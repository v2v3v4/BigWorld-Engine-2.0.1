<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Server Programming Guide</title><link rel="stylesheet" href="../css/bigworld.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.72.0"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div id="bigworld-header"><img src="http://try.bigworldtech.com/bigworld/image.php?img=bigworld_logo.gif&amp;svn=$HeadURL:$" alt="bw logo"></div><div id="content"><div class="book" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="Server_Programming_Guide"></a>Server Programming Guide</h1></div><div><p class="releaseinfo">BigWorld Technology 2.0. Released 2010.</p></div><div><p class="copyright">Copyright &copy; 1999-2010 BigWorld Pty Ltd. All rights reserved. </p></div><div><div class="legalnotice"><a name="d0e17"></a><p>This document is proprietary commercial in confidence and access
  is restricted to authorised users. This document is protected by
  copyright laws of Australia, other countries and international treaties.
  Unauthorised use, reproduction or distribution of this document, or any
  portion of this document, may result in the imposition of civil and
  criminal penalties as provided by law.</p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="part"><a href="#xref_Part_Scripting">I. Server Scripting Guide</a></span></dt><dd><dl><dt><span class="chapter"><a href="#xref_Scripting_Overview">1. Overview</a></span></dt><dt><span class="chapter"><a href="#xref_Physical_Entity_Structure_For_Scripting">2. Physical Entity Structure for Scripting</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_The_entities_xml_File">2.1. The entities.xml File</a></span></dt><dt><span class="section"><a href="#xref_The_Definition_File">2.2. The Entity Definition File</a></span></dt><dt><span class="section"><a href="#xref_The_Script_Files">2.3. The Script Files</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Physical_UDO_Structure_For_Scripting">3. Physical User Data Object Structure for Scripting</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_The_udos_xml_File">3.1. The user_data_objects.xml File</a></span></dt><dt><span class="section"><a href="#xref_The_UDO_Definition_File">3.2. The User Data Object Definition File</a></span></dt><dt><span class="section"><a href="#xref_The_UDO_Script_Files">3.3. The Script Files</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Properties">4. Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Property_Types">4.1. Property Types</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Primitive_Types">4.1.1. Primitive Types</a></span></dt><dt><span class="section"><a href="#xref_Composite_Types">4.1.2. Composite Types</a></span></dt><dt><span class="section"><a href="#xref_Custom_User_Types">4.1.3. Custom User Types</a></span></dt><dt><span class="section"><a href="#xref_Alias_Of_Data_Types">4.1.4. Alias of Data Types</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Default_Values">4.2. Default Values</a></span></dt><dt><span class="section"><a href="#xref_Data_Distribution">4.3. Data Distribution</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Data_Distribution_Combinations">4.3.1. Valid Data Distribution Combinations</a></span></dt><dt><span class="section"><a href="#xref_Data_Distribution_Usage">4.3.2. Using Distribution Flags</a></span></dt><dt><span class="section"><a href="#d0e2493">4.3.3. Data Propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Implementing_Custom_Property_Data_Types">4.4. Implementing Custom Property Data Types</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2548">4.4.1. Wrapping a FIXED_DICT Data Type</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Volatile_Properties">4.5. Volatile Properties</a></span></dt><dt><span class="section"><a href="#xref_LOD_Level_Of_Detail_On_Properties">4.6. LOD (Level of Detail) on Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3627">4.6.1. LOD and Hysteresis</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3824">4.7. Temporary Properties</a></span></dt><dt><span class="section"><a href="#xref_UDO_Linking">4.8. User Data Object Linking With <span class="literal">UDO_REF</span>
    Properties</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Methods">5. Methods</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3981">5.1. Basic Method Specification</a></span></dt><dt><span class="section"><a href="#xref_Intra_Entity_Communication">5.2. Intra-Entity Communication</a></span></dt><dt><span class="section"><a href="#d0e4198">5.3. Sending Auxiliary Data to the Client Via Proxy</a></span></dt><dt><span class="section"><a href="#xref_SPG_ExposedMethods">5.4. Exposed Methods <span class="symbol">&#8208;</span> Client-to-Server
    Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4371">5.4.1. Security Considerations of Exposed Methods</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Implicit_set_property_name_Methods">5.5. Client callbacks on property changes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4431">5.5.1. Implicit
      <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt><dt><span class="section"><a href="#d0e4514">5.5.2. Implicit
      <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt><dt><span class="section"><a href="#d0e4566">5.5.3. Implicit
      <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e4609">5.6. LOD on Methods</a></span></dt><dt><span class="section"><a href="#xref_Inter_Entity_Communication">5.7. Inter-Entity Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4698">5.7.1. Entity IDs</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Mailboxes">5.8. Mailboxes</a></span></dt><dt><span class="section"><a href="#d0e5076">5.9. Method Execution Context</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Inheritance_In_BigWorld">6. Inheritance in BigWorld</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5313">6.1. Python Class Inheritance</a></span></dt><dt><span class="section"><a href="#xref_Entity_Interfaces">6.2. Entity Interfaces</a></span></dt><dt><span class="section"><a href="#xref_Entity_Parents">6.3. Entity Parents</a></span></dt><dt><span class="section"><a href="#xref_Client_Entity_Reuse">6.4. Client Entity Reuse</a></span></dt><dt><span class="section"><a href="#d0e5727">6.5. User Data Object Interfaces and Parents</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Entity_Instantiation_And_Destruction">7. Entity Instantiation and Destruction</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Entity_Instantiation_On_The_BaseApp">7.1. Entity Instantiation on the BaseApp</a></span></dt><dt><span class="section"><a href="#xref_Cell_Entity_Creation_From_BaseApp">7.2. Cell Entity Creation From BaseApp</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6011">7.2.1. Creation Near an Existing Cell Entity</a></span></dt><dt><span class="section"><a href="#d0e6099">7.2.2. Creation in a Numbered Space</a></span></dt><dt><span class="section"><a href="#d0e6149">7.2.3. Creation in a New Space</a></span></dt><dt><span class="section"><a href="#d0e6169">7.2.4. Creation in Default Space</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6199">7.3. Entity Destruction</a></span></dt><dt><span class="section"><a href="#d0e6315">7.4. Entity Instantiation From The CellApp</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6320">7.4.1. Instantiation With No Base Counterpart</a></span></dt><dt><span class="section"><a href="#d0e6380">7.4.2. Instantiation With Base Counterpart</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6441">7.5. Loading Entities From Chunk Files</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_The_Database_Layer">8. The Database Layer</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6520">8.1. Persistent Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Non_Persistent_Properties">8.1.1. Non-Persistent Properties</a></span></dt><dt><span class="section"><a href="#xref_Built_In_Properties">8.1.2. Built-In Properties</a></span></dt><dt><span class="section"><a href="#xref_The_Identifier_Tag">8.1.3. The Identifier Tag</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Reading_And_Writing_Entities">8.2. Reading and Writing Entities</a></span></dt><dt><span class="section"><a href="#xref_Mapping_BigWorld_Properties_Into_SQL">8.3. Mapping BigWorld Properties Into SQL</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6998">8.3.1. Entity Tables</a></span></dt><dt><span class="section"><a href="#d0e7024">8.3.2. The <code class="varname">databaseID</code> property</a></span></dt><dt><span class="section"><a href="#d0e7038">8.3.3. Simple Data Types</a></span></dt><dt><span class="section"><a href="#d0e7135">8.3.4. <span class="type">VECTOR</span> Data Types</a></span></dt><dt><span class="section"><a href="#xref_STRING_UNICODE_STRING_BLOB_and_data_types">8.3.5. <span class="type">STRING</span>, <span class="type">UNICODE_STRING</span>,
      <span class="type">BLOB</span>, and <span class="type">PYTHON</span> Data Types</a></span></dt><dt><span class="section"><a href="#d0e7477">8.3.6. <span class="type">PATROL_PATH</span> and <span class="type">UDO_REF</span> Data
      Types</a></span></dt><dt><span class="section"><a href="#d0e7514">8.3.7. <span class="type">ARRAY</span>s and <span class="type">TUPLE</span>s</a></span></dt><dt><span class="section"><a href="#xref_FIXED_DICTs">8.3.8. <span class="type">FIXED_DICT</span>s</a></span></dt><dt><span class="section"><a href="#d0e7845">8.3.9. <span class="type">USER_TYPE</span>s</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8523">8.4. Execute Arbitrary Commands on Database</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8536">8.4.1. Execute Commands on SQL Database</a></span></dt><dt><span class="section"><a href="#d0e8622">8.4.2. Execute Commands on XML Database</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Secondary_Databases">8.5. Secondary Databases</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Data_Consolidation">8.5.1. Data Consolidation</a></span></dt><dt><span class="section"><a href="#xref_Database_Snapshot">8.5.2. Database Snapshot</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Character_Set_Encodings">9. Character Sets and Encodings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Python_Character_Sets">9.1. Python and Entity Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Encoding_Python_String">9.1.1. <span class="literal">STRING</span></a></span></dt><dt><span class="section"><a href="#xref_Encoding_Python_Unicode_String">9.1.2. <span class="literal">UNICODE_STRING</span></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_DBMgr_Character_Sets">9.2. DBMgr and Encodings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_DBMgr_MySQL_UNICODE_STRING">9.2.1. UNICODE_STRING storage</a></span></dt><dt><span class="section"><a href="#xref_Encodings_Sorting_Search_Results">9.2.2. Sorting search results</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Server_Profiling">10. Profiling</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Profiling_Entities">10.1. Profiling Entities</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9319">10.1.1. Persistent Properties</a></span></dt><dt><span class="section"><a href="#d0e9326">10.1.2. Property Data Types</a></span></dt><dt><span class="section"><a href="#d0e9331">10.1.3. Property Data Propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Python_Script">10.2. Python Game Script</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Understanding_PyProfile_Output">10.2.1. Understanding the output</a></span></dt><dt><span class="section"><a href="#d0e9433">10.2.2. Increasing Memory Usage / Entity Count</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Server_Processes">10.3. Profiling Server Processes (C++ Code)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9479">10.3.1. Common Code Block Profiles</a></span></dt><dt><span class="section"><a href="#d0e9518">10.3.2. BaseApp Code Block Profiles</a></span></dt><dt><span class="section"><a href="#d0e9571">10.3.3. CellApp Code Block Profiles</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Client_Communication">10.4. Client Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9736">10.4.1. Private Client Events</a></span></dt><dt><span class="section"><a href="#d0e9769">10.4.2. Public Client Events</a></span></dt><dt><span class="section"><a href="#d0e9806">10.4.3. Total Public Client Events</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Server_Communication">10.5. Server Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_BaseApp_Interface_Summary">10.5.1. BaseApp Interface Summary</a></span></dt><dt><span class="section"><a href="#d0e10151">10.5.2. CellApp Interface Summary</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Proxies_And_Players">11. Proxies and Players</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10274">11.1. Proxies</a></span></dt><dt><span class="section"><a href="#d0e10363">11.2. Witnesses</a></span></dt><dt><span class="section"><a href="#xref_Entity_Control">11.3. Entity Control</a></span></dt><dt><span class="section"><a href="#xref_Physics_Correction">11.4. Physics Correction</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10544">11.4.1. Avoiding Y-axis rubber-banding.</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Entities_And_The_Universe">12. Entities and the Universe</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10583">12.1. Multiple Spaces</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10693">12.1.1. Spaces Pool</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Navigation_System">12.2. Navigation System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10708">12.2.1. Key Features</a></span></dt><dt><span class="section"><a href="#d0e10726">12.2.2. Navpoly Data Format</a></span></dt><dt><span class="section"><a href="#d0e10754">12.2.3. Script Interface</a></span></dt><dt><span class="section"><a href="#d0e10840">12.2.4. Navigate</a></span></dt><dt><span class="section"><a href="#d0e10879">12.2.5. Graph Searches</a></span></dt><dt><span class="section"><a href="#d0e10916">12.2.6. Auto-Generation of Navpoly Regions <span class="symbol">&#8208;</span> The NavGen Utility</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10992">12.3. Time</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10999">12.3.1. Real Time</a></span></dt><dt><span class="section"><a href="#d0e11004">12.3.2. Server Time</a></span></dt><dt><span class="section"><a href="#xref_Game_Time">12.3.3. Game Time</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Initialisation_Personality_Script_eload_And_runscript">12.4. Initialisation: Personality script, eload, and runscript</a></span></dt><dt><span class="section"><a href="#d0e11335">12.5. Global Data</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11345">12.5.1. <code class="varname">globalData</code>, <code class="varname">baseAppData</code> and
      <code class="varname">cellAppData</code></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Space_Data">12.6. Space Data</a></span></dt><dt><span class="section"><a href="#xref_Global_Bases">12.7. Global Bases</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_XML_Data_File_Access">13. XML Data File Access</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11794">13.1. <code class="classname">ResMgr</code>.<code class="classname">DataSection</code></a></span></dt><dt><span class="section"><a href="#xref_Accessing_Data">13.2. Accessing Data</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11836">13.2.1. Opening a Section Within an XML File</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11851">13.3. Data Types</a></span></dt><dt><span class="section"><a href="#d0e11953">13.4. Writing Data</a></span></dt><dt><span class="section"><a href="#d0e12017">13.5. Performance Issues</a></span></dt><dt><span class="section"><a href="#d0e12026">13.6. API Reference</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_External_Services">14. External Services</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Non-blocking_Methods">14.1. Non-blocking Methods</a></span></dt><dt><span class="section"><a href="#xref_Background_Threads">14.2. Background Threads</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12210">14.2.1. Caveats</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Fault_Tolerance">15. Fault Tolerance</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12229">15.1. CellApp Fault Tolerance</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12232">15.1.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e12245">15.1.2. Restoration process</a></span></dt><dt><span class="section"><a href="#d0e12298">15.1.3. Example</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e12331">15.2. BaseApp Fault Tolerance</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Disaster_Recovery">16. Disaster Recovery</a></span></dt><dt><span class="chapter"><a href="#xref_Controlled_Startup_And_Shutdown">17. Controlled Startup and Shutdown</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12438">17.1. Controlled Shutdown</a></span></dt><dt><span class="section"><a href="#d0e12555">17.2. Controlled Startup</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d0e12645">18. Transactions and Handling Fault Tolerance and Disaster Recovery</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12650">18.1. Transaction logic</a></span></dt><dt><span class="section"><a href="#d0e12736">18.2. Fault Tolerance Behaviour</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12739">18.2.1. CellApp Fault Tolerance</a></span></dt><dt><span class="section"><a href="#d0e12762">18.2.2. BaseApp
      Fault Tolerance</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e12789">18.3. Disaster Recovery Behaviour</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Implementing_Common_Systems">19. Implementing Common Systems</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12819">19.1. General Scalability</a></span></dt><dt><span class="section"><a href="#d0e12838">19.2. Internal inter-component communication</a></span></dt><dt><span class="section"><a href="#d0e12847">19.3. Player AoI Updates</a></span></dt><dt><span class="section"><a href="#d0e12893">19.4. BigWorld Database Scalability</a></span></dt><dt><span class="section"><a href="#d0e12935">19.5. Player Look-up</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12938">19.5.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e12950">19.5.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13027">19.6. Friends lists</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13030">19.6.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13045">19.6.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13242">19.7. Chat</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13255">19.7.1. P2P</a></span></dt><dt><span class="section"><a href="#d0e13287">19.7.2. AoI-based broadcast chat</a></span></dt><dt><span class="section"><a href="#d0e13308">19.7.3. Non-AoI-based broadcast chat</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13337">19.8. Mail</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13340">19.8.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13345">19.8.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13356">19.9. Inventory System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13359">19.9.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13371">19.9.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13399">19.10. AoI-based Trading</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13402">19.10.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13411">19.10.2. Design</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_User_Authentication_And_Proxy_Selection">20. User Authentication and Billing System Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13551">20.1. Authentication by DBMgr</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_bigworldLogOnMapping_Table">20.1.1. Default Authentication via MySQL</a></span></dt><dt><span class="section"><a href="#d0e13674">20.1.2. Default Authentication via XML</a></span></dt><dt><span class="section"><a href="#d0e13754">20.1.3. Custom Authentication and Billing System Integration</a></span></dt><dt><span class="section"><a href="#xref_Accepting_All_Users">20.1.4. Accepting All Users</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Bypassing_bigworldLogOnMapping_And_Using_Account_Entity">20.2. Authentication via a Base entity</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Security_Systems_In_BigWorld_Technology">21. Security</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14054">21.1. Client/Server Communications</a></span></dt><dt><span class="section"><a href="#d0e14143">21.2. Server-Side Network</a></span></dt><dt><span class="section"><a href="#d0e14180">21.3. Client Side</a></span></dt><dt><span class="section"><a href="#d0e14197">21.4. Client Cheating</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14209">21.4.1. General Rules for Managing Entity Data</a></span></dt><dt><span class="section"><a href="#d0e14242">21.4.2. Writing Secure Game Script</a></span></dt><dt><span class="section"><a href="#d0e14255">21.4.3. Balancing Security vs. Latency</a></span></dt><dt><span class="section"><a href="#d0e14262">21.4.4. Balancing Security vs. Server CPU Cost</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Debugging">22. Debugging</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14272">22.1. General Debugging</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14275">22.1.1. Information and Error Messages</a></span></dt><dt><span class="section"><a href="#d0e14309">22.1.2. Testing Scripts Using the Python Server</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e14405">22.2. Performance Profiling</a></span></dt><dt><span class="section"><a href="#d0e14465">22.3. Common Mistakes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14468">22.3.1. Definition Files Inconsistent Between the Server and
      Client</a></span></dt><dt><span class="section"><a href="#d0e14477">22.3.2. Implementation (<span class="literal">.py</span>) Does Not Match Definition
      (<span class="literal">.def</span>)</a></span></dt><dt><span class="section"><a href="#d0e14495">22.3.3. Accessing Other Entities' Properties and Methods Not Declared in
      the Definition File</a></span></dt><dt><span class="section"><a href="#d0e14510">22.3.4. Trying to Update the Properties of a Ghost Entity</a></span></dt><dt><span class="section"><a href="#d0e14537">22.3.5. Database backup and fault tolerance doesn't work for entities
      lacking a Base part</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e14546">22.4. Fixed Cell Boundaries</a></span></dt><dt><span class="section"><a href="#d0e14614">22.5. Message Reliability And Ordering</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Simplified_Server_Usage">23. Shared Development Environments</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Window_Linux_Cross_Platform_Development">23.1. Windows and Linux cross platform development</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Sharing_Resources_From_Windows">23.1.1. Sharing resources from Windows</a></span></dt><dt><span class="section"><a href="#d0e14858">23.1.2. Accessing Windows share from Linux</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15015">23.2. Using BigWorld with a Version Control System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e15020">23.2.1. Customers using the Commercial Edition</a></span></dt><dt><span class="section"><a href="#d0e15029">23.2.2. Customers using the Indie Edition</a></span></dt><dt><span class="section"><a href="#xref_Version_Control_Exclusions">23.2.3. Files to exclude from version
      control</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15139">23.3. DBMgr database conflicts</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#xref_Part_Server_CPP_Programming_Guide">II. Server C++ Programming Guide</a></span></dt><dd><dl><dt><span class="chapter"><a href="#xref_CPP_Overview">24. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Compilation">24.1. Compilation</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Output_Directories">24.1.1. Output Directories</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Extending_BigWorld_Server">25. Extending BigWorld Server</a></span></dt><dt><span class="chapter"><a href="#xref_Entity_Extras_And_Controllers">26. Entity Extras and Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e15368">26.1. Implementing Entity Extras</a></span></dt><dt><span class="section"><a href="#d0e15567">26.2. Implementing Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e15891">26.2.1. Configuring Portal's Permissivity</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15969">26.3. Integrating Entity Extras and Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16075">26.3.1. Restricting the Number of Controllers Per Entity</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Updatable_Objects">27. Updatable Objects</a></span></dt><dt><span class="chapter"><a href="#xref_Encrypting_Client_Server_Traffic">28. Encrypting Client-Server Traffic</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Generating_RSA_Keypair">28.1. Generating your own RSA keypair</a></span></dt><dt><span class="section"><a href="#d0e16240">28.2. Working with multiple keys</a></span></dt><dt><span class="section"><a href="#d0e16254">28.3. Customising the symmetric encryption algorithm</a></span></dt><dt><span class="section"><a href="#xref_How_Packet_Filters_Work">28.4. How PacketFilters work</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16289">28.4.1. High-level requirements</a></span></dt><dt><span class="section"><a href="#d0e16313">28.4.2. Filtering mechanics and requirements</a></span></dt><dt><span class="section"><a href="#d0e16416">28.4.3. Extra space for filtering</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Mercury_Packet_Structure">29. Mercury Packet Structure</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16490">29.1. Header</a></span></dt><dt><span class="section"><a href="#d0e16503">29.2. Messages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16547">29.2.1. Fixed-Length Messages</a></span></dt><dt><span class="section"><a href="#d0e16566">29.2.2. Variable-Length Messages</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e16585">29.3. Footers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16595">29.3.1. Fragment Numbers</a></span></dt><dt><span class="section"><a href="#d0e16610">29.3.2. Sequence Number</a></span></dt><dt><span class="section"><a href="#d0e16618">29.3.3. ACKs</a></span></dt><dt><span class="section"><a href="#d0e16631">29.3.4. Indexed Channel ID</a></span></dt><dt><span class="section"><a href="#d0e16639">29.3.5. First Request Offset and <span class="literal">replyID</span></a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Watcher_Interface">30. The Watcher Interface</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16722">30.1. Callable Function Watchers</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Forwarding_Watchers">30.1.1. Forwarding Watchers</a></span></dt><dt><span class="section"><a href="#xref_Implement_Function_Watchers">30.1.2. Implementing Function Watchers</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Debug_Message_Macros">31. Debug Message Macros</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17094">31.1. Centralised Logging</a></span></dt><dt><span class="section"><a href="#xref_Filtering_By_Priority">31.2. Filtering by Priority</a></span></dt><dt><span class="section"><a href="#d0e17145">31.3. Message Priority</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Non_Blocking_Socket_IO_Using_Mercury">32. Non-Blocking Socket I/O Using Mercury</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17271">32.1. Getting Callbacks From Mercury::EventDispatcher</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_MySQL_Database_Schema">33. MySQL Database Schema</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Entity_Tables">33.1. Entity Tables</a></span></dt><dt><span class="section"><a href="#xref_Non_Entity_Tables">33.2. Non-Entity Tables</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#xref_Part_Extending_WebConsole">III. Extending WebConsole</a></span></dt><dd><dl><dt><span class="chapter"><a href="#xref_WebConsole_Overview">34. Web Console</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17611">34.1. Adding a Page to a Module</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17635">34.1.1. Create a Template KID File</a></span></dt><dt><span class="section"><a href="#d0e17675">34.1.2. Edit <code class="filename">controllers.py</code></a></span></dt></dl></dd><dt><span class="section"><a href="#d0e17723">34.2. Adding a Module</a></span></dt><dt><span class="section"><a href="#d0e17812">34.3. Add an Action Item to ClusterControl</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Adding_A_Menu_Item_For_An_Existing_Component_Type">34.3.1. Adding a Menu Item for an Existing Component Type</a></span></dt><dt><span class="section"><a href="#d0e17862">34.3.2. Adding a Menu Item for a New Component Type</a></span></dt></dl></dd></dl></dd></dl></dd></dl></div><div class="part" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="xref_Part_Scripting"></a>Part&nbsp;I.&nbsp;Server Scripting Guide</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#xref_Scripting_Overview">1. Overview</a></span></dt><dt><span class="chapter"><a href="#xref_Physical_Entity_Structure_For_Scripting">2. Physical Entity Structure for Scripting</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_The_entities_xml_File">2.1. The entities.xml File</a></span></dt><dt><span class="section"><a href="#xref_The_Definition_File">2.2. The Entity Definition File</a></span></dt><dt><span class="section"><a href="#xref_The_Script_Files">2.3. The Script Files</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Physical_UDO_Structure_For_Scripting">3. Physical User Data Object Structure for Scripting</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_The_udos_xml_File">3.1. The user_data_objects.xml File</a></span></dt><dt><span class="section"><a href="#xref_The_UDO_Definition_File">3.2. The User Data Object Definition File</a></span></dt><dt><span class="section"><a href="#xref_The_UDO_Script_Files">3.3. The Script Files</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Properties">4. Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Property_Types">4.1. Property Types</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Primitive_Types">4.1.1. Primitive Types</a></span></dt><dt><span class="section"><a href="#xref_Composite_Types">4.1.2. Composite Types</a></span></dt><dt><span class="section"><a href="#xref_Custom_User_Types">4.1.3. Custom User Types</a></span></dt><dt><span class="section"><a href="#xref_Alias_Of_Data_Types">4.1.4. Alias of Data Types</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Default_Values">4.2. Default Values</a></span></dt><dt><span class="section"><a href="#xref_Data_Distribution">4.3. Data Distribution</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Data_Distribution_Combinations">4.3.1. Valid Data Distribution Combinations</a></span></dt><dt><span class="section"><a href="#xref_Data_Distribution_Usage">4.3.2. Using Distribution Flags</a></span></dt><dt><span class="section"><a href="#d0e2493">4.3.3. Data Propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Implementing_Custom_Property_Data_Types">4.4. Implementing Custom Property Data Types</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2548">4.4.1. Wrapping a FIXED_DICT Data Type</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Volatile_Properties">4.5. Volatile Properties</a></span></dt><dt><span class="section"><a href="#xref_LOD_Level_Of_Detail_On_Properties">4.6. LOD (Level of Detail) on Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3627">4.6.1. LOD and Hysteresis</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3824">4.7. Temporary Properties</a></span></dt><dt><span class="section"><a href="#xref_UDO_Linking">4.8. User Data Object Linking With <span class="literal">UDO_REF</span>
    Properties</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Methods">5. Methods</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3981">5.1. Basic Method Specification</a></span></dt><dt><span class="section"><a href="#xref_Intra_Entity_Communication">5.2. Intra-Entity Communication</a></span></dt><dt><span class="section"><a href="#d0e4198">5.3. Sending Auxiliary Data to the Client Via Proxy</a></span></dt><dt><span class="section"><a href="#xref_SPG_ExposedMethods">5.4. Exposed Methods <span class="symbol">&#8208;</span> Client-to-Server
    Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4371">5.4.1. Security Considerations of Exposed Methods</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Implicit_set_property_name_Methods">5.5. Client callbacks on property changes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4431">5.5.1. Implicit
      <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt><dt><span class="section"><a href="#d0e4514">5.5.2. Implicit
      <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt><dt><span class="section"><a href="#d0e4566">5.5.3. Implicit
      <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e4609">5.6. LOD on Methods</a></span></dt><dt><span class="section"><a href="#xref_Inter_Entity_Communication">5.7. Inter-Entity Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4698">5.7.1. Entity IDs</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Mailboxes">5.8. Mailboxes</a></span></dt><dt><span class="section"><a href="#d0e5076">5.9. Method Execution Context</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Inheritance_In_BigWorld">6. Inheritance in BigWorld</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5313">6.1. Python Class Inheritance</a></span></dt><dt><span class="section"><a href="#xref_Entity_Interfaces">6.2. Entity Interfaces</a></span></dt><dt><span class="section"><a href="#xref_Entity_Parents">6.3. Entity Parents</a></span></dt><dt><span class="section"><a href="#xref_Client_Entity_Reuse">6.4. Client Entity Reuse</a></span></dt><dt><span class="section"><a href="#d0e5727">6.5. User Data Object Interfaces and Parents</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Entity_Instantiation_And_Destruction">7. Entity Instantiation and Destruction</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Entity_Instantiation_On_The_BaseApp">7.1. Entity Instantiation on the BaseApp</a></span></dt><dt><span class="section"><a href="#xref_Cell_Entity_Creation_From_BaseApp">7.2. Cell Entity Creation From BaseApp</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6011">7.2.1. Creation Near an Existing Cell Entity</a></span></dt><dt><span class="section"><a href="#d0e6099">7.2.2. Creation in a Numbered Space</a></span></dt><dt><span class="section"><a href="#d0e6149">7.2.3. Creation in a New Space</a></span></dt><dt><span class="section"><a href="#d0e6169">7.2.4. Creation in Default Space</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6199">7.3. Entity Destruction</a></span></dt><dt><span class="section"><a href="#d0e6315">7.4. Entity Instantiation From The CellApp</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6320">7.4.1. Instantiation With No Base Counterpart</a></span></dt><dt><span class="section"><a href="#d0e6380">7.4.2. Instantiation With Base Counterpart</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6441">7.5. Loading Entities From Chunk Files</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_The_Database_Layer">8. The Database Layer</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6520">8.1. Persistent Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Non_Persistent_Properties">8.1.1. Non-Persistent Properties</a></span></dt><dt><span class="section"><a href="#xref_Built_In_Properties">8.1.2. Built-In Properties</a></span></dt><dt><span class="section"><a href="#xref_The_Identifier_Tag">8.1.3. The Identifier Tag</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Reading_And_Writing_Entities">8.2. Reading and Writing Entities</a></span></dt><dt><span class="section"><a href="#xref_Mapping_BigWorld_Properties_Into_SQL">8.3. Mapping BigWorld Properties Into SQL</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6998">8.3.1. Entity Tables</a></span></dt><dt><span class="section"><a href="#d0e7024">8.3.2. The <code class="varname">databaseID</code> property</a></span></dt><dt><span class="section"><a href="#d0e7038">8.3.3. Simple Data Types</a></span></dt><dt><span class="section"><a href="#d0e7135">8.3.4. <span class="type">VECTOR</span> Data Types</a></span></dt><dt><span class="section"><a href="#xref_STRING_UNICODE_STRING_BLOB_and_data_types">8.3.5. <span class="type">STRING</span>, <span class="type">UNICODE_STRING</span>,
      <span class="type">BLOB</span>, and <span class="type">PYTHON</span> Data Types</a></span></dt><dt><span class="section"><a href="#d0e7477">8.3.6. <span class="type">PATROL_PATH</span> and <span class="type">UDO_REF</span> Data
      Types</a></span></dt><dt><span class="section"><a href="#d0e7514">8.3.7. <span class="type">ARRAY</span>s and <span class="type">TUPLE</span>s</a></span></dt><dt><span class="section"><a href="#xref_FIXED_DICTs">8.3.8. <span class="type">FIXED_DICT</span>s</a></span></dt><dt><span class="section"><a href="#d0e7845">8.3.9. <span class="type">USER_TYPE</span>s</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8523">8.4. Execute Arbitrary Commands on Database</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8536">8.4.1. Execute Commands on SQL Database</a></span></dt><dt><span class="section"><a href="#d0e8622">8.4.2. Execute Commands on XML Database</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Secondary_Databases">8.5. Secondary Databases</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Data_Consolidation">8.5.1. Data Consolidation</a></span></dt><dt><span class="section"><a href="#xref_Database_Snapshot">8.5.2. Database Snapshot</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Character_Set_Encodings">9. Character Sets and Encodings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Python_Character_Sets">9.1. Python and Entity Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Encoding_Python_String">9.1.1. <span class="literal">STRING</span></a></span></dt><dt><span class="section"><a href="#xref_Encoding_Python_Unicode_String">9.1.2. <span class="literal">UNICODE_STRING</span></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_DBMgr_Character_Sets">9.2. DBMgr and Encodings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_DBMgr_MySQL_UNICODE_STRING">9.2.1. UNICODE_STRING storage</a></span></dt><dt><span class="section"><a href="#xref_Encodings_Sorting_Search_Results">9.2.2. Sorting search results</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Server_Profiling">10. Profiling</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Profiling_Entities">10.1. Profiling Entities</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9319">10.1.1. Persistent Properties</a></span></dt><dt><span class="section"><a href="#d0e9326">10.1.2. Property Data Types</a></span></dt><dt><span class="section"><a href="#d0e9331">10.1.3. Property Data Propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Python_Script">10.2. Python Game Script</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Understanding_PyProfile_Output">10.2.1. Understanding the output</a></span></dt><dt><span class="section"><a href="#d0e9433">10.2.2. Increasing Memory Usage / Entity Count</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Server_Processes">10.3. Profiling Server Processes (C++ Code)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9479">10.3.1. Common Code Block Profiles</a></span></dt><dt><span class="section"><a href="#d0e9518">10.3.2. BaseApp Code Block Profiles</a></span></dt><dt><span class="section"><a href="#d0e9571">10.3.3. CellApp Code Block Profiles</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Client_Communication">10.4. Client Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9736">10.4.1. Private Client Events</a></span></dt><dt><span class="section"><a href="#d0e9769">10.4.2. Public Client Events</a></span></dt><dt><span class="section"><a href="#d0e9806">10.4.3. Total Public Client Events</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Server_Communication">10.5. Server Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_BaseApp_Interface_Summary">10.5.1. BaseApp Interface Summary</a></span></dt><dt><span class="section"><a href="#d0e10151">10.5.2. CellApp Interface Summary</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Proxies_And_Players">11. Proxies and Players</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10274">11.1. Proxies</a></span></dt><dt><span class="section"><a href="#d0e10363">11.2. Witnesses</a></span></dt><dt><span class="section"><a href="#xref_Entity_Control">11.3. Entity Control</a></span></dt><dt><span class="section"><a href="#xref_Physics_Correction">11.4. Physics Correction</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10544">11.4.1. Avoiding Y-axis rubber-banding.</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Entities_And_The_Universe">12. Entities and the Universe</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10583">12.1. Multiple Spaces</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10693">12.1.1. Spaces Pool</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Navigation_System">12.2. Navigation System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10708">12.2.1. Key Features</a></span></dt><dt><span class="section"><a href="#d0e10726">12.2.2. Navpoly Data Format</a></span></dt><dt><span class="section"><a href="#d0e10754">12.2.3. Script Interface</a></span></dt><dt><span class="section"><a href="#d0e10840">12.2.4. Navigate</a></span></dt><dt><span class="section"><a href="#d0e10879">12.2.5. Graph Searches</a></span></dt><dt><span class="section"><a href="#d0e10916">12.2.6. Auto-Generation of Navpoly Regions <span class="symbol">&#8208;</span> The NavGen Utility</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10992">12.3. Time</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10999">12.3.1. Real Time</a></span></dt><dt><span class="section"><a href="#d0e11004">12.3.2. Server Time</a></span></dt><dt><span class="section"><a href="#xref_Game_Time">12.3.3. Game Time</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Initialisation_Personality_Script_eload_And_runscript">12.4. Initialisation: Personality script, eload, and runscript</a></span></dt><dt><span class="section"><a href="#d0e11335">12.5. Global Data</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11345">12.5.1. <code class="varname">globalData</code>, <code class="varname">baseAppData</code> and
      <code class="varname">cellAppData</code></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Space_Data">12.6. Space Data</a></span></dt><dt><span class="section"><a href="#xref_Global_Bases">12.7. Global Bases</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_XML_Data_File_Access">13. XML Data File Access</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11794">13.1. <code class="classname">ResMgr</code>.<code class="classname">DataSection</code></a></span></dt><dt><span class="section"><a href="#xref_Accessing_Data">13.2. Accessing Data</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11836">13.2.1. Opening a Section Within an XML File</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11851">13.3. Data Types</a></span></dt><dt><span class="section"><a href="#d0e11953">13.4. Writing Data</a></span></dt><dt><span class="section"><a href="#d0e12017">13.5. Performance Issues</a></span></dt><dt><span class="section"><a href="#d0e12026">13.6. API Reference</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_External_Services">14. External Services</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Non-blocking_Methods">14.1. Non-blocking Methods</a></span></dt><dt><span class="section"><a href="#xref_Background_Threads">14.2. Background Threads</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12210">14.2.1. Caveats</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Fault_Tolerance">15. Fault Tolerance</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12229">15.1. CellApp Fault Tolerance</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12232">15.1.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e12245">15.1.2. Restoration process</a></span></dt><dt><span class="section"><a href="#d0e12298">15.1.3. Example</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e12331">15.2. BaseApp Fault Tolerance</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Disaster_Recovery">16. Disaster Recovery</a></span></dt><dt><span class="chapter"><a href="#xref_Controlled_Startup_And_Shutdown">17. Controlled Startup and Shutdown</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12438">17.1. Controlled Shutdown</a></span></dt><dt><span class="section"><a href="#d0e12555">17.2. Controlled Startup</a></span></dt></dl></dd><dt><span class="chapter"><a href="#d0e12645">18. Transactions and Handling Fault Tolerance and Disaster Recovery</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12650">18.1. Transaction logic</a></span></dt><dt><span class="section"><a href="#d0e12736">18.2. Fault Tolerance Behaviour</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12739">18.2.1. CellApp Fault Tolerance</a></span></dt><dt><span class="section"><a href="#d0e12762">18.2.2. BaseApp
      Fault Tolerance</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e12789">18.3. Disaster Recovery Behaviour</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Implementing_Common_Systems">19. Implementing Common Systems</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12819">19.1. General Scalability</a></span></dt><dt><span class="section"><a href="#d0e12838">19.2. Internal inter-component communication</a></span></dt><dt><span class="section"><a href="#d0e12847">19.3. Player AoI Updates</a></span></dt><dt><span class="section"><a href="#d0e12893">19.4. BigWorld Database Scalability</a></span></dt><dt><span class="section"><a href="#d0e12935">19.5. Player Look-up</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12938">19.5.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e12950">19.5.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13027">19.6. Friends lists</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13030">19.6.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13045">19.6.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13242">19.7. Chat</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13255">19.7.1. P2P</a></span></dt><dt><span class="section"><a href="#d0e13287">19.7.2. AoI-based broadcast chat</a></span></dt><dt><span class="section"><a href="#d0e13308">19.7.3. Non-AoI-based broadcast chat</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13337">19.8. Mail</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13340">19.8.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13345">19.8.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13356">19.9. Inventory System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13359">19.9.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13371">19.9.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13399">19.10. AoI-based Trading</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13402">19.10.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13411">19.10.2. Design</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_User_Authentication_And_Proxy_Selection">20. User Authentication and Billing System Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13551">20.1. Authentication by DBMgr</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_bigworldLogOnMapping_Table">20.1.1. Default Authentication via MySQL</a></span></dt><dt><span class="section"><a href="#d0e13674">20.1.2. Default Authentication via XML</a></span></dt><dt><span class="section"><a href="#d0e13754">20.1.3. Custom Authentication and Billing System Integration</a></span></dt><dt><span class="section"><a href="#xref_Accepting_All_Users">20.1.4. Accepting All Users</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Bypassing_bigworldLogOnMapping_And_Using_Account_Entity">20.2. Authentication via a Base entity</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Security_Systems_In_BigWorld_Technology">21. Security</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14054">21.1. Client/Server Communications</a></span></dt><dt><span class="section"><a href="#d0e14143">21.2. Server-Side Network</a></span></dt><dt><span class="section"><a href="#d0e14180">21.3. Client Side</a></span></dt><dt><span class="section"><a href="#d0e14197">21.4. Client Cheating</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14209">21.4.1. General Rules for Managing Entity Data</a></span></dt><dt><span class="section"><a href="#d0e14242">21.4.2. Writing Secure Game Script</a></span></dt><dt><span class="section"><a href="#d0e14255">21.4.3. Balancing Security vs. Latency</a></span></dt><dt><span class="section"><a href="#d0e14262">21.4.4. Balancing Security vs. Server CPU Cost</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Debugging">22. Debugging</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14272">22.1. General Debugging</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14275">22.1.1. Information and Error Messages</a></span></dt><dt><span class="section"><a href="#d0e14309">22.1.2. Testing Scripts Using the Python Server</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e14405">22.2. Performance Profiling</a></span></dt><dt><span class="section"><a href="#d0e14465">22.3. Common Mistakes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14468">22.3.1. Definition Files Inconsistent Between the Server and
      Client</a></span></dt><dt><span class="section"><a href="#d0e14477">22.3.2. Implementation (<span class="literal">.py</span>) Does Not Match Definition
      (<span class="literal">.def</span>)</a></span></dt><dt><span class="section"><a href="#d0e14495">22.3.3. Accessing Other Entities' Properties and Methods Not Declared in
      the Definition File</a></span></dt><dt><span class="section"><a href="#d0e14510">22.3.4. Trying to Update the Properties of a Ghost Entity</a></span></dt><dt><span class="section"><a href="#d0e14537">22.3.5. Database backup and fault tolerance doesn't work for entities
      lacking a Base part</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e14546">22.4. Fixed Cell Boundaries</a></span></dt><dt><span class="section"><a href="#d0e14614">22.5. Message Reliability And Ordering</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Simplified_Server_Usage">23. Shared Development Environments</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Window_Linux_Cross_Platform_Development">23.1. Windows and Linux cross platform development</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Sharing_Resources_From_Windows">23.1.1. Sharing resources from Windows</a></span></dt><dt><span class="section"><a href="#d0e14858">23.1.2. Accessing Windows share from Linux</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15015">23.2. Using BigWorld with a Version Control System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e15020">23.2.1. Customers using the Commercial Edition</a></span></dt><dt><span class="section"><a href="#d0e15029">23.2.2. Customers using the Indie Edition</a></span></dt><dt><span class="section"><a href="#xref_Version_Control_Exclusions">23.2.3. Files to exclude from version
      control</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15139">23.3. DBMgr database conflicts</a></span></dt></dl></dd></dl></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Scripting_Overview"></a>Chapter&nbsp;1.&nbsp;Overview</h2></div></div></div><p>This part of the document contains technical information for creating
  entities and user data objects for the BigWorld Server. It is part of a
  larger set of documentation describing the whole BigWorld system.</p><p>The intended audience is technical-typically MMOG developers and
  designers.</p><p>For API-level information, please refer to the API reference
  documentation.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Garbage collection is disabled in BigWorld's Python integration,
    because garbage collection is an expensive operation that can occur at any
    time, blocking the main thread in the server applications.</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>For details on BigWorld terminology, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../glossary_of_terms/glossary_of_terms.html#Glossary_Of_Terms" class="olink">Glossary of Terms</a>.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Physical_Entity_Structure_For_Scripting"></a>Chapter&nbsp;2.&nbsp;Physical Entity Structure for Scripting</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_The_entities_xml_File">2.1. The entities.xml File</a></span></dt><dt><span class="section"><a href="#xref_The_Definition_File">2.2. The Entity Definition File</a></span></dt><dt><span class="section"><a href="#xref_The_Script_Files">2.3. The Script Files</a></span></dt></dl></div><p>Entities are the objects that make up the game world. Using entities,
  you can create players, NPCs, loot, chat rooms, and many other interactive
  elements in your games.</p><p>Each entity type is implemented as a collection of Python scripts, and
  an XML-based definition file that ties the scripts together. These scripts
  are located in the resource tree under the folder <code class="filename">scripts</code> (<em class="emphasis">i.e.</em>, <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts
  </code>, where <em class="replaceable"><code>&lt;res&gt;</code></em> is the virtual
  tree defined <code class="filename">~/.bwmachined.conf</code>).</p><p>The list below summarises the important files and directories for
  entities in <em class="replaceable"><code>&lt;res&gt;</code></em>:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><em class="replaceable"><code>&lt;res&gt;</code></em>
      </em> <span class="symbol">&#8208;</span> Resource tree
      defined in <code class="filename">~/.bwmachined.conf </code>.</p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">scripts</span></em>
          <span class="symbol">&#8208;</span> Folder containing all entity
          files.</p><div class="itemizedlist"><ul type="square"><li><p><em class="emphasis"><span class="literal">db.xml</span></em>
              <span class="symbol">&#8208;</span> Persistent state for the
              XML database system.</p></li><li><p><em class="emphasis"><code class="filename">entities.xml</code></em> <span class="symbol">&#8208;</span> Lists all entities to load into
              the client or the server at start-up time.</p></li><li><p><em class="emphasis"><span class="literal">base</span></em>
              <span class="symbol">&#8208;</span> Folder contains Python
              scripts for entities with a base component.</p></li><li><p><em class="emphasis"><span class="literal">cell</span></em>
              <span class="symbol">&#8208;</span> Folder contains Python
              scripts for entities with a cell component.</p></li><li><p><em class="emphasis"><span class="literal">client</span></em>
              <span class="symbol">&#8208;</span> Folder contains Python
              scripts for entities with a client component.</p></li><li><p><em class="emphasis"><span class="literal">common</span></em>
              <span class="symbol">&#8208;</span> Folder listed in the
              Python search path for all components. Used for common game
              code.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">lib</span></em> <span class="symbol">&#8208;</span> Folder listed in the
                    Python search path for all components. Used for common
                    game code.</p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">entity_defs</span></em> <span class="symbol">&#8208;</span> Contains an XML <code class="filename">.def</code> file for each entity listed in
              file
              <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entities.xml</code>.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="filename">alias.xml</code></em>
                  <span class="symbol">&#8208;</span> Data types aliases
                  used in the project.</p></li><li><p><em class="emphasis"><code class="filename"><em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code></em>
                  <span class="symbol">&#8208;</span> Entity definition
                  file. There is one such file for each entity defined in
                  <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entities.xml</span>.</p></li><li><p><em class="emphasis"><span class="literal">interfaces</span></em> <span class="symbol">&#8208;</span> Entity interface definition
                  files</p></li></ul></div></li></ul></div></li><li><p><em class="emphasis"><span class="literal">server</span></em>
          <span class="symbol">&#8208;</span> System-wide settings.</p><div class="itemizedlist"><ul type="square"><li><p>Default values for the system.</p></li></ul></div></li></ul></div></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_The_entities_xml_File"></a>2.1.&nbsp;The entities.xml File</h2></div></div></div><p>The file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entities.xml</code>
    is used by the BigWorld engine to determine the types of entities
    available for use.</p><p>Each tag in this file represents an entity type, and must have a
    corresponding definition file in the directory <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs</code>,
    and at least one Python script file in either the <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base</code>
    or
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell</code>
    directory. It may also have a script file in <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client</code>.</p><p>The order in which the entity types are declared in this file
    corresponds to the final entity ID associated with each entity
    type.</p><p>In its simplest form, the entities file has one tag listed for each
    entity to be loaded.</p><p>To define an entity called <code class="classname">NewEntityType</code>,
    simply add a line like the one below:</p><pre class="programlisting">&lt;root&gt;
  ...
  <em class="emphasis">&lt;NewEntityType/&gt;</em>
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entities.xml</code>
    <span class="symbol">&#8208;</span> Entity
    definition</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_The_Definition_File"></a>2.2.&nbsp;The Entity Definition File</h2></div></div></div><p>The entity definition file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    determines how your scripts communicate in BigWorld. This allows the
    BigWorld system to abstract the tasks of sending and receiving messages
    into simply calling different script methods on your entities. In a sense,
    the definition file provides an interface to your entity, and the Python
    scripts provide the implementation.</p><p>The following diagram shows the conceptual parts of a BigWorld
    entity:</p><div class="informalfigure"><div class="mediaobject"><img src="images/conceptual_parts_of_an_entity.png"><span class="caption"><p>Conceptual parts of an entity</p></span></div></div><p>Each entity type has a corresponding definition file, named after
    the entity's type name followed by the extension '<code class="filename">.def</code>'. For example, a
    <code class="classname">Seat</code> entity type would have a file called
    <code class="filename">Seat.def</code>.</p><p>It is useful then, to have a 'minimal' definition file to aid in
    quickly defining a new entity, as well as to assist in explaining what the
    document's section is trying to accomplish.</p><p>The following file is a minimal entity definition file:</p><pre class="programlisting">&lt;root&gt;

  <em class="emphasis">&lt;Parent&gt;</em> optional parent entity &lt;/Parent&gt; <a name="co186" href="#co186_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>

  <em class="emphasis">&lt;Implements&gt;</em> <a name="co188" href="#co188_desc"><img src="../images/callouts/2.png" alt="2" border="0"></a>
     &lt;!-- interface references --&gt;
   &lt;/Implements&gt;

  <em class="emphasis">&lt;ClientName&gt;</em> optional client type &lt;/ClientName&gt; <a name="co192" href="#co192_desc"><img src="../images/callouts/3.png" alt="3" border="0"></a>
  
  <em class="emphasis">&lt;Volatile&gt;</em> <a name="co195" href="#co195_desc"><img src="../images/callouts/4.png" alt="4" border="0"></a>
     &lt;!-- volatile definitions --&gt;
   &lt;/Volatile&gt;

   <em class="emphasis">&lt;Properties&gt;</em> <a name="co199" href="#co199_desc"><img src="../images/callouts/5.png" alt="5" border="0"></a>
     &lt;!-- properties --&gt;
   &lt;/Properties&gt;

  <em class="emphasis">&lt;ClientMethods&gt;</em> <a name="co203" href="#co203_desc"><img src="../images/callouts/6.png" alt="6" border="0"></a>
     &lt;!-- declaration --&gt; 
   &lt;/ClientMethods&gt;

  <em class="emphasis">&lt;CellMethods&gt;</em> <a name="co207" href="#co207_desc"><img src="../images/callouts/7.png" alt="7" border="0"></a>
     &lt;!-- declaration --&gt; 
   &lt;/CellMethods&gt;

  <em class="emphasis">&lt;BaseMethods&gt;</em> <a name="co211" href="#co211_desc"><img src="../images/callouts/8.png" alt="8" border="0"></a>
     &lt;!-- declaration --&gt; 
   &lt;/BaseMethods&gt;

  <em class="emphasis">&lt;LoDLevels&gt;</em> <a name="co215" href="#co215_desc"><img src="../images/callouts/9.png" alt="9" border="0"></a>
    &lt;!-- levels of detail --&gt;
   &lt;/LODLevels&gt;

  <em class="emphasis">&lt;NetworkCompression&gt;</em> <a name="co219" href="#co219_desc"><img src="../images/callouts/10.png" alt="10" border="0"></a>
    &lt;!-- internal and external network compression --&gt;
   &lt;/NetworkCompression&gt;
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;/</code></em>scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    <span class="symbol">&#8208;</span> Minimal entity definition
    file</span></p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co186_desc"></a><a href="#co186"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Entity_Parents" title="6.3.&nbsp;Entity Parents">Entity Parents</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co188_desc"></a><a href="#co188"><img src="../images/callouts/2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Entity_Interfaces" title="6.2.&nbsp;Entity Interfaces">Entity Interfaces</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co192_desc"></a><a href="#co192"><img src="../images/callouts/3.png" alt="3" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Client_Entity_Reuse" title="6.4.&nbsp;Client Entity Reuse">Client Entity Reuse</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co195_desc"></a><a href="#co195"><img src="../images/callouts/4.png" alt="4" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Volatile_Properties" title="4.5.&nbsp;Volatile Properties">Volatile Properties</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co199_desc"></a><a href="#co199"><img src="../images/callouts/5.png" alt="5" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Properties" title="Chapter&nbsp;4.&nbsp;Properties"><i xmlns:xlink="http://www.w3.org/1999/xlink">Properties</i></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co203_desc"></a><a href="#co203"><img src="../images/callouts/6.png" alt="6" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Methods" title="Chapter&nbsp;5.&nbsp;Methods"><i xmlns:xlink="http://www.w3.org/1999/xlink">Methods</i></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co207_desc"></a><a href="#co207"><img src="../images/callouts/7.png" alt="7" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Methods" title="Chapter&nbsp;5.&nbsp;Methods"><i xmlns:xlink="http://www.w3.org/1999/xlink">Methods</i></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co211_desc"></a><a href="#co211"><img src="../images/callouts/8.png" alt="8" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Methods" title="Chapter&nbsp;5.&nbsp;Methods"><i xmlns:xlink="http://www.w3.org/1999/xlink">Methods</i></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co215_desc"></a><a href="#co215"><img src="../images/callouts/9.png" alt="9" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_LOD_Level_Of_Detail_On_Properties" title="4.6.&nbsp;LOD (Level of Detail) on Properties">LOD (Level of Detail) on Properties</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co219_desc"></a><a href="#co219"><img src="../images/callouts/10.png" alt="10" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s
        chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_General_Configuration_Options" class="olink">General Configuration Options</a> for the
        <span class="literal">networkCompression</span> options.</p></td></tr></table></div><p>By the end of this chapter, we should be able to replace all
    placeholders (denoted by italics) in the example file above with actual
    code.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_The_Script_Files"></a>2.3.&nbsp;The Script Files</h2></div></div></div><p>BigWorld Technology divides processing of entities in a game world
    into three different execution contexts:</p><div class="altrow"><table border="0"><colgroup><col width="33%"><col width="33%"><col width="34%"></colgroup><thead><tr><th align="center">Entity type</th><th align="center">Script file location</th><th align="center">Description</th></tr></thead><tbody><tr><td align="left">Cell</td><td align="left"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell</code></td><td align="left">Takes care of the portions of an entity that
              affect the space around it. Processing takes place on the server
              cluster.</td></tr><tr><td align="left">Base</td><td align="left"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base</code></td><td align="left">Takes care of the portions of an entity that
              do not affect the space around it (as well as possibly acting as
              a proxy for a player). Processing takes place on the server
              cluster.</td></tr><tr><td align="left">Client</td><td align="left"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client</code></td><td align="left">Takes care of the portions of an entity that
              require heavy awareness of the surrounding environment.</td></tr></tbody></table></div><p><span class="citetitle">Entity Types</span></p><p>It is possible for some entity instances to not have one of these
    three parts. Furthermore, some entity types may not support ever having
    one of these parts. For each entity type, there is a script file for each
    of CellApp, BaseApp, and Client, if that type supports that execution
    context.</p><p>These script files are named after the entity type, followed by the
    extension '<code class="filename">.py</code>'. This file must
    contain a class with the name of the entity type.</p><p>For example, if you have an entity type <code class="classname">Seat</code>
    that can have cell, base and client execution contexts, there would be
    three script files, each with the implementation of the class:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Seat.py</code></p></li><li><p><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/Seat.py</code></p></li><li><p><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Seat.py</code></p></li></ul></div><p>The entity's base class defined in the script file is determined by
    the execution context that the file represents, as described below:</p><div class="altrow"><table border="0"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr><th align="center">Script file execution context</th><th align="center">Entity's base class</th></tr></thead><tbody><tr><td align="left">Cell</td><td align="left"><code class="classname">BigWorld.Entity</code></td></tr><tr><td align="left">Base</td><td align="left"><code class="classname">BigWorld.Base</code>
              <em class="emphasis">or</em>
              <code class="classname">BigWorld.Proxy</code></td></tr><tr><td align="left">Client</td><td align="left"><code class="classname">BigWorld.Entity</code></td></tr></tbody></table></div><p><span class="citetitle">Entity's base class per execution
    context</span></p><p>For more details about the difference between the
    <code class="classname">Base</code> and <code class="classname">Proxy</code> classes, see
    <a href="#xref_Proxies_And_Players" title="Chapter&nbsp;11.&nbsp;Proxies and Players"><i xmlns:xlink="http://www.w3.org/1999/xlink">Proxies and Players</i></a>.</p><p>The start of the script for a <code class="classname">Seat</code> entity
    could be implemented as below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Cell script file <span class="symbol">&#8208;</span>
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Seat.py</code></em></p><pre class="programlisting">import BigWorld

class <em class="emphasis">Seat</em>( <em class="emphasis">BigWorld.Entity</em> ):
  def __init__( self ):
    BigWorld.Entity.__init__( self )</pre></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Base script file <span class="symbol">&#8208;</span>
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/Seat.py</code></em></p><pre class="programlisting">import BigWorld

class <em class="emphasis">Seat</em>( <em class="emphasis">BigWorld.Base</em> ):
  def __init__( self ):
    BigWorld.Base.__init__( self )</pre></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Client script file <span class="symbol">&#8208;</span>
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Seat.py</code></em></p><pre class="programlisting">import BigWorld

class <em class="emphasis">Seat</em>( <em class="emphasis">BigWorld.Entity</em> ):
  def __init__( self ):
    BigWorld.Entity.__init__( self )</pre></li></ul></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Physical_UDO_Structure_For_Scripting"></a>Chapter&nbsp;3.&nbsp;Physical User Data Object Structure for Scripting</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_The_udos_xml_File">3.1. The user_data_objects.xml File</a></span></dt><dt><span class="section"><a href="#xref_The_UDO_Definition_File">3.2. The User Data Object Definition File</a></span></dt><dt><span class="section"><a href="#xref_The_UDO_Script_Files">3.3. The Script Files</a></span></dt></dl></div><p>User data objects are a way of embedding user defined data in Chunk
  files. Each user data object type is implemented as a collection of Python
  scripts, and an XML-based definition file that ties the scripts together.
  These scripts are located in the resource tree under the folder
  <code class="filename">scripts</code> (i.e.,
  <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts</code>, where
  <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em> </code>is the virtual
  tree defined <code class="filename">~/.bwmachined.conf</code>).</p><p>User data objects differ from entities in that they are immutable
  (i.e. their properties don't change), and that they are not propagated to
  other cells or clients. This makes them a lot lighter than entities.</p><p>A key feature of user data objects is their linkability. Entities are
  able to link to user data objects, and user data objects are able to link to
  other user data objects. This is achieved by including a
  <span class="literal">UDO_REF</span> property in the definition file for the user data
  object or entity that wishes to link to another user data object.</p><p>The list below summarises the important files and directories for user
  data objects in
  <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em></code>:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em></code></em>
      &#8212; Resource tree defined in
      <code class="filename">~/.bwmachined.conf</code>.</p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><code class="filename">scripts</code></em>
          &#8212; Folder containing all entity files.</p><div class="itemizedlist"><ul type="square"><li><p><em class="emphasis"><code class="filename">user_data_objects.xml</code></em>
              &#8212; Lists all user data objects to load into the client or the
              server at start-up time.</p></li><li><p><em class="emphasis"><code class="filename">base</code></em>
              &#8212; Folder contains Python scripts for user data objects with a
              base component.</p></li><li><p><em class="emphasis"><code class="filename">cell</code></em>
              &#8212; Folder contains Python scripts for user data objects with a
              cell component.</p></li><li><p><em class="emphasis"><code class="filename">client</code></em> &#8212; Folder
              contains Python scripts for user data objects with a client
              component.</p></li><li><p><em class="emphasis"><code class="filename">common</code></em> &#8212; Folder
              listed in the Python search path for all components. Used for
              common game code.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="filename">lib</code></em> &#8212; Folder
                    listed in the Python search path for all components. Used
                    for common game code.</p></li></ul></div></li><li><p><em class="emphasis"><code class="filename">user_data_object_defs</code></em>
              &#8212; Contains the user data object definition files.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="filename"><em class="replaceable"><code>&lt;user_data_object.def&gt;</code></em></code></em>
                  &#8212; User data object definition file. There is one such file
                  for each user data object defined in
                  <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/user_data_objects.xml</code>.</p></li><li><p><em class="emphasis"><code class="filename">interfaces</code></em> &#8212;
                  User data object interface definition files</p></li></ul></div></li></ul></div></li></ul></div></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_The_udos_xml_File"></a>3.1.&nbsp;The user_data_objects.xml File</h2></div></div></div><p>The file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/user_data_objects.xml</code>
    is used by the BigWorld engine to determine the types of user data objects
    available for use.</p><p>The file structure matches that of the
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/entities/entities.xml</code>.
    For further details refer to <a href="#xref_The_entities_xml_File" title="2.1.&nbsp;The entities.xml File">The entities.xml File</a></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_The_UDO_Definition_File"></a>3.2.&nbsp;The User Data Object Definition File</h2></div></div></div><p>The user data object definition file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/user_data_object_defs/<em class="replaceable"><code>&lt;user_data_object&gt;</code></em>.def</code>
    determines the properties it will store and make accessible to BigWorld
    entities. The user data object definition file also specifies if the user
    data object should be created in the server or in the client.</p><p>The following file is a minimal entity definition file:</p><pre class="programlisting">&lt;root&gt;

  &lt;Domain&gt; the execution context for this user &lt;/Domain&gt; <a name="co186_domain" href="#co186_domain_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>

  &lt;Parent&gt; optional parent entity &lt;/Parent&gt; <a name="co186_parent" href="#co186_parent_desc"><img src="../images/callouts/2.png" alt="2" border="0"></a>

  &lt;Implements&gt; <a name="co188_implements" href="#co188_implements_desc"><img src="../images/callouts/3.png" alt="3" border="0"></a>
     &lt;!-- interface references --&gt;
   &lt;/Implements&gt;

   &lt;Properties&gt; <a name="co199_properties" href="#co199_properties_desc"><img src="../images/callouts/4.png" alt="4" border="0"></a>
     &lt;!-- properties --&gt;
   &lt;/Properties&gt;

&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;/</code></em>scripts/user_data_object_defs/<em class="replaceable"><code>&lt;user_data_object&gt;</code></em>.def</code>
    &#8212; Minimal user data object definition file</span></p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co186_domain_desc"></a><a href="#co186_domain"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>The domain for a user data object can be either
        <span class="literal">CLIENT</span>, <span class="literal">CELL</span> or
        <span class="literal">BASE</span>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co186_parent_desc"></a><a href="#co186_parent"><img src="../images/callouts/2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Entity_Parents" title="6.3.&nbsp;Entity Parents">Entity Parents</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co188_implements_desc"></a><a href="#co188_implements"><img src="../images/callouts/3.png" alt="3" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Entity_Interfaces" title="6.2.&nbsp;Entity Interfaces">Entity Interfaces</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co199_properties_desc"></a><a href="#co199_properties"><img src="../images/callouts/4.png" alt="4" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Properties" title="Chapter&nbsp;4.&nbsp;Properties"><i xmlns:xlink="http://www.w3.org/1999/xlink">Properties</i></a>.</p></td></tr></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_The_UDO_Script_Files"></a>3.3.&nbsp;The Script Files</h2></div></div></div><p>BigWorld Technology divides processing of entities in a game world
    into three different execution contexts, depending on its
    <span class="literal">Domain</span>:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">User Data Object Domain: Cell &#8212; Script
        File Location:
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell</code></em></p><p>User data objects to be used by entities in the cell.</p></li><li><p><em class="emphasis">User Data Object Domain: Base &#8212; Script
        File Location:
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base</code></em></p><p>User data objects to be used by entities in the base.</p></li><li><p><em class="emphasis">User Data Object Domain: Client &#8212; Script
        File Location:
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client</code></em></p><p>User data objects to be used by entities in the client.</p></li></ul></div><p>Most implementations of user data objects will only live either in
    the cell or in the client. For an example of a user data object that lives
    in the cell, see the <span class="literal">PatrolNode</span> user data object
    scripts and definition file in the
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts</code>
    folder. For an example of a client-only user data object, look in the same
    place for the scripts and definition file of the
    <span class="literal">CameraNode</span> user data object.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Properties"></a>Chapter&nbsp;4.&nbsp;Properties</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Property_Types">4.1. Property Types</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Primitive_Types">4.1.1. Primitive Types</a></span></dt><dt><span class="section"><a href="#xref_Composite_Types">4.1.2. Composite Types</a></span></dt><dt><span class="section"><a href="#xref_Custom_User_Types">4.1.3. Custom User Types</a></span></dt><dt><span class="section"><a href="#xref_Alias_Of_Data_Types">4.1.4. Alias of Data Types</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Default_Values">4.2. Default Values</a></span></dt><dt><span class="section"><a href="#xref_Data_Distribution">4.3. Data Distribution</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Data_Distribution_Combinations">4.3.1. Valid Data Distribution Combinations</a></span></dt><dt><span class="section"><a href="#xref_Data_Distribution_Usage">4.3.2. Using Distribution Flags</a></span></dt><dt><span class="section"><a href="#d0e2493">4.3.3. Data Propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Implementing_Custom_Property_Data_Types">4.4. Implementing Custom Property Data Types</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2548">4.4.1. Wrapping a FIXED_DICT Data Type</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Volatile_Properties">4.5. Volatile Properties</a></span></dt><dt><span class="section"><a href="#xref_LOD_Level_Of_Detail_On_Properties">4.6. LOD (Level of Detail) on Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e3627">4.6.1. LOD and Hysteresis</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e3824">4.7. Temporary Properties</a></span></dt><dt><span class="section"><a href="#xref_UDO_Linking">4.8. User Data Object Linking With <span class="literal">UDO_REF</span>
    Properties</a></span></dt></dl></div><p>Properties describe what the state of an entity is. Like traditional
  object systems, a BigWorld property has a type and a name. Unlike
  traditional object systems, a property also has distribution properties that
  affect where and how frequently it is distributed around the system.</p><p>Properties are declared in the entity's definition file (named
  <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>),
  in a section named <code class="property">Properties</code>.</p><p>The grammar for property definition is displayed below:</p><pre class="programlisting">&lt;root&gt;
   ...
   &lt;<em class="emphasis">Properties</em>&gt;
      &lt;<em class="replaceable"><code>propertyName</code></em>&gt;
         &lt;!-- type of this property --&gt;
         &lt;<em class="emphasis">Type</em>&gt; <em class="replaceable"><code>TYPE_NAME</code></em> &lt;/Type&gt; <a name="co427" href="#co427_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>

         &lt;!-- Method of distribution --&gt;
         &lt;<em class="emphasis">Flags</em>&gt; <em class="replaceable"><code>DISTRIBUTION_FLAGS</code></em> &lt;/Flags&gt; <a name="co430" href="#co430_desc"><img src="../images/callouts/2.png" alt="2" border="0"></a>

         &lt;!-- Default value (optional) --&gt;
         &lt;<em class="emphasis">Default</em>&gt; <em class="replaceable"><code>DEFAULT_VALUE</code></em> &lt;/Default&gt; <a name="co433" href="#co433_desc"><img src="../images/callouts/3.png" alt="3" border="0"></a>

         &lt;!-- Is the property editable? (true/false) (optional) --&gt;
         &lt;<em class="emphasis">Editable</em>&gt; [true|false] &lt;/Editable&gt;

         &lt;!-- Level of detail for this property (optional) --&gt;
         &lt;<em class="emphasis">DetailLevel</em>&gt; <em class="replaceable"><code>LOD</code></em> &lt;/DetailLevel&gt; <a name="co439" href="#co439_desc"><img src="../images/callouts/4.png" alt="4" border="0"></a>

         &lt;!-- Is the property persistent? --&gt;
         &lt;<em class="emphasis">Persistent</em>&gt; [true|false] &lt;/Persistent&gt; <a name="co442" href="#co442_desc"><img src="../images/callouts/5.png" alt="5" border="0"></a>

      &lt;/<em class="replaceable"><code>propertyName</code></em>&gt;
   &lt;/Properties&gt;
   ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
  &#8212; Property definition syntax</span></p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co427_desc"></a><a href="#co427"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Property_Types" title="4.1.&nbsp;Property Types">Property Types</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co430_desc"></a><a href="#co430"><img src="../images/callouts/2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Data_Distribution" title="4.3.&nbsp;Data Distribution">Data Distribution</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co433_desc"></a><a href="#co433"><img src="../images/callouts/3.png" alt="3" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Default_Values" title="4.2.&nbsp;Default Values">Default Values</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co439_desc"></a><a href="#co439"><img src="../images/callouts/4.png" alt="4" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_LOD_Level_Of_Detail_On_Properties" title="4.6.&nbsp;LOD (Level of Detail) on Properties">LOD (Level of Detail) on Properties</a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co442_desc"></a><a href="#co442"><img src="../images/callouts/5.png" alt="5" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_The_Database_Layer" title="Chapter&nbsp;8.&nbsp;The Database Layer"><i xmlns:xlink="http://www.w3.org/1999/xlink">The Database Layer</i></a>.</p></td></tr></table></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Property_Types"></a>4.1.&nbsp;Property Types</h2></div></div></div><p>BigWorld needs to efficiently transmit data over a network between
    its various components. For this purpose, BigWorld definition file
    describes the type of each property of an entity (despite the fact that
    BigWorld is scripted using Python &#8212; an untyped language).</p><p>Because bandwidth conservation is important in implementing an MMOG,
    property types should be selected such that they are the smallest type (in
    terms of number of bits) that can represent the data.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Primitive_Types"></a>4.1.1.&nbsp;Primitive Types</h3></div></div></div><p>The following list summarises the primitive types available for
      BigWorld properties:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">BLOB</span> &#8212; Size (bytes):
          <span class="literal"><em class="replaceable"><code>N</code></em></span>+<span class="literal"><em class="replaceable"><code>k</code></em></span></em></p><p>Binary data. Similar to a string, but can contain NULL
          characters.</p><p>Stored in base-64 encoding when in XML,
          <em class="emphasis">e.g.</em>, in the XML database.</p><p><span class="literal"><em class="replaceable"><code>N</code></em></span> is the number
          of bytes in the blob, and
          <span class="literal"><em class="replaceable"><code>k</code></em>=4</span>.</p></li><li><p><em class="emphasis"><span class="literal">FLOAT32</span> &#8212; Size
          (bytes): 4</em></p><p>IEEE 32-bit floating-point number.</p></li><li><p><em class="emphasis"><span class="literal">FLOAT64</span> &#8212; Size
          (bytes): 8</em></p><p>IEEE 64-bit floating-point number.</p></li><li><p><em class="emphasis"><span class="literal">INT8</span> &#8212; Size (bytes):
          1 &#8212; Range: From: -128 To: 127</em></p><p>Signed 8-bit integer.</p></li><li><p><em class="emphasis"><span class="literal">INT16</span> &#8212; Size (bytes):
          2 &#8212; Range: From: -32,768 To: 32,767</em></p><p>Signed 16-bit integer.</p></li><li><p><em class="emphasis"><span class="literal">INT32</span> &#8212; Size (bytes):
          4 &#8212; Range: From: -2,147,483,648 To: 2,147,483,647</em></p><p>Signed 32-bit integer.</p></li><li><p><em class="emphasis"><span class="literal">INT64</span> &#8212; Size (bytes):
          8 &#8212; Range: From: -9,223,372,036,854,775,808 To:
          9,223,372,036,854,775,807</em></p><p>Signed 64-bit integer.</p></li><li><p><em class="emphasis"><span class="literal">MAILBOX</span> &#8212; Size
          (bytes): 12</em></p><p>A BigWorld mailbox.</p><p>Passing an entity to a <span class="literal">MAILBOX</span> argument
          automatically converts it to <span class="literal">MAILBOX</span>.</p><p>For details, see <a href="#xref_Mailboxes" title="5.8.&nbsp;Mailboxes">Mailboxes</a>.</p></li><li><p><em class="emphasis"><span class="literal">PYTHON</span> &#8212; Size(bytes):
          Size of pickled string, as per
          <span class="literal">STRING</span></em></p><p>Uses the Python pickler to pack any Python type into a string,
          and transmits the result.</p><p>This should not be used between client and server, as it is
          insecure and inefficient.</p><p>It is recommended to use a user data type for production code.
          For more details, see <a href="#xref_Implementing_Custom_Property_Data_Types" title="4.4.&nbsp;Implementing Custom Property Data Types">Implementing Custom Property Data Types</a>.</p></li><li><p><em class="emphasis"><span class="literal">STRING</span> &#8212; Size
          (bytes):
          <span class="literal"><em class="replaceable"><code>N</code></em></span>+<span class="literal"><em class="replaceable"><code>k</code></em></span></em></p><p>Character string (non-Unicode).</p><p><span class="literal"><em class="replaceable"><code>N</code></em></span> is the number
          of characters in the string, and
          <span class="literal"><em class="replaceable"><code>k</code></em>=4</span>.</p></li><li><p><em class="emphasis"><span class="literal">UINT8</span> &#8212; Size(bytes):
          1 - Range: From: 0 To: 255</em></p><p>Unsigned 8-bit integer.</p></li><li><p><em class="emphasis"><span class="literal">UINT16</span> &#8212; Size(bytes):
          2 &#8212; Range: From: 0 To: 65,535</em></p><p>Unsigned 16-bit integer.</p></li><li><p><em class="emphasis"><span class="literal">UINT32</span> &#8212; Size(bytes):
          4 &#8212; Range: From: 0 To: 4,294,967,295</em></p><p>Unsigned 32-bit integer.</p><p><em class="emphasis">This type may use Python's <span class="literal">long</span>
          type instead of <span class="literal">int</span>, and so might be less
          efficient than <span class="literal">INT32</span>.</em></p></li><li><p><em class="emphasis"><span class="literal">UINT64</span> &#8212; Size(bytes):
          8 &#8212; Range: From: 0 To: 18,446,744,073,709,551,615</em></p><p>Unsigned 64-bit integer.</p></li><li><p><em class="emphasis"><span class="literal">UNICODE_STRING</span> &#8212; Size
          (bytes): Up to
          4<span class="literal"><em class="replaceable"><code>N</code></em></span>+<span class="literal"><em class="replaceable"><code>k</code></em></span></em></p><p>Character string (Unicode).</p><p><span class="literal"><em class="replaceable"><code>N</code></em></span> is the number
          of characters in the string, and
          <span class="literal"><em class="replaceable"><code>k</code></em>=4</span>. Streamed as
          UTF-8.</p></li><li><p><em class="emphasis"><span class="literal">VECTOR2</span> &#8212;
          Size(bytes): 8</em></p><p>Two-dimensional vector of 32-bit floats. Represented in Python
          as a tuple of two numbers (or
          <span class="literal">Math.Vector2</span>).</p></li><li><p><em class="emphasis"><span class="literal">VECTOR3</span> &#8212;
          Size(bytes): 12</em></p><p>Three-dimensional vector of 32-bit floats. Represented in
          Python as a tuple of three numbers (or
          <span class="literal">Math.Vector3</span>).</p></li><li><p><em class="emphasis"><span class="literal">VECTOR4</span> &#8212;
          Size(bytes): 16</em></p><p>Four-dimensional vector of 32-bit floats. Represented in
          Python as a tuple of four numbers (or
          <span class="literal">Math.Vector4</span>).</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Composite_Types"></a>4.1.2.&nbsp;Composite Types</h3></div></div></div><p>The following sections describe the composite types available in
      BigWorld.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_ARRAY_And_TUPLE_Types"></a>4.1.2.1.&nbsp;ARRAY and TUPLE Types</h4></div></div></div><p>BigWorld also has ARRAY and TUPLE types, which can create an
        array of values of any of the BigWorld primitive types.</p><p>Properties of ARRAY type have a byte size calculated by the
        formula below:</p><div class="blockquote"><blockquote class="blockquote"><p>N * t + k</p></blockquote></div><p>The components of the formula are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">N</span></em> &#8212;
            Number of elements in the array.</p></li><li><p><em class="emphasis"><span class="literal">t</span></em> &#8212; Size
            of the type contained in the array.</p></li><li><p><em class="emphasis"><span class="literal">k</span></em> &#8212;
            Constant.</p></li></ul></div><p>The BigWorld TUPLE type is represented in script by the Python
        tuple type, while the BigWorld ARRAY type is represented in script by
        Python list type.</p><p>Tuples are specified as follows:</p><pre class="programlisting">&lt;Type&gt; <em class="emphasis">TUPLE</em> &lt;of&gt; [TYPE_NAME|TYPE_ALIAS] &lt;/of&gt; [&lt;size&gt; n &lt;/size&gt;] &lt;/Type&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
        &#8212; <span class="literal">TUPLE</span> declaration syntax</span></p><p>Arrays are specified as follows:</p><pre class="programlisting">&lt;Type&gt; <em class="emphasis">ARRAY</em> &lt;of&gt; [TYPE_NAME|TYPE_ALIAS] &lt;/of&gt; [&lt;size&gt; n &lt;/size&gt;] &lt;/Type&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
        &#8212; <span class="literal">ARRAY</span> declaration syntax</span></p><p>In case the size of an <code class="property">ARRAY</code> or
        <code class="property">TUPLE</code> is specified, then it must have the
        declared <em class="emphasis">n</em> elements. Adding or deleting elements
        to fixed-sized <code class="property">ARRAY</code> or
        <code class="property">TUPLE</code> is not allowed. If the default value is not
        specified, then a fixed-sized <code class="property">ARRAY</code> or
        <code class="property">TUPLE</code> will contain <em class="emphasis">n</em> default
        values of the element type.</p><p>Arrays have a special method called
        <code class="methodname">equals_seq()</code> that can be used for performing
        element-wise Boolean equality testing against any arbitrary Python
        sequence (including Python lists and tuples). For example:</p><pre class="programlisting">self.myList = [1,2,3]
self.myList.equals_seq( [1,2,3] )
# should return True
self.myList.equals_seq( (1,2,3) )
# should return True</pre><p>Arrays efficiently propagate changes. This includes assigning to
        individual elements, appending, extending, removing, popping and slice
        assignment.</p><p>For example, each of the following are propagated
        efficiently.</p><pre class="programlisting">self.myList = [1, 2, 3, 4, 5]
self.myList[ 3 ] = 8
self.myList.append( 6 )
self.myList.extend( [7, 8] )
self.myList += [9, 10]
self.myList.pop()
self.myList.remove( 7 )
self.myList[ 2 : 5 ] = [11, 12]
del self.myList[ 2 ]
del self.myList[ 1 : 4 ]</pre><p>Arrays can not only contain aliased data types, but may also be
        aliased themselves. For more details, see <a href="#xref_Alias_Of_Data_Types" title="4.1.4.&nbsp;Alias of Data Types">Alias of Data Types</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_FIXED_DICT_Data_Type"></a>4.1.2.2.&nbsp;FIXED_DICT Data Type</h4></div></div></div><p>The <span class="literal">FIXED_DICT</span> data type allows you to define
        dictionary-like attributes with a fixed set of string keys. The keys
        and the types of the keyed values are predefined.</p><p>The declaration of a <span class="literal">FIXED_DICT</span> is
        illustrated below:</p><pre class="programlisting">&lt;Type&gt; FIXED_DICT

  &lt;Parent&gt; <em class="replaceable"><code>ParentFixedDictTypeDeclaration</code></em> &lt;/Parent&gt;
   &lt;Properties&gt;

    &lt;<em class="replaceable"><code>field</code></em>&gt;
      &lt;Type&gt; <em class="replaceable"><code>FieldTypeDeclaration</code></em> &lt;/Type&gt;
     &lt;/<em class="replaceable"><code>field</code></em>&gt;

   &lt;/Properties&gt;

  &lt;AllowNone&gt; true|false &lt;/AllowNone&gt; <a name="co734" href="#co734_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>

&lt;/Type&gt;</pre><p><span class="citetitle"><span class="literal">FIXED_DICT</span> data type
        declaration</span></p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co734_desc"></a><a href="#co734"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>Default is <span class="literal">false</span>. If set to
            <span class="literal">true</span>, then None may be used as the value of the
            whole dictionary.</p></td></tr></table></div><p>This data type may be declared anywhere a type declaration may
        appear, <em class="emphasis">e.g.</em>, in
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</code>
        <sup>[<a name="d0e1420" href="#ftn.d0e1420">1</a>]</sup>, in
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>,
        as method call arguments, etc.</p><p>The code excerpt below shows the declaration of a
        <span class="literal">FIXED_DICT</span> attribute:</p><pre class="programlisting">&lt;root&gt;
  &lt;TradeLog&gt; <em class="emphasis">FIXED_DICT</em>
    &lt;Properties&gt;
      &lt;dbIDA&gt;
        &lt;<em class="emphasis">Type</em>&gt;      INT64                 &lt;/Type&gt;
      &lt;/dbIDA&gt;
      &lt;itemsTypesA&gt;
        &lt;<em class="emphasis">Type</em>&gt;      ARRAY &lt;of&gt; ITEM &lt;/of&gt; &lt;/Type&gt;      
      &lt;/itemsTypesA&gt;
      &lt;goldPiecesA&gt;
        &lt;<em class="emphasis">Type</em>&gt;      GOLDPIECES            &lt;/Type&gt;
      &lt;/goldPiecesA&gt;
    &lt;/Properties&gt;
  &lt;/TradeLog&gt;
&lt;/root&gt;</pre><p><span class="citetitle"><span class="literal">fantasydemo/res/scripts/entity_defs/alias.xml</span></span></p><p>Instances of <span class="literal">FIXED_DICT</span> can be accessed and
        modified like a Python dictionary, with the following
        exceptions:</p><div class="itemizedlist"><ul type="disc"><li><p>Keys cannot be added or deleted</p></li><li><p>The type of the value must match the declaration.</p></li></ul></div><p>For example:</p><pre class="programlisting">if entity.TradeLog[ "dbIDA" ] == 0:
  entity.TradeLog[ "dbIDA" ] = 100</pre><p><span class="citetitle">Example of <span class="literal">FIXED_DICT</span> usage in
        script</span></p><p>Alternatively, it also supports the following:</p><pre class="programlisting">if entity.TradeLog.dbIDA == 0:
  entity.TradeLog.dbIDA = 100</pre><p><span class="citetitle">Example of <span class="literal">FIXED_DICT</span> usage as
        struct in script</span></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Using struct syntax can cause problems with name collisions
          with FIXED_DICT methods.</p></div><p>A <span class="literal">FIXED_DICT</span> instance can be set using a
        Python dictionary that has a superset of the keys required. Any
        unnecessary keys in the dictionary are ignored.</p><p>For example:</p><pre class="programlisting">entity.TradeLog = { "dbIDA" : 100, "itemsTypesA" : [ 1, 2, 3 ], 
     "goldPiecesA" : 1000, "redundantKey" : 12345 }</pre><p><span class="citetitle">Example of <span class="literal">FIXED_DICT</span> instance
        being set using a Python dictionary</span></p><p>When setting a <span class="literal">FIXED_DICT</span> instance using a
        Python dictionary, the values of the Python dictionary are referenced
        by the <span class="literal">FIXED_DICT</span> instance.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>When setting a <span class="literal">FIXED_DICT</span> instance using a
          Python dictionary in the BaseApp, the Python dictionary replaces the
          <span class="literal">FIXED_DICT</span> instance. Thus, the entire Python
          dictionary is being referenced, not just its values.</p><p>As a result of this behaviour, there is the possibility of
          <span class="literal">FIXED_DICT</span> attribute having more keys than in its
          declaration.</p><p>This BaseApp behaviour may be changed in a future release of
          BigWorld so that it matches the rest of the system.</p></div><p>Changes to <span class="literal">FIXED_DICT</span> values are propagated
        efficiently wherever a change to the whole property would be
        propagated, <em class="emphasis">i.e.</em>, to ghosts and to clients &#8212;
        including <code class="varname">ownClients</code>.</p><p>The default value of a <span class="literal">FIXED_DICT</span> data type
        can be specified at the entity property level. For example:</p><pre class="programlisting">&lt;root&gt;
  &lt;Properties&gt; <em class="emphasis">FIXED_DICT</em>
    &lt;<em class="emphasis">someProperty</em>&gt;
      &lt;Type&gt;  TradeLog    &lt;/Type&gt;    &lt;!-- From last example --&gt;
      &lt;<em class="emphasis">Default</em>&gt;
        &lt;dbIDA&gt;  0  &lt;/dbIDA&gt;
        &lt;itemsTypesA&gt;
          &lt;item&gt;  101  &lt;/item&gt;
          &lt;item&gt;  102  &lt;/item&gt;
        &lt;/itemsTypesA&gt;
        &lt;goldPiecesA&gt;  100  &lt;/goldPiecesA&gt;
      &lt;/Default&gt;
    &lt;/someProperty&gt;
  &lt;/Properties&gt;
&lt;/root&gt;</pre><p> <span class="citetitle">Example of specifying default value
        of a <span class="literal">FIXED_DICT</span> data type in an entity definition
        file</span></p><p>If the <code class="property">&lt;Default&gt;</code> section is not
        specified, then the default value of a <span class="literal">FIXED_DICT</span>
        data type will depend on the value of the
        <code class="property">&lt;allowNone&gt;</code> tag, as described below:</p><div class="altrow"><a name="d0e1579"></a><p class="title"><b>Table&nbsp;4.1.&nbsp;Default values for a FIXED_DICT without a &lt;Default&gt;
            section.</b></p><div class="altrow-contents"><table summary="Default values for a FIXED_DICT without a <Default&gt;&#xA;            section." border="0" width="75%"><colgroup><col width="18%"><col width="82%"></colgroup><thead><tr><th align="left">&lt;AllowNone&gt;</th><th align="left"><span class="literal">FIXED_DICT</span> default
                  value</th></tr></thead><tbody><tr><td align="left">True</td><td align="left">Python <span class="literal">None</span>
                  object.</td></tr><tr><td align="left">False</td><td align="left"><p>Python dictionary with keys as
                  specified in the type definition.</p><p>Each keyed
                  value will have a default value according to its type. For
                  example, a keyed value of <span class="literal">INT</span> type will
                  have a default value of 0.</p></td></tr></tbody></table></div></div><p><br class="altrow-break"></p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Custom_User_Types"></a>4.1.3.&nbsp;Custom User Types</h3></div></div></div><p>There are two ways to incorporate user-defined Python classes into
      BigWorld entities: wrapping a <span class="literal">FIXED_DICT</span> data type,
      or implementing a <span class="literal">USER_TYPE</span>.</p><p>The <span class="literal">FIXED_DICT</span> data type supports being wrapped
      by a user-defined Python type. When a <span class="literal">FIXED_DICT</span> is
      wrapped, BigWorld will instantiate the user-defined Python type in place
      of a <span class="literal">FIXED_DICT</span> instance. This enables the user to
      customise the behaviour of a <span class="literal">FIXED_DICT</span> data
      type.</p><p>The type system can also be arbitrarily extended with the
      <span class="literal">USER_TYPE</span> type. Unlike a wrapped
      <span class="literal">FIXED_DICT</span> type, the structure of a
      <span class="literal">USER_TYPE</span> type is completely opaque to BigWorld. As
      such, the implementation of a <span class="literal">USER_TYPE</span> type is more
      involved. The implementation of the type operations is performed by a
      Python object (such as an instance of a class) written by the user. The
      Python object serves as a factory and serialiser for instances of that
      type, and it can choose to use whatever Python representation of that
      type it sees fit &#8212; it can be as simple as an integer, or it can be an
      instance of a Python class.</p><p>For more details on custom user types, see <a href="#xref_Implementing_Custom_Property_Data_Types" title="4.4.&nbsp;Implementing Custom Property Data Types">Implementing Custom Property Data Types</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Alias_Of_Data_Types"></a>4.1.4.&nbsp;Alias of Data Types</h3></div></div></div><p>BigWorld also allows aliases of types to be created. Aliases are a
      concept similar to a C++ <span class="literal">typedef</span>, and are listed in
      the XML file
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</code>.
      The format is described below:</p><pre class="programlisting">&lt;root&gt;
  ... other alias definitions ...
  &lt;<em class="emphasis">ALIAS_NAME</em>&gt; <em class="emphasis">TYPE_TO_ALIAS</em> [&lt;Default&gt; Value &lt;/Default&gt;<a name="co918" href="#co918_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a> ] &lt;/ALIAS_NAME&gt;
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</code>
      &#8212; Data type alias declaration syntax</span></p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co918_desc"></a><a href="#co918"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Default_Values" title="4.2.&nbsp;Default Values">Default Values</a>.</p></td></tr></table></div><p>Some examples of useful aliases are described in the list
      below:</p><div class="altrow"><a name="d0e1697"></a><p class="title"><b>Table&nbsp;4.2.&nbsp;Entity Types</b></p><div class="altrow-contents"><table summary="Entity Types" border="0"><colgroup><col width="18%"><col width="18%"><col width="64%"></colgroup><thead><tr><th align="left">Alias</th><th align="left">Maps to</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><span class="literal">ANGLE</span></td><td align="left"><span class="literal">FLOAT32</span></td><td align="left">An angle measured in radians.</td></tr><tr><td align="left"><span class="literal">BOOL</span></td><td align="left"><span class="literal">INT8</span></td><td align="left"><p>A Boolean type (encoded as
                zero=false, non-zero=true).</p><p>Mapped to
                <span class="literal">INT8</span>, the smallest BigWorld
                type.</p></td></tr><tr><td align="left"><span class="literal">INFO</span></td><td align="left"><span class="literal">UINT16</span></td><td align="left">Element of information about a
                mission.</td></tr><tr><td align="left"><span class="literal">MISSION_STATS</span></td><td align="left"><span class="literal">ARRAY &lt;of&gt; INFO
                &lt;/of&gt;</span></td><td align="left"><p>Array of mission information data
                elements (<em class="emphasis">i.e.</em>, <span class="literal">INFO</span>
                type alias).</p><p>Note that this is an aliased array,
                and the type of its elements is an aliased
                type.</p></td></tr><tr><td align="left"><span class="literal">OBJECT_ID</span></td><td align="left"><span class="literal">INT32</span></td><td align="left">Handle to another entity. The name makes
                clear the property contains a handle to an entity.</td></tr><tr><td align="left"><span class="literal">STATS_MATRIX</span></td><td align="left"><span class="literal">ARRAY &lt;of&gt; MISSION_STATS
                &lt;/of&gt;</span></td><td align="left"><p>Matrix of mission information data
                elements (<em class="emphasis">i.e.</em>, <span class="literal">INFO</span>
                type alias).</p><p>Note that this is an aliased array,
                and the type of its elements is another aliased
                array.</p></td></tr></tbody></table></div></div><p><br class="altrow-break"></p><p>Using the syntax for alias definition to the aliases describe
      above, we have the following file:</p><pre class="programlisting">&lt;root&gt;

  &lt;!-- Aliased data types --&gt; 
  &lt;<em class="emphasis">OBJECT_ID</em>&gt;  <em class="emphasis">INT32</em>   &lt;/OBJECT_ID&gt;
  &lt;<em class="emphasis">BOOL</em>&gt;       <em class="emphasis">INT8</em>    &lt;/BOOL&gt;
  &lt;<em class="emphasis">ANGLE</em>&gt;      <em class="emphasis">FLOAT32</em> &lt;/ANGLE&gt;
  &lt;<em class="emphasis">INFO</em>&gt;       <em class="emphasis">UINT16</em>  &lt;/INFO&gt;

  &lt;!-- Aliased arrays ?
  &lt;<em class="emphasis">MISSION_STATS</em>&gt;  <em class="emphasis">ARRAY &lt;of&gt; INFO           &lt;/of&gt; &lt;/MISSION_STATS&gt;</em>
  &lt;<em class="emphasis">STATS_MATRIX</em>&gt;   <em class="emphasis">ARRAY &lt;of&gt; MISSION_STATS  &lt;/of&gt;  &lt;/STATS_MATRIX&gt;</em>

&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</code>
      &#8212; Definition of data type alias</span></p><p>With aliases, one can also define custom Python data types, which
      have their own streaming semantics on the network. We declare these
      types in the file
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</code>
      file as follows:</p><pre class="programlisting">&lt;root&gt;
  &lt;<em class="emphasis">ALIAS_NAME</em>&gt; 
    <em class="emphasis">USER_TYPE</em> 
    &lt;<em class="emphasis">implementedBy</em>&gt; <em class="emphasis">UserDataType.instance</em> &lt;/implementedBy&gt;
  &lt;/ALIAS_NAME&gt;
&lt;/root&gt;</pre><p><span class="citetitle"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</span>
      &#8212; Custom Python data type declaration syntax</span></p><p>For more details on this mechanism, see <a href="#xref_Implementing_Custom_Property_Data_Types" title="4.4.&nbsp;Implementing Custom Property Data Types">Implementing Custom Property Data Types</a>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Default_Values"></a>4.2.&nbsp;Default Values</h2></div></div></div><p>When an entity is created, its properties are initialised to their
    default values. Default values can be overridden at the property level (in
    the entity definition file<sup>[<a name="d0e1875" href="#ftn.d0e1875">2</a>]</sup>) or at the type level (in
    <code class="filename">alias.xml</code><sup>[<a name="d0e1881" href="#ftn.d0e1881">3</a>]</sup>).</p><p>The default value for each type and the syntax for overriding it are
    described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">ARRAY</span> &#8212; Default:
        <span class="literal">[]</span></em></p><p><em class="emphasis">Example: </em></p><pre class="programlisting">&lt;Default&gt; <a name="co1052" href="#co1052_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>
   &lt;item&gt; Health potion &lt;/item&gt;
   &lt;item&gt; Bear skin     &lt;/item&gt;
   &lt;item&gt; Wooden shield &lt;/item&gt;
&lt;/Default&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co1052_desc"></a><a href="#co1052"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>Constructs the equivalent Python list <span class="literal">[ 'Health
            potion', 'Bear skin', 'Wooden shield' ]</span>.</p></td></tr></table></div></li><li><p><em class="emphasis"><span class="literal">BLOB</span> &#8212; Default:
        <span class="literal">''</span></em></p><p><em class="emphasis">Example</em>:</p><pre class="programlisting">&lt;Default&gt; SGVsbG8gV29ybGQhB &lt;/Default&gt; <a name="co1073" href="#co1073_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>
&lt;!-Hello World! --&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co1073_desc"></a><a href="#co1073"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>BASE6-encoded string value must be specified.</p></td></tr></table></div></li><li><p><em class="emphasis"><span class="literal">FIXED_DICT</span></em></p><p>For details, see <a href="#xref_FIXED_DICT_Data_Type" title="4.1.2.2.&nbsp;FIXED_DICT Data Type">FIXED_DICT Data Type</a>.</p></li><li><p><em class="emphasis"><span class="literal">FLOAT32</span> &#8212; Default:
        <span class="literal">0.0</span></em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; 1.234 &lt;/Default&gt;</pre></li><li><p><em class="emphasis"><span class="literal">FLOAT64</span> &#8212; Default:
        <span class="literal">0.0</span></em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; 1.23456789 &lt;/Default&gt;</pre></li><li><p><em class="emphasis"><span class="literal">INT8</span>,
        <span class="literal">INT16</span>, <span class="literal">INT32</span>,
        <span class="literal">INT64</span> &#8212; Default:
        <span class="literal">0</span></em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; 99 &lt;/Default&gt;</pre></li><li><p><em class="emphasis"><span class="literal">MAILBOX</span> &#8212; Default:
        <span class="literal">None</span></em></p><p>Default value cannot be overridden.</p></li><li><p><em class="emphasis"><span class="literal">PYTHON</span> &#8212; Default:
        <span class="literal">None</span></em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt;
  { "Strength": 90, "Agility": 77 }
&lt;/Default&gt;</pre></li><li><p><em class="emphasis"><span class="literal">STRING</span> &#8212; Default:
        <span class="literal">''</span></em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; Hello World! &lt;/Default&gt; <a name="co1135" href="#co1135_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co1135_desc"></a><a href="#co1135"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>Value must be specified without quotes.</p></td></tr></table></div></li><li><p><em class="emphasis"><span class="literal">TUPLE</span> &#8212; Default:
        <span class="literal">()</span></em></p><p><em class="emphasis">Example:</em> See
        <span class="literal">ARRAY</span> data type</p></li><li><p><em class="emphasis"><span class="literal">UINT8</span>,
        <span class="literal">UINT16</span>, <span class="literal">UINT32</span>, <span class="literal">UINT64
        </span>&#8212; Default: <span class="literal">0</span></em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; 99 &lt;/Default&gt;</pre></li><li><p><em class="emphasis"><span class="literal">UNICODE_STRING</span> &#8212;
        Default: <span class="literal">u''</span></em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; Hello World! (this is a UTF-8 string) &lt;/Default&gt; <a name="co1136" href="#co1136_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co1136_desc"></a><a href="#co1136"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>Value must be specified without quotes, and must be encoded
            as UTF-8<sup>[<a name="d0e2087" href="#ftn.d0e2087">4</a>]</sup>.</p></td></tr></table></div></li><li><p><em class="emphasis"><span class="literal">USER_TYPE</span> &#8212; Default:
        Return value of the user-defined <span class="literal">defaultValue()</span>
        function.</em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt;
   &lt;intVal&gt;  100       &lt;/intVal&gt;
   &lt;strVal&gt;  opposites &lt;/stringVal&gt;
   &lt;dictVal&gt;
      &lt;value&gt;
         &lt;key&gt;   good    &lt;/key&gt;
         &lt;value&gt; bad     &lt;/value&gt;
      &lt;/value&gt;
    &lt;/dictValue&gt;
&lt;/Default&gt;</pre></li><li><p><em class="emphasis"><span class="literal">VECTOR2</span> &#8212; Default:
        <span class="literal">PyVector</span> of <span class="literal">0.0</span> of the
        appropriate length.</em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; 3.142 2.71 &lt;/Default&gt;</pre></li><li><p><em class="emphasis"><span class="literal">VECTOR3</span> &#8212; Default:
        <span class="literal">PyVector</span> of <span class="literal">0.0</span> of the
        appropriate length.</em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; 3.142 2.71 1.4 &lt;/Default&gt;</pre></li><li><p><em class="emphasis"><span class="literal">VECTOR4</span> &#8212; Default:
        <span class="literal">PyVector</span> of <span class="literal">0.0</span> of the
        appropriate length.</em></p><p><em class="emphasis">Example:</em></p><pre class="programlisting">&lt;Default&gt; 3.142 2.71 1.4 3.8 &lt;/Default&gt;</pre></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Data_Distribution"></a>4.3.&nbsp;Data Distribution</h2></div></div></div><p>Properties represent the state of an entity. Some states are only
    relevant to the cell, others only to the base, and yet others only to the
    client. Some states, however, are relevant to more than one of
    these.</p><p>Each property then has a distribution type that specifies to
    BigWorld which execution context (cell, base, or client) is responsible
    for updating the property, and where to propagate its value within the
    system.</p><p>Data distribution is set up by specifying the sub-section
    <code class="property">&lt;Flags&gt;</code> of the section
    <code class="property">&lt;Properties&gt;</code> in the file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>.</p><p>The bit flags available are defined in
    <code class="filename">bigworld/src/lib/entitydef/data_description.hpp</code>, and
    are described in the list below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">DATA_BASE</span></em></p><p><em class="emphasis">Required flags: N/A &#8212; Excluded flags:
        <span class="literal">DATA_GHOSTED</span> &#8212; Master value on:
        Base</em></p><p>Data will be updated on the base, and will not be available on
        the cell.</p></li><li><p><em class="emphasis"><span class="literal">DATA_GHOSTED</span></em></p><p><em class="emphasis">Required flags: N/A &#8212; Excluded flags:
        <span class="literal">DATA_BASE</span> &#8212; Master value on: Cell</em></p><p>Data will be updated on the cell, and will be ghosted on other
        cells.</p><p>This means that it is safe to read the value of this property
        from another entity, because BigWorld safely makes it available even
        across cell boundaries.</p></li><li><p><em class="emphasis"><span class="literal">DATA_OTHER_CLIENT</span></em></p><p><em class="emphasis">Required flags:
        <span class="literal">DATA_GHOSTED</span> &#8212; Excluded flags: N/A &#8212; Master value
        on: Cell</em></p><p>Data will be updated on the cell, and made available to clients
        who have this entity in their AoI.</p><p>This makes the property safe to read from the client for any
        entity, except for that client's player avatar entity. This flag is
        often combined with <span class="literal">DATA_OWN_CLIENT</span> to create a
        property that is distributed to all clients.</p></li><li><p><em class="emphasis"><span class="literal">DATA_OWN_CLIENT</span></em></p><p><em class="emphasis">Required flags: N/A &#8212; Excluded flags: N/A
        &#8212; Master value on: Base, if <span class="literal">DATA_BASE</span> is set.
        Otherwise, on cell.</em></p><p>Data is propagated to client owning this entity.</p><p>This only makes sense with player entities.</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Data_Distribution_Combinations"></a>4.3.1.&nbsp;Valid Data Distribution Combinations</h3></div></div></div><p>The list below describes the valid combinations of the above bit
      flags:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">ALL_CLIENTS</span><sup>A</sup></em></p><p><em class="emphasis">Available to: Other cells, Cell, Own
          client, Other clients</em></p><p>Property is available to all entities on cell and
          client.</p><p>Corresponds to setting both <span class="literal">OWN_CLIENT</span> and
          <span class="literal">OTHER_CLIENTS</span> flags.</p><p>Examples include:</p><div class="itemizedlist"><ul type="circle"><li><p>The name of a player.</p></li><li><p>The health status of a player or a creature.</p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">BASE</span></em></p><p><em class="emphasis">Available to: Base</em></p><p>Property is only available on the base.</p><p>Examples include:</p><div class="itemizedlist"><ul type="circle"><li><p>List of members of a chat room.</p></li><li><p>Items in a character's inventory.</p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">BASE_AND_CLIENT</span></em></p><p><em class="emphasis">Available to: Base, Own
          client</em></p><p>Property is available on the base and on the owning client.
          Corresponds to setting both <span class="literal">OWN_CLIENT</span> and
          <span class="literal">BASE</span> flags.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Properties of this type are only synchronised when the
            client entity is created. Neither the client nor the base is
            automatically updated when property changes. Methods must be used
            to propagate new value, which is simple, since only one player
            needs to receive it.</p></div></li><li><p><em class="emphasis"><span class="literal">CELL_PRIVATE</span></em></p><p><em class="emphasis">Available to: Cell</em></p><p>Property is only available to its entity, and only on
          cell.</p><p>Examples include:</p><div class="itemizedlist"><ul type="circle"><li><p>Properties of an NPCs 'thoughts' in AI algorithms.</p></li><li><p>Player properties relevant to game play, but dangerous to
              allow players to see (<em class="emphasis">e.g.</em>, healing time
              after battle).</p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">CELL_PUBLIC</span></em></p><p><em class="emphasis">Available to: Other cells,
          Cell</em></p><p>Property is available only on the cell, and is available to
          other entities.</p><p>Examples include:</p><div class="itemizedlist"><ul type="circle"><li><p>The mana level of a player (which can be seen only by
              enemies, not by other players).</p></li><li><p>The call sign for grouping from enemy NPC.</p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">CELL_PUBLIC_AND_OWN</span></em></p><p><em class="emphasis">Available to: Other cells, Cell, Own
          client</em></p><p>Property is available to other entities on the cell, and to
          this one on both the cell and the client.</p><p>Unlike <span class="literal">OWN_CLIENT</span>, this data is also
          ghosted, and therefore available to other entities on the
          cell.</p></li><li><p><em class="emphasis"><span class="literal">EDITOR_ONLY</span></em></p><p><em class="emphasis">Available to:
          WorldEditor</em></p><p>This value may be useful when using
          <code class="classname">BigWorld</code>.<code class="methodname">fetchEntitiesFromChunks</code>
          from a BaseApp. It could be used to decide programmatically whether
          a particular entity should be loaded.</p><p>For example, you may associate a level of difficulty with each
          entity, so entity will only be loaded if the mission's level of
          difficulty is high enough.</p></li><li><p><em class="emphasis"><span class="literal">OTHER_CLIENTS</span><sup>A</sup></em></p><p><em class="emphasis">Available to: Other cells, Cell, Other
          clients</em></p><p>Property is available from client to entities that are not
          this player's avatar. Also available on cell to other
          entities.</p><p>Examples include:</p><div class="itemizedlist"><ul type="circle"><li><p>The state of dynamic world items
              (<em class="emphasis">e.g.</em>, doors, loot containers, and
              buttons).</p></li><li><p>The type of a particle system effect.</p></li><li><p>The player who is currently sitting on a seat.</p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">OWN_CLIENT</span><sup>A</sup></em></p><p><em class="emphasis">Available to: Cell, Own
          client</em></p><p>Property is only available to this entity, on both the cell
          and the client.</p><p>Examples include:</p><div class="itemizedlist"><ul type="circle"><li><p>The character class of a player.</p></li><li><p>Number of experience points for a player.</p></li></ul></div></li></ul></div><p><em class="emphasis"><em class="emphasis">A </em>&#8212; When properties
      with this distribution flag are updated by server, an implicit method is
      called on client. For details, see <a href="#xref_Implicit_set_property_name_Methods" title="5.5.&nbsp;Client callbacks on property changes">Client callbacks on property changes</a>.</em></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Data_Distribution_Usage"></a>4.3.2.&nbsp;Using Distribution Flags</h3></div></div></div><p>When choosing a distribution flag for a property, consider the
      points described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Which methods need the
          property?</em></p><p>You have to make the property available on an execution
          context (cell, base, or client) if that context has a method that
          manipulates the property.</p></li><li><p><em class="emphasis">Does this property need to be accessed
          by other entities?</em></p><p>This could include methods being called to access its value.
          If this is the case, we need to make the property ghosted.</p><p>When doing this, remember that the ghosted entities'
          properties may be a little 'lagged', <em class="emphasis">i.e.</em>, they
          may not represent the exact state of an entity at a given time.
          Also, remember that other entities can only read the property; only
          the entity that owns the property may change it.</p></li><li><p><em class="emphasis">Is the client interested in this value
          directly?</em></p><p>Client/server bandwidth is scarce, so the number of properties
          on the client needs to be minimised.</p><p>Sometimes, a group of properties can be maintained on the cell
          and only a derived additional property needs to be sent to the
          client. For example, a client part would probably not need to know
          that a combination of six AI state variables are causing a guard to
          be angry; they would however need to know the derived value that the
          guard is brandishing an axe.</p></li><li><p><em class="emphasis">Could a player cheat by seeing this
          property?</em></p><p>If so, then care must be taken about sending it to the
          client.</p></li><li><p><em class="emphasis">There can only be one master value of
          any property.</em></p><p>The master value must reside on either the base or cell.
          Consequently, if the same property is available on both the base and
          the cell, the other holder of the property needs to have the value
          propagated to it via a method.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2493"></a>4.3.3.&nbsp;Data Propagation</h3></div></div></div><p>Data propagation occurs when the entity is first created.
      Subsequent modifications to properties will only be local to the
      component, except when the modification occurs in a CellApp, in which
      case the change will be automatically propagated to all interested
      parties. For example, <span class="literal">CELL_PUBLIC</span> properties are
      propagated to all other CellApps that have a ghost of the entity,
      <span class="literal">OTHER_CLIENTS</span> properties are propagated to all
      clients that have the entity in their AoI, and so on.</p><p>When changing the value of a property in a component other than a
      CellApp, the change can be manually propagated using remote method
      calls. For details, see <a href="#xref_Methods" title="Chapter&nbsp;5.&nbsp;Methods"><i xmlns:xlink="http://www.w3.org/1999/xlink">Methods</i></a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e2508"></a>4.3.3.1.&nbsp;Forcing Data Propagation for Python and Custom User
        Types</h4></div></div></div><p>Changes to properties of <span class="literal">PYTHON</span> and custom
        user types are not automatically propagated, unless the property is
        reassigned.</p><p>This behaviour mainly affects composite Python types like
        dictionaries, arrays, and classes, because modifications to the object
        do not cause data propagation unless the property is reassigned to
        itself.</p><p>For example, if entity <em class="emphasis">e</em> has the property
        as illustrated below:</p><pre class="programlisting">&lt;pythonProp&gt;
  &lt;Type&gt; PYTHON &lt;/Type&gt;
  ...
&lt;/pythonProp&gt;</pre><p>Assigning a new value to <code class="varname">pythonProp</code> will
        cause data propagation:</p><pre class="programlisting">e.pythonProp = { 'gold': 100 }</pre><p>However, modifying the value will not cause data
        propagation:</p><pre class="programlisting">e.pythonProp[ 'gold' ] = 50
e.pythonProp[ 'arrows' ] = 200</pre><p>Different parts of the entity will see different values for
        <code class="varname">pythonProp</code>, unless data propagation is manually
        triggered by reassigning the property back to itself:</p><pre class="programlisting">e.pythonProp = e.pythonProp</pre></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Implementing_Custom_Property_Data_Types"></a>4.4.&nbsp;Implementing Custom Property Data Types</h2></div></div></div><p>Custom data types are useful for the implementation of data
    structures with complex behaviour that is shared between different
    components, or that must be attached to cell entities (in which case they
    must be able to be transferred from one cell to another).</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2548"></a>4.4.1.&nbsp;Wrapping a FIXED_DICT Data Type</h3></div></div></div><p>By default, the <span class="literal">FIXED_DICT</span> data type behaves
      like a Python dictionary. This behaviour can be changed by replacing the
      dictionary-like <span class="literal">FIXED_DICT</span> type with another Python
      type (referred to as a wrapper type in this document).</p><p>To do so, specify a type converter object in the
      <code class="property">&lt;implementedBy&gt;</code> section in the
      <span class="literal">FIXED_DICT</span> type declaration. For example:</p><pre class="programlisting">&lt;Type&gt; 
  FIXED_DICT
  &lt;implementedBy&gt; <em class="emphasis">CustomTypeConverterInstance</em>  &lt;/implementedBy&gt;
  &lt;Properties&gt; ... &lt;/Properties&gt;
  ...
&lt;/Type&gt;</pre><p><span class="citetitle">Declaration of a Wrapped <span class="literal">FIXED_DICT</span>
      Data Type</span></p><p><code class="classname">CustomTypeConverterInstance</code> must be a
      Python object that converts between <span class="literal">FIXED_DICT</span>
      instances and wrapper instances.</p><p>It must implement the following methods:</p><div class="altrow"><a name="d0e2588"></a><p class="title"><b>Table&nbsp;4.3.&nbsp;Methods that should be implemented by wrapper type.</b></p><div class="altrow-contents"><table summary="Methods that should be implemented by wrapper type." border="0"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th align="left">Method</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code class="methodname">addToStream</code>(
                <em class="parameter"><code>self</code></em>, <em class="parameter"><code>obj</code></em>
                )</td><td align="left"><p>Optional method that converts a
                wrapper instance to a string suitable for transmitting over
                the network.</p><p>The <code class="varname">obj</code> parameter
                is a wrapper instance. This method should return a string
                representation of <code class="varname">obj</code>. Typically, this is
                done using the <code class="classname">cPickle</code>
                module.</p><p>If this method is present, then
                <code class="methodname">createFromStream</code> must also
                be.</p><p>If this method is not present, then wrapper
                instances are transmitted over the network by first converting
                them to <span class="literal">FIXED_DICT</span> instances using the
                <code class="methodname">getDictFromObj</code> method, and then
                recreated at the receiving end using the
                <code class="methodname">createObjFromDict</code>
                method.</p></td></tr><tr><td align="left"><code class="methodname">createFromStream</code>(
                <em class="parameter"><code>self</code></em>, <em class="parameter"><code>stream</code></em>
                )</td><td align="left"><p>Optional method that creates an
                instance of the wrapper type from its string network
                form.</p><p>The <code class="varname">stream</code> parameter is a
                Python string obtained by calling the
                <code class="methodname">addToStream</code> method. This method
                should return a wrapper instance constructed from the data in
                stream.</p><p>If this method is present, then
                <code class="methodname">addToStream</code> must also be
                provided.</p></td></tr><tr><td align="left"><code class="methodname">createObjFromDict</code>(
                <em class="parameter"><code>self</code></em>, <em class="parameter"><code>dict</code></em>
                )</td><td align="left"><p>Method to convert a
                <span class="literal">FIXED_DICT</span> instance to a wrapper
                instance.</p><p>The <code class="varname">dict</code> parameter is
                a <span class="literal">FIXED_DICT</span> instance. This method should
                return the wrapper instance constructed from the information
                in <code class="varname">dict</code>.</p></td></tr><tr><td align="left"><code class="methodname">getDictFromObj</code>(
                <em class="parameter"><code>self</code></em>, <em class="parameter"><code>obj</code></em>
                )</td><td align="left"><p>Method to convert a wrapper instance
                to a <span class="literal">FIXED_DICT</span> instance.</p><p>The
                <code class="varname">obj</code> parameter is a wrapper instance. This
                method should return a Python dictionary (or dictionary-like
                object) that contains the same set of keys as a
                <span class="literal">FIXED_DICT</span> instance.</p></td></tr><tr><td align="left"><code class="methodname">isSameType</code>(
                <em class="parameter"><code>self</code></em>, <em class="parameter"><code>obj</code></em>
                )</td><td align="left"><p>Method to check whether an object is
                of the wrapper type.</p><p>The <code class="varname">obj</code>
                parameter in an arbitrary Python object. This method should
                return <span class="literal">True</span> if <code class="varname">obj</code> is a
                wrapper instance.</p></td></tr></tbody></table></div></div><p><br class="altrow-break"></p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e2747"></a>4.4.1.1.&nbsp;Example of Wrapping FIXED_DICT with a Class</h4></div></div></div><p>It is often desirable to wrap a <span class="literal">FIXED_DICT</span>
        data type with a class to facilitate object-oriented
        programming.</p><pre class="programlisting">import cPickle

class MyCustomType:          # wrapper type
  def __init__( self, dict ):
    self.a = dict[ "a" ]
    self.b = dict[ "b" ]
  ...                    # other MyCustomType methods

class MyCustomTypeConverter:    # type converter class
  def <em class="emphasis">getDictFromObj</em>( self, obj ):
    return { "a": obj.a, "b": obj.b }
  
  def <em class="emphasis">createObjFromDict</em>( self, dict ):
    return MyCustomType( dict )

  def <em class="emphasis">isSameType</em>( self, obj ):
    return isinstance( obj, MyCustomType )

  def <em class="emphasis">addToStream</em>( self, obj ):          # optional
    return cPickle.dumps( obj )

  def <em class="emphasis">createFromStream</em>( self, stream ):    # optional
    return cPickle.loads( stream )

instance = MyCustomTypeConverter()    # type converter object</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/MyCustomTypeImpl.py</code>
        &#8212; Wrapper type and type converter object</span></p><pre class="programlisting">&lt;Type&gt; 
  FIXED_DICT
  &lt;implementedBy&gt; <em class="emphasis">MyCustomTypeImpl.instance</em>  &lt;/implementedBy&gt;
  &lt;Properties&gt;
    &lt;a&gt; ... &lt;/a&gt;
    &lt;b&gt; ... &lt;/b&gt;
  &lt;/Properties&gt;
  ...
&lt;/Type&gt;</pre><p><span class="citetitle">Excerpt of a wrapped <span class="literal">FIXED_DICT</span>
        type declaration</span></p><p>The above example makes a <span class="literal">FIXED_DICT</span> type
        behave as a class with members <code class="varname">a</code> and
        <code class="varname">b</code>, instead of as a dictionary with the same
        keys.</p><p>The drawback with the above example is that member updates are
        not automatically propagated to other components. For example, if the
        above data type is used in an entity attribute called
        <code class="varname">custType</code>, the following script code would only set
        the value of the attribute for the local copy of the entity:</p><pre class="programlisting">e.custType.a = 100
e.custType.b = 200</pre><p>To ensure that all copies of the entity e have the updated
        values, the attribute must be set to a different instance of
        <code class="classname">MyCustomType</code> with the updated values:</p><pre class="programlisting">e.custType = MyCustomType( { "a": 100, "b": 200 } )</pre><p>Alternatively, <span class="literal">MyCustomType</span> can be
        implemented using descriptors that reference the original
        <span class="literal">FIXED_DICT</span> instance:</p><pre class="programlisting">class MemberProxy( object ):              # descriptor class
  def __init__( self, memberName ):
    self.memberName = memberName

  def __get__( self, instance, owner ):
    return instance.fixedDict[ self.memberName ]

  def __set__( self, instance, value ):
    instance.fixedDict[ self.memberName ] = value

  def __delete__( self, instance ):
    raise NotImplementedError( self.memberName )

class MyCustomType( object ):            # wrapper class
  a = MemberProxy( "a" )
  b = MemberProxy( "b" )

  def __init__( self, dict ):
    self.fixedDict = dict
  ...                      # other MyCustomType methods

class MyCustomTypeConverter( object ):      # type converter class
  def getDictFromObj( self, obj ):
    return obj.fixedDict        # must return original instance
  
  def createObjFromDict( self, dict ):
    return MyCustomType( dict )

  def isSameType( self, obj ):
    return isinstance( obj, MyCustomType )

  # addToStream and createFromStream cannot be implemented</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/MyCustomTypeImpl.py</code>
        &#8212; Wrapper type and type converter object using
        descriptors</span></p><p>In the above example, <code class="classname">MyCustomType</code>
        references the original <span class="literal">FIXED_DICT</span> instance in its
        <code class="varname">fixedDict</code> member. Access to members
        <code class="varname">a</code> or <code class="varname">b</code> will be redirected via
        the descriptor class to the <code class="varname">fixedDict</code> member. As
        updates to <span class="literal">FIXED_DICT</span> instances are automatically
        propagated to other components, updates to members
        <code class="varname">a</code> and <code class="varname">b</code> are also automatically
        propagated.</p><p>The drawback with this approach is that custom streaming is not
        possible. If the <span class="literal">addToStream</span> and
        <span class="literal">createFromStream</span> methods are implemented, then the
        custom object is created directly from the stream. Since it is not
        possible to instantiate a FIXED_DICT object in Python script, it will
        not be possible for the custom object to reference a FIXED_DICT object
        that will propagate partial changes.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e2869"></a>4.4.1.2.&nbsp;Implementing a USER_TYPE Data Type</h4></div></div></div><p>The <span class="literal">USER_TYPE</span> data type predates the
        <span class="literal">FIXED_DICT</span> data type, and much of its functionality
        can be achieved by wrapping a <span class="literal">FIXED_DICT</span> data type.
        However, <span class="literal">USER_TYPE</span> data type additionally allows
        customising its representation as a
        <code class="property">&lt;DataSection&gt;</code>.</p><p>A <span class="literal">USER_TYPE</span> data type consists of the
        following pieces:</p><div class="itemizedlist"><ul type="disc"><li><p>A declaration of the Python instance implementing the
            <span class="literal">USER_TYPE</span> data type. For example:</p><pre class="programlisting">&lt;Type&gt; <em class="emphasis">USER_TYPE</em> &lt;implementedBy&gt; <em class="emphasis">UserType.instance</em> &lt;/implementedBy&gt; &lt;/Type&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
            &#8212; User type declaration syntax</span></p><p>However, it is recommended to declare a
            <span class="literal">USER_TYPE</span> data type in
            <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</code>
            <sup>[<a name="d0e2929" href="#ftn.d0e2929">5</a>]</sup> to give it a name that we can use in the entity
            definition files <sup>[<a name="d0e2936" href="#ftn.d0e2936">6</a>]</sup> (named
            <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>).</p></li><li><p>A class that defines methods to read and write this data
            type from various places.</p></li><li><p>A module, containing the above class, and an instance of
            this class, which will be used to serialise and unserialise the
            custom data type.</p></li></ul></div><p>The custom data type might also declare a Python class that
        represents the type at runtime. A Python list, a dictionary, or some
        other native Python data type might also represent it.</p><p>The class we implement provides methods to serialise whatever
        Python type we use to represent a concept. This means that we can
        transmit the class over the network and serialise it to a database,
        simply by writing the appropriate methods in this class.</p><p>These methods are described in the list below:</p><div class="altrow"><a name="d0e2963"></a><p class="title"><b>Table&nbsp;4.4.&nbsp;Custom data type serialisation methods.</b></p><div class="altrow-contents"><table summary="Custom data type serialisation methods." border="0"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th align="left">Method</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code class="methodname">addToStream</code>(
                  <em class="parameter"><code>self</code></em>,
                  <em class="parameter"><code>obj</code></em>)</td><td align="left"><p>Converts the Python object obj
                  into a string representation to be placed onto the network,
                  and return that string. It does the opposite of
                  <code class="methodname">createFromStream</code>. The
                  <code class="classname">struct</code> library from Python is useful
                  in performing this task.</p><p>For example, if your
                  type contains a single <span class="literal">INT32</span> member, then
                  <code class="methodname">addToStream</code> could be implemented
                  as:</p><pre class="programlisting">def addToStream( self, obj ):
	return struct.pack( "i", obj )</pre></td></tr><tr><td align="left"><code class="methodname">createFromStream</code>(
                  <em class="parameter"><code>self</code></em>, <em class="parameter"><code>stream</code></em>
                  )</td><td align="left"><p>Creates a Python object from the
                  string passed in through <code class="varname">stream</code>. It does
                  the opposite of
                  <code class="methodname">addToStream</code>.</p><p>The length
                  of the <code class="varname">stream</code> must be checked before
                  trying to unpack it.</p><p>For example, if your type
                  contains a single <span class="literal">INT32</span> member, then
                  <code class="methodname">createFromStream</code> could be
                  implemented as:</p><pre class="programlisting">def createFromStream( self, stream ):
  if len(stream) != 4: # one integer
    raise "Error: string has wrong length"
  else:
    return struct.unpack( "I", stream )</pre></td></tr><tr><td align="left"><code class="methodname">addToSection</code>(
                  <em class="parameter"><code>self</code></em>, <em class="parameter"><code>obj</code></em>,
                  <em class="parameter"><code>section</code></em> )</td><td align="left"><p>Adds a representation of
                  <code class="varname">obj</code> to the section
                  <code class="property">&lt;DataSection&gt;</code>.</p><p>It is
                  used for persisting properties into the database. Hence, if
                  a property is not persistent, this method does not have to
                  be implemented.</p></td></tr><tr><td align="left"><code class="methodname">createFromSection</code>(
                  <em class="parameter"><code>self</code></em>, <em class="parameter"><code>section</code></em>
                  )</td><td align="left"><p>Creates and returns a Python
                  object from its persisted representation in section
                  <code class="property">&lt;DataSection&gt;</code>.</p><p>It is
                  used for persisting properties into the database, and
                  parsing default values from
                  <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
                  files.</p><p>You should always implement this method,
                  even if you do not implement
                  <code class="methodname">addToSection</code>.</p></td></tr><tr><td align="left"><code class="methodname">fromStreamToSection</code>(
                  <em class="parameter"><code>self</code></em>, <em class="parameter"><code>stream</code></em>,
                  <em class="parameter"><code>section</code></em> )</td><td align="left"><p>Converts data from a
                  <code class="varname">stream</code> representation (a string) to a
                  <code class="property">&lt;DataSection&gt;</code> representation in
                  <code class="varname">section</code>. It can be implemented as
                  follows:</p><pre class="programlisting">def fromStreamToSection( self, stream, section ):
  o = self.createFromStream( stream )
  self.addToSection( o, section ) </pre><p>It can also be
                  implemented more efficiently (for instance if the
                  <code class="property">&lt;DataSection&gt;</code> representation is
                  very similar to the stream representation). For
                  example:</p><pre class="programlisting">section.asBlob = stream</pre></td></tr><tr><td align="left"><code class="methodname">fromSectionToStream</code>(
                  <em class="parameter"><code>self</code></em>, <em class="parameter"><code>section</code></em>
                  )</td><td align="left"><p>Converts data from a
                  <code class="property">&lt;DataSection&gt;</code> representation in
                  <code class="varname">section</code> to a stream representation, and
                  returns it.</p><p>It can be implemented as
                  follows:</p><pre class="programlisting">def fromSectionToStream( self, section ):
  o = self.createFromSection( section )
  return self.addToStream( o ) </pre><p>It can also be
                  implemented more efficiently (for instance if the
                  <code class="property">&lt;DataSection&gt;</code> representation is
                  very similar to the stream representation). For
                  example:</p><pre class="programlisting">return section.asBlob</pre></td></tr><tr><td align="left"><code class="methodname">defaultValue</code>(
                  <em class="parameter"><code>self</code></em> )</td><td align="left"><p>Returns a reasonable default value
                  for this data type.</p><p>It is used when there is no
                  default value specified when this data type is used in a
                  property.</p></td></tr></tbody></table></div></div><p><br class="altrow-break"></p><p>We place a class implementing these methods into a module in the
        directory <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common</code>,
        and create an instance variable as an instance of this class.</p><p>For example, we may define a module called
        <code class="filename">MyCustDataType.py</code>, as illustrated below:</p><pre class="programlisting">class <em class="emphasis">MyCustDataType</em>:
  def <em class="emphasis">addToStream</em>( self, obj ):
    ...
  def <em class="emphasis">createFromStream</em>( self, stream ):
    ...
  def <em class="emphasis">addToSection</em>( self, obj, section ):
    ...
  def <em class="emphasis">createFromSection</em>( self, section ):
    ...
  def <em class="emphasis">fromStreamToSection</em>( self, stream, section ):
    ...
  def <em class="emphasis">fromSectionToStream</em>( self, section ):
    ...
  def <em class="emphasis">defaultValue</em>( self ):
    ...
instance = MyCustDataType()</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/MyCustDataType.py</code>
        &#8212; Serialisation methods</span></p><p>If the property is persistent, and stored in a MySQL database,
        then an additional method has to be implemented. This method will
        declare the binding of the data into the database. For more details,
        see <a href="#xref_The_Database_Layer" title="Chapter&nbsp;8.&nbsp;The Database Layer"><i xmlns:xlink="http://www.w3.org/1999/xlink">The Database Layer</i></a>.</p><p>The variable instance is the object that performs the
        manipulation of this data type by BigWorld. In the aliases file
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/defs/alias.xml</code>,
        we would include the following definition:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;MY_CUSTOM_DATA_TYPE&gt; 
    USER_TYPE
    &lt;implementedBy&gt; MyCustDataType.instance &lt;/implementedBy&gt;
  &lt;/MY_CUSTOM_DATA_TYPE&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/defs/alias.xml</code>
        &#8212; Definition of
        <span class="literal">MY_CUST_DATA_TYPE</span></span></p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Volatile_Properties"></a>4.5.&nbsp;Volatile Properties</h2></div></div></div><p>Some properties are updated more often than others, and almost all
    entities have a set of properties that need to be handled specially due to
    this. These properties are called <em class="emphasis">volatile</em>
    properties, and are pre-defined by the BigWorld engine.</p><p>The default volatile properties defined by BigWorld are outlined
    below:</p><div class="altrow"><a name="d0e3256"></a><p class="title"><b>Table&nbsp;4.5.&nbsp;BigWorld's pre-defined volatile properties.</b></p><div class="altrow-contents"><table summary="BigWorld's pre-defined volatile properties." border="0"><colgroup><col width="11%"><col width="89%"></colgroup><thead><tr><th align="left">Property</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code class="varname">position</code></td><td align="left"><p>The (x,y,z) position of the entity.
              Represented in Python as a <span class="literal">TUPLE</span> of three
              floats.</p></td></tr><tr><td align="left"><p><code class="varname">yaw</code></p><p><code class="varname">pitch</code></p><p><code class="varname">roll</code></p></td><td align="left"><p>Three extra volatile properties, which
              are typically used for the direction an entity is facing, but
              may be used for other purposes. They still must, however, have
              the ranges of the corresponding element of a
              direction:</p><div class="itemizedlist"><ul type="disc"><li><p>(<span class="literal">-pi</span>,<span class="literal">pi</span>) for
                    <code class="varname">yaw</code></p></li><li><p>(<span class="literal">-pi/2</span>,<span class="literal">pi/2</span>)
                    for <code class="varname">pitch</code></p></li><li><p>(<span class="literal">-pi</span>,<span class="literal">pi</span>) for
                    <code class="varname">roll</code></p></li></ul></div></td></tr></tbody></table></div></div><p><br class="altrow-break"></p><p>These properties are updated with an optimised protocol used between
    the client and the server, in order to minimise bandwidth.</p><p>The volatile properties are listed separately to the normal
    properties in the file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>.</p><p>Each entity can decide which of these volatile properties are
    automatically updated. Additionally, they can have a priority attached to
    them. This priority determines a distance from the entity above which the
    property is no longer sent.</p><p>The syntax is as follows:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;Volatile&gt;
    &lt;<em class="emphasis">position</em>/&gt; | &lt;<em class="emphasis">position</em>&gt;  <em class="replaceable"><code>float</code></em>  &lt;/<em class="emphasis">position</em>&gt; 
    &lt;<em class="emphasis">yaw</em>/&gt;      | &lt;<em class="emphasis">yaw</em>&gt;       <em class="replaceable"><code>float</code></em>  &lt;/<em class="emphasis">yaw</em>&gt; 
    &lt;<em class="emphasis">pitch</em>/&gt;    | &lt;<em class="emphasis">pitch</em>&gt;     <em class="replaceable"><code>float</code></em>  &lt;/<em class="emphasis">pitch</em>&gt; 
    &lt;<em class="emphasis">roll</em>/&gt;     | &lt;<em class="emphasis">roll</em>&gt;      <em class="replaceable"><code>float</code></em>  &lt;/<em class="emphasis">roll</em>&gt; 
  &lt;/Volatile&gt;
  ...</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    &#8212; Declaration of volatile properties</span></p><p>This is how the volatility status and priority of a property are
    interpreted:</p><div class="itemizedlist"><ul type="disc"><li><p>If a property is not specified, then it will never be updated
        (<code class="classname">BigWorld</code>.<code class="varname">VOLATILE_NEVER</code>).</p></li><li><p>If a property is specified:</p><div class="itemizedlist"><ul type="circle"><li><p>If a priority is not specified, then property will always be
            updated, regardless of distance from entity
            (<code class="classname">BigWorld</code>.<code class="varname">VOLATILE_ALWAYS</code>).</p></li><li><p>If a priority is specified, then the value is used as the
            maximum distance from entity (in metres) for which property will
            still be updated.</p></li></ul></div></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The volatile distance for pitch cannot be less than that of yaw
      and the volatile distance for roll cannot be less than that of
      pitch.</p></div><p>Supposing an entity the volatile properties as defined below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">Volatile</em>&gt;
    &lt;<em class="emphasis">position</em>/&gt;   
    &lt;<em class="emphasis">yaw</em>&gt;    30.0  &lt;/<em class="emphasis">yaw</em>&gt; 
    &lt;<em class="emphasis">pitch</em>&gt;  25.0  &lt;/<em class="emphasis">pitch</em>&gt; 
  &lt;/Volatile&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    &#8212; Example definition</span></p><p>For the above example, we have the following for each
    property:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="varname">position</code> &#8212; Always updated
        (<code class="classname">BigWorld</code>.<code class="varname">VOLATILE_ALWAYS</code>)</p></li><li><p><code class="varname">yaw</code> &#8212; Updated up to a distance of 30.0
        metres.</p></li><li><p><code class="varname">pitch</code> &#8212; Updated up to a distance of 25.0
        metres.</p></li><li><p><code class="varname">roll</code> &#8212; Never updated
        (<code class="classname">BigWorld</code>.<code class="varname">VOLATILE_NEVER</code>)</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Only non-moving entities should be defined without volatile
      properties.</p><p>Each position or direction change of an entity without any
      volitile properties is sent to the necessary clients in a detailed but
      less efficient way. This allows an entity's position to be correct when
      it is occasionally moved (<em class="emphasis">e.g.</em>, a chair has been
      slightly moved). If this happen consistently, it can consume a lot of
      server to client bandwidth.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_LOD_Level_Of_Detail_On_Properties"></a>4.6.&nbsp;LOD (Level of Detail) on Properties</h2></div></div></div><p>Sometimes bandwidth usage can be optimised even further, by not
    distributing information to clients that are distant. We can do this by
    attaching a <code class="property">&lt;DetailLevel&gt;</code> tag to a property.
    This tag determines the distance after which property changes will not be
    sent to the client.</p><p>Note that this is purely an optimisation for the property. This
    option should only be used if bandwidth usage is proven to be too high. If
    this feature is enabled for the property, then you must test it very
    carefully to check if the result achieved in terms of game play is what
    you expected.</p><p>The definition of the LOD (level of detail) of a property in the
    file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    is described below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">Properties</em>&gt;
    ...
    &lt;<em class="emphasis">modelNumber</em>&gt;
      ...
      &lt;<em class="emphasis">DetailLevel</em>&gt; <em class="emphasis">NEAR</em> &lt;/DetailLevel&gt;
    &lt;/modelNumber&gt;
    ...</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    &#8212; Declaration of LOD for property</span></p><p>The example above declared a LOD labelled <span class="literal">NEAR</span>
    for the property. The actual value of <span class="literal">NEAR</span> is defined
    in the sub-section <code class="property">&lt;level&gt;</code> of the section
    <code class="property">&lt;LodLevels&gt;</code> in the entity's file.</p><p>For example, to subdivide the AoI into the ranges labelled
    <span class="literal">NEAR</span>, <span class="literal">MEDIUM</span>, and
    <span class="literal">FAR</span> (with everything further than
    <span class="literal">FAR</span> being transmitted whenever entities are within each
    other's AoI), the entity's definition file will include the lines
    below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">LODLevels</em>&gt;
    &lt;level&gt;  <em class="emphasis">20</em>  &lt;label&gt; <em class="emphasis">NEAR</em>    &lt;/label&gt; &lt;/level&gt;
    &lt;level&gt; <em class="emphasis">100</em>  &lt;label&gt; <em class="emphasis">MEDIUM</em>  &lt;/label&gt; &lt;/level&gt;
    &lt;level&gt; <em class="emphasis">250</em>  &lt;label&gt; <em class="emphasis">FAR</em>     &lt;/label&gt; &lt;/level&gt;
  &lt;/LODLevels&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    &#8212; Definition of labels for LODs</span></p><p>The LODs specified for the entity in the example file above are
    illustrated below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/location_of_lod_boundaries_relative_to_the_entity.png"><span class="caption"><p>Location of LOD boundaries relative to the
        entity</p></span></div></div><p>Detail levels are inherited from parent definition files. Any level
    with the same label as a parent will modify that level, and any new levels
    will be added.</p><p>There is currently a limit of six levels of detail for each entity
    type</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3627"></a>4.6.1.&nbsp;LOD and Hysteresis</h3></div></div></div><p>In addition to its parameter <code class="property">&lt;label&gt;</code>,
      the sub-section <code class="property">&lt;level&gt;</code> can also have
      <code class="property">&lt;hyst&gt;</code> parameter.</p><p>It is defined as illustrated in the example below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">LODLevels</em>&gt;
    &lt;level&gt;  20 &lt;label&gt; NEAR   &lt;/label&gt; &lt;<em class="emphasis">hyst</em>&gt;  4 &lt;/hyst&gt; &lt;/level&gt;
    &lt;level&gt; 100 &lt;label&gt; MEDIUM &lt;/label&gt; &lt;<em class="emphasis">hyst</em>&gt; 10 &lt;/hyst&gt; &lt;/level&gt;
    &lt;level&gt; 250 &lt;label&gt; FAR    &lt;/label&gt; &lt;<em class="emphasis">hyst</em>&gt; 20 &lt;/hyst&gt; &lt;/level&gt;
  &lt;/LODLevels&gt;
  ...</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
      &#8212; Definition of hysteresis regions</span></p><p>This parameter defines a hysteresis region starting from the LOD's
      outer boundary and moving outwards. It prevents frequent changes in the
      LOD of a property, which saves significant processing time on the cell,
      as properties do not have to change their priorities often. In order to
      do this, the <code class="property">&lt;hyst&gt;</code> specifies a buffer region
      around the boundary of a LOD level, which an entity must pass through
      completely before changing to a lower LOD.</p><p>The declaration of the <code class="property">&lt;hyst&gt;</code> parameter
      is optional, and if not declared, it will default to 10 metres.</p><p>As an example, consider a stationary entity, and another entity
      travelling through points <em class="emphasis">A</em>,
      <em class="emphasis">B</em>, <em class="emphasis">C</em>, <em class="emphasis">D</em>,
      <em class="emphasis">E</em>, and finally back to <em class="emphasis">A</em>, as
      illustrated in the diagram below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/entity_moving_around_lods_of_another_entity.png"><span class="caption"><p>Entity moving around LODs of another
          entity</p></span></div></div><p>We consider the minimum LOD of properties that will be propagated
      from the moving entity to the stationary entity, as listed in the table
      below:</p><div class="altrow"><a name="d0e3707"></a><p class="title"><b>Table&nbsp;4.6.&nbsp;Entity moving around LODs of another entity.</b></p><div class="altrow-contents"><table summary="Entity moving around LODs of another entity." border="0" width="85%"><colgroup><col width="8%"><col width="12%"><col width="80%"></colgroup><thead><tr><th align="left">Point</th><th align="left">LOD</th><th align="left">Reason</th></tr></thead><tbody><tr><td align="left">A</td><td align="left"><span class="literal">NEAR</span></td><td align="left">Unaffected by hysteresis.</td></tr><tr><td align="left">B</td><td align="left"><span class="literal">NEAR</span></td><td align="left">Entity has moved from
                <span class="literal">NEAR</span> to <span class="literal">MEDIUM</span>, but not
                yet completely through the hysteresis.</td></tr><tr><td align="left">C</td><td align="left"><span class="literal">MEDIUM</span></td><td align="left">Entity has moved from
                <span class="literal">NEAR</span> to <span class="literal">MEDIUM</span>, and
                completely through the hysteresis.</td></tr><tr><td align="left">D</td><td align="left"><span class="literal">MEDIUM</span></td><td align="left">Entity is still in
                <span class="literal">MEDIUM</span>.</td></tr><tr><td align="left">E</td><td align="left"><span class="literal">MEDIUM</span></td><td align="left">Entity is still in
                <span class="literal">MEDIUM</span>.</td></tr><tr><td align="left">A</td><td align="left"><span class="literal">NEAR</span></td><td align="left">Entity has moved from
                <span class="literal">MEDIUM</span> to <span class="literal">NEAR</span>.</td></tr></tbody></table></div></div><p><br class="altrow-break"></p><p>In the example above, we have the following regarding the change
      of LOD for the moving entity:</p><div class="itemizedlist"><ul type="disc"><li><p>The change of LOD for the moving entity from
          <span class="literal">NEAR</span> to <span class="literal">MEDIUM</span> occurs at a
          distance of 24 metres from the stationary entity (20 metres as
          defined for the <span class="literal">NEAR</span> LOD, plus 4 metres for its
          hysteresis). If no <code class="property">&lt;hyst&gt;</code> parameter were
          specified, the change would happen at 30 metres (since hysteresis
          would then default to 10 metres).</p></li><li><p>The change of LOD for the moving entity from
          <span class="literal">MEDIUM</span> to <span class="literal">NEAR</span> occurs at 20
          metres from the stationary entity (since hysteresis does not affect
          moving to a higher LOD).</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e3824"></a>4.7.&nbsp;Temporary Properties</h2></div></div></div><p>Temporary properties can be used for properties that do not need to
    be backed up or offloaded with an entity.</p><p>The grammar for temporary property definition is displayed
    below:</p><pre class="programlisting">&lt;root&gt;
   ...
   &lt;<em class="emphasis">TempProperties</em>&gt;
      &lt;<em class="replaceable"><code>tempPropertyName1/</code></em>&gt;
      &lt;<em class="replaceable"><code>tempPropertyName2/</code></em>&gt;
      ...
   &lt;/TempProperties&gt;
   ...
&lt;/root&gt;</pre><p>These should generally be rare but are useful for properties that
    cannot be streamed such as sockets or properties that are recreated on
    restoring. These apply to both cell and base entities.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_UDO_Linking"></a>4.8.&nbsp;User Data Object Linking With <span class="literal">UDO_REF</span>
    Properties</h2></div></div></div><p>There is a special property type, <span class="literal">UDO_REF</span>, that
    can be used in both entities and user data objects. This property type
    makes it possible to create a connection between an entity and a user data
    object, or between two user data objects. This property type is a key
    feature of user data objects, as it allows the creation of complex graphs
    made up of different types of user data objects and entities that can be
    used by the entity scripts as desired. A <span class="literal">UDO_REF</span>
    property is nothing more than a reference to a user data object. When an
    entity or a user data object with a <span class="literal">UDO_REF</span> property is
    loaded, the user data object referenced by the <span class="literal">UDO_REF</span>
    property could exist in an unloaded state if the user data object
    referenced hasn't been loaded yet. In this case, the script will only be
    able to get the user data object's unique identification number through
    the <span class="literal">guid</span> attribute. Once the referenced user data
    object is loaded, all it's attributes and properties can be
    accessed.</p><p>The most important example of this property type is in the
    PatrolNode user data object. The old patrol path system, including the old
    <span class="literal">PATROL_PATH</span> property type, have been deprecated. Patrol
    functionality is now achieved with the <span class="literal">PatrolNode</span> user
    data object, which can be linked to other <span class="literal">PatrolNode</span>
    objects through an array of <span class="literal">UDO_REF</span> properties.
    Entities that wish to patrol through a graph of
    <span class="literal">PatrolNode</span> objects just need have a
    <span class="literal">UDO_REF</span> property that links to a
    <span class="literal">PatrolNode.</span></p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e1420" href="#d0e1420">1</a>] </sup>For details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_alias_xml" class="olink"><i><span class="literal">alias.xml</span></i></a></p></div><div class="footnote"><p><sup>[<a name="ftn.d0e1875" href="#d0e1875">2</a>] </sup>For details, see the introduction to this chapter.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e1881" href="#d0e1881">3</a>] </sup>For details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_alias_xml" class="olink"><i><span class="literal">alias.xml</span></i></a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e2087" href="#d0e2087">4</a>] </sup>For more details on encodings, see <a href="#xref_Character_Set_Encodings" title="Chapter&nbsp;9.&nbsp;Character Sets and Encodings"><i xmlns:xlink="http://www.w3.org/1999/xlink">Character Sets and Encodings</i></a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e2929" href="#d0e2929">5</a>] </sup>For details on this file's grammar, see the document
                <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_alias_xml" class="olink"><i><span class="literal">alias.xml</span></i></a></p></div><div class="footnote"><p><sup>[<a name="ftn.d0e2936" href="#d0e2936">6</a>] </sup>For an example of declaration of aliases for data types,
                see <a href="#xref_Alias_Of_Data_Types" title="4.1.4.&nbsp;Alias of Data Types">Alias of Data Types</a>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Methods"></a>Chapter&nbsp;5.&nbsp;Methods</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e3981">5.1. Basic Method Specification</a></span></dt><dt><span class="section"><a href="#xref_Intra_Entity_Communication">5.2. Intra-Entity Communication</a></span></dt><dt><span class="section"><a href="#d0e4198">5.3. Sending Auxiliary Data to the Client Via Proxy</a></span></dt><dt><span class="section"><a href="#xref_SPG_ExposedMethods">5.4. Exposed Methods <span class="symbol">&#8208;</span> Client-to-Server
    Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4371">5.4.1. Security Considerations of Exposed Methods</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Implicit_set_property_name_Methods">5.5. Client callbacks on property changes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4431">5.5.1. Implicit
      <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt><dt><span class="section"><a href="#d0e4514">5.5.2. Implicit
      <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt><dt><span class="section"><a href="#d0e4566">5.5.3. Implicit
      <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e4609">5.6. LOD on Methods</a></span></dt><dt><span class="section"><a href="#xref_Inter_Entity_Communication">5.7. Inter-Entity Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4698">5.7.1. Entity IDs</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Mailboxes">5.8. Mailboxes</a></span></dt><dt><span class="section"><a href="#d0e5076">5.9. Method Execution Context</a></span></dt></dl></div><p>Methods allow events to be propagated, both between different
  execution contexts of an entity (<em class="emphasis">i.e.</em>, cell, base,
  client), as well as between different entities. BigWorld separates entity
  methods into categories based on which execution context they will be
  executed within.</p><p>In general, methods should not be used for propagating states. The use
  of properties is recommended for this purpose. For example, a player holding
  a gun should be a property, while a player shooting should be a
  method.</p><p>The categories of methods are:</p><div class="altrow"><table border="0"><colgroup><col width="20%"><col width="13%"><col width="67%"></colgroup><thead><tr><th align="left">Category</th><th align="left">Runs on</th><th align="left">Common uses</th></tr></thead><tbody><tr><td align="left"><code class="property">&lt;BaseMethods&gt;</code></td><td align="left">BaseApp</td><td align="left"><p>Updates properties on the
            base.</p><p>Serves as a root point to propagate messages to
            related things.</p></td></tr><tr><td align="left"><code class="property">&lt;CellMethods&gt;</code></td><td align="left">CellApp</td><td align="left"><p>Notifies the cell of changes in response
            to player interaction.</p><p>Allows communication between
            nearby entities.</p></td></tr><tr><td align="left"><code class="property">&lt;ClientMethods&gt;</code></td><td align="left">Clients</td><td align="left"><p>Notifies the client of events, so that
            the player can see them. Implicit
            <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
            methods need not be declared<sup>[<a name="d0e3951" href="#ftn.d0e3951">a</a>]</sup>.</p></td></tr></tbody><tbody class="footnotes"><tr><td colspan="3"><div class="footnote"><p><sup>[<a name="ftn.d0e3951" href="#d0e3951">a</a>] </sup>For details, see <a href="#xref_Implicit_set_property_name_Methods" title="5.5.&nbsp;Client callbacks on property changes">Client callbacks on property changes</a></p></div></td></tr></tbody></table></div><p><span class="citetitle">Method categories.</span></p><p>The grammar for method declaration is described below:</p><pre class="programlisting">&lt;[ClientMethods|CellMethods|BaseMethods]&gt;

  &lt;<em class="replaceable"><code>method_name</code></em>&gt;
    &lt;Exposed/&gt;
    &lt;Arg&gt; data_type &lt;/Arg&gt;
   &lt;/<em class="replaceable"><code>method_name</code></em>&gt;

&lt;/[ClientMethods|CellMethods|BaseMethods]&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
  <span class="symbol">&#8208;</span> Method declaration
  syntax</span></p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e3981"></a>5.1.&nbsp;Basic Method Specification</h2></div></div></div><p>All methods in all categories have some fundamental common
    characteristics. They are declared in the relevant section in the file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>,
    with an XML tag per method.</p><p>The method's arguments are also defined in the file, and its types
    are specified in the same way as property types. For more details, see
    <a href="#xref_Property_Types" title="4.1.&nbsp;Property Types">Property Types</a>.</p><p>In order to declare a method called <code class="methodname">yell</code> on
    the cell, which receives a string argument, we would have the lines
    below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">CellMethods</em>&gt;
    &lt;<em class="emphasis">yell</em>&gt;
      &lt;<em class="emphasis">Arg</em>&gt; <em class="emphasis">STRING</em> &lt;/Arg&gt; &lt;!-- phrase to exclaim --&gt;
    &lt;/yell&gt;
  &lt;/CellMethods&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    <span class="symbol">&#8208;</span> Declaration of cell method
    <code class="methodname">yell</code></span></p><p>By convention, the meaning of each argument is written next to it as
    an XML comment.</p><p>Once the method is declared, it also needs to be declared in the
    appropriate Python implementation file. Each context of execution (cell,
    base, and client) has a folder containing scripts for each entity.</p><p>In our example, the method was added to the section
    <code class="property">&lt;CellMethods&gt;</code>, and therefore will be executed
    on the cell entity.</p><p>The cell script for this entity, named
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>,
    will need to define the <code class="methodname">yell</code> method, as
    illustrated below:</p><pre class="programlisting">import BigWorld
...
class <em class="emphasis"><em class="replaceable"><code>entity</code></em></em>(BigWorld.Entity):

  def <em class="emphasis">__init__</em>(self):
    BigWorld.Entity.__init__(self)

  def <em class="emphasis">yell</em>(self, phrase):
    # insert code to implement yell here
    return</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
    <span class="symbol">&#8208;</span> Definition of cell method
    <code class="methodname">yell</code></span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Intra_Entity_Communication"></a>5.2.&nbsp;Intra-Entity Communication</h2></div></div></div><p>Different execution contexts of an entity communicate with each
    other by calling methods on the other execution contexts. These are
    exposed as special properties of the entity.</p><p>As a quick reference, the available objects are described
    below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">allClients</span> <span class="symbol">&#8208;</span> Available on: Cell</em></p><p><em class="emphasis">When/how to use:</em> To call a
        client method on all client instances of this entity.</p><p><em class="emphasis">Example:
        </em><span class="literal">self.allClients.someMethod()</span></p></li><li><p><em class="emphasis"><span class="literal">base</span> <span class="symbol">&#8208;</span> Available on: Cell, Client</em></p><p><em class="emphasis">When/how to use:</em> To call a base
        method of this entity. Calls to this object are executed on the base
        script. The client cannot directly call methods on the base of other
        entities.</p><p><em class="emphasis">Example:</em>
        <span class="literal">self.base.someMethod()</span></p></li><li><p><em class="emphasis"><span class="literal">cell</span> <span class="symbol">&#8208;</span> Available on: Base, Client</em></p><p><em class="emphasis">When/how to use:</em> To call a cell
        method of this entity. Calls to this object are executed on the cell
        script. All client instances can access their cell object (when the
        entity exists on the cell).</p><p><em class="emphasis">Example:</em>
        <span class="literal">self.cell.someMethod()</span></p></li><li><p><em class="emphasis"><span class="literal">otherClients</span> <span class="symbol">&#8208;</span> Available on: Cell</em></p><p><em class="emphasis">When/how to use:</em> To call a
        client method on all client instances of this entity, except on its
        own.</p><p><em class="emphasis">Example:</em>
        <span class="literal">self.otherClients.someMethod()</span></p></li><li><p><em class="emphasis"><span class="literal">ownClient</span> <span class="symbol">&#8208;</span> Available on: Cell, Base</em></p><p><em class="emphasis">When/how to use:</em> To call a
        client method only on this entity's client. This object calls the
        method only on the entity on the client application that is 'playing'
        as this entity, not on other client applications that can see this
        entity.</p><p><em class="emphasis">Example:</em>
        <span class="literal">self.ownClient.someMethod()</span></p></li></ul></div><p>The methods of a nearby entity can be called from the client
    directly on the cell part of that entity.</p><p>BigWorld automatically exposes these objects to the relevant script
    classes.</p><p>What this means is that it is possible for any script that is part
    of an entity (cell, base or client part) to call other scripts that are
    part of the same entity. The definition file
    (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>)
    describes which methods are exposed to different execution
    contexts.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4198"></a>5.3.&nbsp;Sending Auxiliary Data to the Client Via Proxy</h2></div></div></div><p>Auxiliary data can be streamed to the client via the proxy, without
    affecting the normal game traffic. This data is opportunistically streamed
    to the client when bandwidth is available.</p><p>All data types in this streamed data are user-defined, since
    BigWorld does not have any internal uses for it.</p><p>Data is added to a proxy via method
    <code class="methodname">streamStringToClient</code>:</p><pre class="programlisting">id = Proxy.streamStringToClient( id, data )</pre><p>or via method <code class="methodname">streamFileToClient</code>:</p><pre class="programlisting">id = Proxy.streamFileToClient( id, resource )</pre><p>Where the parameters are:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><em class="parameter"><code>id</code></em></em></p><p>16-bit ID of the data. If <span class="literal">-1</span> is received,
        then the next ID in sequence that is not currently in use is selected.
        The caller of this method is responsible for the management of this
        parameter. The same ID value used by the method is returned to the
        caller.</p></li><li><p><em class="emphasis"><em class="parameter"><code>data</code></em></em></p><p>Data to be sent to the attached client. Must be in string
        format.</p></li><li><p><em class="emphasis"><em class="parameter"><code>resource</code></em></em></p><p>The string name of the resource to be sent to the client.</p></li></ul></div><p>Once the client has received the entire data string, the callback
    <code class="classname">BWPersonality</code>.<code class="methodname">onStreamComplete</code>
    is called on the client.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_SPG_ExposedMethods"></a>5.4.&nbsp;Exposed Methods <span class="symbol">&#8208;</span> Client-to-Server
    Communication</h2></div></div></div><p>Because MMOGs operate over the Internet, and in order to stop
    players cheating, server methods (those on the cell or the base) are not
    automatically allowed to be called by the client.</p><p>In order to make a server method callable from the client (so that
    the world can provide interactivity), its declaration has to include the
    tag <code class="property">&lt;Exposed/&gt;</code>, as illustrated below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">CellMethods</em>&gt;
    &lt;<em class="emphasis">yell</em>&gt;
      &lt;<em class="emphasis">Exposed</em>/&gt;
      &lt;Arg&gt; STRING &lt;/Arg&gt; &lt;!-- phrase to exclaim --&gt;
    &lt;/yell&gt;
  &lt;/CellMethods&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    <span class="symbol">&#8208;</span> Declaration of the exposed
    method</span></p><p>The tag <code class="property">&lt;Exposed/&gt;</code> accomplishes two
    things:</p><div class="itemizedlist"><ul type="disc"><li><p>It makes the method available to clients.</p></li><li><p>On the cell, it acts as an <code class="property">&lt;Arg&gt;</code> tag
        that is automatically filled in with the entity ID of the client
        calling it.</p></li></ul></div><p>Client instances actually call the method with one argument less
    than are received by the cell entity, which prevents 'entity-faking'
    outside the safe server environment. The entity ID needs to be passed as
    an argument when calling exposed methods from the server
    components.</p><p>The definition of the method on the cell must be extended to take
    this parameter, as illustrated below:</p><pre class="programlisting">import BigWorld
class EntityName(BigWorld.Entity):

  def __init__(self):
    BigWorld.Entity.init(self)

  def <em class="emphasis">yell</em>(self, <em class="emphasis">sourceEntityID</em>, phrase):
    # insert code to implement yell here
    # if desired, check that self.id == sourceEntityID before proceeding
    return</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
    <span class="symbol">&#8208;</span> Definition of cell method
    <code class="methodname">yell</code></span></p><p>On the client, the method <code class="methodname">yell</code> can be
    called with the code below:</p><pre class="programlisting">self.cell.yell( "BigWorld message test" )</pre><p><span class="citetitle">Example of a client calling a cell method <em class="emphasis"><code class="methodname">yell</code></em></span></p><p>If the cell method <code class="methodname">yell</code> implements the
    check of <code class="varname">sourceEntityID</code> against
    <code class="varname">self</code>.<code class="varname">id</code>, only its client will be
    able to call it. Others clients will not be able to execute it.</p><p>There might be occasions where the method might run with a different
    <code class="varname">sourceEntityID</code>. For example, for a method called
    <code class="methodname">shakeHand</code>, it is a good idea to check that the
    source entity is within a couple of metres away from the
    <code class="varname">self</code> entity before proceeding (and maybe that neither
    is dead).</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4371"></a>5.4.1.&nbsp;Security Considerations of Exposed Methods</h3></div></div></div><p>Script writers should be aware that the arguments of any exposed
      method need to be heavily scrutinised on the server side before being
      operated on.</p><p>The underlying C++ code that handles the passing of arguments
      ensures that the method will be invoked on the server side only
      if:</p><div class="itemizedlist"><ul type="disc"><li><p>The right number of arguments is being passed.</p></li><li><p>The arguments have the expected type.</p></li></ul></div><p>Beyond that, however, the underlying architecture cannot provide
      any further constraints on the values that clients may pass to method
      calls on the server.</p><p>For example, integers may take any valid 32-bit value, strings and
      arrays may be of any length, &#8230;. It is up to the script writer to ensure
      that the arguments to an exposed method have values that make sense in
      the context of that method.</p><p>You should carefully inspect the value of any arguments to an
      exposed method before using them.</p><p>It is never safe to trust arbitrary Python objects from the client
      as passed in through <code class="code">PYTHON</code> parameters to exposed method
      invocations. A <span class="literal">WARNING</span> log message is emitted at
      startup by any component that parses the entity definitions if an
      exposed method has parameter of type <code class="code">PYTHON</code>. The safer
      alternative is to use some other data type that is more concretely
      defined, for example the <code class="code">FIXED_DICT</code> data type, and validate
      each known element.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Implicit_set_property_name_Methods"></a>5.5.&nbsp;Client callbacks on property changes</h2></div></div></div><p>When the server changes a property on the client a callback method
    is called on the entity to allow the client to take appropriate
    action.</p><p><code class="code">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code> is
    called when a property of an entity is replaced with a new value. That is,
    a value in the entity's <code class="code">__dict__</code> is replaced.</p><p>If an existing property is modified, either
    <code class="code">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code> or
    <code class="code">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code> is
    called.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4431"></a>5.5.1.&nbsp;Implicit
      <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</h3></div></div></div><p>When the server updates a property with distribution flag
      <sup>[<a name="d0e4441" href="#ftn.d0e4441">7</a>]</sup> <span class="literal">ALL_CLIENTS</span>,
      <span class="literal">OTHER_CLIENTS</span> or <span class="literal">OWN_CLIENT</span>, an
      implicit method called
      <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      is called on the client.</p><p>This method should not need be declared in the section
      <code class="property">&lt;ClientMethods&gt;</code> of the definition file as it
      is automatically provided by BigWorld.</p><p>All implicitly defined
      <code class="methodname">set_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      methods have one argument which receives the old value of the property
      when the method is called. For example:</p><pre class="programlisting">class Seat( BigWorld.Entity ):
    ...
  def <em class="emphasis">set_seatType</em>( self, <em class="emphasis">oldValue</em> ):
    ...</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Seat.py</code>
      <span class="symbol">&#8208;</span> Example of an implicit
      <code class="methodname">set_seatType</code> for the
      <code class="classname">Seat</code> entity.</span></p><p>Note that if an existing property is modified instead of being
      replaced and the appropriate
      <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      or
      <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      method does not exist, this method is called with the
      <code class="code">oldValue</code> argument as <code class="code">None</code>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4514"></a>5.5.2.&nbsp;Implicit
      <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</h3></div></div></div><p>If a nested property of an existing property is modified, the
      <code class="methodname">setNested_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      is called. This includes modifying a single element of an
      <code class="code">ARRAY</code> or <code class="code">FIXED_DICT</code>. The method accepts two
      arguments. The first represents the path to the change and the second is
      the value that has been replaced.</p><p>For example:</p><pre class="programlisting">class Seat( BigWorld.Entity ):
    ...
  def <em class="emphasis">setNested_myFixedDict</em>( self, <em class="emphasis">path</em>, <em class="emphasis">oldValue</em> ):
    ...</pre><p>The first argument represents the path to the changed property.
      For example, if the change was:</p><pre class="programlisting">self.myFixedDict.rightHandItem.weight = 10</pre><p>The value of path would be:</p><pre class="programlisting">["rightHandItem", "weight"]</pre><p>If you had a property that was <code class="code">ARRAY &lt;of&gt; ARRAY
      &lt;of&gt; INT32 &lt;/of&gt; &lt;/of&gt;.</code></p><pre class="programlisting">self.myArray[ 5 ][ 3 ] = 8</pre><p>would result with the value of path being:</p><pre class="programlisting">(5, 3)</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4566"></a>5.5.3.&nbsp;Implicit
      <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      Methods</h3></div></div></div><p>If a slice of an array is modified, the
      <code class="methodname">setSlice_<em class="replaceable"><code>&lt;property_name&gt;</code></em></code>
      is called. This includes appending and deleting from an array. The
      method accepts two arguments. The first represents the path to the
      changed slice and the second is the slice that has been replaced. The
      last value in the path is a tuple containing two integers. These
      represent the range of the new values. To create a slice containing the
      new values, use <code class="code">myModifiedArray[ path[-1][0] : path[-1][1]
      ]</code>.</p><p>For example, if <code class="code">self.myArray</code> is an existing array
      with 5 elements:</p><pre class="programlisting">self.myArray.append( 10 )</pre><p>would result in <code class="methodname">setSlice_myArray</code> being
      called with:</p><pre class="programlisting">path = [(5,6)]
oldValues = [ ]
newValues = self.myArray[ path[-1][0] : path[-1][1] ]</pre><p>If the array is part of a <code class="code">FIXED_DICT</code> and the array
      has 5 elements with the last value 21.</p><pre class="programlisting">del self.myFixedDict.myArray[-1]</pre><p>would result in:</p><pre class="programlisting">path = ["myArray", (4,4)]
oldValues = [21]</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4609"></a>5.6.&nbsp;LOD on Methods</h2></div></div></div><p>Like properties, some methods need to be broadcast only to nearby
    entities.</p><p>For example, even though an entity may be visible at an AoI distance
    (500 metres), it seems unlikely that players will be able to tell the
    difference between a smiling and a non-smiling entity.</p><p>To reflect his, the smile method's level of detail, can be declared
    as illustrated below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;ClientMethods&gt;
    ...
    &lt;<em class="emphasis">smile</em>&gt;
      ...
      &lt;<em class="emphasis">DetailDistance</em>&gt; <em class="emphasis">30</em> &lt;/DetailDistance&gt;
    &lt;/smile&gt;
    ...
  &lt;/ClientMethods&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
    <span class="symbol">&#8208;</span> Declaration of client method
    <code class="methodname">smile</code></span></p><p>The specification of the LOD for a method is far simpler than it is
    for a property. This is because a non-broadcast property change might have
    to be sent later if the LOD increases, while a non-broadcast method in the
    same scenario will not have to.</p><p>Consequently, the method just needs to declare a tag
    <code class="property">&lt;DetailDistance&gt;</code> inline, and when it is called
    on exposed objects <code class="varname">allClients</code> or
    <code class="varname">otherClients</code>, it is broadcast only to clients within
    the specified distance around the entity.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Inter_Entity_Communication"></a>5.7.&nbsp;Inter-Entity Communication</h2></div></div></div><p>Once the entities have methods assigned to them, it becomes useful
    to be able to call methods on other entities.</p><p>If you have an object <code class="varname">ent</code> as a Python script
    representation of another entity, then you can call
    <code class="varname">ent</code>.<code class="methodname">someMethod</code>() to call that
    method on <code class="varname">ent</code>. This assumes that
    <code class="methodname">someMethod</code>() runs on the same execution context
    you are in. For example, if you are on the cell, then
    <code class="varname">ent</code>.<code class="methodname">someMethod</code>() must be
    defined and provided by the entity type of <code class="varname">ent</code>.</p><p>If you are on the cell, you can call a method on the base, with the
    code below:</p><pre class="programlisting">ent.base.otherMethod()</pre><p>This means that once you are able to obtain an entity object, there
    is a plethora of options for invoking methods on different execution
    contexts of different entity instances. For more details, see <a href="#xref_Intra_Entity_Communication" title="5.2.&nbsp;Intra-Entity Communication">Intra-Entity Communication</a>.</p><p>But to achieve this, first it is necessary to retrieve the object
    for another entity. The mechanism for that is described in the next
    sub-section</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4698"></a>5.7.1.&nbsp;Entity IDs</h3></div></div></div><p>In order to uniquely identify every object in the game universe,
      BigWorld assigns a unique number to every entity. This is referred to as
      the entity ID.</p><p>In the <code class="classname">BigWorld</code> Python module (which is
      imported at the start of most scripts), there is an object which maps
      entity IDs to the corresponding entity object. This object has the same
      interface as a Python dictionary, and is called
      <code class="classname">BigWorld</code>.<code class="varname">entities</code>.</p><p>Given an entity id <code class="varname">entityID</code>, its entity object
      can be retrieved with the code below:</p><pre class="programlisting">ent = BigWorld.entities[ entityID ]</pre><p><span class="citetitle">Retrieval of entity object using its
      ID</span></p><p>One should be very careful with entity IDs, and always check for
      the existence of the corresponding entity before assuming that it is
      safe to use it.
      <code class="classname">BigWorld</code>.<code class="varname">entities</code> throws an
      exception if the entity looked up does not exist.</p><p>Each execution context has a version of the
      <code class="classname">BigWorld</code>.<code class="varname">entities</code> object with
      different entities in it.</p><p><code class="classname">BigWorld</code>.<code class="varname">entities</code>
      contains the entities that are relevant to the execution context in
      which it is located, as listed below:</p><div class="altrow"><table border="0"><colgroup><col width="18%"><col width="82%"></colgroup><thead><tr><th align="left">Execution context</th><th align="left">Entities listed in
                <code class="classname">BigWorld</code>.<code class="varname">entities</code></th></tr></thead><tbody><tr><td align="left">Cell</td><td align="left">Real and ghosted entities located on all
                cells managed by this cell's CellApp.</td></tr><tr><td align="left">Base</td><td align="left">Entities located on this base's BaseApp
                <sup>[<a name="d0e4774" href="#ftn.d0e4774">a</a>]</sup>.</td></tr><tr><td align="left">Client</td><td align="left">Entities in the client's AoI.</td></tr></tbody><tbody class="footnotes"><tr><td colspan="2"><div class="footnote"><p><sup>[<a name="ftn.d0e4774" href="#d0e4774">a</a>] </sup>For sending messages to bases on other BaseApps, see
                    <a href="#xref_Mailboxes" title="5.8.&nbsp;Mailboxes">Mailboxes</a></p></div></td></tr></tbody></table></div><p><span class="citetitle">Entities listed in
      <code class="classname">BigWorld</code>.<code class="varname">entities</code> per
      execution context.</span></p><p>Entity IDs can be obtained in various ways:</p><div class="orderedlist"><ol type="1"><li><p>From exposed methods (client sends entity ID as
          argument).</p></li><li><p>From the entity object's <code class="varname">id</code>
          property.</p><p>You can pass the object's ID from one execution context to
          another (<em class="emphasis">e.g.</em>, from the client to the cell), so
          that the other context can obtain the corresponding object. You can
          also use this property to obtain the ID of a newly created
          entity.</p></li><li><p>From various utility methods that one can use to find entity
          references.</p><p>One of these methods is
          <code class="methodname">entitiesInRange</code><sup>[<a name="d0e4816" href="#ftn.d0e4816">8</a>]</sup>. This method is defined for every cell entity, and
          returns all entity objects located within a certain distance from
          the calling entity. The resulting output can be queried again for
          more specific search results.</p><p>For example, to find all the <code class="classname">Guard</code>
          entities within 100 metres of the current entity, you could have the
          code below:</p><pre class="programlisting">def findGuards():
  output = []
  for entity in <em class="emphasis">self</em>.<em class="emphasis">entitiesInRange</em>( 100 ):
    if entity.__class__.__name__ == "Guard":
      output += [entity]
  return output</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</code>
          <span class="symbol">&#8208;</span> Obtaining ID of surrounding
          entities</span></p><p>Care should be taken when using this approach for entity
          discovery as it is a linear search, and hence does not scale well.
          Specifically to be avoided are searches over large entity sets that
          could be obtained from a search of large distances, or from using
          the complete set of entities in
          <code class="classname">BigWorld</code>.<code class="varname">entities</code>. For a
          small distance however, one would not expect large numbers of
          objects (although this depends on the game).</p></li></ol></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Mailboxes"></a>5.8.&nbsp;Mailboxes</h2></div></div></div><p>Mailboxes are used to communicate to entities that are remote,
    <em class="emphasis">i.e.</em>, not on the current process.</p><p>Entities can only access other entities that are running in the same
    execution context<sup>[<a name="d0e4870" href="#ftn.d0e4870">9</a>]</sup>, however it is frequently useful to be able to send a
    message to entities in other execution contexts. For example, an entity
    may wish to send a message to all members of a chat channel, but the
    channel might not have all its members located on the same BaseApp as the
    executing entity.</p><p>Mailboxes are used to implement the following properties of an
    entity:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="varname">self</code>.<code class="varname">cell</code></p></li><li><p><code class="varname">self</code>.<code class="varname">base</code></p></li><li><p><code class="varname">self</code>.<code class="varname">ownClient</code></p></li></ul></div><p>These properties allow you to reference objects located on different
    processes, and can be sent like any other value, using method calls, and
    the <span class="literal">MAILBOX</span> data type.</p><p>You can use the <span class="literal">MAILBOX</span> like a normal entity
    reference, and call methods declared in the entity's definition file on
    other entities on other processes.</p><p>Considering that an entity <em class="emphasis">B</em> (referenced in the
    following example as <code class="varname">anotherEntity</code>) has a method
    <code class="methodname">heyThere</code> which takes one argument of type
    <span class="literal">MAILBOX</span>, an entity <em class="emphasis">A</em> can pass its
    base mailbox to entity <em class="emphasis">B</em> from the cell, as in the
    example below:</p><pre class="programlisting">anotherEntity.heyThere( <em class="emphasis">self.base</em> )</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;original_entity&gt;</code></em>.py</code>
    <span class="symbol">&#8208;</span> Passing base mailbox from
    cell</span></p><p>On the receiving entity <em class="emphasis">B</em> (referenced in the
    example as <code class="varname">anotherEntity</code>), the calling entities (entity
    <em class="emphasis">A</em>) base mailbox (as received via the method argument)
    can be used to call a method <code class="methodname">someMethod</code> on entity
    <em class="emphasis">A</em>. For example:</p><pre class="programlisting">def heyThere( self, <em class="emphasis">originalEntity</em> ):
  <em class="emphasis">originalEntity</em>.<em class="emphasis">someMethod</em>()</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>&lt;another_entity&gt;</code></em>.py</code>
    <span class="symbol">&#8208;</span> Receiving base mailbox</span></p><p>It is also possible to store mailboxes in a class as properties.
    However this is only useful for base entity mailboxes, since they will not
    change address as the entity moves around the space.</p><p>Cell entity mailboxes should not be stored, because they can change
    as the entity moves between cells. It is possible to pass cell entity
    mailboxes to another entity for once-off use, since they are guaranteed to
    be usable for the time it takes to call a method and have it respond
    (<em class="emphasis">i.e.</em>, up to approximately 1 second).</p><p>Using mailboxes, it is also possible to call methods within a
    different execution context to that of the mailbox being called. For
    example, using a base mailbox of an entity (<code class="varname">baseMB</code> in
    the following code), it is possible to call a cell method of the base
    entity as follows:</p><pre class="programlisting">baseMB.cell.cellMethod()</pre><p><span class="citetitle">Calling a cell method of another entity through its base
    mailbox</span></p><p>The call is sent to the base entity first, which then calls the cell
    method from where the base entity resides. Though it is more convenient
    than calling a base method that in turn calls the cell method, it still
    takes two hops to call the cell entity.</p><p>Available usages are:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="literal">baseMB.cell</span></p></li><li><p><span class="literal">baseMB.ownClient</span></p></li><li><p><span class="literal">cellMB.base</span></p></li><li><p><span class="literal">cellMB.ownClient</span></p></li></ul></div><p>These are in fact instances of MailBoxes, and can be passed as
    method arguments. However, the same restriction applies to
    <span class="literal">cellMB.base</span> and <span class="literal">cellMB.client</span> as to
    cell mailboxes <span class="symbol">&#8208;</span> they can change as an
    entity moves around, and therefore should not be stored for later
    use.</p><p>Note that both <span class="literal">baseMB.ownClient</span> and
    <span class="literal">cellMB.ownClient</span> refer to their own client only. There
    are no shortcut calls to <span class="literal">otherClients</span> and
    <span class="literal">allClients</span>.</p><p>A convenient way to obtain other entities' mailboxes is by using the
    methods
    <code class="classname">BigWorld</code>.<code class="methodname">lookUpBaseByDBID</code>
    and
    <code class="classname">BigWorld</code>.<code class="methodname">lookUpBaseByName</code>
    on the BaseApp. For more details, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/baseapp/index.html#Client_Python_API" class="olink">Client Python API</a>'s entry <em class="emphasis">Main&nbsp;Page <span class="symbol">&#8594;</span> BigWorld
    (Module) <span class="symbol">&#8594;</span> Member
    Functions</em>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5076"></a>5.9.&nbsp;Method Execution Context</h2></div></div></div><p>All entity method calls across physical machines are asynchronous.
    For example, if you execute <span class="literal">self.cell.cellMethod()</span> or
    <span class="literal">self.client.clientMethod()</span> on a base entity, the call
    returns immediately without any value. The actual method execution takes
    place on the machine where the cell or client part of the entity
    resides.</p><p>To inform the calling entity of the execution result you will have
    to call a function from within the method.</p><p>The example below describes the client entity of class
    <span class="literal">Avatar</span> initiating a sequence of actions to open a door,
    executing the following steps:</p><div class="orderedlist"><ol type="1"><li><p>The client method <span class="literal">openDoor</span> of class
        <span class="literal">Avatar</span> calls its cell method
        <span class="literal">openDoor</span>.</p></li><li><p>That method then calls the cell method <span class="literal">unlock</span>
        of class <span class="literal">Door</span>, passing <span class="literal">self</span> as
        an argument. This way, <span class="literal">Door</span> receives a mailbox of
        the cell entity <span class="literal">Avatar</span>, which is later used (with
        exposed object client) to call the appropriate cell method on
        <span class="literal">Avatar</span>.</p></li><li><p>That method then checks the keycard, and using the cell mailbox
        (<span class="literal">sourceEntity</span>), makes a call directly to the
        appropriate client method of class <span class="literal">Avatar</span> (in this
        example, we assume it was successful).</p></li></ol></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">The client entity of the
        <span class="literal">Avatar</span> class:</em></p><pre class="programlisting">class Avatar( ):
  ...
  def openDoor( self, doorID ):
    # Call the cell method to open the door
    self.cell.openDoor( doorID )
  ...
  def doorOpenFailed( self, doorID, keycard ):
    # Animation shows the Avatar scratching his head
  ...
  def doorOpenSucceeded( self, doorID, keycard ):
    # Animation shows the door with corresponding doorID opening
  ...</pre><p><span class="citetitle"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>
        <span class="symbol">&#8208;</span> Definition of <span class="literal">door</span>
        methods</span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">The cell entity of the
        <span class="literal">Avatar</span> class:</em></p><pre class="programlisting">class Avatar( ):
  ...
  def openDoor( self, doorID ):
    # locate the door
    door = self.locateTheDoor( doorID )
    keycard = self.getKeycardFromInventory()
    door.unlock( self, keycard )
   ...</pre><p><span class="citetitle"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</span>
        <span class="symbol">&#8208;</span> Definition of
        <span class="literal">methodopenDoor</span></span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">The cell entity of the
        <span class="literal">Door</span> class:</em></p><pre class="programlisting">class Door( BigWorld.Entity ):
  ...
  def unlock( self, sourceEntity, keycard ):
  # check source is close enough
  # check keycard is good
  if not self.isGoodKeycard( keycard ):
    sourceEntity.client.doorOpenFailed( self.id, keycard )
  else:
    self.isOpen = True
    sourceEntity.client.doorOpenSucceeded( self.id, keycard )
  ...</pre><p><span class="citetitle"><span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Door.py</span>
        <span class="symbol">&#8208;</span> Definition of
        <span class="literal">methodunlock</span></span></p></li></ul></div><p>The same callback technique is used to return values from a called
    method.</p><p>The example below describes the client entity of class
    <span class="literal">Avatar</span> initiating a sequence of actions to inquire
    about an item's description based on its inventory index, executing the
    following steps:</p><div class="orderedlist"><ol type="1"><li><p>The client method <span class="literal">investigateInventory</span> of
        class <span class="literal">Avatar</span> calls its base method
        <span class="literal">itemDescriptionRequest</span>.</p></li><li><p>That method then calls its client method
        <span class="literal">itemDescriptionReply</span>.</p></li><li><p>That method then displays the item's description.</p></li></ol></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">The client entity of the
        <span class="literal">Avatar</span> class:</em></p><pre class="programlisting">class Avatar( ):
  ...
  def investigateInventory( self, indexInInventory ):
    # first get the details from the server
    self.base.itemDescriptionRequest( indexInInventory )
    # maybe have a timeout in case server doesn't reply
  ...
  def itemDescriptionReply( self, indexInInventory, desc ):
    # call the callback
    if desc == []:
      GUI.addAlert( "No such item" + str(indexInInventory) )
      return
    GUI.displayItemWindow( indexInInventory, desc )
  ...</pre><p><span class="citetitle">Example
        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/Avatar.py</span>
        <span class="symbol">&#8208;</span> Definition of inventory
        methods</span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">The base entity of the
        <span class="literal">Avatar</span> class:</em></p><pre class="programlisting">class Avatar( ):
  ...
  def itemDescriptionRequest( self, indexInInventory ):
    try:
      desc = self.generateDescription( indexInInventory )
    except:
      desc = []    # in case no such index
    self.client.itemDescriptionReply( indexInInventory, desc )
  ...</pre><p><span class="citetitle">Example
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Avatar.py</code>
        <span class="symbol">&#8208;</span> Definition of
        <code class="methodname">itemDescriptionRequest</code></span></p></li></ul></div><p>For those entities residing in the same process, the method calls
    take place synchronously. However, since there is no guarantee that the
    calling entities and the called ones will always be in the same process,
    it is better to adopt the callback solution.</p><p>A special case is an entity method that is not defined in the
    entity's definition file
    (<span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</span>
    <span class="symbol">&#8208;</span> For details, see <a href="#xref_The_Definition_File" title="2.2.&nbsp;The Entity Definition File">The Entity Definition File</a>). In this case, the method is always
    executed synchronously, and is only executed in the process of the caller.
    For example, a method call on a ghosted entity normally will be delegated
    to the real one. However, if this method is not defined in the entity's
    definition file, it will be treated as a usual Python method, and run
    locally.</p><p>This mechanism does save a bit of network traffic between server
    components, and can return a result immediately to the caller, but it is
    also limited in that it can only access the read-only ghosted properties.
    Trying to access non-ghosted properties or to write read-only properties
    would result in unexpected errors. Unless carefully planned, one should
    not take advantage of this feature.</p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e4441" href="#d0e4441">7</a>] </sup>For details on property's distribution flags, see <a href="#xref_Data_Distribution" title="4.3.&nbsp;Data Distribution">Data Distribution</a></p></div><div class="footnote"><p><sup>[<a name="ftn.d0e4816" href="#d0e4816">8</a>] </sup>For other methods, please refer to the
              <code class="classname">BigWorld</code>.<code class="classname">Entity</code>
              class reference in the Base, Cell and Client Python API
              documentation.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e4870" href="#d0e4870">9</a>] </sup>For more details, see <a href="#xref_Inter_Entity_Communication" title="5.7.&nbsp;Inter-Entity Communication">Inter-Entity Communication</a></p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Inheritance_In_BigWorld"></a>Chapter&nbsp;6.&nbsp;Inheritance in BigWorld</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e5313">6.1. Python Class Inheritance</a></span></dt><dt><span class="section"><a href="#xref_Entity_Interfaces">6.2. Entity Interfaces</a></span></dt><dt><span class="section"><a href="#xref_Entity_Parents">6.3. Entity Parents</a></span></dt><dt><span class="section"><a href="#xref_Client_Entity_Reuse">6.4. Client Entity Reuse</a></span></dt><dt><span class="section"><a href="#d0e5727">6.5. User Data Object Interfaces and Parents</a></span></dt></dl></div><p>Class-based inheritance is a useful design technique in
  object-orientated software, and is implemented in most object-orientated
  languages.</p><p>BigWorld uses three separate classes (for the cell, base, and client
  entity parts) to implement an entity, and a definition file
  (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>)
  to tie them all together. As such, there are a variety of ways that
  entities, or parts of entities, may use inheritance in their specification
  and implementation.</p><p>There are three different ways to declare inheritance relationships in
  BigWorld, all fulfilling different needs.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5313"></a>6.1.&nbsp;Python Class Inheritance</h2></div></div></div><p>The Python language allows classes to be derived from each
    other.</p><p>For example, to define a class <code class="classname">B</code>, derived
    from <code class="classname">A</code>, and methods for each of them, you can have
    the code below:</p><pre class="programlisting">class <em class="emphasis">A</em>:
  def <em class="emphasis">f</em>( self ):
    print "A.f was called"

class <em class="emphasis">B</em>( <em class="emphasis">A</em> ):
  def <em class="emphasis">g</em>( self ):
    print "B.g was called"</pre><p><span class="citetitle">Declaring Python class <code class="classname">A</code> and its
    derived class <code class="classname">B</code></span></p><p>Then suppose you have a program with the code below:</p><pre class="programlisting">x = B()
x.f()
x.g()</pre><p><span class="citetitle">Program using Python class inheritance</span></p><p>The output of this program will be as illustrated below:</p><pre class="programlisting">A.f was called
B.g was called</pre><p><span class="citetitle">Example program output</span></p><p>When used in entities, this form of inheritance allows the sharing
    of common implementation details between entity types. Multiple
    inheritance is allowed, so that you can use many Python classes to help
    implement disparate features in some entities.</p><p>This concept is illustrated in the diagram and code fragments
    below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/python_class_inheritance.png"><span class="caption"><p>Python class inheritance</p></span></div></div><p>The code fragments below show how the Python class
    <code class="classname">CommonBase</code> could be used in an entity
    <code class="classname">DerivedEntity</code><sup>[<a name="d0e5383" href="#ftn.d0e5383">10</a>]</sup></p><div class="orderedlist"><ol type="1"><li><p>If a base class' cell script
        (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/CommonBase.py</code>)
        is defined as below:</p><pre class="programlisting"><em class="emphasis"># note that this class is not derived from BigWorld.Entity
# so it is just an ordinary Python class</em>
class <em class="emphasis">CommonBase</em>:
  ...
  def <em class="emphasis">readyForAction</em>( self ):
    # implement method's logic
    return True
  ...</pre></li><li><p>If a derived entity's cell script
        (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/DerivedEntity1.py</code>)
        is defined as below:</p><pre class="programlisting"><em class="emphasis">import BigWorld
from common import CommonBase</em>
...
# derive from CommonBase, so you can use the method readyForAction
class <em class="emphasis">DerivedEntity1</em>( <em class="emphasis">BigWorld.Entity</em>, <em class="emphasis">CommonBase</em> ):
  ...
  def <em class="emphasis">__init__</em>( self ):
    BigWorld.Entity.__init__( self )
    CommonBase.__init__( self )
  ...
  def <em class="emphasis">someAction</em>( self ):
    if self.readyForAction():
      print "action performed"
  ...</pre></li><li><p>Then you can call methods from the base class, as illustrated
        below:</p><pre class="programlisting">DerivedEntity1.readyForAction()</pre></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Entity_Interfaces"></a>6.2.&nbsp;Entity Interfaces</h2></div></div></div><p>BigWorld also supports inheritance in a form similar to Java's
    interface system. There can be a folder <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/defs/interfaces</code>
    that can be used to declare common parts of entities. This allows the
    definition in one place of often-used declarations.</p><p>This concept is illustrated below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/python_entity_interfaces.png"><span class="caption"><p>Python entity interfaces</p></span></div></div><p>The format of entity interface definition files is similar to the
    format of entity definition files, except that interface definition files
    do not have the section <code class="property">&lt;Parent&gt;</code>. For more
    details on entity definition files, see <a href="#xref_The_Definition_File" title="2.2.&nbsp;The Entity Definition File">The Entity Definition File</a>.</p><p>The outline of an interface definition file is described below (all
    sections are optional):</p><pre class="programlisting">&lt;root&gt;

  &lt;<em class="emphasis">Implements</em>&gt;
    <em class="emphasis">&lt;!-- interface references --&gt;</em>
  &lt;/Implements&gt;
  
  &lt;<em class="emphasis">Properties</em>&gt; <a name="co3523" href="#co3523_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>
    &lt;!-- properties --&gt;
  &lt;/Properties&gt;

  &lt;<em class="emphasis">ClientMethods</em>&gt; <a name="co3527" href="#co3527_desc"><img src="../images/callouts/2.png" alt="2" border="0"></a>
    &lt;!-- client methods --&gt;
  &lt;/ClientMethods&gt;

  &lt;<em class="emphasis">CellMethods</em>&gt; <a name="co3531" href="#co3531_desc"><img src="../images/callouts/3.png" alt="3" border="0"></a>
    &lt;!-- cell methods --&gt;
  &lt;/CellMethods&gt;

  &lt;<em class="emphasis">BaseMethods</em>&gt; <a name="co3535" href="#co3535_desc"><img src="../images/callouts/4.png" alt="4" border="0"></a>
    &lt;!-- base methods --&gt;
  &lt;/BaseMethods&gt;

  &lt;<em class="emphasis">LoDLevels</em>&gt; <a name="co3539" href="#co3539_desc"><img src="../images/callouts/5.png" alt="5" border="0"></a>
    &lt;!-- levels of detail --&gt;
  &lt;/LODLevels&gt;

&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/interfaces/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    <span class="symbol">&#8208;</span> Minimal entity definition
    file</span></p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co3523_desc"></a><a href="#co3523"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Properties" title="Chapter&nbsp;4.&nbsp;Properties"><i xmlns:xlink="http://www.w3.org/1999/xlink">Properties</i></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co3527_desc"></a><a href="#co3527"><img src="../images/callouts/2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Methods" title="Chapter&nbsp;5.&nbsp;Methods"><i xmlns:xlink="http://www.w3.org/1999/xlink">Methods</i></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co3531_desc"></a><a href="#co3531"><img src="../images/callouts/3.png" alt="3" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Methods" title="Chapter&nbsp;5.&nbsp;Methods"><i xmlns:xlink="http://www.w3.org/1999/xlink">Methods</i></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co3535_desc"></a><a href="#co3535"><img src="../images/callouts/4.png" alt="4" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_Methods" title="Chapter&nbsp;5.&nbsp;Methods"><i xmlns:xlink="http://www.w3.org/1999/xlink">Methods</i></a>.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co3539_desc"></a><a href="#co3539"><img src="../images/callouts/5.png" alt="5" border="0"></a> </td><td valign="top" align="left"><p>For details, see <a href="#xref_LOD_Level_Of_Detail_On_Properties" title="4.6.&nbsp;LOD (Level of Detail) on Properties">LOD (Level of Detail) on Properties</a>.</p></td></tr></table></div><p>Unlike entities, entity interfaces do not need to have associated
    Python implementation files, although this can be a good idea.</p><p>The code fragments below illustrate the result of using an interface
    in an entity definition file:</p><div class="orderedlist"><ol type="1"><li><p>If an entity is defined implementing an interface
        (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/someEntity.def</code>),
        as below:</p><pre class="programlisting">&lt;!-- <em class="emphasis">someEntity </em>--&gt;
&lt;root&gt;
  ...
  &lt;<em class="emphasis">Implements</em>&gt;
    &lt;<em class="emphasis">Interface</em>&gt; <em class="emphasis">someInterface</em> &lt;/Interface&gt;
  &lt;/Implements&gt;
  ...
&lt;/root&gt;</pre></li><li><p>And if the implemented interface is defined
        (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/interfaces/someInterface.def</code>)
        as below:</p><pre class="programlisting">&lt;!-- <em class="emphasis">someInterface</em> --&gt;
&lt;root&gt;
  &lt;Properties&gt;
    &lt;name&gt;
      &lt;Type&gt;  STRING       &lt;/Type&gt;
      &lt;Flags&gt; ALL_CLIENTS  &lt;/Flags&gt;
    &lt;/name&gt;
  &lt;/Properties&gt;
&lt;/root&gt;</pre></li><li><p>Then conceptually, the resulting entity definition is as defined
        as below:</p><pre class="programlisting">&lt;!-- <em class="emphasis">someEntity</em> --&gt;
&lt;root&gt;
  ...
  &lt;Properties&gt;
    &lt;name&gt;
      &lt;Type&gt;  STRING       &lt;/Type&gt;
      &lt;Flags&gt; ALL_CLIENTS  &lt;/Flags&gt;
    &lt;/name&gt;
  &lt;/Properties&gt;
  ...
&lt;/root&gt;</pre></li></ol></div><p>A property from an interface can be overridden if the description
    needs to be changed. In this case, the entire property description is
    replaced with the new one, so all appropriate fields need to be
    specified.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Entity_Parents"></a>6.3.&nbsp;Entity Parents</h2></div></div></div><p>It is often possible to define an entity that provides functionality
    common to other entity types as a single base entity. For example, a
    collection of NPCs may share most of their implementation, but need some
    specific tuning to turn them into a guard or a shopkeeper.</p><p>This concept is illustrated below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/python_entity_parents.png"><span class="caption"><p>Python entity parents</p></span></div></div><p>The code fragments below demonstrate this form of
    inheritance.</p><div class="orderedlist"><ol type="1"><li><p>Define the base entity <code class="classname">GenericEntity</code>
        (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/GenericEntity.def</code>):</p><pre class="programlisting">&lt;!-- <em class="emphasis">GenericEntity</em> --&gt;
&lt;root&gt;
  &lt;!-- common properties and methods --&gt;
&lt;/root&gt;</pre></li><li><p>Define <code class="classname">GenericEntity</code>'s base
        script:</p><pre class="programlisting">import BigWorld

class <em class="emphasis">GenericEntity</em>( <em class="emphasis">BigWorld.Base</em> ):
  ...
  def __init__( self ):
    BigWorld.Base.__init__( self )
  ...</pre></li><li><p>Define <code class="classname">GenericEntity</code>'s cell
        script:</p><pre class="programlisting">import BigWorld

class <em class="emphasis">GenericEntity</em>( <em class="emphasis">BigWorld.Entity</em> ):
  ...
  def __init__( self ):
    BigWorld.Entity.__init__( self )
  ...</pre></li><li><p>Define derived entity
        <code class="classname">SpecificEntity</code>:</p><pre class="programlisting">&lt;!-- <em class="emphasis">SpecificEntity</em> --&gt;
&lt;root&gt;
  &lt;!-- inheritance is defined in this tag --&gt;
  &lt;Parent&gt; <em class="emphasis">GenericEntity</em> &lt;/Parent&gt;

  &lt;!-- add more properties and methods here --&gt;
&lt;/root&gt;</pre></li><li><p>Define <code class="classname">SpecificEntity</code>'s base
        script:</p><pre class="programlisting">import BigWorld
<em class="emphasis">import GenericEntity</em>

class <em class="emphasis">SpecificEntity</em>( <em class="emphasis">GenericEntity.GenericEntity</em> ):
  ...
  def __init__( self ):
    GenericEntity.GenericEntity.__init__( self )
 ...</pre></li><li><p>Define <code class="classname">SpecificEntity</code>'s cell
        script:</p><pre class="programlisting">import BigWorld
<em class="emphasis">import GenericEntity</em>

class <em class="emphasis">SpecificEntity</em>( <em class="emphasis">GenericEntity.GenericEntity</em> ):
  ...
  def __init__( self ):
    GenericEntity.GenericEntity.__init__( self )
  ...</pre></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Client_Entity_Reuse"></a>6.4.&nbsp;Client Entity Reuse</h2></div></div></div><p>There may be times when an entity type only needs to be specialised
    on the server. Using the optional section
    <code class="property">&lt;ClientName&gt;</code> in a <code class="filename">.def</code> file allows a different (usually parent)
    entity type to be used for the client entity.</p><p>For example, if <code class="classname">NPC</code> is derived from
    <code class="classname">Avatar</code>, and <code class="classname">NPC</code> contains
    additional properties that the client does not need to access,
    <code class="classname">NPC</code> objects can be sent to clients as
    <code class="classname">Avatar</code> objects. This means that the client does not
    need a specific script to handle <code class="classname">NPC</code>s.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5727"></a>6.5.&nbsp;User Data Object Interfaces and Parents</h2></div></div></div><p>The inheritance of interfaces and parents described for entities
    also apply to User Data Objects. Due to the similarity of User Data
    Objects to regular Entities, for further details, please refer to sections
    <a href="#xref_Entity_Interfaces" title="6.2.&nbsp;Entity Interfaces">Entity Interfaces</a> and <a href="#xref_Entity_Parents" title="6.3.&nbsp;Entity Parents">Entity Parents</a></p><p>For an example of inheritance in User Data Objects see
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/user_data_object_defs/testItem.def</code>
    and
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/user_data_object_defs/testParent.def</code>.</p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e5383" href="#d0e5383">10</a>] </sup>Although this example is implemented on the cell, this technique
        is also useful for base and client scripts.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Entity_Instantiation_And_Destruction"></a>Chapter&nbsp;7.&nbsp;Entity Instantiation and Destruction</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Entity_Instantiation_On_The_BaseApp">7.1. Entity Instantiation on the BaseApp</a></span></dt><dt><span class="section"><a href="#xref_Cell_Entity_Creation_From_BaseApp">7.2. Cell Entity Creation From BaseApp</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6011">7.2.1. Creation Near an Existing Cell Entity</a></span></dt><dt><span class="section"><a href="#d0e6099">7.2.2. Creation in a Numbered Space</a></span></dt><dt><span class="section"><a href="#d0e6149">7.2.3. Creation in a New Space</a></span></dt><dt><span class="section"><a href="#d0e6169">7.2.4. Creation in Default Space</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6199">7.3. Entity Destruction</a></span></dt><dt><span class="section"><a href="#d0e6315">7.4. Entity Instantiation From The CellApp</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6320">7.4.1. Instantiation With No Base Counterpart</a></span></dt><dt><span class="section"><a href="#d0e6380">7.4.2. Instantiation With Base Counterpart</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6441">7.5. Loading Entities From Chunk Files</a></span></dt></dl></div><p>Due to the way that BigWorld entities must be set up and linked to
  each other, they must be instantiated differently to how other objects are
  instantiated in Python. Similarly, because the parts must be unlinked at
  destruction time, there are special ways of accomplishing this.</p><p>As mentioned in section <a href="#xref_The_Script_Files" title="2.3.&nbsp;The Script Files">The Script Files</a>, an
  entity can have a part located on the cell (in both real and ghost forms), a
  part on the base, and another on clients that have the entity in their AoI.
  Different entity types may support their instances being only on one, two,
  or all three of these. Also, it is possible for instances of entity types to
  have less parts than their type supports.</p><p>Most commonly, the base part of an entity is created first and then,
  if appropriate, its cell part. There are a number of reasons for
  this.</p><div class="itemizedlist"><ul type="disc"><li><p>The base entity can be created directly from the database, while
      the cell entity cannot.</p></li><li><p>The base entity can create its cell part, but the reverse is not
      true.</p></li><li><p>The cell entity needs an associated base entity to be
      fault-tolerant.</p></li><li><p>The cell entity needs an associated base entity to write itself to
      the database.</p></li></ul></div><p>For entity types that have base and cell parts, the base part is
  always created before the cell part, and destroyed after it. It is also
  possible to create a cell entity that does not have a base part.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Entity_Instantiation_On_The_BaseApp"></a>7.1.&nbsp;Entity Instantiation on the BaseApp</h2></div></div></div><p>The base entity can be created in the following ways:</p><div class="itemizedlist"><ul type="disc"><li><p>Directly from script, using the methods
        <code class="classname">BigWorld</code>.<code class="methodname">createBaseAnywhere</code>
        <sup>[<a name="d0e5788" href="#ftn.d0e5788">11</a>]</sup>,
        <code class="classname">BigWorld</code>.<code class="methodname">createBaseLocally</code>,
        or
        <code class="classname">BigWorld</code>.<code class="methodname">createBaseRemotely</code></p></li><li><p>From the database, using the methods
        <code class="classname">BigWorld</code>.<code class="methodname">createBaseFromDBID</code>
        or
        <code class="classname">BigWorld</code>.<code class="methodname">createBaseFromDB</code>.</p></li></ul></div><p>For more details on instantiating entities from the data stored in
    the database, see <a href="#xref_The_Database_Layer" title="Chapter&nbsp;8.&nbsp;The Database Layer"><i xmlns:xlink="http://www.w3.org/1999/xlink">The Database Layer</i></a>.</p><p>The method
    <code class="classname">BigWorld</code>.<code class="methodname">createBaseAnywhere</code>
    can specify both the base and cell entity properties, and has the
    following signature:</p><pre class="programlisting">def createBaseAnywhere( entityTypeName, *args, **kwargs ):</pre><p><span class="citetitle">Method
    <code class="classname">BigWorld</code>.<code class="methodname">createBaseAnywhere</code>'s
    signature</span></p><p>The parameter <em class="parameter"><code>entityTypeName</code></em> is a string
    containing the name of the entity type to instantiate. For example, to
    instantiate an entity <code class="classname">ExampleEntity</code>, this parameter
    would be <span class="literal">"ExampleEntity"</span>.</p><p>In its simplest form, it creates the entity with all default values,
    and is invoked as in the example below:</p><pre class="programlisting">newEntity = BigWorld.createBaseAnywhere( "ExampleEntity" )</pre><p><span class="citetitle">Example of method
    <code class="classname">BigWorld</code>.<code class="methodname">createBaseAnywhere</code></span></p><p>This method can optionally take a list of other parameters that are
    searched to create base and cell entity values. These parameters can
    be:</p><div class="itemizedlist"><ul type="disc"><li><p>Keyword arguments</p></li><li><p>Dictionaries</p></li><li><p><code class="classname">ResMgr</code>.<code class="classname">DataSection</code></p></li></ul></div><p>The keyword arguments are searched first, then the dictionaries, and
    finally the DataSection. If a value is not found for any of the entity's
    properties, the default value for that property / data type is
    assigned.</p><p>Keyword arguments and dictionary values not found in the entity's
    definition are set as base entity properties.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Cell_Entity_Creation_From_BaseApp"></a>7.2.&nbsp;Cell Entity Creation From BaseApp</h2></div></div></div><p>The method
    <code class="classname">BigWorld</code>.<code class="methodname">createBaseAnywhere</code>
    creates only the base representation of the entity. If a cell entity is
    required, it is the base entity's duty to instantiate its associated cell
    entity.</p><p>To create the associated cell entity, the following methods are
    used:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="classname">Base</code>.<code class="methodname">createCellEntity</code></p></li><li><p><code class="classname">Base</code>.<code class="methodname">createInNewSpace</code></p></li><li><p><code class="classname">Base</code>.<code class="methodname">createInDefaultSpace</code></p></li></ul></div><p>These methods read the base entity's special variable
    <code class="classname">Base</code>.<code class="varname">cellData</code> (which is
    initialised with the cell entity's data when the base entity is created)
    to get the initialisation values for the cell entity. If the entity type
    does not support a cell entity, the base entity will not have
    <code class="varname">cellData</code>.</p><p>The variable <code class="varname">cellData</code> is behaves like a
    dictionary containing all cell properties defined in the entity's
    definition file
    (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>).</p><p>It also has three additional members:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="varname">position</code></em>
        <span class="symbol">&#8208;</span> Sequence of three <span class="type">float</span>s
        (x, y, z), or a <span class="type">Vector3</span> with position to create the new
        entity at.</p></li><li><p><em class="emphasis"><code class="varname">direction</code></em>
        <span class="symbol">&#8208;</span> Sequence of three <span class="type">float</span>s
        (roll, pitch and yaw) with direction for the new cell entity.</p></li><li><p><em class="emphasis"><code class="varname">spaceID</code></em>
        <span class="symbol">&#8208;</span> ID of the space for the cell entity
        to be created in, if space is not specified in a different way.</p></li></ul></div><p>Once the cell entity is successfully created, the following steps
    take place:</p><div class="orderedlist"><ol type="1"><li><p>The variable <code class="varname">cellData</code> is deleted.</p></li><li><p>A variable called <code class="varname">cell</code> is created, with the
        mailbox of the cell entity.</p></li><li><p>The callback
        <code class="classname">Base</code>.<code class="methodname">onGetCell</code> is
        invoked.</p></li></ol></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6011"></a>7.2.1.&nbsp;Creation Near an Existing Cell Entity</h3></div></div></div><p>The diagram below illustrates the creation of the cell entity
      using the method
      <code class="classname">Base</code>.<code class="methodname">createCellEntity</code> of
      the <code class="classname">BigWorld</code> module. This method cannot be used
      when the cell entity has already been created.</p><div class="informalfigure"><div class="mediaobject"><img src="images/creation_of_the_cell_entity.png"><span class="caption"><p>Creation of the cell entity using the method
          <code class="methodname">createCellEntity</code> of
          <code class="classname">BigWorld</code>.<code class="classname">Base</code>.</p></span></div></div><p>The declaration of method
      <code class="methodname">createCellEntity</code> in Python would look like
      this<sup>[<a name="d0e6046" href="#ftn.d0e6046">12</a>]</sup>:</p><pre class="programlisting">class Base:
  ...
  def createCellEntity( self, mailbox = None ):
    ...</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/Base.py</code>
      <span class="symbol">&#8208;</span> Declaration of method
      <code class="methodname">createCellEntity</code></span></p><p>The parameter <code class="varname">mailbox</code> is a cell entity mailbox.
      The new cell entity is created in the same space and cell as the mailbox
      references (if <code class="varname">mailbox</code> is not
      <span class="literal">None</span>). Ideally, the two entities are close, as this
      increases the likelihood of the entity starting on the correct
      cell.</p><p>The diagram below shows the flow of communications if the entity
      is created on the correct cell:</p><div class="informalfigure"><div class="mediaobject"><img src="images/flow_of_communication.png"><span class="caption"><p>Flow of communication when cell entity is created on
          correct cell.</p></span></div></div><p>The diagram below shows the flow of communications if the entity
      is created on an incorrect cell:</p><div class="informalfigure"><div class="mediaobject"><img src="images/flow_of_communicaton_when_cell_entity_is_created_on_the_wrong_cell.png"><span class="caption"><p>Flow of communication when cell entity is created on
          an incorrect cell.</p></span></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6099"></a>7.2.2.&nbsp;Creation in a Numbered Space</h3></div></div></div><p>It is also possible to create the cell entity by having an
      appropriate value for <code class="varname">spaceID</code> in the property
      <code class="varname">cellData</code>. This should be avoided, as it requires the
      request to go via the CellAppMgr, which can cause a bottleneck.</p><p>Once the cell entity has been created, the notification method
      <code class="methodname">onGetCell</code> is called on the base entity. This is
      the signal that it is now safe to start using the mailbox to the cell
      entity <code class="varname">self</code>.<code class="varname">cell</code>.</p><p>For entity <code class="varname">someEntity</code>, the method
      <code class="methodname">onGetCell</code> can be defined as illustrated
      below:</p><pre class="programlisting">import BigWorld

class <em class="emphasis">someEntity</em>( BigWorld.Base ):
  ...
  def <em class="emphasis">onGetCell</em>( self ):
    # this method was called, that means cell entity has been created.
  ...</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/someEntity.py</code>
      <span class="symbol">&#8208;</span> Definition of method
      <code class="classname">onGetCell</code></span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6149"></a>7.2.3.&nbsp;Creation in a New Space</h3></div></div></div><p>The method
      <code class="classname">Base</code>.<code class="methodname">createInNewSpace</code>
      dispatches a request to the CellAppMgr to create a new space, and the
      entity on it.</p><p>The resulting message trace is illustrated below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/flow_of_communication_when_creating_cell_entity_on_a_new_space.png"><span class="caption"><p>Flow of communication when creating cell entity on a
          new space.</p></span></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6169"></a>7.2.4.&nbsp;Creation in Default Space</h3></div></div></div><p>The method
      <code class="classname">Base</code>.<code class="methodname">createInDefaultSpace</code>
      is similar to method
      <code class="classname">Base</code>.<code class="methodname">createInNewSpace</code>,
      except that a new space is not created.</p><p>This is only available if flag
      <code class="property">&lt;useDefaultSpace&gt;</code> is set to
      <span class="literal">true</span> in the configuration file
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/server/bw.xml</code>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6199"></a>7.3.&nbsp;Entity Destruction</h2></div></div></div><p>The base entity is always created before the cell entity and is
    destroyed after it.</p><p>The sequence of events ensued by the destruction of a cell entity is
    described below:</p><div class="altrow"><table border="0"><colgroup><col width="12%"><col width="44%"><col width="44%"></colgroup><thead><tr><th align="left">Step</th><th align="left">Base</th><th align="left">Cell</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Calls method
              <code class="methodname">destroyCellEntity</code>.</td><td align="left">Calls method
              <code class="methodname">destroy</code>.</td></tr><tr><td align="left">2</td><td align="left">&nbsp;</td><td align="left">Has method
              <code class="methodname">onDestroy</code> automatically called.</td></tr><tr><td align="left">3</td><td align="left">Has method
              <code class="methodname">onLoseCell</code> automatically called. If
              base is to be destroyed, this is a good place to call method
              destroy.</td><td align="left">&nbsp;</td></tr><tr><td align="left">4</td><td align="left"><code class="varname">cell</code> property is
              lost<sup>[<a name="d0e6259" href="#ftn.d0e6259">a</a>]</sup>.</td><td align="left">&nbsp;</td></tr><tr><td align="left">5</td><td align="left"><code class="varname">cellData</code> property is
              restored, with values it had when destroyed<sup>[<a name="d0e6273" href="#ftn.d0e6273">b</a>]</sup>.</td><td align="left">&nbsp;</td></tr></tbody><tbody class="footnotes"><tr><td colspan="3"><div class="footnote"><p><sup>[<a name="ftn.d0e6259" href="#d0e6259">a</a>] </sup>For details on this property, see <a href="#xref_Cell_Entity_Creation_From_BaseApp" title="7.2.&nbsp;Cell Entity Creation From BaseApp">Cell Entity Creation From BaseApp</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e6273" href="#d0e6273">b</a>] </sup>For details on this property, see <a href="#xref_Cell_Entity_Creation_From_BaseApp" title="7.2.&nbsp;Cell Entity Creation From BaseApp">Cell Entity Creation From BaseApp</a>.</p></div></td></tr></tbody></table></div><p><span class="citetitle">Sequence of events during entity destruction
    on the cell.</span></p><p>The method
    <code class="classname">Base</code>.<code class="methodname">destroy</code> has two
    Boolean keyword arguments:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><em class="parameter"><code>deleteFromDB</code></em></em> <span class="symbol">&#8208;</span> The default value is
        <span class="literal">false</span>.</p></li><li><p><em class="emphasis"><em class="parameter"><code>writeToDB</code></em></em> <span class="symbol">&#8208;</span> The default value is <span class="literal">true</span>
        if the entity has previously been written to the database.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6315"></a>7.4.&nbsp;Entity Instantiation From The CellApp</h2></div></div></div><p>When creating a cell entity, it can be created either with its base
    counterpart or not. The following sub-sections describe both
    approaches.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6320"></a>7.4.1.&nbsp;Instantiation With No Base Counterpart</h3></div></div></div><p>The method
      <code class="classname">BigWorld</code>.<code class="methodname">createEntity</code>
      can be called to create a cell entity with no associated base
      entity.</p><p>This scenario is illustrated below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/creation_of_cell_entity_without_base_counterpart.png"><span class="caption"><p>Creation of cell entity without base
          counterpart.</p></span></div></div><p>The method
      <code class="classname">BigWorld</code>.<code class="methodname">createEntity</code>
      has the following signature:</p><pre class="programlisting">def createEntity( entityTypeName, spaceID, position, direction, properties ):</pre><p><span class="citetitle">Method
      <code class="classname">BigWorld</code>.<code class="methodname">createEntity</code>'s
      signature.</span></p><p>For details on the parameters for this method, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/cellapp/index.html#Client_Python_API" class="olink">Client Python API</a>'s entry <em class="emphasis">Main Page
      <span class="symbol">&#8594;</span> Cell <span class="symbol">&#8594;</span> BigWorld <span class="symbol">&#8594;</span> Function <span class="symbol">&#8594;</span>
      <span class="literal">createEntity</span></em>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6380"></a>7.4.2.&nbsp;Instantiation With Base Counterpart</h3></div></div></div><p>The method
      <code class="classname">BigWorld</code>.<code class="methodname">createEntityOnBase</code>
      allows the CellApp to create base entities. It has the following
      signature:</p><pre class="programlisting">def createEntityOnBaseApp( <em class="parameter"><code>entityTypeName</code></em>, <em class="parameter"><code>properties</code></em> ):</pre><p><span class="citetitle">Method
      <code class="classname">BigWorld</code>.<code class="methodname">createEntityOnBaseApp</code>'s
      signature</span></p><p>This function takes the following parameters:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><em class="parameter"><code>entityTypeName</code></em></em> <span class="symbol">&#8208;</span> Name of the entity type to create.</p></li><li><p><em class="emphasis"><em class="parameter"><code>properties</code></em></em> <span class="symbol">&#8208;</span> A dictionary of properties on the base as
          listed in the entity's definition file.</p></li></ul></div><p>This function dispatches a message to a BaseApp to create a base
      entity, which can later call method
      <code class="methodname">createCellEntity</code> to create the cell
      entity.</p><div class="informalfigure"><div class="mediaobject"><img src="images/creation_of_cell_entity_with_its_base_counterpart.png"><span class="caption"><p>Creation of cell entity with its base
          counterpart</p></span></div></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6441"></a>7.5.&nbsp;Loading Entities From Chunk Files</h2></div></div></div><p>WorldEditor can be used to insert entity placeholders into chunks.
    These placeholders can be read by Python script on the server to load
    these entities into the game world using the
    <code class="classname">BigWorld</code>.<code class="methodname">fetchEntitiesFromChunks</code>
    method on BaseApps.</p><p>The following example code is taken from
    <code class="filename">fantasydemo/res/scripts/base/TeleportPoint.py</code>:</p><pre class="programlisting">class TeleportPoint( BigWorld.Base ):
  ...
  BigWorld.fetchEntitiesFromChunks( self.geometry, EntityLoader( self ) )
                                                                                
class EntityLoader:
  def __init__( self, dstEntity ):
    self.dstEntity = dstEntity
                                                                                
  def onSection( self, entityDataSection, matrix ):
    e = BigWorld.createEntity( 
      entityDataSection.readString( "type" ),
      entityDataSection[ "properties" ],
      createOnCell = self.dstEntity.cell,
      position = matrix.applyToOrigin(),
      direction = (matrix.roll, matrix.pitch, matrix.yaw))</pre><p><span class="citetitle"><span class="literal">fantasydemo/res/scripts/base/TeleportPoint.py</span></span></p><p>The
    <code class="classname">BigWorld</code>.<code class="methodname">fetchEntitiesFromChunks</code>
    method causes all chunks in the space to be loaded in a loading thread.
    Each <code class="property">&lt;entity&gt;</code> data section in the loaded chunks
    causes the method <code class="methodname">onSection</code> to be called on the
    handler object. This method can then use the data section to create an
    appropriate entity.</p><p>For more details on loading data section information in a
    thread-safe way, see both the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../howto_avoid_file_in_main_thread/howto_avoid_file_in_main_thread.html#HowTo_Avoid_File_In_Main_Thread" class="olink">How To Avoid Files Being Loaded in the Main Thread</a> and the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/baseapp/index.html#Client_Python_API" class="olink">Client Python API</a>'s entries <em class="emphasis">Main Page
    <span class="symbol">&#8594;</span> Base <span class="symbol">&#8594;</span> BigWorld <span class="symbol">&#8594;</span> Function <span class="symbol">&#8594;</span>
    <span class="literal">BigWorld.fetchDataSection</span></em>, <em class="emphasis"><span class="literal">BigWorld.fetchEntitiesFromChunks</span></em>,
    and <em class="emphasis"><span class="literal">BigWorld.fetchFromChunks</span></em>.</p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e5788" href="#d0e5788">11</a>] </sup><code class="classname">BigWorld</code>.<code class="methodname">createBaseAnywhere</code>
            is the recommended method of creating an instance of a base entity
            as it allows BaseAppMgr to select the least loaded BaseApp to be
            created on.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e6046" href="#d0e6046">12</a>] </sup>The method <code class="methodname">createCellEntity</code> is
          implemented in C++ <span class="symbol">&#8208;</span> the example
          declares it in Python just for explanation purposes.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_The_Database_Layer"></a>Chapter&nbsp;8.&nbsp;The Database Layer</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e6520">8.1. Persistent Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Non_Persistent_Properties">8.1.1. Non-Persistent Properties</a></span></dt><dt><span class="section"><a href="#xref_Built_In_Properties">8.1.2. Built-In Properties</a></span></dt><dt><span class="section"><a href="#xref_The_Identifier_Tag">8.1.3. The Identifier Tag</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Reading_And_Writing_Entities">8.2. Reading and Writing Entities</a></span></dt><dt><span class="section"><a href="#xref_Mapping_BigWorld_Properties_Into_SQL">8.3. Mapping BigWorld Properties Into SQL</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6998">8.3.1. Entity Tables</a></span></dt><dt><span class="section"><a href="#d0e7024">8.3.2. The <code class="varname">databaseID</code> property</a></span></dt><dt><span class="section"><a href="#d0e7038">8.3.3. Simple Data Types</a></span></dt><dt><span class="section"><a href="#d0e7135">8.3.4. <span class="type">VECTOR</span> Data Types</a></span></dt><dt><span class="section"><a href="#xref_STRING_UNICODE_STRING_BLOB_and_data_types">8.3.5. <span class="type">STRING</span>, <span class="type">UNICODE_STRING</span>,
      <span class="type">BLOB</span>, and <span class="type">PYTHON</span> Data Types</a></span></dt><dt><span class="section"><a href="#d0e7477">8.3.6. <span class="type">PATROL_PATH</span> and <span class="type">UDO_REF</span> Data
      Types</a></span></dt><dt><span class="section"><a href="#d0e7514">8.3.7. <span class="type">ARRAY</span>s and <span class="type">TUPLE</span>s</a></span></dt><dt><span class="section"><a href="#xref_FIXED_DICTs">8.3.8. <span class="type">FIXED_DICT</span>s</a></span></dt><dt><span class="section"><a href="#d0e7845">8.3.9. <span class="type">USER_TYPE</span>s</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8523">8.4. Execute Arbitrary Commands on Database</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8536">8.4.1. Execute Commands on SQL Database</a></span></dt><dt><span class="section"><a href="#d0e8622">8.4.2. Execute Commands on XML Database</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Secondary_Databases">8.5. Secondary Databases</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Data_Consolidation">8.5.1. Data Consolidation</a></span></dt><dt><span class="section"><a href="#xref_Database_Snapshot">8.5.2. Database Snapshot</a></span></dt></dl></dd></dl></div><p>The database layer is BigWorld's persistent storehouse of entities. It
  allows writing specific entities into online storage (usually into a
  database table or disk file), and retrieving them back into the world again
  later.</p><p>The database layer is not intended to be accessed frequently by each
  entity, but instead only at entity creation and destruction times (and
  perhaps at critical trade points). You should not attempt to access the
  database in response to every action a character performs <span class="symbol">&#8208;</span> let the disaster recovery mechanisms handle game
  integrity.</p><p>This chapter provides details on how to store and retrieve entities
  from the database.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6520"></a>8.1.&nbsp;Persistent Properties</h2></div></div></div><p>The first step to make an entity persistent is to edit its
    definition file (named
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>)
    and specify the properties to be made persistent.</p><p>The persistent set of properties is often a small subset of the
    entity properties. For example, a role playing game typically has a set of
    core attributes (strength, dexterity, etc...), and a set of derived
    attributes that need to be modified transiently (maybe the character
    always gets full vitality when logging on, and so vitality points need not
    be persisted).</p><p>To mark an entity property as persistent, it needs the tag
    <code class="property">&lt;Persistent&gt;</code> added to it, as illustrated
    below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;Properties&gt;
    ...
    &lt;<em class="emphasis"><em class="replaceable"><code>somePersistentProperty</code></em></em>&gt;
      &lt;Type&gt;       TYPENAME &lt;/Type&gt;
      &lt;Flags&gt;      FLAGS    &lt;/Flags&gt;
      &lt;<em class="emphasis">Persistent</em>&gt; <em class="emphasis">true</em>     &lt;/Persistent&gt;
    &lt;/<em class="replaceable"><code>somePersistentProperty</code></em>&gt;
    ...
  &lt;/Properties&gt; 
  ...
&lt;/root&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
    <span class="symbol">&#8208;</span> Marking a property as
    persistent</span></p><p>If the type is <span class="type">FIXED_DICT</span>, then the
    <code class="property">&lt;Persistent&gt;</code> tag can be specified for each
    property of the <span class="type">FIXED_DICT</span> data type.</p><p>For example:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;Properties&gt;
    ...
    &lt;<em class="emphasis"><em class="replaceable"><code>someFixedDictProperty</code></em></em>&gt;
      &lt;Type&gt;    FIXED_DICT
        &lt;Properties&gt;
          &lt;a&gt; &lt;Type&gt; TYPENAME &lt;/Type&gt; &lt;/a&gt;
          &lt;b&gt; 
            &lt;Type&gt; TYPENAME &lt;/Type&gt;
            &lt;<em class="emphasis">Persistent</em>&gt; <em class="emphasis">false</em> &lt;/Persistent&gt;
          &lt;/b&gt;
        &lt;/Properties&gt;
      &lt;/Type&gt;
      &lt;Flags&gt;    FLAGS      &lt;/Flags&gt;
      &lt;<em class="emphasis">Persistent</em>&gt;  <em class="emphasis">true</em>    &lt;/Persistent&gt;  
    &lt;/<em class="replaceable"><code>somePersistentProperty</code></em>&gt;
    ...
  &lt;/Properties&gt;
  ...
&lt;/root&gt;</pre><p>In the above example,
    <code class="classname">someFixedDictProperty</code>.<code class="varname">a</code> is
    persistent, but
    <code class="classname">someFixedDictProperty</code>.<code class="varname">b</code> is not.
    If the <code class="property">&lt;Persistent&gt;</code> tag at the
    <code class="property">&lt;someFixedDictProperty&gt;</code> level is
    <span class="literal">false</span>, then neither <code class="varname">a</code> nor
    <code class="varname">b</code> will be persistent. By default, the
    <code class="property">&lt;Persistent&gt;</code> tag at the <span class="type">FIXED_DICT</span>
    field level is <span class="literal">true</span>, so it is not necessary to specify
    it, except for selectively turning off the persistence of some
    fields.</p><p>Other parameters can be set for persistent properties for the MySQL
    database engine. For more details, see <a href="#xref_Mapping_BigWorld_Properties_Into_SQL" title="8.3.&nbsp;Mapping BigWorld Properties Into SQL">Mapping BigWorld Properties Into SQL</a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Non_Persistent_Properties"></a>8.1.1.&nbsp;Non-Persistent Properties</h3></div></div></div><p>Properties that are reset each time the entity is created should
      not be made persistent. For example, entity's A.I. and GUI states are
      usually non-persistent. Reducing the number of persistent properties
      will reduce the load on the database. If a property is not persistent,
      its value will be set to its default value when the entity is loaded
      from the database (see <a href="#xref_Reading_And_Writing_Entities" title="8.2.&nbsp;Reading and Writing Entities">Reading and Writing Entities</a>).</p><p>A <span class="type">MAILBOX</span> property is always non-persistent.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Built_In_Properties"></a>8.1.2.&nbsp;Built-In Properties</h3></div></div></div><p>The following built-in properties are persistent: </p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Base</em> :
            <code class="varname">databaseID</code> .</p></li><li><p><em class="emphasis">Cell</em> :
            <code class="varname">position</code> , <code class="varname">direction</code> and
            <code class="varname">spaceID</code> .</p></li></ul></div><p>All other built-in properties are non-persistent.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The entity's built-in <code class="varname">id</code> property is not
        persistent. It will change each time the entity is re-created. This
        includes the case where the entity is re-created automatically by the
        disaster recovery mechanism (see <a href="#xref_Disaster_Recovery" title="Chapter&nbsp;16.&nbsp;Disaster Recovery"><i xmlns:xlink="http://www.w3.org/1999/xlink">Disaster Recovery</i></a>). Therefore, when storing entity
        IDs of other entities, they should be stored in non-persistent
        properties so that they will be automatically reset to the properties'
        default value when the entity is re-created by the disaster recovery
        mechanism. This avoids the possibility of storing invalid entity
        IDs.</p><p>The entity's <code class="varname">id</code> property is unchanged when
        the entity is restored by our fault tolerance mechanism (see <a href="#xref_Fault_Tolerance" title="Chapter&nbsp;15.&nbsp;Fault Tolerance"><i xmlns:xlink="http://www.w3.org/1999/xlink">Fault Tolerance</i></a>).</p><p>Use the entity's database ID for a long term reference to the
        entity.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_The_Identifier_Tag"></a>8.1.3.&nbsp;The Identifier Tag</h3></div></div></div><p>The <code class="property">&lt;Identifier&gt;</code> tag is an optional tag
      for persistent <span class="type">STRING</span> or <span class="type">BLOB</span> entity
      properties. It specifies a property to be the identifier for that entity
      type. Entities can be retrieved from the database by using their
      identifier instead of their database ID. For this reason, all entities
      of the same type must have unique identifiers. At most one property per
      entity can be tagged as an identifier.</p><p>For example, assuming the entity definition file below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;Properties&gt;
    ...
    &lt;playerNickname&gt; 
      &lt;Type&gt;       STRING &lt;/Type&gt;
      &lt;Flags&gt;      Flags  &lt;/Flags&gt;
      &lt;Persistent&gt; true   &lt;/Persistent&gt;
      &lt;<em class="emphasis">Identifier</em>&gt; <em class="emphasis">true</em>   &lt;/Identifier&gt;
    &lt;/playerNickname&gt;

    &lt;someProperty1&gt; 
      &lt;Type&gt;       UINT32 &lt;/Type&gt;
    &lt;/someProperty1&gt;

    &lt;someProperty2&gt; 
      &lt;Type&gt;       STRING &lt;/Type&gt;
      &lt;Persistent&gt; true   &lt;/Persistent&gt;
    &lt;someProperty2&gt;
    ...</pre><p><span class="citetitle">Example
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
      <span class="symbol">&#8208;</span> Setting the Identifier
      property</span></p><p>Then assuming that there are three instances of the above entity
      type, they could be represented like in the table below:</p><div class="altrow"><a name="d0e6743"></a><p class="title"><b>Table&nbsp;8.1.&nbsp;Entity data with its <code class="property">&lt;Identifier&gt;</code>
        property.</b></p><div class="altrow-contents"><table summary="Entity data with its <Identifier&gt;&#xA;        property." border="0" width="40%"><colgroup><col width="60%"><col width="40%"></colgroup><thead><tr><th align="left">playerNickname</th><th align="left">someProperty2</th></tr></thead><tbody><tr><td align="left"><code class="varname">playerNickname1</code></td><td align="left">"cfeh"</td></tr><tr><td align="left"><code class="varname">playerNickname2</code></td><td align="left">"fwep"</td></tr><tr><td align="left"><code class="varname">playerNickname3</code></td><td align="left">"fwep"</td></tr></tbody></table></div></div><br class="altrow-break"><p>Note that <code class="property">&lt;someProperty1&gt;</code> is not
      represented in the database because it is not specified as being
      persistent.</p><p>Entity types with an <code class="property">&lt;Identifier&gt;</code>
      property can be searched by name, using methods such as
      <code class="classname">BigWorld</code>.<code class="methodname">lookUpBaseByName</code>
      and
      <code class="classname">BigWorld</code>.<code class="methodname">createBaseFromDB</code>.
      For details, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/baseapp/index.html#Client_Python_API" class="olink">Client Python API</a>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Reading_And_Writing_Entities"></a>8.2.&nbsp;Reading and Writing Entities</h2></div></div></div><p>The database provides the means of saving entities and bringing them
    back into the world at a later time. It also guarantees that each saved
    entity can have only one instance within the world. This assures that any
    writes to the database for the entity will be correctly carried
    out.</p><p>In order to use this functionality, you must first create a
    persistent entity. Such an entity must exist on a BaseApp, and could be of
    type <code class="classname">BigWorld</code>.<code class="classname">Base</code> or
    <code class="classname">BigWorld</code>.<code class="classname">Proxy</code>. You can
    create it with any of the normal techniques. For more details, see <a href="#xref_Entity_Instantiation_On_The_BaseApp" title="7.1.&nbsp;Entity Instantiation on the BaseApp">Entity Instantiation on the BaseApp</a>.</p><p>The key for persisting an entity is its property
    <code class="varname">databaseID</code>, combined with its entity type. The property
    <code class="varname">databaseID</code> is a 64-bit integer that is unique among
    entities of the same type, and usually corresponds to an auto-increment
    field in a database table. When an entity is created with any of the usual
    techniques, its <code class="varname">databaseID</code> is set to 0, indicating that
    it has never been written to the database.</p><p>To add a newly created entity to the database, its method
    <code class="methodname">writeToDB</code> has to be invoked (from either cell or
    base).</p><p>If invoked on the base entity, <code class="methodname">writeToDB</code>
    receives an optional argument specifying the callback method. Upon
    completion, <code class="methodname">writeToDB</code> will invoke the callback,
    passing a Boolean argument indicating if writing to the database succeeded
    or failed, and the base entity that invoked the method. A notification
    method is used, as the database write is an asynchronous operation.</p><p>The code fragments below illustrate the use of method
    <code class="methodname">writeToDB</code> from the base.</p><div class="orderedlist"><ol type="1"><li><p>In <code class="classname">someEntity</code>'s base script
        (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/someEntity.py</code>),
        define callback method for <code class="methodname">writeToDB</code>:</p><pre class="programlisting">import BigWorld

class <em class="emphasis">someEntity</em>( BigWorld.Base )
  ...
  def <em class="emphasis">onWriteToDBComplete</em>( successful, entity ):
    if successful:
      print "write %i OK. databaseID = %i" % (entity.id, databaseID)
    else:
      print "write %i was not successful" % entity.id
  ...</pre></li><li><p>Invoke methods to create base and add it to database:</p><pre class="programlisting">ent = BigWorld.createBase( <em class="emphasis">"someEntity"</em> )
ent.<em class="emphasis">writeToDB</em>( <em class="emphasis">onWriteToDBComplete</em> )</pre></li><li><p>The result displayed in BaseApp:</p><pre class="programlisting">write 92 OK. databaseID = 376182</pre></li></ol></div><p>Next time this entity is destroyed (by invoking method
    <code class="varname">ent</code>.<code class="methodname">destroy</code>), it will be
    'logged off' <span class="symbol">&#8208;</span> the database layer keeps
    track of whether the entity is in the world.</p><p>A destroyed entity can later be brought back to the world using the
    method
    <code class="classname">BigWorld</code>.<code class="methodname">createBaseFromDBID</code>
    and the properties stored in the database, as illustrated below:</p><pre class="programlisting">BigWorld.<em class="emphasis">createBaseFromDBID</em>( "someEntity", 376182, optionalCallbackMethod )</pre><p>Since loading a destroyed entity from the database is also an
    asynchronous operation, if you wish to be notified of the completion of
    this process, you need to pass a callback function as the third argument
    of method
    <code class="classname">BigWorld</code>.<code class="methodname">createBaseFromDBID</code>.
    The callback function receives the entity identifier as the only argument,
    which is the <code class="varname">databaseID</code> if entity was successfully
    loaded, or <span class="literal">None</span>, otherwise.</p><p>The code fragments below illustrate the request to reload entities
    from the database:</p><div class="orderedlist"><ol type="1"><li><p>In <code class="classname">someEntity</code>'s base script
        (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/someEntity.py</code>),
        define callback method for
        <code class="methodname">createBaseFromDBID</code>:</p><pre class="programlisting">import BigWorld

def <em class="emphasis">onComplete</em>( entity ):
  if entity is not None:
    print "entity successfully created" 
  else:
    print "entity was not created" </pre></li><li><p>Call <code class="methodname">createBaseFromDBID</code> with a valid
        <code class="varname">databaseID</code>:</p><pre class="programlisting">BigWorld.<em class="emphasis">createBaseFromDBID</em>( "someEntity", 376182, onComplete )</pre></li><li><p>The result displayed in BaseApp:</p><pre class="programlisting">entity successfully created</pre></li><li><p>Call <code class="methodname">createBaseFromDBID</code> with an invalid
        <code class="varname">databaseID</code>:</p><pre class="programlisting">BigWorld.<em class="emphasis">createBaseFromDBID</em>( "someEntity", 10000000000, onComplete )</pre></li><li><p>The result displayed in BaseApp:</p><pre class="programlisting">entity was not created</pre></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Mapping_BigWorld_Properties_Into_SQL"></a>8.3.&nbsp;Mapping BigWorld Properties Into SQL</h2></div></div></div><p>When designing persistent properties, it is useful to understand how
    the mapping from BigWorld types to SQL types is performed by the database
    layer. This information can be used for performance tuning, or in manually
    modifying the database.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6998"></a>8.3.1.&nbsp;Entity Tables</h3></div></div></div><p>Each entity type will have a main entity table, and zero or more
      sub-tables in the database.</p><p>An entity type's main table is named
      <span class="literal">tbl_<em class="replaceable"><code>&lt;entity_type_name&gt;</code></em></span>.
      Data for the majority of BigWorld types will be stored in the columns of
      the main table. Types like <span class="type">ARRAY</span> and <span class="type">TUPLE</span>,
      however, require the use of additional tables, referred to as sub-tables
      in this document.</p><p>Except for <span class="type">ARRAY</span> and <span class="type">TUPLE</span> properties,
      data for each entity is stored as a single row in the entity type's main
      table.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7024"></a>8.3.2.&nbsp;The <code class="varname">databaseID</code> property</h3></div></div></div><p>The <code class="varname">databaseID</code> property of an entity is stored
      in the id column in the main table <span class="symbol">&#8208;</span> this
      is why entities without persistent properties still have a main entity
      table.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7038"></a>8.3.3.&nbsp;Simple Data Types</h3></div></div></div><p>A property with a simple data type is mapped to a single SQL
      column (named
      <span class="literal">sm_<em class="replaceable"><code>&lt;property_name&gt;</code></em></span>)
      with a type that accommodates.</p><p>The table below describes each BigWorld simple data type, and
      which MySQL type it is mapped to:</p><div class="altrow"><a name="d0e7050"></a><p class="title"><b>Table&nbsp;8.2.&nbsp;Mapping of simple BigWorld data types to SQL.</b></p><div class="altrow-contents"><table summary="Mapping of simple BigWorld data types to SQL." border="0" width="50%"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th align="left">BigWorld data type</th><th align="left">Mapped to MySQL type (column
              sm_&lt;property_type&gt;)</th></tr></thead><tbody><tr><td align="left"><span class="type">INT8</span></td><td align="left"><span class="type">TINYINT</span></td></tr><tr><td align="left"><span class="type">UINT8</span></td><td align="left"><span class="type">TINYINT UNSIGNED</span></td></tr><tr><td align="left"><span class="type">INT16</span></td><td align="left"><span class="type">SMALLINT</span></td></tr><tr><td align="left"><span class="type">UINT16</span></td><td align="left"><span class="type">SMALLINT UNSIGNED</span></td></tr><tr><td align="left"><span class="type">INT32</span></td><td align="left"><span class="type">INT</span></td></tr><tr><td align="left"><span class="type">UINT32</span></td><td align="left"><span class="type">INT UNSIGNED</span></td></tr><tr><td align="left"><span class="type">INT64</span></td><td align="left"><span class="type">BIGINT</span></td></tr><tr><td align="left"><span class="type">UINT64</span></td><td align="left"><span class="type">BIGINT UNSIGNED</span></td></tr><tr><td align="left"><span class="type">FLOAT32</span></td><td align="left"><span class="type">FLOAT</span></td></tr><tr><td align="left"><span class="type">FLOAT64</span></td><td align="left"><span class="type">DOUBLE</span></td></tr></tbody></table></div></div><br class="altrow-break"></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7135"></a>8.3.4.&nbsp;<span class="type">VECTOR</span> Data Types</h3></div></div></div><p>Properties with vector types are mapped to the appropriate number
      of columns of MySQL type <span class="type">FLOAT</span> <span class="symbol">&#8208;</span> named
      <span class="literal">vm_<em class="replaceable"><code>&lt;index&gt;</code></em>_<em class="replaceable"><code>&lt;property_name&gt;</code></em></span>,
      where <span class="literal"><em class="replaceable"><code>&lt;index&gt;</code></em></span> is a
      number from 0 to the size of the vector minus 1.</p><p>The list below describes each BigWorld <span class="type">VECTOR</span> data
      type, and which MySQL type it is mapped to:</p><div class="altrow"><a name="d0e7165"></a><p class="title"><b>Table&nbsp;8.3.&nbsp;Mapping of BigWorld <span class="type">VECTOR</span> data types to
        MySQL.</b></p><div class="altrow-contents"><table summary="Mapping of BigWorld VECTOR data types to&#xA;        MySQL." border="0" width="60%"><colgroup><col width="25%"><col width="25%"><col width="50%"></colgroup><thead><tr><th align="left">BigWorld data type</th><th align="left"># of columns</th><th align="left">Mapped to MySQL type (column
              vm_&lt;index&gt;_&lt;property_name&gt;)</th></tr></thead><tbody><tr><td align="left"><span class="type">VECTOR2</span></td><td align="left"><span class="literal">2</span></td><td align="left"><span class="type">FLOAT</span></td></tr><tr><td align="left"><span class="type">VECTOR3</span></td><td align="left"><span class="literal">3</span></td><td align="left"><span class="type">FLOAT</span></td></tr><tr><td align="left"><span class="type">VECTOR4</span></td><td align="left"><span class="literal">4</span></td><td align="left"><span class="type">FLOAT</span></td></tr></tbody></table></div></div><br class="altrow-break"></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_STRING_UNICODE_STRING_BLOB_and_data_types"></a>8.3.5.&nbsp;<span class="type">STRING</span>, <span class="type">UNICODE_STRING</span>,
      <span class="type">BLOB</span>, and <span class="type">PYTHON</span> Data Types</h3></div></div></div><p>Properties of types <span class="type">STRING</span>,
      <span class="type">UNICODE_STRING</span>, <span class="type">BLOB</span>, and <span class="type">PYTHON</span>
      will be mapped to column
      <span class="literal">sm_<em class="replaceable"><code>&lt;property_name&gt;</code></em></span>,
      with the type being dependent on the
      <code class="property">&lt;DatabaseLength&gt;</code> attribute of the property
      specified in the entity definition file (for details, see <a href="#xref_The_Definition_File" title="2.2.&nbsp;The Entity Definition File">The Entity Definition File</a>, and <a href="#xref_Properties" title="Chapter&nbsp;4.&nbsp;Properties"><i xmlns:xlink="http://www.w3.org/1999/xlink">Properties</i></a>), as it determines the width of the column
      when the type is mapped to SQL.</p><p>The list below summarises the mapping of <span class="type">STRING</span>,
      <span class="type">UNICODE_STRING</span>, <span class="type">BLOB</span>, and <span class="type">PYTHON</span>
      data types:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">PYTHON</span></em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">DatabaseLength</span>
              &lt; 256 </em><span class="symbol">&#8208;</span>
              <span class="literal">TINYBLOB</span></p></li><li><p><em class="emphasis"><span class="literal">DatabaseLength</span>
              &gt;= 256 and &lt; 65536</em> <span class="symbol">&#8208;</span> <span class="literal">BLOB</span></p></li><li><p><em class="emphasis"><span class="literal">DatabaseLength</span>
              &gt;= 65536 and &lt; 16777215</em> <span class="symbol">&#8208;</span> <span class="literal">MEDIUMBLOB</span></p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">STRING</span></em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">DatabaseLength</span>
              &lt; 256</em> <span class="symbol">&#8208;</span>
              <span class="literal">VARBINARY</span></p></li><li><p><em class="emphasis"><span class="literal">DatabaseLength</span>
              &gt;= 256 and &lt; 65536</em> <span class="symbol">&#8208;</span> <span class="literal">BLOB</span></p></li><li><p><em class="emphasis"><span class="literal">DatabaseLength</span>
              &gt;= 65536 and &lt; 16777215</em> <span class="symbol">&#8208;</span> <span class="literal">MEDIUMBLOB</span></p></li><li><p><em class="emphasis"><span class="literal">DatabaseLength</span>
              &gt;= 16777216</em> <span class="symbol">&#8208;</span>
              <span class="literal">LONGBLOB</span></p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">UNICODE_STRING</span></em></p><p>The <span class="type">UNICODE_STRING</span> type maps to the MySQL string
          types outlined below. The character encoding used for storing these
          strings in the database is determined by the value of the
          <code class="filename">bw.xml</code> option
          <span class="literal">dbMgr/unicodeString/characterSet</span><sup>[<a name="d0e7381" href="#ftn.d0e7381">13</a>]</sup>. For more details on the
          <span class="literal">UNICODE_STRING</span> and the issues involved when
          dealing with character sets, please refer to the chapter <a href="#xref_Character_Set_Encodings" title="Chapter&nbsp;9.&nbsp;Character Sets and Encodings"><i xmlns:xlink="http://www.w3.org/1999/xlink">Character Sets and Encodings</i></a>. The
          <span class="literal">UNICODE_STRING</span> type has similar storage
          requirements to the <span class="type">STRING</span> type as shown below:</p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">(DatabaseLength</span> x
              3) &lt; 256</em> <span class="symbol">&#8208;</span>
              <span class="literal">VARCHAR</span></p></li><li><p><em class="emphasis"><span class="literal">(DatabaseLength</span> x
              3) &gt;= 256 and &lt; 65536</em> <span class="symbol">&#8208;</span> <span class="literal">TEXT</span></p></li><li><p><em class="emphasis"><span class="literal">(DatabaseLength</span> x
              3) &gt;= 65536 and &lt; 16777215</em> <span class="symbol">&#8208;</span> <span class="literal">MEDIUMTEXT</span></p></li><li><p><em class="emphasis"><span class="literal">DatabaseLength</span>
              &gt;= 16777216</em> <span class="symbol">&#8208;</span>
              <span class="literal">LONGTEXT</span></p></li></ul></div></li></ul></div><p>The definition of <code class="property">&lt;DatabaseLength&gt;</code> is
      illustrated below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;Properties&gt;
    ...
    &lt;someProperty&gt;
      &lt;Type&gt;            STRING  &lt;/Type&gt;
      &lt;Persistent&gt;      true    &lt;/Persistent&gt;
      &lt;<em class="emphasis">DatabaseLength</em>&gt;  <em class="emphasis">16</em>      &lt;/DatabaseLength&gt;
    &lt;/someProperty&gt;
    ...</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
      <span class="symbol">&#8208;</span> Defining property's mapped SQL
      type</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7477"></a>8.3.6.&nbsp;<span class="type">PATROL_PATH</span> and <span class="type">UDO_REF</span> Data
      Types</h3></div></div></div><p>The <span class="type">PATROL_PATH</span> type has been deprecated in favor of
      the use of User Data Objects and should be avoided as they will be
      removed in a future release. The <code class="property">&lt;PatrolNode&gt;</code>
      User Data Object replaces the station nodes of the old system.</p><p>Properties with <span class="type">UDO_REF</span> type are mapped to a column
      of type <span class="type">BINARY</span>, named
      <span class="literal">sm_<em class="replaceable"><code>&lt;property_name&gt;</code></em></span>.
      The column width is 16 bytes, which corresponds to the 128-bit GUID that
      identifies a Patrol Path or User Data Object type.</p><p>The 128-bit GUID is stored in the column as four groups of 32-bit
      unsigned integers. Each integer is in little endian order. For example,
      if the GUID is <span class="literal">00112233.44556677.8899AABB.CCDDEEFF</span>,
      then the byte values in the column will be
      <span class="literal">3322110077665544BBAA9988FFEEDDCC</span>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7514"></a>8.3.7.&nbsp;<span class="type">ARRAY</span>s and <span class="type">TUPLE</span>s</h3></div></div></div><p>Each <span class="type">ARRAY</span> or <span class="type">TUPLE</span> property is mapped
      to an SQL table, referred to as sub-tables of the entity's main table,
      and named
      <span class="literal"><em class="replaceable"><code>&lt;parent_table_name&gt;</code></em>_<em class="replaceable"><code>&lt;property_name&gt;</code></em></span>.</p><p><span class="literal"><em class="replaceable"><code>&lt;parent_table_name&gt;</code></em></span>
      is the name of the entity type's main table, unless the
      <span class="type">ARRAY</span> or <span class="type">TUPLE</span> is nested in another
      <span class="type">ARRAY</span> or <span class="type">TUPLE</span> property, in which case
      <span class="literal"><em class="replaceable"><code>&lt;parent_table_name&gt;</code></em></span>
      is the name of the parent <span class="type">ARRAY</span>'s or <span class="type">TUPLE</span>'s
      table.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Although BigWorld does not impose a limit on nesting
        <span class="type">ARRAY</span> or <span class="type">TUPLE</span> types, MySQL has a limit of
        64 characters on table names.</p><p>As sub-table names are always prefixed with their parent table
        name, this effectively limits the nesting depth.</p></div><p><span class="type">ARRAY</span> or <span class="type">TUPLE</span> sub-tables have a
      <span class="literal">parentID</span> column that stores the id of the row in the
      parent table associated with the data. The sub-table will also have an
      id column to maintain the order of the elements, as well as to provide a
      row identifier in case there are sub-tables of this sub-table.</p><p>The other columns of the sub-table will be determined by the
      <span class="type">ARRAY</span>'s or <span class="type">TUPLE</span>'s element type
      (<em class="emphasis">e.g.</em>, an <span class="literal">ARRAY &lt;of&gt; INT8
      &lt;/of&gt;</span> will result in one additional column of type
      <span class="type">TINYINT</span>). Most BigWorld types only require one additional
      column, which will be called <span class="literal">sm_value</span>. For details on
      how an <span class="type">ARRAY</span> or <span class="type">TUPLE</span> of
      <span class="type">FIXED_DICT</span> is mapped into the database, see <a href="#xref_FIXED_DICTs" title="8.3.8.&nbsp;FIXED_DICTs"><span class="type">FIXED_DICT</span>s</a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Storing_Arrays_And_Tuples_As_Blob"></a>8.3.7.1.&nbsp;Storing ARRAYs and TUPLEs as a BLOB</h4></div></div></div><p>Instead of storing ARRAY and TUPLE data in a separate tables,
        each ARRAY or TUPLE can be configured to stored their data in an
        internal binary format inside a MEDIUMBLOB column. This behaviour is
        controlled by the <code class="property">&lt;persistAsBlob&gt;</code>
        option:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;Properties&gt;
    ...
    &lt;someProperty&gt;
      &lt;Type&gt; 
        ARRAY &lt;of&gt; INT32 &lt;/of&gt; 
        <em class="emphasis">&lt;persistAsBlob&gt; true &lt;/persistAsBlob&gt;</em>
      &lt;/Type&gt;
    &lt;/someProperty&gt;</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>
        <span class="symbol">&#8208;</span> Storing an ARRAY property as a
        blob</span></p><p><code class="property">&lt;persistAsBlob&gt;</code> is
        <span class="literal">false</span> by default.</p><p>Storing the data as a blob can improve database performance
        significantly, especially for deeply nested arrays. However, the
        binary data is in BigWorld's internal format and should not be
        modified directly using SQL statements. The data should only be
        modified by loading the entity into BigWorld, modifying the data in
        Python and then writing the entity back to the database.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>There is currently no way of migrating the ARRAY or TUPLE data
          from separate tables into the MEDIUMBLOB binary format or vice
          versa. When switching <code class="property">&lt;persistAsBlob&gt;</code>
          between <span class="literal">true</span> and <span class="literal">false</span>, the
          data in the database associated with the ARRAY or TUPLE will be
          lost. Therefore, the &lt;persistAsBlob&gt; option should not be
          changed lightly.</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Changing the element type of the ARRAY or TUPLE will
          invalidate the data in the database. This will cause the entity
          which contains the ARRAY or TUPLE to fail to load. This problem
          exists even when changing between elements of similar types, for
          example from an <span class="literal">ARRAY &lt;of&gt; INT32
          &lt;/of&gt;</span> to an <span class="literal">ARRAY &lt;of&gt; INT16
          &lt;/of&gt;</span>. It is recommended that you:</p><div class="orderedlist"><ol type="1"><li><p>Set <code class="property">&lt;persistAsBlob&gt;</code> to
              <span class="literal">false</span>.</p></li><li><p>Run the sync_db tool. For more details, see Server
              Programming Guide's <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Initialise_Database_With_Entity_Definitions" class="olink">Synchronise Database With Entity Definitions</a>.</p></li><li><p>Change the ARRAY or TUPLE element type and set
              <code class="property">&lt;persistAsBlob&gt;</code> to
              <span class="literal">true</span>.</p></li><li><p>Run the sync_db tool again.</p></li></ol></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e7701"></a>8.3.7.2.&nbsp;The <code class="property">&lt;DatabaseLength&gt;</code>
        Attribute</h4></div></div></div><p>The <code class="property">&lt;DatabaseLength&gt;</code> attribute of an
        <span class="type">ARRAY</span> or <span class="type">TUPLE</span> property is applied to the
        element type of the array if the element type is <span class="type">STRING</span>,
        <span class="type">BLOB</span> or <span class="type">PYTHON</span>.</p><p>Other types either disregard the
        <code class="property">&lt;DatabaseLength&gt;</code> modifier or, as in the
        case of <span class="type">FIXED_DICT</span>, have their own method of specifying
        the <code class="property">&lt;DatabaseLength&gt;</code>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_FIXED_DICTs"></a>8.3.8.&nbsp;<span class="type">FIXED_DICT</span>s</h3></div></div></div><p>If an entity type contains a <span class="type">FIXED_DICT</span> property,
      then that property's fields are mapped to the database as though they
      where properties of the entity.</p><p><span class="type">FIXED_DICT</span> columns have more elaborate names than
      non-<span class="type">FIXED_DICT</span> columns:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="literal">sm_<em class="replaceable"><code>&lt;property_name&gt;</code></em>_<em class="replaceable"><code>&lt;field_name&gt;</code></em></span></p></li></ul></div><p>If the <span class="type">FIXED_DICT</span> property contains an
      <span class="type">ARRAY</span> or <span class="type">TUPLE</span> field then the name of the
      sub-table is correspondingly more elaborate:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="literal"><em class="replaceable"><code>&lt;parent_table_name&gt;</code></em>_<em class="replaceable"><code>&lt;property_name&gt;</code></em>_<em class="replaceable"><code>&lt;field_name&gt;</code></em></span>.</p></li></ul></div><p>If a <span class="type">FIXED_DICT</span> type is used as an element of an
      <span class="type">ARRAY</span> or <span class="type">TUPLE</span>, then the fields are mapped
      into the columns of the <span class="type">ARRAY</span>'s or <span class="type">TUPLE</span>'s
      sub-table. The columns will be named <span class="literal">sm_&lt;field
      name&gt;</span>.</p><p>If the <span class="type">FIXED_DICT</span> property has the
      <code class="property">&lt;AllowNone&gt;</code> attribute set to
      <span class="literal">true</span>, then an additional column called
      <span class="literal">fm_<em class="replaceable"><code>&lt;property_name&gt;</code></em></span>
      will be added to the table. This column will have the value
      <span class="literal">0</span> when the property's value is
      <span class="literal">None</span>, or <span class="literal">1</span> otherwise.</p><p>The <code class="property">&lt;DatabaseLength&gt;</code> attribute should
      be specified at the field level of a <span class="type">FIXED_DICT</span> property
      <span class="symbol">&#8208;</span> the one specified at the property level
      is ignored.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7845"></a>8.3.9.&nbsp;<span class="type">USER_TYPE</span>s</h3></div></div></div><p>If you have a <span class="type">USER_TYPE</span> data type, then you can
      specify how it should be mapped to SQL. For more details on custom data
      types, see <a href="#xref_Implementing_Custom_Property_Data_Types" title="4.4.&nbsp;Implementing Custom Property Data Types">Implementing Custom Property Data Types</a>.</p><p>In order to provide this mapping, a method called
      <code class="methodname">bindSectionToDB</code> needs to be implemented in the
      <span class="type">USER_TYPE</span> implementation. This method receives an object as
      its argument to be used to declare the data binding. For example, for a
      <span class="type">USER_TYPE</span> implemented by an instance of the type
      <span class="type">TestUserType</span>:</p><pre class="programlisting">...
  class <em class="emphasis">TestUserType</em>:
    ...
    def addToStream( self, obj ):
      ...

    def <em class="emphasis">bindSectionToDB</em>( self, <em class="emphasis">binder</em> ):
      ...

instance = TestUserType()</pre><p><span class="citetitle">Defining <span class="type">USER_TYPE</span> database mapping
      method.</span></p><p>The object received by <code class="methodname">bindSectionToDB</code> to
      perform the type mapping (<em class="parameter"><code>binder</code></em> in the preceding
      example) provides the following methods:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="methodname">bind</code>(
          <em class="parameter"><code>property</code></em>, <em class="parameter"><code>type</code></em>,
          <em class="parameter"><code>databaseLength</code></em> )</em></p><p>Binds a property (based on name) from the data section to a
          field (or fields) in the current SQL table, and creates a column
          called
          <span class="literal">sm_<em class="replaceable"><code>&lt;property_name&gt;</code></em></span>.</p><p>The parameter type is a string that corresponds to the
          <span class="literal">&lt;Type&gt;</span> field of the XML definition of the
          property. For example:</p><div class="altrow"><a name="d0e7924"></a><p class="title"><b>Table&nbsp;8.4.&nbsp;Examples of <span class="literal">type</span> mapped to
            string.</b></p><div class="altrow-contents"><table summary="Examples of type mapped to&#xA;            string." border="0" width="75%"><colgroup><col width="11%"><col width="44%"><col width="45%"></colgroup><thead><tr><th align="left">Data type</th><th align="left">XML</th><th align="left"><span class="literal">type</span></th></tr></thead><tbody><tr><td align="left">Simple</td><td align="left"><span class="literal">&lt;Type&gt; INT
                  &lt;/Type&gt;</span></td><td align="left"><span class="type">INT</span></td></tr><tr><td align="left"><span class="type">ARRAY</span></td><td align="left"><span class="literal">&lt;Type&gt; ARRAY &lt;of&gt;
                  INT&lt;/of&gt; &lt;/Type&gt;</span></td><td align="left"><span class="literal">ARRAY &lt;of&gt;
                  INT&lt;/of&gt;</span></td></tr><tr><td align="left">Custom</td><td align="left"><span class="literal">&lt;Type&gt; USER_TYPE
                  &lt;implementedBy&gt; module.instance &lt;/implementedBy&gt;
                  &lt;/Type&gt;</span></td><td align="left"><span class="literal">USER_TYPE &lt;implementedBy&gt;
                  module.instance &lt;/implementedBy&gt;</span></td></tr></tbody></table></div></div><br class="altrow-break"><p>The parameter <em class="parameter"><code>databaseLength</code></em> is
          optional (defaulting to 255), and determines the size and data type
          of <span class="type">STRING</span> mapped. For more details, see <a href="#xref_STRING_UNICODE_STRING_BLOB_and_data_types" title="8.3.5.&nbsp;STRING, UNICODE_STRING, BLOB, and PYTHON Data Types"><span class="type">STRING</span>, <span class="type">UNICODE_STRING</span>,
      <span class="type">BLOB</span>, and <span class="type">PYTHON</span> Data Types</a>.</p></li><li><p><em class="emphasis"><code class="methodname">beginTable</code>(
          <em class="parameter"><code>property</code></em> )</em></p><p>Starts the specification of a new SQL table (called
          <span class="literal"><em class="replaceable"><code>&lt;current_table_name&gt;</code></em>_<em class="replaceable"><code>&lt;property_name&gt;</code></em></span>)
          for binding Python compound objects <em class="emphasis">e.g.</em> lists,
          tuples, dictionaries. Any calls to the method
          <code class="methodname">bind</code> following a
          <code class="methodname">beginTable</code> call will bind to fields in the
          new table until <code class="methodname">endTable</code> is called.</p><p>Typically, <code class="methodname">beginTable</code> is only used
          for binding Python compound objects that contains a variable number
          of compound objects <em class="emphasis">e.g.</em> list of tuples. For
          simple lists and tuples, it is sufficient to call bind with
          '<span class="literal">ARRAY &lt;of&gt;&lt;simple_type&gt;&lt;/of&gt;</span>'
          as the type. For compound objects that contain a fixed number of
          items, it is more efficient to bind each item as a separate field in
          parent table instead of creating a new table.</p><p>All tables created by <code class="methodname">beginTable</code> will
          have an additional field called <em class="parameter"><code>parentID</code></em> used
          in associating rows in the new table with the parent table.</p></li><li><p><em class="emphasis"><code class="methodname">endTable</code>()</em></p><p>Finishes the specification of new SQL table started by method
          <code class="methodname">beginTable</code>.</p><p>Upon completion, specification of the parent table is
          resumed.</p></li></ul></div><p>The implementation of the method
      <code class="methodname">bindSectionToDB</code> must match the implementation
      of the method <code class="methodname">addToStream</code>. The order and the
      parameter type of calls to <code class="methodname">bind</code> must match the
      order in which the properties are serialised.</p><p>The table below shows the <code class="methodname">addToStream</code>
      implementation followed by the corresponding
      <code class="methodname">bindSectionToDB</code> implementation:</p><div class="altrow"><table border="0"><colgroup><col width="50%"><col width="50%"></colgroup><thead><tr><th align="left"><code class="methodname">addToStream</code>
                implementation</th><th align="left">Corresponding
                <code class="methodname">bindSectionToDB</code>
                implementation</th></tr></thead><tbody><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"b"</code></em><code class="code">, obj.intValue
                )</code></td><td align="left"><code class="code">binder.bind( "intValue",
                </code><em class="emphasis"><code class="code">"INT8"</code></em><code class="code">
                )</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"B"</code></em><code class="code">, obj.intValue
                )</code></td><td align="left"><code class="code">binder.bind( "intValue",
                </code><em class="emphasis"><code class="code">"UINT8"</code></em><code class="code">
                )</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"h"</code></em><code class="code">, obj.intValue
                )</code></td><td align="left"><code class="code">binder.bind( "intValue",
                </code><em class="emphasis"><code class="code">"INT16"</code></em><code class="code">
                )</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"H"</code></em><code class="code">, obj.intValue
                )</code></td><td align="left"><code class="code">binder.bind( "intValue",
                </code><em class="emphasis"><code class="code">"UINT16"</code></em><code class="code">
                )</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"i"</code></em><code class="code">, obj.intValue
                )</code></td><td align="left"><code class="code">binder.bind( "intValue",
                </code><em class="emphasis"><code class="code">"INT32"</code></em><code class="code">
                )</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"I"</code></em><code class="code">, obj.intValue
                )</code></td><td align="left"><code class="code">binder.bind( "intValue",
                </code><em class="emphasis"><code class="code">"UINT32"</code></em><code class="code">
                )</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"q"</code></em><code class="code">, obj.intValue
                )</code></td><td align="left"><code class="code">binder.bind( "intValue",
                </code><em class="emphasis"><code class="code">"INT64"</code></em><code class="code">
                )</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"Q"</code></em><code class="code">, obj.intValue
                )</code></td><td align="left"><code class="code">binder.bind( "intValue",
                </code><em class="emphasis"><code class="code">"UINT64"</code></em><code class="code">
                )</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"f"</code></em><code class="code">, obj.floatValue
                )</code></td><td align="left"><code class="code">binder.bind( "floatValue",
                </code><em class="emphasis"><code class="code">"FLOAT32"</code></em><code class="code">)</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack(
                </code><em class="emphasis"><code class="code">"b"</code></em><code class="code">,
                len(obj.stringValue) ) + stringValue</code></td><td align="left"><code class="code">binder.bind( "stringValue",
                </code><em class="emphasis"><code class="code">"STRING"</code></em><code class="code">,
                50)</code></td></tr><tr><td align="left"><code class="code">stream += struct.pack ( "i",
                len(obj.listValue) ) for item in obj.listValue stream +=
                struct.pack ( "f", item )</code></td><td align="left"><p> <code class="code">binder.beginTable(
                "listValue" ) binder.bind( "value", "FLOAT32" )</code> </p>
                <p> <code class="code">binder.endTable()</code> </p> <p>
                <em class="emphasis">or</em> </p> <p> <code class="code">binder.bind(
                "listValue", "ARRAY &lt;of&gt; FLOAT32 &lt;/of&gt;" )</code>
                </p></td></tr></tbody></table></div><p> <span class="citetitle">Implementation of method
      <code class="methodname">addToStream</code> and corresponding
      <code class="methodname">bindSectionToDB</code>.</span></p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e8289"></a>8.3.9.1.&nbsp;Examples</h4></div></div></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Mapping a simple user-defined data
            type</em></p><p>The example below illustrates a simple user data type that
            represents a UTF-8 string.</p><p>It maps the Python type <span class="type">unicode</span> to a BigWorld
            data type. The method <code class="methodname">bindSectionToDB</code>
            binds the property to a 50-byte SQL string column. Since this type
            requires only one column, there is no need to give it a name, thus
            the property argument can be an empty string.</p><pre class="programlisting">class <em class="emphasis">UTF8String</em>():
  "
  UTF8(unicode) string
  "
  def <em class="emphasis">addToStream</em>( self, obj ):
    # obj is a Python Unicode object.
    string = obj.encode( "utf-8" ) <a name="db_layer_UTFEncodingNote" href="#db_layer_UTFEncodingNote_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>
    return struct.pack( "b", len(string) ) + string

  def <em class="emphasis">addToSection</em>( self, object, section ):
    # Since UTF-8 is compatible to C strings(no NULL characters)
    # it is safe to store a Unicode string as C string.
    # The asString setter/getter method stores the value in the
    # root of DataSection 'section'.
    section.asString = obj.encode( "utf-8" )

  def <em class="emphasis">createFromStream</em>( self, stream ):
    # Return a Python Unicode object.
    (length,) = struct.unpack( "b", stream[0] )
    string = stream[ 1 : length+1 ]
    return string.decode( "utf-8" )

  def <em class="emphasis">createFromSection</em>( self, section ):
    # The asString method returns the value of section root
    # as a simple C string.
    # Return a Python Unicode object.
    return section.asString.decode( "utf-8" )

  def <em class="emphasis">bindSectionToDB</em>( self, binder ):
    # The empty string represents the root of DataSection.
    # The value in the DataSection root will be stored in
    # SQL database as a column of STRING type
    binder.bind( "", "STRING", 50 )

  def <em class="emphasis">defaultValue</em>( self ):
    # Return an empty Python Unicode object.
    return u""

instance = UTF8String()</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/UTF8String.py</code></span></p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="db_layer_UTFEncodingNote_desc"></a><a href="#db_layer_UTFEncodingNote"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>In order to enable the utf-8 encode operation, the
                  Python <span class="literal">encodings</span> module will need to be
                  imported from
                  <code class="filename">fantasydemo/res/scripts/common/BWAutoImport.py</code>.</p></div></td></tr></table></div></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Mapping </em><em class="emphasis">a complex user-defined type</em></p><p>The example below implements the class
            <code class="classname">Test</code>, and the class
            <code class="classname">TestDataType</code>, which accesses the values on
            <code class="classname">Test</code>.</p><p><code class="classname">Test</code> contains three member
            variables:</p><div class="itemizedlist"><ul type="circle"><li><p>An integer.</p></li><li><p>A string.</p></li><li><p>A dictionary.</p></li></ul></div><p><code class="classname">TestDataType</code>'s method
            <code class="methodname">addToSection</code> will represent the
            attributes of <code class="classname">Test</code> objects like the
            following <code class="property">&lt;DataSection&gt;</code>:</p><pre class="programlisting">&lt;testData&gt;

  &lt;intValue&gt;    100        &lt;/intValue&gt;

  &lt;stringValue&gt; opposites  &lt;/stringValue&gt;

  &lt;dictValue&gt;
    &lt;value&gt;
      &lt;key&gt;    good     &lt;/key&gt;
      &lt;value&gt;  bad      &lt;/value&gt;
    &lt;/value&gt;
     &lt;value&gt;
      &lt;key&gt;    old      &lt;/key&gt;
      &lt;value&gt;  new      &lt;/value&gt;
    &lt;/value&gt;
    &lt;value&gt;
      &lt;key&gt;    big      &lt;/key&gt;
      &lt;value&gt;  small    &lt;/value&gt;
    &lt;/value&gt;
  &lt;/dictValue&gt;

&lt;/testData&gt;</pre><p><span class="citetitle"><code class="classname">Test</code> object's
            <code class="classname">DataSection</code> </span></p><p><code class="classname">TestDataType</code>'s method
            <code class="methodname">createFromSection</code> will create
            <code class="classname">Test</code> objects from
            <code class="classname">DataSection</code>s like the one above.</p><p><code class="classname">TestDataType</code>'s method
            <code class="methodname">bindSectionToDB</code> will bind the
            <code class="classname">Test</code> object's integer and string variables
            to two columns, and add a child table for the dictionary member,
            as illustrated below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/representation_of_test_entity_data.png"><span class="caption"><p>Representation of Test entity data in the MySQL
                database</p></span></div></div><p>The classes <code class="classname">Test</code> and
            <code class="classname">TestDataType</code> are defined as below:</p><pre class="programlisting">import struct

class <em class="emphasis">Test</em>:
  def <em class="emphasis">__init__</em>( self, intValue, stringValue, dictValue ):
    self.intValue = intValue
    self.stringValue = stringValue
    self.dictValue = dictValue

  def <em class="emphasis">writePascalString</em>( string ):
    return struct.pack( "b", len(string) ) + string

  def <em class="emphasis">readPascalString</em>( stream ):
    (length,) = struct.unpack( "b", stream[0] )
    string = stream[1:length+1]
    stream = stream[length+1:]
    return (string, stream)

class <em class="emphasis">TestDataType</em>:
  def <em class="emphasis">addToStream</em>( self, obj ):
    if not obj: obj = self.defaultValue()
    stream = struct.pack( "i", obj.intValue )
    stream += writePascalString( obj.stringValue )
    stream += struct.pack( "i", len( obj.dictValue ) ) <a name="db_layer_streamSizeNote" href="#db_layer_streamSizeNote_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>
    for key in obj.dictValue.keys():
      stream += writePascalString( key )
      stream += writePascalString( obj.dictValue[key] )
    return stream
  
  def <em class="emphasis">createFromStream</em>( self, stream ):
    (intValue,) = struct.unpack( "i", stream[:4] )
    stream = stream[4:]
    stringValue, stream = readPascalString( stream )
    dictValue = {}
    size = struct.unpack( "i", stream[:4] )
    stream = stream[4:]
    while len( stream ):
      key, stream = readPascalString( stream )
      value, stream = readPascalString( stream )
      dictValue[key] = value
    return Test( intValue, stringValue, dictValue )

  def <em class="emphasis">addToSection</em>( self, obj, section ):
    if not obj: obj = self.defaultValue()
    section.writeInt( "intValue", obj.intValue )
    section.writeString( "stringValue", obj.stringValue )
    s = section.createSection( "dictValue" )
    for key in obj.dictValue.keys():
      v = s.createSection( "value" )
      print key, obj.dictValue[key]
      v.writeString( "key", key )
      v.writeString( "value", obj.dictValue[key] )


  def <em class="emphasis">createFromSection</em>( self, section ): <a name="db_layer_createFromSectionNote" href="#db_layer_createFromSectionNote_desc"><img src="../images/callouts/2.png" alt="2" border="0"></a>
    intValue = section.readInt( "intValue" )
    if intValue is None:
      return self.defaultValue()
    stringValue = section.readString( "stringValue" )
    dictValue = {}
    for value in section["dictValue"].values():
      dictValue[value["key"].asString] = value["value"].asString
    return Test( intValue, stringValue, dictValue )

  def <em class="emphasis">fromStreamToSection</em>( self, stream, section ):
    o = self.createFromStream( stream )
    self.addToSection( o, section )

  def <em class="emphasis">fromSectionToStream</em>( self, section ):
    o = self.createFromSection( section )
    return self.addToStream( o )

  def <em class="emphasis">bindSectionToDB</em>( self, binder ):
    binder.bind( "intValue", "INT32" )
    binder.bind( "stringValue", "STRING", 50 )
    binder.beginTable( "dictValue" )
    binder.bind( "key", "STRING", 50 )
    binder.bind( "value", "STRING", 50 )
    binder.endTable()

  def <em class="emphasis">defaultValue</em>( self ):
    return Test(100, "opposites", {"happy":"sad", "big":"small", "good":"bad"})

instance = TestDataType()</pre><p><span class="citetitle"><code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/common/TestDataType.py
            </code></span></p><p>For details on methods supported for
            <code class="classname">DataSection</code> objects, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/baseapp/index.html#Client_Python_API" class="olink">Client Python API</a>, <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/cellapp/index.html#Client_Python_API" class="olink">Client Python API</a>, and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>'s entry <em class="emphasis">Class list <span class="symbol">&#8594;</span>
            DataSection</em>.</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="db_layer_streamSizeNote_desc"></a><a href="#db_layer_streamSizeNote"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>While it is important to stream and destream the size of
                dictionaries and array's correctly in Python, it is also
                important to realise that there is a C++ assumption of these
                sizes existing on the stream in order for entities to be sent
                to the DBMgr for persistent storage.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="db_layer_createFromSectionNote_desc"></a><a href="#db_layer_createFromSectionNote"><img src="../images/callouts/2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>This script function does not process the input
                  command and its corresponding output <span class="symbol">&#8208;</span> the input command is handled by the
                  database management system.</p><p>It is the user's responsibility to ensure that the
                  command is compatible with the underlying database. The
                  command's output should be processed by the callback
                  function provided by the user.</p></div></td></tr></table></div></li></ul></div></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e8523"></a>8.4.&nbsp;Execute Arbitrary Commands on Database</h2></div></div></div><p>BigWorld provides a facility for developers to execute arbitrary
    commands on the underlying database. By using the method
    <code class="classname">BigWorld</code>.<code class="methodname">executeRawDatabaseCommand</code>
    you can execute custom statements or commands, and access data that do not
    conform to the standard BigWorld database schema.</p><p>Each database interface can interpret the data (command) and convert
    it to the expected format. For example, the MySQL interface expects an SQL
    statement, and the XML interface expects a Python statement.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8536"></a>8.4.1.&nbsp;Execute Commands on SQL Database</h3></div></div></div><p>When executing a command on a SQL database, the method
      <code class="classname">BigWorld</code>.<code class="methodname">executeRawDatabaseCommand</code>
      has the following signature:</p><pre class="programlisting">BigWorld.executeRawDatabaseCommand( sql_statement, sqlResultCallback )</pre><p>It has the following parameters:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><em class="parameter"><code>sql_statement</code></em></em></p><p>The SQL statement to execute. For example: '<span class="literal">select *
          from tbl_Avatar</span>'.</p></li><li><p><em class="emphasis"><em class="parameter"><code>sqlResultCallback</code></em>
          </em></p><p>The Python callback to be invoked with the result from
          SQL.</p></li></ul></div><p>The callback will be invoked with the following parameters:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><em class="parameter"><code>resultSet</code></em> (List
          of list of strings)</em></p><p>For SQL statements that return a result set (such as
          <span class="literal">SELECT</span>), this is a list of rows, with each row
          being a list of strings.</p><p>For SQL statements that do not return a result set (such as
          <span class="literal">DELETE</span>), this is <span class="literal">None</span>.</p></li><li><p><em class="emphasis"><em class="parameter"><code>affectedRows</code></em>
          (Integer)</em></p><p>For SQL statements that return a result set (such as
          <span class="literal">SELECT</span>), this is <span class="literal">None</span>.</p><p>For SQL statements that do not return a result set (such as
          <span class="literal">DELETE</span>),this is the number of affected
          rows</p></li><li><p><em class="emphasis"><em class="parameter"><code>error</code></em>
          (String)</em></p><p>If there was an error in executing the SQL statement, this is
          the error message. Otherwise, this is
          <span class="literal">None</span>.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8622"></a>8.4.2.&nbsp;Execute Commands on XML Database</h3></div></div></div><p>When executing a command on a XML database, the method
      <code class="classname">BigWorld</code>.<code class="methodname">executeRawDatabaseCommand</code>
      has the following signature:</p><pre class="programlisting">BigWorld.executeRawDatabaseCommand( python_statement, pythonResultCallback )</pre><p>It has the following parameters:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><em class="parameter"><code>python_statement</code></em></em></p><p>The Python expression to execute</p></li><li><p><em class="emphasis"><em class="parameter"><code>pythonResultCallback</code></em>
          </em></p><p>The Python callback to be invoked with the result from the
          Python expression.</p></li></ul></div><p>The XML database is stored in a global data section named
      <code class="property">BigWorld.dbRoot</code>. The structure of the data section
      is defined by the entity definition files
      (<code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</code>).</p><p>The callback is called with three parameters:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">resultSet</span> (List of
          list of strings)</em></p><p>Output of the Python expression, as a string.</p><p>The string is embedded inside two levels of lists, so
          <span class="literal">resultSet[0][0]</span> retrieves the string.</p></li><li><p><em class="emphasis"><span class="literal">affectedRows</span>
          (Integer)</em></p><p>This parameter will always be <span class="literal">None</span>.</p></li><li><p><em class="emphasis"><span class="literal">error</span>
          (String)</em></p><p>If there was an error in executing the Python expression, this
          is the error message. Otherwise, this is
          <span class="literal">None</span>.</p></li></ul></div><p>The code fragments below execute a command on the XML
      database:</p><div class="orderedlist"><ol type="1"><li><p>Request the health level of an avatar called
          '<span class="literal">Fred</span>':</p><pre class="programlisting">BigWorld.executeRawDatabaseCommand(
    "[a[1]['health'].asInt for a in BigWorld.dbRoot.items() if a[0]=='Avatar' and a[1]['playerName'].asString == 'Fred']", <em class="emphasis">healthCallback</em> )</pre></li><li><p>Implement the Python callback:</p><pre class="programlisting">def <em class="emphasis">healthCallback</em>( result, dummy, error ):
    if (error):
         print "Error:", error
         return
    print "Health:", result[0][0]</pre></li><li><p>If the avatar's health level is 87, then the output will
          be:</p><pre class="programlisting">Health: [87]</pre></li></ol></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Secondary_Databases"></a>8.5.&nbsp;Secondary Databases</h2></div></div></div><p>Secondary databases are an optional feature that can be used to help
    reduce load on the primary database by distributing database writes onto
    machines with BaseApp processes. After an entity has been loaded from the
    primary database onto a BaseApp they are considered
    <em class="emphasis">active</em> and store any property modifications into a
    secondary database stored on the same machine as their associated BaseApp.
    Secondary databases will write back their contents to the primary database
    after an active entity is destroyed, becoming inactive.</p><div class="informalfigure"><div class="mediaobject"><img src="images/flow_of_persistent_data_secondary_database.png"><span class="caption"><p>Flow of persistent entity data when secondary databases
        are enabled</p></span></div></div><p>Each BaseApp has its own secondary database, including machines
    which may host more than one BaseApp. A secondary database is an SQLite
    database file on the BaseApp machine's local disk. Secondary databases can
    be enabled or disabled using the
    <code class="property">&lt;baseApp/secondaryDB/enable&gt;</code> configuration
    option. For details on this option, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_BaseApp_Secondary_Database_Configuration_Options" class="olink">Secondary Database Configuration Options</a>
    .</p><p>Entities are currently stored in raw binary form inside secondary
    databases and should only be manipulated using BigWorld tools like the
    data consolidation tool <span><strong class="command">consolidate_dbs</strong></span>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Data_Consolidation"></a>8.5.1.&nbsp;Data Consolidation</h3></div></div></div><p>In case of a complete system failure, active entities may not have
      the opportunity to flush their data to the primary database. The data
      consolidation tool is run to transfer the active entity data from
      secondary databases to the primary database.</p><p>The data consolidation process is automatically run during system
      shutdown to transfer the persistent data of entities that were active
      when the system was shutdown.</p><p>The data consolidation tool is automatically run during start-up
      if the system was not shutdown successfully.</p><p>Unlike the BigWorld server, which uses UDP for interprocess
      communications, the data consolidation tool uses TCP connections to
      transfer the secondary databases from the BaseApp machines to the DBMgr
      machine. If there is a firewall on the DBMgr machine, it needs to be
      configured to allow TCP connections from BaseApp machines.</p><p>For more details on the data consolidation tool, see the document
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Data_Consolidation_Tool" class="olink">Data Consolidation Tool</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Database_Snapshot"></a>8.5.2.&nbsp;Database Snapshot</h3></div></div></div><p>Due to the existence of secondary databases, the data in the
      primary database may be quite stale. A backup made of the primary
      database may be considered too stale for functional use. As a solution
      to this issue, a secondary database snapshot tool is provided to make
      more up-to-date backups by backing up data from secondary databases as
      well. For details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Database_Snapshot_Tool" class="olink">Database Snapshot Tool</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Despite the name of the tool, it does not generate a true
        snapshot of the system. The tool does not ensure that all active
        entities have flushed their data to the secondary databases before
        taking a copy of the secondary database. It makes a best effort at
        copying the primary and all the secondary databases at close to the
        same time.</p></div></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e7381" href="#d0e7381">13</a>] </sup>For more details see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>, chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a>, section
              <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Character_Set_Encodings"></a>Chapter&nbsp;9.&nbsp;Character Sets and Encodings</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Python_Character_Sets">9.1. Python and Entity Properties</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Encoding_Python_String">9.1.1. <span class="literal">STRING</span></a></span></dt><dt><span class="section"><a href="#xref_Encoding_Python_Unicode_String">9.1.2. <span class="literal">UNICODE_STRING</span></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_DBMgr_Character_Sets">9.2. DBMgr and Encodings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_DBMgr_MySQL_UNICODE_STRING">9.2.1. UNICODE_STRING storage</a></span></dt><dt><span class="section"><a href="#xref_Encodings_Sorting_Search_Results">9.2.2. Sorting search results</a></span></dt></dl></dd></dl></div><p>When dealing with characters outside the ASCII range it may be
  necessary to convert multi-byte values into a well defined format for
  network transmission and storage in either a file or database.</p><p>All areas of the server and the server tools default to using the
  UTF-8 character encoding as it is well known and widely implemented and
  supported.</p><p>The following chapter discusses the different areas of the server and
  tools that consider character encoding, along with how the default character
  encoding can be modified (if possible).</p><p>When discussing Unicode and character encodings we use some common
  terminology. This is briefly outlined below to avoid any confusion
  later.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Unicode</em></p><p>A standard for representing text (characters and symbols) from any
      language.</p><p>Characters for each language are represented by a unique
      <em class="emphasis">code point</em>. When discussing a code point, a
      <span class="literal">U</span> or <span class="literal">U+</span> will typically be prefixed
      before the code point for clarity.</p><p>Examples include:</p><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Code point</th><th>Description</th></tr></thead><tbody><tr><td>U+0041</td><td>Latin letter <em class="emphasis">A</em></td></tr><tr><td>U+0448</td><td>Cyrillic letter <em class="emphasis">SHA</em></td></tr><tr><td>U+4E04</td><td>CJK (Han) ideogram for <em class="emphasis">above</em></td></tr><tr><td>U+3082</td><td>Hiragana letter <em class="emphasis">MO</em></td></tr><tr><td>U+30E2</td><td>Katakana letter <em class="emphasis">MO</em></td></tr></tbody></table></div></li><li><p><em class="emphasis">Character encoding</em></p><p>A standard for representing a multi-byte value, for example a 3
      byte Unicode code point, when transmitting data between
      applications.</p><p>Examples include: UTF-8, Big5, GB18030, GB2312, KOI8-R</p></li><li><p><em class="emphasis">Encode</em></p><p>The process of converting a Unicode code point (or series of code
      points) into a specific character encoding.</p><p>For example, encoding <span class="literal">U+4E09</span> (Han character for
      <em class="emphasis">3</em>) into UTF-8 would result in a three byte value
      <span class="literal">E4 B8 89</span>.</p></li><li><p><em class="emphasis">Decode</em></p><p>The process of converting a byte (or array of bytes) from a
      character encoding into a set of Unicode code points.</p><p>For example, decoding the GB18030 value <span class="literal">08 1A</span>
      (Han character for <em class="emphasis">above</em>) into a Unicode code point
      would result in the value <span class="literal">U+4E04</span>.</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Python_Character_Sets"></a>9.1.&nbsp;Python and Entity Properties</h2></div></div></div><p>In every Python interpreter there is a default encoding that is used
    to convert from <code class="classname">string</code> objects to
    <code class="classname">unicode</code> objects. The current default encoding can
    be seen by running the following from within a Python interpreter:</p><pre class="programlisting">&gt;&gt;&gt; import sys
&gt;&gt;&gt; sys.getdefaultencoding()
'ascii'</pre><p>Within the BigWorld FantasyDemo source code, the default encoding is
    controlled by the variable <code class="varname">DEFAULT_ENCODING</code> in the file
    <code class="filename">fantasydemo/res/scripts/common/BWAutoImport.py</code>. By
    default this value is set to <span class="literal">utf-8</span>, however this may be
    changed to any valid Python encoding as required.</p><p>As Python is the scripting language used for interacting with
    entities and their properties, it is important to understand the
    implications of the default Python encoding on entity properties. This
    primarily affects two types of entity property data types,
    <span class="literal">STRING</span> and <span class="literal">UNICODE_STRING</span>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Encoding_Python_String"></a>9.1.1.&nbsp;<span class="literal">STRING</span></h3></div></div></div><p>Entity properties using the <span class="literal">STRING</span> data type
      are transferred around the network as byte arrays without any
      modification and are stored as a <span class="literal">BLOB</span> in the MySQL
      database. Properties of this type are expected to map directly to a
      Python <code class="classname">string</code> object.</p><p>When assigning a <code class="classname">unicode</code> string to a
      <span class="literal">STRING</span> property, the programmer must explicitly
      <code class="methodname">encode()</code> the string. For example assuming the
      default encoding is UTF-8:</p><pre class="programlisting">&gt;&gt;&gt; self.string_property = u"\u4e04".encode()
&gt;&gt;&gt; print repr( self.string_property )
'\xe4\xb8\x84'</pre><p>As <span class="literal">STRING</span> properties are stored in the database
      as a binary <span class="literal">BLOB</span>, any character encoding may be used
      using this method as it is up to the programmer to ensure all Python
      script references to the string are using the same encoding.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Encoding_Python_Unicode_String"></a>9.1.2.&nbsp;<span class="literal">UNICODE_STRING</span></h3></div></div></div><p>Entity properties that use the <span class="literal">UNICODE_STRING</span>
      data type are expected to be a Python <code class="classname">unicode</code>
      type object that can have their <code class="methodname">encode()</code> and
      <code class="methodname">decode()</code> methods invoked as required to
      convert, respectively, from and to Python <code class="classname">string</code>
      objects.</p><p>In order to transfer <span class="literal">UNICODE_STRING</span> properties
      around the network, they are encoded to UTF-8 by the BigWorld engine and
      then decoded to a Python <code class="classname">unicode</code> object after
      being destreamed. This is performed by the the
      <code class="classname">UnicodeStringDataType</code> class in
      <code class="filename">bigworld/src/lib/entitydef/data_types.<em class="replaceable"><code>[ch]</code></em>pp</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>There should be no reason to modify the encoding used to stream
        / destream <span class="literal">UNICODE_STRING</span> properties. This
        information is provided for reference purposes only.</p></div><p>The MySQL storage of <span class="literal">UNICODE_STRING</span> properties
      is slightly different to regular <span class="literal">STRING</span> objects.
      These properties result in <span class="literal">TEXT</span> or
      <span class="literal">VARCHAR</span> columns in the database with a specific
      character set encoding on each table and column. For more details please
      refer to the section <a href="#xref_DBMgr_MySQL_UNICODE_STRING" title="9.2.1.&nbsp;UNICODE_STRING storage">UNICODE_STRING storage</a>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_DBMgr_Character_Sets"></a>9.2.&nbsp;DBMgr and Encodings</h2></div></div></div><p>When considering DBMgr and MySQL's usage of character encodings, we
    must be clear on all areas that character sets are used.</p><p>Character encoding is only particularly relevant when dealing with
    <span class="literal">UNICODE_STRING</span> properties as <span class="literal">STRING</span>
    properties are already being considered as a byte array.</p><p>Streaming <span class="literal">UNICODE_STRING</span> properties to DBMgr uses
    the encoding / decoding mechanism outlined in <a href="#xref_Encoding_Python_Unicode_String" title="9.1.2.&nbsp;UNICODE_STRING"><span class="literal">UNICODE_STRING</span></a>.</p><p>Once DBMgr needs to send a UNICODE _STRING property to MySQL it is
    passed as UTF-8 to the MySQL client connection<sup>[<a name="d0e9063" href="#ftn.d0e9063">14</a>]</sup> for transmission. All BigWorld connections to a MySQL server
    are established in UTF-8 mode. This can be seen in the
    <code class="methodname">MySql::connect()</code> method located in
    <code class="filename">bigworld/src/lib/dbmgr_mysql/wrapper.cpp</code>.</p><p>When data is received by the MySQL server from a client connection
    it may optionally convert the data into another character set<sup>[<a name="d0e9078" href="#ftn.d0e9078">15</a>]</sup>. The client connection establishment outlined in the
    previous step ensures that this character set is also UTF-8 which means
    that no character set modification will occur here.</p><p>Now that the MySQL server has completely received the client data it
    can store it in whatever format is necessary. When creating entity tables,
    BigWorld defaults all UNICODE_STRING columns to store their data as UTF-8.
    This ensures the most compatible mode possible for all customers as UTF-8
    should cover the entire Unicode range of characters. The following section
    <a href="#xref_DBMgr_MySQL_UNICODE_STRING" title="9.2.1.&nbsp;UNICODE_STRING storage">UNICODE_STRING storage</a> outlines how the
    <span class="literal">UNICODE_STRING</span> properties are stored in more detail
    along with details on how to alter the encoding on disk.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_DBMgr_MySQL_UNICODE_STRING"></a>9.2.1.&nbsp;UNICODE_STRING storage</h3></div></div></div><p>Entity properties that have a data type of
      <span class="literal">UNICODE_STRING</span> are stored in a MySQL database as
      <span class="literal">TEXT</span> or <span class="literal">VARCHAR</span> columns depending
      on whether a <span class="literal">&lt;DatabaseLength&gt;</span> was specified in
      the entity definition file.</p><p>In order to allow more efficient storage of data in MySQL, it is
      possible to change the storage type of <span class="literal">UNICODE_STRING</span>
      property columns using the
      <span class="literal">dbMgr/unicodeString/characterSet</span><sup>[<a name="d0e9116" href="#ftn.d0e9116">16</a>]</sup> <code class="filename">bw.xml</code> option. The effect of
      modifying this value can best be seen by using an example.</p><p>Using the Chinese character for <em class="emphasis">3</em> (unicode
      code point U+4E09) we can see from the following Python code that the
      byte representation of the character is smaller in the GB2312<sup>[<a name="d0e9134" href="#ftn.d0e9134">17</a>]</sup> character set than in UTF-8.</p><pre class="programlisting">&gt;&gt;&gt; print repr( three )
u'\u4e09'
&gt;&gt;&gt; print repr( three.encode( "utf8" ) )
'\xe4\xb8\x89'
&gt;&gt;&gt; print repr( three.encode( "gb2312" ) )
'\xc8\xfd'</pre><p>For this reason for certain games it may make sense to use an
      alternate character set for storing <span class="literal">UNICODE_STRING</span>
      properties, however it is worth noting that while this is a supported
      feature, it may introduce unexpected issues due to differences in the
      Client input method<sup>[<a name="d0e9145" href="#ftn.d0e9145">18</a>]</sup> and the Python unicode string encoding<sup>[<a name="d0e9153" href="#ftn.d0e9153">19</a>]</sup>.</p><p>For more information on MySQL character encodings please refer to
      the MySQL online documentation.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9161"></a>9.2.1.1.&nbsp;Storing invalid characters</h4></div></div></div><p>As it is possible to modify the character set that
        UNICODE_STRING properties are stored as in MySQL, it is important to
        understand how MySQL handles the case of writing data to a column that
        cannot be encoded to the column's character set.</p><p>To illustrate this case we will start with a simple Python
        example. If we attempt to encode() the code point U+4E04 to the ASCII
        character encoding, an exception is raised as follows:</p><pre class="programlisting">&gt;&gt;&gt; print u"\u4E04".encode( "ascii" )
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1 in ?
UnicodeEncodeError: 'ascii' codec can't encode character u'\u4e04' in position 0: ordinal not in range(128)</pre><p>This behaviour unfortunately is not replicated in MySQL which
        will instead silently fail and insert ? characters in place of the
        invalid characters. As this failure is silent, it is possible to
        unknowingly corrupt data in your database by having a
        <span class="literal">dbMgr/unicodeString/characterSet</span> value that doesn't
        not fully cover the range of values that may be provided to MySQL.
        This is one of the reasons we recommend you leave the storage type as
        UTF-8 unless absolutely required.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Encodings_Sorting_Search_Results"></a>9.2.2.&nbsp;Sorting search results</h3></div></div></div><p>As each language has its own conventions regarding the order in
      which a set of values should be sorted, MySQL also provides the ability
      to modify the behaviour of search results when querying a database. This
      rules used to define sorting order is referred to as a
      <em class="emphasis">collation</em>.</p><p>Each character set that is available in MySQL has one or more
      collations available. For example the UTF-8 character set in MySQL has
      21 collations available which can be seen by running the command:</p><pre class="programlisting">mysql&gt; SHOW COLLATION LIKE 'utf8_%';</pre><p>This is relevant for both custom search results you may perform on
      the BigWorld entity database, as well as for internal server lookups
      that are performed for looking up entities by their
      <span class="literal">&lt;Identifier&gt;</span> property<sup>[<a name="d0e9192" href="#ftn.d0e9192">20</a>]</sup>.</p><p>Collations are generally referred to as one of the
      following:</p><div class="itemizedlist"><ul type="disc"><li><p>Case sensitive</p></li><li><p>Case insensitive</p></li><li><p>Binary</p></li></ul></div><p>Depending on the behaviour of your game, you may wish to modify
      the default UNICODE_STRING collation with the
      <span class="literal">dbMgr/unicodeString/collation</span><sup>[<a name="d0e9218" href="#ftn.d0e9218">21</a>]</sup> <code class="filename">bw.xml</code> option.</p><p>By default the server collation is <span class="literal">utf8_bin</span>
      which will provide case sensitive lookups.</p><p>For more information on MySQL collations and behaviour, please
      refer to the MySQL online documentation <em class="emphasis">Character Set
      Support</em>.</p></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e9063" href="#d0e9063">14</a>] </sup>This corresponds to the MySQL variable
        <code class="varname">character_set_client</code>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e9078" href="#d0e9078">15</a>] </sup>This corresponds to the MySQL variable
        <code class="varname">character_set_connection</code>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e9116" href="#d0e9116">16</a>] </sup>For more information on this option see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>, chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a>, section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e9134" href="#d0e9134">17</a>] </sup>The GB2312 character set is used in the example above rather
          than the more modern GB18030 character set as MySQL does not support
          GB18030.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e9145" href="#d0e9145">18</a>] </sup>For more information see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../client_programming_guide/client_programming_guide.html#Client_Programming_Guide" class="olink">Client Programming Guide</a>, chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../client_programming_guide/client_programming_guide.html#xref_IME" class="olink"><i>Input Method Editors (IME)</i></a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e9153" href="#d0e9153">19</a>] </sup>For more details see <a href="#xref_Python_Character_Sets" title="9.1.&nbsp;Python and Entity Properties">Python and Entity Properties</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e9192" href="#d0e9192">20</a>] </sup>This only applies when an
          <span class="literal">&lt;Identifier&gt;</span> property is a
          <span class="literal">UNICODE_STRING</span>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e9218" href="#d0e9218">21</a>] </sup>For more information on this option see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>, chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a>, section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Server_Profiling"></a>Chapter&nbsp;10.&nbsp;Profiling</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Profiling_Entities">10.1. Profiling Entities</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9319">10.1.1. Persistent Properties</a></span></dt><dt><span class="section"><a href="#d0e9326">10.1.2. Property Data Types</a></span></dt><dt><span class="section"><a href="#d0e9331">10.1.3. Property Data Propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Python_Script">10.2. Python Game Script</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Understanding_PyProfile_Output">10.2.1. Understanding the output</a></span></dt><dt><span class="section"><a href="#d0e9433">10.2.2. Increasing Memory Usage / Entity Count</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Server_Processes">10.3. Profiling Server Processes (C++ Code)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9479">10.3.1. Common Code Block Profiles</a></span></dt><dt><span class="section"><a href="#d0e9518">10.3.2. BaseApp Code Block Profiles</a></span></dt><dt><span class="section"><a href="#d0e9571">10.3.3. CellApp Code Block Profiles</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Client_Communication">10.4. Client Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e9736">10.4.1. Private Client Events</a></span></dt><dt><span class="section"><a href="#d0e9769">10.4.2. Public Client Events</a></span></dt><dt><span class="section"><a href="#d0e9806">10.4.3. Total Public Client Events</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Profiling_Server_Communication">10.5. Server Communication</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_BaseApp_Interface_Summary">10.5.1. BaseApp Interface Summary</a></span></dt><dt><span class="section"><a href="#d0e10151">10.5.2. CellApp Interface Summary</a></span></dt></dl></dd></dl></div><p>Profiling the server can take on a number of forms depending on the
  stage of development you are in and what kind of issues you are attempting
  to isolate. The following list is a brief outline of the different areas you
  may wish to profile.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Entities</em></p><p>Entities are the main game object which are used by all components
      of the BigWorld engine. Inefficient or bloated entities can cause
      excessive load and network communication on your server processes which
      will reduce the overall performance of your server cluster. This in turn
      can affect the total number of active users your server can
      support.</p><p>For more information see <a href="#xref_Profiling_Entities" title="10.1.&nbsp;Profiling Entities">Profiling Entities</a>.</p></li><li><p><em class="emphasis">Python script</em></p><p>Python script represents the majority of custom game code and as
      such is one of the most variable sources of load that is placed on the
      BigWorld server processes. Profiling Python script should be performed
      on a semi-regular basis and preferably while performing load tests in
      order to ensure that there are no major bottlenecks in your
      script.</p><p>For more information see <a href="#xref_Profiling_Python_Script" title="10.2.&nbsp;Python Game Script">Python Game Script</a>.</p></li><li><p><em class="emphasis">Server Processes</em></p><p>As the BigWorld server processes are the core of a server cluster
      that run custom script and game code, it can be useful to identify which
      areas of the server processes are under load. This can help to pinpoint
      issues in either game script, navigation issues, network communication,
      entity management or any of the other numerous tasks that are handled by
      the server processes.</p><p>For more information see <a href="#xref_Profiling_Server_Processes" title="10.3.&nbsp;Profiling Server Processes (C++ Code)">Profiling Server Processes (C++ Code)</a>.</p></li><li><p><em class="emphasis">Client Communication</em></p><p>Understanding the network traffic being sent to client connections
      can help lower bandwidth usage, thus reducing network costs as well as
      increasing the overall performance of your server cluster.</p><p>For more information see <a href="#xref_Profiling_Client_Communication" title="10.4.&nbsp;Client Communication">Client Communication</a>.</p></li><li><p><em class="emphasis">Server Process
      Communication</em></p><p>In order to diagnose network related latency issues on individual
      server processes, it can be useful to identify which network messages
      are causing the most load on each process.</p><p>For more information see <a href="#xref_Profiling_Server_Communication" title="10.5.&nbsp;Server Communication">Server Communication</a>.</p></li></ul></div><p>We recommend you run profiles regularly while you are developing or
  making changes to configuration, etc. as you can see what effect a change
  can make. You should keep the profiles that you generate to use as a
  historical reference for your games performance over the development life.
  For example, if you make a script change, and suddenly cell load is quite
  high, you can use the profiles to see when this load spike started and
  narrow down the cause of the issue to script usage as well as the particular
  methods causing the script load spike.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Profiling_Entities"></a>10.1.&nbsp;Profiling Entities</h2></div></div></div><p>As Entities are the main game object being used by all components of
    the BigWorld engine it is important to make sure that your game entities
    are implemented as efficiently as possible. This includes:</p><div class="itemizedlist"><ul type="disc"><li><p>Minimising persistent properties.</p></li><li><p>Ensuring properties have the smallest applicable data type
        (while considering long term scaling).</p></li><li><p>Ensuring properties have the most appropriate data propagation
        flags assigned.</p></li><li><p>Ensuring properties have AoI where appropriate.</p></li></ul></div><p>The best mechanism currently in place for profiling entity sizes is
    the usage of the WebConsole filtered watchers view to collect information
    about the impact of each entity type's properties, coupled with a peer
    review system to ensure that multiple people have an understanding of the
    impact of property types.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9319"></a>10.1.1.&nbsp;Persistent Properties</h3></div></div></div><p>Persistent properties cause load from both network transmission
      costs between CellApp, BaseApp and DBMgr, as well as placing load onto
      DBMgr when not using Secondary Databases. By minimising the number of
      persistent properties as well as decreasing the size of properties that
      are being persisted you will effect a long term performance gain in your
      cluster.</p><p>Determining the persistent properties can be performed by using
      the WebConsole filtered watcher page using a Processes of 'cellapp' and
      a Path of 'entityTypes/*/properties/*/persistent'. Once you have
      narrowed down the persistent properties you can perform a review of them
      to determine any optimisations that can be made.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9326"></a>10.1.2.&nbsp;Property Data Types</h3></div></div></div><p>Choosing the smallest possible data type that can be used for a
      property will assist in lowering network load within your cluster. This
      includes all properties regardless of whether they are persisted.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9331"></a>10.1.3.&nbsp;Property Data Propagation</h3></div></div></div><p>Often the easiest solution when developing a game is to set all
      properties to <span class="literal">CELL_PUBLIC</span> or
      <span class="literal">ALL_CLIENTS</span> as it provides the greatest visibility of
      the property. This quite often works perfectly when developing in the
      office on a single machine server that isn't heavily loaded, however
      this can lead to large problems when performing load tests and scaling a
      game up to production.</p><p>Ideally the best approach when deciding on the propagation flags
      to use with properties is to use the object oriented design philosophy
      of calling methods on an object, in this case an Entity, to request that
      it perform work for you, rather than accessing its private information
      yourself.</p><p>A common example is the health or HP of an entity. This value may
      be constantly changing due to damage or regenerating health over time
      and is often only directly relevant for the entity the property is
      associated with. While other entities may be interested in this
      property, they are only transiently interested, such as when they are
      all in combat together, or if the entities have formed a group of
      players. In this circumstance it may make sense to have the propagation
      flag as <span class="literal">CELL_PRIVATE</span> which can be requested as
      required by a method call. This reduces the amount of network traffic
      generated from broadcasting the health property every time it is updated
      but still allows access to the property when required.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Profiling_Python_Script"></a>10.2.&nbsp;Python Game Script</h2></div></div></div><pre class="programlisting">control_cluster.py pyprofile</pre><p>Profiling Python script generally occurs as a result of identifying
    particular bottlenecks in script that are causing issues with server
    processes, such as long tick times resulting in process termination
    through a SIGQUIT signal.</p><p>Profiling server side script is performed with the
    <code class="filename">control_cluster.py</code> script using the <em class="parameter"><code>pyprofile</code></em><sup>[<a name="d0e9363" href="#ftn.d0e9363">22</a>]</sup> command. This command only applies to server components that
    run Python script, i.e., CellApp, BaseApp and DBMgr.</p><p>This command will dump a table of the top cumulative and internal
    times for script calls over a period of time. The user can optionally
    display tables of callers and callees as well. See
    <span><strong class="command">control_cluster.py</strong></span> <code class="option">--help</code> for exact
    usage and options.</p><p>This tool is invaluable in determining which script calls are
    causing the most server-side CPU load for your game, for example:</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Understanding_PyProfile_Output"></a>10.2.1.&nbsp;Understanding the output</h3></div></div></div><p>PyProfile will output its results for each process that has been
      queried in two orderings, internal time and cumulative time. The output
      format of these two result sets are identical. The profile aims to help
      in identifying the most time-expensive Python script methods implemented
      by your game.</p><pre class="programlisting">      6681 function calls in 0.106 CPU seconds

Ordered by: internal time
List reduced from 30 to 10 due to restriction &lt;10&gt;

ncalls  tottime  percall  cumtime  percall filename:lineno(function)
   643    0.019    0.000    0.020    0.000 Guard.py:446(moveToPosition)
   102    0.016    0.000    0.016    0.000 Creature.py:476(moveTowardsPoint)
   643    0.011    0.000    0.050    0.000 Guard.py:349(think)
   354    0.010    0.000    0.036    0.000 Creature.py:332(think)
   239    0.007    0.000    0.008    0.000 Guard.py:584(nextPatrolNode)
   627    0.006    0.000    0.054    0.000 Guard.py:735(onMove)
   202    0.006    0.000    0.006    0.000 Flock.py:166(onTimer)
   404    0.005    0.000    0.019    0.000 Guard.py:653(doCamp)
   101    0.004    0.000    0.004    0.000 DustDevil.py:26(onTimer)
   239    0.004    0.000    0.019    0.000 Guard.py:639(doPatrol)
</pre><p>The <code class="classname">hotshot</code> Python module which produces
      these reports uses two different names when referring to the same
      information. The internal time report corresponds to the total time
      column outlined in the table below along with the other column
      descriptions.</p><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Column Name</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">ncalls</td><td align="left">The total number of calls seen for this
              function.</td></tr><tr><td align="left">tottime</td><td align="left">The amount of time (in seconds) that is
              spent executing the code only inside of the current method.
              Methods called from this method are not included.</td></tr><tr><td align="left">cumtime</td><td align="left">The amount of time (in seconds) this method
              took to execute, including the execution time of any other
              methods called from this method.</td></tr><tr><td align="left">percall</td><td align="left">The percall columns refer to the columns
              immediately to the left of them and indicate the average time
              per call for the profile time they refer to.</td></tr><tr><td align="left">filename:lineno(function)</td><td align="left">The filename and line number containing
              function the profile refers to.</td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9433"></a>10.2.2.&nbsp;Increasing Memory Usage / Entity Count</h3></div></div></div><p>Automatic garbage collection has been disabled in BigWorld to
      avoid the Python engine from utilising large amounts of CPU time at
      unexpected intervals. In order to allow Python objects to be deleted,
      the server processes will only delete objects when their reference count
      reaches zero. This approach has the side effect of not deleting objects
      that have circular references or are referenced by objects having
      circular references.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9438"></a>10.2.2.1.&nbsp;Identifying the problem</h4></div></div></div><p>The symptoms of circular references in Python script will
        generally manifest as a constant rising of the total number of
        entities in your server, either on the base or cell, and / or as a
        constantly increasing memory footprint of your server
        processes.</p><p>If you suspect this may be occurring within your game script the
        following code will run the Python garbage collector and report the
        Python objects that are ready for deletion.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The following operation can take a large amount of time (in
          the order of many seconds), so it is possible to cause a BaseApp or
          CellApp process to be terminated due to not processing network
          requests for more than three seconds.</p><p>Ideally this command should only be run within a development
          environment and as a last resort within a production cluster.</p></div><pre class="programlisting">import gc
gc.set_debug( gc.DEBUG_SAVEALL )
gc.collect()
print gc.garbage</pre><p>The list of objects stored in gc.garbage are ready for deletion.
        If you see a large number objects all of the same object types, you
        may need to explore your code further to remove any circular
        references when the parent object is deleted.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Profiling_Server_Processes"></a>10.3.&nbsp;Profiling Server Processes (C++ Code)</h2></div></div></div><p>When experiencing load spikes in your server that are not easily
    attributable to a specific cause it can be useful to profile the C++
    server code to help narrow down the areas where the most time is being
    spent. This is supported on both the BaseApp and the CellApp using the
    <code class="filename">control_cluster.py</code> command <em class="parameter"><code>cprofile</code></em>.</p><p>This <em class="parameter"><code>cprofile</code></em> command collects
    and reports the internal C++ profiles of a server process over a period of
    time. The profiles are broken down into key time sensitive code blocks
    such as sending updates to clients, entity navigation, etc.</p><p>Below is the <em class="parameter"><code>cprofile</code></em> output
    from a CellApp running the FantasyDemo resources that is idling:</p><pre class="programlisting">Profile                Count   Cumulative Times          Internal Times         
Idle                    2758 |  8.963s   3249us  88.0% |  8.963s   3249us  88.0%
scriptCall              8825 |  0.804s     91us   7.9% |  0.744s     84us   7.3%
callUpdates              102 |  0.383s   3758us   3.8% |  0.109s   1067us   1.1%
shuffleEntity          15648 |  0.069s      4us   0.7% |  0.069s      4us   0.7%
backup                   102 |  0.065s    637us   0.6% |  0.052s    510us   0.5%
boundaryCheck            448 |  0.035s     78us   0.3% |  0.035s     78us   0.3%
findPath                 466 |  0.030s     65us   0.3% |  0.030s     65us   0.3%
RunningTime                0 |  0.000s      0us   0.0% |  0.025s      0us   0.2%
callTimers               102 |  0.637s   6241us   6.3% |  0.020s    193us   0.2%
visionUpdate            9999 |  0.018s      1us   0.2% |  0.018s      1us   0.2%
tickStats                102 |  0.017s    163us   0.2% |  0.017s    163us   0.2%
canNavigateTo           2018 |  0.046s     22us   0.5% |  0.016s      8us   0.2%
calcBoundary             102 |  0.016s    159us   0.2% |  0.014s    140us   0.1%
onTimer                 3614 |  0.618s    170us   6.1% |  0.010s      2us   0.1%
watchersTCP              250 |  0.007s     26us   0.1% |  0.007s     26us   0.1%
transientLoad            509 |  0.004s      8us   0.0% |  0.004s      8us   0.0%
gameTick                 102 |  1.158s  11356us  11.4% |  0.004s     41us   0.0%
findEntity              1327 |  0.003s      2us   0.0% |  0.003s      2us   0.0%
onMove                   796 |  0.198s    248us   1.9% |  0.002s      2us   0.0%
chunksMainThread         509 |  0.006s     10us   0.1% |  0.001s      2us   0.0%

Total running time: 10.181s (0.000s spare)
</pre><p>The following sections outline some of the code blocks that are
    profiled along with a short description of their meaning. The sections
    have been broken down into code that is common between server processes,
    and server process specific code.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9479"></a>10.3.1.&nbsp;Common Code Block Profiles</h3></div></div></div><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Profile Type</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">Idle</td><td align="left">Time spent idling while polling for network
              / file descriptor activity.</td></tr><tr><td align="left">RunningTime</td><td align="left">Time spent collating profile
              statistics.</td></tr><tr><td align="left">tickStats</td><td align="left">Time spent updating moving average for
              statistics.</td></tr><tr><td align="left">watchersTCP</td><td align="left">Time spent processing TCP watcher
              requests.</td></tr><tr><td align="left">watchersUDP</td><td align="left">Time spent processing UDP watcher
              requests.</td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9518"></a>10.3.2.&nbsp;BaseApp Code Block Profiles</h3></div></div></div><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Profile Type</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">archive</td><td align="left">Time spent archiving entities to the
              database as part of the second level fault tolerance. See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a> chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Backups_And_Disaster_Recovery" class="olink"><i>Backups and Disaster Recovery</i></a>.</td></tr><tr><td align="left">backup</td><td align="left">Time spent performing entity backups to
              other BaseApps as part of the first level fault tolerance
              mechanism. See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>
              chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Fault_Tolerance" class="olink"><i>Fault Tolerance</i></a>.</td></tr><tr><td align="left">encryptRecv</td><td align="left">Time spent decrypting incoming network
              traffic from the EncryptionFilter
              (<code class="filename">bigworld/src/lib/network/encryption_filter.cpp</code>).</td></tr><tr><td align="left">encryptSend</td><td align="left">Time spent encrypting outgoing network
              traffic from the EncryptionFilter
              (<code class="filename">bigworld/src/lib/network/encryption_filter.cpp</code>).</td></tr><tr><td align="left">tickGameTime</td><td align="left">Time spent processing game ticks.</td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9571"></a>10.3.3.&nbsp;CellApp Code Block Profiles</h3></div></div></div><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Profile Type</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">backup</td><td align="left">Time spent backing up cell entities to their
              Base.</td></tr><tr><td align="left">boundaryCheck</td><td align="left">Time spent calculating all entities that
              need to be offloaded, ghosted or removed.</td></tr><tr><td align="left">calcBoundary</td><td align="left">Time spent calculating the number of
              entities that can be offloaded and notifying CellAppMgr.</td></tr><tr><td align="left">callTimers</td><td align="left">Time spent processing timers.</td></tr><tr><td align="left">callUpdates</td><td align="left">Time spent calling updatable objects such as
              controllers and witnesses. Calls to
              <code class="classname">Controller</code><code class="methodname">.update()</code>
              are included in this time.</td></tr><tr><td align="left">canNavigateTo</td><td align="left">Time spent calculating whether an Entity can
              move to a destination position from its current
              location.</td></tr><tr><td align="left">chunksMainThread</td><td align="left">Time spent performing chunk loading /
              unloading calculations in the main thread.</td></tr><tr><td align="left">findEntity</td><td align="left">Time spent locating a specific entity within
              the known population on the CellApp.</td></tr><tr><td align="left">gameTick</td><td align="left">Time processing the game tick.</td></tr><tr><td align="left">onMove</td><td align="left">Time spent in the
              <code class="methodname">onMove()</code> script callback from a
              movement controller.</td></tr><tr><td align="left">onTimer</td><td align="left">Time spent in the
              <code class="methodname">onTimer()</code> script callback from the
              timer controller.</td></tr><tr><td align="left">scriptCall</td><td align="left">Time spent in any Python script call that
              has been invoked from C++.</td></tr><tr><td align="left">shuffleEntity</td><td align="left">Time spent updating the range lists on
              entity movement.</td></tr><tr><td align="left">transientLoad</td><td align="left">Time spent performing entity management
              tasks such as creation, deletion and initialisation.</td></tr><tr><td align="left">visionUpdate</td><td align="left">Time spent updating the vision of
              entities.</td></tr></tbody></table></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Profiling_Client_Communication"></a>10.4.&nbsp;Client Communication</h2></div></div></div><pre class="programlisting">control_cluster.py eventprofile</pre><p>Recall that the server sends down both non-volatile data and
    volatile data down to the client. Volatile data is in the form of position
    and pose updates, while non-volatile data consists of the property updates
    on an entity and client-side method calls for that entity, sent down to
    any player that can witness that entity. The profiling of non-volatile
    data can give valuable insight into which methods and property updates are
    particularly high throughput, enabling effective optimisation of the
    network impact of entity scripts.</p><p>There is a distinction made between own-client communication and
    other-client communication. Own-client communication consists of method
    calls and property updates that only an entity's own client will receive.
    These include updates for properties marked as
    <span class="literal">OWN_CLIENT</span> as well as method calls that are made using
    the <span class="literal">ownClient</span> mailbox, and are private to the player's
    own entity and not broadcast to other players. Note that this type of
    client communication only applies to player entities.</p><p>In contrast, there is also other-client communication for an entity,
    which consists of the public method calls and property updates that
    players having that entity in their AoI are able to witness. This includes
    updates for properties marked as <span class="literal">OTHER_CLIENTS</span> or
    <span class="literal">ALL_CLIENTS</span>, as well as method calls made on an
    entity''s <span class="literal">otherClients</span> or as well as the
    <span class="literal">allClients</span> mailbox. These events are potentially
    propagated to any player that has that entity in their AoI.</p><p>Other-client events are not propagated to witnessing clients
    immediately. For instance, the distance a player is from the entity an
    event pertains to will affect how soon that event is propagated after the
    event has actually occurred on the server side. In addition, the LoD level
    set on properties and methods will affect whether a particular event will
    be sent down to a witnessing player.</p><p>Client communication is broken down into three types for the
    purposes of profiling:</p><div class="itemizedlist"><ul type="disc"><li><p>Property changes and method calls to an entity's own client
        (<span class="literal">privateClientEvents</span>). This tracks whenever any
        own-client communication occurs.</p></li><li><p>Property changes and method calls that can be made available to
        players that witness it (<span class="literal">publicClientEvents</span>). This
        tracks whenever any public property is updated or any client method is
        called that can be sent down to any witnessing players.</p></li><li><p>Property changes and method calls that are actually sent down to
        players (<span class="literal">totalPublicClientEvents</span>). This tracks the
        total number of public properties that were actually sent down to
        witnessing players, subject to LoD levels.</p></li></ul></div><p>The <em class="parameter"><code>eventprofile</code></em> command
    samples a running server over a period of time, collecting counts and
    sizes of all non-volatile communication down to the client. A sample
    output of <em class="parameter"><code>eventprofile</code></em> is provided
    below, followed by a brief description of the sections. This section is
    brief as the event profile command is scheduled to be updated to use the
    new property statistics available under the <span class="literal">entityTypes</span>
    watcher tree.</p><pre class="programlisting">Waiting 120.0 secs for sample data ...
**** cellapp01 ****

Event Type: privateClientEvents

Name                                    #       Size    AvgSize  Bandwidth

Avatar.cellBounds                     120       2880     24.000     24.000
Avatar.myArray                          2         41     20.500      0.342
Avatar.modeTarget                       2         16      8.000      0.133
Avatar.myDict                           1         11     11.000      0.092
Avatar.mode                             2         10      5.000      0.083


Event Type: publicClientEvents

Name                                    #       Size    AvgSize  Bandwidth

Creature.moving                      4741      23705      5.000    197.542
Creature.performAction                956       4780      5.000     39.833
Guard.moving                          647       3235      5.000     26.958
Creature.creatureState                150        750      5.000      6.250
Guard.didGesture                       69        345      5.000      2.875
Avatar.modeTarget                       2         16      8.000      0.133
Merchant.modeTarget                     2         16      8.000      0.133
Avatar.mode                             2         10      5.000      0.083
Beast.initiateRage                      2          8      4.000      0.067


Event Type: totalPublicClientEvents

Name                                    #       Size    AvgSize  Bandwidth

Creature.moving                      1559       7795      5.000     64.958
Creature.performAction                396       1980      5.000     16.500
Creature.creatureState                 52        260      5.000      2.167
Merchant.modeTarget                     2         16      8.000      0.133
Beast.initiateRage                      2          8      4.000      0.067
</pre><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9736"></a>10.4.1.&nbsp;Private Client Events</h3></div></div></div><p>These include:</p><div class="itemizedlist"><ul type="disc"><li><p>Changes on properties marked as <span class="literal">OWN_CLIENT</span>
          or <span class="literal">ALL_CLIENT</span>S.</p></li><li><p>Client-side method calls on a player's own entity that are
          propagated to that player's own client via
          <code class="classname">Entity</code><code class="varname">.ownClient</code>,
          <code class="classname">Entity</code><code class="varname">.client</code> or
          <code class="classname">Entity</code><code class="varname">.allClients</code>.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9769"></a>10.4.2.&nbsp;Public Client Events</h3></div></div></div><p>These include:</p><div class="itemizedlist"><ul type="disc"><li><p>Changes on properties marked as
          <span class="literal">OTHER_CLIENTS</span> or
          <span class="literal">ALL_CLIENTS</span>.</p></li><li><p>Client-side methods calls that are made on the mailboxes
          <code class="classname">Entity</code><code class="varname">.otherClients</code>,
          <code class="classname">Entity</code><code class="varname">.allClients</code>, or
          using the special
          <code class="classname">Entity</code>.<code class="methodname">clientMethod</code>(
          <em class="parameter"><code>entityID</code></em> ) method.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9806"></a>10.4.3.&nbsp;Total Public Client Events</h3></div></div></div><p>These include:</p><div class="itemizedlist"><ul type="disc"><li><p>Changes on properties marked as
          <span class="literal">OTHER_CLIENTS</span> or <span class="literal">ALL_CLIENTS</span>
          that were actually sent down to witnessing players.</p></li><li><p>Client-side method calls that are made on the mailboxes
          <code class="classname">Entity</code><code class="varname">.otherClients</code>,
          <code class="classname">Entity</code><code class="varname">.allClients</code>, or
          using the special
          <code class="classname">Entity</code>.<code class="methodname">clientMethod</code>(
          <em class="parameter"><code>entityID</code></em> ) method, that were actually sent
          down to witnessing players.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Profiling_Server_Communication"></a>10.5.&nbsp;Server Communication</h2></div></div></div><pre class="programlisting">control_cluster.py mercuryprofile</pre><p>Server communication primarily occurs via Mercury<sup>[<a name="d0e9850" href="#ftn.d0e9850">23</a>]</sup> interfaces. These can be seen on server processes under the
    Watcher tree path <span class="literal">nub/interfacesByName</span>.</p><p>The output of <em class="parameter"><code>mercuryprofile</code></em>
    provides a condensed table of results that can be optionally sorted as
    required by using options when running the profile. A sample of the output
    from a single instance of CellApp is provided below.</p><pre class="programlisting">cellapp01 - Internal Nub

 id                   name     br    mr max br   aml abps amps
  0       DBInterfaceBirth      8     1      8   8.0  0.0  0.0
  1                addCell     92     4     23  23.0  0.0  0.0
  2                startup      8     1      8   8.0  0.0  0.0
  3            setGameTime      4     1      4   4.0  0.0  0.0
 14         cellAppMgrInfo 380184 95046      4   4.0 40.0 10.0
 18         updateGeometry 646272 38016     17  17.0 68.0  4.0
 19    spaceGeometryLoaded     78     4     22  19.5  0.0  0.0
 21           createEntity    270     4     70  67.5  0.0  0.0
 22 createEntityNearEntity  63181   466    295 135.6  0.0  0.0
 35       writeToDBRequest   1536   384      4   4.0  0.1  0.0
 50        runScriptMethod  49110  4821    190  10.2 -5.0 -0.5
255                  Reply  10892   165   9600  66.0 -0.0 -0.0
</pre><p>By default this output is sorted by ID. As mentioned the sorting can
    be altered by providing command line options with running the profile.
    Refer to the online help with <code class="code">control_cluster.py help
    mercuryprofile</code> for more details. The table below provides a
    description of each column type.</p><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Column Name</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">id</td><td align="left">The Mercury message ID for this message. This
            corresponds to the watcher value
            <span class="literal">nub/interfaceByName/<em class="replaceable"><code>messageName</code></em>/id</span>.</td></tr><tr><td align="left">name</td><td align="left">The name for this Mercury message. This
            corresponds to the watcher value
            <span class="literal">nub/interfaceByID/<em class="replaceable"><code>ID</code></em>/name</span>.</td></tr><tr><td align="left">br</td><td align="left">The total number of bytes received for
            messages of this message type.</td></tr><tr><td align="left">mr</td><td align="left">A count of the number of messages received for
            this message type.</td></tr><tr><td align="left">max br</td><td align="left">The maximum numbers of bytes received for a
            single instance of this message type from all messages of this
            type that have been seen.</td></tr><tr><td align="left">aml</td><td align="left">The average message length (in bytes) for this
            message type.</td></tr><tr><td align="left">abps</td><td align="left">The average bytes per second that this message
            type is handling.</td></tr><tr><td align="left">amps</td><td align="left">The average number of messages per second of
            this message type.</td></tr></tbody></table></div><p>Each server process type provides a different interface based on the
    functionality that process is providing. The two major causes of network
    traffic from Mercury messages are the BaseApp and CellApp. The following
    sections outline the most commonly encountered interface messages and
    their associated functionality. With this information it is possible to
    narrow down the scope of any potential issues.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_BaseApp_Interface_Summary"></a>10.5.1.&nbsp;BaseApp Interface Summary</h3></div></div></div><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Interface Name</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">addGlobalBase</td><td align="left">Messages received from the BaseAppMgr
              informing a BaseApp of a new global base.</td></tr><tr><td align="left">backupBaseEntity</td><td align="left">Messages containing backup information for
              bases on other BaseApps. This is part of the first level fault
              tolerance mechanism. See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a> chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Fault_Tolerance" class="olink"><i>Fault Tolerance</i></a>.</td></tr><tr><td align="left">backupCellEntity</td><td align="left">Messages from cell entities containing
              backup information. This is part of the first level fault
              tolerance mechanism.</td></tr><tr><td align="left">callBaseMethod</td><td align="left">Messages from other processes requesting a
              Python method is run on a base entity.</td></tr><tr><td align="left">callCellMethod</td><td align="left">Messages from a CellViaBaseMailBox. These
              messages are forwarded on to the requested base's cell
              entity.</td></tr><tr><td align="left">callClientMethod</td><td align="left">Messages from a ClientViaBaseMailBox. These
              messages are forwarded to the Proxy's connect client
              entity.</td></tr><tr><td align="left">cellEntityLost</td><td align="left">Messages from a cell entity notifying its
              base that it has been destroyed.</td></tr><tr><td align="left">createBaseFromDB</td><td align="left">Messages asking for a base entity to be
              created using a known DBID as a result of calling
              <code class="classname">BigWorld</code><code class="methodname">.createRemoteBaseFromDB<em class="replaceable"><code>*</code></em>()</code>.</td></tr><tr><td align="left">createBaseWithCellData</td><td align="left">Messages requesting a base entity is
              created.</td></tr><tr><td align="left">createCellPlayer</td><td align="left">Messages forwarded from a CellApp to a
              Client connection via a Proxy notifying the client that its
              Witness has been created.</td></tr><tr><td align="left">currentCell</td><td align="left">Messages from CellApps to BaseApps notifying
              a base of an offload in its cell entity. This occurs as a normal
              part of offloading entities as part of load balancing.</td></tr><tr><td align="left">detailedPosition</td><td align="left">Messages containing position updates from
              the cell to the client.</td></tr><tr><td align="left">entityMessage</td><td align="left">Messages that are received on a nub to call
              a specific interface method. For internal nubs this corresponds
              to all methods defined in an entity's
              <span class="literal">&lt;baseMethod&gt;</span> section. For external nubs
              this corresponds only to methods that are an
              <span class="literal">&lt;Exposed&gt;</span>
              <span class="literal">&lt;baseMethod&gt;</span>.</td></tr><tr><td align="left">forwardedBaseMessage</td><td align="left">Messages intended for a base that has been
              recently offloaded to another BaseApp.</td></tr><tr><td align="left">logOnAttempt</td><td align="left">Messages from the DBMgr for logon
              attempts.</td></tr><tr><td align="left">modWard</td><td align="left">Messages from the cell notifying the proxy
              and the client of a change of client control as a result of
              calling
              <code class="classname">BigWorld</code><code class="methodname">.controlledBy()</code>.</td></tr><tr><td align="left">sendToClient</td><td align="left">Messages from the cell notifying the proxy
              that it has sent all the required updates for the entity for the
              current tick and they should now be forwarded to the
              client.</td></tr><tr><td align="left">setBackupBaseApps</td><td align="left">Messages from the BaseAppMgr notifying the
              current BaseApp of the other BaseApps that it is responsible for
              performing backups of.</td></tr><tr><td align="left">setClient</td><td align="left">Message to notify the BaseApp that the next
              message received refers to a specific Entity. This will
              generally correspond with the number of callBaseMethod,
              callCellMethod and callClientMethod messages.</td></tr><tr><td align="left">setCreateBaseInfo</td><td align="left">Messages from the BaseAppMgr informing the
              BaseApp of the best BaseApp to use for calls to
              <code class="classname">BigWorld</code><code class="methodname">.createBaseAnywhere()</code>
              and
              <code class="classname">BigWorld</code><code class="methodname">.createBaseRemotely()</code>.</td></tr><tr><td align="left">setSharedData</td><td align="left">Messages notifying the BaseApp of any
              changes to shared data which can include
              <code class="classname">BigWorld</code><code class="varname">.baseAppData</code>
              and
              <code class="classname">BigWorld</code><code class="varname">.globalData</code>.</td></tr><tr><td align="left">teleportOther</td><td align="left">Messages requesting that an entity (A) is
              teleported to the same space as an entity (B) that is owned by
              this BaseApp.</td></tr><tr><td align="left">writeToDB</td><td align="left">Messages from the cell notifying the base
              entity to write itself to the database.</td></tr></tbody></table></div><p>The following table outlines some of the BaseApp interfaces that
      are used primarily to forward messages directly to the client without
      performing any processing. These message occur as a result of CellApp
      witnesses sending updates to their associated client.</p><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Interface Name</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">enterAoI</td><td align="left">Proxy message forwarded to client.</td></tr><tr><td align="left">enterAoIOnVehicle</td><td align="left">Proxy message forwarded to client.</td></tr><tr><td align="left">forcedPosition</td><td align="left">Proxy message forwarded to client.</td></tr><tr><td align="left">leaveAoI</td><td align="left">Proxy message forwarded to client.</td></tr><tr><td align="left">updateEntity</td><td align="left">Proxy message forwarded to client.</td></tr></tbody></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10151"></a>10.5.2.&nbsp;CellApp Interface Summary</h3></div></div></div><div class="altrow"><table border="1"><colgroup><col width="33%"><col width="67%"></colgroup><thead><tr><th>Interface Name</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">addCell</td><td align="left">Messages from a CellAppMgr to add a Cell
              into a Space.</td></tr><tr><td align="left">avatarUpdateExplicit</td><td align="left">Position updates from a Client connection to
              their entity.</td></tr><tr><td align="left">avatarUpdateImplicit</td><td align="left">Position updates from a Client connection to
              their entity.</td></tr><tr><td align="left">callBaseMethod</td><td align="left">Method calls occurring on a BaseViaCell
              mailbox.</td></tr><tr><td align="left">callClientMethod</td><td align="left">Method calls occurring on a ClientViaCell
              mailbox.</td></tr><tr><td align="left">callWatcher</td><td align="left">A forwarding watcher request from the
              corresponding manager process (i.e., CellAppMgr / BaseAppMgr).
              For more information see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a> section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#xref_Forwarding_Watchers" class="olink">Forwarding Watchers</a>.</td></tr><tr><td align="left">createEntity</td><td align="left">Requests to create a new entity within a
              Space.</td></tr><tr><td align="left">createEntityNearEntity</td><td align="left">Requests to create a new entity near to
              another Entity.</td></tr><tr><td align="left">createGhost</td><td align="left">Messages from other CellApps requesting a
              ghost entity is created for a new real entity in a nearby
              Cell.</td></tr><tr><td align="left">forwardedBaseEntityPacket</td><td align="left">Messages that are forwarded from a ghost
              entity to the real so that it may be provided to the base
              entity. This is used to avoid race conditions when offloading
              entities between CellApps.</td></tr><tr><td align="left">ghostAvatarUpdate</td><td align="left">Messages from nearby Cells updating ghost
              entities on the current CellApp of position changes.</td></tr><tr><td align="left">ghostHistoryEvent</td><td align="left">Messages sent from real entities that are
              being ghosted on the current CellApp providing history event
              updates.</td></tr><tr><td align="left">ghostedDataUpdate</td><td align="left">Messages from real entities updating ghosted
              properties.</td></tr><tr><td align="left">notifyOfCellRemoval</td><td align="left">Messages sent from the CellAppMgr to notify
              of a neighbouring cells removal.</td></tr><tr><td align="left">onload</td><td align="left">Messages sent from a nearby cell that is
              handing responsibility for a real entity over to the current
              CellApp.</td></tr><tr><td align="left">runExposedMethod</td><td align="left">Messages from Clients to run an
              <span class="literal">&lt;Exposed&gt;</span> method on an entity.</td></tr><tr><td align="left">runScriptMethod</td><td align="left">Messages from other server components to run
              a method on an entity.</td></tr><tr><td align="left">spaceData</td><td align="left">Messages from other CellApps notifying us of
              Space Data changes. For more information see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a> section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#xref_Space_Data" class="olink">Space Data</a>.</td></tr><tr><td align="left">writeToDBRequest</td><td align="left">Messages to entities to stream their
              information back to their base to be written to the
              database.</td></tr></tbody></table></div></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e9363" href="#d0e9363">22</a>] </sup>For information on <em class="parameter"><code>pyprofile</code></em> usage see the
        <code class="filename">control_cluster.py</code> help.</p><pre class="programlisting">$ control_cluster.py help pyprofile</pre></div><div class="footnote"><p><sup>[<a name="ftn.d0e9850" href="#d0e9850">23</a>] </sup>For more information on Mercury see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#Server_Overview" class="olink">Server Overview</a> section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Inter_Process_Communication_Mercury" class="olink">Inter-Process Communication (Mercury)</a>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Proxies_And_Players"></a>Chapter&nbsp;11.&nbsp;Proxies and Players</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e10274">11.1. Proxies</a></span></dt><dt><span class="section"><a href="#d0e10363">11.2. Witnesses</a></span></dt><dt><span class="section"><a href="#xref_Entity_Control">11.3. Entity Control</a></span></dt><dt><span class="section"><a href="#xref_Physics_Correction">11.4. Physics Correction</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10544">11.4.1. Avoiding Y-axis rubber-banding.</a></span></dt></dl></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10274"></a>11.1.&nbsp;Proxies</h2></div></div></div><p>The class
    <code class="classname">BigWorld</code>.<code class="classname">Proxy</code> on the
    BaseApp extends
    <code class="classname">BigWorld</code>.<code class="classname">Base</code> to support
    player-controlled entities. By deriving an entity from
    <code class="classname">BigWorld</code>.<code class="classname">Proxy</code>, you can
    implement player characters, their accounts, and any other relevant
    player-controlled objects on the server.</p><p>An entity derived from
    <code class="classname">BigWorld</code>.<code class="classname">Proxy</code> is created
    from the database whenever a client logs in to the server. For details on
    how BigWorld determines which Proxy to load, see <a href="#xref_User_Authentication_And_Proxy_Selection" title="Chapter&nbsp;20.&nbsp;User Authentication and Billing System Integration"><i xmlns:xlink="http://www.w3.org/1999/xlink">User Authentication and Billing System Integration</i></a>. Proxies created
    in this way (see below for other ways of creating proxies) which have a
    property called <code class="varname">password</code>, will have the value of that
    property set to the login password.</p><p>An instance of
    <code class="classname">BigWorld</code>.<code class="classname">Proxy</code> needs neither
    a cell entity, nor a client one. A proxy entity can be created using the
    method
    <code class="classname">BigWorld</code>.<code class="methodname">createBase</code>, just
    like any other entity. For more detail on this method, see <a href="#xref_Entity_Instantiation_On_The_BaseApp" title="7.1.&nbsp;Entity Instantiation on the BaseApp">Entity Instantiation on the BaseApp</a>.</p><p>Like other base entities, saving and loading proxy entities from the
    database is possible. Initially, these reloaded proxy entities will be
    created without an attached client. An existing proxy can later hand its
    client over to the reloaded one, in which case the reloaded proxy will be
    the one handling the client connection.</p><p>This allows you to have, for example, an
    <code class="classname">Account</code> entity that people can log in to, and a
    <code class="classname">Character</code> entity that people can select from a menu
    in order to use in the game.</p><p>To pass the control of a client from one proxy to another, use the
    method <code class="methodname">giveClientTo</code>, as in the example
    below:</p><pre class="programlisting">clientControlledProxy.giveClientTo( nonClientControlledProxy )</pre><p>Whenever a client moves between proxies, or the cell entity of the
    proxy that a client is attached to is destroyed, the client receives a
    call on <code class="methodname">onEntitiesReset</code> to clear out its current
    knowledge of the world. This effectively interrupts all game
    communications, and forces the client to refresh. If only the cell entity
    has been destroyed, then the client's knowledge of its proxy is
    retained.</p><p>If <code class="methodname">giveClientTo</code> does not succeed because of
    a problem with the destination proxy,
    <code class="methodname">onGiveClientToFailure</code> will be called on the
    origin proxy.</p><div class="informalfigure"><div class="mediaobject"><img src="images/baseapp_managing_bases_and_proxies.png"><span class="caption"><p>BaseApp managing bases and proxies</p></span></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10363"></a>11.2.&nbsp;Witnesses</h2></div></div></div><p>Whenever a proxy with an attached client has a corresponding cell
    entity, an extra object called witness is attached to the cell
    entity.</p><p>This object manages the entity's AoI, and sends updates to the
    proxy, which forwards them on to the client.</p><p>The updates consist of the bulk of game-related messages, such
    as:</p><div class="itemizedlist"><ul type="disc"><li><p>Entity position updates.</p></li><li><p>Entity property updates.</p></li><li><p>Method calls.</p></li><li><p>Space data changes.</p></li><li><p>Notifications of entities entering and leaving the AoI.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Entity_Control"></a>11.3.&nbsp;Entity Control</h2></div></div></div><p>By default, every cell entity is considered to be controlled by the
    server. When an entity incorporates a witness object, it is considered to
    be controlled by the client attached to the corresponding proxy.</p><p>However, the control of an entity may be explicitly assigned and
    queried, using the entity attribute .<code class="varname">controlledBy</code>. This
    attribute may be set to <span class="literal">None</span>, to indicate server
    control, or to a <code class="classname">BaseEntityMailBox</code> to indicate
    control by the client attached to that proxy. Within this context, control
    implies ownership of and responsibility for the entity's position and
    direction. Clients (and proxies) are informed of changes to the set of
    entities that they are allowed to control. Proxies may read this set
    through their attribute wards.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Physics_Correction"></a>11.4.&nbsp;Physics Correction</h2></div></div></div><p>When an entity is controlled by a client, setting the attribute
    <code class="classname">Entity</code>.<code class="varname">topSpeed</code> to a value
    greater than zero enables the physics checking. By default the
    <code class="varname">topSpeed</code> enables physics checking on all 3 axis,
    however this may not always be appropriate. For example, if the gravity of
    your game environment enables a Y-axis acceleration that results in a top
    speed exceeding the maximum allowable X/Z-axis top speed. In order to
    accommodate this there is a secondary attribute named
    <code class="classname">Entity</code>.<code class="varname">topSpeedY</code> which takes
    precedence when set to a value greater than zero.
    <code class="varname">topSpeedY</code> will only be used when both
    <code class="varname">topSpeed</code> and <code class="varname">topSpeedY</code> are greater
    than zero.</p><p>Entity movement is validated in the following ways:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Speed</em></p><p>The first check is regarding the speed, to ensure that it does
        not exceed <code class="varname">topSpeed</code> and
        <code class="varname">topSpeedY</code>. There is a small amount of variance
        allowed in speed to account for up to 150ms of network jitter. Care is
        taken so that this <em class="emphasis">latency debt</em> is not exploited
        by allowing the player to travel faster than the top speed for a brief
        period of time.</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Geometry of the scene</em></p><p>The second check is made against the geometry of the scene, to
        ensure that the entity only leaves its current chunk through a
        well-defined portal.</p><p>In spite of being very fast, this check does have consequences
        for level design. Barriers that control character mobility must be
        represented at the level of chunks. For example, a chunk with a wall
        across it, and a door giving access to the other side, is not
        protected by this physics checking system. In order to implement this
        in a manner to enable physics validation, two chunks should be used
        one on each side of the wall, with the door as a portal between
        them.</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Custom physics validator</em></p><p>If a custom physics validator has been developed, it will then
        be called between the top speed and the geometry checks. The custom
        physics validator is called with the following parameters:</p><div class="itemizedlist"><ul type="circle"><li><p>Pointer to the entity.</p></li><li><p>Pointer to the vehicle (<span class="literal">NULL</span> if the
            entity is not on a vehicle).</p></li><li><p>The position to which the entity wants to move.</p></li><li><p>The time elapsed since the last physics check.</p></li></ul></div><p>The custom physics validator should return
        <span class="literal">true</span> if the entity is allowed to move to the new
        position, or <span class="literal">false</span> if it is not allowed.</p><p>To install a custom physics validator, a CellApp extension
        module must be written. During the initialisation of the extension
        module, the global function pointer
        <code class="varname">g_customPhysicsValidator</code> (declared in
        <code class="filename">bigworld/src/server/cellapp/entity.hpp</code>) should be
        set to point to the custom physics validator function. For more
        details, see <a href="#xref_Extending_BigWorld_Server" title="Chapter&nbsp;25.&nbsp;Extending BigWorld Server"><i xmlns:xlink="http://www.w3.org/1999/xlink">Extending BigWorld Server</i></a>.</p></li></ul></div><p>Other scenarios in which physics checking is applied include:</p><div class="itemizedlist"><ul type="disc"><li><p>Control of multiple entities by the same client (such as
        wards).</p></li><li><p>Movement between vehicles (the ghost methods
        <code class="methodname">onPassengerAlightAttempt</code> and
        <code class="methodname">onPassengerBoardAttempt</code> are additionally
        called).</p></li><li><p>Movement to another space.</p></li></ul></div><p>When a server script directly sets the position or direction of an
    entity that is controlled by a client, the CellApp treats that as a
    physics correction. A new position and direction (sometimes referred to as
    the <em class="emphasis">pose</em>) are forced down to the client, and no
    future position and direction updates are accepted until the correction is
    acknowledged. This feature can be very useful for teleporting a player in
    response to some action or event on the server. Notably, the methods
    <code class="classname">Entity</code>.<code class="methodname">teleport</code>,
    <code class="classname">Entity</code>.<code class="methodname">boardVehicle</code> and
    <code class="classname">Entity</code>.<code class="methodname">alightVehicle</code> also
    adhere to this mechanism. Server-side teleports are the only way to move
    an entity between spaces.</p><p>While in most cases movement controllers would also result in
    downstream-forced positions, their use on client-controlled entities is
    neither recommended nor supported, since they continually set the position
    via a system intended for one-off adjustments.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10544"></a>11.4.1.&nbsp;Avoiding Y-axis rubber-banding.</h3></div></div></div><p>Due to the manner in which physics validation occurs, if a top
      speed has been exceeded, the server will force a position update to the
      client with the last known valid position. This however has the
      unfortunate side effect of producing an entity which doesn't fall if the
      top speed has been exceeded in the Y-axis. Setting the
      <code class="varname">topSpeedY</code> to be higher than
      <code class="varname">topSpeed</code> will help in this situation, but eventually,
      the Y-velocity will be greater than <code class="varname">topSpeedY</code> due to
      acceleration due to gravity when falling for long periods.</p><p>In order to produce a work around for this, it is recommended to
      write a custom physics validator while setting a large value for
      <code class="varname">topSpeedY</code>. The custom physics validator could then
      perform its own validation and update the entity position with a
      decreasing Y-position prior to returning <span class="literal">false</span>, and
      the updated position would then be forced to the client.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Entities_And_The_Universe"></a>Chapter&nbsp;12.&nbsp;Entities and the Universe</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e10583">12.1. Multiple Spaces</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10693">12.1.1. Spaces Pool</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Navigation_System">12.2. Navigation System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10708">12.2.1. Key Features</a></span></dt><dt><span class="section"><a href="#d0e10726">12.2.2. Navpoly Data Format</a></span></dt><dt><span class="section"><a href="#d0e10754">12.2.3. Script Interface</a></span></dt><dt><span class="section"><a href="#d0e10840">12.2.4. Navigate</a></span></dt><dt><span class="section"><a href="#d0e10879">12.2.5. Graph Searches</a></span></dt><dt><span class="section"><a href="#d0e10916">12.2.6. Auto-Generation of Navpoly Regions <span class="symbol">&#8208;</span> The NavGen Utility</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10992">12.3. Time</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10999">12.3.1. Real Time</a></span></dt><dt><span class="section"><a href="#d0e11004">12.3.2. Server Time</a></span></dt><dt><span class="section"><a href="#xref_Game_Time">12.3.3. Game Time</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Initialisation_Personality_Script_eload_And_runscript">12.4. Initialisation: Personality script, eload, and runscript</a></span></dt><dt><span class="section"><a href="#d0e11335">12.5. Global Data</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11345">12.5.1. <code class="varname">globalData</code>, <code class="varname">baseAppData</code> and
      <code class="varname">cellAppData</code></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Space_Data">12.6. Space Data</a></span></dt><dt><span class="section"><a href="#xref_Global_Bases">12.7. Global Bases</a></span></dt></dl></div><p>Entities in BigWorld are contained in the game universe. A universe is
  composed of spaces, which are composed of cells.</p><p>Each space can contain:</p><div class="itemizedlist"><ul type="disc"><li><p>Space Data for information that must be available to the entire
      space.</p></li><li><p>Geometry to define where entities can move.</p></li><li><p>Time of day, which is used by clients to determine day/night
      cycles.</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10583"></a>12.1.&nbsp;Multiple Spaces</h2></div></div></div><p>BigWorld supports having multiple separate geometric spaces in a
    universe. Each space can have a different set of geometry mapped into it,
    and a different set of entities existing within it. Each CellApp can
    handle multiple cells in different spaces.</p><div class="informalfigure"><div class="mediaobject"><img src="images/visualisation_of_spaces_and_division_in_cells.png"><span class="caption"><p>Visualisation of spaces and division in cells (cell
        boundaries marked in dotted lines)</p></span></div></div><p>Spaces are usually created by creating an entity in a new space. For
    this reason, every space needs at least one entity and as such once a
    space has no entities, it will cease to exist.</p><p>A common design technique to make this management easier is to
    create an entity <code class="classname">Space</code> (usually named after the
    space's purpose, <em class="emphasis">e.g.</em>,
    <code class="classname">Mission</code>, or <code class="classname">Quest</code>). Such an
    entity will be created in a new space, and then be responsible for
    configuring that space for game play to begin. Players can then teleport
    into the new space to explore it, play their mission, etc.</p><p>The general structure of this kind of entity is the illustrated in
    the code fragments below:</p><div class="itemizedlist"><ul type="disc"><li><p>Base script:</p><pre class="programlisting">class Space( BigWorld.Base ):

  def __init__( self ):
    # create our cell entity in a new space. self.onGetCell() will be
    # called when the cell entity is created.
    self.createInNewSpace()

  def onGetCell( self ):
    # create any predefined entities in the space
    # may want to use ResMgr to load details from an XML file
    
    # we want to make sure that each entity's createCellEntity()
    # method is passed the appropriate cell mailbox (this entity's
    # cell mailbox) so that it is created in the correct space
    # for example:
    BigWorld.createBase( "Monster", arguments, createOnCell=self.cell )</pre><p><span class="citetitle">Example file
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/Space.py</code></span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Cell script:</em></p><pre class="programlisting">class Space( BigWorld.Entity ):

  def __init__( self ):
    # Register our mailbox for getting the callback when the space
    # geometry finishes loading. You can choose any arbitrary string 
    # as the key so long you can find this entry again.
    BigWorld.cellAppData[ 'SpaceLoader:' + str(self.spaceID) ] = self

    # Add the geometry mapping. This maps the set of .chunk files we  
    # want into the space. BWPersonality.onAllSpaceGeometryLoaded will
    # be called when BigWorld finished loading the geometry.
    BigWorld.addSpaceGeometryMapping( self.spaceID, None, 
      "geometry/path" )

  def onGeometryLoaded( self ):
    # we can now also teleport in any additional entities that already
    # existed in the world (we'd probably store a mailbox somewhere in
    # the construction sequence to make this possible)
    # see the cell entity teleport() method for details
    playerMB.teleport( self, position, direction )</pre><p><span class="citetitle">Example file
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/Space.py</code></span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Cell personality script:</em></p><pre class="programlisting">def onAllSpaceGeometryLoaded( spaceID, isBootstrap, lastPath ):
  if (isBootstrap):
    # Find the registered loader and tell it to load the entities into
    # the space.
    loaderKey = 'SpaceLoader:' + str(spaceID)
    if BigWorld.cellAppData.has_key( loaderKey ):
      BigWorld.cellAppData[ loaderKey ].onGeometryLoaded();</pre><p><span class="citetitle">Example file
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/BWPersonality.py</code></span></p></li></ul></div><p>To create this entity, the code below would be written<sup>[<a name="d0e10656" href="#ftn.d0e10656">24</a>]</sup>:</p><pre class="programlisting">newSpace = BigWorld.createBaseAnywhere( "Space", ... )</pre><p>Notice that there are four key steps in this piece of code:
    </p><div class="orderedlist"><ol type="1"><li><p>Create the cell entity in a new space (in the
          <code class="methodname">__init__</code> method).</p></li><li><p>When the cell entity is created, map in any geometry that the
          space contains.</p></li><li><p>Create any entities that are required to be in the
          world.</p></li><li><p>When the space geometry is loaded, bring any required players
          into the space.</p></li></ol></div><p>It is likely that there will be management code specific to the
    style of space that is required (this code will be heavily dependant on
    your game's requirements). It is also possible to perform various steps
    between the cell and the base, depending on entity instantiation
    requirements.</p><p>When all entities in a space are removed, the space will be
    destroyed. Alternatively, any entity in the space can call the method
    <code class="classname">Entity</code>.<code class="methodname">destroySpace</code> to
    destroy the current space the entity exists in. Each entity in the space
    will have its method <code class="methodname">onSpaceGone</code> called before it
    is actually destroyed.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10693"></a>12.1.1.&nbsp;Spaces Pool</h3></div></div></div><p>When your game requires multiple instances of a space
      (<em class="emphasis">e.g.</em>, a mission space), it is advantageous to
      create a pool of reusable space instance during game startup.</p><p>This mechanism removes the need of later having to load chunks on
      demand, as when players request to enter a space, an instance will be
      chosen from the pool. After players leave the space, you can move the
      space back to the pool for later usage. This mechanism can greatly speed
      up the game loading for players on the server.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Navigation_System"></a>12.2.&nbsp;Navigation System</h2></div></div></div><p>The sub-sections below describe the features of the Navigation
    System.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10708"></a>12.2.1.&nbsp;Key Features</h3></div></div></div><p>The key features of the system are:</p><div class="itemizedlist"><ul type="disc"><li><p>Navigation of both indoor and outdoor chunks.</p></li><li><p>Seamless transition between indoor and outdoor regions.</p></li><li><p>Dynamic loading of navpoly graphs.</p></li><li><p>Paths caching, for efficiency.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10726"></a>12.2.2.&nbsp;Navpoly Data Format</h3></div></div></div><p>The world is broken up into chunks. Each chunk is a convex hull,
      and is uniquely identified by a chunk ID string,
      <em class="emphasis">e.g.</em>, <span class="literal">0000ffffo</span>.</p><p>For navigation purposes, each chunk is broken up into a set of
      convex polygonal prisms. Such a prism is known as navpoly, and is
      identified by an integer navpoly ID unique to a single chunk.</p><p>Each edge on a navpoly can be shared with the edge of an adjacent
      region. This means that movement between these two regions is allowed.
      Alternatively, an edge may be marked as being adjacent to a different
      chunk.</p><div class="informalfigure"><div class="mediaobject"><img src="images/navpoly_edge_demarcation.png"><span class="caption"><p>Navpoly edge demarcation</p></span></div></div><p>A navpoly also has a height associated with it. This is the
      maximum height of the navpoly region, such that the client can do a drop
      test from this Y value, and always end up on the bottom of the
      navpoly.</p><p>Vertices in the navpoly are defined in clockwise order, and have
      its XZ coordinates stored in the XY fields.</p><p>The third coordinate is used to store adjacency information for
      the edge formed between this vertex and the next. The value of this
      third coordinate is either the navpoly ID of the adjacent navpoly, or an
      encoding of an obstacle type. Edges on chunk boundaries are indicated by
      the presence of a separate tag for the adjacent chunk ID. In this case,
      the third vertex coordinate is not used.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10754"></a>12.2.3.&nbsp;Script Interface</h3></div></div></div><p>When an entity wants to navigate to a position, it uses the Python
      <code class="classname">Entity</code>.<code class="methodname">navigate</code> script
      method, like the example below:</p><pre class="programlisting">self.controllerId = self.navigate( position, velocity, userTag, girth )</pre><p>The parameters for the <code class="methodname">navigate</code> script
      method are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"> <em class="parameter"><code>position</code></em>
          </em> <span class="symbol">&#8208;</span> The destination
          position.</p></li><li><p><em class="emphasis"> <em class="parameter"><code>velocity</code></em>
          </em> <span class="symbol">&#8208;</span> Movement velocity in
          metres per second.</p></li><li><p><em class="emphasis"> <em class="parameter"><code>userTag</code></em>
          </em> <span class="symbol">&#8208;</span> Integer value passed to
          the navigation callback.</p></li><li><p><em class="emphasis"> <em class="parameter"><code>girth</code></em>
          </em> <span class="symbol">&#8208;</span> Minimum width of the
          gap that the entity can squeeze through.</p></li></ul></div><p>If there is no valid path to the destination, then navigate will
      fail, and throw a script exception. Otherwise, it will return a
      controller ID. This is a unique ID that can be used to cancel the
      movement request, like so:</p><pre class="programlisting">self.cancel( self.controllerID )</pre><p>When the movement is complete, the entity's
      <code class="methodname">onNavigate</code> method will be called, with the
      <code class="varname">controllerId</code> and <code class="varname">userId</code> as
      arguments. At this stage, all resources related to the controller have
      been released, and there is no need to free them by calling
      <code class="classname">Entity</code>.<code class="methodname">cancel</code>.</p><pre class="programlisting">self.onNavigate( controllerId, userId )</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10840"></a>12.2.4.&nbsp;Navigate</h3></div></div></div><p>When the
      <code class="classname">Entity</code>.<code class="methodname">navigate</code> script
      method is called, the server performs the following steps:</p><div class="orderedlist"><ol type="1"><li><p>Resolve the <span class="literal">ChunkID</span> and
          <span class="literal">WaypointID</span> from the source location.</p></li><li><p>Resolve the <span class="literal">ChunkID</span> and
          <span class="literal">WaypointID</span> from the destination location.</p></li><li><p>If the <span class="literal">ChunkID</span>s are different, then perform
          a graph search on the chunk level. Otherwise, if the
          <span class="literal">WaypointID</span>s are different, then perform a graph
          search on the navpoly level. If both these tests fail, move in a
          straight line to the specified position.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10879"></a>12.2.5.&nbsp;Graph Searches</h3></div></div></div><p>An A* search is used for both the chunk graph search and the
      navpoly graph search. The <code class="classname">ChunkState</code> and
      <code class="classname">WaypointState</code> classes both implement the
      interface required for an A* search, and are used to search the chunk
      and navpoly graphs respectively.</p><p>The chunk graph is searched by using the centre of each chunk for
      calculating distances.</p><p>Distances on the navpoly graph are calculated based on the actual
      path that would be taken through the navpolys.</p><p>Given a source location inside the navpoly, and a destination
      location outside the navpoly, the algorithm is as follows:</p><div class="itemizedlist"><ul type="disc"><li><p>Find the point where the direct line from source to
          destination would intersect the polygon border.</p></li><li><p>If this point is on an edge that has an adjacency, move
          directly to the point of intersection.</p></li><li><p>Otherwise, move to a vertex that has an adjacency, such that
          the angle between this path and the desired path is
          minimised.</p></li></ul></div><p>This is a simple approach, and not always optimal, but works
      properly in most cases.</p><p>The <code class="classname">PathCache</code> class is used as a wrapper
      for performing both chunk and navpoly graph searches. It caches one path
      per entity, and also stores the current hop index within that path. Each
      time a graph search would take place, the
      <code class="classname">PathCache</code> checks if the goal is the same as the
      cached goal. If so, then the next state in the path is returned, and the
      hop index is incremented, if appropriate.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10916"></a>12.2.6.&nbsp;Auto-Generation of Navpoly Regions <span class="symbol">&#8208;</span> The NavGen Utility</h3></div></div></div><p>Based on terrain and other geometric information in the chunk
      files (named
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/spaces/&lt;space&gt;/<em class="replaceable"><code>&lt;chunk_ID&gt;</code></em>.chunk</code><sup>[<a name="d0e10931" href="#ftn.d0e10931">25</a>]</sup>), the NavGen utility creates the convex navpoly polygonal
      prisms in two phases:</p><div class="orderedlist"><ol type="1"><li><p>It flood fills each chunk, using client physics rules.</p></li><li><p>It uses a BSP to recursively subdivide the space and form
          convex polygonal prisms.</p></li></ol></div><p>It writes the results in the binary <code class="filename">.cdata</code> files<sup>[<a name="d0e10951" href="#ftn.d0e10951">26</a>]</sup>.</p><p>The NavGen utility handles multiple vertical levels within a chunk
      (bridges, tunnels, etc...). It uses a multi-pass algorithm to analyse
      and describe the connectedness of such scenes.</p><p>NavGen's XML configuration file
      <code class="filename"><em class="replaceable"><code>&lt;bwclient_source_folder&gt;</code></em>/../tools/misc/navgen_settings.xml</code>
      accounts for different entity profiles, such as their size and other
      physical properties. This is represented by the <span class="literal">girth</span>
      value. Multiple girths may be specified, in which case multiple
      navigation meshes will be generated and maintained. For each girth,
      different physical parameters may be set (<em class="emphasis">e.g.</em>,
      there is a flood fill parameter for the entity's height). A setting of
      2.0 metres is good default for humanoid entities.</p><p>For more details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_NavGen" class="olink"><i>NavGen</i></a>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10992"></a>12.3.&nbsp;Time</h2></div></div></div><p>We have seen how entities define how different pieces of a game can
    behave. Game play involves changing entities' states over time, and so it
    is important to have a good understanding of how time is managed in the
    BigWorld environment.</p><p>It helps to think about different types of time when discussing time
    in BigWorld. These types are discussed in the following
    sub-sections.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10999"></a>12.3.1.&nbsp;Real Time</h3></div></div></div><p>Real Time is simply the time on a clock in the real world. Real
      time is used as the basis for defining the other types of time in
      BigWorld.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e11004"></a>12.3.2.&nbsp;Server Time</h3></div></div></div><p>On the server, game time is incremented in discrete units, based
      on the <code class="property">&lt;gameUpdateHertz&gt;</code> configuration option
      in
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/server/bw.xml</code><sup>[<a name="d0e11016" href="#ftn.d0e11016">27</a>]</sup>.</p><p>The server keeps an integer counter that is incremented at this
      rate and whose initial value at server startup is
      <span class="literal">0</span>.</p><p>To calculate the server time in seconds, the following formula is
      used:</p><pre class="programlisting">serverTime = serverTimestamp / gameUpdateHertz</pre><p>This is approximately:</p><pre class="programlisting">serverTime ~= currentRealTime - serverStartRealTime</pre><p>Each client machine calculates a synchronised version of this
      time, available via the
      <code class="classname">BigWorld</code>.<code class="methodname">serverTime</code>
      script method.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Game_Time"></a>12.3.3.&nbsp;Game Time</h3></div></div></div><p>Game Time is the time sensed by the players in the game
      world.</p><p>A massively online persistent game usually has virtual days and
      months in its virtual world. You might want to run one game world hour
      for every hour of Real Time, for example. In order to support this,
      BigWorld has a standard piece of space data used to calculate the time
      of day<sup>[<a name="d0e11057" href="#ftn.d0e11057">28</a>]</sup>.</p><p>This space data records the following numbers:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">initialTimeOfDay</span></em> <span class="symbol">&#8208;</span> Game Time when server started.</p></li><li><p><em class="emphasis"><span class="literal">gameSecondsPerSecond</span></em>
          <span class="symbol">&#8208;</span> Conversion factor, from Server Time
          update rate to Real Time.</p></li></ul></div><p>They are used together to define Game Time as:</p><pre class="programlisting">gameTimeOfDay = ( serverTime - initialTimeOfDay ) * gameSecondsPerSecond</pre><p>To modify game time for an entire space a CellApp Python method
      called
      <code class="classname">BigWorld</code>.<code class="methodname">setSpaceTimeOfDay</code>
      can be used. This method takes three parameters as follows:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><em class="parameter"><code>spaceID</code></em></em> <span class="symbol">&#8208;</span> The ID of the space which should be
          effected.</p></li><li><p><em class="emphasis"><em class="parameter"><code>initialTimeOfDay</code></em></em>
          <span class="symbol">&#8208;</span> The time of day at server
          startup.</p></li><li><p><em class="emphasis"><em class="parameter"><code>gameSecondsPerSecond</code></em></em>
          <span class="symbol">&#8208;</span> The number of game seconds that
          pass for each real time second.</p></li></ul></div><p>To modify only client side visualisation based on time, refer to
      the Client Python method
      <code class="classname">BigWorld</code>.<code class="methodname">spaceTimeOfDay</code>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Initialisation_Personality_Script_eload_And_runscript"></a>12.4.&nbsp;Initialisation: Personality script, eload, and runscript</h2></div></div></div><p>By default, when the server is started, a single
    <em class="emphasis">default</em> space is created, containing no entities and
    no geometry. In order to make a game interesting, scripts must populate
    this space, and possibly create other spaces to also populate. While the
    server is running, you might wish to run specialist scripts to change
    properties of elements within the world. These tasks can be completed
    using the personality script, and two server side tools: eload and
    runscript.</p><p>The personality script can contain a Python function to be executed
    on every BaseApp right after there is an available CellApp running. In
    this way, it is guaranteed that you can create both cell and base entities
    from the script.</p><p>The script to be executed is specified in the file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/server/bw.xml</code>,
    as in the example below:</p><pre class="programlisting">&lt;root&gt;
  ...
  &lt;<em class="emphasis">personality</em>&gt; <em class="emphasis">personalityscript</em> &lt;/personality&gt;
  ...
&lt;/root&gt;</pre><p><span class="citetitle">Example file
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/server/bw.xml</code>
    <span class="symbol">&#8208;</span> Declaring the personality
    script</span></p><p>The corresponding file (following the example above would be
    <code class="filename">personalityscript.py</code>) is placed in the directory
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base</code>,
    to be executed at the appropriate time.</p><p>If a personality script is not defined, then the default filename
    <code class="filename">BWPersonality.py</code> is used.</p><p>The method <code class="methodname">onBaseAppReady</code> in the
    personality script is called by the BaseApp. The method receives one
    Boolean argument, whose values are defined below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">True</span></em> <span class="symbol">&#8208;</span> If the BaseApp is the first one ready in the
        server clusters.</p></li><li><p><em class="emphasis"><span class="literal">False</span></em>
        <span class="symbol">&#8208;</span> If the BaseApp is not the first ready
        in the cluster.</p></li></ul></div><p>The personality script can call any BigWorld module method, and it
    is the recommended point to perform the following:</p><div class="itemizedlist"><ul type="disc"><li><p>Add geometry to the space by calling
        <code class="methodname">addSpaceGeometryMapping</code> from a cell
        entity.</p></li><li><p>Initialise the game time by calling method
        <code class="methodname">setSpaceTimeOfDay</code> from a cell entity. For
        more details, see <a href="#xref_Game_Time" title="12.3.3.&nbsp;Game Time">Game Time</a>.</p></li><li><p>Initialise any custom space data. For more details, see <a href="#xref_Space_Data" title="12.6.&nbsp;Space Data">Space Data</a>.</p></li><li><p>Populate the world by creating entities.</p></li></ul></div><p>During the execution of the personality script functions, the
    BaseApp cannot respond to messages received from other server components.
    A time-consuming personality script is likely to timeout the BaseApp from
    the server clusters. It is recommended to spread the entity creation in a
    timely manner for a smooth and robust startup.</p><p>The example is illustrated below, with code on the personality,
    base, and client scripts.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">In the personality
        script:</em></p><pre class="programlisting">...
def <em class="emphasis">onBaseAppReady</em>( bool isBootStrap ):
  if isBootStrap:
    BigWorld.createBase( "SpaceManager", {}, {} )
    BigWorld.createBase( "EntityLoaderManager", {}, {} )
  # every BaseApp needs an EntityLoader
  BigWorld.createBase( "EntityLoader", {}, {} )
...</pre><p><span class="citetitle">Example personality script
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/&lt;personality_script_name&gt;.py</code></span></p></li><li><p><em class="emphasis">On the </em><em class="emphasis">BaseApp:</em></p><pre class="programlisting">class <em class="emphasis">SpaceManager</em>( BigWorld.Base ):
  def <em class="emphasis">__init__</em>( self ):
    # create the cell entity in a new space
    self.createInNewSpace( (0,0,0), (0,0,0), None )

class <em class="emphasis">EntityLoaderManager</em>( BigWorld.Base ):
  def <em class="emphasis">__init__</em>( self ):
    # register globally under a well-known name (ELM for example)
    # so the EntityLoaders can register with me
    self.registerGlobally( "ELM", onRegister )
    # add a timer that calls back every 1 second.
    # User data is 999 (only for identification purpose)
    self.addTimer( 1, 1, 999 )

  def <em class="emphasis">onRegister</em>( self, succeeded ):
    # callback from registerGlobally(). Argument succeeded should always
    # be True there is only one EntityLoaderManager in whole system
    if not succeeded:
      # should not be possible, try re-register
      self.registerGlobally( "ELM", onRegister )

  def <em class="emphasis">registerLoader</em>( self, entityLoader ):
    # append the mailbox of an entityLoader into our list
    # might have to verify it is not re-registered though
    self.entityLoaderList.append( entityLoader )

  def <em class="emphasis">onTimer</em>( self, timerId, userData ):
    if userData == 999:
      # distribute entity creation tasks to every registered
      # EntityLoader in a load spreading manner
      for i in range( len( self.entityLoaderList ) ):
        # prepare the argument for entity creation
        args = ...
        self.entityLoaderList[i].createEntities( args )
      if allJobFinished:
        # remove the timer if not required any more
        delTimer( timerId )

class <em class="emphasis">EntityLoader</em>( BigWorld.Base ):
  def <em class="emphasis">__init__</em>( self ):
    self.registerWithELM()

  def <em class="emphasis">registerWithELM</em>():
    if BigWorld.globalBases.has_key( "ELM" ):
      # if EntityLoaderManager is available register with it now
      elm = BigWorld.globalBases["ELM"]
      elm.registerLoader( self )
    else:
      # otherwise wait a bit
      self.addTimer( 1 )

  def <em class="emphasis">onTimer</em>( self, timerId, userData ):
    # retry registering
    self.registerWithELM()

  def <em class="emphasis">createEntities</em>( self, args ):
    # create the entities according to the arguments</pre><p><span class="citetitle">Example file
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/base/SpaceManager.py</code></span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">On the CellApp:</em></p><pre class="programlisting">class SpaceManager( BigWorld.Entity ):
  def __init__( self ):
    # add the geometry mapping
    # this maps the set of .chunk files we want into the space
    BigWorld.addSpaceGeometryMapping( self.spaceID, None, "geometry/path" )</pre><p><span class="citetitle">Example file
        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/SpaceManager.py</span></span></p></li></ul></div><p>For details on <span class="literal">eload</span> and
    <span class="literal">runscript</span>, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Admin_Tools" class="olink"><i>Cluster Administration Tools</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Command_Line_Utilities" class="olink">Server Command-Line Utilities</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e11335"></a>12.5.&nbsp;Global Data</h2></div></div></div><p>BigWorld offers several mechanisms for distributing
    <em class="emphasis">global</em> data to its components. Most of these
    mechanisms also offer callbacks when a particular piece of global data is
    modified, effectively turning them into global event distribution
    mechanisms as well.</p><p>As with most programming environments, global data should be treated
    with care, due to the challenges they pose to code maintenance. In a
    distributed system like BigWorld, globals should be used even more
    sparingly, because of the performance impact of data distribution, as well
    as the risk of race conditions.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e11345"></a>12.5.1.&nbsp;<code class="varname">globalData</code>, <code class="varname">baseAppData</code> and
      <code class="varname">cellAppData</code></h3></div></div></div><p>BigWorld offers three Python dictionaries that are replicated
      across BigWorld components. They differ in their scope of
      replication:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="classname">BigWorld</code>.<code class="varname">globalData</code></em>
          <span class="symbol">&#8208;</span> Replicated on all BaseApps and
          CellApps.</p></li><li><p><em class="emphasis"><code class="classname">BigWorld</code>.<code class="varname">baseAppData</code></em>
          <span class="symbol">&#8208;</span> Replicated on all BaseApps.</p></li><li><p><em class="emphasis"><code class="classname">BigWorld</code>.<code class="varname">cellAppData</code></em>
          <span class="symbol">&#8208;</span> Replicated on all CellApps.</p></li></ul></div><p>The keys and values must be pickle-able Python objects. The value
      type can be any pickle-able Python object. If the value is a BigWorld
      entity, then it is converted to a mailbox on components where the entity
      does not currently reside.</p><p>The following callbacks are invoked when items in the dictionary
      are modified:</p><div class="altrow"><table border="0" width="75%"><colgroup><col width="20%"><col width="40%"><col width="40%"></colgroup><thead><tr><th align="left">Global Data</th><th align="left">Added or modified</th><th align="left">Deleted</th></tr></thead><tbody><tr><td align="left"><code class="varname">baseAppData</code></td><td align="left"><code class="classname">BWPersonality</code>.<code class="methodname">onBaseAppData</code></td><td align="left"><code class="classname">BWPersonality</code>.<code class="methodname">onDelBaseAppData</code></td></tr><tr><td align="left"><code class="varname">cellAppData</code></td><td align="left"><code class="classname">BWPersonality</code>.<code class="methodname">onCellAppData</code></td><td align="left"><code class="classname">BWPersonality</code>.<code class="methodname">onDelCellAppData</code></td></tr><tr><td align="left"><code class="varname">globalData</code></td><td align="left"><code class="classname">BWPersonality</code><code class="methodname">onGlobalData</code></td><td align="left"><code class="classname">BWPersonality</code><code class="methodname">onDelGlobalData</code></td></tr></tbody></table></div><p><span class="citetitle">Callbacks invoked by manipulating global
      data.</span></p><p>BigWorld only detects an item change if it is assigned to a
      different object, not when part of the object is changed. For
      example:</p><pre class="programlisting">BigWorld.globalData[ "list" ] = [1, 2, 3]   # addition is detected
BigWorld.globalData[ "list" ][1] = 7        # modification not detected
BigWorld.globalData[ "list" ] = [3, 4, 5]   # modification is detected</pre><p>If the modification is not detected, then the change will not
      replicated to other components, resulting in inconsistency between the
      local and remote copies.</p><p>Each value object is pickled individually. This results in the
      value being a copy of the original. For example:</p><pre class="programlisting">drinks = [ "juice", "wine" ]
# BigWorld.globalData[ "fridge" ] will have its own copy of [ "juice","wine" ]
BigWorld.globalData[ "fridge" ] = drinks
# BigWorld.globalData[ "cupboard" ] will have its own copy of [ "juice","wine" ]
BigWorld.globalData[ "cupboard" ] = drinks</pre><p>If multiple components concurrently modify the same item in the
      dictionary, then a central authority will determine the order of
      modifications. For <code class="varname">globalData</code> and
      <code class="varname">cellAppData</code>, the authority is CellAppMgr; for
      <code class="varname">baseAppData</code>, the authority is BaseAppMgr.</p><p>Callbacks for the modifications will be called in the order
      determined by the authority. In the components where the modifications
      took place, the dictionary item will temporarily have the value of the
      local modification before it is overridden by the value determined by
      the authority. Therefore, it is recommended that any actions that should
      take place after a change to global data be placed in the callback
      functions instead of inline with the code that changes the value of
      global data. For example:</p><pre class="programlisting">def someFunction( ):
  BigWorld.globalData[ "mode" ] = 3
  # Should not put actions for mode 3 here. Otherwise there is a risk
  # that it will be performed in a different order on different
  # components

# In BWPersonality.py
def onGlobalData( key, value ):
  if ((key == "mode") and (value == 3)):
    # Do actions for mode 3</pre><p>In addition to the components where <code class="varname">globalData</code>,
      <code class="varname">baseAppData</code> and <code class="varname">cellAppData</code> are
      replicated, the dictionaries are also backed up to the following
      locations:</p><div class="altrow"><table border="0" width="50%"><colgroup><col width="25%"><col width="25%"><col width="25%"><col width="25%"></colgroup><thead><tr><th align="left">Global Data</th><th align="left">BaseAppMgr</th><th align="left">CellAppMgr</th><th align="left">Database</th></tr></thead><tbody><tr><td align="left"><code class="varname">baseAppData</code></td><td align="left"><span class="symbol">&#10003;</span></td><td align="left"><span class="symbol">&#10007;</span></td><td align="left"><span class="symbol">&#10007;</span></td></tr><tr><td align="left"><code class="varname">cellAppData</code></td><td align="left"><span class="symbol">&#10007;</span></td><td align="left"><span class="symbol">&#10003;</span></td><td align="left"><span class="symbol">&#10007;</span></td></tr><tr><td align="left"><code class="varname">globalData</code></td><td align="left"><span class="symbol">&#10003;</span></td><td align="left"><span class="symbol">&#10003;</span></td><td align="left"><span class="symbol">&#10007;</span></td></tr></tbody></table></div><p><span class="citetitle">Locations to which dictionaries are backed
      up.</span></p><p>The backup copies are used in the case of a component failure.
      However, since the dictionaries are never backed up to the database, in
      the event of entire server failure, these dictionaries will be empty
      after disaster recovery has completed.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Space_Data"></a>12.6.&nbsp;Space Data</h2></div></div></div><p>Space data is a means to distribute global data across the cell and
    client. It can be used for data that should be transmitted to the client,
    but does not fit in the entity structure. Such examples, which are built
    into BigWorld itself, include:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Time of day </em><span class="symbol">&#8208;</span> Two <span class="type">float</span>s containing data that
        allows BigWorld to translate Server Time to Game Time.</p></li><li><p><em class="emphasis">Space geometry</em> <span class="symbol">&#8208;</span> String describing which geometries are mapped
        into a space.</p></li></ul></div><p>Space data consists of a 16-bit integer index, and a string. By
    packing various types into a string, it can represent any
    application-defined data type.</p><p>A piece of space data can be set by calling the method
    <code class="classname">BigWorld</code>.<code class="methodname">setSpaceData</code> on
    the cell.</p><p>The function takes the parameters described below:</p><div class="altrow"><table border="0"><colgroup><col width="20%"><col width="80%"></colgroup><thead><tr><th align="left">Parameter</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><em class="parameter"><code>spaceID</code></em></td><td align="left"><p>The space in which to set the space
              data.</p><p>Each space has its own unique set of space
              data, which is never shared between spaces.</p></td></tr><tr><td align="left"><em class="parameter"><code>key</code></em></td><td align="left"><p>A 16-bit integer index identifying
              which piece of space data to set.</p><p>All indices less
              than 256 are reserved for internal BigWorld usage, so games
              developers must choose values greater than or equal to 256
              (<code class="varname">SPACE_DATA_FIRST_USER_KEY</code>).</p><p>For
              keys less than 16,384
              (<code class="varname">SPACE_DATA_FIRST_CELL_ONLY_KEY</code>), space data
              is automatically sent to clients.</p></td></tr><tr><td align="left"><em class="parameter"><code>value</code></em></td><td align="left"><p>A string to set as the current space
              data value for this key.</p></td></tr></tbody></table></div><p><span class="citetitle"><code class="classname">BigWorld</code>.<code class="methodname">setSpaceData</code>
    parameters.</span></p><p>When space data is set, a space data entry ID is returned. The entry
    ID and the <code class="varname">key</code> can be used to retrieve the space data
    using the
    <code class="classname">BigWorld</code>.<code class="methodname">getSpaceData</code>
    method. Entry ID is required because BigWorld supports having multiple
    space data entries with the same key using the method
    <code class="classname">BigWorld</code>.<code class="methodname">addSpaceData</code>. All
    entries for a particular key can be retrieved using
    <code class="classname">BigWorld</code>.<code class="methodname">getSpaceDataForKey</code>.</p><p>For keys that should never have more than one entry, the method
    <code class="classname">BigWorld</code>.<code class="methodname">getSpaceDataFirstForKey</code>
    can be used to retrieve a space data entry with only the key. The method
    returns the first entry with the specified key. The ordering of entries is
    guaranteed to be the same across all CellApps.</p><p>When multiple CellApps simultaneously call
    <code class="classname">BigWorld</code>.<code class="methodname">setSpaceData</code> with
    the same key, there is a small possibility that both entries are kept by
    BigWorld. In this case,
    <code class="classname">BigWorld</code>.<code class="methodname">getSpaceDataForKey()</code>
    would return many entries. But since
    <code class="classname">BigWorld</code>.<code class="methodname">getSpaceDataFirstForKey()</code>
    is more commonly used for keys that should have only one entry, the
    situation is usually resolved automatically.</p><p>Whenever a new space data value is added,
    <code class="methodname">onSpaceData</code> is called on the personality script.
    For more details, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/cellapp/index.html#Client_Python_API" class="olink">Client Python API</a>'s entry
    <em class="emphasis">Main Page <span class="symbol">&#8594;</span> Cell
    <span class="symbol">&#8594;</span> BW Personality <span class="symbol">&#8594;</span> Functions <span class="symbol">&#8594;</span> <span class="literal">
    onSpaceData</span></em>.</p><p>Space data is backed up to the CellAppMgr as well as the database.
    Space data is preserved in all failure scenarios handled by the BigWorld
    server.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Global_Bases"></a>12.7.&nbsp;Global Bases</h2></div></div></div><p>BigWorld provides a registry of base entity mailboxes that is
    replicated on all BaseApps. Base entities represented in this registry are
    referred to as global bases, and their mailbox can be retrieved by name on
    all BaseApps.</p><p>In order to give a name in the global registry to a base entity, you
    can call its method <span class="literal">registerGlobally</span><sup>[<a name="d0e11736" href="#ftn.d0e11736">29</a>]</sup>. This method takes the following parameters:</p><div class="itemizedlist"><ul type="disc"><li><p>A name for the base entity to register as.</p></li><li><p>A callback function to be called when the registration is
        complete or has failed. The callback function is called with a single
        Boolean parameter indicating if the registration was
        successful.</p></li></ul></div><p>The method <code class="methodname">registerGlobally</code> can be called
    multiple times on a single entity with different names. It is not allowed
    to register two different entities (or the same entity twice) with the
    same name.</p><p>The BaseApp contains the object
    <code class="classname">BigWorld</code>.<code class="varname">globalBases</code>, which
    emulates a read-only Python dictionary that provides information on global
    bases.</p><p>The object
    <code class="classname">BigWorld</code>.<code class="varname">globalBases</code> can be used
    as illustrated below:</p><pre class="programlisting">print "The main mission entity is", BigWorld.globalBases["MainMission"]
print "There are", len( BigWorld.globalBases ), "global bases."</pre><p><span class="citetitle">Using the BaseApp's object
    <code class="classname">BigWorld</code>.<code class="varname">globalBases</code> to retrieve
    information on global bases</span></p><p>Things to consider when using global bases include:</p><div class="itemizedlist"><ul type="disc"><li><p>Remember that global bases are not actually distributed
        themselves, only their mailboxes are. You may not want these entities
        to be accessed frequently by many different entities, as it could
        affect the scalability as more players log in.</p></li><li><p>Often the game design will require an interaction to locate many
        entities that might otherwise be considered global. For example,
        perhaps a conversation with a faction leader is required to join that
        faction, and as such might remove the need to declare that an entity
        is global.</p></li></ul></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e10656" href="#d0e10656">24</a>] </sup>This entity creation would normally be initiated from a client
        side action such as a "Create Mission" user interface option, or from
        a player entering a dungeon portal.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e10931" href="#d0e10931">25</a>] </sup>For details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_chunk_o_chunk_chunk_i_chunk" class="olink"><i><span class="literal">.chunk</span></i></a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e10951" href="#d0e10951">26</a>] </sup>For details on the information held by this and other chunk
          files, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../client_programming_guide/client_programming_guide.html#Client_Programming_Guide" class="olink">Client Programming Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../client_programming_guide/client_programming_guide.html#xref_Chunks" class="olink"><i>Chunks</i></a>
          <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../client_programming_guide/client_programming_guide.html#xref_Implementation_Files" class="olink">Implementation files</a>. For details on <code class="filename">.cdata</code> files' grammar, see the document
          <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_chunk_cdata" class="olink"><i><span class="literal">.cdata</span></i></a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e11016" href="#d0e11016">27</a>] </sup>For details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_General_Configuration_Options" class="olink">General Configuration Options</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e11057" href="#d0e11057">28</a>] </sup>For more details on space data, see <a href="#xref_Space_Data" title="12.6.&nbsp;Space Data">Space Data</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e11736" href="#d0e11736">29</a>] </sup>You can remove an entity from the global bases registry with its
        method <code class="methodname">deregisterGlobally</code>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_XML_Data_File_Access"></a>Chapter&nbsp;13.&nbsp;XML Data File Access</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e11794">13.1. <code class="classname">ResMgr</code>.<code class="classname">DataSection</code></a></span></dt><dt><span class="section"><a href="#xref_Accessing_Data">13.2. Accessing Data</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11836">13.2.1. Opening a Section Within an XML File</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11851">13.3. Data Types</a></span></dt><dt><span class="section"><a href="#d0e11953">13.4. Writing Data</a></span></dt><dt><span class="section"><a href="#d0e12017">13.5. Performance Issues</a></span></dt><dt><span class="section"><a href="#d0e12026">13.6. API Reference</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e11794"></a>13.1.&nbsp;<code class="classname">ResMgr</code>.<code class="classname">DataSection</code></h2></div></div></div><p>Server component scripting can access custom data stored in XML
    files. These would typically be used to store game data resources, for
    example, anything from gameplay tables to configuration data. The data is
    stored in an XML hierarchy, accessible by traversing the tree defined in
    the each XML file.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Accessing_Data"></a>13.2.&nbsp;Accessing Data</h2></div></div></div><p>Suppose that a data file is defined as in the example below:</p><pre class="programlisting">&lt;root&gt;
   &lt;character&gt;     Sir Manfred
      &lt;description&gt; White knight                       &lt;/description&gt;
      &lt;modelName&gt;   sets/main/characters/knight.model  &lt;/modelName&gt;
      &lt;race&gt;        human                              &lt;/race&gt;
      &lt;gender&gt;      0                                  &lt;/gender&gt;
   &lt;/character&gt;

   &lt;character&gt;     Sofia
      &lt;description&gt; Evil queen                         &lt;/description&gt;
      &lt;modelName&gt;   sets/main/characters/queen.model   &lt;/modelName&gt;
      &lt;race&gt;        undead                             &lt;/race&gt;
      &lt;gender&gt;      1                                  &lt;/gender&gt;

      &lt;slaves&gt;
         &lt;character&gt;     Underling
           &lt;description&gt; Hapless underling                   &lt;/description&gt;
           &lt;modelName&gt;   sets/main/characters/guard.model    &lt;/modelName&gt;
           &lt;race&gt;        undead                              &lt;/race&gt;
           &lt;gender&gt;      1                                    &lt;/gender&gt;
         &lt;/character&gt;

         &lt;character&gt;      Servant
            &lt;description&gt; Unpaid slave                       &lt;/description&gt;
            &lt;modelName&gt;   sets/main/characters/servant.model &lt;/modelName&gt;
            &lt;race&gt;        undead                             &lt;/race&gt;
            &lt;gender&gt;      1                                  &lt;/gender&gt;
         &lt;/character&gt;
      &lt;/slaves&gt;
   &lt;/character&gt;
&lt;/root&gt;</pre><p><span class="citetitle">Example XML file <span class="symbol">&#8208;</span>
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/data/Characters.xml</code></span></p><p>You can access this data by creating a new
    <code class="classname">DataSection</code> using the
    <code class="classname">ResMgr</code>.<code class="methodname">openSection</code> method.
    The path argument used is relative to the resources path. This is
    illustrated in the example below:</p><pre class="programlisting">ds = ResMgr.openSection( 'scripts/data/Characters.xml' )

# this will retrieve "Sir Manfred"
ds.child( 0 ).asString

# this will retrieve "White knight"
ds.child( 0 )['description'].asString

# this will retrieve 1
ds.child( 0 )['gender'].asInt</pre><p><span class="citetitle">Reading an XML data file</span></p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e11836"></a>13.2.1.&nbsp;Opening a Section Within an XML File</h3></div></div></div><p>You can access a section within the XML file by adding the name of
      the section to the end of the path given to ResMgr.openSection:</p><pre class="programlisting">dsChild = ResMgr.openSection(
  'scripts/data/Characters.xml/character' )</pre><p><em class="emphasis">Reading an XML data file <span class="symbol">&#8208;</span> Accessing a specific section</em></p><p>If there are multiple elements with the same under the root
      element, then the first one is returned.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e11851"></a>13.3.&nbsp;Data Types</h2></div></div></div><p>The available data types are:</p><div class="altrow"><table border="0" width="40%"><colgroup><col width="55%"><col width="45%"></colgroup><thead><tr><th align="left">Data type</th><th align="left">Accessed by</th></tr></thead><tbody><tr><td align="left">64-bit floating-point numbers</td><td align="left"><code class="methodname">.asDouble</code></td></tr><tr><td align="left">64-bit integers</td><td align="left"><code class="methodname">.asInt64</code></td></tr><tr><td align="left">Data blob</td><td align="left"><code class="methodname">.asBlob</code></td></tr><tr><td align="left">Floating-point numbers</td><td align="left"><code class="methodname">.asFloat</code></td></tr><tr><td align="left">Integers</td><td align="left"><code class="methodname">.asInt</code></td></tr><tr><td align="left">Matrix</td><td align="left"><code class="methodname">.asMatrix</code></td></tr><tr><td align="left">Raw binary representation of the XML
              node</td><td align="left"><code class="methodname">.asBinary</code></td></tr><tr><td align="left">String</td><td align="left"><code class="methodname">.asString</code></td></tr><tr><td align="left">Vector2</td><td align="left"><code class="methodname">.asVector2</code></td></tr><tr><td align="left">Vector3</td><td align="left"><code class="methodname">.asVector3</code></td></tr><tr><td align="left">Vector4</td><td align="left"><code class="methodname">.asVector4</code></td></tr><tr><td align="left">Wide strings</td><td align="left"><code class="methodname">.asWideString</code></td></tr></tbody></table></div><p><span class="citetitle">Available data types in
    XML</span></p><p>For more details, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>'s
    entry <em class="emphasis">Class List <span class="symbol">&#8594;</span> DataSection</em>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e11953"></a>13.4.&nbsp;Writing Data</h2></div></div></div><p>You can write to properties by referencing the appropriate
    <code class="varname">.as<em class="replaceable"><code>&lt;data type&gt;</code></em></code>
    property, then saving the XML file.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>This feature is for use only on server tools, and you should avoid
      using it in game scripts.</p></div><p>An important limitation to be aware of is that it is only possible
    to save a <code class="classname">DataSection</code> that has been opened by
    reference to an XML document. It is not possible to directly save a
    section that is retrieved by a path to a sub-element within a file.</p><p>For example, the code below will <em class="emphasis">not</em> work:</p><pre class="programlisting"># this will not work, throws IOError
dsChild = ResMgr.openSection( 'scripts/data/Characters.xml/<em class="emphasis">character</em>' )
dsChild.asString = "Sir Lancelot"
dsChild.save()</pre><p><span class="citetitle">Example of incorrect procedure for writing to
    XML</span></p><p>The code excerpt below, on the other, will work:</p><pre class="programlisting"># this will work
dsRoot = ResMgr.openSection( 'scripts/data/Characters.xml' )
dsChild = dsRoot.child( 0 )
dsChild.asString = "Sir Lancelot"
dsRoot.save()</pre><p><span class="citetitle">Example of correct procedure for writing to
    XML</span></p><p>You can also add or remove child elements from each data
    section:</p><pre class="programlisting"># get the document data section
dsRoot = ResMgr.openSection( 'scripts/data/Characters.xml' )

# this will delete the first character
dsRoot.deleteSection( 'character' )

# create a new character, which is appended to the top-level
newChild = dsRoot.createSection( 'character' )
newChild.asString = "King Arthur"

newChild.createSection( 'description' )
newChild.createSection( 'modelName' )
newChild.createSection( 'race' )
newChild.createSection( 'gender' )
newChild.createSection( 'slaves' )

newChild['description'].asString = "The King of Camelot"
newChild['modelName'].asString = 'sets/main/character/knight.model'
newChild['race'].asString = 'human'
newChild['gender'].asInt = 0
dsRoot.save()</pre><p><span class="citetitle">Deleting sections and adding new ones</span></p><p>Running the code excerpt below, and assuming a
    <code class="filename">Characters.xml</code> as described in <a href="#xref_Accessing_Data" title="13.2.&nbsp;Accessing Data">Accessing Data</a>, the result will be the file below:</p><pre class="programlisting">&lt;root&gt;
   &lt;character&gt;      Sofia
      &lt;description&gt; Evil queen                       &lt;/description&gt;
      &lt;modelName&gt;   sets/main/characters/queen.model &lt;/modelName&gt;
      &lt;race&gt;        undead                           &lt;/race&gt;
      &lt;gender&gt;      1                                &lt;/gender&gt;

      &lt;slaves&gt;
         &lt;character&gt;      Underling
            &lt;description&gt; Hapless underling                  &lt;/description&gt;
            &lt;modelName&gt;   sets/main/characters/guard.model   &lt;/modelName&gt;
            &lt;race&gt;        undead                             &lt;/race&gt;
            &lt;gender&gt;      1                                  &lt;/gender&gt;
         &lt;/character&gt;

         &lt;character&gt;      Servant
            &lt;description&gt; Unpaid slave                       &lt;/description&gt;
            &lt;modelName&gt;   sets/main/characters/servant.model &lt;/modelName&gt;
            &lt;race&gt;        undead                             &lt;/race&gt;
            &lt;gender&gt;      1                                  &lt;/gender&gt;
         &lt;/character&gt;
      &lt;/slaves&gt;
   &lt;/character&gt;

<em class="emphasis">
   &lt;character&gt;       King Arthur
      &lt;description&gt;  The King of Camelot              &lt;/description&gt;
      &lt;modelName&gt;    sets/main/character/knight.model &lt;/modelName&gt;
      &lt;race&gt;         human                            &lt;/race&gt;
      &lt;gender&gt;       0                                &lt;/gender&gt;
      &lt;slaves&gt;                                        &lt;/slaves&gt;
   &lt;/character&gt;
</em>
&lt;/root&gt;</pre><p><span class="citetitle">Resulting
    <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/data/Characters.xml</code></span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12017"></a>13.5.&nbsp;Performance Issues</h2></div></div></div><p>Accessing the XML files on disk can potentially halt game
    processing. This can occur from disk I/O and parsing of the resulting
    data. This halt to processing can occur for both reading as well as
    writing of XML files and should be avoided as much as possible.</p><p>Due to the adverse impact this can cause to game development and
    resulting behaviour, a separate document has been written to address these
    issues. For more details please refer to the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../howto_avoid_file_in_main_thread/howto_avoid_file_in_main_thread.html#HowTo_Avoid_File_In_Main_Thread" class="olink">How To Avoid Files Being Loaded in the Main Thread</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12026"></a>13.6.&nbsp;API Reference</h2></div></div></div><p><code class="classname">ResMgr</code> documents the
    <code class="classname">DataSection</code>'s methods, and can be found in the
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/baseapp/index.html#Client_Python_API" class="olink">Client Python API</a>, <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/cellapp/index.html#Client_Python_API" class="olink">Client Python API</a>, and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_External_Services"></a>Chapter&nbsp;14.&nbsp;External Services</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Non-blocking_Methods">14.1. Non-blocking Methods</a></span></dt><dt><span class="section"><a href="#xref_Background_Threads">14.2. Background Threads</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12210">14.2.1. Caveats</a></span></dt></dl></dd></dl></div><p>From your game script you may want to access external services such as
  a billing or shopping system. When doing so, it is important not to block on
  I/O as a process that pauses for too long may be considered as dead by other
  server components. To avoid blocking on I/O you can either:</p><div class="orderedlist"><ol type="1"><li><p>Use non-blocking methods and handle notifications (the reactor
      pattern).</p></li><li><p>Call blocking methods from a background thread (the thread pool
      pattern).</p></li></ol></div><p>When available, non-blocking methods is preferred over background
  threads.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Due to the Python interpreter's implementation, the main thread
    could still be blocked if a background thread does not release the Global
    Interpreter Lock (GIL) frequently enough. By default a thread
    automatically releases the GIL every 100 bytecode instructions. The GIL is
    not automatically released when C code is called, the C code has the
    responsibility of periodically releasing the GIL. Please be aware that
    some Python modules are simply C API bindings.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Non-blocking_Methods"></a>14.1.&nbsp;Non-blocking Methods</h2></div></div></div><p>The easiest way to avoid blocking on I/O is to use non-blocking
    methods and handle notifications. You can register a callback to be
    invoked once a file descriptor has characters to be read with the
    <code class="classname">BigWorld</code>.<code class="methodname">registerFileDescriptor</code>
    method. Similarly, you can register a callback to be invoked once a file
    descriptor becomes writable with the
    <code class="classname">BigWorld</code>.<code class="methodname">registerWriteFileDescriptor</code>
    method. Both methods are respectively complemented with the
    <code class="classname">BigWorld</code>.<code class="methodname">deregisterFileDescriptor</code>
    and
    <code class="classname">BigWorld</code>.<code class="methodname">deregisterWriteFileDescriptor</code>
    methods. For more information please see the BaseApp and CellApp API
    documentation.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Background_Threads"></a>14.2.&nbsp;Background Threads</h2></div></div></div><p>To call a blocking method in a background thread you need to use the
    <code class="classname">BackgroundTask</code> module (this module is available
    from the file <code class="filename">BackgroundTask.py</code> in the import path
    <code class="filename">bigworld/res/scripts/server_common</code>). This module is
    available to both BaseApp and CellApp script. Below is a summary of
    usage:</p><div class="orderedlist"><ol type="1"><li><p>Create a <code class="classname">BackgroundTask.Manager</code>.</p></li><li><p>Use the <code class="classname">BackgroundTask.Manager</code> to start
        background threads.</p></li><li><p>Wrap blocking calls into a <code class="classname">BackgroundTask</code>
        subclass.</p></li><li><p>Add <code class="classname">BackgroundTask</code>s to the
        <code class="classname">BackgroundTask.Manager</code>.</p></li><li><p>Use the <code class="classname">BackgroundTask.Manager</code> to stop
        background threads.</p></li></ol></div><p>The remainder of this section describes how to add a row to an
    external database in a <code class="classname">BackgroundTask</code>.</p><pre class="programlisting">import BackgroundTask
import sqlalchemy

bgTaskMgr = None

def init( config_file ):
  ...
  bgTaskMgr = BackgroundTask.BgTaskManager()
  bgTaskMgr.startThreads( 5 ) # Can optionally pass a functor to create thread data per thread.
  
def fini():
  ...
  bgTaskMgr.stopAll()
  
class Note( sqlalchemy.SQLAlchemyBase ):
  ... </pre><p><span class="citetitle"><span class="literal">fantasydemo/res/scripts/base/NoteDataStore.py</span></span></p><p>In the code above, the init method creates a
    <code class="classname">BackgroundTask.Manager</code> (step 1) and start
    background threads (step 2) while the fini method stops all background
    threads (step 5).</p><pre class="programlisting">class AddNoteTask( BackgroundTask ):
  def __init__( self, noteReporter, description ):
    self.noteReporter = noteReporter
    self.note = NoteDataStore.Note( description )

  def doBackgroundTask( self, bgTaskMgr, threadData ):
    session = create_session()
    session.add( self.note )
    session.flush()                          # Blocking method

    bgTaskMgr.addMainThreadTask( self )      # Re-add ourself to invoke the callback in the main thread

  def doMainThreadTask( self, bgTaskMgr ):   # Invoke the callback
    ...
    self.noteReporter.onAddNote( id )

class NoteReporter( object ):
  def addNote( self, description ):
    ...
    task = AddNoteTask( self, description )
    NoteDataStore.bgTaskMgr.addBackgroundTask( task )

  def onAddNote( self, id ):                   # AddNoteTask's callback
    ...</pre><p><span class="citetitle"><span class="literal">fantasydemo/res/scripts/base/NoteReporter.py</span></span></p><p>In the code above, the <code class="classname">AddNoteTask</code> subclass
    wraps the blocking method <code class="methodname">session.flush</code> (step 3).
    The method
    <code class="classname">NoteReporter</code>.<code class="methodname">addNote</code>
    creates an <code class="classname">AddNoteTask</code> instance and adds it to the
    <code class="classname">BackgroundTask.Manager</code> as a background thread task
    (step 4). The <code class="classname">AddNoteTask</code> instance will invoke the
    callback
    <code class="classname">NoteReporter</code>.<code class="methodname">onAddNote</code>
    after it finishes its background thread work. To invoke a callback,
    overload the
    <code class="classname">BackgroundTask</code>.<code class="methodname">doMainThreadTask</code>
    method and inside
    <code class="classname">BackgroundTask</code>.<code class="methodname">doBackgroundTask</code>
    make the subclass re-add itself to the
    <code class="classname">BackgroundTask.Manager</code> as a main thread
    task.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The <code class="classname">BackgroundTask</code> module is a Python port
      of the C++ version located at
      <code class="filename">bigworld/src/lib/cstdmf/bgtask_manager.hpp</code></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12210"></a>14.2.1.&nbsp;Caveats</h3></div></div></div><p>Due to Python's thread implementation and the way that BigWorld
      incorporates Python, it is unsafe to perform any modifications on
      entities from within a background thread. For example, the following
      code would be considered unsafe:</p><pre class="programlisting">class DatabaseTask( BackgroundTask ):

  ...

  def doBackgroundTask( self, bgTaskMgr, threadData ):
    # Interact with DB to fetch data
    
    self.entity.cell.applyData( dataFromDB )</pre><p>It is unsafe to call the <code class="code">cell.applyData()</code> method as
      the Python thread context may switch back to the main thread and send a
      corrupt network packet.</p><p>A safe / correct approach to avoid these kind of issues would be
      the following:</p><pre class="programlisting">class DatabaseTask( BackgroundTask ):

  ...

  def doBackgroundTask( self, bgTaskMgr, threadData ):
    # Interact with DB to fetch data
    self.dataFromDB = dataFromDB
    bgTaskMgr.addMainThreadTask( self )


  def doMainThreadTask( self, bgTaskMgr ):
    self.entity.cell.applyData( self.dataFromDB )</pre></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Fault_Tolerance"></a>Chapter&nbsp;15.&nbsp;Fault Tolerance</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e12229">15.1. CellApp Fault Tolerance</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12232">15.1.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e12245">15.1.2. Restoration process</a></span></dt><dt><span class="section"><a href="#d0e12298">15.1.3. Example</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e12331">15.2. BaseApp Fault Tolerance</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12229"></a>15.1.&nbsp;CellApp Fault Tolerance</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12232"></a>15.1.1.&nbsp;Overview</h3></div></div></div><p>Periodically, a complete copy of each cell entity is backed up on
      the base entity. Only cell entities with an associated base entity are
      fault tolerant. The CellApp backup period specifies how often cell
      entities are backed up to their base entities, and is specified in the
      <code class="filename">bw.xml</code> option
      &lt;<span class="literal">cellApp/backupPeriod</span>&gt;.</p><p>Should a CellApp process become unavailable, the real entities
      located on the cells residing on that process will be restored by their
      corresponding base entities to other CellApps. The state of the cell
      data of the restored cell entities is the same state as was given from
      the most recent backup from the cell entity to the base entity.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12245"></a>15.1.2.&nbsp;Restoration process</h3></div></div></div><p>The CellApp restoration process typically follows these
      steps:</p><div class="orderedlist"><ol type="1"><li><p>A CellApp process becomes unavailable.</p></li><li><p>Base entities that have cell entities on the now unavailable
          CellApp process restore their corresponding real entities to other
          CellApps.</p></li><li><p>Restored cell entities have the
          <code class="methodname">onRestore</code>() callback called on them.
          Because the restored cell data is taken from the last time the cell
          entity backed up to the base, this copy can be up to twice the
          backup period. This callback should check that the entity's
          properties are in a consistent state.</p></li><li><p>For player cell entities, their corresponding client-side
          player entities have the <code class="methodname">onRestore</code>()
          callback called on them.</p></li></ol></div><p>The callback <code class="methodname">onRestore</code>() is invoked on
      the cell entity to inform it that it is being restored.</p><p>The code fragment below illustrates its implementation on the cell
      entity:</p><pre class="programlisting">class <em class="emphasis"><em class="replaceable"><code>SomeEntity</code></em></em>( BigWorld.Entity ):
  ...
  def <em class="emphasis">__init__</em>( self ):
    # set up initial property values
  ...
  def <em class="emphasis">onRestore</em>( self ):
    # check that property values are consistent, and
    # perform any cleanups that need to occur
  ...</pre><p><span class="citetitle">Example file
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/<em class="replaceable"><code>SomeEntity</code></em>.py</code></span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12298"></a>15.1.3.&nbsp;Example</h3></div></div></div><div class="figure"><a name="d0e12301"></a><p class="title"><b>Figure&nbsp;15.1.&nbsp;CellApp Fault Tolerance Example</b></p><div class="figure-contents"><div class="mediaobject"><img src="images/fault_tolerance_overview_example.png" alt="CellApp Fault Tolerance Example"></div></div></div><br class="figure-break"><p>The above diagram shows a space divided into three cells, the top
      cell residing on CellApp 4, the bottom-left cell residing on CellApp 3
      (not shown) and the bottom-right cell residing on CellApp 8 (not shown).
      In the cell that CellApp 4 has in this space, it has the cell entities
      with IDs 4156, 5712 and 2114, all within the same spatial region. The
      entities 4156 and 2114 have corresponding base entities that reside on
      BaseApp 1 and 2 respectively. Entity 5712 does not have a base entity,
      and is a cell-only entity.</p><p>Cell entities back up their data to their corresponding base
      entities. So in this example, entities 4156 and 2114 send a copy of
      themselves to their corresponding base entities. The rate at which they
      do this can be configured by changing the backup period, using the
      <code class="filename">bw.xml</code> option
      &lt;<span class="literal">cellApp/backupPeriod</span>&gt; (see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_CellApp_Configuration_Options" class="olink">CellApp Configuration Options</a> for more details). When
      a single CellApp goes down, cell entities are restored from the backup
      data sent to their base entities. Any cell entities that do not have
      corresponding base entities will not have been backed up, and so will
      not be restored.</p><p>If CellApp 4 was to go down, the cell entities for 4156 and 2114
      will be restored onto other CellApps from their base entities. Entity
      5712 will not be restored, as it has no corresponding base
      entity.</p><p>It is important to note that when restoring cell entities, the
      cell data that is used will be whatever data was present at the time of
      the last cell entity backup. Thus, any modification to the cell entity
      data since the last backup is lost, and the state of that cell entity
      may be inconsistent when it is restored. For example, a backup of a cell
      entity may be made in the middle of a multi-step transaction. The script
      callback
      <code class="classname">Entity</code>.<code class="methodname">onRestore</code>() can
      be used to check the state of outstanding transactions, and the decision
      to either roll them back or continue them can be made in script.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12331"></a>15.2.&nbsp;BaseApp Fault Tolerance</h2></div></div></div><p>With BaseApp fault tolerance, BaseApps back up the base entity data
    and cell backup data of all their base entities to other BaseApp processes
    periodically.</p><p>Should the primary BaseApp become unavailable, then all its entities
    are restored from the backup process. In this case, the BaseApp invokes
    the callback <code class="methodname">onRestore</code> on the base or proxy
    entity, in a process similar to the one for CellApp restoration. This
    callback should ensure that all properties on the entity are in a
    consistent state.</p><p>It should be noted that when a BaseApp fails unexpectedly, entities
    that were on that BaseApp before the death might be restored to different
    BaseApps. Care should be taken when writing scripts, to avoid assumptions
    that a Base entity is local. When performing an entity backup, Base entity
    properties are streamed using their description in the definition file (if
    there is one). For properties that are not specified in the definition
    file, these are pickled. Each entity is backed up individually, so if two
    entities refer to the same object, on restoration they will likely each
    have a copy of that object. An option is available to prevent properties
    not specified in the definition file from being backed up. To disable
    backing up undefined properties set the <code class="filename">bw.xml</code> option
    <code class="property">&lt;baseApp/backUpUndefinedProperties&gt;</code> to
    <span class="literal">false</span>. For more information on this option refer to the
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a> section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_BaseApp_Configuration_Options" class="olink">BaseApp Configuration Options</a>.</p><p>For more details regarding Fault Tolerance, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Fault_Tolerance" class="olink"><i>Fault Tolerance</i></a>,
    and the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#Server_Overview" class="olink">Server Overview</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Server_Components" class="olink"><i>Server Components</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Server_Components_BaseApp" class="olink">BaseApp</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Server_Components_BaseApp_Fault_Tolerance" class="olink">Fault Tolerance</a>.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Disaster_Recovery"></a>Chapter&nbsp;16.&nbsp;Disaster Recovery</h2></div></div></div><p>BigWorld's fault tolerance ensures that the server continues to
  operate if a single process is lost. The server also provides a second level
  of fault tolerance known as disaster recovery. The server's state can be
  written periodically to the database. In the event of entire server failure,
  the server can be restarted using this information.</p><p>The rate of this archiving is specified in the file
  <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/server/bw.xml</code> by
  the configuration options <code class="property">&lt;baseApp/archivePeriod&gt;</code>
  and <code class="property">&lt;cellAppMgr/archivePeriod&gt;</code>. For more details
  on these options, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a>'s sections <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_BaseApp_Configuration_Options" class="olink">BaseApp Configuration Options</a> and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_CellAppMgr_Configuration_Options" class="olink">CellAppMgr Configuration Options</a>.</p><p>The CellAppMgr process is responsible for writing to the database the
  spaces, their data, and the game time.</p><p>Entities with a valid database entry are also periodically archived
  (indicated by a non-zero <code class="varname">databaseID</code> on the base entity).
  To write an entity to the database, thus enabling its archiving, call the
  method <code class="methodname">writeToDB</code>() on the base or cell
  entity.</p><p>Each time an entity is archived, its callback
  <code class="methodname">onWriteToDB</code>() is invoked.</p><p>Starting a server with this archived information is the same as
  starting the server after a controlled shutdown. For more details, see <a href="#xref_Controlled_Startup_And_Shutdown" title="Chapter&nbsp;17.&nbsp;Controlled Startup and Shutdown"><i xmlns:xlink="http://www.w3.org/1999/xlink">Controlled Startup and Shutdown</i></a>.</p><p>For more details regarding Disaster Recovery, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Disaster_Recovery" class="olink">Disaster Recovery</a>.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Controlled_Startup_And_Shutdown"></a>Chapter&nbsp;17.&nbsp;Controlled Startup and Shutdown</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e12438">17.1. Controlled Shutdown</a></span></dt><dt><span class="section"><a href="#d0e12555">17.2. Controlled Startup</a></span></dt></dl></div><p>There may be times when the server needs to be shut down and later
  restarted in a similar state. This chapter describes the script-related
  details of this scenario.</p><p>For more details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Controlled_Startup_And_Shutdown" class="olink"><i>Controlled Startup and Shutdown</i></a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12438"></a>17.1.&nbsp;Controlled Shutdown</h2></div></div></div><p>The process of controlled shutdown is described in the list
    below:</p><div class="orderedlist"><ol type="1"><li><p><span class="literal">USR1</span> signal is received by LoginApp
        processes.</p></li><li><p>The LoginApp processes shut down immediately.</p></li><li><p>The CellAppMgr receives a message to schedule the shutdown (in
        game time).</p></li><li><p>The CellAppMgr sends a message to the other processes informing
        them when the shutdown is scheduled for.</p></li><li><p>The callback <code class="methodname">onCellAppShuttingDown</code> on
        the CellApp personality script is invoked.</p><p>The personality scripts on this step and the next should perform
        the appropriate finishing tasks, like ending long running tasks such
        as combats or trades, informing the players, and stopping new long
        running tasks from starting.</p></li><li><p>The callback <code class="methodname">onBaseAppShuttingDown</code> on
        the BaseApp personality script is invoked.</p></li><li><p>Once these callbacks have been executed, calls to method
        <code class="classname">BigWorld</code>.<code class="methodname">isShuttingDown</code>
        will return <span class="literal">True</span>.</p></li><li><p>The other server processes (CellApps, BaseAppMgr, BaseApps,
        Backup BaseApps, DBMgr, Reviver) do not stop immediately, instead
        performing any finishing tasks.</p><p>This delay can be specified in the file
        <code class="filename">res/server/bw.xml</code> by using the configuration
        option <code class="property">&lt;shuttingDownDelay&gt;</code>. For more
        details on this option, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>.</p></li><li><p>Shutdown game time is reached.</p></li><li><p>Game stops running, but the processes not.</p><p>This means that the game time is no longer incremented, and no
        game object is ticked.</p></li><li><p>When ready to shut down, CellAppMgr writes the spaces, their
        data, and the game time to the database.</p></li><li><p>This step takes place in parallel with step <em class="emphasis">11</em>.</p><p>Each BaseApp performs the following steps:</p><div class="itemizedlist"><ul type="disc"><li><p>Receives a message to disconnect any connected
            clients.</p></li><li><p>Invokes the callback
            <code class="methodname">onBaseAppShutDown</code> with an argument of
            <span class="literal">0</span> before disconnecting the clients.</p><p>For each disconnected client, the proxy's callback
            <code class="methodname">onClientDeath</code> is invoked.</p></li><li><p>Invokes the callback
            <code class="methodname">onBaseAppShutDown</code> with an argument of
            <span class="literal">1</span>, before writing to the database each entity
            with a database entry.</p></li><li><p>Invokes the callback
            <code class="methodname">onBaseAppShutDown</code> with an argument of
            <span class="literal">2</span>.</p></li></ul></div></li><li><p>All server process shut down.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12555"></a>17.2.&nbsp;Controlled Startup</h2></div></div></div><p>When starting up, the DBMgr initially waits until all components are
    ready. A minimum number of BaseApp and CellApp processes can be specified
    in <code class="filename">bw.xml</code> via the options
    <code class="property">&lt;desiredBaseApps&gt;</code> and
    <code class="property">&lt;desiredCellApps&gt;</code><sup>[<a name="d0e12568" href="#ftn.d0e12568">30</a>]</sup>. Once ready, the DBMgr loads the spaces and their data back
    into the system.</p><p>Entities stored from a previous session are then loaded into the
    system by creating the base entities. The script function
    <code class="classname">BigWorld</code>.<code class="methodname">hasStarted</code> will
    return <span class="literal">False</span> during this stage. This can be handy for
    implementing different behaviour in the method
    <code class="methodname">__init__</code> of restored entities.</p><p>It is up to the script to create the cell entity, if desired.
    Creating a cell entity during startup is often different from doing so
    during other times. Usually the method
    <code class="classname">Base</code>.<code class="methodname">createCellEntity</code> is
    called with a cell entity mailbox to indicate the entity's space. But
    during startup, the entity's space ID is restored and set in the
    <code class="classname">Base</code>.<code class="varname">cellData</code> map. The base
    entity script may use this by calling the method
    <code class="classname">Base</code>.<code class="methodname">createCellEntity</code> with
    no arguments.</p><p>Once the server is ready to start running, the callbacks
    <code class="methodname">onBaseAppReady</code> and
    <code class="methodname">onCellAppReady</code> from the personality script are
    called on the BaseApps and CellApps, respectively.</p><p>The game recovery function can be disabled by setting the
    <code class="property">&lt;dbMgr/clearRecoveryData&gt;</code><sup>[<a name="d0e12627" href="#ftn.d0e12627">31</a>]</sup> configuration option to <span class="literal">true</span>. When game
    recovery is disabled, the game is restarted with a single default space
    with no entities. For information on how to re-populate the game, see
    <a href="#xref_Initialisation_Personality_Script_eload_And_runscript" title="12.4.&nbsp;Initialisation: Personality script, eload, and runscript">Initialisation: Personality script, eload, and runscript</a>.</p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e12568" href="#d0e12568">30</a>] </sup>For details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_General_Configuration_Options" class="olink">General Configuration Options</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e12627" href="#d0e12627">31</a>] </sup>For details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="d0e12645"></a>Chapter&nbsp;18.&nbsp;Transactions and Handling Fault Tolerance and Disaster Recovery</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e12650">18.1. Transaction logic</a></span></dt><dt><span class="section"><a href="#d0e12736">18.2. Fault Tolerance Behaviour</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12739">18.2.1. CellApp Fault Tolerance</a></span></dt><dt><span class="section"><a href="#d0e12762">18.2.2. BaseApp
      Fault Tolerance</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e12789">18.3. Disaster Recovery Behaviour</a></span></dt></dl></div><p>We illustrate the previous chapters' guidelines with respect to handling
  fault tolerance and disaster recovery mechanisms in BigWorld by providing an
  example involving the use of transactions and how to make them work with fault
  tolerance and disaster recovery mechanisms.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12650"></a>18.1.&nbsp;Transaction logic</h2></div></div></div><p>We give here an example of a trading transaction for transferring an
    item between two player entities.</p><div class="figure"><a name="d0e12655"></a><p class="title"><b>Figure&nbsp;18.1.&nbsp;Transaction sequence diagram</b></p><div class="figure-contents"><div class="mediaobject"><img src="images/transaction_flow.png" alt="Transaction sequence diagram"></div></div></div><br class="figure-break"><p>The transaction logic between the two player entities Alice and Bob is
    as follows:</p><div class="orderedlist"><ol type="1"><li><p>Alice and Bob are within each other's Area of Interest (AoI).
        Alice's client informs her base entity that she would like to give Bob a
        Sword item.</p><p>Alice's base entity is passed the player name of Bob as part of
        the request from the client, along with the representation of the Sword
        item within Alice's inventory.</p><p>Alice's base entity adds an entry into her transaction list. This
        entry contains a unique transaction ID that identifies this transaction,
        Bob's player name, the state of the transaction (set to a symbolic
        constant called <span class="literal">BEGIN</span>), and the item in Alice's
        inventory.</p><p>Alice's base entity removes the Sword from Alice's
        inventory.</p><p>Alice requests a write to the database.</p></li><li><p>When the write to the database calls back, it indicates whether
        the write was successful or not.</p><p>If it was not successful, then there is a problem with the
        database, and the transaction is aborted (a message is sent back to the
        client informing Alice of this situation), and the Sword is added back
        to Alice's inventory.</p><p>Otherwise, if the write to the database was successful, the
        transaction action starts with Alice's base entity requesting an entity
        base mailbox lookup based on the player name, via the
        <code class="classname">BigWorld</code>.<code class="methodname">lookUpBaseByName</code>()
        method, and registers a callback to a functor containing the transaction
        ID.</p></li><li><p>Alice's base entity gets notification with the base mailbox of
        Bob.</p><p>If Bob's base entity can't be found, the transaction is aborted by
        removing the transaction entry from the transaction list, adding the
        Sword back to Alice's inventory, informing Alice's client and calling
        another <code class="methodname">writeToDB</code>().</p><p>Otherwise, Alice's base entity calls a method on Bob's base
        mailbox and requesting that it add the Sword item to his inventory. We
        pass the item, transaction ID, Alice's player name and a mailbox back to
        Alice's base entity.</p></li><li><p>Bob's base entity adds the Sword item to its inventory (but marks
        it as unusable by Bob's client for the moment).</p><p>Bob's base entity adds an entry into its transaction list, with
        Alice's player name, the state of the transaction set to the symbolic
        constant <span class="literal">REMOVE</span>, and the same transaction ID that was
        passed in from Alice.</p><p>Bob's base entity then starts a write to the database, registering
        a callback to a functor object that holds Alice's base entity mailbox
        and the transaction ID.</p></li><li><p>Bob's base entity is called back with the result of the database
        write.</p><p>If it was unsuccessful, Bob should remove the sword from his
        inventory as well as the transaction entry in the transaction list (the
        transaction ID is stored in the functor callback).</p><p>If the write was successful, the item should be marked as usable
        for Bob's client.</p><p>Whether or not the database write was successful, Bob's base
        entity informs Alice of the success of the database write through her
        base mailbox that is supplied through the functor callback. Bob passes
        in the success flag, a mailbox to Bob's base entity and the transaction
        ID.</p></li><li><p>Alice's base entity receives the result of the transaction from
        Bob's side.</p><p>Alice removes the transaction entry from her transaction
        list.</p><p>If Bob indicated that the transaction was unsuccessful, Alice
        re-adds the item back to her inventory informs the client of the trading
        failure.</p><p>Alice writes to the database, and registers a callback to a
        functor that holds Bob's base mailbox and the transaction ID.</p><p>Alice notifies Bob that the transaction on her side is complete,
        by passing in the transaction ID.</p></li><li><p>Bob receives this notification, and removes the transaction entry
        with the given transaction ID.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12736"></a>18.2.&nbsp;Fault Tolerance Behaviour</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12739"></a>18.2.1.&nbsp;CellApp Fault Tolerance</h3></div></div></div><p>If the CellApp that Alice's and/or Bob's cell entity resides on
      exits, all cell entities that have base entities will be restored to
      another CellApp. With this example scenario and transaction as described,
      there is not much of concern with regards to behaviour of restored cell
      entities as the transaction only involves BaseApps.</p><p>However, suppose the inventory system implementation was such that
      the player cell entities required knowledge of items, for example, what
      item a player was holding in its hands, which would need to be a
      <span class="literal">OTHER_CLIENTS</span> or <span class="literal">ALL_CLIENTS</span> cell
      entity property so that other players could view the item that a player
      was holding. If the cell entity was restored from an older version of its
      cell entity data when it was last backed up to the base entity, there
      could be inconsistencies in the cell entity state with respect to the base
      entity state.</p><p>For example, if Alice was restored to another CellApp, her cell
      entity could check with her base entity whether she still owned the item
      that she was holding, and if not, her cell entity should remove that
      item.</p><p>Cell entities that are restored do not have their
      <code class="methodname">__init__</code>() method called, instead, after they are
      restored with the cell backup data from their base entity, they have their
      <code class="methodname">onRestore</code>() method called, and checks such as
      these can be done in this method to make sure the state is consistent with
      the base entity state.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12762"></a>18.2.2.&nbsp;BaseApp
      Fault Tolerance</h3></div></div></div><p>If the BaseApp that Alice's and/or Bob's base entity resides on
      exits, those base entities will be restored to other BaseApps if they
      exist (if there is only one BaseApp, they cannot be restored).</p><p>As with cell entities, restored base entities do not have
      <code class="methodname">__init__</code>() called on them, instead, they have
      <code class="methodname">onRestore</code>() called on them when they are each
      restored from their most recent base entity backup data. This is a good
      place to do checks on uncompleted transactions.</p><p>For example, if the BaseApp that contained Alice exited, and Alice
      was restored onto another BaseApp (and perhaps Bob was too, and it could
      be a different BaseApp to where he was), then we need to replay any
      transactions that may have been underway.</p><p>For each transaction entry in Alice's transaction list, the entity
      needs to replay each transaction depending on the state that it's
      in.</p><p>For example, if it is in the <span class="literal">BEGIN</span> state, we
      resume the transaction from step 3 by looking up Bob's base entity, and
      continuing on.</p><p>If we are Bob, we may have transactions in the
      <span class="literal">REMOVE</span> state, and so we resume the transaction from
      step 6, and we tell Alice (or whoever the transactions' player name refers
      to) that they should complete the transaction on their end.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12789"></a>18.3.&nbsp;Disaster Recovery Behaviour</h2></div></div></div><p>When we are starting the server and restoring from the database, the
    base entities will be restored, and each of these will have
    <code class="methodname">__init__</code>() called on them. The variable
    <code class="classname">BigWorld</code>.<code class="varname">hasStarted</code> will be
    <span class="literal">False</span> for restored base entities, so we can do similar
    checks to what we have in the BaseApp fault tolerance section.</p><p>It is also the responsibility of the base entities to recreate the
    cell entities, usually via <code class="methodname">createCellEntity</code>(). The
    space ID is archived with the entity when it is written to the database, and
    this is present in the base entity's <code class="varname">cellData</code>
    dictionary.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Implementing_Common_Systems"></a>Chapter&nbsp;19.&nbsp;Implementing Common Systems</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e12819">19.1. General Scalability</a></span></dt><dt><span class="section"><a href="#d0e12838">19.2. Internal inter-component communication</a></span></dt><dt><span class="section"><a href="#d0e12847">19.3. Player AoI Updates</a></span></dt><dt><span class="section"><a href="#d0e12893">19.4. BigWorld Database Scalability</a></span></dt><dt><span class="section"><a href="#d0e12935">19.5. Player Look-up</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12938">19.5.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e12950">19.5.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13027">19.6. Friends lists</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13030">19.6.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13045">19.6.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13242">19.7. Chat</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13255">19.7.1. P2P</a></span></dt><dt><span class="section"><a href="#d0e13287">19.7.2. AoI-based broadcast chat</a></span></dt><dt><span class="section"><a href="#d0e13308">19.7.3. Non-AoI-based broadcast chat</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13337">19.8. Mail</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13340">19.8.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13345">19.8.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13356">19.9. Inventory System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13359">19.9.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13371">19.9.2. Design</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13399">19.10. AoI-based Trading</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13402">19.10.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e13411">19.10.2. Design</a></span></dt></dl></dd></dl></div><p>This chapter discusses some general issues that programmers
  implementing game systems should keep in mind, and also provides some
  example design and implementation of common systems used in MMOGs.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12819"></a>19.1.&nbsp;General Scalability</h2></div></div></div><p>In general, server processing load, internal network bandwidth and
    external network bandwidth scales linearly to the number of players if
    player and entity density remain constant. There is a small extra cost as
    density increases.</p><p>Capacity can be added by:</p><div class="itemizedlist"><ul type="disc"><li><p>Adding more BaseApps for more external connection points and
        connection processing capacity</p></li><li><p>Adding more CellApps for more spatial processing capacity</p></li><li><p>Adding a combination of both more BaseApps and more CellApps to
        increase game script processing capacity</p></li></ul></div><p>CellAppMgr, BaseAppMgr and DBMgr are single instances and are
    theoretically scaling bottlenecks. CellAppMgr and BaseAppMgr are only
    concerned with managing CellApps and BaseApps and have very low load. They
    can scale to handling thousands of BaseApps and CellApps. Although
    BigWorld's design does not make heavy use of the database, the main
    concern for scaling is DBMgr. This is addressed below in BigWorld Database
    Scalability.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12838"></a>19.2.&nbsp;Internal inter-component communication</h2></div></div></div><p>The number of BaseApps and CellApps required to sufficiently service
    an entity population should generally scale linearly with the number of
    entities. Most communication between entities is with those that are
    nearby. This is handled by keeping those entities together on CellApps as
    much as possible. Other communication involves point-to-point
    communication using remote method calls. The main issue here is to try to
    minimise situations where entities need to be looked up globally.</p><p>The DBMgr functionality for writing out entity state is distributed
    across the secondary databases for each BaseApp and consolidated when the
    entity is retired. See BigWorld Database Scalability below.</p><p>The general strategy to combating bottlenecks in game script is to
    avoid global game systems where possible, such as having singleton
    entities that control some operation of the game, for example, trading. In
    general, these bottlenecks can be avoided by restructuring game script and
    using distributed object methods to implement such global sub-systems,
    rather than entrusting the request handling to a single entity. An example
    of this is presented below (see AoI-based trading below).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12847"></a>19.3.&nbsp;Player AoI Updates</h2></div></div></div><p>Updates to some of the entities in a player's AoI are propagated to
    the player's client every game tick (by default,
    <span class="literal">gameUpdateHertz</span> is 10Hz). The amount of update data
    sent to the player's client is constrained to a downstream bit rate (by
    default, <span class="literal">bitsPerSecondToClient</span> is 20kbps).</p><p>These updates consist of property changes and method calls. Every
    cell entity keeps a history of these changes, and for each entity in a
    player's AoI, the player is updated incrementally about that entity
    periodically. The position and direction data of an entity is specially
    treated so that only the most recent value of these properties (so called
    volatile properties) is sent to the client, instead of the full history of
    the property.</p><p>Internally, entities in an AoI are in a priority queue. The priority
    of an entity in a player's AoI determines how long it will be before the
    next update about that entity occurs to the player. Generally speaking,
    entities closer to the player are updated more frequently than those that
    are towards the edge of a player's AoI. Properties can have
    <em class="emphasis">Level of Detail</em> (LoD) rules applied so that these
    properties will only be updated if the entity is close enough to the
    player. See the chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#xref_LOD_Level_Of_Detail_On_Properties" class="olink">LOD (Level of Detail) on Properties</a>.</p><p>In general, many game operations are localised to the specific area
    that a player inhabits. Load balance partitioning is done across each
    space depending on the load being generated per cell. As entity densities
    increase, the partitioning scheme changes in response to equalise the load
    amongst the cells servicing a space. The amount of data per entity that is
    sent to the client is also reduced as the density of entities increases.
    This reduces a lot of the extra cost due to density and also makes good
    use of the client's bandwidth.</p><p>However, very high entity densities can cause problems by causing
    each periodic update to a player client to be overrun with excessive
    amounts of entity event data. Recall that the amount of downstream
    bandwidth is a configurable constant. Due to the prioritising of change
    events of entities in a player's AoI, this can cause updates of entities
    further away to be starved if there are many more entities that are closer
    to the player.</p><p>Increasing the downstream bandwidth can improve on this situation,
    but eventually, it is usually the client that becomes the limiting factor.
    There is a per-entity cost of processing on game clients, for
    example:</p><div class="itemizedlist"><ul type="disc"><li><p>processing notifications for each entity's position and
        direction</p></li><li><p>processing notifications for each entity's property
        changes</p></li><li><p>processing notifications for each entity's method calls</p></li><li><p>applying physics rules to each entity</p></li><li><p>rendering of each entity</p></li></ul></div><p>There is also a limit to the amount of information that a player can
    comprehend. With large numbers of entities nearby, less information tends
    to be needed for distant entities.</p><p>Extreme entity densities that can negatively affect the end-user
    experience can be avoided with good game design.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12893"></a>19.4.&nbsp;BigWorld Database Scalability</h2></div></div></div><p>A brief discussion of the operation of DBMgr and implications for
    scalability follow.</p><p>When entities are checked out of the database, they are assigned to
    the least-loaded BaseApp. Once entities are loaded onto a BaseApp they do
    not generally migrate away from that BaseApp unless that BaseApp process
    terminates, in which case they are restored on other BaseApps in the
    system. See the chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#xref_Fault_Tolerance" class="olink"><i>Fault Tolerance</i></a>.</p><p>For each entity that resides on it, the BaseApp is responsible for
    collecting all the explicit script writes (from calls to
    <code class="methodname">BigWorld.writeToDB()</code>) for that entity over its
    checked-out lifetime, as well as the periodic backups for that entity.
    These writes are performed on a secondary database stored on the BaseApp
    machine. There can be arbitrarily many BaseApps in a cluster, and entities
    are statically load-balanced across them when they are instantiated. That
    is, they are assigned to the least-loaded BaseApp.</p><p>When the entity is destroyed, it is checked back into the primary
    database, this results in the sum of the database writes in the BaseApp
    secondary database for that entity being consolidated back into the
    primary database on the DBMgr.</p><p>This consolidation can be a bottleneck, and there are future
    features planned to reduce this so as to not overload the DBMgr. In
    general, writing back to the primary database is not a time-critical
    operation, so that checking entities back into the database is a
    fire-and-forget operation. No data loss is possible as the data is
    persisted on the secondary database, and not removed until the
    consolidation for that entity is done.</p><p>On server shutdown, all checked-out entities have their database
    writes consolidated back into the primary database. If an unexpected
    failure occurs (e.g. power failure), this consolidation can take place on
    the next server startup.</p><p>The following operations on the DBMgr can still be a
    bottleneck:</p><div class="itemizedlist"><ul type="disc"><li><p>checking login credentials</p></li><li><p>handling lookup requests for entities by name or database
        ID</p></li><li><p>loading entities from the persistent storage</p></li><li><p>writing entity state when entities are checked back into
        persistent storage</p></li></ul></div><p>In practice, looking up which BaseApp an entity is checked out to
    (by name or database ID) is a read operation and comparatively inexpensive
    due to the underlying MySQL query cache. However, schemes such as the
    <code class="classname">PlayerRegistry</code> entity (see Player Lookup below) can
    be implemented which can offload the task of handling lookup requests from
    the DBMgr to game script running on arbitrarily many BaseApps.</p><p>However, the global DBMgr process will still place an implicit limit
    on how quickly entities can be loaded from, and saved to, persistent
    storage. Future improvements being considered include sharding the
    database to spread this load over many external databases.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12935"></a>19.5.&nbsp;Player Look-up</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12938"></a>19.5.1.&nbsp;Requirements</h3></div></div></div><p>Each player must be able to query the status of another player by
      name:</p><div class="itemizedlist"><ul type="disc"><li><p>whether or not they are logged in</p></li><li><p>if they are logged in, get their player mailbox</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12950"></a>19.5.2.&nbsp;Design</h3></div></div></div><p>Using <code class="methodname">BigWorld.lookUpBaseByName()</code> causes
      a query to DBMgr (which causes a read on the primary database), while
      sufficient for many scenarios (and empirically works in many released
      BigWorld-based games), introduces a potential bottleneck. The discussion
      below outlines a design for a distributed mapping of player names to
      player mailboxes which effectively offloads this load to BaseApp game
      script, which can be scaled up by adding more BaseApps.</p><p>The idea is to have multiple <code class="classname">PlayerRegistry</code>
      Base entities that contain a distributed mapping of player names to
      player mailboxes. These <code class="classname">PlayerRegistry</code> entities
      have no geospatial representation, they exist only as a system service,
      and so generate no load with respect to AoI updates.</p><p>Each BaseApp has a corresponding
      <code class="classname">PlayerRegistry</code> entity - this spreads the
      <code class="classname">PlayerRegistry</code> entities out and protects against
      BaseApp failures. Having more than one
      <code class="classname">PlayerRegistry</code> entity per BaseApp does not add
      any additional redundancy benefit.</p><p><code class="classname">PlayerRegistry</code> entity instances register
      themselves globally. Globally registered bases have their mailboxes
      registered under a string key in a global bases mapping that is
      synchronised across every BaseApp. Player names are hashed against the
      known number of player registries, and a particular
      <code class="classname">PlayerRegistry</code> instance is located via the Global
      Bases mechanism (see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#xref_Global_Bases" class="olink">Global Bases</a>).</p><p>When player entities are created, they add themselves to the
      distributed registry by hashing their own name to the appropriate
      <code class="classname">PlayerRegistry</code> entity, and registering their base
      mailbox with that <code class="classname">PlayerRegistry</code> entity. On
      logout, they contact that same <code class="classname">PlayerRegistry</code> to
      notify it of the logout, and this results in the removal of the mapping
      between that player name and that player mailbox. A scheme for
      rebalancing the player registry entries can be implemented which
      re-balances the entries across the <code class="classname">PlayerRegistry</code>
      entities when a new <code class="classname">PlayerRegistry</code> is added or
      removed, such that the hash scheme remains consistent.</p><p>Queries for a particular player name are done by first hashing the
      player name to be looked up to the appropriate
      <code class="classname">PlayerRegistry</code>, and then querying one of the
      multiple <code class="classname">PlayerRegistry</code> entities via a remote
      method, and a callback remote method with a mailbox. Requests for player
      lookup are asynchronous, and caller entities implement a callback method
      that is called back when the lookup is complete.</p><p>Each <code class="classname">PlayerRegistry</code> needs a persistent
      mailbox list for fault tolerance purposes, so that the registry is
      restored to another BaseApp along with the
      <code class="classname">PlayerRegistry</code> entity if the BaseApp it formerly
      resides on fails. In this case, it is likely that it will be restored to
      another BaseApp which already has its own
      <code class="classname">PlayerRegistry</code>, so re-balancing should be done
      and then the restored <code class="classname">PlayerRegistry</code> should be
      destroyed.</p><p>This system can be scaled up by increasing the number of BaseApps
      to handle queries. Tiered request schemes could also be used to avoid
      large numbers of globally registered base entities becoming a
      bottleneck.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13027"></a>19.6.&nbsp;Friends lists</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13030"></a>19.6.1.&nbsp;Requirements</h3></div></div></div><p>Each player maintains a list of other players that they can use
      for the following purposes:</p><div class="itemizedlist"><ul type="disc"><li><p>to contact a friend</p></li><li><p>send private messages to friends</p></li><li><p>presence updates</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13045"></a>19.6.2.&nbsp;Design</h3></div></div></div><p>Assume that friendship relation is symmetric, so that if A is on
      the friend list of B, then B is on the friend list of A. A friends list
      can be implemented as an <span class="type">ARRAY</span> of <span class="type">FIXED_DICT</span>
      consisting of a <span class="type">STRING</span> name property, and the
      <span class="type">MAILBOX</span> of the player (or <code class="code">None</code> if offline),
      and a <code class="code">UINT8</code> Boolean flag <code class="property">hasResponded</code>
      indicating that this player has responded to our request to add that
      player as a friend.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13071"></a>19.6.2.1.&nbsp;Adding new friends</h4></div></div></div><p>Let the player adding the friend be called Player A, and the
        friend being added to Player A's list be called Player B.</p><div class="orderedlist"><ol type="1"><li><p>Player A checks that Player B is not already in A's friends
            list. Player A uses Player B's name to look up B's status and
            mailbox (if online) via the Player Look-up mechanism.</p></li><li><p>If B is not online, then we fail the operation. A scheme
            could be implemented that accommodated this situation, but for the
            sake of simplicity, it will not be discussed here.</p><p>If Player B is online, then Player A adds Player B to its
            friend list, setting the <code class="property">hasResponded</code> flag to
            <code class="code">False</code>, and writes itself to the database using
            <code class="methodname">Base.writeToDB()</code>, registering a callback
            when the database write completes.</p></li><li><p>If the write fails, then we rollback the friends list by
            removing Player B's <span class="type">FIXED_DICT</span> element, and abort
            this process, and inform Player A's client of system error.</p><p>Otherwise, the write is completed successfully, and so
            Player A informs Player B via remote method call to add Player A
            to Player B's list, passing along Player A's name and
            mailbox.</p><p>Periodically, Player A resends any such outstanding requests
            (indicated by <code class="property">hasResponded</code> being
            <code class="code">False</code> in the friends list), every, say, 3 seconds.
            The mailbox for each of these resends should be looked up each
            time, in case Player B has been restored to another BaseApp or if
            Player B has logged off and/or back on again. If Player B is not
            online during a retry, then the operation fails and Player A's
            client is informed that Player B is not online.</p></li><li><p>Typically, Player B won't already have Player A as a friend,
            and so Player B adds to its local friends list by creating a
            <span class="type">FIXED_DICT</span> element for Player A containing Player A's
            name and mailbox, and sets the <code class="property">hasResponded</code>
            flag to <code class="code">True</code>. A write to the database is requested
            with a callback.</p><p>Player B may already have an entry for Player A in its
            friends list. This can happen if Player A and Player B both
            simultaneously attempt to add each other as friends (in which case
            <code class="property">hasResponded</code> will be <code class="code">False</code>). It
            can also happen if Player B is restored to another BaseApp or is
            destroyed and re-created during the wait for the database write,
            or the database write takes so long that Player A has resent the
            request, and in these cases, <code class="property">hasResponded</code>
            will be <code class="code">True</code>.</p><p>If the <code class="property">hasResponded</code> flag is
            <code class="code">True</code>, then it signals to Player A that the operation
            succeeded straight away. If the <code class="property">hasResponded</code>
            flag is <code class="code">False</code>, then it should be set to
            <code class="code">True</code>, and the database written to and called back
            from before signalling success to Player A.</p></li><li><p>Typically, the write succeeds, and so Player B calls back on
            Player A to indicate that the request was successful.</p><p>In the exceptional case, the write can fail. Player B
            removes Player A's <span class="type">FIXED_DICT</span> entry in its friends
            list, and calls back on Player A to indicate that the operation
            failed.</p><p>In this scenario, Player A should try to remove Player B's
            <span class="type">FIXED_DICT</span> element, and this should be made
            persistent by writing Player A to the database. However, there's a
            chance that Player A fails this second database write while its
            earlier database write succeeded, making Player A's friends list
            inconsistent in the database. There are some ways of handling this
            situation:</p><div class="itemizedlist"><ul type="disc"><li><p>Do not remove Player B's <span class="type">FIXED_DICT</span> entry
                in Player A's list, and instead have Player A retry the
                request to Player B periodically until Player B responds with
                success.</p></li><li><p>Do remove Player B's <span class="type">FIXED_DICT</span> entry in
                Player A's write to database periodically.</p></li></ul></div><p>Both of these approaches assume that the database write
            failures are a temporary phenomenon. It could be caused by, the
            BaseApp secondary databases not having enough disk space, which is
            cleared up when the system administrator makes more space. A retry
            count could be kept that would remove the <span class="type">FIXED_DICT</span>
            entry from the friends list after the retry count exceeded some
            threshold, and Player A's client should be informed of
            failure.</p></li><li><p>On a successful callback from Player B, Player A sets the
            <code class="property">hasResponded</code> flag to <code class="code">True</code>. A
            database write is not necessary at this point, as the periodic
            backup and archival systems can be relied on to save this out
            eventually. In the event that the system is restarted or Player A
            is restored to another BaseApp, the periodic retry of
            <span class="type">FIXED_DICT</span> entries with
            <code class="property">hasResponded</code> set to <code class="code">False</code> will
            get a second successful callback, and will eventually be written
            out.</p></li></ol></div><p>Adding to friends lists is not expected to be a frequent
        operation on average over the entire player population, and players
        are typically spread out across the available BaseApps.</p><p>Removing a player from a friends list can be done in a similar
        fashion.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13206"></a>19.6.2.2.&nbsp;Private messages to friends</h4></div></div></div><p>See the section on Chat below. Once you have a player mailbox, a
        chat message can be sent to them using a simple remote method
        call.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13211"></a>19.6.2.3.&nbsp;Presence information</h4></div></div></div><p>Presence notifications can be implemented simply by calling a
        method on each player in that player's friends list indicating that
        they have logged in or logged out (which signals that the mailbox is
        invalidated, and should be set to <code class="code">None</code> in the
        corresponding <span class="type">FIXED_DICT</span> in the
        <span class="type">ARRAY</span>).</p><p>Player status notifications (e.g. away from keyboard) can be
        done in a similar way. Player base entities inform their clients of
        any change in the status of any friends, so they can update a user
        interface to the friends list.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13227"></a>19.6.2.4.&nbsp;Cache of friend player mailboxes</h4></div></div></div><p>The friends list can be used as a cache of player mailboxes
        while those friends are logged in, and do not need to use the general
        Player Look-up mechanism in order to communicate with their friend
        player entities. Friend mailboxes are set to <code class="code">None</code> when
        the friends log out.</p><p>Caches are not required to be persistent, and so do not add any
        additional processing cost to the database.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13237"></a>19.6.2.5.&nbsp;Fault tolerance handling</h4></div></div></div><p>When a player is restored, some of the friends may have come
        online or offline (or come offline, and then online) in the time since
        the player and the friends list was last backed up. At restore or
        initialisation time, player entities should perform look-ups on all
        the players in its friends list. It should also notify all online
        friends of its new mailbox when restoring.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13242"></a>19.7.&nbsp;Chat</h2></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>P2P chat</p></li><li><p>AoI-based chat</p></li><li><p>Channel-based chat (includes guid chat, world chat)</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13255"></a>19.7.1.&nbsp;P2P</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13258"></a>19.7.1.1.&nbsp;Requirements</h4></div></div></div><p>Players need to be able to send messages to other players.
        Players are identified by name.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13263"></a>19.7.1.2.&nbsp;Design</h4></div></div></div><p>See the section on Player Look-up above. Chatting from one
        player to another player involves the following: </p><div class="itemizedlist"><ul type="disc"><li><p>the mailbox of the destination player needs to be
              acquired. This can be done in one of the following ways:</p><div class="itemizedlist"><ul type="circle"><li><p>supplied by the player cell entity as the destination
                  entity is in the player's AoI</p></li><li><p>a local look-up in your friends list mailbox
                  cache</p></li><li><p>a look-up of their mailbox using the Player Look-up
                  mechanism described above</p></li></ul></div></li><li><p>calling chat remote method on that mailbox with the chat
              message contents.</p></li></ul></div><p>To save the remote method cost of look-ups, player mailboxes can
        be cached on the player entities as a non-persistent entity property.
        For example, private messages to non-friend players tend to result in
        conversations, and so having a local cache of player name mapped to
        player mailboxes will save on a look-up each time a further chat
        message is sent.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13287"></a>19.7.2.&nbsp;AoI-based broadcast chat</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13290"></a>19.7.2.1.&nbsp;Requirements</h4></div></div></div><p>Players need to be able to broadcast messages to players in
        their immediate spatial vicinity.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13295"></a>19.7.2.2.&nbsp;Design</h4></div></div></div><p>AoI-based chat can be implemented as a broadcast remote method
        call to all player entities that have the speaking player in their
        AoI. This does not require looping through all entities in script, and
        is implemented efficiently on the CellApp. The chat method call is
        broadcast to client entities using the same mechanism as any other
        broadcast method call, or when an <code class="code">ALL_CLIENTS</code> or
        <code class="code">OTHER_CLIENTS</code> property changes.</p><p>Volatile distance constraints can be specified for that chat
        method call so that only players within a certain radius of the
        originating player receive the method call message.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13308"></a>19.7.3.&nbsp;Non-AoI-based broadcast chat</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13311"></a>19.7.3.1.&nbsp;Requirements</h4></div></div></div><p>Non-AoI-based chat channels are chat channels of entities that
        are not necessarily in the same spatial location. This could be used
        for guild-scope chat and world-scope chat.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13316"></a>19.7.3.2.&nbsp;Design</h4></div></div></div><p>A non-AoI-based channel can be implemented as a
        <code class="classname">ChatChannel</code> entity that contains a list of
        player mailboxes of the players that are connected to that chat
        channel.</p><p>When a player wants to connect to a channel, a channel look-up
        is performed for the particular <code class="classname">ChatChannel</code>
        entity. This could be done via a similar scheme to the Player Look-up
        scheme described above. Once a mailbox to the channel is found, the
        player registers its base mailbox with the
        <code class="classname">ChatChannel</code> entity, which adds it to the list
        of connected player mailboxes.</p><p>A connected player broadcasts to that channel via a remote
        method call with the contents of that channel. The
        <code class="classname">ChatChannel</code> entity is responsible for
        broadcasting that message to each of its connected player base
        mailboxes.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13337"></a>19.8.&nbsp;Mail</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13340"></a>19.8.1.&nbsp;Requirements</h3></div></div></div><p>Each player must have the ability to send mail to other players.
      This mail includes some text and optionally in-game items.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13345"></a>19.8.2.&nbsp;Design</h3></div></div></div><p>The scalability of SMTP/IMAP mail servers can be leveraged here.
      Note that these game mail servers are completely internal to the game -
      no public access would be allowed (though this would be up to the game
      design).</p><p>Each player has an associated email address. BaseApps can query
      IMAP servers asynchronously using a TCP socket registered with BigWorld,
      without blocking game script. Python has good support for communication
      with IMAP over a socket (see the chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#xref_Non_Blocking_Socket_IO_Using_Mercury" class="olink"><i>Non-Blocking Socket I/O Using Mercury</i></a>)</p><p>Items can be gifted using special attachments or special email
      headers, depending on the item system used. Item data would never be
      directly sent via email, instead, gifted items over email would be held
      in escrow, as with AoI-based player item trading. See Inventory and Item
      trading below.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13356"></a>19.9.&nbsp;Inventory System</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13359"></a>19.9.1.&nbsp;Requirements</h3></div></div></div><p>Assume a game inventory system with the following features:</p><div class="itemizedlist"><ul type="disc"><li><p>Items are instances of a finite set of item archetypes</p></li><li><p>Each item instance has associated with it customisations that
          differentiate it between other instances of the same item archetype.
          These customisations may be visual customisations, different
          attributes (e.g. durability, bonus to strength, etc.)</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13371"></a>19.9.2.&nbsp;Design</h3></div></div></div><p>Store a fixed amount of inventory item slots per-player on the
      player entity to limit the amount of inventory data that is associated
      with player inventory.</p><p>Some popular MMOs have the concept of banks where players must be
      in a specific area to access items stored at the bank. This could be a
      separate entity that is loaded on request when a player is accessing
      their bank, and then destroyed once they leave the bank. The capacity of
      the on-player inventory and the bank inventory could be tuned to
      optimise database load.</p><p>With the on-player inventory, this can be stored as a BigWorld
      ARRAY of item descriptors. Item descriptors themselves would be
      persisted as a BigWorld <span class="type">FIXED_DICT</span>, but could be
      class-customised when loaded from the database so that items are
      represented in script as an arbitrary object type.</p><p>Player inventory changes are expected to be frequent. Per-element
      changes in a BigWorld <span class="type">ARRAY</span> are propagated to the client
      with a description of the change path to that element and the new
      element value (i.e. the entire array is not sent from the server to the
      client each time an element is changed).</p><p>If each time the inventory is changed, the entity wrote its state
      out to the secondary database, then a bottleneck can occur, as this
      operation is expected to be frequent.</p><p>In this case, we rely on the fault tolerance mechanism for
      ensuring against data loss. This works by periodically saving out the
      state of the entity to another process. That other process is
      responsible for restoring the entity in the event of a process failure.
      For example, cell entity data is backed up to the corresponding base
      entity's BaseApp, and base entities are backed up to other BaseApps.
      This is the first level of fault tolerance, and the frequency of backups
      can be configured.</p><p>There is also a second level of fault tolerance, which is the
      periodic archiving of the base and cell entity state to the secondary
      databases. The frequency of this can similarly tuned to achieve optimum
      BaseApp load.</p><p>However, for important changes to the item inventory, for example,
      a quest item, game script can request a write to the secondary database
      and have that confirmed via an <code class="methodname">onWriteToDB()</code>
      callback. For trading transactions between two players, see
      below.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13399"></a>19.10.&nbsp;AoI-based Trading</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13402"></a>19.10.1.&nbsp;Requirements</h3></div></div></div><p>Player entities in the same spatial vicinity must be able to
      negotiate trade of items that they own.</p><p>Each player makes an offer to each other, placing their offered
      items in escrow. Once both players accept the opposing player's offer,
      the trade succeeds and the items are traded. If one player cancels the
      trade, all offered items are returned to their respective
      players.</p><p>Item trading transactions must not result in duplicate items or
      item loss.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13411"></a>19.10.2.&nbsp;Design</h3></div></div></div><p>BigWorld can readily supply the base mailboxes of any player
      entity in a player's AoI. Otherwise, if trading with a specific person
      not in the player AoI, a player look-up is required.</p><p><code class="classname">Escrow</code> entities are created for the
      lifetime of a transaction, and hold mailboxes to the two entities
      bartering. <code class="classname">Escrow</code> entities persist to the
      database. Trading consists of two stages, the negotiation stage and the
      transfer stage. <code class="classname">Escrow</code> entities are created on
      the least loaded BaseApp.</p><p>The negotiation stage is a series of offer operations made from a
      player entity to an <code class="classname">Escrow</code> entity, each of which
      is then forwarded to the opposing player entity.</p><p>If the server stops in the middle of a transaction, the
      <code class="classname">Escrow</code> entity has enough persistent information
      to cancel itself on restore and return items back to their owning player
      entities.</p><p>Player entities on the server offer items to the other player (in
      response to GUI interactions from their player client) in the form of
      remote method requests to the <code class="classname">Escrow</code> entity. In
      doing so, they transfer these items from their inventory to a special
      holding area on the player entity on the server. This holding area is
      not accessible for any other purpose by the player's client, other than
      to remove the item from the current offer, which moves that item back
      into their inventory.</p><p>Each transfer to/from their player inventory to the trade holding
      area results in:</p><div class="itemizedlist"><ul type="disc"><li><p>notification of a change in items being offered to the
          <code class="classname">Escrow</code> entity via remote method call</p></li><li><p>a database write on the <code class="classname">Escrow</code>
          entity</p></li><li><p>an acknowledgement remote method call from the
          <code class="classname">Escrow</code> entity back to the originating player
          entity</p></li><li><p>removal of the items from the holding area, and a database
          write on the player entity</p></li></ul></div><p>If, for some reason (temporary or otherwise), the database write
      fails, the entire trade is cancelled, and the items are returned to the
      players via remote method calls, which are acknowledged via a remote
      method call by the players back to the <code class="classname">Escrow</code>
      entity. When the <code class="classname">Escrow</code> entity receives
      acknowledgements from the two players that the trade has been cancelled,
      it deletes itself from the database.</p><p>Each player can signal to the <code class="classname">Escrow</code> entity
      that it is willing to accept the trade as it stands. Once the
      <code class="classname">Escrow </code>entity receives positive notification for
      both parties, it transfers ownership of the items to the corresponding
      opposing players by signalling to the player the item data that they
      have traded.</p><div class="itemizedlist"><ul type="disc"><li><p>The <code class="classname">Escrow</code> entity transfers ownership
          to each player their corresponding traded items</p></li><li><p>On receipt of the items, each player initiates a write to the
          database. When this is confirmed to be OK, the player entity
          acknowledges that they have the items by calling back on the
          <code class="classname">Escrow</code> entity.</p></li><li><p>The <code class="classname">Escrow</code> entity waits for both
          acknowledgements to return, and then destroys itself and deletes
          itself from the database.</p></li></ul></div><p>Total database writes: 2 for each offer made, and at least 2
      offers are made. 3 writes for the transfer stage.</p><p>This illustrates that trading can potentially be an expensive
      operation in terms of writes to disk. However, all the writes are
      distributed amongst the entities involved, and most would be written to
      the secondary database. Only one of the database writes, when the
      <code class="classname">Escrow</code> entity is destroyed, results in the
      primary database being utilised, in order to remove that
      <code class="classname">Escrow</code> entity from persistent storage.</p><p>Note that each participating entity in a trading transaction is
      not required to be on the same process. This scales well because there
      can be an arbitrary number of BaseApps, and players and Escrow entities
      would be uniformly distributed amongst the BaseApps. Recall that while
      CellApps have player distributions that map to where they are spatially,
      base entities on BaseApps do not have this spatial relation.</p><p>There is a cost to the primary database associated with the
      creation and destruction of each <code class="classname">Escrow</code> entity.
      This design can be improved by consolidating the escrow operations to
      target a pre-existing <code class="classname">EscrowManager</code> entity rather
      than creating and destroying <code class="classname">Escrow</code> entities. A
      similar scheme could be implemented to the
      <code class="classname">PlayerRegistry</code> entities by having an
      <code class="classname">EscrowManager</code> entity per BaseApp. Trading
      entities would nominate and agree on a random
      <code class="classname">EscrowManager</code> to use for their trading
      transaction.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_User_Authentication_And_Proxy_Selection"></a>Chapter&nbsp;20.&nbsp;User Authentication and Billing System Integration</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e13551">20.1. Authentication by DBMgr</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_bigworldLogOnMapping_Table">20.1.1. Default Authentication via MySQL</a></span></dt><dt><span class="section"><a href="#d0e13674">20.1.2. Default Authentication via XML</a></span></dt><dt><span class="section"><a href="#d0e13754">20.1.3. Custom Authentication and Billing System Integration</a></span></dt><dt><span class="section"><a href="#xref_Accepting_All_Users">20.1.4. Accepting All Users</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Bypassing_bigworldLogOnMapping_And_Using_Account_Entity">20.2. Authentication via a Base entity</a></span></dt></dl></div><p>In the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#Server_Overview" class="olink">Server Overview</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Design_Introduction" class="olink"><i>Design Introduction</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Design_Introduction_Use_Cases" class="olink">Use Cases</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Use_Cases_Logging_In" class="olink">Logging In</a>, an overview of the login process is
  given. This chapter details the part of that process concerned with
  authenticate the login details and loading the initial entity.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13551"></a>20.1.&nbsp;Authentication by DBMgr</h2></div></div></div><p>By default, authentication of the player's username and password is
    done by the DBMgr. It also handles the mapping of that username to the
    initial entity the player will use. There are a number of different ways
    this can be done. This section discusses these different
    approaches.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_bigworldLogOnMapping_Table"></a>20.1.1.&nbsp;Default Authentication via MySQL</h3></div></div></div><p>When using the MySQL database, DBMgr uses the
      <span class="literal">bigworldLogOnMapping</span> table (for details, see <a href="#xref_Entity_Tables" title="33.1.&nbsp;Entity Tables">Entity Tables</a>) to check login's validity and which
      entity to load for the user. It contains the following columns:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">logOnName</span></em></p><p>Username used to log in to BigWorld. This corresponds to the
          <span class="literal"><em class="parameter"><code>username</code></em></span> argument passed
          to the
          <code class="classname">BigWorld</code>.<code class="methodname">connect()</code>
          call on the client.</p><p>This is the primary key.</p></li><li><p><em class="emphasis"><span class="literal">password</span></em></p><p>User's password. This corresponds to the
          <code class="code"><em class="parameter"><code>password</code></em></code> argument passed to the
          <code class="classname">BigWorld</code>.<code class="methodname">connect()</code>
          call on the client.</p><p>If <code class="filename">bw.xml</code> file's
          <span class="literal">billingSystem/isPasswordHashed</span> setting is true,
          the password will be hashed. The following SQL is used to perform
          the hashing: </p><pre class="programlisting">MD5( CONCAT( <em class="replaceable"><code>password</code></em>, logOnName ) )</pre></li><li><p><em class="emphasis"><span class="literal">entityType</span></em></p><p>Type ID of the entity to create. To map the type ID to its
          name, <span class="literal">bigworldEntityTypes</span> table (for details, see
          <a href="#xref_Entity_Tables" title="33.1.&nbsp;Entity Tables">Entity Tables</a>.) is used. This can be queried
          with the following MySQL query.</p><pre class="programlisting">SELECT typeID FROM bigworldEntityTypes WHERE name='MyEntityType';</pre></li><li><p><em class="emphasis"><span class="literal">entityID</span></em></p><p>The database id of the associated entity.</p></li></ul></div><p>To determine whether a login is valid and which entity to load,
      DBMgr executes the following steps:</p><div class="orderedlist"><ol type="1"><li><p>Find a row in the <span class="literal">bigworldLogOnMapping</span>
          table where the <span class="literal">logOnName</span> column matches the
          username.</p></li><li><p>Check that the user's password matches the password of the
          found row.</p></li><li><p>Load the entity identified by <span class="literal">typeID</span> and
          <span class="literal">recordName</span>.</p></li></ol></div><p>For this step to succeed, the entity must already exist in the
      database. For information on how to create an entity and write it to the
      database, see <a href="#xref_Reading_And_Writing_Entities" title="8.2.&nbsp;Reading and Writing Entities">Reading and Writing Entities</a>.</p><p>This table is usually populated using MySQL tools. An example
      script, <code class="filename">bigworld/tools/server/misc/add_account.py</code>,
      implements a command line utility that can be used to create
      accounts.</p><p>For information on how BigWorld can automatically populate this
      table, see <a href="#xref_Accepting_All_Users" title="20.1.4.&nbsp;Accepting All Users">Accepting All Users</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13674"></a>20.1.2.&nbsp;Default Authentication via XML</h3></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>It is highly recommended to use the MySQL database back-end for
        production environments. You should consider moving away from the XML
        database before implementing user authentication. </p></div><p>The XML database implements the equivalent of the
      <span class="literal">bigworldLogOnMapping</span> table in the section
      <span class="literal">_BigWorldInfo/LogOnMapping</span>. Each row is specified
      using a separate sub-section, as illustrated below:</p><pre class="programlisting">&lt;root&gt;
  &lt;_BigWorldInfo&gt;
    &lt;LogOnMapping&gt;
      &lt;item&gt;
        &lt;logOnName&gt;  John      &lt;/logOnName&gt;
        &lt;password&gt;   acde1234  &lt;/password&gt;
        &lt;type&gt;       Account   &lt;/type&gt;
        &lt;entityID&gt;   7231  &lt;/entityID&gt;
      &lt;/item&gt;
      &lt;item&gt;
        &lt;logOnName&gt;  Peter     &lt;/logOnName&gt;
        &lt;password&gt;   zyxw9876  &lt;/password&gt;
        &lt;type&gt;       Avatar    &lt;/type&gt;
        &lt;entityID&gt;   7232  &lt;/entityID&gt;
      &lt;/item&gt;
    &lt;/LogOnMapping&gt;
  &lt;/_BigWorldInfo&gt;
...
&lt;/root&gt;</pre><p><span class="citetitle"><span class="literal">bigworldLogOnMapping</span> table in
      XML</span></p><p>In the example above, two rows are specified. The tags correspond
      to the table columns as described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">logOnName</span></em>
          <span class="symbol">&#8208;</span> Corresponds to column:
          <span class="literal">logOnName</span></p></li><li><p><em class="emphasis"><span class="literal">password</span></em>
          <span class="symbol">&#8208;</span> Corresponds to column:
          <span class="literal">password</span></p></li><li><p><em class="emphasis"><span class="literal">type</span></em>
          <span class="symbol">&#8208;</span> Corresponds to column:
          <span class="literal">typeID</span></p></li><li><p><em class="emphasis"><span class="literal">entityID</span></em>
          <span class="symbol">&#8208;</span> Corresponds to column:
          <span class="literal">entityID</span></p></li></ul></div><p>When specifying the type of the entity, the type name is used
      instead of the type ID used by the MySQL database.</p><p>Please note that
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/db.xml</code>
      is only read and written to during startup and shutdown, respectively.
      Therefore, it is not possible to update the
      <span class="literal">_BigWorldInfo/LogOnMapping</span> section and have the
      changes take effect while DBMgr is running.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13754"></a>20.1.3.&nbsp;Custom Authentication and Billing System Integration</h3></div></div></div><p>It is often the case that user accounts are stored in an external
      system. This section describes how to bypass the
      <span class="literal">bigworldLogOnMapping</span> table and use your own
      system.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13762"></a>20.1.3.1.&nbsp;Billing System Integration using Python</h4></div></div></div><p>The easiest way to achieve this is via Python. When the DBMgr
        checks whether to use Python by attempting to call
        <code class="code">BWPersonality.connectToBillingSystem()</code>. If this exists
        and returns a Python object, this object is used to perform user
        authentication. The object should implement a
        <code class="methodname">getEntityKeyForAccount</code> and optionally
        <code class="methodname">setEntityKeyForAccount</code>.</p><pre class="programlisting">class BillingSystem( object ):
    def getEntityKeyForAccount( username, password, clientAddr, response ):
        ...

    def setEntityKeyForAccount( username, password, entityType, entityID ):
        ...

def connectToBillingSystem():
    return BillingSystem()</pre><p><span class="citetitle">Example excerpt from
        res/scripts/db/BWPersonality.py</span></p><p>The <code class="methodname">getEntityKeyForAccount</code> method
        accepts username, password, client address and response object as
        arguments. The username and password should be used for authentication
        and an appropriate response should be returned by calling one of the
        methods of the handler object.</p><p>The response argument has the following methods:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">loadEntity( entityType,
            entityDatabaseID )</span><em class="emphasis"><span class="symbol">
            &#8208;</span> This should be called on successful authentication. It
            accepts two arguments, the type and database id of the entity to
            be loaded from the database and used by this
            user.</em></em></p></li><li><p><em class="emphasis"><span class="literal">loadEntityByName( entityType,
            entityName, shouldCreateUnknown )</span><em class="emphasis"><span class="symbol"> &#8208;</span> This is like loadEntity but takes the
            name (identifier string) of the entity instead of the database id.
            It also takes a boolean argument indicating whether to create a
            new entity if one with this name does not
            exist.</em></em></p></li><li><p><em class="emphasis"><span class="literal">createNewEntity( entityType,
            shouldRemember )</span><em class="emphasis"><span class="symbol">
            &#8208;</span> This should be called when logging in should proceed
            but a new entity should be created instead of loading one from the
            database. It accepts two argument, the type of the entity to
            create and a boolean indicating whether this new entity should be
            saved in the database and in the billing
            system.</em></em></p></li><li><p><em class="emphasis"><span class="literal">failureInvalidPassword()</span><em class="emphasis"><span class="symbol"> &#8208;</span> This should be called when
            authentication fails because of an invalid
            password.</em></em></p></li><li><p><em class="emphasis"><span class="literal">failureNoSuchUser()</span><em class="emphasis"><span class="symbol"> &#8208;</span> This should be called when
            authentication fails because no such user
            exists.</em></em></p></li></ul></div><p>You may not want to differentiate between receiving an invalid
        password or non-existent user. If so, you should just consistently
        return either <code class="methodname">failureNoSuchUser</code> or
        <code class="methodname">failureInvalidPassword</code> on failure.</p><p>The <code class="methodname">setEntityKeyForAccount</code> is only
        required if <code class="methodname">createNewEntity</code> is ever called
        with <em class="parameter"><code>shouldRemember</code></em> as
        <span class="literal">True</span>. If so, this is called with the username and
        password of the account and the entity type and entity id of the
        entity to associate with that account.</p><p>FantasyDemo has a simple example where account information is
        stored in an sqlite database. This is located in
        <code class="filename">fantasydemo/res/scripts/db/FantasyDemo.py</code> and
        <code class="filename">fantasydemo/res/scripts/db/sqlite_billing.py</code>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13864"></a>20.1.3.2.&nbsp;Billing System Integration using C++</h4></div></div></div><p>Billing system integration can also be done via C++. A skeleton
        billing system case is implemented in
        <code class="filename">bigworld/src/server/dbmgr/custom_billing_system.cpp</code>.
        Integration should be done by filling out this class. To make use of
        this class, <code class="code">USE_CUSTOM_BILLING_SYSTEM</code> needs to be set to
        <code class="code">1</code> in
        <code class="filename">bigworld/src/server/dbmgr/Makefile</code>.</p><p>The support for Python billing system integration is implemented
        in
        <code class="filename">bigworld/src/server/dbmgr/py_billing_system.cpp</code>.
        This can be used as an example.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Accepting_All_Users"></a>20.1.4.&nbsp;Accepting All Users</h3></div></div></div><p>During development, it is often convenient to grant all users
      access to the server, without having to set up a
      <span class="literal">bigworldLogOnMapping</span> table.</p><p>This can be achieved by setting <code class="filename">bw.xml</code> file's
      <span class="literal">billingSystem/shouldAcceptUnknownUsers</span><sup>[<a name="d0e13901" href="#ftn.d0e13901">32</a>]</sup> configuration option to <span class="literal">true</span>. With this
      configuration, a default entity is created for the user if there is no
      row matching the username in
      <span class="literal">bigworldLogOnMapping</span>.</p><p>The type of the entity created is controlled by the
      <span class="literal">bw.xml</span> file's
      <span class="literal">billingSystem/entityTypeForUnknownUsers</span> option.
      Additionally, if
      <span class="literal">billingSystem/shouldRememberUnknownUsers</span> is set to
      <span class="literal">true</span>, then the entity created for the unknown user is
      saved in the database, and an entry is added in
      <span class="literal">bigworldLogOnMapping</span>. This effectively adds a new
      user into the system, and subsequent logins by the same user will be
      processed via the normal login process.</p><p>If a custom billing system is being used, it is up to its
      implementation whether these options are respected.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Bypassing_bigworldLogOnMapping_And_Using_Account_Entity"></a>20.2.&nbsp;Authentication via a Base entity</h2></div></div></div><p>An alternative method for performing user authentication, and entity
    selection is to delegate to an account entity and perform the logic in its
    base entity script. An account entity is just another BigWorld entity that
    is implemented using Python script. The DBMgr can be configured to bypass
    its usual login processing and pass control over to the account
    entity.</p><p>To use this method, the following configuration options must be
    set:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">billingSystem/entityTypeForUnknownUsers</span><sup>A</sup>
        <span class="symbol">&#8208;</span> Required value: Your account entity
        type</em></p><p><em class="emphasis">Reason for required value:
        </em></p><p>Type of the entity that will handle the login process.</p><p>For details on how to implement entities, see <a href="#xref_Physical_Entity_Structure_For_Scripting" title="Chapter&nbsp;2.&nbsp;Physical Entity Structure for Scripting"><i xmlns:xlink="http://www.w3.org/1999/xlink">Physical Entity Structure for Scripting</i></a>.</p></li><li><p><em class="emphasis"><span class="literal">billingSystem/authenticateViaBaseEntity</span><sup>A</sup>
        <span class="symbol">&#8208;</span> Required value:
        <span class="literal">true</span></em></p><p><em class="emphasis">Reason for required
        value:</em></p><p>This bypasses the DBMgr authentication and always creates a
        Proxy entity of the type indicated above. If this entity already
        exists in the database with its identifier equal to the current
        username, that data will be loaded otherwise a new entity will be
        created. New entities are not immediately added to the database. It is
        up to the base entity script to write only the appropriate entities
        with a call to <code class="code">Base.writeToDB()</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The name of an entity is a property tagged with the
          <code class="property">&lt;Identifier&gt;</code> tag. For details, see <a href="#xref_The_Identifier_Tag" title="8.1.3.&nbsp;The Identifier Tag">The Identifier Tag</a>.</p></div></li></ul></div><p><em class="emphasis"><em class="emphasis">A </em><span class="symbol">&#8208;</span> For details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>.</em></p><p>After a successful login:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">On the client </em><span class="symbol">&#8208;</span> The account's <span class="literal">__init__</span>
        method is called.</p></li><li><p><em class="emphasis">On the BaseApp</em> <span class="symbol">&#8208;</span> The account's
        <span class="literal">onEntitiesEnabled</span> method is called.</p></li></ul></div><p>There are a couple of approaches to retrieving the user's
    password:</p><div class="itemizedlist"><ul type="disc"><li><p>On the BaseApp, if the account entity has a property called
        password, it is automatically set to the user's login password. And,
        of course, the account's name property will try to match the
        username.</p></li><li><p>Since the login password sent by the client using
        BigWorld.connect method is usually sent in clear text, it may be
        preferable to use an empty password for normal login processing. Then,
        after the account entity has been created, the client can send an
        encrypted password to the Proxy.</p></li></ul></div><p>It is up to the account entity's implementation to verify the user's
    password. This is usually done by communicating with a third-party billing
    system. For details on how to communicate with a non-BigWorld process, see
    <a href="#xref_Non_Blocking_Socket_IO_Using_Mercury" title="Chapter&nbsp;32.&nbsp;Non-Blocking Socket I/O Using Mercury"><i xmlns:xlink="http://www.w3.org/1999/xlink">Non-Blocking Socket I/O Using Mercury</i></a>. If the user's
    password is invalid, then the Proxy entity can destroy itself to
    disconnect the client.</p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e13901" href="#d0e13901">32</a>] </sup>For details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Server_Configuration_With_bw_xml" class="olink"><i>Server Configuration with <span class="literal">bw.xml</span></i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Security_Systems_In_BigWorld_Technology"></a>Chapter&nbsp;21.&nbsp;Security</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e14054">21.1. Client/Server Communications</a></span></dt><dt><span class="section"><a href="#d0e14143">21.2. Server-Side Network</a></span></dt><dt><span class="section"><a href="#d0e14180">21.3. Client Side</a></span></dt><dt><span class="section"><a href="#d0e14197">21.4. Client Cheating</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14209">21.4.1. General Rules for Managing Entity Data</a></span></dt><dt><span class="section"><a href="#d0e14242">21.4.2. Writing Secure Game Script</a></span></dt><dt><span class="section"><a href="#d0e14255">21.4.3. Balancing Security vs. Latency</a></span></dt><dt><span class="section"><a href="#d0e14262">21.4.4. Balancing Security vs. Server CPU Cost</a></span></dt></dl></dd></dl></div><p>Any MMOG needs to implement robust solutions to safeguard its
  environment from exploits. This chapter describes the measures adopted by
  BigWorld to provide safety for your data.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14054"></a>21.1.&nbsp;Client/Server Communications</h2></div></div></div><p>The list below describes the measures taken to guarantee the
    security of client/server communications:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Security measure: Login
        authentication</em></p><p><em class="emphasis">Opportunity thwarted: Unknown user using a
        player's account.</em></p><p>When a player logs in to a BigWorld server, he sends a username
        and a password. These are compared to a server-side database, to make
        sure that the user is subscribed.</p><p>The source code is available to the login procedure, so this
        method can be customised as desired.</p></li><li><p><em class="emphasis">Security measure: Packet
        authentication</em></p><p><em class="emphasis">Opportunity thwarted: Player pretending to
        be someone else, by spoofing another player's data.</em></p><p>When a player logs in to a BigWorld server, the server sends a
        32-bit session key back to the client. The client must use this key in
        all further packets sent to the server, or the packet will be
        rejected.</p><p>Optionally, the server can also send to the client an
        authentication key with every packet. This makes it very hard for an
        attacker to successfully masquerade as the server.</p><p>Also, every command called on the server has the client's ID
        added to the arguments. This is done by the BaseApp before the command
        is transmitted, so the client cannot fake the ID.</p></li><li><p><em class="emphasis">Security measure:
        Encryption</em></p><p><em class="emphasis">Opportunity thwarted: Attacker sniffing
        data to gain privileged information, or injecting new packets into
        client-server streams.</em></p><p>All traffic between the client and server is encrypted. The
        credentials sent to the server during login are RSA-encrypted and all
        client-server traffic after this point is encrypted with 128-bit modal
        Blowfish. This makes it very difficult for an attacker to inject new
        packets into either the upstream or downstream traffic; without
        knowing the Blowfish key, the probability of generating a packet that
        will parse correctly and not be discarded is extremely low.</p><p>It would still be possible for a player to hack its own binary
        and sniff the data stream from the server after it has been
        decrypted.</p></li><li><p><em class="emphasis">Security measure: Data
        hiding</em></p><p><em class="emphasis">Opportunity thwarted: Player accessing
        privileged information.</em></p><p>All properties of entities are tagged with propagation
        specifiers. These allow the server to control where information is
        sent.</p><p>For example, you may want to hide the actual health of NPC
        players, to prevent players from cheating by sniffing the data
        stream.</p><p>This is a common problem on MMOGs that receive data that is not
        always displayed to the user.</p><p>For more details, see <a href="#xref_Data_Distribution" title="4.3.&nbsp;Data Distribution">Data Distribution</a>.</p></li><li><p><em class="emphasis">Security measure: Sequence
        numbers</em></p><p><em class="emphasis">Opportunity thwarted: User spoofing and
        replaying captured stream.</em></p><p>All packets are stamped with a sequence number, and packets are
        rejected if the sequence number is repeated.</p><p>This makes it much harder for a hacker to capture a data stream
        and replay it, or inject packets to fake game operations.</p></li><li><p><em class="emphasis">Security measure: IP address
        masking</em></p><p><em class="emphasis">Opportunity thwarted: User doing DOS
        attacks on clients.</em></p><p>A player's IP address is not shared between clients, making it
        impossible for hackers to sniff it and then perform a Denial Of
        Service attack on that client.</p></li><li><p><em class="emphasis">Security measure: Privilege checks on
        RPCs</em></p><p><em class="emphasis">Opportunity thwarted: Player calling
        server-only functions.</em></p><p>Both client and server entities call functions (Remote Procedure
        Calls) on Python objects.</p><p>The developer tags all methods with accessibility flags. This
        enables the server to check all calls to make sure that they are
        legal.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14143"></a>21.2.&nbsp;Server-Side Network</h2></div></div></div><p>Security for the internal server-side network is provided by a
    simple proxy mechanism <span class="symbol">&#8208;</span> the only machines
    exposed to the Internet are the LoginApps and BaseApps (for more details,
    see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#Server_Overview" class="olink">Server Overview</a>s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Server_Components" class="olink"><i>Server Components</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Server_Components_BaseApp" class="olink">BaseApp</a>).</p><p>As such, internal server traffic between BigWorld components
    (<em class="emphasis">e.g.</em>, CellApp to BaseApp traffic, CellApp to
    CellAppMgr traffic) cannot be sniffed.</p><p>Additionally, each server component is only required to listen for
    all external communications on a single UDP port. This way, all other
    network services can be disabled, including TCP, which is the target of
    many known attacks. Listening on a single UDP port for communications with
    all clients (as opposed to a distinct port for each) also has the
    following advantages:</p><div class="itemizedlist"><ul type="disc"><li><p>It becomes impossible for one client to guess another's port,
        and thereby impersonate it.</p></li><li><p>A single <span class="literal">recv()</span> is used for all incoming
        messages on the server side, instead of a <span class="literal">select()</span>
        across a large number of per-player sockets. This results in a more
        efficient message handling implementation.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14180"></a>21.3.&nbsp;Client Side</h2></div></div></div><p>The list below describes the measures taken to guarantee the
    security of the client side:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Security measure: CD Key</em></p><p><em class="emphasis">Opportunity thwarted: Stealing of CD
        images</em></p><p>BigWorld Technology does not cover distribution issues.</p><p>But since an MMOG client must connect to a server to play the
        game, this problem can be solved by modifying the login process so
        that, in addition to the username and password, the CD key is also
        sent to the server and checked against a database.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14197"></a>21.4.&nbsp;Client Cheating</h2></div></div></div><p>As a developer, you need to watch out for hacked clients, and third
    party apps (often called 'trainers'). It is also important to realise that
    it is very hard to prevent all forms of cheating. You should decide what
    forms of cheating will impact you and/or your customers, and work on those
    issues, and do not let minor cheating distract you.</p><p>The most important rule is to always be careful with data sent from
    the client. If possible, everything that the client does should be checked
    for validity on the server. Simple rules, like ensuring that a switch can
    only be activated when the player is close enough to throw the lever, are
    easy to enforce. To simplify these checks, an extra 'source' argument is
    added to the parameter list for every method exposed to the client. The
    client does not send it up <span class="symbol">&#8208;</span> it is added by
    the BaseApp automatically. Also, to make it harder for clients to cheat,
    methods not exposed to the client are excised from the address space that
    it sees.</p><p>Generalised physics checking on more frequent interactions, such as
    movement, is not so easy, since running the physics of every player on the
    server would be quite expensive. One solution is to use the high-level
    geometry of the world as the expression of the important physical rules.
    The world is built up of polyhedral chunks connected by portals. A chunk
    equates to one room in inside areas. Whenever the player moves between
    chunks, we check that the movement passes through a portal, and that the
    player has not moved too fast. This means that we are not concerned about
    petty violations of physical rules, like standing in the middle of a
    table, but we do catch violations that influence the game, like moving
    through walls or locked doors, and moving too quickly.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14209"></a>21.4.1.&nbsp;General Rules for Managing Entity Data</h3></div></div></div><p>The general rule is to send data to the client only if it is
      necessary. This saves bandwidth, as well as helping reduce hacking.
      There are three techniques you can use with BigWorld Technology:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Level of Detail</em></p><p>Instead of constantly sending entity information, you might
          want to send it only when it is within range. For example, a player
          might be able to see a monster from 500 metres away, but its level
          does not have to be sent to the client until it is within 20
          metres.</p></li><li><p><em class="emphasis">Data hiding</em></p><p>Some information should never be sent to the client. For
          example, NPC health could be kept local to the server, and the
          client can just call functions that affect it
          (<em class="emphasis">e.g.</em>, <span class="literal">doDamage(10)</span>). The
          server sends the results to the client (<em class="emphasis">e.g.</em>,
          monster limping because health is below 50%).</p></li><li><p><em class="emphasis">Data on request</em></p><p>The client should call server functions to request data only
          when needed. For example, your game could be designed such that the
          client must physically 'con' a monster by calling a server-side
          function that returns level and health. To detect potential cheating
          the server could then flag clients that con more than one monster
          per second, or con monsters further than 20 metres away.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14242"></a>21.4.2.&nbsp;Writing Secure Game Script</h3></div></div></div><p>As mentioned in other places, the responsibility for security in a
      BigWorld-based game is shared between the engine itself and the game
      script running on top of it. In particular, script writers must be very
      careful in the design and implementation of
      <code class="code">&lt;Exposed/&gt;</code> methods. Please see <a href="#xref_SPG_ExposedMethods" title="5.4.&nbsp;Exposed Methods &#8208; Client-to-Server Communication">Exposed Methods <span class="symbol">&#8208;</span> Client-to-Server
    Communication</a> for more details on the specifics of
      the security requirements for exposed methods.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Please be aware that at this point in time, the FantasyDemo game
        that ships with each BigWorld package has not been bulletproofed
        against the actions of malicious clients and in all likelihood
        contains security vulnerabilities in its exposed methods. We are
        working on improving this and offering a FantasyDemo to customers that
        serves as both a good feature demonstration as well as a good example
        of secure script.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14255"></a>21.4.3.&nbsp;Balancing Security vs. Latency</h3></div></div></div><p>As much as security is important, as a developer you have to be
      careful so that it does not impact too much the player's experience of
      the game.</p><p>The game has to be responsive, but the game play may feel very
      lagged if the client passed all movement and combat commands to the
      server for validation before showing results. Therefore, you are best
      off handling movement on the client side, or simultaneously on the
      client and the server. For example, to have a fast-paced shooting game,
      you would need to perform client-side tests for impact, and show the
      result immediately (monster recoils when hit, etc...). Simultaneously,
      you would send the shoot command to the server, and let the server send
      down any changes of health if the monster is really hit. This means that
      the client cannot cheat with shooting, but still gets lag-free
      results.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14262"></a>21.4.4.&nbsp;Balancing Security vs. Server CPU Cost</h3></div></div></div><p>This is one of the biggest issues in controlling hacking. For
      example, it may be too expensive to check all player physics on the
      server. The developer has to pick the most common forms of cheating, and
      check for those.</p><p>It is sensible to allow checks to be turned on and off per player,
      or only check 10% of the players at any one time. Statistical checking
      can be useful, for example by monitoring how many XP are gained over
      time by players, to check if they are accumulating points at an
      unfeasible rate. If the player becomes a suspect of cheating, then more
      checks can be turned on for him.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Debugging"></a>Chapter&nbsp;22.&nbsp;Debugging</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e14272">22.1. General Debugging</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14275">22.1.1. Information and Error Messages</a></span></dt><dt><span class="section"><a href="#d0e14309">22.1.2. Testing Scripts Using the Python Server</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e14405">22.2. Performance Profiling</a></span></dt><dt><span class="section"><a href="#d0e14465">22.3. Common Mistakes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14468">22.3.1. Definition Files Inconsistent Between the Server and
      Client</a></span></dt><dt><span class="section"><a href="#d0e14477">22.3.2. Implementation (<span class="literal">.py</span>) Does Not Match Definition
      (<span class="literal">.def</span>)</a></span></dt><dt><span class="section"><a href="#d0e14495">22.3.3. Accessing Other Entities' Properties and Methods Not Declared in
      the Definition File</a></span></dt><dt><span class="section"><a href="#d0e14510">22.3.4. Trying to Update the Properties of a Ghost Entity</a></span></dt><dt><span class="section"><a href="#d0e14537">22.3.5. Database backup and fault tolerance doesn't work for entities
      lacking a Base part</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e14546">22.4. Fixed Cell Boundaries</a></span></dt><dt><span class="section"><a href="#d0e14614">22.5. Message Reliability And Ordering</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14272"></a>22.1.&nbsp;General Debugging</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14275"></a>22.1.1.&nbsp;Information and Error Messages</h3></div></div></div><p>When running the server using
      <code class="filename">control_cluster.py</code>, for example, there may not be a
      console associated with an application. In order to view process
      messages when not running from the console the server tools
      MessageLogger<sup>[<a name="d0e14283" href="#ftn.d0e14283">33</a>]</sup>, and WebConsole<sup>[<a name="d0e14296" href="#ftn.d0e14296">34</a>]</sup> should be used for collecting process output and viewing
      log messages respectively.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14309"></a>22.1.2.&nbsp;Testing Scripts Using the Python Server</h3></div></div></div><p>In order to test Python scripts and behaviour on a live server a
      telnet server can be connected to on both the BaseApp and CellApp
      processes to run script. The telnet server by default is run on port
      40001 for a BaseApp, and 50001 for a CellApp, but both can be configured
      in the file
      <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/server/bw.xml</code>
      using the <code class="property">&lt;pythonPort&gt;</code> configuration
      option.</p><p>If the desired port is already used on the application's machine,
      then a random port is chosen. You can find out the assigned port by
      looking at the log output of the particular BaseApp or CellApp for a
      line such as the following:</p><pre class="programlisting">INFO: Python server is running on port 33225</pre><p>This value can also be found in the watcher value
      <span class="literal">pythonServerPort</span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>This is intended primarily as a development time only utility
        and should be used sparingly in a production environment. Performing
        CPU intensive Python operations such as listing all entities may
        adversely affect game behaviour for your clients.</p></div><p>Telnet can be used to connect to the Python server of each BaseApp
      and CellApp, which provides a Python console that can be used for</p><p>There are currently three methods of connecting to the Python
      telnet server:</p><div class="orderedlist"><ol type="1"><li><p>Connecting via WebConsole</p></li><li><p>Connecting via <code class="filename">control_cluster.py</code></p></li><li><p>Connecting via the commandline using
          <span class="application">telnet</span></p></li></ol></div><p>Connecting to the Python server via WebConsole is the recommended
      method of interacting with the Python server as it allows access to the
      other server debugging tools as required. To connect through WebConsole
      simply select the <em class="emphasis">Python Console</em> module from the
      menu on the left hand side of the main WebConsole page.</p><p>To connect using <code class="filename">control_cluster.py</code>, simply
      use the <span class="literal">pyconsole</span><sup>[<a name="d0e14364" href="#ftn.d0e14364">35</a>]</sup> option. For example, to connect to the second CellApp in a
      cluster:</p><pre class="programlisting">$ ./control_cluster.py pyconsole cellapp02</pre><p>To connect using <span class="application">telnet</span>, after
      determining the port the process has an active python server on simply
      provide telnet with the <em class="emphasis">hostname</em> and
      <em class="emphasis">port</em>. For example, to connect to a machine called
      <span class="literal">cluster01</span> running a BaseApp with a Python server
      running on port <span class="literal">40001</span> the following command would be
      used:</p><pre class="programlisting">$ telnet cluster01 40001</pre><p>Once connected to the Python console server it is possible to call
      script methods. For example, in FantasyDemo, the player entity is called
      <code class="classname">Avatar</code>, and it is possible to access its cell or
      base parts after a player logs in:</p><pre class="programlisting">$ telnet cluster02 50001
Trying 10.40.3.4...
Connected to cluster02.
Escape character is '^]'.
Welcome to Cell App 1
Build: 13:34:56 Apr 12 2005
&gt; BigWorld.entities.keys()
[4848, 4849]
&gt; BigWorld.entities[4848]
Avatar at 0x08533FDC
&gt; avatar = _
&gt; avatar.playerName
'Trogdor the Burninator'
&gt; avatar.beginTrade()</pre><p><span class="citetitle">Accessing an avatar via the Python console on the
      cell</span></p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14405"></a>22.2.&nbsp;Performance Profiling</h2></div></div></div><p>Python has helpful modules that can be used to profile your script.
    BigWorld exposes the method <em class="emphasis">_hotshot</em>
    through the watcher interface, to help with profiling BigWorld
    script.</p><p>To start profiling, set the watcher
    <span class="literal">pythonProfile/running</span> to <span class="literal">true</span>. The
    profiler outputs its log to a file with the filename specified by the
    watcher <span class="literal">pythonProfile/filename</span>, the file name being
    relative to the current working directory, most likely to be
    <span class="literal">bigworld/bin/Hybrid</span>. Setting the watcher
    <span class="literal">pythonProfile/running</span> to <span class="literal">false</span> ends
    the profiling session, and closes the profile log.</p><p>To inspect the log, use the module <em class="emphasis">hotshot.stats</em>.</p><p>For example,</p><pre class="programlisting">$ python
&gt; import hotshot.stats
&gt; stats = hotshot.stats.load( "cell.prof" )
&gt; stats.sort_stats( "time", "calls" )
&gt; stats.print_stats( 20 )</pre><p>Please note that there may be problems inspecting the profiling log,
    if the call stack depth gets smaller than when the session was started, or
    the session is stopped at a different call stack depth. Due to that, care
    must be taken when starting and stopping profiling from script.</p><p>It is also possible to use the module <em class="emphasis">_hotshot</em> in script. This may be helpful if you only
    want to profile specific parts of the script. A profiler object can be
    created, and then started and stopped over a specific method call.</p><p>For example, the following could be added to file
    <span class="literal">fantasydemo/res/scripts/cell/Creature.py</span> to profile the
    method <span class="literal">Creature.onTime</span>:</p><pre class="programlisting">import _hotshot
profiler = None

def startProfiling():
  global profiler
  profiler = _hotshot.profiler( "creature.prof" )

def stopProfiling():
  global profiler
  profiler.close()
  profiler = None

class Creature( BigWorld.Entity ):
  def onTimer( self, timerId, userId ):
    if profiler:
        profiler.start()

    # Normal function body

    if profiler:
        profiler.stop()</pre><p>This can be started and stopped with something like the
    following.</p><pre class="programlisting">$ telnet bgserver 50001
Trying 10.40.3.4...
Connected to bgserver.
Escape character is '^]'.
Welcome to Cell App 1
Build: 13:34:56 Apr 12 2005
&gt; import Creature
&gt; Creature.startProfiling()
&gt; Creature.stopProfiling()</pre><p>For more details on the hotshot module, see the Python documentation
    at http://docs.python.org/lib/module-hotshot.html.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14465"></a>22.3.&nbsp;Common Mistakes</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14468"></a>22.3.1.&nbsp;Definition Files Inconsistent Between the Server and
      Client</h3></div></div></div><p>To ensure that the client can understand the data sent by the
      server, the definition files must be kept consistent between
      them.</p><p>A client will not be able to log in if it has inconsistent
      definition files. The LoginApp and the DBMgr produce the following
      error:</p><pre class="programlisting">INFO: LoginApp::sendFailure: LogOn for 10.40.3.17:2254 failed 'Bad digest'</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14477"></a>22.3.2.&nbsp;Implementation (<span class="literal">.py</span>) Does Not Match Definition
      (<span class="literal">.def</span>)</h3></div></div></div><p>For each entity type, its Python script must implement the methods
      described in its <span class="literal">.def</span> file. The server will report an
      error if this does not occur.</p><p>For example:</p><pre class="programlisting">ERROR: EntityDescription::checkMethods: class Avatar does not have method sendMessageToFriends
ERROR: EntityType::Type: Script for Avatar is missing a method.</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14495"></a>22.3.3.&nbsp;Accessing Other Entities' Properties and Methods Not Declared in
      the Definition File</h3></div></div></div><p>It is possible to access a property of another entity when it is
      on the same process as the calling entity. This is true for both base
      and cell entities.</p><p>This works during initial testing, when only one BaseApp and one
      CellApp are used, but is likely to not work when more BaseApps and
      CellApps are used.</p><p>Properties of remote entities cannot be written to directly (i.e.
      they are read-only), regardless of whether those properties are declared
      in the <span class="literal">.def</span> file. Also, only methods declared in the
      <span class="literal">.def</span> file can be called when the entity is on another
      application.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14510"></a>22.3.4.&nbsp;Trying to Update the Properties of a Ghost Entity</h3></div></div></div><p><em class="emphasis">Sometimes the game design might have two
      entities moving through the world close to each </em>other, as
      would be the case of an Avatar and a Bodyguard, or a Pet. Due to their
      proximity, developers might assume that they will always be located in
      the same cell as each other, and thus have one of the entities try to
      update a property on the other (<em class="emphasis">e.g.</em>,
      <span class="literal">self.bodyguard.armour=true</span>, or
      <span class="literal">self.pet.state=Alert</span>).</p><p>Though this will not cause problems most of the time, it might
      happen that the two entities are separated by a cell boundary, and thus
      will only have access to the other one's ghost, which will cause the
      properties to be read-only.</p><p>To test for the existence of this kind of problem, CellApp has the
      configuration option <span class="literal">treatAllOtherEntitiesAsGhosts</span>.
      This option causes the CellApp to treat only its own entity as real, and
      all others as ghosts. For more details, see <a href="#xref_Data_Distribution" title="4.3.&nbsp;Data Distribution">Data Distribution</a>.</p><p>This debugging mode allows script writers to catch these errors
      immediately instead of leaving them lurking in the background to only
      appear on rare occasions.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14537"></a>22.3.5.&nbsp;Database backup and fault tolerance doesn't work for entities
      lacking a Base part</h3></div></div></div><p>As noted in the Python API documentation, the writeToDB() method
      can only be called on entities that have a Base part. That means you
      cannot persist entities that do not have a Base part.</p><p>The server's first-level fault tolerance (which restores entities
      when a CellApp dies) also relies on those entities having a Base part.
      The state of the entity is backed up from the Cell to the Base part over
      time and if the CellApp that is hosting an entity's Cell part
      disappears, the Base entity will restore it to another CellApp. This
      does not work unless you create each entity type with a Base and Cell
      part.</p><p>This means that you may need to declare more-or-less empty Base
      entity definitions for entities that don't have any Base methods, just
      so that they can be written to the database and so that they will be
      restored in the event of a CellApp crash.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14546"></a>22.4.&nbsp;Fixed Cell Boundaries</h2></div></div></div><p>To help the testing and debugging of the transitioning of entities
    between CellApps, it can be helpful to have fixed cell boundaries.</p><p>Typical things that could be tested this way include:</p><div class="itemizedlist"><ul type="disc"><li><p>Controllers and entity extras implemented in extensions.</p></li><li><p>Script interaction of entities on different CellApps.</p></li><li><p>Streaming of entity properties.</p></li></ul></div><p>To configure fixed cell boundaries in BigWorld, follow the steps
    below:</p><div class="itemizedlist"><ul type="disc"><li><p>Start the server including at least two CellApps.</p></li><li><p>Make sure that cells are created on all CellApps by setting the
        configuration options
        <span class="literal">cellAppMgr/cellAppLoadLowerBound</span> and
        <span class="literal">cellAppMgr/cellAppLoadUpperBound</span> to
        <span class="literal">0.0</span> in file
        <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/server/bw.xml</span>.
        These options can also be changed with the watcher values
        <span class="literal">cellAppLoad/ balanceLowerBound</span> and
        <span class="literal">cellAppLoad/balanceUpperBound</span> of CellAppMgr.</p></li><li><p>Disable load balancing by setting the CellAppMgr watcher value
        <span class="literal">debugging/shouldLoadBalance</span> to
        <span class="literal">false</span>.</p></li><li><p>It can also be convenient to set the exact position of a
        partition. Currently, only the root partition of a space can have its
        position set. This can be set with the CellAppMgr watcher value
        <span class="literal">spaces/<em class="replaceable"><code>&lt;spaceID&gt;</code></em>/rootPartition</span>,
        where <span class="literal"><em class="replaceable"><code>&lt;spaceID&gt;</code></em></span> is
        the space ID.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e14614"></a>22.5.&nbsp;Message Reliability And Ordering</h2></div></div></div><p>BigWorld is a networked, distributed system, and as such, script
    writers need to be aware of the reliability and ordering issues that can
    arise in such a system. All non-volatile messages are reliably delivered.
    BigWorld guarantees not only the reliable delivery but also the in-order
    delivery of some messages. These are:</p><div class="itemizedlist"><ul type="disc"><li><p>Messages sent between Proxy and Client</p></li><li><p>Messages sent between the Base and Cell part of the same
        entity</p></li><li><p>Messages sent between two Base entities</p></li><li><p>Messages sent between any pair of server processes</p></li><li><p>Updates sent from a real entity to its ghosts</p></li></ul></div><p>The offloading of Cell entities from one CellApp to another can
    cause some messages to be delivered slightly out-of-order. This means your
    game script may need to cope with method calls and property updates being
    slightly out-of-order if they are triggered by any of the following
    message types:</p><div class="itemizedlist"><ul type="disc"><li><p>Messages sent between two different Cell entities</p></li><li><p>Messages sent between the Cell part of one entity and the Base
        part of another</p></li><li><p>Messages sent between the Cell part of one entity and the Client
        part of another</p></li></ul></div><p>It is important to note that the probability of out-of-order
    delivery of these messages is directly proportional to the amount of
    packet loss on the network the server processes are running,
    <em class="emphasis">i.e.</em> this re-ordering cannot happen unless you are
    getting some degree of packet loss. We cannot emphasise enough the
    importance of using good quality hardware (both computers and network
    hardware) in your production deployment clusters, and having enough
    hardware in your clusters that you can run your game servers with an ample
    amount of CPU and network capacity to spare. BigWorld's experience with
    customer deployments has shown that inferior and/or insufficient hardware
    is likely to cause critical (<em class="emphasis">i.e</em> showstopping)
    problems at runtime.</p></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e14283" href="#d0e14283">33</a>] </sup>For details on MessageLogger, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Admin_Tools" class="olink"><i>Cluster Administration Tools</i></a>
          <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_MessageLogger" class="olink">Message Logger</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e14296" href="#d0e14296">34</a>] </sup>For details on WebConsole, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Admin_Tools" class="olink"><i>Cluster Administration Tools</i></a>
          <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_WebConsole" class="olink">WebConsole</a>.</p></div><div class="footnote"><p><sup>[<a name="ftn.d0e14364" href="#d0e14364">35</a>] </sup>For more information regarding this option see the
          <code class="filename">control_cluster.py</code> program help using the
          <code class="option">--help</code> flag.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Simplified_Server_Usage"></a>Chapter&nbsp;23.&nbsp;Shared Development Environments</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Window_Linux_Cross_Platform_Development">23.1. Windows and Linux cross platform development</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Sharing_Resources_From_Windows">23.1.1. Sharing resources from Windows</a></span></dt><dt><span class="section"><a href="#d0e14858">23.1.2. Accessing Windows share from Linux</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15015">23.2. Using BigWorld with a Version Control System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e15020">23.2.1. Customers using the Commercial Edition</a></span></dt><dt><span class="section"><a href="#d0e15029">23.2.2. Customers using the Indie Edition</a></span></dt><dt><span class="section"><a href="#xref_Version_Control_Exclusions">23.2.3. Files to exclude from version
      control</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15139">23.3. DBMgr database conflicts</a></span></dt></dl></div><p>As the workflow of creating a game requires a large number of people
  working on a numerous components simultaneously within a variety of
  environments it is nescessary to ensure that everybody can work together in
  as seamless a manner as possible. This chapter aims to outline the key areas
  in which interaction is required and the recommended methods to avoid
  conflicts.</p><p>Currently there are three areas that have been identified that may
  cause potential interaction conflict for an unprepared development
  team:</p><div class="orderedlist"><ol type="1"><li><p>Windows and Linux cross platform development.</p></li><li><p>Using BigWorld with a Version Control System.</p></li><li><p>DBMgr database conflicts.</p></li></ol></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Window_Linux_Cross_Platform_Development"></a>23.1.&nbsp;Windows and Linux cross platform development</h2></div></div></div><p>For anyone not familiar with both Windows and Linux, running a
    BigWorld server on a Linux box to test game scripts and assets can be
    intimidating and error prone. Since designers and artists typically do
    most of their work on Windows, the process of synchronising files between
    Windows and Linux machines can be tedious.</p><p>The solution outlined below aims to simplify this task by having all
    assets and game scripts reside on a Windows machine, with a Linux machine
    (which can be shared among multiple users) hosting and running a BigWorld
    server for each user that requires their own development
    environment.</p><div class="informalfigure"><div class="mediaobject" align="center"><img src="images/shared_resources.png" align="middle" height=""><span class="caption"><p>Sharing game resources between Windows and
        Linux</p></span></div></div><p>This solution can be summarised as follows:</p><div class="orderedlist"><ol type="1"><li><p>A game developer on a Windows machine creates a network share of
        the root BigWorld directory (<em class="emphasis">i.e.</em>, the directory
        containing <code class="filename">bigworld</code>, <code class="filename">fantasydemo</code>, and <code class="filename">src</code> folders).</p></li><li><p>On the Linux machine, the Windows share from Step 1 is mapped to
        a directory and the relevant <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em></code>
        directories and used when a BigWorld server is started.</p></li></ol></div><p>Cross-mounting development resources has been found within the
    BigWorld offices to be the most effective method for Windows based
    developers and artists to work, as all editable files reside on the
    machine they are working on.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>This solution intentionally keeps the server binaries on the Linux
      box.</p><p>Running server executables that exist on Samba mounted filesystems
      can cause unexpected problems, and is not recommended.</p><p>Running server binaries from NFS mounted filesystems works
      correctly and is a recommended alternative.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Sharing_Resources_From_Windows"></a>23.1.1.&nbsp;Sharing resources from Windows</h3></div></div></div><p>For the purposes of this example we assume that all the game
      resources have been checked out into a directory called <code class="filename">C:\BigWorld</code>.</p><p>To share the <code class="filename">C:\BigWorld</code>
      directory on the Windows machine, follow the steps below for your
      version of Windows.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14733"></a>23.1.1.1.&nbsp;Windows XP</h4></div></div></div><div class="orderedlist"><ol type="1"><li><p>Browse to the <code class="filename">C:\</code>
            drive in Explorer.</p></li><li><p>Select the <code class="filename">BigWorld</code>
            directory and right-click it.</p></li><li><p>In the context menu, select the <em class="emphasis">Sharing and Security...</em> menu item.</p></li><li><p>On the <em class="emphasis">mf Properties</em> dialog
            box, select the <em class="emphasis">Share This Folder</em>
            option button.</p></li><li><p>In the <em class="emphasis">Share Name</em> field,
            type the name to share the folder by (in our example, <em class="emphasis">mf-win</em>).</p></li><li><p>Click the <em class="emphasis">Permissions</em>
            button.</p></li><li><p>In the <em class="emphasis">Permission For mf</em>
            dialog box's <em class="emphasis">Group or User Names</em>
            list box, select the <em class="emphasis">Everyone</em>
            item.</p></li><li><p>In the <em class="emphasis">Permissions For
            Everyone</em> list box's <em class="emphasis">Full
            Control</em> entry, select the <em class="emphasis">Allow</em> check box.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14803"></a>23.1.1.2.&nbsp;Windows 7</h4></div></div></div><div class="orderedlist"><ol type="1"><li><p>Browse to the <code class="filename">C:\</code>
            drive in Explorer.</p></li><li><p>Select the <code class="filename">BigWorld</code>
            directory and right-click it.</p></li><li><p>In the context menu, select the <em class="emphasis">Properties</em> menu item.</p></li><li><p>Select the <em class="emphasis">Sharing</em>
            tab.</p></li><li><p>Click the <em class="emphasis">Advanced
            Sharing...</em> button.</p></li><li><p>In the <em class="emphasis">Advanced Sharing</em>
            dialog box, select the <em class="emphasis">Share this
            folder</em> check box.</p></li><li><p>If necessary, click the <em class="emphasis">Permissions</em> button to enable all users
            access privileges to this share.</p></li><li><p>Click <em class="emphasis">OK</em> when
            finished.</p></li></ol></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e14858"></a>23.1.2.&nbsp;Accessing Windows share from Linux</h3></div></div></div><p>To assist the process of mounting the Windows share, BigWorld
      provides the script <code class="filename">setup_win_dev</code>. The location of
      this script may differ depending on your edition.</p><div class="variablelist"><dl><dt><span class="term">Indie Edition</span></dt><dd><p>For customers using the Indie edition,
            <code class="filename">setup_win_dev</code> will be installed into
            <code class="filename">/opt/bigworld/current/server/bin</code> by
            the server RPM package. This directory has also been placed into
            your <code class="envar">$PATH</code> so you can run
            <code class="filename">setup_win_dev</code> from any directory.</p></dd><dt><span class="term">Commercial Edition</span></dt><dd><p>Customers using the Commercial edition can find the
            setup_win_dev script located in
            <code class="filename">bigworld/tools/server/install/setup_win_dev.py</code>.</p></dd></dl></div><p>Please note, however, that it was designed for developers working
      at BigWorld, and hence it uses default values appropriate for BigWorld
      as well. Before artists and game programmers use it, a sysadmin or
      programmer should edit this file to change the defaults to values
      appropriate for your development environment.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14896"></a>23.1.2.1.&nbsp;Assumptions and Requirements</h4></div></div></div><p>This <code class="filename">setup_win_dev</code> script has following
        assumptions:</p><div class="itemizedlist"><ul type="disc"><li><p>The server binaries can be accessed on the Windows
            share.</p></li><li><p>Your username on the Windows box is the same as your
            username on the Linux box.</p></li><li><p>You are using CentOS 5 or later.</p></li><li><p>Linux kernel with CIFS module. This should be contained
            within the default CentOS kernel.</p></li></ul></div><p>The script will display a list of prerequisites upon startup,
        which are reproduced here for convenience:</p><div class="itemizedlist"><ul type="disc"><li><p>The user running the script has been entered into the
            <code class="filename">/etc/sudoers</code> file on the Linux
            machine.</p><p>For details see the system manual page with the command
            '<span><strong class="command">man sudoers</strong></span>'.</p></li><li><p>You know the location of your home directory on the Linux
            machine.</p><p>This can generally be discovered by running the following
            command:</p><pre class="programlisting">$ echo $HOME
/home/alice</pre></li><li><p>You have shared the top level BigWorld directory from your
            Windows machine.</p><p>For details on how to achieve this see <a href="#xref_Sharing_Resources_From_Windows" title="23.1.1.&nbsp;Sharing resources from Windows">Sharing resources from Windows</a>.</p></li><li><p>You may also require the Samba client programs. To install
            the Samba client, run the following command as the root
            user:</p><pre class="programlisting"># yum install samba-client</pre></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e14950"></a>23.1.2.2.&nbsp;Mapping a Windows share onto Linux</h4></div></div></div><p>Once the requirements outlined above have been met, or any
        necessary modifications have been made to your environment, running
        the <code class="filename">setup_win_dev</code> script will guide you through
        mounting a Windows share using Samba onto the Linux machine.</p><p>Outlined below is a simple run through of the
        <code class="filename">setup_win_dev</code> program discussing each
        step.</p><p>When the program is first run, it attempts to establish root
        user privileges using the <span><strong class="command">sudo</strong></span> command. This
        enables the program to interact with the system devices nescessary to
        provide access to your Windows share. This step may not be nescessary
        if you have recently performed another command using sudo. Enter the
        password for the account you are currently logged in as.</p><pre class="programlisting">$ setup_win_dev
NOTE: If you are immediately prompted for a password, enter your *own*
      password not that of the root user.

* Validating user has 'sudo' privileges
Password: </pre><p>Next we see that the program is preparing a destination
        directory for the Windows share to be placed under. This directory
        defaults to <code class="filename"><code class="envar">$HOME</code>/bigworld_windows_share</code>.</p><pre class="programlisting">* Setting up destination location for Windows resources</pre><p>The next step involves entering information regarding the
        location of the Windows machine and the name of the shared resources.
        If you are uncertain about any of the details attempt to access your
        Windows machine from another machine in the network to establish the
        machine name and share name.</p><pre class="programlisting">* Querying location of remote resources

Enter the hostname of your Windows machine: <em class="emphasis">mywindowsmachine</em>
Enter the share name of the shared BigWorld directory: <em class="emphasis">BigWorld_indie</em></pre><p>You now need to input the username and password required to
        access the Windows machine. The username will default to the username
        of your unix account, however if your Windows login is different
        simply enter that here.</p><pre class="programlisting">We now need the username and password required to connect to the Windows share
Username [alice]: <em class="emphasis">bob</em>
Password: 
Confirm password: </pre><p>The <code class="filename">setup_win_dev</code> program now outputs the
        resource name to be used when accessing the Windows share. This
        resource name can be used by other Samba tools such as smbclient if
        you are having troubles connecting.</p><pre class="programlisting">Using remote location: '//mywindowsmachine/BigWorld_indie'</pre><p>Finally you will be asked if you wish to have the Windows share
        always available on the Linux machine. This allows you to reboot or
        shutdown the Linux machine whenever you need to without having to
        remount the Windows share. If you choose 'yes' a new file that is only
        readable by your user will be created in
        <code class="filename"><code class="envar">$HOME</code>/.bw_share_credentials</code>
        containing your username and password.</p><pre class="programlisting">Do you want to automount your Windows share each time this Linux box boots?
This will place a file in your home directory containing a clear-text copy
of your password that is only readable by your user. [yes]</pre><p>The setup_win_dev program will now attempt to make the Windows
        shared resources available for you.</p><pre class="programlisting">Patched /etc/fstab successfully
//mywindowsmachine/BigWorld_indie is mounted at /home/alice/bigworld_windows_share
* Windows directory successfully mounted</pre></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e15015"></a>23.2.&nbsp;Using BigWorld with a Version Control System</h2></div></div></div><p>It is strongly recommended that a version control system such as
    CVS, SVN or Perforce is used while developing a game using BigWorld. In
    doing so you allow numerous people within your development team to remain
    up to date with changes and enable access to all parts of the project
    resources regardless of the development platform of an individual.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e15020"></a>23.2.1.&nbsp;Customers using the Commercial Edition</h3></div></div></div><p>Most recipients of an SVN distribution should place the entire
      release received from BigWorld into their version control system. This
      ensures that any changes to the BigWorld source code and resources are
      propagated to all the game developers at once.</p><p>Some files should not be committed into the version control
      system. Please review the section <a href="#xref_Version_Control_Exclusions" title="23.2.3.&nbsp;Files to exclude from version control">Files to exclude from version
      control</a> for further details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e15029"></a>23.2.2.&nbsp;Customers using the Indie Edition</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e15032"></a>23.2.2.1.&nbsp;Creating a project repository</h4></div></div></div><p>Customers using the Indie edition should only commit their own
        project directories into version control.</p><p>Indie customers should only commit their own project directories
        into version control.</p><p>For example in the case of a new game called
        &#8220;<span class="quote">my_game</span>&#8221; it is recommended to commit the directory
        <code class="filename">C:\BigWorld\my_game</code> into your
        version control system.</p><p>Some files should not be committed into the version control
        system. Please review the section <a href="#xref_Version_Control_Exclusions" title="23.2.3.&nbsp;Files to exclude from version control">Files to exclude from version
      control</a> for further
        details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e15051"></a>23.2.2.2.&nbsp;Checking out an existing project</h4></div></div></div><p>When setting up a new client machine run the installation
        procedures outlined in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../client_installation_guide/client_installation_guide.html#Client_Installation_Guide" class="olink">Client Installation Guide</a> and then checkout your project
        into the new installation.</p><p>When setting up a new server machine run the installation
        procedures outlined in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_installation_guide/server_installation_guide.html#Server_Installation_Guide" class="olink">Server Installation Guide</a>. You will then need to
        checkout your project into the home directory of the user running the
        server, or follow the instructions outlined in <a href="#xref_Window_Linux_Cross_Platform_Development" title="23.1.&nbsp;Windows and Linux cross platform development">Windows and Linux cross platform development</a> to use
        resources mounted from a Windows machined. After preparing the server
        and the game resources for use you will also need to ensure that the
        .bwmachined.conf file has been updated accordingly. Details on the
        .bwmachined.conf file can be found in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_installation_guide/server_installation_guide.html#Server_Installation_Guide" class="olink">Server Installation Guide</a>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Version_Control_Exclusions"></a>23.2.3.&nbsp;Files to exclude from version
      control</h3></div></div></div><p>There are numerous files that are automatically generated while
      running a the BigWorld Technology Suite which are only relevant to the
      user currently running a program. These files should be excluded from
      your version control system to avoid conflicts with other users. Each
      version control system provides its own mechanism to ignore or exclude
      files. For example Subversion allows you to set a directory property
      <span class="literal">svn:ignore</span> to a list of file match patterns for that
      directory.</p><p>Below is listed a set of files and directories that should be
      considered for adding exclusion rules to your version control repository
      and configuration files.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e15076"></a>23.2.3.1.&nbsp;General exclusion rules</h4></div></div></div><p>Application log files such as <code class="filename">python.log</code> or
        <code class="filename">worldeditor.log</code> should not be committed into your
        repository.</p><pre class="programlisting">*.log</pre><p>When you run the game client or the tools, some resources will
        be created on-disk as 'processed' or 'compiled' versions of source
        files. These files are regenerated on demand based on comparing the
        timestamp of the source with the timestamp of the automatically
        generated file. These files should not be committed into your
        repository.</p><pre class="programlisting">*.dds        # Compressed texture map files
*.anca       # Compressed animation files
*.font       # Processed font files
font/*.dds   # Generated font bitmaps</pre><p>Python scripts used for client and server game logic will
        generate a compiled byte-code file when they are first run or updated.
        As these files will be changing frequently during development they
        should not be included in the repository to help reduce clutter with
        each changeset.</p><pre class="programlisting">*.pyc</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e15097"></a>23.2.3.2.&nbsp;Tools specific exclusion rules</h4></div></div></div><p>The art pipeline tools automatically generate user preference
        files when they are run. As these will differ between artists they
        should be excluded from the repository.</p><pre class="programlisting">bigworld/tools/worldeditor/options.xml
bigworld/tools/worldeditor/resources/graphics_preferences.xml

bigworld/tools/particleeditor/options.xml

bigworld/tools/modeleditor/options.xml</pre><p>The art tools Asset Browser also generates history files as it
        is being used.</p><pre class="programlisting">bigworld/tools/modeleditor/resources/ual/history.xml
bigworld/tools/modeleditor/resources/ual/favourites.xml

bigworld/tools/particleeditor/resources/ual/history.xml
bigworld/tools/particleeditor/resources/ual/favourites.xml

bigworld/tools/worldeditor/resources/ual/history.xml
bigworld/tools/worldeditor/resources/ual/favourites.xml</pre><p>WorldEditor will create a
        <code class="filename">space.localsettings</code> file when creating a new
        space.</p><pre class="programlisting"><em class="replaceable"><code>&lt;your_game&gt;</code></em>/res/spaces/<em class="replaceable"><code>&lt;your_new_space&gt;</code></em>/space.localsettings</pre><p>WorldEditor will also create two files containing a space map.
        Both these files must be committed to revision control or
        neither.</p><pre class="programlisting"><em class="replaceable"><code>&lt;your_game&gt;</code></em>/res/spaces/<em class="replaceable"><code>&lt;your_space&gt;</code></em>/space.thumbnail.dds
<em class="replaceable"><code>&lt;your_game&gt;</code></em>/res/spaces/<em class="replaceable"><code>&lt;your_space&gt;</code></em>/space.thumbnail.timestamps</pre><p>The BigWorld game client will also generate a preferences file
        in the directory it is run from.</p><pre class="programlisting"># Substitute 'fantasydemo' for your game name
fantasydemo/game/preferences.xml</pre></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e15139"></a>23.3.&nbsp;DBMgr database conflicts</h2></div></div></div><p>For customers using a MySQL database to store persistent data,
    shared development environments can present an issue with multiple servers
    contending for the same database.</p><p>The database used by DBMgr is exclusive per server cluster instance
    so it is nessecary for multiple users running a server on the same machine
    to use different databases. To do this requires adding or modifying the
    the &lt;res&gt;/server/bw.xml configuration file entries for
    <span class="literal">dbMgr/host</span> and <span class="literal">dbMgr/databaseName</span>.
    Specifically the <span class="literal">databaseName</span> should be unique per
    user. For more information on these options refer to the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a> section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>.</p></div></div></div><div class="part" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="xref_Part_Server_CPP_Programming_Guide"></a>Part&nbsp;II.&nbsp;Server C++ Programming Guide</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#xref_CPP_Overview">24. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Compilation">24.1. Compilation</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Output_Directories">24.1.1. Output Directories</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Extending_BigWorld_Server">25. Extending BigWorld Server</a></span></dt><dt><span class="chapter"><a href="#xref_Entity_Extras_And_Controllers">26. Entity Extras and Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e15368">26.1. Implementing Entity Extras</a></span></dt><dt><span class="section"><a href="#d0e15567">26.2. Implementing Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e15891">26.2.1. Configuring Portal's Permissivity</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15969">26.3. Integrating Entity Extras and Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16075">26.3.1. Restricting the Number of Controllers Per Entity</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Updatable_Objects">27. Updatable Objects</a></span></dt><dt><span class="chapter"><a href="#xref_Encrypting_Client_Server_Traffic">28. Encrypting Client-Server Traffic</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Generating_RSA_Keypair">28.1. Generating your own RSA keypair</a></span></dt><dt><span class="section"><a href="#d0e16240">28.2. Working with multiple keys</a></span></dt><dt><span class="section"><a href="#d0e16254">28.3. Customising the symmetric encryption algorithm</a></span></dt><dt><span class="section"><a href="#xref_How_Packet_Filters_Work">28.4. How PacketFilters work</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16289">28.4.1. High-level requirements</a></span></dt><dt><span class="section"><a href="#d0e16313">28.4.2. Filtering mechanics and requirements</a></span></dt><dt><span class="section"><a href="#d0e16416">28.4.3. Extra space for filtering</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Mercury_Packet_Structure">29. Mercury Packet Structure</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16490">29.1. Header</a></span></dt><dt><span class="section"><a href="#d0e16503">29.2. Messages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16547">29.2.1. Fixed-Length Messages</a></span></dt><dt><span class="section"><a href="#d0e16566">29.2.2. Variable-Length Messages</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e16585">29.3. Footers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16595">29.3.1. Fragment Numbers</a></span></dt><dt><span class="section"><a href="#d0e16610">29.3.2. Sequence Number</a></span></dt><dt><span class="section"><a href="#d0e16618">29.3.3. ACKs</a></span></dt><dt><span class="section"><a href="#d0e16631">29.3.4. Indexed Channel ID</a></span></dt><dt><span class="section"><a href="#d0e16639">29.3.5. First Request Offset and <span class="literal">replyID</span></a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Watcher_Interface">30. The Watcher Interface</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16722">30.1. Callable Function Watchers</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Forwarding_Watchers">30.1.1. Forwarding Watchers</a></span></dt><dt><span class="section"><a href="#xref_Implement_Function_Watchers">30.1.2. Implementing Function Watchers</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Debug_Message_Macros">31. Debug Message Macros</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17094">31.1. Centralised Logging</a></span></dt><dt><span class="section"><a href="#xref_Filtering_By_Priority">31.2. Filtering by Priority</a></span></dt><dt><span class="section"><a href="#d0e17145">31.3. Message Priority</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Non_Blocking_Socket_IO_Using_Mercury">32. Non-Blocking Socket I/O Using Mercury</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17271">32.1. Getting Callbacks From Mercury::EventDispatcher</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_MySQL_Database_Schema">33. MySQL Database Schema</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Entity_Tables">33.1. Entity Tables</a></span></dt><dt><span class="section"><a href="#xref_Non_Entity_Tables">33.2. Non-Entity Tables</a></span></dt></dl></dd></dl></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_CPP_Overview"></a>Chapter&nbsp;24.&nbsp;Overview</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Compilation">24.1. Compilation</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Output_Directories">24.1.1. Output Directories</a></span></dt></dl></dd></dl></div><p>This part of the document contains technical information for extending
  and customising the BigWorld Server. It is part of a larger set of
  documentation describing the whole BigWorld system.</p><p>The intended audience is technical-MMOG developers with game-specific
  needs that require the efficiency of C++ extensions.</p><p>For API-level information, please refer to the API reference
  documentation.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Compilation"></a>24.1.&nbsp;Compilation</h2></div></div></div><p>BigWorld uses Linux makefiles in order to compile C++ source code on
    Linux machines. Most source code directories will have a file called
    <code class="filename">Makefile</code> in the directory if they support compilation
    from Linux. Common build scripts are placed under the directory <code class="filename">bigworld/src/build</code> so they can be used by
    multiple projects.</p><p>To perform a compilation of all supported Linux components, perform
    the following from a command prompt:</p><pre class="programlisting">$ cd bigworld/src
$ make</pre><p>This will run the <span><strong class="command">make</strong></span> process using the
    <code class="filename">Makefile</code> in each source directory to compile and
    generate the Linux binaries.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Output_Directories"></a>24.1.1.&nbsp;Output Directories</h3></div></div></div><p>There are a number of locations where programs may be compiled to
      under Linux depending on their function. The following list outlines
      directories according to their contents.</p><div class="itemizedlist"><ul type="disc"><li><p><code class="filename">bigworld/bin</code></p><p>Server process binaries that are used for running a BigWorld
          server.</p></li><li><p><code class="filename">bigworld/bin/web</code></p><p>This directory only contains the dynamic library used for
          Apache integration with the BigWorld server.</p></li><li><p><code class="filename">bigworld/src/lib/bin</code></p><p>The location of statically compiled libraries generated from
          the source code located in <code class="filename">bigworld/src/lib</code>. These libraries are
          used to link into server processes.</p></li><li><p><code class="filename">bigworld/tools/server/bin</code></p><p>All server tool binaries generated from C++ source are placed
          into this directory.</p></li></ul></div></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Extending_BigWorld_Server"></a>Chapter&nbsp;25.&nbsp;Extending BigWorld Server</h2></div></div></div><p>The best way of extending BigWorld is to take advantage of its
  extension loading mechanism. When a CellApp or BaseApp component of the
  system is loaded, it checks for executable objects in its extensions
  directory, and dynamically loads each one separately, in alphabetical
  order.</p><p>The extensions directory is located in the same folder of the
  component executable, and is named after it, with the
  <span class="literal">-extensions</span> suffix.</p><p>For example, the CellApp's extensions directory is cellapp-extensions,
  and is normally located under folder
  <span class="literal">bigworld/bin/$MF_CONFIG</span>.</p><p>The file <code class="filename">bigworld/src/build/common.mak</code> contains
  Makefile rules to ease the compilation of server extensions, and it is
  recommended that you use of it.</p><p>The format of a Makefile for an extension is described below (italics
  indicate placeholders):</p><pre class="programlisting">SO = <em class="replaceable"><code>extension_name</code></em>
COMPONENT = <em class="replaceable"><code>component_name</code></em>
SRCS = <em class="replaceable"><code>source files</code></em>

include $(MF_ROOT)/bigworld/src/build/common.mak

all::</pre><p>The list below describes the Makefile entries:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">SO</span></em></p><p>Name chosen for the extension.</p></li><li><p><em class="emphasis"><span class="literal">COMPONENT</span></em></p><p>Name of the BigWorld component to extend (CellApp or
      BaseApp).</p></li><li><p><em class="emphasis"><span class="literal">SRCS</span></em></p><p>List of sources files to compile, separated by white spaces
      (excluding the suffix '<span class="literal">.cpp</span>').</p></li></ul></div><p>There is no blueprint for what an extension must do, and there is no
  API that is called by the host component. In general, any functionality that
  does not damage the operation of the host component may be compiled into an
  extension, including launching threads, and sending network messages.
  However, extensions must take great care not to block the main thread of the
  component while running in the game.</p><p>Since an extension is a dynamic library, it does not have any standard
  entry point such as <code class="function">main</code>(). Usually, an extension must
  have static initialisers that call back into its host component to hook in
  somewhere, or else the extension will have no way of being executed. Most
  BigWorld systems have macros that create such static initialisers
  automatically, such as <span class="literal">IMPLEMENT_CHUNK_ITEM</span> for a chunk
  item type.</p><p>The BigWorld infrastructure is modular, and there are many ways to
  hook into it without changing the underlying code (which is fixed in the
  component binary).</p><p>Some examples of places to hook in are:</p><div class="itemizedlist"><ul type="disc"><li><p>New chunk item types.</p></li><li><p>New ResMgr file systems.</p></li><li><p>Entity extras.</p></li><li><p>Controllers.</p></li><li><p>Loading thread jobs.</p></li><li><p>Network packet filters.</p></li><li><p>Game tick (and higher resolution) timer queues.</p></li><li><p>New Python functions or object types.</p></li><li><p>New basic entity data types.</p></li></ul></div><p>These are all ideal candidates for compiling into extensions.</p><p>The following sections describe some of the most useful and
  sophisticated extensions.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Entity_Extras_And_Controllers"></a>Chapter&nbsp;26.&nbsp;Entity Extras and Controllers</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e15368">26.1. Implementing Entity Extras</a></span></dt><dt><span class="section"><a href="#d0e15567">26.2. Implementing Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e15891">26.2.1. Configuring Portal's Permissivity</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e15969">26.3. Integrating Entity Extras and Controllers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16075">26.3.1. Restricting the Number of Controllers Per Entity</a></span></dt></dl></dd></dl></div><p>BigWorld provides two mechanisms for extending Entity and server
  functionality. These are known as <em class="emphasis">Entity Extras</em> and
  <em class="emphasis">Controllers</em>.</p><p>Entity extras provide a mechanism for adding additional methods to all
  BigWorld cell entities. They are created on the spot when accessed by an
  entity, and are otherwise stateless. They are lost when the entity changes
  cells. There is at most one instance of EntityExtra per entity, and it may
  be easily retrieved from an Entity reference.</p><p>Controllers provide a standard method to perform CPU-intensive work on
  entities in C++. They are instantiated by, and attached to a cell entity,
  and travel with it between cells. They are useful for performing actions
  that are either unfeasible or inefficient to implement in Python. There may
  be multiple Controller instances per entity, each with its own ID, which the
  entity script (or another Controller) may use to cancel or access the
  entity.</p><p>Thus, it is not possible to retrieve a Controller instance by type
  from an entity reference, since it would not be possible to determine the
  instance retrieved. Of course, a friendly EntityExtra could store a pointer
  to it, if this were desired.</p><p>BigWorld comes packaged with a selection of proven useful entity
  extras and Controllers, including facilities for performing the following
  functions:</p><div class="itemizedlist"><ul type="disc"><li><p>Movement and navigation.</p></li><li><p>Vehicle management.</p></li><li><p>Entity vision and visibility.</p></li><li><p>Timed events.</p></li></ul></div><p>Depending on game design, however, additional facilities may be
  needed. Game design may also dictate the need for different implementations
  of one or more of the supplied facilities. Custom entity extras and
  Controllers are often useful for implementing these game-specific
  features.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e15368"></a>26.1.&nbsp;Implementing Entity Extras</h2></div></div></div><p>Entity extras attach additional methods to the
    <code class="classname">BigWorld</code>.<code class="classname">Entity</code> Python class
    on the cell. All entities have access to all methods of entity extras.
    However, the class implementing an entity extra is not instantiated until
    one of those methods is used, thus saving memory.</p><p>While entity extras are useful for extending entities in ways that
    can only be done via C++, it is worth remembering that for many things a
    simple Python base class will suffice.</p><p>Entity extras should not contain any state for an entity, as they
    are not streamed from one cell to another during the cell's ghosting
    process.</p><p>A minimal entity extra consists of the following header file
    (replacing any references to <span class="literal">EgExtra</span> with the
    appropriate name):</p><pre class="programlisting">#ifndef EGEXTRA_HPP
#define EGEXTRA_HPP

<em class="emphasis">#include "cellapp/entity_extra.hpp"</em>

/**
 * Simple example entity extra... can print a message to the screen
 */
<em class="emphasis">
#undef PY_METHOD_ATTRIBUTE_WITH_DOC
#define PY_METHOD_ATTRIBUTE_WITH_DOC PY_METHOD_ATTRIBUTE_ENTITY_EXTRA_WITH_DOC
</em>
class <em class="emphasis">EgExtra</em> : public <em class="emphasis">EntityExtra</em>
{
  <em class="emphasis">Py_EntityExtraHeader</em>( EgExtra );

public:
  EgExtra( Entity&amp; e );
  ~EgExtra();

  PyObject * <em class="emphasis">pyGetAttribute</em>( const char * attr );
  int <em class="emphasis">pySetAttribute</em>( const char * attr, PyObject * value );

  static const Instance&lt;EgExtra&gt; <em class="emphasis">instance</em>;
};
<em class="emphasis">
#undef PY_METHOD_ATTRIBUTE_WITH_DOC
#define PY_METHOD_ATTRIBUTE_WITH_DOC PY_METHOD_ATTRIBUTE_BASE_WITH_DOC
</em>
#endif</pre><p><span class="citetitle">EgExtra header file
    <code class="filename">bigworld/src/examples/cellapp_extension/egextra.hpp</code>
    <span class="symbol">&#8208;</span> Minimal definition</span></p><p>The code above contains the declarations necessary to integrate an
    entity extra into any entity in the BigWorld system.</p><p>After the header guards,
    <span class="literal">bigworld/src/server/cellapp/entity_extra.hpp</span> is
    included which defines the <code class="classname">EntityExtra</code>
    class.</p><p>It also overrides the macro <span class="literal">PY_METHOD_ATTRIBUTE</span>,
    in order to make automatically declared Python attributes in
    <span class="literal">EntityExtra</span>s work<sup>[<a name="d0e15444" href="#ftn.d0e15444">36</a>]</sup>. This allows BigWorld to search through and automatically
    instantiate extras by using only the name of the method that has been
    called.</p><p>In the <span class="literal">EgExtra</span> class, we derive from
    <span class="literal">EntityExtra</span>, and use the macro
    <span class="literal">Py_EntityExtraHeader</span> to declare some additional methods
    and properties that are used to keep track of these classes.</p><p>We provide the methods <span class="literal">pyGetAttribute</span> and
    <span class="literal">pySetAttribute</span> so that we can act like a Python
    object.</p><p>A static specialisation <span class="literal">EntityExtra::instance</span>
    member is also declared to access the entity extras. With it, we can get a
    reference to the <span class="literal">EgExtra</span> for any <span class="literal">Entity&amp;
    ent</span> using the code:</p><pre class="programlisting">EgExtra&amp; eg = EgExtra instance( ent );</pre><p>If the extra does not exist, it will be instantiated and returned.
    If we wanted to check first whether the extra exists, we can query it with
    the following code:</p><pre class="programlisting">bool hasEgExtra = EgExtra instance.exists( ent );</pre><p>We implement the outline of the <span class="literal">EgExtra</span> class as
    follows:</p><pre class="programlisting">#include "egextra.hpp"

DECLARE_DEBUG_COMPONENT(0);

PY_TYPEOBJECT( EgExtra )

PY_BEGIN_METHODS( EgExtra )
PY_END_METHODS()

PY_BEGIN_ATTRIBUTES( EgExtra )
PY_END_ATTRIBUTES()

const EgExtra::<em class="emphasis">Instance</em>&lt;EgExtra&gt; 
  EgExtra::instance( &amp;EgExtra::s_attributes_.di_ );

EgExtra::EgExtra( Entity&amp; e ) : EntityExtra( e )
{
}

EgExtra::~EgExtra()
{
}

PyObject * EgExtra::<em class="emphasis">pyGetAttribute</em>( const char * attr )
{
  PY_GETATTR_STD();
  return this-&gt;EntityExtra::pyGetAttribute( attr );
}

int EgExtra::<em class="emphasis">pySetAttribute</em>( const char * attr, PyObject * value )
{
  PY_SETATTR_STD();
  return this-&gt;EntityExtra::pySetAttribute( attr, value );
}</pre><p><span class="citetitle">EgExtra implementation file
    <code class="filename">bigworld/src/examples/cellapp_extension/egextra.cpp</code>
    <span class="symbol">&#8208;</span> Class outline</span></p><p>These two files together constitute the framework that we will use
    to implement any entity extra. These files can be found in BigWorld
    distribution, in the directory <code class="filename">bigworld/src/examples/cellapp_extension</code>.</p><p>We can now add methods to this entity extra. We do this by declaring
    the method in the class declaration, and exposing it to Python with the
    BigWorld Python macros.</p><p>As a simple example, to implement a method that prints the message
    '<span class="literal">hello world</span>' to the server debug log, we add the
    following code to the class declaration:</p><pre class="programlisting">// ...

class EgExtra : public EntityExtra
{
  Py_EntityExtraHeader( EgExtra );

public:
  // ...

  void <em class="emphasis">helloWorld</em>();
  PY_AUTO_METHOD_DECLARE( RETVOID, helloWorld, END );
};

// ...</pre><p><span class="citetitle"><span class="literal">EgExtra</span> header file <span class="symbol">&#8208;</span> Declaration of method
    <span class="literal">helloWorld</span></span></p><p>And in the implementation file, we add a simple 'stub'
    implementation:</p><pre class="programlisting">// ...

PY_TYPE_OBJECT( EgExtra )

PY_BEGIN_METHODS( EgExtra )
  PY_METHOD( helloWorld )
PY_END_METHODS()

// ...

void EgExtra::<em class="emphasis">helloWorld</em>()
{
  DEBUG_MSG( "egextra: hello world\n" );
}</pre><p><span class="citetitle"><span class="literal">EgExtra</span> implementation file <span class="symbol">&#8208;</span> Definition of method
    <span class="literal">helloWorld</span></span></p><p>After compiling this module, then for any entity in the world you
    can call:</p><pre class="programlisting">self.helloWorld()</pre><p>The call above outputs the text '<span class="literal">egextra: hello
    world</span>' to the server debug log.</p><p>Entity extras have an <code class="methodname">entity</code>() function,
    which returns a reference to the entity they have been attached to.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e15567"></a>26.2.&nbsp;Implementing Controllers</h2></div></div></div><p>Controllers enable us to dynamically add stateful C++ objects to
    entities on the CellApp. They can be used for property updates that need
    to be continuous, or for extensions that need to interact with the server
    at a level lower than the one exposed via the scripted entity
    model.</p><p>To implement a Controller, inherit from the CellApp class named
    <code class="classname">Controller</code>. The Controller declaration has to
    include the special macro <span class="literal">DECLARE_CONTROLLER_TYPE</span>,
    which includes definitions required to register the Controller in the
    BigWorld system.</p><p>The stub declaration file contains the following code:</p><pre class="programlisting">#ifndef EGCONTROLLER_HPP
#define EGCONTROLLER_HPP

#include "cellapp/controller.hpp"

class EgController : public Controller
{
  <em class="emphasis">DECLARE_CONTROLLER_TYPE</em>( EgController );

public:
};

#endif</pre><p><span class="citetitle">Controller header file <span class="symbol">&#8208;</span>
    <code class="filename">bigworld/src/examples/cellapp_extension/egcontroller.hpp</code></span></p><p>A Controller may be a member of the real domain (denoted by
    <span class="literal">DOMAIN_REAL</span>), or the ghost domain (denoted by
    <span class="literal">DOMAIN_GHOST</span>).</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">A Controller member of
        <span class="literal">DOMAIN_REAL</span> works with reals.</em></p><p>An example would be a movement Controller. Positional data is
        already sent via the entity (due to the necessity of placing the ghost
        in the right position), but other clients are unlikely to need to know
        the entity's final destination. Consequently, there is no need to send
        ghost information for this entity. Therefore, the Controller needs to
        operate only in the real domain.</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">A Controller member of
        <span class="literal">DOMAIN_GHOST</span> works with ghosts.</em></p><p>One such controller is BigWorld's
        <code class="classname">VisibilityController</code>, which simply publishes
        information for other entities to query. Other entities need to query
        this Controller (through an entity extra) to determine whether they
        can see that entity, even when the entity is a ghost.</p></li></ul></div><p>BigWorld directs Controllers by calling various virtual methods on
    the <code class="classname">Controller</code> class. There are two types of such
    methods:</p><div class="orderedlist"><ol type="1"><li><p><em class="emphasis">Communication methods</em></p><p>These methods serialise data onto a stream between cells, so
        that the Controller representation can be moved from one machine to
        another.</p><p>There are four of these, one each for reading/writing to the
        real/ghost domains, as described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Method:
            <span class="literal">Read</span></em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">DOMAIN_REAL</span>:
                <span class="literal">bool readRealFromStream( BinaryIStream&amp;
                )</span></em></p><p>Returns <span class="literal">TRUE</span> on success. Default
                implementation: <span class="literal">return TRUE</span>.</p></li><li><p><em class="emphasis"><span class="literal">DOMAIN_GHOST</span>:
                <span class="literal">bool readGhostFromStream( BinaryIStream&amp;
                )</span></em></p><p>Returns <span class="literal">TRUE</span> on success. Default
                implementation: <span class="literal">return TRUE</span>.</p></li></ul></div></li><li><p><em class="emphasis">Method:
            <span class="literal">Write</span></em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">DOMAIN_REAL</span>:
                <span class="literal">void writeRealToStream( BinaryOStream&amp;
                )</span></em></p><p>Default implementation: Do nothing</p></li><li><p><em class="emphasis"><span class="literal">DOMAIN_GHOST</span>:
                <span class="literal">bool void writeGhostToStream( BinaryOStream&amp;
                )</span></em></p><p>Default implementation: Do nothing.</p></li></ul></div></li></ul></div></li><li><p><em class="emphasis">Start/stop methods</em></p><p>Controllers often request to be called back from the BigWorld
        code. However, a real Controller should not be executed when it is
        attached to a ghost entity, and a ghost Controller should not be
        executed when it is attached to a real entity.</p><p>To allow this, BigWorld uses four Controller methods to notify a
        controller when it should change its processing strategy <span class="symbol">&#8208;</span> start methods should request the callbacks,
        and stop methods should cancel them, as described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Method: Start</em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">DOMAIN_REAL</span>:
                <span class="literal">void startReal( bool isInitialStart
                )</span></em></p><p>Default implementation: Do nothing.</p></li><li><p><em class="emphasis"><span class="literal">DOMAIN_GHOST</span>:
                <span class="literal">void startGhost( )</span></em></p><p>Default implementation: Do nothing.</p></li></ul></div></li><li><p><em class="emphasis">Method: Stop</em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">DOMAIN_REAL</span>:
                <span class="literal">void stopReal( bool isFinalStop
                )</span></em></p><p>Default implementation: Do nothing.</p></li><li><p><em class="emphasis"><span class="literal">DOMAIN_GHOST</span>:
                <span class="literal">void stopGhost( )</span></em></p><p>Default implementation: Do nothing.</p></li></ul></div></li></ul></div></li></ol></div><p>A Controller can be a member of both domains
    (<span class="literal">DOMAIN_REAL</span>, and <span class="literal">DOMAIN_GHOST</span>) if
    it has the (uncommon) need to present aspects of itself as a ghost
    Controller, and aspects of itself as a real Controller.</p><p>Once an initial decision has been made as to which domains a
    controller belongs to, a stub implementation file needs to be set up. At
    first, it does not have to declare the domain, as illustrated
    below:</p><pre class="programlisting">#include "egcontroller.hpp"
#include "cellapp/cellapp.hpp"

DECLARE_DEBUG_COMPONENT(0);

// controller type declaration needs to go here</pre><p><span class="citetitle">Controller stub implementation file <span class="symbol">&#8208;</span>
    <code class="filename">bigworld/src/examples/cellapp_extension/egcontroller.cpp</code></span></p><p>Next, a macro needs to be placed to implement the controller
    integration. There are two possible macros for that:</p><div class="orderedlist"><ol type="1"><li><p><em class="emphasis">IMPLEMENT_CONTROLLER_TYPE( CLASS_NAME,
        DOMAIN )</em></p><p>This macro declares a standard Controller type, which will be
        instantiated using an <span class="literal">EntityExtra</span>. See below for
        more details.</p></li><li><p><em class="emphasis">IMPLEMENT_CONTROLLER_TYPE_WITH_PY_FACTORY(
        CLASS_NAME, DOMAIN )</em></p><p>This macro declares that the controller will be instantiated
        using an automatically generated
        <span class="literal">addControllerClassName</span> method in Python. The
        <span class="literal">ControllerClassName</span> used omits the trailing word
        '<span class="literal">Controller</span>' if it is present
        (<em class="emphasis">e.g.</em>, <span class="literal">TimerController</span> becomes
        <span class="literal">addTimer</span>).</p><p>A factory method has to be created to use this feature. Its
        declaration goes into the class declaration, and its name is
        <span class="literal">New</span>:</p><pre class="programlisting">public:
  static FactoryFnRet New( int userArg );
  PY_AUTO_CONTROLLER_FACTORY_DECLARE( EgController, ARG( int, END ) )</pre><p>This method is implemented in the <span class="literal">.cpp</span>
        file:</p><pre class="programlisting">Controller::FactoryFnRet EgController::New( int userArg )
{
  return FactoryFnRet( new EgController(), userArg );
}</pre></li></ol></div><p>When implementing a controller, the <span class="literal">Controller</span>
    class exposes the following useful methods:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">entity()</span></em></p><p>Returns an <span class="literal">Entity&amp;</span> object, referring to
        the entity that owns this Controller.</p><p>For more details on methods exposed by the
        <span class="literal">Entity</span> class, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_cpp/cellapp/index.html#Client_C_API" class="olink">Client C API</a> and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_cpp/client/index.html#Client_C_API" class="olink">Client C API</a>.</p></li><li><p><em class="emphasis"><span class="literal">cancel()</span></em></p><p>Cancels this controller. Call this method only on real
        entities.</p></li><li><p><em class="emphasis"><span class="literal">ghost()</span></em></p><p>Informs the cell to update the ghosted portion of this (real
        entity) controller.</p></li><li><p><em class="emphasis"><span class="literal">standardCallback (
        <em class="replaceable"><code>methodName</code></em> )</span></em></p><p>Calls the 'standard' Controller Python notification method on
        the associated entity. Standard notification methods have the
        following Python signature: <span class="literal">def methodName( self,
        controllerID, userData )</span>.</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e15891"></a>26.2.1.&nbsp;Configuring Portal's Permissivity</h3></div></div></div><p>A <span class="literal">PortalConfigController</span> configures the portal
      that its owning entity straddles. It is added with the entity method
      <span class="literal">addPortalConfig</span>, and takes the following
      arguments:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">permissive</span></em></p><p>Boolean value indicating whether the portal allows objects in
          the collision scene to pass through it.</p></li><li><p><em class="emphasis"><span class="literal">triFlags</span></em></p><p>uint32 value for the triangle flags that should be returned on
          collision tests that intersect the portal when it is not
          permissive.</p></li><li><p><em class="emphasis"><span class="literal">navigable</span></em></p><p>Boolean value not currently used, and which should be set to
          the same value as the permissive argument.</p><p>In the future, this argument may be used to indicate whether
          the navigation system should consider the portal to be passable. For
          now however, the navigation system uses the same flag as the
          collision scene (permissive). For details, on the navigation system,
          see <a href="#xref_Navigation_System" title="12.2.&nbsp;Navigation System">Navigation System</a>.</p></li></ul></div><p>The controller is cancelled with the Entity method
      <span class="literal">cancel</span>, as with other controllers. It is a ghost
      controller, and therefore the portal configuration is correctly
      replicated across cells when more than one can see it. It is not however
      propagated to the client, if required it must be done via script
      properties or messages.</p><p>The direction of the entity to which the
      <span class="literal">PortalConfigController</span> is attached must be the same
      as the normal of the portal that is to be configured,
      <em class="emphasis">i.e.</em>, if the portal runs east-west between two
      chunks, then the entity must face either south or north, otherwise the
      portal will probably not be found.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>An entity should not be moved while it has a
        <span class="literal">PortalConfigController</span> attached, or there may be
        undesirable results across cells.</p><p>If the entity needs to be moved, then cancel
        <span class="literal">PortalConfigController</span>, move the entity, and
        recreate the controller.</p></div><p>To the extent that portals are uni-directional and come in pairs,
      <span class="literal">PortalConfigController</span> configures only the portal
      whose normal faces approximately the same direction as the entity,
      <em class="emphasis">i.e.</em>, the portal in the chunk that is found just in
      front (10 cm) of the entity's position. Another entity with opposite
      direction may be created if a separate configuration is desired for the
      opposing portal. For most purposes however (<em class="emphasis">i.e.</em>,
      navigation and collision) it is only necessary to configure one portal
      differently to the default permissive state.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The method <span class="literal">configureConnection</span> has been
        deprecated, since it does not work across cells.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e15969"></a>26.3.&nbsp;Integrating Entity Extras and Controllers</h2></div></div></div><p>Entity extras are commonly used to provide a more sophisticated
    means of instantiating Controllers. They might provide a factory that
    selects one of several types of Controller to instantiate, or provide a
    means of limiting the number of Controllers that are instantiated.</p><p>To begin exploring this, we implement something similar to the
    automatic instantiation provided by the macro
    <span class="literal">IMPLEMENT_CONTROLLER_TYPE_WITH_PY_FACTORY</span>.</p><p>We add an instantiation method called
    <span class="literal">addEgController</span> to <span class="literal">EgExtra</span>, taking
    an integer user argument:</p><pre class="programlisting">class EgExtra : public EntityExtra
{
  Py_EntityExtraHeader( EgExtra );

public:
  // ...

  PY_AUTO_METHOD_DECLARE( RETOWN, addEgController, ARG( int, END ) );
  PyObject * <em class="emphasis">addEgController</em>( int userArg );

  static const Instance&lt;EgExtra&gt; instance;
};</pre><p><span class="citetitle"><span class="literal">EgExtra</span> header file
    <code class="filename">bigworld/src/examples/cellapp_extension/egextra.hpp</code>
    <span class="symbol">&#8208;</span> Declaration of instantiation method
    <span class="literal">addEgController</span></span></p><p>The next step is to implement the method addEgController. To do so,
    we need to:</p><div class="orderedlist"><ol type="1"><li><p>Add a macro <span class="literal">PY_METHOD</span> to declare the
        Python/C++ binding code.</p></li><li><p>Ensure that the method is being called on a real entity.</p></li><li><p>Instantiate an <span class="literal">EgController</span>.</p></li><li><p>Add the new Controller to the entity.</p></li><li><p>Return the controller ID.</p></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Most Controllers do not need any more functionality than the
      built-in Python factory method supplies.</p><p>Creating unnecessary <span class="literal">EntityExtra</span> instances
      should be avoided, since every declared <span class="literal">EntityExtra</span>
      type uses 4 bytes per entity (including ghost entities), even when it is
      not instantiated.</p></div><p>This will mean the following changes to
    <span class="literal">EgExtra</span>:</p><pre class="programlisting">#include "egextra.hpp"
#include "egcontroller.hpp"

DECLARE_DEBUG_COMPONENT(0);

PY_TYPEOBJECT( EgExtra )

PY_BEGIN_METHODS( EgExtra )
  PY_METHOD( helloWorld )
  <em class="emphasis">PY_METHOD( addEgController )</em>
PY_END_METHODS()

// ...

PyObject * EgExtra::<em class="emphasis">addEgController</em>( int userArg )
{
  <em class="emphasis">if (!entity_.isReal())</em>
  {
    PyErr_SetString( PyExc_TypeError,
      "Entity.addEgController() may only be called on real entities" );
    return NULL;
  }

  <em class="emphasis">ControllerPtr pController = new EgController();</em>
  ControllerID controllerID = 
    <em class="emphasis">entity_.addController( pController, userArg );
  return Script::getData( controllerID );</em>
}</pre><p><span class="citetitle"><span class="literal">EgExtra</span> implementation file
    <code class="filename">bigworld/src/examples/cellapp_extension/egextra.cpp</code>
    <span class="symbol">&#8208;</span> Definition of instantiation method
    <span class="literal">addEgController</span></span></p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16075"></a>26.3.1.&nbsp;Restricting the Number of Controllers Per Entity</h3></div></div></div><p>If you want to restrict the entities to have only one Controller
      each, then the class <span class="literal">EgExtra</span> may be changed so that
      it maintains a pointer to the current Controller, and the method
      <span class="literal">addEgController</span> should ensure that the pointer is
      <span class="literal">NULL</span> before allowing a new one to be added.</p><p>The class <span class="literal">EgController</span> would then, in its
      method <span class="literal">startReal</span>, send its pointer to the class
      <span class="literal">EgExtra</span>, and communicate to it that it has been
      cancelled in its method <span class="literal">stopReal</span>. The pointer must
      not be directly set in the method <span class="literal">addEgController</span>, as
      it would break the symmetry of the Controller 'owning' that pointer in
      the <span class="literal">EntityExtra</span>.</p><p>Setting the pointer in the mentioned methods in the Controller
      works correctly when the entity is offloaded to another cell.</p><p>The line to add to method <span class="literal">startReal</span> would be
      similar to the line below:</p><pre class="programlisting">EgExtra::instance( *this-&gt;entity() ).setEgControllerPtr( this )</pre><p>Note that the object <span class="literal">EgExtra</span> will be
      instantiated if it does not already exist.</p><p>Keeping a pointer to a related Controller can also be useful for
      an entity extra to maintain states across cell transitions.</p><p>For example, to calculate the age of an entity extra, it might
      provide a method <span class="literal">getEgAge</span>, and the Controller might
      store the game time when it is created. The entity extra can then
      calculate its age by subtracting the current game time from the
      Controller's stored game time (after checking that the Controller
      pointer is not <span class="literal">NULL</span>).</p></div></div><div class="footnotes"><br><hr width="100" align="left"><div class="footnote"><p><sup>[<a name="ftn.d0e15444" href="#d0e15444">36</a>] </sup>Note that this is undone at the end of the file.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Updatable_Objects"></a>Chapter&nbsp;27.&nbsp;Updatable Objects</h2></div></div></div><p>One of the main reasons for using Controllers is to implement in C++
  actions that need to occur frequently, thus reducing the execution time in
  the Python virtual machine on the server. In order to do this, the CellApp
  has a mechanism to call back certain classes every game tick.</p><p>The relationship between the CellApp and its Controllers is depicted
  below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/cellapp_and_controllers.png"><span class="caption"><p>CellApp and Controllers</p></span></div></div><p>The first step is to add the class <span class="literal">Updatable</span> to the
  list of the Controller's base classes:</p><pre class="programlisting">#include "../cellapp/updatable.hpp"

class EgController : public Controller, public Updatable
</pre><p>Updates on a Controller are usually run only on the real copy of the
  entity, and for this reason the class Controller exposes the methods
  <span class="literal">startReal</span> and <span class="literal">stopReal</span> (which can be
  overridden).</p><p>In these methods, the CellApp is requested to start or stop calling
  back the Controllers. The implementation would look as follows:</p><pre class="programlisting">void EgController::startReal( bool /*isInitialStart*/ )
{
  CellApp::instance().registerForUpdate( this );
}

void EgController::stopReal( bool /*isFinalStop*/ )
{
  MF_VERIFY( CellApp::instance().deregisterForUpdate( this ) );
}</pre><p>We use the macro <span class="literal">MF_VERIFY</span> in
  <span class="literal">stopReal</span> to ensure that an error message is printed on
  failure <span class="symbol">&#8208;</span> this is an easy place to
  check for bugs in the Controller.</p><p>Now the update method can be implemented to perform any action
  required on the entity at each game tick.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Encrypting_Client_Server_Traffic"></a>Chapter&nbsp;28.&nbsp;Encrypting Client-Server Traffic</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Generating_RSA_Keypair">28.1. Generating your own RSA keypair</a></span></dt><dt><span class="section"><a href="#d0e16240">28.2. Working with multiple keys</a></span></dt><dt><span class="section"><a href="#d0e16254">28.3. Customising the symmetric encryption algorithm</a></span></dt><dt><span class="section"><a href="#xref_How_Packet_Filters_Work">28.4. How PacketFilters work</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16289">28.4.1. High-level requirements</a></span></dt><dt><span class="section"><a href="#d0e16313">28.4.2. Filtering mechanics and requirements</a></span></dt><dt><span class="section"><a href="#d0e16416">28.4.3. Extra space for filtering</a></span></dt></dl></dd></dl></div><p>BigWorld guarantees the security of the client-server session in two
  important ways:</p><div class="itemizedlist"><ul type="disc"><li><p>The login handshake is RSA-encrypted using a public key stored in
      the client resources.</p></li><li><p>The client-proxy channel is symmetrically encrypted using
      Blowfish.</p></li></ul></div><p>As a result, it is impossible for an attacker to:</p><div class="itemizedlist"><ul type="disc"><li><p>Steal a player's password</p></li><li><p>Hijack a player's session</p></li><li><p>Inject upstream packets into the player's traffic to disrupt
      his/her session</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Generating_RSA_Keypair"></a>28.1.&nbsp;Generating your own RSA keypair</h2></div></div></div><p>This security framework is provided to work out-of-the-box, and
    BigWorld ships with an RSA keypair that we have pre-generated for you
    (<code class="filename">bigworld/res/server/loginapp.privkey</code> and
    <code class="filename">bigworld/res/loginapp.pubkey</code>).</p><p>Before making any kind of public game release, it is critical to
    replace this keypair with a new keypair generated by your own company. As
    all BigWorld clients receive the same default keypair BigWorld cannot
    guarantee that this keypair is secure. Generating a new keypair with the
    <code class="filename">openssl</code> command-line utility (which should be
    available in all modern Linux distributions) is simple:</p><div class="orderedlist"><ol type="1"><li><p>Generate a new RSA keypair as follows:</p><pre class="programlisting">$ openssl genrsa <em class="replaceable"><code>[numbits]</code></em> &gt; loginapp.privkey</pre><p>BigWorld recommends using a 2048-bit key.</p></li><li><p>Strip out the public part of your keypair as follows:</p><pre class="programlisting">$ openssl rsa -pubout &lt; loginapp.privkey &gt; loginapp.pubkey</pre></li></ol></div><p>The private key should be placed into your server game resources,
    and the public part should be placed in your client game resources.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Ensure your private key is never shipped with your game client
      resources.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e16240"></a>28.2.&nbsp;Working with multiple keys</h2></div></div></div><p>You may want to ship multiple public keys with your game client (for
    instance, you may want to have a different key for each shard of your game
    world). The <code class="function">BigWorld.connect()</code> function in the Client
    API allows you to specify which public key to use when logging into the
    server using the <code class="code">publicKeyPath</code> attribute of the
    <code class="code">loginParams</code> object. Please see the Client API documentation
    for more details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e16254"></a>28.3.&nbsp;Customising the symmetric encryption algorithm</h2></div></div></div><p>The Client-Proxy Channel is encrypted using 128-bit Blowfish by
    default. This encryption method was selected as it was the most secure,
    high-performance symmetric cipher offered in the standard OpenSSL
    distribution. Should you wish to use a different encryption algorithm, you
    should be able to edit
    <code class="filename">src/lib/network/encryption_filter.cpp</code> to change the
    encryption algorithm without needing to modify any header files.</p><p>You will probably want to leave the stream-padding operations in
    <code class="function">EncryptionFilter::send()</code> and
    <code class="function">EncryptionFilter::recv()</code> as they are; all you should
    need to edit is the initialisation method
    (<code class="function">EncryptionFilter::initKey()</code>) and the
    encryption/decryption methods
    (<code class="function">EncryptionFilter::encrypt()</code> and
    <code class="function">EncryptionFilter::decrypt()</code>).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_How_Packet_Filters_Work"></a>28.4.&nbsp;How PacketFilters work</h2></div></div></div><p>In previous versions of BigWorld, encryption support was not
    automatically provided, and the task of implementing it was left to each
    individual customer. In recognition of the importance of online security
    and the sensitivity of game data in today's online games, a standard
    implementation is now included with BigWorld.</p><p>This documentation used to describe the specifics of how to
    implement your own <code class="classname">Mercury::PacketFilter</code> to provide
    end-to-end encryption for a Client-Proxy Channel. A lot of this
    documentation is now irrelevant, however the description of how
    PacketFilters work is still accurate and is retained for
    completeness.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16289"></a>28.4.1.&nbsp;High-level requirements</h3></div></div></div><p>Packet filters do not allow arbitrary encryption algorithms to be
      used <span class="symbol">&#8208;</span> the algorithm implemented
      must work within the mechanics of Mercury. Mercury processes each data
      packet individually, and has mechanisms for coping with packet loss and
      similar problems. Since packet filters are called as the last stage of
      sending a packet, and as the first stage of receiving a packet,
      algorithms implemented within a packet filter should work under the
      normal constraints of UDP, which are:</p><div class="itemizedlist"><ul type="disc"><li><p>Packets may be delivered out of order.</p></li><li><p>Packets may be delivered more than once.</p></li></ul></div><p>For this reason, encryption algorithms that assume a continuous
      transport byte stream are not appropriate. The appropriate encryption
      algorithms are the ones that work on a single block (packet) at a time
      within a window, and include algorithms like DES block encryption (as
      used in the secure PPP protocol), Blowfish, TwoFish, or similar
      protocols used in wireless Ethernet technology (SSL is not appropriate,
      since it assumes a continuous stream). The previously mentioned block
      algorithms can support packet loss and prevent packet replayability,
      among other features.</p><p>Mercury takes care of the particulars of a UDP environment <span class="symbol">&#8208;</span> the packet filter only has to perform
      its filtering function. It uses sequence numbers of its own to discard
      duplicate packets (assuming that the packet filter itself has not
      discarded the packet). It also detects dropped packets, and resends them
      if they contained reliable information (so the packet filter should not
      do this). When Mercury needs to resend messages, it will sometimes
      resend the whole packet unmodified, and at other times (if there is
      space) it will piggyback just the reliable messages of the dropped
      packet into the body of the next new packet. Packet filters must be able
      to cope with both of these types of resending.</p><p>Packet filters are always associated with channels, like the ones
      between a proxy and a client.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16313"></a>28.4.2.&nbsp;Filtering mechanics and requirements</h3></div></div></div><p>For every sent packet associated with a <span class="literal">Channel</span>
      object, the <span class="literal">send</span> method of the associated
      <span class="literal">PacketFilter</span> is called, with the packet as one of the
      parameters. This happens after all other processing on the packet.
      Similarly, the <span class="literal">recv</span> method of the
      <span class="literal">PacketFilter</span> instance is called for every packet that
      is received over the channel by the Nub, before any other processing
      occurs on it. This method should undo any modifications made to the
      packet by the <span class="literal">send</span> method, and then call the base
      class <span class="literal">PacketFilter::recv</span> method.</p><p>Since packets may be received out of order, the
      <span class="literal">PacketFilter</span> instance must be able to reconstruct any
      packet received within the <span class="literal">Channel</span>'s window.
      Duplicate packets may also be received, and these must also be
      reconstructed when within the window, so that they can be acknowledged
      (in case the ACK for the original packet was lost).</p><p>Note that a <span class="literal">PacketFilter</span> must not modify a
      packet to be sent <span class="symbol">&#8208;</span> or at least if
      it does so, it then must undo the modifications afterwards. If it were
      to leave a packet modified, and that packet needed to be resent (or
      partially resent), then it would be filtering the data twice. Depending
      on the nature of the modifications being made to the
      <span class="literal">Packet</span>'s data, it may make sense to do the desired
      changes, or it may make more sense to simply grab a new
      <span class="literal">Packet</span> from the <span class="literal">PacketPool</span>, write
      the filtered data to that packet, and then send it. This notice does not
      apply to packets that are received <span class="symbol">&#8208;</span> the <span class="literal">PacketFilter</span> may
      modify received packets in-place if it so chooses, especially if it is
      efficient to do so.</p><p>The <span class="literal">PacketFilter</span> base class'
      <span class="literal">send</span> implementation sends the packets over the Nub's
      socket with the usual accounting, error checking, and retries.</p><p>Do not use the Nub's socket directly. The
      <span class="literal">PacketFilter</span> base class' <span class="literal">recv</span>
      implementation submits the packet for normal internal processing. If you
      do not call it, then you must give the packet back to the
      <span class="literal">PacketPool</span> (with
      <span class="literal"><span class="literal">PacketPool::give</span></span>), or the packet
      will be leaked.</p><p>New packets may be obtained and old ones returned at any time via
      the <span class="literal">PacketPool</span> object.
      <span class="literal">PacketFilter</span> instances may use and store packets for
      any purpose that they see fit. Also, the <span class="literal">PacketFilter</span>
      base class' methods <span class="literal">send</span> and <span class="literal">recv</span>
      may be called as many times as desired from the corresponding derived
      methods <span class="literal">send</span> and <span class="literal">recv</span>, if that is
      what the filter needs to do.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16416"></a>28.4.3.&nbsp;Extra space for filtering</h3></div></div></div><p>Normally, when messages are added to a bundle, the full size of
      the packet may be used. This would deny many potential filtering uses,
      which might want to add data to packets after this. The virtual method
      <span class="literal">maxSpareSize</span> may be implemented in this case to
      specify the minimum amount of space to leave spare in each packet
      (<em class="emphasis">i.e.</em>, the maximum amount of space required by the
      <span class="literal">PacketFilter</span>).</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Mercury_Packet_Structure"></a>Chapter&nbsp;29.&nbsp;Mercury Packet Structure</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e16490">29.1. Header</a></span></dt><dt><span class="section"><a href="#d0e16503">29.2. Messages</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16547">29.2.1. Fixed-Length Messages</a></span></dt><dt><span class="section"><a href="#d0e16566">29.2.2. Variable-Length Messages</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e16585">29.3. Footers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e16595">29.3.1. Fragment Numbers</a></span></dt><dt><span class="section"><a href="#d0e16610">29.3.2. Sequence Number</a></span></dt><dt><span class="section"><a href="#d0e16618">29.3.3. ACKs</a></span></dt><dt><span class="section"><a href="#d0e16631">29.3.4. Indexed Channel ID</a></span></dt><dt><span class="section"><a href="#d0e16639">29.3.5. First Request Offset and <span class="literal">replyID</span></a></span></dt></dl></dd></dl></div><p>The API for network communications that Mercury exposes is based on a
  message/bundle paradigm, which masks the true nature of the actual UDP
  packets being sent and received.</p><p>From the programmer's point of view, messages are created and streamed
  onto Bundles (see <span class="literal">src/lib/network/bundle.hpp)</span>. At some
  point a Bundle will be sent, at which point Mercury will convert the
  messages on the Bundle into one or more contiguous sequences of bytes, and
  send them as a regular UDP packets. This section details the format of those
  packets.</p><p>Broadly speaking, the structure of a Mercury packet is composed of the
  following:</p><div class="itemizedlist"><ul type="disc"><li><p>A single-byte header.</p></li><li><p>Zero or more messages.</p></li><li><p>The footers specified by the flags in the header.</p></li></ul></div><div class="informalfigure"><div class="mediaobject"><img src="images/mercury_packet_structure_broad_structure.png"><span class="caption"><p>Broad structure</p></span></div></div><div class="informalfigure"><div class="mediaobject"><img src="images/mercury_packet_structure_message_structure.png"><span class="caption"><p>Message structure</p></span></div></div><div class="informalfigure"><div class="mediaobject"><img src="images/mercury_packet_structure_specific_message_types.png"><span class="caption"><p>Specific message types</p></span></div></div><div class="informalfigure"><div class="mediaobject"><img src="images/mercury_packet_structure_footers.png"><span class="caption"><p>Footers</p></span></div></div><div class="informalfigure"><div class="mediaobject"><img src="images/mercury_packet_structure_how_first_request.png"><span class="caption"><p>How first request offset/reply <span class="symbol">&#8208;</span> IDs work</p></span></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e16490"></a>29.1.&nbsp;Header</h2></div></div></div><p>The first byte of a Mercury packet is always a header, which
    essentially details which footers should be expected on the packet.</p><p>It is a bitwise combination of the <span class="literal">FLAG*</span>
    constants defined inside Bundle in
    <span class="literal">src/lib/network/packet.hpp</span>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e16503"></a>29.2.&nbsp;Messages</h2></div></div></div><p>The first byte of a message is always its ID.</p><p>Looking up that message ID in whichever Mercury interface is
    currently in effect will reveal what type of message it is and how the
    subsequent bytes on the packet should be interpreted. For example,
    LoginApp processes all packets on its external interface according to
    <span class="literal">LoginInterface</span>, defined in
    <span class="literal">bigworld/src/common/login_interface.hpp</span>.</p><p>The ID of a message is the index of its
    <span class="literal">MERCURY_*_MESSAGE</span> declaration in the
    <span class="literal">BEGIN_MERCURY_INTERFACE()</span> /
    <span class="literal">END_MERCURY_INTERFACE()</span> block for that Mercury
    interface. For example, in
    <span class="literal">bigworld/src/common/login_interface.hpp</span>, a login
    message has ID 0, because it is the first message type declared in the
    <span class="literal">MERCURY_INTERFACE</span> block.</p><p>There are three basic types of Mercury messages:</p><div class="itemizedlist"><ul type="disc"><li><p>Fixed-length messages</p></li><li><p>Variable-length messages</p></li><li><p>Multiple-length messages</p></li></ul></div><p>These types are described in the sub-sections below.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16547"></a>29.2.1.&nbsp;Fixed-Length Messages</h3></div></div></div><p>A fixed-length message has its precise length determined at
      compile time. Specifically, it is the second argument to the
      <span class="literal">MERCURY_FIXED_MESSAGE</span> macro that declares it.</p><p>Therefore, the header of a fixed-length message is simply its
      message ID. The message payload immediately follows the header, and must
      have the exact length given in the interface definition.</p><p>Although all fixed-length messages are treated equally during
      low-level Mercury processing, there are different macros that can
      declare them, which result in different handling in the callbacks that
      receive the unpacked messages.</p><p>The most common example of this is the
      <span class="literal">MERCURY_STRUCT_MESSAGE</span> declaration. A message type
      declared in this way is simply a fixed-length message whose length is
      equal to the sum of the sizes of the fields of the struct.</p><p>The advantage of using a struct message instead of a vanilla
      fixed-length one is that the object passed to the callback registered
      for this message type will be an object whose fields match those of the
      struct. The callback can therefore access them by name, and with the
      correct types, instead of having to extract bytes at particular offsets
      and lengths inside the binary data blob, and then cast them to the
      desired types.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16566"></a>29.2.2.&nbsp;Variable-Length Messages</h3></div></div></div><p>The header for a variable-length message is the message ID,
      followed by a short field that specifies the exact size of the message
      payload.</p><p>The length of the field specifying the payload size is the second
      argument to the <span class="literal">MERCURY_VARIABLE_MESSAGE</span> macro that
      declares the message type.</p><p>For example, from
      <span class="literal">bigworld/src/common/login_interface.hpp</span>:</p><pre class="programlisting">MERCURY_VARIABLE_MESSAGE( login, 2, &amp;gLoginHandler )</pre><p>The length field in a login message header will therefore be 2
      bytes long.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e16585"></a>29.3.&nbsp;Footers</h2></div></div></div><p>The footers that are present on Mercury packet are specified by the
    field header, which is the first byte of the packet, and must appear in a
    specific order.</p><p>They are listed in the following sub-sections in reverse order,
    <em class="emphasis">i.e.</em>, from the end of the packet towards the
    messages.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16595"></a>29.3.1.&nbsp;Fragment Numbers</h3></div></div></div><p>If a packet has the header <span class="literal">FLAG_IS_FRAGMENT</span>,
      then it is part of a chain of packets where messages span the packet
      boundaries.</p><p>Typically, this will occur when trying to send messages larger
      than the maximum allowable UDP packet size (<em class="emphasis">e.g.</em>,
      large writes to the database).</p><p>The sequence numbers for the first and last packet in the sequence
      of fragments are written to the footer of every packet in the sequence.
      Therefore, the footer consists of two 4-byte integers specifying the
      relevant sequence numbers.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16610"></a>29.3.2.&nbsp;Sequence Number</h3></div></div></div><p>Given by <span class="literal">FLAG_HAS_SEQUENCE_NUMBER</span>, this is a
      single 4-byte sequence number that is streamed onto reliable packets so
      that they can be acknowledged.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16618"></a>29.3.3.&nbsp;ACKs</h3></div></div></div><p>Given by <span class="literal">FLAG_HAS_ACKS</span>, these are
      acknowledgement messages corresponding to sequence numbers from previous
      outgoing packets.</p><p>This is a sequence of 4-byte sequence numbers, followed by a
      single byte indicating the number of <span class="literal">ACK</span>s on the
      packet.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16631"></a>29.3.4.&nbsp;Indexed Channel ID</h3></div></div></div><p>Given by <span class="literal">FLAG_INDEXED_CHANNEL</span>, this is the
      channel ID of a packet on an indexed channel, as opposed to a normal
      channel that is identified by the source address of the packet.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e16639"></a>29.3.5.&nbsp;First Request Offset and <span class="literal">replyID</span></h3></div></div></div><p>When a request is sent to a server component (for example, the
      <span class="literal">LoginInterface</span> '<span class="literal">probe</span>' message,
      which the server replies to with information about itself) the requester
      will attach a <span class="literal">replyID</span> to the message. The server will
      attach the same ID to the reply so that the requester can correlate the
      reply to its original request.</p><p>If a message is a request, then an extra field will be added to
      the packet between the header and the message payload. This extra field
      is not accounted for by any variable-length fields. The field will
      contain the 4-byte <span class="literal">replyID</span>, followed by the 2-byte
      offset (from the start of the packet) of the next
      <span class="literal">replyID</span> in the same packet. The reason that the
      address of the next replyID needs to be specified is so that the
      <span class="literal">replyID</span>s can be distinguished from regular message
      payloads and parsed correctly.</p><p>If any of the messages on a packet have
      <span class="literal">replyID</span>s, the header will have
      <span class="literal">FLAG_HAS_REQUESTS</span> set, and the footer will contain
      the 2-byte offset of the first <span class="literal">replyID</span> on the packet.
      The last request on a packet will have a next-request-offset of
      0.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Watcher_Interface"></a>Chapter&nbsp;30.&nbsp;The Watcher Interface</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e16722">30.1. Callable Function Watchers</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Forwarding_Watchers">30.1.1. Forwarding Watchers</a></span></dt><dt><span class="section"><a href="#xref_Implement_Function_Watchers">30.1.2. Implementing Function Watchers</a></span></dt></dl></dd></dl></div><p>Watcher is a mechanism that exposes internal operational parameters of
  a running BigWorld Server so that a developer or administrator can view and
  change these parameters.</p><p>All BigWorld components use the Watcher interface. You can easily
  extend your own processes to use this interface. To enable this, the
  targeted server component code needs to be modified-one needs to first
  register a watcher interface instance, and then specify the internal
  parameters to be exposed through watchers.</p><p>There are a number of watcher types, such as
  <span class="literal">DataWatcher</span>, <span class="literal">DirectoryWatcher</span>, and
  <span class="literal">FunctionWatcher</span>, among others. You can build a tree of
  different type of watchers logically linked together. To do this, you need
  to first create a new <span class="literal">DirectoryWatcher</span>, and then add to
  the tree using the function <span class="literal">addChild()</span> of the parent
  watcher. The root of the watcher tree can be obtained by calling the static
  function <span class="literal">Watcher::rootWatcher()</span>.</p><p>In the case where watchers are attached to the root only, the macro
  <span class="literal">MF_WATCH</span> is provided to simplify the process. For more
  details on adding new watchers, check the existing examples in the server
  source code and the C++ API documentation.</p><p>Once watchers are enabled, the running server process grants access to
  its internal statistics and debug information.</p><p>Background Watcher processes can collect watcher data and republish it
  through WebConsole's ClusterControl module. WebConsole's StatGrapher module
  can poll and graph watcher data. For details on WebConsole, see the document
  <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Admin_Tools" class="olink"><i>Cluster Administration Tools</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_WebConsole" class="olink">WebConsole</a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e16722"></a>30.1.&nbsp;Callable Function Watchers</h2></div></div></div><p>Both Python and C++ functions can be exposed as BigWorld Watchers
    which enables them to be 'called' via the watcher protocol.</p><p>When a function watcher has been invoked, three pieces of data will
    be returned to the invoker:</p><div class="itemizedlist"><ul type="disc"><li><p>Call success status</p><p>This is a boolean True / False representing whether or not the
        callable watcher successfully completed running.</p><p>A situation that may generate a status of False would be a
        Python function that throws an exception that is not caught. Such
        status should be rare, and we suggest that it should only happen
        during development of the callable functions.</p></li><li><p>Function return data</p><p>This is recommended to be a human-readable string, indicating
        the resulting state/information pertaining to the operation of the
        called watcher.</p><p>For example, a callable watcher that changes the position of a
        specific entity number may return <em class="emphasis">'Entity
        <span class="literal"><em class="replaceable"><code>&lt;id&gt;</code></em></span> moved to
        (x,y,z).'</em> on success, or <em class="emphasis">'No entity with id
        <span class="literal"><em class="replaceable"><code>&lt;id&gt;</code></em></span>
        found.'</em> if the entity did not exist at the time of calling
        the watcher.</p></li><li><p>Console output (stdout/stderr)</p><p>This is intended to provide a mechanism for developers writing
        callable watchers to catch error states and have access to debugging
        information while development is occurring.</p><p>Any exception thrown in Python scripts will be be in this
        segment of the return data. Console output may however also be useful
        for providing more detailed information about a callable watcher
        operation.</p><p>For example, a callable watcher may be defined to display all
        entities of type <span class="literal">PlayerAvatar</span>. The Function Return
        Data piece of data may output <em class="emphasis">'Found
        <span class="literal"><em class="replaceable"><code>&lt;count&gt;</code></em></span> entities
        of type <span class="literal">PlayerAvatar</span>'</em>, while the console
        output may display summary information for each of the
        entities.</p></li></ul></div><p>Callable function watchers can be defined in two ways:</p><div class="itemizedlist"><ul type="disc"><li><p>Via Python code, such as the ones in your game's base or cell
        entities' resource directories.</p><p>For details on how to implement Python function watchers, see
        <a href="#xref_Implement_Function_Watchers" title="30.1.2.&nbsp;Implementing Function Watchers">Implementing Function Watchers</a>.</p></li><li><p>Via C++ in server components.</p><p>Currently, C++ support for callable watchers is limited <span class="symbol">&#8208;</span> if you wish to use C++ callable watchers,
        then please contact BigWorld support for further information on how to
        use and implement these watchers.</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>In order to enable any callable function watchers to be exposed
        on the WebConsole's <em class="emphasis">Commands</em> <span class="symbol">&#8594;</span> <em class="emphasis">My
        Commands</em> page, it is necessary to place the watcher under
        the <span class="literal">command</span> watcher path.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Forwarding_Watchers"></a>30.1.1.&nbsp;Forwarding Watchers</h3></div></div></div><p>The concept of watcher forwarding was introduced because quite
      often the knowledge of how best to run a callable function watcher is
      not known by the person using it <span class="symbol">&#8208;</span>
      <em class="emphasis">i.e.</em>, decisions such as if should all CellApps run
      the watcher to generate a comprehensive report, or should it be run on
      the first available CellApp to perform an action.</p><p>Watcher forwarding allows a component manager
      (<em class="emphasis">e.g.</em>, CellAppMgr, BaseAppMgr) to forward a
      callable watcher request to any of its owned components, thus allowing
      the developer of the callable watcher to determine how best to expose
      the watchers functionality for general use.</p><p>The decision regarding how best to run a callable watcher is
      encoded by the developer via an exposure hint. Currently there are 2
      forms of expose hints:</p><div class="itemizedlist"><ul type="disc"><li><p>Least Loaded:</p><p>Run the callable watcher on the component with the least load
          of all known components owned by the manager.</p></li><li><p>All</p><p>Run the callable watcher on all components owned by the
          manager.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Implement_Function_Watchers"></a>30.1.2.&nbsp;Implementing Function Watchers</h3></div></div></div><p>Python function watchers can be added either via a component
      <span class="literal">PyConsole</span> for development purposes, or via game
      script for a persistent callable watcher. Adding a watcher requires
      using the <span class="literal">BigWorld.addFunctionWatcher</span> method (for
      details, see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/baseapp/index.html#Client_Python_API" class="olink">Client Python API</a>, <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/cellapp/index.html#Client_Python_API" class="olink">Client Python API</a>, or <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>).</p><p>Generally function watchers are added to pre-existing Python
      functions which functionality would be useful to expose to a wider
      audience. Below is a brief example of a function being exposed via a
      watcher.</p><pre class="programlisting">def addGuardReturnMessage( num ):<a name="co59975"></a><img src="../images/callouts/1.png" alt="1" border="0">
   count = 0
   resultStr = ""
   try:
      count = util.addGuards( num )
      resultStr = "Added %s guards." % count
   except Exception, e:
      print e
      resultStr = "Unable to add %s guards." % num

   return resultStr


BigWorld.addFunctionWatcher(
   "command/addGuards",  <a name="co59976" href="#co59976_desc"><img src="../images/callouts/2.png" alt="2" border="0"></a>
   addGuardReturnMessage,  <a name="co59977" href="#co59977_desc"><img src="../images/callouts/3.png" alt="3" border="0"></a>
   [("Number of guards to add", int)],  <a name="co59978" href="#co59978_desc"><img src="../images/callouts/4.png" alt="4" border="0"></a>
   BigWorld.EXPOSE_LEAST_LOADED,  <a name="co59979" href="#co59979_desc"><img src="../images/callouts/5.png" alt="5" border="0"></a>
   "Add an arbitrary number of patrolling guards into the world.")  <a name="co59980" href="#co59980_desc"><img src="../images/callouts/6.png" alt="6" border="0"></a></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co59975_desc"></a><a href="#co59975"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p><span class="literal">addGuardReturnMessage</span> acts as a wrapper
            function for <span class="literal">util.addGuards</span>, to provide more
            meaningful output for WebConsole display.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co59976_desc"></a><a href="#co59976"><img src="../images/callouts/2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><p><span class="literal">command/addGuards</span> is the watcher path the
            function watcher will be exposed at.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co59977_desc"></a><a href="#co59977"><img src="../images/callouts/3.png" alt="3" border="0"></a> </td><td valign="top" align="left"><p><span class="literal">addGuardReturnMessage</span> is the function
            name the watcher should call when a request is received at the
            watcher path.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co59978_desc"></a><a href="#co59978"><img src="../images/callouts/4.png" alt="4" border="0"></a> </td><td valign="top" align="left"><p>The argument list is defined as a list of tuples, with each
            tuple containing argument name and the type of the value to be
            expected.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co59979_desc"></a><a href="#co59979"><img src="../images/callouts/5.png" alt="5" border="0"></a> </td><td valign="top" align="left"><p><span class="literal">BigWorld.EXPOSE_LEAST_LOADED</span> indicates to
            the component manager to run the watcher request on the component
            with the lowest load.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="co59980_desc"></a><a href="#co59980"><img src="../images/callouts/6.png" alt="6" border="0"></a> </td><td valign="top" align="left"><p>This is a longer description of the function watcher, which
            can be useful in outlining any peculiarities or caveats with the
            function watcher.</p></td></tr></table></div><p>More examples can be found in
      <code class="filename">fantasydemo/res/scripts/base/Watchers.py</code> and
      <code class="filename">fantasydemo/res/scripts/cell/Watchers.py</code>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Debug_Message_Macros"></a>Chapter&nbsp;31.&nbsp;Debug Message Macros</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e17094">31.1. Centralised Logging</a></span></dt><dt><span class="section"><a href="#xref_Filtering_By_Priority">31.2. Filtering by Priority</a></span></dt><dt><span class="section"><a href="#d0e17145">31.3. Message Priority</a></span></dt></dl></div><p>Debug message macros (defined in header file
  <span class="literal">src/lib/cstdmf/debug.hpp</span>) are designed to be used in
  place of <span class="literal">printf()</span> for outputting debug
  information.</p><p>The use of debug message macros instead of <span class="literal">printf()</span>
  allows for more systematic treatment of debug messages. For example,
  BigWorld server supports centralised logging and filtering for debug
  messages.</p><p>Before being able to use a debug message macro, you must include one
  of the following declarations in your .cpp file:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="literal">DECLARE_DEBUG_COMPONENT( modulePriority )</span>,
      or</p></li><li><p><span class="literal">DECLARE_DEBUG_COMPONENT2( watcherLocation, modulePriority
      )</span></p></li></ul></div><p>The argument <span class="literal">modulePriority</span> is a number (usually 0)
  used for filtering debug messages. For more details, see <a href="#xref_Filtering_By_Priority" title="31.2.&nbsp;Filtering by Priority">Filtering by Priority</a>.</p><p>These macros also create a watcher entry allowing the modulePriority
  to be modified. The watcher entry is one of the following:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="literal">logger/cppThresholds/<em class="replaceable"><code>&lt;source_filename&gt;</code></em></span>,
      or</p></li><li><p><span class="literal">logger/cppThresholds/watcherLocation/<em class="replaceable"><code>&lt;source_filename&gt;</code></em></span></p></li></ul></div><p>Debug output macros accept the same parameters as
  <span class="literal">printf()</span>. The <span class="literal">printf()</span> function has
  the syntax below:</p><pre class="programlisting">int printf( const char * format [argument]... )</pre><p>An example usage of a debug output macro:</p><pre class="programlisting">TRACE_MSG( "%s is %d", someString, someInteger );</pre><p>There are several debug message macros, named in the form
  &lt;priority&gt;_MSG, as described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">TRACE_MSG</span> <span class="symbol">&#8208;</span> Priority: 0</em></p><p>Tracing program flow, <em class="emphasis">e.g.</em>, entering a
      method.</p></li><li><p><em class="emphasis"><span class="literal">DEBUG_MSG</span> <span class="symbol">&#8208;</span> Priority: 1</em></p><p>Displaying debugging information, <em class="emphasis">e.g.</em>,
      showing the value of a variable.</p></li><li><p><em class="emphasis"><span class="literal">INFO_MSG</span> <span class="symbol">&#8208;</span> Priority: 2</em></p><p>Displaying general information, <em class="emphasis">e.g.</em>, the
      start of a process.</p></li><li><p><em class="emphasis"><span class="literal">NOTICE_MSG</span> <span class="symbol">&#8208;</span> Priority: 3</em></p><p>Displaying information that is more important than INFO, but
      definitely not an error.</p></li><li><p><em class="emphasis"><span class="literal">WARNING_MSG</span> <span class="symbol">&#8208;</span> Priority: 4</em></p><p>Displaying potential errors.</p></li><li><p><em class="emphasis"><span class="literal">ERROR_MSG</span> <span class="symbol">&#8208;</span> Priority: 5</em></p><p>Displaying definite errors.</p></li><li><p><em class="emphasis"><span class="literal">CRITICAL_MSG</span> <span class="symbol">&#8208;</span> Priority: 6</em></p><p>Displaying critical errors (<em class="emphasis">i.e.</em>, errors that
      cause the program to stop running).</p></li><li><p><em class="emphasis"><span class="literal">HACK_MSG</span> <span class="symbol">&#8208;</span> Priority: 7</em></p><p>Temporary messages used during development. Reserved for BigWorld
      internal use only.</p></li><li><p><em class="emphasis"><span class="literal">SCRIPT_MSG</span> <span class="symbol">&#8208;</span> Priority: 8</em></p><p>Messages printed from a Python script. Reserved for BigWorld
      internal use only.</p></li></ul></div><p>Debug messages are output to the console on Linux and to the debugger
  on Windows. For components with access to the game time (such as BaseApp and
  CellApp), it is automatically added to the start of the message.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e17094"></a>31.1.&nbsp;Centralised Logging</h2></div></div></div><p>In addition to outputting to the console (or debugger), the debug
    messages are also sent to all MessageLogger processes on the
    network.</p><p>Apart from the filtering options available in MessageLogger, logging
    (<em class="emphasis">i.e.</em>, the sending of messages) to a particular
    MessageLogger can be disabled by specifying the IP address of the
    MessageLogger machine in the watcher value logger/del. For details on
    MessageLogger, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_Admin_Tools" class="olink"><i>Cluster Administration Tools</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_MessageLogger" class="olink">Message Logger</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Filtering_By_Priority"></a>31.2.&nbsp;Filtering by Priority</h2></div></div></div><p>The amount of debug output generated by a server component can be
    controlled through a combination of module priority and filter threshold.
    A debug message is discarded if its priority is less than the value of
    variable <span class="literal">filterThreshold</span> added to
    <span class="literal">modulePriority</span>.</p><p>The variable <span class="literal">modulePriority</span> is initialised by the
    macro <span class="literal">DECLARE_DEBUG_COMPONENT</span>, but can be later changed
    using the watcher value
    <span class="literal">logger/cppThresholds/<em class="replaceable"><code>&lt;source_filename&gt;</code></em></span>.</p><p>The variable <span class="literal">filterThreshold</span> is initialised to
    zero, but can be changed using the watcher value
    <span class="literal">logger/filterThreshold</span>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e17145"></a>31.3.&nbsp;Message Priority</h2></div></div></div><p>All log messages have an explicit priority value. The
    <span class="literal">DebugMessagePriority</span> enumeration in header file
    <span class="literal">src/lib/cstdmf/debug.hpp</span> defines these values as
    below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">0</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_TRACE</span></p></li><li><p><em class="emphasis">1</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_DEBUG</span></p></li><li><p><em class="emphasis">2</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_INFO</span></p></li><li><p><em class="emphasis">3</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_NOTICE</span></p></li><li><p><em class="emphasis">4</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_WARNING</span></p></li><li><p><em class="emphasis">5</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_ERROR</span></p></li><li><p><em class="emphasis">6</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_CRITICAL</span></p></li><li><p><em class="emphasis">7</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_HACK</span></p></li><li><p><em class="emphasis">8</em> <span class="symbol">&#8208;</span>
        <span class="literal">MESSAGE_PRIORITY_SCRIPT</span></p></li></ul></div><p>This value is used to filter the messages that are printed and sent
    to the logger. If the message priority is greater than, or equal to the
    filter threshold value, then the message is allowed. For example, a
    threshold of <span class="literal">MESSAGE_PRIORITY_INFO</span> only allows
    <span class="literal">INFO</span> messages, and higher <span class="symbol">&#8208;</span> which means that <span class="literal">TRACE</span>
    and <span class="literal">DEBUG</span> messages will be filtered out.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Non_Blocking_Socket_IO_Using_Mercury"></a>Chapter&nbsp;32.&nbsp;Non-Blocking Socket I/O Using Mercury</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e17271">32.1. Getting Callbacks From Mercury::EventDispatcher</a></span></dt></dl></div><p>TCP/IP is commonly used to communicate with third party products, like
  billing systems, for example. However, care must be taken to avoid blocking
  the main thread of the program.</p><p>One option is to spawn separate threads to handle the I/O, but the
  recommended option is to use non-blocking I/O. Mercury uses non-blocking I/O
  by default, and provides callbacks on I/O events to enable the program to
  wait for something without blocking the main thread.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e17271"></a>32.1.&nbsp;Getting Callbacks From Mercury::EventDispatcher</h2></div></div></div><p>The <code class="classname">Mercury::EventDispatcher</code> class contains
	the main loop of almost all the server executables:
	<code class="methodname">Mercury::EventDispatcher::processContinuously()</code>.</p><p>This function effectively time slices the main thread by waiting for
    events to happen on sockets, and then calling handlers to process those
    events. It is vital that all event handler does not to block or take
    a significant amount of processing time, otherwise the others will be
    starved.</p><p>The following Mercury::EventDispatcher methods allow event handlers
	to be registered:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="methodname">registerFileDescriptor</code></em></p><p><span class="literal">bool registerFileDescriptor( int
        fd, InputNotificationHandler * handler );</span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="methodname">deregisterFileDescriptor</code></em></p><p><span class="literal">bool deregisterFileDescriptor( int fd
        );</span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="methodname">registerWriteFileDescriptor</code></em></p><p><span class="literal">bool registerWriteFileDescriptor( int
        fd, InputNotificationHandler * handler );</span></p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="methodname">deregisterWriteFileDescriptor</code></em></p><p><span class="literal">bool deregisterWriteFileDescriptor( int fd
        );</span></p></li></ul></div><p>The <span class="literal">handleInputNotification</span> method of an
    <span class="literal">InputNotificationHandler</span> object registered via
    <span class="literal">registerFileDescriptor</span> will be called when the
    specified file descriptor (usually a socket) has data available for
    reading.</p><p>The <code class="methodname">handleInputNotification</code> method of an
    <code class="methodname">InputNotificationHandler</code> object registered via
    <code class="methodname">registerWriteFileDescriptor</code> will be called when
    the specified file descriptor (usually a socket) is ready for writing.
    This is useful when writing a large amount of data. A non-blocking write
    operation will only write an amount of data equal to, or less than, its
    internal buffers can hold. Then the program must wait until the socket is
    again ready to be written to. Waiting for a socket to become writable is
    also useful during the TCP connection process, as the socket will not be
    ready for writing until the connection is fully established.</p><p>All registered handlers must be de-registered using the
    corresponding function. They are not automatically de-registered when the
    file descriptor is closed.</p><p>For more details, see the example file
    <code class="filename">bigworld/src/server/baseapp/eg_tcpecho.cpp</code>.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_MySQL_Database_Schema"></a>Chapter&nbsp;33.&nbsp;MySQL Database Schema</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Entity_Tables">33.1. Entity Tables</a></span></dt><dt><span class="section"><a href="#xref_Non_Entity_Tables">33.2. Non-Entity Tables</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Entity_Tables"></a>33.1.&nbsp;Entity Tables</h2></div></div></div><p>Entity tables store the persistent entity data. The name of all
    entity tables if prefixed by <span class="literal">tbl_</span>.</p><p>Every entity type has one main table and zero or more sub-tables. An
    entity type's main table is named
    <span class="literal">tbl_<em class="replaceable"><code>&lt;entity_type_name&gt;</code></em></span>.
    The main table name is the prefix for the names any sub-tables of that
    entity type.</p><p>For details, see <a href="#xref_Mapping_BigWorld_Properties_Into_SQL" title="8.3.&nbsp;Mapping BigWorld Properties Into SQL">Mapping BigWorld Properties Into SQL</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Non_Entity_Tables"></a>33.2.&nbsp;Non-Entity Tables</h2></div></div></div><p>BigWorld uses a number of tables to keep track of various internal
    states <span class="symbol">&#8208;</span> these tables' names are prefixed
    by <span class="literal">bigworld</span>. Accessing or modifying these tables is
    strongly discouraged.</p><p>BigWorld non-entity tables are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">bigworldEntityTypes</span></em></p><p>Maps entity names to internal entity type numbers.</p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">name</span></em> -
            The name of the entity type.</p></li><li><p><em class="emphasis"><span class="literal">typeID</span></em> -
            An id that is maintained over changes to
            <span class="literal"><code class="filename">entities.xml</code></span>.</p></li><li><p><em class="emphasis"><span class="literal">bigworldID</span></em> - An id that
            indicates this type's position in
            <code class="filename">entities.xml</code>.</p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">bigworldGameTime</span></em></p><p>Stores the current game time.</p><p>This information is used during crash recovery.</p></li><li><p><em class="emphasis"><span class="literal">bigworldInfo</span></em></p><p>Stores the version number of the schema.</p><p>This number is incremented if a new version of BigWorld uses an
        incompatible schema that will require migration of data.</p></li><li><p><em class="emphasis"><span class="literal">bigworldLogOnMapping</span></em></p><p>Used during the login process to determine whether to allow
        access to a user.</p><p>For details, see <a href="#xref_Bypassing_bigworldLogOnMapping_And_Using_Account_Entity" title="20.2.&nbsp;Authentication via a Base entity">Authentication via a Base entity</a>.</p></li><li><p><em class="emphasis"><span class="literal">bigworldLogOns</span></em></p><p>Stores information about entities that are currently
        active.</p><p>This information is used to construct mailboxes to active
        entities <span class="symbol">&#8208;</span> every active entity with a
        non-zero <span class="literal">databaseID</span> (including non-Proxy entities
        <span class="symbol">&#8208;</span> will have an entry in this
        table.</p></li><li><p><em class="emphasis"><span class="literal">bigworldNewID</span></em></p><p>Together with <span class="literal">bigWorldUserID</span>s, this table is
        used to keep track of the object IDs currently in use by the
        system.</p><p>This information is used during crash recovery to prevent
        allocation of duplicate object IDs.</p></li><li><p><em class="emphasis"><span class="literal">bigworldSecondaryDatabases</span></em></p><p>Each row in this table represents an unconsolidated secondary
        database. When the server is shutdown this information will be used by
        the data consolidation process to retrieve the secondary databases.
        When the data consolidation completes, this table will be
        cleared.</p><p>For more details about secondary databases, see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="server_programming_guide.html#xref_Secondary_Databases" class="olink">Secondary Databases</a>.</p></li><li><p><em class="emphasis"><span class="literal">bigworldSpaceData</span></em></p><p>Together with <span class="literal">bigworldSpaces</span>, this table
        contains a backup of the space data.</p><p>This information is used during crash recovery.</p></li><li><p><em class="emphasis"><span class="literal">bigworldSpaces</span></em></p><p>See <span class="literal">bigworldSpaceData</span></p></li><li><p><em class="emphasis"><span class="literal">bigworldTableMetadata</span></em></p><p>Stores meta information about the database schema.</p><p>This table is a candidate for obsolescence, since MySQL already
        provides APIs for retrieving database meta data.</p></li><li><p><em class="emphasis"><span class="literal">bigworldUsedIDs</span></em></p><p>See <span class="literal">bigworldNewID</span>.</p></li></ul></div></div></div></div><div class="part" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="xref_Part_Extending_WebConsole"></a>Part&nbsp;III.&nbsp;Extending WebConsole</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#xref_WebConsole_Overview">34. Web Console</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17611">34.1. Adding a Page to a Module</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17635">34.1.1. Create a Template KID File</a></span></dt><dt><span class="section"><a href="#d0e17675">34.1.2. Edit <code class="filename">controllers.py</code></a></span></dt></dl></dd><dt><span class="section"><a href="#d0e17723">34.2. Adding a Module</a></span></dt><dt><span class="section"><a href="#d0e17812">34.3. Add an Action Item to ClusterControl</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Adding_A_Menu_Item_For_An_Existing_Component_Type">34.3.1. Adding a Menu Item for an Existing Component Type</a></span></dt><dt><span class="section"><a href="#d0e17862">34.3.2. Adding a Menu Item for a New Component Type</a></span></dt></dl></dd></dl></dd></dl></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_WebConsole_Overview"></a>Chapter&nbsp;34.&nbsp;Web Console</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e17611">34.1. Adding a Page to a Module</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e17635">34.1.1. Create a Template KID File</a></span></dt><dt><span class="section"><a href="#d0e17675">34.1.2. Edit <code class="filename">controllers.py</code></a></span></dt></dl></dd><dt><span class="section"><a href="#d0e17723">34.2. Adding a Module</a></span></dt><dt><span class="section"><a href="#d0e17812">34.3. Add an Action Item to ClusterControl</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Adding_A_Menu_Item_For_An_Existing_Component_Type">34.3.1. Adding a Menu Item for an Existing Component Type</a></span></dt><dt><span class="section"><a href="#d0e17862">34.3.2. Adding a Menu Item for a New Component Type</a></span></dt></dl></dd></dl></div><p>Although WebConsole provides numerous features to control and monitor
  a server cluster, there many times when you want to extend its
  functionality. This part of the document describes how to do that.</p><p>WebConsole is built upon an existing web development framework
  (TurboGears). The list below describes TurboGears' components of
  interest:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">TurboGears</em></p><p>Rapid web application development framework.</p><p>Component can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.turbogears.org/" target="_top">http://www.turbogears.org/</a>.</p><p>Documentation can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://docs.turbogears.org/1.0" target="_top">http://docs.turbogears.org/1.0</a>.</p></li><li><p><em class="emphasis">MochiKit</em></p><p>A set of JavaScript libraries to enhance existing JavaScript
      functionality and provide simple mechanisms of performing common
      JavaScript operations.</p><p>Component can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://mochikit.com/" target="_top">http://mochikit.com/</a>.</p><p>Documentation can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://mochikit.com/doc/html/MochiKit/index.html" target="_top">http://mochikit.com/doc/html/MochiKit/index.html</a>.</p></li><li><p><em class="emphasis">KID Templates</em></p><p>Template language that provides the ability to integrate Python
      code into HTML to generate dynamic web pages.</p><p>Component can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://kid-templating.org/" target="_top">http://kid-templating.org/</a>.</p></li><li><p><em class="emphasis">CherryPy</em></p><p>Web server component of TurboGears.</p><p>Component can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.cherrypy.org/" target="_top">http://www.cherrypy.org/</a>.</p><p>Documentation can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://docs.cherrypy.org/" target="_top">http://docs.cherrypy.org/</a>.</p></li><li><p><em class="emphasis">SQLObject</em></p><p>Relational database Python wrapper that abstracts database
      concepts (such as tables, rows and columns) into object-oriented
      concepts (such as classes, instances and attributes).</p><p>Component can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.sqlobject.org/" target="_top">http://www.sqlobject.org/</a>.</p><p>Documentation can be found at <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.sqlobject.org/SQLObject.html" target="_top">http://www.sqlobject.org/SQLObject.html</a>.</p></li></ul></div><p>The referenced documentation will differ based on the kind of
  functionality that you are trying to achieve within WebConsole. The sections
  below outline some common modifications that you might wish to make to
  WebConsole, and a brief description of what is required. The also include
  references to the appropriate component documentation that would be used
  while modifying the tool.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e17611"></a>34.1.&nbsp;Adding a Page to a Module</h2></div></div></div><p>This is possibly the easiest modification that you might want to
    make to WebConsole.</p><p>There are roughly two steps to add a new page:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Create a template KID
        file.</em></p><p>This file displays the dynamic content generated in whatever
        format we choose. The content is generated by the method created in
        the step below.</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Add a method to
        <code class="filename">controllers.py</code>.</em></p><p>The method will be called when the page is accessed, and
        generates the content to be passed to the template file.</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e17635"></a>34.1.1.&nbsp;Create a Template KID File</h3></div></div></div><p>Below is a simple stub template file that is enough to test if the
      code is hooked up correctly, before writing the template layout
      code.</p><p>For our example, this template file will be saved as
      <code class="filename">web_console/log_viewer/
      templates/delete.kid</code>.</p><pre class="programlisting">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
  
&lt;?python
  layout_params[ "moduleHeader" ] = "Log Viewer"
?&gt;
  
&lt;html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://purl.org/kid/ns#"
      py:layout="'../../common/templates/layout.kid'"
      py:extends="'../../common/templates/common.kid'"&gt;
  
&lt;div py:def="moduleContent()"&gt; <a name="co10568" href="#co10568_desc"><img src="../images/callouts/1.png" alt="1" border="0"></a>
  
    &lt;script type="text/javascript"&gt;
        PAGE_TITLE = 'Delete a Log';
    &lt;/script&gt;
  
    This page will be able to delete logs.

`&lt;p&gt;Page accessed: ${accessTime}&lt;/p&gt;
&lt;/div&gt;
&lt;/html&gt;</pre><p><span class="citetitle">Example KID template file <span class="symbol">&#8208;</span>
      <code class="filename">web_console/log_viewer/templates/delete.kid</code></span></p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="co10568_desc"></a><a href="#co10568"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>This tag is necessary because the template inherits its layout
          from <code class="filename">web_console/common/templates/layout.kid</code>,
          which displays the module list in the left hand side of the page,
          and then fills the main portion of the page by calling
          <code class="methodname">moduleContent()</code>.</p><p>If you remove the <span class="literal">&lt;div&gt;</span> element and
          access the page, an exception should be produced, stating that
          <span class="literal">"name 'moduleContent' is not defined"</span>.</p></td></tr></table></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e17675"></a>34.1.2.&nbsp;Edit <code class="filename">controllers.py</code></h3></div></div></div><p>The method created in controllers.py joins the act of accessing a
      web page in the browser to processing the data and passing it to the
      template KID file.</p><p>An <span class="literal">@expose</span> decorator must be specified for the
      method that will tie the template KID file to the new method, with the
      forward slashes replaced by periods.</p><p>Add the excerpt below to the <code class="classname">LogViewer</code>
      class:</p><pre class="programlisting"># This will only allow users who have logged in to access the page
@identity.require( identity.not_anonymous() )
@expose( template = "log_viewer.templates.delete" )
def delete( self, **kw ):
  return dict( accessTime=time.ctime() )</pre><p>Note that the name of the added method can be accessed directly,
      since it has been exposed. To access the page, try to connect to
      <span class="literal">http://<em class="replaceable"><code>&lt;machinename&gt;</code></em>:8080/log/delete.</span></p><p>Finally, if you wish to add the page as a link in the left-hand
      navigation links, under the module heading, then add the line below in
      the <code class="methodname">__init__</code> method of
      <code class="filename">controllers.py</code>:</p><pre class="programlisting">self.addPage( "Delete Logs", "delete" )</pre><p><em class="emphasis">Example <code class="filename">controllers.py</code>
      <span class="symbol">&#8208;</span> Addition to the
      <span class="literal">__init__</span> method</em></p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e17723"></a>34.2.&nbsp;Adding a Module</h2></div></div></div><p>Creating a basic module is a relatively straightforward procedure.
    Outlined below are the steps required to get a new module working within
    WebConsole. However, to extend its functionality, it is strongly
    recommended that you refer to the TurboGears documentation website, and
    the existing WebConsole modules' documentation.</p><p>The Python Console module is the simplest one in WebConsole, and
    thus the best starting point for grasping how you might extend a module
    once the basic framework is operational.</p><p>The steps below create a module called Devel:</p><div class="orderedlist"><ol type="1"><li><p>Create the directory <code class="filename">web_console/devel</code> and <code class="filename">web_console/devel/templates</code>.</p></li><li><p>In each of the directories above, create an empty file
        <code class="filename">__init__.py</code>.</p></li><li><p>Add the module to <code class="filename">controllers.py</code>.</p><p>To make the module accessible from WebConsole, the root
        controller has to be notified of its existence. To do this, at the end
        of the <code class="methodname">__init__</code> method of
        <code class="filename">web_console/ root/controllers.py</code>, add the excerpt
        below (you should see similar lines for the other modules above
        it):</p><pre class="programlisting">import web_console.devel.controllers
self.devel = web_console.devel.controllers.Devel(self, "Devel Tools", "devel","/static/images/console.png", lambda: not isAdmin() )</pre><p><span class="citetitle">Example <code class="filename">controllers.py</code> <span class="symbol">&#8208;</span> Addition to the
        <code class="methodname">__init__</code> method</span></p></li><li><p>Create the <span class="literal">controllers.py</span> for the new
        module.</p><p>Below is an extremely basic stub module that makes the index
        page available, and links it to the template KID file
        <code class="filename">web_console/devel/templates/index.kid</code>:</p><pre class="programlisting">from turbogears.controllers import (expose, validate)
from turbogears import identity
  
from web_console.common import module
  
class Devel( module.Module ):
  
  def __init__( self, *args, **kw ):
    module.Module.__init__( self, *args, **kw )
  
  @identity.require( identity.not_anonymous() )
  @expose( template="devel.templates.index" )
  def index( self ):
    return dict()</pre><p><span class="citetitle">Example <code class="filename">controllers.py</code> for the
        new module</span></p></li><li><p>Create the template page to use when the module is
        accessed.</p><p>Place the text below in
        <code class="filename">web_console/devel/templates/index.kid</code>.</p><pre class="programlisting">  &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
  &lt;html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://purl.org/kid/ns#"
      py:layout="'../../common/templates/layout.kid'"&gt;
  
  &lt;div py:def="moduleContent()"&gt;
    The Development Module
  &lt;/div&gt;
  
  &lt;/html&gt;</pre><p><span class="citetitle">File
        <code class="filename">web_console/devel/templates/index.kid</code></span></p></li></ol></div><p>After these modifications, the module Devel Tools will be displayed
    in WebConsole's left-hand navigation menu.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e17812"></a>34.3.&nbsp;Add an Action Item to ClusterControl</h2></div></div></div><p>The action menu supports two types of functionality:</p><div class="itemizedlist"><ul type="disc"><li><p>Redirecting upon selection</p></li><li><p>Running JavaScript upon selection</p></li></ul></div><p>The behaviour is defined in
    <code class="filename">web_console/common/util.py</code> script, in
    <code class="methodname">ActionMenuOptions.addRedirect()</code> and
    <code class="methodname">ActionMenuOptions.addScript()</code> methods.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Adding_A_Menu_Item_For_An_Existing_Component_Type"></a>34.3.1.&nbsp;Adding a Menu Item for an Existing Component Type</h3></div></div></div><p>To add an action menu item to a cluster component type, edit the
      <code class="filename">web_console/common/caps.py</code> script, and for the
      particular cluster process type, add a call to either
      <code class="methodname">addRedirect</code> or
      <code class="methodname">addScript</code>.</p><p>For example, in order to add a menu item called Clone, which only
      for CellApps redirects to a different page, the following should be
      added to the get method in caps.py:</p><pre class="programlisting">if isinstance( o, cluster.CellAppProcess ):
  addRedirect( "Clone", "/cc/clone",
           params = dict( ),
           help = "Clone this process" )</pre><p><span class="citetitle">Example caps.py <span class="symbol">&#8208;</span>
      Addition to the <code class="methodname">get()</code> method</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e17862"></a>34.3.2.&nbsp;Adding a Menu Item for a New Component Type</h3></div></div></div><p>To enable the detection of a new component process type, it is
      necessary to add a Python class in
      <code class="filename">bigworld/tools/server/pycommon/process.py</code> to
      uniquely identify that process.</p><p>In the example below, we add a new component process type for an
      SMS component, so that WebConsole can display a Send SMS action.</p><p>First, a simple stub class for the SMS component must be created.
      To keep all the different process definitions together, search for the
      class definition for ReviverProcess, then add the following text just
      after it:</p><pre class="programlisting">class SMSProcess( Process ):
  
  def __init__( self, machine, mgm ):
    Process.__init__( self, machine, mgm )</pre><p><span class="citetitle">Example <code class="filename">process.py</code> <span class="symbol">&#8208;</span> Definition of <span class="literal">SMSProcess</span>
      class</span></p><p>The new class then needs to be associated with an MGM message
      <span class="symbol">&#8208;</span> in <span class="literal">cluster.py</span>, in
      the <span class="literal">Process.getProcess</span> method, edit the
      <span class="literal">name2proc</span> hash and add the mapping from the component
      network name to the class type:</p><pre class="programlisting">  ...
  "client": ClientProcess,
  "message_logger": MessageLoggerProcess,
  "sms": SMSProcess }</pre><p><span class="citetitle">Example cluster.py <span class="symbol">&#8208;</span>
      Addition to the <span class="literal">Process.getProcess</span>
      method</span></p><p>It is now possible to add an action menu item, just as described
      in section <a href="#xref_Adding_A_Menu_Item_For_An_Existing_Component_Type" title="34.3.1.&nbsp;Adding a Menu Item for an Existing Component Type">Adding a Menu Item for an Existing Component Type</a>.</p></div></div></div></div></div></div></body></html>