<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Client Programming Guide</title><link rel="stylesheet" href="../css/bigworld.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.72.0"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div id="bigworld-header"><img src="http://try.bigworldtech.com/bigworld/image.php?img=bigworld_logo.gif&amp;svn=$HeadURL:$" alt="bw logo"></div><div id="content"><div class="book" lang="en"><div class="titlepage"><div><div><h1 class="title"><a name="Client_Programming_Guide"></a>Client Programming Guide</h1></div><div><p class="releaseinfo">BigWorld Technology 2.0. Released 2010.</p></div><div><p class="copyright">Copyright &copy; 1999-2010 BigWorld Pty Ltd. All rights reserved. </p></div><div><div class="legalnotice"><a name="d0e17"></a><p>This document is proprietary commercial in confidence and access
  is restricted to authorised users. This document is protected by
  copyright laws of Australia, other countries and international treaties.
  Unauthorised use, reproduction or distribution of this document, or any
  portion of this document, may result in the imposition of civil and
  criminal penalties as provided by law.</p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#xref_Overview">1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e34">1.1. Client in context</a></span></dt><dt><span class="section"><a href="#d0e63">1.2. Outline</a></span></dt><dt><span class="section"><a href="#xref_Resource_Search_Paths">1.3. Resource search paths</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e145">1.3.1. paths.xml</a></span></dt><dt><span class="section"><a href="#d0e170">1.3.2. Command line switch</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Configuration_Files">1.4. Configuration files</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_File_resources_xml">1.4.1. File <span class="literal">resources.xml</span></a></span></dt><dt><span class="section"><a href="#xref_File_engine_config_xml">1.4.2. File
      <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span></a></span></dt><dt><span class="section"><a href="#xref_File_scripts_config_xml">1.4.3. File
      <span class="literal"><em class="replaceable"><code>&lt;scripts_config&gt;</code></em>.xml</span></a></span></dt><dt><span class="section"><a href="#xref_File_preferences_xml">1.4.4. File
      <span class="literal"><em class="replaceable"><code>&lt;preferences&gt;</code></em>.xml</span></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Coordinate_system">1.5. Coordinate System</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_User_Input">2. User Input</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Key_Events">2.1. Key events</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e481">2.1.1. Character events</a></span></dt><dt><span class="section"><a href="#d0e495">2.1.2. Auto-repeat</a></span></dt><dt><span class="section"><a href="#d0e505">2.1.3. Sequence of events</a></span></dt><dt><span class="section"><a href="#d0e554">2.1.4. Sinking events</a></span></dt><dt><span class="section"><a href="#d0e569">2.1.5. Mouse cursor position</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e580">2.2. Mouse</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e583">2.2.1. Movement</a></span></dt><dt><span class="section"><a href="#d0e621">2.2.2. Buttons</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e631">2.3. Joystick</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e636">2.3.1. Axis events</a></span></dt><dt><span class="section"><a href="#d0e647">2.3.2. Buttons</a></span></dt><dt><span class="section"><a href="#d0e657">2.3.3. Controlling player direction</a></span></dt><dt><span class="section"><a href="#d0e665">2.3.4. Avatar movement</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Cameras">3. Cameras</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e709">3.1. The Cursor Camera</a></span></dt><dt><span class="section"><a href="#d0e720">3.2. The Free Camera</a></span></dt><dt><span class="section"><a href="#d0e725">3.3. The FlexiCam</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Terrain">4. Terrain</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e737">4.1. Advanced Terrain</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e740">4.1.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e745">4.1.2. Key Features</a></span></dt><dt><span class="section"><a href="#d0e780">4.1.3. Texturing</a></span></dt><dt><span class="section"><a href="#d0e788">4.1.4. Lighting</a></span></dt><dt><span class="section"><a href="#d0e794">4.1.5. Shadows</a></span></dt><dt><span class="section"><a href="#d0e802">4.1.6. LOD</a></span></dt><dt><span class="section"><a href="#d0e838">4.1.7. Memory footprint</a></span></dt><dt><span class="section"><a href="#xref_terrain2_section">4.1.8. <span class="literal">terrain2</span> resources</a></span></dt><dt><span class="section"><a href="#xref_Space_terrain_section">4.1.9. <span class="literal">terrain</span> section in
      <span class="literal">space.settings</span></a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1702">4.2. Simple Terrain</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1705">4.2.1. Key features</a></span></dt><dt><span class="section"><a href="#d0e1739">4.2.2. Overview</a></span></dt><dt><span class="section"><a href="#d0e1747">4.2.3. Chunking</a></span></dt><dt><span class="section"><a href="#d0e1752">4.2.4. Disk footprint</a></span></dt><dt><span class="section"><a href="#d0e1825">4.2.5. Memory footprint</a></span></dt><dt><span class="section"><a href="#d0e1832">4.2.6. Texture spacing</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_TerrainSpecular">4.3. Terrain specular lighting</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Cloud_Shadows">5. Cloud shadows</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2015">5.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e2020">5.2. Implementation</a></span></dt><dt><span class="section"><a href="#d0e2032">5.3. Effect File Implementation</a></span></dt><dt><span class="section"><a href="#xref_Tweaking">5.4. Tweaking</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Chunks">6. Chunks</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2146">6.1. Definitions</a></span></dt><dt><span class="section"><a href="#xref_Implementation_Files">6.2. Implementation files</a></span></dt><dt><span class="section"><a href="#xref_Details_And_Notes">6.3. Details and notes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2278">6.3.1. Includes</a></span></dt><dt><span class="section"><a href="#d0e2296">6.3.2. Models</a></span></dt><dt><span class="section"><a href="#d0e2303">6.3.3. Entities</a></span></dt><dt><span class="section"><a href="#xref_Boundaries_And_Portals">6.3.4. Boundaries and portals</a></span></dt><dt><span class="section"><a href="#d0e2325">6.3.5. Transforms</a></span></dt><dt><span class="section"><a href="#d0e2330">6.3.6. Other items</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e2354">6.4. Loading and ejecting</a></span></dt><dt><span class="section"><a href="#d0e2364">6.5. Focus grid</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2375">6.5.1. Hull tree</a></span></dt><dt><span class="section"><a href="#d0e2385">6.5.2. Quad tree</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e2392">6.6. Collisions</a></span></dt><dt><span class="section"><a href="#xref_Sway_Items">6.7. Sway items</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Entities">7. Entities</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2527">7.1. Entity Manager</a></span></dt><dt><span class="section"><a href="#xref_Entities_Are_Python_Script_Objects">7.2. Entity scripts</a></span></dt><dt><span class="section"><a href="#d0e2566">7.3. Entity resources</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Entity_Preloads">7.3.1. Preloads</a></span></dt><dt><span class="section"><a href="#d0e2606">7.3.2. Prerequisites</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_UDOs">8. User Data Objects</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_UDOs_Are_Python_Script_Objects">8.1. .1. User Data Objects are Python script objects</a></span></dt><dt><span class="section"><a href="#xref_UDOs_client_access">8.2. .2. Accessing from the Client</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Scripting">9. Scripting</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Functional_Components">9.1. Functional components</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2788">9.1.1. Entity skeleton</a></span></dt><dt><span class="section"><a href="#d0e2797">9.1.2. Python script object</a></span></dt><dt><span class="section"><a href="#d0e2804">9.1.3. Model management</a></span></dt><dt><span class="section"><a href="#xref_Filters">9.1.4. Filters</a></span></dt><dt><span class="section"><a href="#xref_Action_Queue">9.1.5. Action Queue</a></span></dt><dt><span class="section"><a href="#xref_Action_Matcher">9.1.6. Action Matcher</a></span></dt><dt><span class="section"><a href="#d0e3476">9.1.7. Trackers</a></span></dt><dt><span class="section"><a href="#d0e3558">9.1.8. Timers and Traps</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Personality_Script">9.2. Personality script</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_init">9.2.1. <span class="literal">init</span></a></span></dt><dt><span class="section"><a href="#d0e3802">9.2.2. <span class="literal">fini</span></a></span></dt><dt><span class="section"><a href="#d0e3822">9.2.3. <span class="literal">handleKeyEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3852">9.2.4. <span class="literal">handleMouseEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3872">9.2.5. <span class="literal">handleAxisEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3892">9.2.6. <span class="literal">handleIMEEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3907">9.2.7. <span class="literal">handleLangChangeEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3917">9.2.8. <span class="literal">onChangeEnvironments</span></a></span></dt><dt><span class="section"><a href="#d0e3933">9.2.9. <span class="literal">onGeometryMapped</span></a></span></dt><dt><span class="section"><a href="#d0e3945">9.2.10. <span class="literal">onRecreateDevice</span></a></span></dt><dt><span class="section"><a href="#d0e3964">9.2.11. <span class="literal">onTimeOfDayLocalChange</span></a></span></dt><dt><span class="section"><a href="#d0e3976">9.2.12. <span class="literal">start</span></a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Models">10. Models</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4015">10.1. Performance</a></span></dt><dt><span class="section"><a href="#xref_Hard_Points">10.2. Hard Points</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4079">10.2.1. Naming scheme</a></span></dt><dt><span class="section"><a href="#d0e4157">10.2.2. How it works</a></span></dt><dt><span class="section"><a href="#d0e4164">10.2.3. Syntax</a></span></dt><dt><span class="section"><a href="#d0e4181">10.2.4. Data</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_SuperModel">10.3. SuperModel</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4256">10.3.1. Design</a></span></dt><dt><span class="section"><a href="#d0e4272">10.3.2. SuperModel classes</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Animation_System">11. Animation System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4345">11.1. Basic keyframed animations</a></span></dt><dt><span class="section"><a href="#d0e4361">11.2. Animation layering and blending</a></span></dt><dt><span class="section"><a href="#d0e4401">11.3. Animation data files</a></span></dt><dt><span class="section"><a href="#d0e4435">11.4. Animation data streaming</a></span></dt><dt><span class="section"><a href="#d0e4460">11.5. Actions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Server_Communications">12. Server Communications</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4539">12.1. Login</a></span></dt><dt><span class="section"><a href="#d0e4560">12.2. Online</a></span></dt><dt><span class="section"><a href="#d0e4648">12.3. Firewalls</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Particles">13. Particles</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4671">13.1. Particle Systems</a></span></dt><dt><span class="section"><a href="#d0e4733">13.2. Particle Actions</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4763">13.2.1. Source actions</a></span></dt><dt><span class="section"><a href="#d0e4772">13.2.2. Movement actions</a></span></dt><dt><span class="section"><a href="#d0e4784">13.2.3. Sink actions</a></span></dt><dt><span class="section"><a href="#d0e4800">13.2.4. Alteration actions</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e4805">13.3. Particle types</a></span></dt><dt><span class="section"><a href="#d0e4823">13.4. Attaching particle systems to bones</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Detail_Objects">14. Detail Objects</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4946">14.1. Flora</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4964">14.1.1. Placement</a></span></dt><dt><span class="section"><a href="#d0e5009">14.1.2. Implementation</a></span></dt><dt><span class="section"><a href="#d0e5034">14.1.3. Frame coherency</a></span></dt><dt><span class="section"><a href="#d0e5041">14.1.4. Animation</a></span></dt><dt><span class="section"><a href="#d0e5048">14.1.5. Lighting</a></span></dt><dt><span class="section"><a href="#d0e5055">14.1.6. File format</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Water">15. Water</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5096">15.1. Code overview</a></span></dt><dt><span class="section"><a href="#d0e5216">15.2. Scene generation</a></span></dt><dt><span class="section"><a href="#xref_Render_Settings">15.3. Render settings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Setting_The_Quality">15.3.1. Setting the quality</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Simulation">15.4. Simulation</a></span></dt><dt><span class="section"><a href="#d0e5419">15.5. Rain</a></span></dt><dt><span class="section"><a href="#d0e5424">15.6. Water depth</a></span></dt><dt><span class="section"><a href="#d0e5437">15.7. Watchers</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Graphical_User_Interface_GUI">16. Graphical User Interface (GUI)</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_C_GUI_Support">16.1. C++ GUI support</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5606">16.1.1. SimpleGUIComponent</a></span></dt><dt><span class="section"><a href="#d0e5617">16.1.2. GUIShader</a></span></dt><dt><span class="section"><a href="#d0e5637">16.1.3. SimpleGUI</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Python_GUI_Support">16.2. Python GUI support</a></span></dt><dt><span class="section"><a href="#d0e5689">16.3. XML</a></span></dt><dt><span class="section"><a href="#xref_XML_And_Python">16.4. XML and Python</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5729">16.4.1. <span class="literal">onLoad(self,section)</span></a></span></dt><dt><span class="section"><a href="#d0e5742">16.4.2. <span class="literal">onBound(self)</span></a></span></dt><dt><span class="section"><a href="#d0e5762">16.4.3. <span class="literal">onSave(self,section)</span></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Input_Events">16.5. Input events</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5890">16.5.1. Keyboard Events</a></span></dt><dt><span class="section"><a href="#d0e5941">16.5.2. Axis Events</a></span></dt><dt><span class="section"><a href="#d0e5979">16.5.3. Mouse Events</a></span></dt><dt><span class="section"><a href="#d0e6136">16.5.4. Drag-and-drop events</a></span></dt><dt><span class="section"><a href="#d0e6333">16.5.5. Component PyGUI</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Mouse_Cursor">16.6. Mouse cursor</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Fonts">17. Fonts</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6434">17.1. Creating and Using Fonts</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6439">17.1.1. Creating a Font Definition File</a></span></dt><dt><span class="section"><a href="#d0e6473">17.1.2. Preloading Glyphs</a></span></dt><dt><span class="section"><a href="#d0e6483">17.1.3. Specifying the widest character</a></span></dt><dt><span class="section"><a href="#d0e6493">17.1.4. Displaying Text</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6503">17.2. Artist modified Fonts</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6508">17.2.1. Generating a Snapshot of a Font's Glyph Cache</a></span></dt><dt><span class="section"><a href="#d0e6516">17.2.2. Modifying the Font Texture</a></span></dt><dt><span class="section"><a href="#d0e6523">17.2.3. Explaining the Font Grid .dds File</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_IME">18. Input Method Editors (IME)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6612">18.1. Components of an IME interface</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6637">18.1.1. Examples</a></span></dt><dt><span class="section"><a href="#d0e6654">18.1.2. Recommended Reading</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6667">18.2. IME Python API</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6680">18.2.1. Enabling IME</a></span></dt><dt><span class="section"><a href="#d0e6695">18.2.2. Receiving IME events</a></span></dt><dt><span class="section"><a href="#d0e6772">18.2.3. Displaying the IME</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Web">19. BigWorld Web Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6868">19.1. Architecture</a></span></dt><dt><span class="section"><a href="#d0e6907">19.2. Using the Web Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Web_GUI_Component">19.2.1. In Game Web GUI Component</a></span></dt><dt><span class="section"><a href="#xref_Web_Screen">19.2.2. In Game Web Screen</a></span></dt><dt><span class="section"><a href="#xref_Texture_Mapping">19.2.3. Texture Mapping of Web Pages into a world object</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Sounds">20. Sounds</a></span></dt><dt><span class="chapter"><a href="#xref_3D_Engine">21. 3D Engine (Moo)</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Features">21.1. Features</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7014">21.1.1. D3DXEffects vertex and pixel shader support</a></span></dt><dt><span class="section"><a href="#d0e7021">21.1.2. Cubic environment maps</a></span></dt><dt><span class="section"><a href="#d0e7026">21.1.3. Render targets</a></span></dt><dt><span class="section"><a href="#xref_Lighting">21.1.4. Lighting</a></span></dt><dt><span class="section"><a href="#d0e7136">21.1.5. Normal mapping/bump mapping</a></span></dt><dt><span class="section"><a href="#d0e7141">21.1.6. Terrain</a></span></dt><dt><span class="section"><a href="#d0e7146">21.1.7. Animation</a></span></dt><dt><span class="section"><a href="#d0e7151">21.1.8. Vertex morphing</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e7158">21.2. Supported video cards</a></span></dt><dt><span class="section"><a href="#d0e7191">21.3. Hardware requirements for special effects</a></span></dt><dt><span class="section"><a href="#d0e7324">21.4. Visual</a></span></dt><dt><span class="section"><a href="#xref_EffectMaterial">21.5. EffectMaterial</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_EffectMaterial_Format">21.5.1. Format</a></span></dt><dt><span class="section"><a href="#xref_Automatic_Variables_Globals">21.5.2. Automatic variables/Globals</a></span></dt><dt><span class="section"><a href="#xref_Artist_Editable_Tweakable_Variables">21.5.3. Artist-editable/tweakable variables</a></span></dt><dt><span class="section"><a href="#d0e8227">21.5.4. Multiple-layered effects per material</a></span></dt><dt><span class="section"><a href="#d0e8237">21.5.5. Recording material states</a></span></dt><dt><span class="section"><a href="#d0e8261">21.5.6. Using BigWorld <span class="literal">.fx</span> files with 3ds Max</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8326">21.6. Visual channels</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8359">21.6.1. Sorted channel</a></span></dt><dt><span class="section"><a href="#d0e8371">21.6.2. Internal sorted channel</a></span></dt><dt><span class="section"><a href="#d0e8380">21.6.3. Shimmer channel</a></span></dt><dt><span class="section"><a href="#d0e8387">21.6.4. Sorted shimmer channel</a></span></dt><dt><span class="section"><a href="#d0e8397">21.6.5. Distortion channel</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Textures">21.7. Textures</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Texture_Details_Levels_Compression">21.7.1. Texture detail levels/compression</a></span></dt><dt><span class="section"><a href="#d0e8587">21.7.2. Animated textures</a></span></dt><dt><span class="section"><a href="#d0e8650">21.7.3. Applying a code-generated texture to a character</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8829">21.8. Vertex declaration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8849">21.8.1. File format</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Graphics_Settings">21.9. Graphics settings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Customising_Options">21.9.1. Customising options</a></span></dt><dt><span class="section"><a href="#d0e9820">21.9.2. Using settings</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_High_Resolution_Screenshots">21.10. Taking Screenshots</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10078">21.10.1. High Resolution Screenshots</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Dynamic_Entity_Shadows">21.11. Dynamic Entity Shadows</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10227">21.11.1. Splodges</a></span></dt><dt><span class="section"><a href="#d0e10255">21.11.2. Shadow maps</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Post_Processing">22. Post Processing</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Post_Processing_Pipeline">22.1. Pipeline Overview</a></span></dt><dt><span class="section"><a href="#d0e10390">22.2. Creating a Custom Post-Processing Effect</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10399">22.2.1. Creating the Custom Pixel Shader</a></span></dt><dt><span class="section"><a href="#d0e10416">22.2.2. Previewing the Results</a></span></dt><dt><span class="section"><a href="#d0e10437">22.2.3. Writing a Custom Pixel Shader for Previewing the Results</a></span></dt><dt><span class="section"><a href="#d0e10451">22.2.4. Authoring a Post-Processing Effect in Python</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10539">22.3. Render Targets</a></span></dt><dt><span class="section"><a href="#d0e10572">22.4. Performance</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10577">22.4.1. Measuring the Time Spent on the GPU</a></span></dt><dt><span class="section"><a href="#d0e10590">22.4.2. Background Loading</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#xref_Job_System">23. Job System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10621">23.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e10632">23.2. Under the Hood</a></span></dt><dt><span class="section"><a href="#d0e10643">23.3. Wrapper API</a></span></dt><dt><span class="section"><a href="#d0e10670">23.4. Job System API</a></span></dt><dt><span class="section"><a href="#d0e10694">23.5. An Example</a></span></dt><dt><span class="section"><a href="#d0e10731">23.6. Implementing it</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Debugging">24. Debugging</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10791">24.1. Build configuration &#8212; conditional feature inclusion</a></span></dt><dt><span class="section"><a href="#xref_Watchers">24.2. Watchers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10818">24.2.1. Watcher types</a></span></dt><dt><span class="section"><a href="#d0e10829">24.2.2. Using watchers</a></span></dt><dt><span class="section"><a href="#d0e10844">24.2.3. Watcher Console</a></span></dt><dt><span class="section"><a href="#d0e10856">24.2.4. Remote watcher access</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10872">24.3. Memory tracking</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10877">24.3.1. ResourceCounters overview</a></span></dt><dt><span class="section"><a href="#d0e10899">24.3.2. Memory allocation taxonomy</a></span></dt><dt><span class="section"><a href="#d0e10930">24.3.3. Case studies</a></span></dt><dt><span class="section"><a href="#d0e11557">24.3.4. Displaying the memory tracking console</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11600">24.4. Scripts</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11607">24.4.1. Python Console</a></span></dt><dt><span class="section"><a href="#xref_Remote_Python_Console">24.4.2. Remote Python Console</a></span></dt><dt><span class="section"><a href="#d0e11876">24.4.3. Script reloading</a></span></dt><dt><span class="section"><a href="#d0e11891">24.4.4. Common errors</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11974">24.5. Script interactive debugging</a></span></dt><dt><span class="section"><a href="#xref_Client_Access_Tool_CAT">24.6. Client Access Tool (CAT)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12089">24.6.1. Connecting to the client</a></span></dt><dt><span class="section"><a href="#d0e12105">24.6.2. CAT Scripts</a></span></dt><dt><span class="section"><a href="#d0e12187">24.6.3. Creating scripts for CAT</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e12550">24.7. Timing</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Releasing_The_Game">25. Releasing The Game</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Limited_User_Accounts">25.1. Configure the engine for limited user accounts</a></span></dt><dt><span class="section"><a href="#xref_Prepare_The_Assets">25.2. Prepare the assets</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12639">25.2.1. <span class="literal">bin_convert</span></a></span></dt><dt><span class="section"><a href="#xref_Run_res_packer">25.2.2. <span class="literal">res_packer</span></a></span></dt><dt><span class="section"><a href="#d0e12948">25.2.3. Processing done in <span class="literal">bin_convert</span> and
      <span class="literal">res_packer</span></a></span></dt><dt><span class="section"><a href="#d0e13136">25.2.4. Files and folders that do not need to be shipped to the end
      user</a></span></dt><dt><span class="section"><a href="#d0e13211">25.2.5. Font Licensing issues with <span class="literal">bin_convert</span> and
      <span class="literal">res_packer</span></a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13227">25.3. Zip assets and specify paths</a></span></dt><dt><span class="section"><a href="#d0e13319">25.4. Prepare the game executable</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xref_Simplified_Server_Usage">26. Shared Development Environments</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Window_Linux_Cross_Platform_Development">26.1. Windows and Linux cross platform development</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Sharing_Resources_From_Windows">26.1.1. Sharing resources from Windows</a></span></dt><dt><span class="section"><a href="#d0e13570">26.1.2. Accessing Windows share from Linux</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13727">26.2. Using BigWorld with a Version Control System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13732">26.2.1. Customers using the Commercial Edition</a></span></dt><dt><span class="section"><a href="#d0e13741">26.2.2. Customers using the Indie Edition</a></span></dt><dt><span class="section"><a href="#xref_Version_Control_Exclusions">26.2.3. Files to exclude from version
      control</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13851">26.3. DBMgr database conflicts</a></span></dt></dl></dd></dl></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Overview"></a>Chapter&nbsp;1.&nbsp;Overview</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e34">1.1. Client in context</a></span></dt><dt><span class="section"><a href="#d0e63">1.2. Outline</a></span></dt><dt><span class="section"><a href="#xref_Resource_Search_Paths">1.3. Resource search paths</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e145">1.3.1. paths.xml</a></span></dt><dt><span class="section"><a href="#d0e170">1.3.2. Command line switch</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Configuration_Files">1.4. Configuration files</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_File_resources_xml">1.4.1. File <span class="literal">resources.xml</span></a></span></dt><dt><span class="section"><a href="#xref_File_engine_config_xml">1.4.2. File
      <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span></a></span></dt><dt><span class="section"><a href="#xref_File_scripts_config_xml">1.4.3. File
      <span class="literal"><em class="replaceable"><code>&lt;scripts_config&gt;</code></em>.xml</span></a></span></dt><dt><span class="section"><a href="#xref_File_preferences_xml">1.4.4. File
      <span class="literal"><em class="replaceable"><code>&lt;preferences&gt;</code></em>.xml</span></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Coordinate_system">1.5. Coordinate System</a></span></dt></dl></div><p>This document is a technical design overview for the Client Engine for
  3d engine Technology. It is part of a larger set of documentation describing
  the whole system. It only includes references to the BigWorld Server in
  order to provide context. Readers interested only in the workings of the
  BigWorld Client may ignore the server information.</p><p>The intended audience is technical-typically MMOG developers and
  designers.</p><p>For API-level information, please refer to the online
  documentation.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>For details on BigWorld terminology, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../glossary_of_terms/glossary_of_terms.html#Glossary_Of_Terms" class="olink">Glossary of Terms</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e34"></a>1.1.&nbsp;Client in context</h2></div></div></div><p>The BigWorld Client provides the end-user experience of the BigWorld
    client/server architecture. In a BigWorld client/server implementation,
    the client connects to the server using UDP/IP over the Internet.</p><p>The BigWorld Client presents the user with a realistic and immersive
    3D environment. The contents of that environment are a combination of
    static data stored with the client, and dynamic data sent from the server.
    The user interacts with the world through an avatar (character) that he or
    she controls. The movement and actions of that avatar are relayed to the
    server. The avatars controlled by other connected users are part of the
    dynamic data sent from the server.</p><div class="informalfigure"><div class="mediaobject"><img src="images/client_perspective_of_bigworld_system.png"><span class="caption"><p>Client perspective of BigWorld system. Note that the
        BigWorld server is not just one machine, although the client can treat
        it as such.</p></span></div></div><p>Developers may choose to integrate the client with their own server
    technology, but if they do, they will have to address problems already
    tackled by the BigWorld architecture, like:</p><div class="itemizedlist"><ul type="disc"><li><p>Uniform collision scene (used on client and server).</p></li><li><p>Uniform client/server scripting (used on client and
        server).</p></li><li><p>Tools that produce server and client content.</p></li><li><p>Optimised low bandwidth communication protocol.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e63"></a>1.2.&nbsp;Outline</h2></div></div></div><p>The client initialises itself, connects to the server, and then runs
    in its main thread a standard game loop (each iteration of which is known
    as a frame):</p><div class="itemizedlist"><ul type="disc"><li><p>Receive input</p></li><li><p>Update world</p></li><li><p>Draw world</p></li></ul></div><p>Each step of the frame is described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Input</em></p><p>Input is received from attached input devices using DirectInput.
        In a BigWorld client/server implementation, input is also received
        over the network from the server using WinSock 2.</p></li><li><p><em class="emphasis">Update</em></p><p>The world is updated to account for the time that has passed
        since the last update.</p></li><li><p><em class="emphasis">Draw</em></p><p>The world is drawn with the 3D engine Moo, which uses Direct3D
        (version 9c). For details, see <a href="#xref_3D_Engine" title="Chapter&nbsp;21.&nbsp;3D Engine (Moo)"><i xmlns:xlink="http://www.w3.org/1999/xlink">3D Engine (Moo)</i></a>.</p></li></ul></div><p>A number of other objects also fall into the world's 'update then
    draw' system. These include a dozen related to the weather and atmospheric
    effects (rain, stars, fog, clouds, etc.), various script assistance
    systems (targeting, combat), pools of water, footprints, and
    shadows.</p><p>There are other threads for background scene loading and other
    asynchronous tasks.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Resource_Search_Paths"></a>1.3.&nbsp;Resource search paths</h2></div></div></div><p>The BigWorld client is a generic executable that is fully
    configurable via the game specific resources. The location of these
    resources must be supplied to the client so that it can initialise
    correctly.</p><p>Typically, at least two resource paths need to be specified - your
    project specific resource path and the BigWorld resource path (which
    supplies common resources such as standard shaders, fonts, scripts, etc).
    For example, if your game was located in "my_game", the two resource paths
    you would define are:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="code">my_game/res</code></p></li><li><p><code class="code">bigworld/res</code></p></li></ul></div><p>When the engine tries to access a resource, it will look in each
    resource tree in the order that they are given to the engine. As an
    example, if the client scripts request the resource named
    <code class="code">sets/models/foo.model</code> it tries the following
    locations:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="code">my_game/res/sets/models/foo.model</code></p></li><li><p><code class="code">bigworld/res/sets/models/foo.model</code></p></li></ul></div><p>The search will stop at the first valid file found. As such, it is
    possible to override resources specified in <code class="code">bigworld/res</code> by
    placing it in the same location within <code class="code">my_game/res</code>.</p><p>There are two ways search paths can be specified:</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e145"></a>1.3.1.&nbsp;paths.xml</h3></div></div></div><p><code class="code">paths.xml</code> is an XML file which the engine will look
      for on startup and contains a list of resource paths. The client will
      first try to open <code class="code">paths.xml</code> in the current working
      directory. If it cannot be found in the current directory, then it will
      try to open <code class="code">paths.xml</code> in the same folder as the client
      executable. The schema of <code class="code">paths.xml</code> looks like this:</p><pre class="programlisting">&lt;root&gt;
    &lt;Paths&gt;
        &lt;Path&gt;../../my_game/res&lt;/Path&gt;
        &lt;Path&gt;../../bigworld/res&lt;/Path&gt;
    &lt;/Paths&gt;
&lt;/root&gt;
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Paths are defined relative to the location of
        <code class="code">paths.xml</code>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e170"></a>1.3.2.&nbsp;Command line switch</h3></div></div></div><p>By default the client will look for the <code class="code">paths.xml</code>
      illustrated above. However, this can be overridden via the command line
      using the <code class="code">--res</code> switch. Multiple paths are semi-colon
      separated. For example,</p><pre class="programlisting">"bwclient.exe" --res ../../../my_game/res;../../../bigworld/res</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>These paths must be defined relative to the executable location,
        <em class="emphasis">not </em>the current working directory.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Configuration_Files"></a>1.4.&nbsp;Configuration files</h2></div></div></div><p>Configuration files are defined relatively to one of the entries in
    the resources folders list (or
    <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span>). For details on
    how BigWorld compiles this list, see <a href="#xref_Resource_Search_Paths" title="1.3.&nbsp;Resource search paths">Resource search paths</a></p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_File_resources_xml"></a>1.4.1.&nbsp;File <span class="literal">resources.xml</span></h3></div></div></div><p>This file defines game-specific resources that are needed by the
      client engine to run.</p><p>The entries in resources.xml are read from the various entries in
      the resources folders list (or
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span>), in the order
      in which they are listed. Only missing entries will have their values
      read in subsequent folders.</p><p>A default file exists under folder bigworld/res, and any of its
      resources may be overridden by creating your own file
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/resources.xml</span>.</p><p>The example below illustrates this mechanism:</p><div class="informalfigure"><div class="mediaobject"><img src="images/precedence_of_your_games_resources_xml.png"><span class="caption"><p>Precedence of your game's
          <span class="literal">resources.xml</span> file over BigWorld's
          ones</p></span></div></div><p>For a complete list of the resources and values used by BigWorld,
      refer to the <span class="literal">resources.xml</span> file provided with the
      distribution.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_File_engine_config_xml"></a>1.4.2.&nbsp;File
      <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span></h3></div></div></div><p>The XML file
      <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span>
      lists several engine configuration options.</p><p>The actual name and location of this file is defined by the
      <code class="filename">resources.xml</code>'s
      <span class="literal">&lt;engineConfigXML&gt;</span> tag. The location of the
      <code class="filename">resources.xml</code> file is always defined relative to
      one of the entries in the resources directories list (or
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span>), which will
      be searched in the order in which they are listed.</p><p>An example follows below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/locating_engineconfigxmls_file.png"><span class="caption"><p>Locating <span class="literal">&lt;engineConfigXML&gt;</span>'s
          file</p></span></div></div><p>Under the main section of the XML file, a personality tag must be
      included, naming the personality script to use.</p><p>Several other tags are used by BigWorld to customize the way the
      client runs. For a complete list of the supported tags and a description
      of their functions, refer to the <span class="literal">engine_config.xml</span>
      file provided with the distribution. Additional information can also be
      found in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>.</p><p>The data contained in this file is passed to the personality
      script as the second argument to the <span class="literal">init</span> method (for
      details, see <a href="#xref_init" title="9.2.1.&nbsp;init"><span class="literal">init</span></a>), in the form of a
      <span class="literal">DataSection</span> object.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_File_scripts_config_xml"></a>1.4.3.&nbsp;File
      <span class="literal"><em class="replaceable"><code>&lt;scripts_config&gt;</code></em>.xml</span></h3></div></div></div><p>The XML file
      <span class="literal"><em class="replaceable"><code>&lt;scripts_config&gt;</code></em>.xml</span>
      can be used to configure the game scripts. It has no fixed grammar, and
      its form can be freely defined by the script programmer.</p><p>The actual name and location of this file is defined by the
      <span class="literal">resources.xml</span>'s <span class="literal">scriptsConfigXML</span>
      tag &#8212; its location is always defined relative to one of the entries in
      the resources folders list (or
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span>), which will
      be searched in the order in which they are listed.</p><div class="informalfigure"><div class="mediaobject"><img src="images/locating_scriptsconfigxmls_file.png"><span class="caption"><p>Locating <span class="literal">scriptsConfigXML</span>'s
          file</p></span></div></div><p>The data contained in this file is passed to the personality
      script as the first argument to the <span class="literal">init</span> method (for
      details, see <a href="#xref_init" title="9.2.1.&nbsp;init"><span class="literal">init</span></a>), in the form of a
      <span class="literal">DataSection</span> object.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_File_preferences_xml"></a>1.4.4.&nbsp;File
      <span class="literal"><em class="replaceable"><code>&lt;preferences&gt;</code></em>.xml</span></h3></div></div></div><p>The XML file
      <span class="literal"><em class="replaceable"><code>&lt;preferences&gt;</code></em>.xml</span> is
      used to save user preferences for video and graphics settings, with a
      pre-defined grammar.</p><p>The file also embeds a data section (called
      <span class="literal">scriptsPreference</span>) that can be used by scripts to
      persist game preferences &#8212; there is no fixed grammar for this
      section.</p><p>The actual name and location of this file is defined in file
      specified by <span class="literal">resources.xml</span>'s
      <span class="literal">engineConfigXML</span> tag, in the
      <span class="literal">preferences</span> tag.</p><div class="informalfigure"><div class="mediaobject"><img src="images/locating_engineconfigxmls_preferences_file.png"><span class="caption"><p>Locating <span class="literal">engineConfigXML</span>'s
          preferences' file</p></span></div></div><p>By default the preferences XML file is relative to the client
      executable location, but this can be changed to a number of other base
      paths by specifying a <code class="code">pathBase</code> subtag (e.g. it can be
      defined to be relative to the user's My Documents directory). The base
      path can be defined as an optional sub-tag of the preferences tag. The
      available path bases for &lt;preferences&gt;.xml are:</p><div class="itemizedlist"><ul type="disc"><li><p><code class="code">EXE_PATH</code> &#8212; The preferences XML file will be
          stored relative to the location of the client executable. This is
          the default location if none is supplied.</p></li><li><p><code class="code">CWD</code> &#8212; The preferences XML file will be stored
          relative to the current working directory. Note that if the working
          directory changes during runtime, it will save in the new working
          directory.</p></li><li><p><code class="code">APP_DATA</code> &#8212; The preferences XML file will be
          stored relative to the current user's AppData directory.</p></li><li><p><code class="code">MY_DOCS</code> &#8212; The preferences XML file will be stored
          relative to the current user's My Documents directory.</p></li><li><p><code class="code">RES_TREE</code> &#8212; The preferences XML file will be
          stored relative to the first resource path found in
          <code class="code">paths.xml</code>.</p></li></ul></div><p>The data contained in the <span class="literal">scriptsPreference</span> of
      this file is passed to the personality script as the third argument to
      the <span class="literal">init</span> method (for details, see <a href="#xref_init" title="9.2.1.&nbsp;init"><span class="literal">init</span></a>), in the form of a <span class="literal">DataSection</span>
      object.</p><p>The current user preferences can be saved back into the file
      (including changes to the <span class="literal">DataSection</span> that represents
      the script preferences) by calling
      <span class="literal">BigWorld.savePreferences</span>. For details, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a> .</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Coordinate_system"></a>1.5.&nbsp;Coordinate System</h2></div></div></div><p>BigWorld uses a left-handed coordinate system. The x-axis points
    <em class="emphasis">"left"</em>, the y-axis points <em class="emphasis">"up"</em>
    and the z-axis points <em class="emphasis">"forward"</em>.</p><p><em class="emphasis">yaw</em> is rotation around the y-axis. Positive is
    to the right, negative is to the left.</p><p><em class="emphasis">pitch</em> is rotation around the x-axis. Positive
    is nose pointing down, negative is nose pointing up.</p><p><em class="emphasis">roll</em> is rotation around the z-axis. Positive is
    to the left, negative is to the right.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_User_Input"></a>Chapter&nbsp;2.&nbsp;User Input</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Key_Events">2.1. Key events</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e481">2.1.1. Character events</a></span></dt><dt><span class="section"><a href="#d0e495">2.1.2. Auto-repeat</a></span></dt><dt><span class="section"><a href="#d0e505">2.1.3. Sequence of events</a></span></dt><dt><span class="section"><a href="#d0e554">2.1.4. Sinking events</a></span></dt><dt><span class="section"><a href="#d0e569">2.1.5. Mouse cursor position</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e580">2.2. Mouse</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e583">2.2.1. Movement</a></span></dt><dt><span class="section"><a href="#d0e621">2.2.2. Buttons</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e631">2.3. Joystick</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e636">2.3.1. Axis events</a></span></dt><dt><span class="section"><a href="#d0e647">2.3.2. Buttons</a></span></dt><dt><span class="section"><a href="#d0e657">2.3.3. Controlling player direction</a></span></dt><dt><span class="section"><a href="#d0e665">2.3.4. Avatar movement</a></span></dt></dl></dd></dl></div><p>The BigWorld client uses a combination of Windows messages and the
  Windows raw input API for keyboard and mouse input. It reads key-up,
  key-down, and character press events from the keyboard as well as high
  resolution movement events from the mouse. It uses the DirectInput API to
  read button and axis movement events from joysticks.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Key_Events"></a>2.1.&nbsp;Key events</h2></div></div></div><p>Key events, encapsulated by the KeyEvent object
    (<code class="code">BigWorld.KeyEvent</code> in Python), are generated by devices that
    have keys or buttons. This includes the keyboard, mouse buttons, and
    joystick buttons.</p><p>The two basic types of key events are key-down and key-up.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e481"></a>2.1.1.&nbsp;Character events</h3></div></div></div><p>If a KeyEvent is generated by the keyboard, it may have a
      character attached to it. The character generated by a particular key is
      determined by the currently set locale and input language in the
      operating system, and is represented by the
      <code class="code">KeyEvent.character</code> member (a Unicode string).</p><p>Dead character keys are supported (e.g. in Spanish, a user can
      type the letter &eacute; by first pressing the apostrophe key followed by the e
      key). In this case the first key press will not have a character
      associated with it, and the second key press will have the final
      character.</p><p>The BigWorld client supports advanced Input Method Editors (IME).
      See <a href="#xref_IME" title="Chapter&nbsp;18.&nbsp;Input Method Editors (IME)"><i xmlns:xlink="http://www.w3.org/1999/xlink">Input Method Editors (IME)</i></a> for details on using an IME in your
      game.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e495"></a>2.1.2.&nbsp;Auto-repeat</h3></div></div></div><p>The keyboard will generate auto-repeat events when keys are held
      down, based on the user's operating system settings (e.g. repeat delay).
      The mouse and joystick do not generate auto-repeat events.</p><p>Auto-repeat events are sent as additional key-down events, however
      scripts that do not want to handle repeat events can call the
      <code class="code">KeyEvent.isRepeatedEvent</code> method to determine whther or not
      it is an auto-repeat event.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e505"></a>2.1.3.&nbsp;Sequence of events</h3></div></div></div><p>When the user presses a button (keyboard, mouse or joystick), the
      sequence of events are:</p><div class="itemizedlist"><ul type="disc"><li><p>The first key-down event.</p></li><li><p>If the key is held down, multiple key-down events are raised
          due to auto-repeat (keyboard only).</p></li><li><p>A key-up event is triggered when the user releases the
          button.</p></li></ul></div><p>The output from the user input module is processed by a number of
      other modules, which take it in turn to examine events and either
      consume or ignore them. If an event is not consumed by any module then
      it is discarded. The order of modules that get a turn at the events is
      as follows:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Debug</em> &#8212; Special keys,
          consoles, etc.</p></li><li><p><em class="emphasis">Personality script</em> &#8212;
          Global keys.</p></li><li><p><em class="emphasis">Application</em> &#8212;
          Hard-coded keys such as <span class="literal">QUIT</span>.</p></li><li><p><em class="emphasis">Player script</em> &#8212; The
          rest, which is the major part of the processing.</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Note that the GUI system does not automatically receive input,
        instead it is up to the script write to choose when. This could be
        either in the personality script, or in the player script. The most
        obvious place is in the personality script callbacks, for example in
        the personality script's handleKeyEvent, you should call
        <code class="code">GUI.handleKeyEvent()</code> and check the return value.</p><p>Similarly, the active camera also does not automatically receive
        input events. It is up to the Python scripts to decide when and where
        the camera receives user input.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e554"></a>2.1.4.&nbsp;Sinking events</h3></div></div></div><p>The BigWorld client performs event matching to ensure consistent
      module behaviour. If a key-down event is consumed by a module, that
      module's identifier is recorded as the sink of the event's key number.
      When the corresponding auto-repeat and key-up event arrives, it is
      delivered directly to that module. For example, if a chat console is
      brought up (and inserted into the list) while the player is running, and
      the user subsequently releases the run key, then the player script will
      still get the key-up event for that key, and be able to stop the run
      action.</p><p>In some cases it may be desired to temporarily block certain key
      events from being passed into the scripts. For example, the GUI scripts
      may handle a key down event by removing the current GUI screen and
      replacing it with a new GUI screen. By default, since the new GUI screen
      has become the active screen by the time <code class="code">handleKeyEvent</code>
      returns, any associated auto-repeat and key-up events will be posted to
      the new GUI screen creating possibly unwanted behaviour.</p><p>The <code class="code">BigWorld.sinkKeyEvents</code> function can be used to
      stop all key events for the given key-code from reaching the scripts
      until (and including) the next key-up. See the Python API guide for
      details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e569"></a>2.1.5.&nbsp;Mouse cursor position</h3></div></div></div><p>It is often a requirement to know where the mouse was when a key
      event occured (i.e. rather than where the mouse is at the time of
      handling the event), especially when processing mouse button events.
      Therefore, the mouse cursor position is available via the
      <code class="code">KeyEvent.cursorPosition</code> property, and should be used
      instead of <code class="code">GUI.mcursor().position</code> where ever
      possible.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e580"></a>2.2.&nbsp;Mouse</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e583"></a>2.2.1.&nbsp;Movement</h3></div></div></div><p>High resolution mouse movement events are sent to the scripts as a
      <code class="code">MouseEvent</code>. This object exposes three direction
      deltas.</p><div class="itemizedlist"><ul type="disc"><li><p>The <code class="code">dx</code> and <code class="code">dy</code> members are signed
          integers indicating movement of the mouse in the X and Y
          directions.</p></li><li><p>The <code class="code">dz</code> member represents movement of the mouse
          wheel. </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>If multiple mouse deltas arrive from the driver within a
              single frame, they are accumulated into a single
              <code class="code">MouseEvent</code>.</p></div></li></ul></div><p>Similar to the <code class="code">KeyEvent</code> object, the mouse cursor
      position for when the event occured is available as a member of the
      <code class="code">MouseEvent</code> object.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e621"></a>2.2.2.&nbsp;Buttons</h3></div></div></div><p>Mouse buttons are sent as a <code class="code">KeyEvent</code>, however they do
      not generate auto-repeat events. See <a href="#xref_Key_Events" title="2.1.&nbsp;Key events">Key events</a>
      for details.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e631"></a>2.3.&nbsp;Joystick</h2></div></div></div><p>The BigWorld client will automatically detect the first joystick
    device attached to the system, and is been designed to be used with
    dual-stick style joypads.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e636"></a>2.3.1.&nbsp;Axis events</h3></div></div></div><p>When axis events occur, they will be sent to the scripts as an
      <code class="code">AxisEvent</code> object via the <code class="code">handleAxisEvent</code>
      personality script function.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e647"></a>2.3.2.&nbsp;Buttons</h3></div></div></div><p>Joystick buttons are sent as a <code class="code">KeyEvent</code>, however they
      do not generate auto-repeat events. See <a href="#xref_Key_Events" title="2.1.&nbsp;Key events">Key events</a> for details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e657"></a>2.3.3.&nbsp;Controlling player direction</h3></div></div></div><p>The C++ engine will automatically pass axis events to the active
      cursor, so the direction cursor can be joystick controlled by setting it
      as the active cursor using <code class="code">BigWorld.setCursor</code>. The
      direction cursor will process any events generated by the right
      axis.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e665"></a>2.3.4.&nbsp;Avatar movement</h3></div></div></div><p>The C++ engine will also give the physics subsystem a chance to
      handle axis events. The physics treats axis input as a special case and
      will scale movement speed by how far the user as pushed the joystick
      forward.</p><p>In order to enable joystick support on movement physics, set the
      <code class="code">Physics.joystickEnabled</code> property to True and be sure to set
      <code class="code">joystickFwdSpeed</code> and <code class="code">joystickBackSpeed</code>
      properties to values appropriate for your game.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Cameras"></a>Chapter&nbsp;3.&nbsp;Cameras</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e709">3.1. The Cursor Camera</a></span></dt><dt><span class="section"><a href="#d0e720">3.2. The Free Camera</a></span></dt><dt><span class="section"><a href="#d0e725">3.3. The FlexiCam</a></span></dt></dl></div><p>The placement of the camera update within the general update process
  is a delicate matter, because the camera depends on some components having
  been updated before it, whilst other components depend on the camera being
  updated before them.</p><p>Conceptually, there are four types of camera: fixed camera, FlexiCam,
  cursor camera, and free camera. The first three are client-controlled views,
  ranging from minimum user interaction to maximum user interaction. The last
  camera is completely user-controlled, but is not part of actual game
  play.</p><p>There are however just three camera classes:
  <code class="classname">FlexiCam</code>, <code class="classname">CursorCamera</code>, and
  <code class="classname">FreeCamera</code>. The fixed camera is implemented with a
  <code class="classname">FlexiCam</code> object. They all derive from a common
  <code class="classname">BaseCamera</code> class.</p><p>There is only ever one active camera at a time. The personality script
  usually handles camera management, since the camera is a global, but any
  script can also manipulate the camera, and the player script often does
  (although usually indirectly, through the personality script)</p><p>The base class and all the derived classes are fully accessible to
  Python. Any camera can be created and set to whatever position a script
  desires, including to the position of another camera. This is particularly
  useful when switching camera types to remove any unwanted
  'jump-cuts'.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e709"></a>3.1.&nbsp;The Cursor Camera</h2></div></div></div><p>The cursor camera is a camera that follows the character in the game
    world. It always positions itself on a sphere centred on the character's
    head. It works primarily with the direction cursor so as to face the
    camera in the direction of the character's head. You may use any
    MatrixProvider in place of the direction cursor, and you may use any
    MatrixProvider in place of the player's head.</p><p>The direction cursor is an input handler that translates device
    input from the user into the manipulation of an imaginary cursor that
    travels on an invisible sphere. This cursor is described by its pitch and
    yaw. It produces a pointing vector extending from the head position of the
    player's avatar in world space, in the direction of the cursor's pitch and
    yaw. The direction cursor is a useful tool to allow a targeting method
    across different devices. Rather than have each device affect the camera
    and character mesh, each device talks to the direction cursor, affecting
    its look-at vector in the world. The cursor camera, target tracker, and
    action matcher then read the direction cursor for information on what
    needs to be done.</p><p>The cursor camera takes the position of the direction cursor on the
    sphere, extends the line back towards the character's head, and follows
    that line until it intersects with the sphere on the other side. This
    intersection point is the cursor camera's position. The direction of the
    camera is always that of the direction cursor.</p><p>The cursor camera is an instance of the abstract concept
    InputCursor. There can be only one active InputCursor at any time, and
    BigWorld automatically forwards keyboard, joystick, and mouse events to
    it. Upon startup, the cursor camera is the active InputCursor by default.
    You can change the active InputCursor at any time, using the method
    BigWorld.setCursor (for example to change the InputCursor to be a mouse
    pointer instead).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e720"></a>3.2.&nbsp;The Free Camera</h2></div></div></div><p>The Free Camera is a free roaming camera that is neither tied to a
    fixed point in space nor following the player's avatar. It is controlled
    by the mouse (for direction) and keyboard (for movement), and allows the
    user to fly about the world. The free camera has inertia in order to
    provide smooth, gradual transitions in movement. It is not a gameplay
    camera, but is useful for debugging, development, and demonstration of the
    game.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e725"></a>3.3.&nbsp;The FlexiCam</h2></div></div></div><p>The FlexiCam is a flexible camera that follows the character in the
    game world. It always positions itself at a specified point, relative to
    the character orientation, and always looks at a specified orientation,
    relative to the character's feet direction.</p><p>It is called FlexiCam because it has a certain amount of elasticity
    to its movement, allowing the sensation of speed to be visualised. This
    makes it especially useful for chasing vehicles.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Terrain"></a>Chapter&nbsp;4.&nbsp;Terrain</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e737">4.1. Advanced Terrain</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e740">4.1.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e745">4.1.2. Key Features</a></span></dt><dt><span class="section"><a href="#d0e780">4.1.3. Texturing</a></span></dt><dt><span class="section"><a href="#d0e788">4.1.4. Lighting</a></span></dt><dt><span class="section"><a href="#d0e794">4.1.5. Shadows</a></span></dt><dt><span class="section"><a href="#d0e802">4.1.6. LOD</a></span></dt><dt><span class="section"><a href="#d0e838">4.1.7. Memory footprint</a></span></dt><dt><span class="section"><a href="#xref_terrain2_section">4.1.8. <span class="literal">terrain2</span> resources</a></span></dt><dt><span class="section"><a href="#xref_Space_terrain_section">4.1.9. <span class="literal">terrain</span> section in
      <span class="literal">space.settings</span></a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1702">4.2. Simple Terrain</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1705">4.2.1. Key features</a></span></dt><dt><span class="section"><a href="#d0e1739">4.2.2. Overview</a></span></dt><dt><span class="section"><a href="#d0e1747">4.2.3. Chunking</a></span></dt><dt><span class="section"><a href="#d0e1752">4.2.4. Disk footprint</a></span></dt><dt><span class="section"><a href="#d0e1825">4.2.5. Memory footprint</a></span></dt><dt><span class="section"><a href="#d0e1832">4.2.6. Texture spacing</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_TerrainSpecular">4.3. Terrain specular lighting</a></span></dt></dl></div><p>The terrain system employed by the BigWorld client integrates neatly
  with the chunking system. It allows a wide variety of terrains to be created
  in an artistic manner and managed efficiently. There are two different
  terrain renderers available that target different machine specifications.
  They are called Advanced Terrain and Simple Terrain.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e737"></a>4.1.&nbsp;Advanced Terrain</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e740"></a>4.1.1.&nbsp;Overview</h3></div></div></div><p>The advanced terrain engine uses a height map split up into blocks
      of 100 by 100 metres. Each block consists of height and texture
      information, normals, a hole map and LOD information.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e745"></a>4.1.2.&nbsp;Key Features</h3></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Configurable height map resolution</p></li><li><p>Unlimited number of texture levels with configurable blend
          resolution and projection angles</p></li><li><p>Configurable normal map resolution</p></li><li><p>Configurable hole map resolution</p></li><li><p>Per pixel lighting</p></li><li><p>LOD System</p><div class="itemizedlist"><ul type="circle"><li><p>Geo mip-mapping with geo-morphing</p></li><li><p>Normal map LOD</p></li><li><p>Texture LOD</p></li><li><p>Height map LOD</p></li></ul></div></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e780"></a>4.1.3.&nbsp;Texturing</h3></div></div></div><p>Texturing is done by blending multiple textures layers together,
      each texture layer has its own projection angle and blend values for
      blending with other texture layers. The resolution of the blend values
      is configurable per space and the layers themselves are stored per
      chunk. The textures are assumed to be <em class="emphasis">rgba</em> with the
      alpha channel used for the specular value.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e788"></a>4.1.4.&nbsp;Lighting</h3></div></div></div><p>The lighting of the advanced terrain is performed per pixel. A
      normal map is stored per block, which is used in the lighting
      calculations, this is combined with the blended texture to output the
      final colour. The terrain allows up to 8 diffuse and 6 specular lights
      per block. For details of how the specular lighting is calculated see
      <a href="#xref_TerrainSpecular" title="4.3.&nbsp;Terrain specular lighting">Terrain specular lighting</a></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e794"></a>4.1.5.&nbsp;Shadows</h3></div></div></div><p>The terrain uses a <em class="emphasis">horizon shadow map</em> for
      shadowing, this map stores two angles (east-west) between which there is
      an unobstructed view of the sky from the terrain. In the terrain shader,
      these angles are checked against the sun angle and the sun light is only
      applied if the sun angle falls between the horizon angles.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e802"></a>4.1.6.&nbsp;LOD</h3></div></div></div><p>The purpose of the LOD system is to reduce the amount of cpu and
      gpu time spent rendering terrain and to reduce the memory footprint of
      the terrain. The terrain LOD system achieves this by reducing geometric
      and texture detail in the distance and loading/unloading high resolution
      resources as they are needed. The LODing is broken up by resource so
      that texture and geometric detail can be streamed separately. The LOD
      distances are configurable in the space.settings file, please see <a href="#xref_Space_terrain_section" title="4.1.9.&nbsp;terrain section in space.settings"><span class="literal">terrain</span> section in
      <span class="literal">space.settings</span></a> for more information.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e809"></a>4.1.6.1.&nbsp;Geometry</h4></div></div></div><p>Geometry LOD is achieved by using <span class="literal">geo-mipmaps</span>
        and <span class="literal">geo-morphing</span>. <span class="literal">Geo-mipmaps</span>
        are generated from the high resolution normal map for the terrain
        block. Depending on the x/z distance from the camera a lower
        resolution version of the terrain block is displayed. To avoid popping
        when changing between the different resolutions of the height map,
        geo-morphing is used, this allows the engine to smoothly interpolate
        between two height map levels. Degenerate triangles are inserted
        between blocks of differing sizes to avoid sparkles.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e823"></a>4.1.6.2.&nbsp;Collision Geometry</h4></div></div></div><p>Collision geometry is streamed in using two distinct
        resolutions. The low resolution collisions are always available,
        whereas the higher resolution collisions are streamed in depending on
        their x-z distance from the camera.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e828"></a>4.1.6.3.&nbsp;Texture</h4></div></div></div><p>Texture LOD is performed by substituting the multi-layer
        blending with a single top-down image of the terrain block. The LOD
        image is smoothly blended in based on the x-z distance from the
        camera. The top-down image is generated in the World Editor.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e833"></a>4.1.6.4.&nbsp;Normal maps</h4></div></div></div><p>Normal map LOD is performed by using low-resolution and high
        resolution maps. The low resolution normal map is always available and
        the high resolution map is streamed in and blended based on the x-z
        distance from the camera. The normal maps are generated in the World
        Editor. The size of the LOD normal map is a 16th of the resolution of
        the normal map or 32x32 whichever value is larger.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e838"></a>4.1.7.&nbsp;Memory footprint</h3></div></div></div><p>Since the advanced terrain allows for a number of configuration
      options the memory footprint of the terrain depends on the options
      selected.</p><p>In the Fantasydemo example provided, the terrain overhead is as
      follows (this information was captured using the resource counters in
      the Fantasydemo client, the graphics settings were set to high and the
      far plane was set to 1500 metres):</p><p>(<em class="emphasis">this includes the textures used by the texture layers,
      which may also be used by other assets</em>)</p><div class="altrow"><table border="0" width="50%"><colgroup><col width="64%"><col width="36%"></colgroup><thead><tr><th>Component</th><th>Size</th></tr></thead><tbody><tr><td>Collision data</td><td>42,453,517</td></tr><tr><td>Vertex buffers</td><td>6,169,008</td></tr><tr><td>Index buffers</td><td>536,352</td></tr><tr><td>Texture layers</td><td>57,541,905</td></tr><tr><td>Shadow maps</td><td>26,361,856</td></tr><tr><td>LOD textures</td><td>35,148,605</td></tr><tr><td>Hole maps</td><td>4,096</td></tr><tr><td>Normal maps</td><td>6,572,032</td></tr><tr><td><em class="emphasis">Total</em></td><td><em class="emphasis">174,787,371</em></td></tr></tbody></table></div><p> <span class="citetitle">Terrain memory usage</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_terrain2_section"></a>4.1.8.&nbsp;<span class="literal">terrain2</span> resources</h3></div></div></div><p>A <span class="literal">terrain2</span> section is contained in a chunk's
  <span class="literal">.cdata</span> file. It contains all the resources for the
  terrain in a chunk. The different types of terrain data are described in
  <span class="literal">BNF</span> format in the following chapter.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e930"></a>4.1.8.1.&nbsp;<span class="literal">heights</span> sections</h4></div></div></div><p>The <span class="literal">heights</span> sections stores the height map for
    the terrain block. Multiple <span class="literal">heights</span> sections are stored
    in the block, one for each LOD level, each <span class="literal">heights</span>
    section stores data at half the resolution of the previous one. The
    <span class="literal">heights</span> sections are named as "
    <span class="literal">heights?</span> " where <span class="literal">?</span> is replaced by a
    number. The highest res height map is stored in a section named heights
    the second highest in a section called heights1 all the way down to a map
    that stores 2x2 heights. This way if the height map resolution is 128x128,
    7 height maps are stored in the file (heights, heights1, ...
    heights6)</p><pre class="programlisting">&lt;heightMap&gt; ::= &lt;header&gt;&lt;<em class="emphasis">heightData</em>&gt;
&lt;header&gt; ::= &lt;<em class="emphasis">magic</em>&gt;&lt;<em class="emphasis">width</em>&gt;&lt;<em class="emphasis">height</em>&gt;&lt;<em class="emphasis">compression</em>&gt;&lt;<em class="emphasis">version</em>&gt;&lt;<em class="emphasis">minHeight</em>&gt;&lt;<em class="emphasis">maxHeight</em>&gt;&lt;<em class="emphasis">padding</em>&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;magic&gt;</span></em></p><p>uint32 <span class="literal">0x00706d68</span> (string "hmp\0")</p></li><li><p><em class="emphasis"><span class="literal">&lt;width&gt;</span></em></p><p>uint32 containing the width of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;height&gt;</span></em></p><p>uint32 containing the height of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;compression&gt;</span></em></p><p>(unused) uint32 containing the compression type</p></li><li><p><em class="emphasis"><span class="literal">&lt;version&gt;</span></em></p><p>uint32 containing the version of the data, currently 4</p></li><li><p><em class="emphasis"><span class="literal">&lt;minHeight&gt;</span></em></p><p>float containing the minimum height of this block</p></li><li><p><em class="emphasis"><span class="literal">&lt;maxHeight&gt;</span></em></p><p>float containing the maximum height of this block</p></li><li><p><em class="emphasis"><span class="literal">&lt;padding&gt;</span></em></p><p>4 bytes of padding to make the header 16-byte aligned</p></li><li><p><em class="emphasis"><span class="literal">&lt;heightData&gt;</span></em></p><p>PNG compressed block of int32 storing the height in millimetres,
        dimensions = width * height from the header</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e1051"></a>4.1.8.2.&nbsp;<span class="literal">layer</span> sections</h4></div></div></div><p>The <span class="literal">layer</span> sections store the texture layers for
    the terrain block. Multiple <span class="literal">layer</span> sections are stored
    in the terrain block. Each section describes one texture layer. The
    <span class="literal">layer</span> sections are named " <span class="literal">layer ?</span> "
    where <span class="literal">?</span> is replaced by a number greater than 1. I.e if
    the block has 3 layers, three layer sections will be stored ("layer 1",
    "layer 2", "layer 3")</p><pre class="programlisting">&lt;textureLayer&gt; ::= &lt;header&gt;&lt;textureName&gt;&lt;<em class="emphasis">blendData</em>&gt;
&lt;header&gt; ::= &lt;<em class="emphasis">magic</em>&gt;&lt;<em class="emphasis">width</em>&gt;&lt;<em class="emphasis">height</em>&gt;&lt;<em class="emphasis">bpp</em>&gt;&lt;<em class="emphasis">uProjection</em>&gt;&lt;<em class="emphasis">vProjection</em>&gt;&lt;<em class="emphasis">version</em>&gt;&lt;<em class="emphasis">padding</em>&gt;
&lt;textureName&gt; ::= &lt;<em class="emphasis">length</em>&gt;&lt;<em class="emphasis">string</em>&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;magic&gt;</span></em></p><p>uint32 0x00646c62 (string bld/0")</p></li><li><p><em class="emphasis"><span class="literal">&lt;width&gt;</span></em></p><p>uint32 containing the width of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;height&gt;</span></em></p><p>uint32 containing the height of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;bpp&gt;</span></em></p><p>(unused) uint32 containing the size of the entries in the layer
        data</p></li><li><p><em class="emphasis"><span class="literal">&lt;uProjection&gt;</span></em></p><p>Vector4 containing the projection of the u coordinate of the
        texture layer</p></li><li><p><em class="emphasis"><span class="literal">&lt;vProjection&gt;</span></em></p><p>Vector4 containing the projection of the v coordinate of the
        texture layer</p></li><li><p><em class="emphasis"><span class="literal">&lt;version&gt;</span></em></p><p>uint32 containing the version of the data, currently 2</p></li><li><p><em class="emphasis"><span class="literal">&lt;padding&gt;</span></em></p><p>12 bytes of padding to make the header 16-byte aligned</p></li><li><p><em class="emphasis"><span class="literal">&lt;length&gt;</span></em></p><p>the length of the texturename string</p></li><li><p><em class="emphasis"><span class="literal">&lt;string&gt;</span></em></p><p>the name of the texture used by this layer</p></li><li><p><em class="emphasis"><span class="literal">&lt;blendData&gt;</span></em></p><p>png compressed block of uint8 defining the strength of this
        texture layer at each x/z position</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e1186"></a>4.1.8.3.&nbsp;<span class="literal">normals</span> &amp; <span class="literal">lodNormals</span>
    sections</h4></div></div></div><p>The <span class="literal">normals</span> section stores the high resolution
    normal map for the terrain block. The <span class="literal">lodNormals</span>
    section stores the LOD normals for the height block, the LOD normals are
    generally 1/16th of the size of the normals.</p><pre class="programlisting">&lt;normals&gt; ::= &lt;header&gt;&lt;<em class="emphasis">data</em>&gt;
&lt;header&gt; ::= &lt;<em class="emphasis">magic</em>&gt;&lt;<em class="emphasis">version</em>&gt;&lt;<em class="emphasis">padding</em>&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;magic&gt;</span></em></p><p>uint32 0x006d726e (string "nrm/0")</p></li><li><p><em class="emphasis"><span class="literal">&lt;version&gt;</span></em></p><p>uint32 containing the version of the data, currently 1</p></li><li><p><em class="emphasis"><span class="literal">&lt;padding&gt;</span></em></p><p>8 bytes of padding to make the header 16-byte aligned</p></li><li><p><em class="emphasis"><span class="literal">&lt;data&gt;</span></em></p><p>png compressed block storing 2 signed bytes per entry for the x
        and z components of the normal the y component is calculate in the
        shader</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e1245"></a>4.1.8.4.&nbsp;<span class="literal">holes</span> section</h4></div></div></div><p>The <span class="literal">holes</span> section stores the holemap for the
    terrain block, this section is only stored when a terrain block has holes
    in it.</p><pre class="programlisting">&lt;holes&gt; ::= &lt;header&gt;&lt;<em class="emphasis">data</em>&gt;
&lt;header&gt; ::= &lt;<em class="emphasis">magic</em>&gt;&lt;<em class="emphasis">width</em>&gt;&lt;<em class="emphasis">height</em>&gt;&lt;<em class="emphasis">version</em>&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;magic&gt;</span></em></p><p>uint32 0x006c6f68 (string "hol/0")</p></li><li><p><em class="emphasis"><span class="literal">&lt;width&gt;</span></em></p><p>uint32 containing the width of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;height&gt;</span></em></p><p>uint32 containing the height of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;version&gt;</span></em></p><p>uint32 containing the version of the data, currently 1</p></li><li><p><em class="emphasis"><span class="literal">&lt;data&gt;</span></em></p><p>The hole data stored in a bit field of width * height, each row
        in the data is rounded up to 1 byte. If a bit is set to 1 it denotes a
        hole in the map.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e1308"></a>4.1.8.5.&nbsp;<span class="literal">horizonShadows</span> section</h4></div></div></div><p>The <span class="literal">horizonShadows</span> section stores the horizon
    shadows for the terrain block.</p><pre class="programlisting">&lt;shadows&gt; ::= &lt;header&gt;&lt;<em class="emphasis">data</em>&gt;
&lt;header&gt; ::= &lt;<em class="emphasis">magic</em>&gt;&lt;<em class="emphasis">width</em>&gt;&lt;<em class="emphasis">height</em>&gt;&lt;<em class="emphasis">bpp</em>&gt;&lt;<em class="emphasis">version</em>&gt;&lt;<em class="emphasis">padding</em>&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;magic&gt;</span></em></p><p>uint32 0x00646873 (string "shd/0")</p></li><li><p><em class="emphasis"><span class="literal">&lt;width&gt;</span></em></p><p>uint32 containing the width of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;height&gt;</span></em></p><p>uint32 containing the height of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;bpp&gt;</span></em></p><p>(unused)uint32 containing the bits per entry in the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;version&gt;</span></em></p><p>uint32 containing the version of the data, currently 1</p></li><li><p><em class="emphasis"><span class="literal">&lt;padding&gt;</span></em></p><p>12 bytes of padding to make the header 16-byte aligned</p></li><li><p><em class="emphasis"><span class="literal">&lt;data&gt;</span></em></p><p>The shadow data, (uint16,uint16) * width * height, the horizon
        shadow data stores two angles between which there is no occlusion from
        any terrain or objects.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e1391"></a>4.1.8.6.&nbsp;<span class="literal">lodTexture.dds</span> section</h4></div></div></div><p>The <span class="literal">lodTexture.dds</span> section stores the LOD
    texture for the terrain block. The LOD texture is a low resolution
    snapshot of all the texture layers blended together. The texture is stored
    in the DXT5 format. For more information about the dds texture format
    please refer to the DirectX documentation.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e1401"></a>4.1.8.7.&nbsp;<span class="literal">dominantTextures</span> section</h4></div></div></div><p>The <span class="literal">dominantTextures</span> section stores the dominant
    texture map. The dominant texture map stores the texture with the highest
    blend for each x/z location in the terrain block.</p><pre class="programlisting">&lt;dominant&gt; ::=&lt;header&gt;&lt;<em class="emphasis">texNames</em>&gt;&lt;<em class="emphasis">data</em>&gt;
&lt;header&gt; ::= &lt;<em class="emphasis">magic</em>&gt;&lt;<em class="emphasis">version</em>&gt;&lt;<em class="emphasis">numTextures</em>&gt;&lt;<em class="emphasis">texNameSize</em>&gt;&lt;<em class="emphasis">width</em>&gt;&lt;<em class="emphasis">height</em>&gt;&lt;<em class="emphasis">padding</em>&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;magic&gt;</span></em></p><p>uint32 0x0074616d (string "mat/0")</p></li><li><p><em class="emphasis"><span class="literal">&lt;version&gt;</span></em></p><p>uint32 containing the version of the data, currently 1</p></li><li><p><em class="emphasis"><span class="literal">&lt;numTextures&gt;</span></em></p><p>uint32 containing the number of textures referenced by the
        dominant texture map</p></li><li><p><em class="emphasis"><span class="literal">&lt;texNameSize&gt;</span></em></p><p>uint32 containing the size of the texture entries</p></li><li><p><em class="emphasis"><span class="literal">&lt;width&gt;</span></em></p><p>uint32 containing the width of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;height&gt;</span></em></p><p>uint32 containing the height of the data</p></li><li><p><em class="emphasis"><span class="literal">&lt;padding&gt;</span></em></p><p>8 bytes of padding to make the header 16-byte aligned</p></li><li><p><em class="emphasis"><span class="literal">&lt;texNames&gt;</span></em></p><p><span class="literal">numTextures</span> entries of
        <span class="literal">texNameSize</span> size containing the names of the
        dominant textures referred to in this map. Texture names shorter than
        <span class="literal">texNameSize</span> are padded with
        <span class="literal">0</span></p></li><li><p><em class="emphasis"><span class="literal">&lt;data&gt;</span></em></p><p>stored as a compressed bin section. byte array of width *
        height, each entry is an index into the texture names which indexes
        the dominant texture at the x/z location of the entry</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Space_terrain_section"></a>4.1.9.&nbsp;<span class="literal">terrain</span> section in
      <span class="literal">space.settings</span></h3></div></div></div><p>The terrain section in the <span class="literal">space.settings</span> file
      contains the configuration options for the terrain. The values in the
      <span class="literal">lodInfo</span> and <span class="literal">server</span> sections can be
      modified, but the root level values should only be modified by the World
      Editor.</p><pre class="programlisting">    &lt;version&gt; 200 (int) &lt;/version&gt;
    &lt;heightMapSize&gt; uint &lt;/heightMapSize&gt;
    &lt;normalMapSize&gt; uint &lt;/normalMapSize&gt;
    &lt;holeMapSize&gt; uint &lt;/holeMapSize&gt;
    &lt;shadowMapSize&gt; uint &lt;/shadowMapSize&gt;
    &lt;blendMapSize&gt; uint &lt;/blendMapSize&gt;
    &lt;lodInfo&gt;
      &lt;startBias&gt; float &lt;/startBias&gt;
      &lt;endBias&gt; float &lt;/endBias&gt;
      &lt;lodTextureStart&gt; float &lt;/lodTextureStart&gt;
      &lt;lodTextureDistance&gt; float &lt;/lodTextureDistance&gt;
      &lt;blendPreloadDistance&gt; float &lt;/blendPreloadDistance&gt;
      &lt;lodNormalStart&gt; float &lt;/lodNormalStart&gt;
      &lt;lodNormalDistance&gt; float &lt;/lodNormalDistance&gt;
      &lt;normalPreloadDistance&gt; float &lt;/normalPreloadDistance&gt;
      &lt;defaultHeightMapLod&gt; uint &lt;/defaultHeightMapLod&gt;
      &lt;detailHeightMapDistance&gt; float &lt;/detailHeightMapDistance&gt;
      &lt;lodDistances&gt;
        +&lt;distance?&gt; float &lt;/distance?&gt;
      &lt;/lodDistances&gt;
      &lt;server&gt;
        &lt;heightMapLod&gt; uint &lt;/heightMapLod&gt;
      &lt;/server&gt;
    &lt;/lodInfo&gt;    </pre><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;version&gt;</span></em></p><p>The version of the terrain, this value is
          <span class="literal">200</span> for advanced terrain</p></li><li><p><em class="emphasis"><span class="literal">&lt;heightMapSize&gt;</span></em></p><p>The size of the height map per terrain block, this value is a
          power of 2 between 4 and 256</p></li><li><p><em class="emphasis"><span class="literal">&lt;normalMapSize&gt;</span></em></p><p>The size of the normal map per terrain block, this value is a
          power of 2 between 32 and 256</p></li><li><p><em class="emphasis"><span class="literal">&lt;holeMapSize&gt;</span></em></p><p>The size of the hole map per terrain block, this can be any
          value up to 256</p></li><li><p><em class="emphasis"><span class="literal">&lt;shadowMapSize&gt;</span></em></p><p>The size of the shadow map per terrain block, this value is a
          power of 2 between 32 and 256</p></li><li><p><em class="emphasis"><span class="literal">&lt;blendMapSize&gt;</span></em></p><p>The size of the blend maps per terrain block, this value is a
          power of 2 between 32 and 256</p></li><li><p><em class="emphasis"><span class="literal">&lt;lodInfo&gt;</span></em></p><p>This section contains the configurations for the terrain LOD
          system</p></li><li><p><em class="emphasis"><span class="literal">&lt;startBias&gt;</span></em></p><p>This value is the bias value for the start of geo-morphing,
          this value defines where a LOD level starts fading out to the next
          one. This value is a factor of the difference between two
          lodDistances.</p></li><li><p><em class="emphasis"><span class="literal">&lt;endBias&gt;</span></em></p><p>This value is the bias value for the end of geo-morphing, this
          value defines where a LOD level has fully faded out to the next one.
          This value is a factor of the difference between two
          lodDistances.</p></li><li><p><em class="emphasis"><span class="literal">&lt;lodTextureStart&gt;</span></em></p><p>This is the start distance for blending in the LOD texture, up
          until this distance, the blended layers are used for rendering the
          terrain.</p></li><li><p><em class="emphasis"><span class="literal">&lt;lodTextureDistance&gt;</span></em></p><p>This is the distance the lodtexture is blended in over, this
          value relative to <span class="literal">lodTextureStart.</span></p></li><li><p><em class="emphasis"><span class="literal">&lt;blendPreloadDistance&gt;</span></em></p><p>This is the distance at which the blends are preloaded, this
          value is relative to lodTextureDistance and lodTextureStart</p></li><li><p><em class="emphasis"><span class="literal">&lt;lodNormalStart&gt;</span></em></p><p>This is the start distance for blending in the LOD
          normals</p></li><li><p><em class="emphasis"><span class="literal">&lt;lodNormalDistance&gt;</span></em></p><p>This is the distance the full normal map is blended in over,
          this value relative to <span class="literal">lodNormalStart.</span></p></li><li><p><em class="emphasis"><span class="literal">&lt;normalPreloadDistance&gt;</span></em></p><p>This is the distance at which the full normal maps are
          preloaded. This value is relative to
          <span class="literal">lodNormalStart</span> and
          <span class="literal">lodNormalDistance</span></p></li><li><p><em class="emphasis"><span class="literal">&lt;defaultHeightMapLod&gt;</span></em></p><p>This is the default LOD level of height map to load, 0 = the
          full height map, 1 = half resolution, 2 = quarter resolution
          etc.</p></li><li><p><em class="emphasis"><span class="literal">&lt;detailHeightMapDistance&gt;</span></em></p><p>This is the distance at which the full height map is
          loaded</p></li><li><p><em class="emphasis"><span class="literal">&lt;lodDistances&gt;</span></em></p><p>This section contains the geometry LOD distances.</p></li><li><p><em class="emphasis"><span class="literal">&lt;distance&gt;</span></em></p><p>The <span class="literal">distance</span> sections define the distances
          at which each geometry LOD level is blended out. <span class="literal">distance0
          is for the first LOD level, <span class="literal">distance1 for the second LOD
          level etc. The distance between LOD levels must be at least half the
          diagonal distance of a terrain block (~71), this is because we only
          support a difference of 1 LOD level between neighbouring
          blocks.</span></span></p></li><li><p><em class="emphasis"><span class="literal">&lt;server&gt;</span></em></p><p>This section contains the information used by the
          server</p></li><li><p><em class="emphasis"><span class="literal">&lt;heightMapLod&gt;</span></em></p><p>This defines which LOD level to load on the server, this value
          is used to speed up loading on the server.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e1702"></a>4.2.&nbsp;Simple Terrain</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e1705"></a>4.2.1.&nbsp;Key features</h3></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Works with the chunking system.</p></li><li><p>Individual grid squares addressable from disk and
          memory.</p></li><li><p>Based on a 4x4 metre grid (tiles), which matches portal
          dimensions.</p></li><li><p>Low memory footprint.</p></li><li><p>Low disk footprint.</p></li><li><p>Fast rendering.</p></li><li><p>Automatic blending.</p></li><li><p>Easy tool integration.</p></li><li><p>Layered terrain with tiled textures for easy strip
          creation.</p></li><li><p>Uses texture projection to apply texture coordinates to save
          vertex memory.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e1739"></a>4.2.2.&nbsp;Overview</h3></div></div></div><p>The terrain is a huge height map defined by a regular grid of
      height poles, every 4x4 metres. Terrain is organised into terrain blocks
      of 100x100 metres. Each of these blocks can have up to four textures,
      which are blended on a per-vertex (<em class="emphasis">i.e.</em>, per-pole)
      basis. The terrain also is self-shadowing, and allows holes to be cut
      out of it, for things like cave openings. The terrain also contains
      detail information, so that the detail objects can be matched to the
      terrain type.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e1747"></a>4.2.3.&nbsp;Chunking</h3></div></div></div><p>The terrain integrates properly with the chunking: each terrain
      block is 100x100 metres, which is the size of the outside chunks. The
      terrain blocks are stored in separate files, so that they can be opened
      as needed.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e1752"></a>4.2.4.&nbsp;Disk footprint</h3></div></div></div><p>Each terrain block covers one chunk, each with dimension of
      100x100 metres. It contains 28x28 height, blend, shadow, and detail
      values (there are two extra rows and one column to allow for boundary
      interpolation). Each terrain block also stores 25x25 hole values, one
      for each 4x4m tile.</p><p>The table below display the terrain cost per chunk.</p><div class="altrow"><table border="0"><colgroup><col width="22%"><col width="62%"><col width="16%"></colgroup><thead><tr><th>Component</th><th>Size calculation</th><th>Size</th></tr></thead><tbody><tr><td>Headers</td><td>256 (header) + 128 x 4 (texture names)</td><td>768</td></tr><tr><td>Height</td><td>28 x 28 x sizeof( float )</td><td>3,136</td></tr><tr><td>Blend</td><td>28 x 28 x sizeof( dword )</td><td>3,136</td></tr><tr><td>Shadow</td><td>28 x 28 x sizeof( word )</td><td>1,568</td></tr><tr><td>Detail</td><td>28 x 28 x sizeof( byte )</td><td>784</td></tr><tr><td>Hole</td><td>25 x 25 x sizeof( bool )</td><td>625</td></tr><tr><td colspan="2">Total</td><td>10,017</td></tr></tbody></table></div><p><span class="citetitle">Terrain cost per chunk</span></p><p>For example, for a 15x15 km world the total disk size of the
      terrain would be: 10,017 x 150 x 150 ~ 215MB.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e1825"></a>4.2.5.&nbsp;Memory footprint</h3></div></div></div><p>With a field of view of 500m, and each terrain block covering
      100x100 metres, a typical scene would require roughly 160 terrain blocks
      in memory at any one time.</p><p>The memory usage of this much terrain is about 2MB, plus data
      management overheads.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e1832"></a>4.2.6.&nbsp;Texture spacing</h3></div></div></div><p>The <span class="literal">TerrainTextureSpacing</span> tag included in the
      <span class="literal">environment</span> section of file
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/resources.xml</span>
      (for details on the precedence of entries in the various copies of file
      resources.xml, see <a href="#xref_File_resources_xml" title="1.4.1.&nbsp;File resources.xml">File <span class="literal">resources.xml</span></a>) determines
      the size (in metres) to which texture map will be stretched/shrunk when
      applied to the terrain.</p><p>This value determines both the length and height of the texture
      tile.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_TerrainSpecular"></a>4.3.&nbsp;Terrain specular lighting</h2></div></div></div><p>The equation for the specular lighting is:</p><div class="blockquote"><blockquote class="blockquote"><p>SpeClr = TerSpeAmt * ( (SpeDfsAmt * TerDfsClr) + SunClr) *
      SpeRfl</p></blockquote></div><p>The list below describes each variable:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">SpeClr</span> (Specular
        colour)</em></p><p>Final colour reflected.</p></li><li><p><em class="emphasis"><span class="literal">TerSpeAmt</span> (Specular
        amount)</em></p><p>Value is given by the weighted blend of the alpha channel of the
        4 terrain textures.</p></li><li><p><em class="emphasis"><span class="literal">SpeDfsAmt</span> (Specular
        diffuse amount)</em></p><p>Initial value is stored in the variable
        <span class="literal">specularDiffuseAmount</span> in the effect file
        <span class="literal">bigworld/res/shaders/terrain/terrain.fx</span>.</p><p>Its value can be tweaked during runtime via the watcher
        <span class="literal">render/terrain/specularDiffuseAmount</span>.</p><p>Once the desired result is achieved, the new value can be stored
        in the effect file.</p></li><li><p><em class="emphasis"><span class="literal">TerDfsClr</span> (Terrain
        diffuse colour)</em></p><p>Value is given by the weighted blend of the RGB channels of the
        4 terrain textures.</p></li><li><p><em class="emphasis"><span class="literal">SunClr</span> (Sunlight
        colour)</em></p><p>Colour impinged by sunlight.</p></li><li><p><em class="emphasis"><span class="literal">SpeFlr</span> (Specular
        reflection)</em></p><p>Specular reflection value at the given pixel, adjusted by the
        Specular power coefficient</p></li></ul></div><p>As a result of the formula, a small amount of the<em class="emphasis"> Terrain diffuse colour</em>
    (<span class="literal">TerDfsClr</span>) is added to the <em class="emphasis">Sunlight colour</em> (<span class="literal">SunClr</span>) to give
    the <em class="emphasis">Specular colour</em>
    (<span class="literal">SpeClr</span>).</p><p>The initial value of the power of specular lighting is stored in the
    variable <span class="literal">specularPower</span> in the effect file
    <span class="literal">bigworld/res/shaders/terrain/terrain.fx</span>. Its value can
    be tweaked during runtime via the watcher
    <span class="literal">render/terrain/specularPower</span>. Once the desired result
    is achieved, the new value can be stored in the effect file.</p><p>Note that the <em class="emphasis">Specular power</em> can
    only be adjusted for shader hardware version 2.0 and later. Earlier
    versions of shader hardware are limited to a <em class="emphasis">Specular power</em> value of 4 (which is the default for
    shader hardware version 2.0 and later).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The final amount of specular lighting applied to the terrain is
      affected by the variable <span class="literal">specMultiplier</span> in file
      <span class="literal">bigworld/res/shaders/terrain/terrain.fx</span>.</p><p>Set it to anything other than 1 to rescale the specular lighting,
      or 0 to completely disable it.</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Terrain specular lighting can be turned off via
      <span class="literal">TERRAIN_SPECULAR</span> graphics settings.</p><p>For details, see <a href="#xref_Graphics_Settings" title="21.9.&nbsp;Graphics settings">Graphics settings</a>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Cloud_Shadows"></a>Chapter&nbsp;5.&nbsp;Cloud shadows</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e2015">5.1. Requirements</a></span></dt><dt><span class="section"><a href="#d0e2020">5.2. Implementation</a></span></dt><dt><span class="section"><a href="#d0e2032">5.3. Effect File Implementation</a></span></dt><dt><span class="section"><a href="#xref_Tweaking">5.4. Tweaking</a></span></dt></dl></div><p>All objects in the BigWorld client engine that are drawn outside are
  affected by cloud shadows. This effect is applied per-pixel, and is
  performed using a light map-stored as a texture feed in the engine that is
  projected onto the world.</p><p>This light map is exposed to the effects system via macros defined in
  the file
  <span class="literal">bigworld/res/shaders/std_effects/stdinclude.fxh</span>.</p><p>By default, the texture feed is named <span class="literal">skyLightMap</span>,
  and therefore is accessible to Python via the command:</p><pre class="programlisting">BigWorld.getTextureFeed( "skyLightMap" )</pre><p>Information for the sky light map is found in the sky XML file, which
  is defined in the file
  <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/spaces/<em class="replaceable"><code>&lt;space&gt;</code></em>/space.settings</span>
  (for details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_space_settings" class="olink"><i><span class="literal">space.settings</span></i></a>) for the
  given space. The parameters are the same as in any BigWorld light
  map.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2015"></a>5.1.&nbsp;Requirements</h2></div></div></div><p>Cloud shadowing requires one extra texture layer per material. While
    the fixed-function pipeline supports this for most materials, cloud
    shadowing on bump-mapped and specular objects requires more than four sets
    of texture coordinates, meaning that for bump-mapped objects it will only
    work on Pixel Shader 2 and above.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2020"></a>5.2.&nbsp;Implementation</h2></div></div></div><p>The sky light map is calculated by the code in C++ file
    <span class="literal">src/lib/romp/sky_light_map.cpp</span>, and is updated by the
    sky module during draw.</p><p>It is exposed to the effect engine via automatic effect constants.
    The light map is updated only when a new cloud is created, or the current
    set of clouds has moved more than 25% downwind.</p><p>Between updates, the projection texture coordinates are slid by the
    wind speed so that the cloud shadows appear to move with the clouds. All
    effect files incorporate the cloud shadowing effect, including the terrain
    and flora.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2032"></a>5.3.&nbsp;Effect File Implementation</h2></div></div></div><p>There are two effect constants exposed to effect files to aid with
    sky light mapping:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">SkyLightMapTransform</span></em></p><p>Sets the "World to SkyLightMap" texture projection.Use this
        constant to convert x,z world vertex positions to u,v texture
        coordinates.</p></li><li><p><em class="emphasis"><span class="literal">SkyLightMap</span></em></p><p>Exposes the sky light map texture to effect files.</p></li></ul></div><p>There are several macros in file
    <span class="literal">bigworld/res/shaders/std_effects/stdinclude.fxh</span> that
    assist with integrating cloud shadowing into your effect files.</p><p>These macros are described in the list below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">BW_SKY_LIGHT_MAP_OBJECT_SPACE</span>,
        <span class="literal">BW_SKY_LIGHT_MAP_WORLD_SPACE</span></em></p><p>These macros declare the variables and constants required for
        the texture projection, including:</p><div class="itemizedlist"><ul type="circle"><li><p>World space camera position.</p></li><li><p>Sky light map transform.</p></li><li><p>The sky light map itself.</p></li></ul></div><p>When using an effect file that performs lighting in object space
        (for example, if you are also using the macro
        <span class="literal">DIFFUSE_LIGHTING_OBJECT_SPACE</span>), use the variation
        <span class="literal">BW_SKY_LIGHT_MAP_OBJECT_SPACE</span>, and that will have
        the world matrix declared.</p></li><li><p><em class="emphasis"><span class="literal">BW_SKY_LIGHT_MAP_SAMPLER</span></em></p><p>This macro declares a sampler object that is used when
        implementing cloud shadows in a pixel shader.</p></li><li><p><em class="emphasis"><span class="literal">BW_SKY_MAP_COORDS_OBJECT_SPACE</span>,
        <span class="literal">BW_SKY_MAP_COORDS_WORLD_SPACE</span></em></p><p>These macros perform the texture projection on the given vertex
        position, and set the texture coordinates into the given
        register.</p><p>Be sure to pass the positions in the appropriate reference
        frame, depending on which set of macros you are using.</p></li><li><p><em class="emphasis"><span class="literal">BW_TEXTURESTAGE_CLOUDMAP</span></em></p><p>This macro defines a texture stage that multiplies the previous
        stage's result by the appropriate cloud shadowing value.</p><p>It should be used after any diffuse lighting calculation, and
        before any reflection or specular lighting.</p></li><li><p><em class="emphasis"><span class="literal">SAMPLE_SKY_MAP</span></em></p><p>This macro samples the sky light map in a pixel shader, and
        returns a 1D-float value representing the amount by which you should
        multiply your diffuse lighting value.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Tweaking"></a>5.4.&nbsp;Tweaking</h2></div></div></div><p>After the light map is calculated based on the current clouds, it is
    clamped to a maximum value. This means that the cloud map can never get
    too dark, or have too great an effect on the world.</p><p>For example, even if the sun is completely obscured by clouds during
    the day, there will still be enough ambient lighting and illumination from
    the cloud layer itself such that sunlight still takes effect.</p><p>The BigWorld watcher <span class="literal">Client
    Settings/Clouds/max&nbsp;sky&nbsp;light&nbsp;map&nbsp;darkness</span>
    sets the maximum value that the sky light map can have. A value of 1 means
    that the sky light map is able to completely obscure the sun (full
    shadowing). The default value of 0.65 represents the BigWorld artists'
    best guess at the optimal value for cloud shadowing. A value of 0 would
    mean there is never any effect of cloud shadows on the world.</p><p>This value is also read from the file sky.xml in the light map
    settings. It is represented by the maxDarkness tag. For details on the sky
    light map settings file, see <a href="#xref_Sky_Light_Map" title="21.1.4.1.2.&nbsp;Sky light map">Sky light map</a>.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Chunks"></a>Chapter&nbsp;6.&nbsp;Chunks</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e2146">6.1. Definitions</a></span></dt><dt><span class="section"><a href="#xref_Implementation_Files">6.2. Implementation files</a></span></dt><dt><span class="section"><a href="#xref_Details_And_Notes">6.3. Details and notes</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2278">6.3.1. Includes</a></span></dt><dt><span class="section"><a href="#d0e2296">6.3.2. Models</a></span></dt><dt><span class="section"><a href="#d0e2303">6.3.3. Entities</a></span></dt><dt><span class="section"><a href="#xref_Boundaries_And_Portals">6.3.4. Boundaries and portals</a></span></dt><dt><span class="section"><a href="#d0e2325">6.3.5. Transforms</a></span></dt><dt><span class="section"><a href="#d0e2330">6.3.6. Other items</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e2354">6.4. Loading and ejecting</a></span></dt><dt><span class="section"><a href="#d0e2364">6.5. Focus grid</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2375">6.5.1. Hull tree</a></span></dt><dt><span class="section"><a href="#d0e2385">6.5.2. Quad tree</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e2392">6.6. Collisions</a></span></dt><dt><span class="section"><a href="#xref_Sway_Items">6.7. Sway items</a></span></dt></dl></div><p>The scene graph drawn by the BigWorld client is built from small
  convex chunks of space. This has many benefits including easy streaming,
  reduced loading times, concurrent world editing, and facilitation of server
  scene updates and physics checking.</p><p>The concepts and implementation of the chunking system are described
  in the following sections.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2146"></a>6.1.&nbsp;Definitions</h2></div></div></div><p>The following terms are related to the BigWorld chunking
    system:</p><p>A space is a continuous three-dimensional Cartesian medium. Each
    space is divided piecewise into chunks, which occupy the entire space but
    do not overlap. Every point in the space is in exactly one chunk. A space
    is split into columns of 100x100 metres in the horizontal dimensions, and
    total vertical range. Examples of separate spaces include planets,
    parallel spaces, space stations, and 'detached' apartment/dungeon
    levels.</p><p>A chunk is a convex three-dimensional volume. It contains a
    description of the scene objects that reside inside it. Scene objects
    include models, lights, entities, terrain blocks, etc, known as chunk
    items. It also defines the set of planes that form its boundary.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The <em class="emphasis">outside</em> chunk of a column is exempt
        from this &#8212; it needs only define the four planes to adjacent column.
        The boundary planes of other chunks overlapping that grid square are
        used to build a complete picture of the division of space inside
        it.</p></div><p> Some planes have portals defined on them, indicating that a
    neighbouring chunk is visible through them.</p><p>A portal is a polygon plus a reference to the chunk that is visible
    through that polygon. It includes a flag to indicate whether it permits
    objects to pass through it. Some portals may be named so that scripts can
    address them, and change their permissivity.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Implementation_Files"></a>6.2.&nbsp;Implementation files</h2></div></div></div><p>The following files are used by the chunking system:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">One <span class="literal">space.setting</span>s file
        for each space in the universe (XML format)</em></p><p>For details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_space_settings" class="olink"><i><span class="literal">space.settings</span></i></a>.</p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">&lt;res&gt;/spaces/&lt;space&gt;/space.settings</span></em></p><div class="itemizedlist"><ul type="square"><li><p>Environment settings</p></li><li><p>Bounding rectangle of grid squares</p></li></ul></div></li></ul></div></li><li><p><em class="emphasis">Multiple <span class="literal">.chunk</span> files
        for each space (XML format)</em></p><p>For details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_chunk_o_chunk_chunk_i_chunk" class="olink"><i><span class="literal">.chunk</span></i></a>.</p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">&lt;res&gt;/spaces/&lt;space&gt;/XXXXZZZZo.chunk</span>
            (o = outside)</em></p></li><li><p><em class="emphasis"><span class="literal">&lt;res&gt;/spaces/&lt;space&gt;/CCCCCCCCi.chunk</span>
            (i = inside)</em></p><div class="itemizedlist"><ul type="square"><li><p>List of scene objects</p></li><li><p>Texture sets used</p></li><li><p>Boundary planes and portals (including references to
                visible chunks)</p></li><li><p>Collision scene</p></li></ul></div></li></ul></div></li><li><p><em class="emphasis">Multiple <span class="literal">.cdata</span> files
        for each space (binary format)</em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">&lt;res&gt;/spaces/&lt;space&gt;/XXXXZZZZ.cdata</span></em></p><div class="itemizedlist"><ul type="square"><li><p>Terrain data such as:</p><div class="itemizedlist"><ul type="disc"><li><p>Height map data</p></li><li><p>Overlay data</p></li><li><p>Textures used</p></li></ul></div></li></ul></div><p>&#8212; or &#8212;</p><div class="itemizedlist"><ul type="square"><li><p>Multiple instances of lighting data for each object in
                the chunk:</p><div class="itemizedlist"><ul type="disc"><li><p>Static lighting data</p></li><li><p>A colour value for each vertex in the model</p></li></ul></div></li></ul></div></li></ul></div></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Details_And_Notes"></a>6.3.&nbsp;Details and notes</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2278"></a>6.3.1.&nbsp;Includes</h3></div></div></div><p>Includes are transparent after being loaded (to client, server,
      and scripts). Label clashes are handled by appending
      '<span class="literal">_<em class="replaceable"><code>n</code></em></span>' to labels, where
      <span class="literal"><em class="replaceable"><code>N</code></em></span> is the number of objects
      with that label already.</p><p>Includes are expanded inline where they are encountered, and do
      not need to have a bounding box for the purposes of the client or
      server.</p><p>The WorldEditor does not generate includes.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2296"></a>6.3.2.&nbsp;Models</h3></div></div></div><p>Material overrides and animation declarations remain the domain of
      model files. For more details, see <a href="#xref_Models" title="Chapter&nbsp;10.&nbsp;Models"><i xmlns:xlink="http://www.w3.org/1999/xlink">Models</i></a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2303"></a>6.3.3.&nbsp;Entities</h3></div></div></div><p>Only entities that are implicitly instantiated need to have their
      ID field filled in. If it is zero or is missing, then the entity is
      assigned a unique ID from either the client's pool (if it is a
      client-instantiated entity) or the creating cell's pool (if it is a
      server-instantiated entity).</p><p>If an entity needs a label, it must include the label as a
      property in its formal type definition.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Boundaries_And_Portals"></a>6.3.4.&nbsp;Boundaries and portals</h3></div></div></div><p>The special chunk identifier heaven may be used if only the sky
      (gradient, clouds, sun, moon, stars, etc...) is to be drawn there.
      Similarly with earth, if the terrain ought to be drawn. Therefore,
      outside chunks will have six sides, with the heaven chunk on the top and
      the earth chunk on the bottom.</p><p>The absence of a chunk reference in a portal means it is
      unconnected and that nothing will be drawn there.</p><p>If a chunk is included inside another, then its boundary planes
      are ignored &#8212; only things like its includes, models, lights, and sounds
      are used.</p><p>An internal portal means that the specified boundary is not an
      actual boundary, but instead that the space occupied by the chunk it
      connects to (and all chunks that that chunk connects to) should be
      logically subtracted from the space owned by this chunk, as defined by
      its non-internal boundaries. This was originally intended only for
      'outside' chunks to connect to 'inside' chunks, but it may be readily
      adapted for 'interior portals', the complement to 'boundary
      portals'.</p><p>In a portal definition, the vAxis for the 2D polygon points is
      found by the cross product of the normal with uAxis.</p><p>In boundary definitions, the normals should point inward.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2325"></a>6.3.5.&nbsp;Transforms</h3></div></div></div><p>Everything in the chunk except the bounding box is interpreted in
      the local space of the chunk (as specified in the top-level transform
      section).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2330"></a>6.3.6.&nbsp;Other items</h3></div></div></div><p>The following items can also exist in chunks:</p><div class="itemizedlist"><ul type="disc"><li><p>Spot Light</p></li><li><p>Ambient Light</p></li><li><p>Directional Light</p></li><li><p>Water (body of water)</p></li><li><p>Flare (lens flare)</p></li><li><p>Particle System</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2354"></a>6.4.&nbsp;Loading and ejecting</h2></div></div></div><p>At every frame, the Chunk Manager performs a simple graph traversal
    of all the chunks it has loaded, looking for new chunks to load. It
    follows the portals between chunks, keeping track of how far it has
    'travelled' in its scan. Its scan is limited to the maximum visible
    distance, <em class="emphasis">i.e.</em>, a little further than the far plane
    distance.</p><p>The closest unloaded chunk it finds on this traversal is the chunk
    that is loaded next. Loading is done in a separate thread, so it does not
    interfere with the running of the game. Similarly, any chunks that are
    beyond the reach of the scan are candidates for ejecting
    (unloading).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2364"></a>6.5.&nbsp;Focus grid</h2></div></div></div><p>The focus grid is a set of columns surrounding the camera position.
    Each column is 100x100metres and is aligned to the terrain squares and
    outside chunks. The focus grid is sized to just exceed the far
    plane.</p><p>For a far plane of 500m, for example, the focus grid goes 700m in
    each direction, making for 14 x 14 = 196 columns total.</p><p>The set of columns in the focus grid is dependent on the camera
    position. As the camera moves, the focus grid disposes columns that are no
    longer under the grid and 'focuses' on ones that have just come close
    enough.</p><p>Each column contains a hull tree and a quad tree.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2375"></a>6.5.1.&nbsp;Hull tree</h3></div></div></div><p>A hull tree is a kind of binary-space partitioning tree for convex
      hulls. It can handle hulls that overlap. It can do point tests and
      proper line traversals.</p><p>The hull tree is formed from the boundaries of all the chunks that
      overlap the column. From this tree, the chunk that any given point lies
      in can be quickly determined. (<em class="emphasis">e.g.</em>, the location
      of the camera)</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2385"></a>6.5.2.&nbsp;Quad tree</h3></div></div></div><p>The quad tree is made up of the bounding boxes (or, potentially,
      any other bounding convex hull) of all the obstacles that overlap the
      column. This tree is used for collision scene tests. Chunk items are
      responsible for adding and implementing obstacles. Currently only model
      and terrain chunk items add any obstacles.</p><p>If a chunk or obstacle is in more than one column, it is added to
      the trees of both columns.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2392"></a>6.6.&nbsp;Collisions</h2></div></div></div><p>Using its focus grid of obstacle quad trees, the chunk space class
    can sweep any 3D shape through its space, and report all the triangle
    collisions to a callback object. The currently supported 3D shapes are
    points and triangles, but any other could be added with very little
    difficulty.</p><p>The bottommost level of collision checking is handled by a generic
    obstacle interface, so any conceivable obstacle could be added to this
    collision scene, as long as it can quickly determine when another shape
    collides with it (in its own local coordinates).</p><p>For more details, see file
    <span class="literal">bigworld/src/client/physics.cpp</span>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Sway_Items"></a>6.7.&nbsp;Sway items</h2></div></div></div><p>A sway item is a chunk item that is swayed by the passage of other
    chunk items. Whenever a dynamic chunk item moves, any sway items in that
    chunk get the sway method called on them, specifying source and destiny of
    movement.</p><p>Currently the only user of this is <span class="literal">ChunkWater</span>. It
    uses movements that pass through its surface to make ripples in the water.
    This is why the ripples work for any kind of dynamic item &#8212; from dynamic
    obstacles/moving platforms to player models to small bullets.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">In
        <span class="literal">mf/src/lib/chunk/chunk_water.cpp</span>:</em></p><pre class="programlisting">/**
 * Constructor
 */
ChunkWater::ChunkWater() :
  ChunkItem( 5 ), <a name="co1543"></a><img src="../images/callouts/1.png" alt="1" border="0">
  pWater_( NULL )
{
}
...
/**
 *   Apply a disturbance to this body of water
 */
void ChunkWater::sway( const Vector3 &amp; src, const Vector3 &amp; dst )
{
  if (pWater_ != NULL)
  {
    pWater_-&gt;addMovement( src, dst );
  }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a href="#co1543"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>Calls <span class="literal">ChunkItem</span> constructor with
            <span class="literal">wantFlags</span> =5:</p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">1</span></em> &#8212;
                <span class="literal">wantsDraw</span></p></li><li><p><em class="emphasis"><span class="literal">4</span></em> &#8212;
                <span class="literal">wantsSway</span></p></li></ul></div></td></tr></table></div></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">In
        <span class="literal">mf/src/lib/chunk/chunk_item.hpp</span>:</em></p><pre class="programlisting">...
class ChunkItem : public SpecialChunkItem
{
public:
  ChunkItem( int wantFlags = 0 ) : SpecialChunkItem( wantFlags ) { }
};
...
typedef ClientChunkItem SpecialChunkItem;
...
class ClientChunkItem : public ChunkItemBase
{
public:
  ClientChunkItem( int wantFlags = 0 ) : ChunkItemBase( wantFlags ) { }
};
...
ChunkItemBase( int wantFlags = 0 );

bool wantsDraw() const { return !!(wantFlags_ &amp; 1); }
bool wantsTick() const { return !!(wantFlags_ &amp; 2); }
bool wantsSway() const { return !!(wantFlags_ &amp; 4); }
bool wantsNest() const { return !!(wantFlags_ &amp; 8); }</pre></li></ul></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Entities"></a>Chapter&nbsp;7.&nbsp;Entities</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e2527">7.1. Entity Manager</a></span></dt><dt><span class="section"><a href="#xref_Entities_Are_Python_Script_Objects">7.2. Entity scripts</a></span></dt><dt><span class="section"><a href="#d0e2566">7.3. Entity resources</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Entity_Preloads">7.3.1. Preloads</a></span></dt><dt><span class="section"><a href="#d0e2606">7.3.2. Prerequisites</a></span></dt></dl></dd></dl></div><p>Entities are a key BigWorld concept, and involve a large system in
  their own right. They are the link between the client and the server and are
  the feature most particular to BigWorld Technology, in comparison to other
  3D game systems.</p><p>This section deals only with the management aspects of entities on the
  client.</p><p>For details on the environment in which entity scripts are placed, and
  the system that supports them, see <a href="#xref_Scripting" title="Chapter&nbsp;9.&nbsp;Scripting"><i xmlns:xlink="http://www.w3.org/1999/xlink">Scripting</i></a>. For
  details on the definition of an entity, which is shared between the server
  and the client, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_Physical_Entity_Structure_For_Scripting" class="olink"><i>Physical Entity Structure for Scripting</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_The_Definition_File" class="olink">The Entity Definition File</a>.</p><p>Depending on the entity type, it can exist in different parts of
  BigWorld, as listed below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Client-only</em></p><p>For example, a security camera prop, or an information icon.
        Client-only entities are created by setting WorldEditor's <em class="emphasis">Properties</em>' panel <em class="emphasis">Client-Only</em> attribute to <em class="emphasis">true</em>. (for details on this panel, see the
        document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a> 's section
        <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_WorldEditor" class="olink"><i>WorldEditor</i></a> <span class="symbol">&#8594;</span>
        <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_we_Panel_Summary" class="olink">Panel summary</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_we_Properties_Panel" class="olink">Properties panel</a>). Client-only entities should
        not have cell or base scripts.</p></li><li><p><em class="emphasis">Client and server</em></p><p>The entity will exist in both parts at the same position. For
        example, the player Avatar, NPCs, a vending machine.</p></li><li><p><em class="emphasis">Server-only</em></p><p>The entity will be instantiated on the server only. For example,
        a NPC spawn point or teleportation destination point. Server-only
        entities do not have any scripts on the client side.</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2527"></a>7.1.&nbsp;Entity Manager</h2></div></div></div><p>The Entity Manager stores two lists of entities:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Active List</em> &#8212; Contains
        the entities that are currently in the world, as relayed by the server
        or indicated by the chunk files.</p></li><li><p><em class="emphasis">Cached List</em> &#8212; Contains
        the entities that have recently been in the world, but are now just
        outside the client's 500m radius area of interest (AoI).</p></li></ul></div><p>Entities are cached so that if they come back into the client's AoI
    shortly after they have left it, the server does not have to resend all
    the data associated with that entity; only the fields that have
    changed.</p><p>Since messages may be received from the server out of order, the
    Entity Manager is not sensitive to their order. For example, if an entity
    enters the player's AoI then quickly leaves it, the BigWorld client
    behaves correctly even if it receives the entity's 'leave AoI' message
    before its 'enter AoI' message.</p><p>The Entity Manager can always determine the relative time that it
    should have received a message from the sequence number of the packet,
    since packets are sent at regular intervals.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Entities_Are_Python_Script_Objects"></a>7.2.&nbsp;Entity scripts</h2></div></div></div><p>Entity scripts on the client are Python classes that derive from the
    <code class="code">BigWorld.Entity</code> class. This base class exposes a number of
    methods and attributes which allow the script to control the behaviour of
    the entity (e.g. position, orientation, and the entity model are all
    exposed via the <code class="code">BigWorld.Entity</code> interface).</p><p>In addition exposing to methods and attributes, the client engine
    will notify the entity scripts when certain events occur via named event
    handlers.</p><p>See <a href="#xref_Scripting" title="Chapter&nbsp;9.&nbsp;Scripting"><i xmlns:xlink="http://www.w3.org/1999/xlink">Scripting</i></a> and the Client Python API
    reference guide for details on what methods, attributes, and event
    handlers are available.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e2566"></a>7.3.&nbsp;Entity resources</h2></div></div></div><p>Generally, each entity type require some resources in order to
    operate, for example models, textures, shaders, sounds, or particle
    systems. The BigWorld client provides a couple of ways to make sure these
    resources are available when the entity enters the world, avoiding
    stalling the main thread.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Entity_Preloads"></a>7.3.1.&nbsp;Preloads</h3></div></div></div><p>When the client starts up, it will query each entity Python module
      for a function named <code class="code">preload</code>. Resource names returned by
      this function will be loaded on client startup and kept in memory for
      the entire life-time of the client (i.e. it will be instantly available
      for use at any time). This is useful for commonly used assets to avoid
      potentially loading and re-loading at a later time. The tradeoff,
      however, is that the client will take longer to start and will use more
      memory (if the resource isn't actually being used at some point).</p><p>To use the preloads mechanism, create a global function called
      <code class="code">preload</code> in the relevant entity module. It must take a
      single parameter which is a Python list containing resource to preload.
      Modify this list in place (e.g. using list.append or list
      concatenation), inserting the string names of each resource to be
      preloaded by the client.</p><p>For example, <code class="code"> </code></p><pre class="programlisting"># Door.py
import BigWorld

class Door( BigWorld.Entity ):
    def __init__( self ):
        ...

def preload( list ):
    list.append( "doors/models/generic_door.model" )
    list.append( "doors/maps/door_highlight.tga" )
    ... </pre><p>The type of resources which can be preloaded are,

      </p><div class="itemizedlist"><ul type="disc"><li><p>Fonts</p></li><li><p>Textures</p></li><li><p>Shaders</p></li><li><p>Models</p></li></ul></div><p>
	  </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2606"></a>7.3.2.&nbsp;Prerequisites</h3></div></div></div><p>When an entity is about to appear in the world on the client, the
      engine will execute a callback on the entity script called
      <code class="code">prerequisites</code>. This allows entity scripts to return a list
      of resources that must be loaded before the entity may enter the world.
      These resources are loaded by the loading thread, so as to not interrupt
      the rendering pipeline.</p><p>It is recommended practice for an entity to expose its required
      resources as pre-requisites, and load them in the method
      <code class="code">onEnterWorld</code>. Unlike using preloads, prerequisites do not
      leak a reference, so when the entity leaves the world, it will free its
      resources.</p><p>The Entity Manager calls <code class="code">Entity::checkPrerequisites</code>
      before allowing an entity to enter the world. This method checks whether
      the pre-requisites for this entity entering the world are satisfied. If
      they are not, then it starts the process of satisfying them (if not yet
      started).</p><p>Note that when the <code class="code">prerequisites</code> method is called on
      the entity, its script has already been initialised and its properties
      have been set up. The entity thus may specialise its pre-requisites list
      based on the specific instance of that entity. For example:</p><pre class="programlisting">def Door( BigWorld.Entity ):
    ...
    def prerequisites( self ):
        return [ DoorResources[ self.modelType ].modelName ]
    ...</pre></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_UDOs"></a>Chapter&nbsp;8.&nbsp;User Data Objects</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_UDOs_Are_Python_Script_Objects">8.1. .1. User Data Objects are Python script objects</a></span></dt><dt><span class="section"><a href="#xref_UDOs_client_access">8.2. .2. Accessing from the Client</a></span></dt></dl></div><p>User data objects are a way of embedding user defined data in Chunk
  files. Each user data object type is implemented as a collection of Python
  scripts, and an XML-based definition file that ties the scripts together.
  These scripts are located in the resource tree under the folder
  <code class="filename">scripts</code>.</p><p>User data objects differ from entities in that they are immutable
  (i.e. their properties don't change), and that they are not propagated to
  other cells or clients. This makes them a lot lighter than entities.</p><p>A key feature of user data objects is their linkability. Entities are
  able to link to user data objects, and user data objects are able to link to
  other user data objects. This is achieved by including a
  <span class="literal">UDO_REF</span> property in the definition file for the user data
  object or entity that wishes to link to another user data object.</p><p>For more information about linking, please refer to <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_UDO_Linking" class="olink">User Data Object Linking With <span class="literal">UDO_REF</span>
    Properties</a>.</p><p>For details on the definition of a user data object, which is shared
  between the server and the client, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_Physical_UDO_Structure_For_Scripting" class="olink"><i>Physical User Data Object Structure for Scripting</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_The_UDO_Definition_File" class="olink">The User Data Object Definition File</a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_UDOs_Are_Python_Script_Objects"></a>8.1.&nbsp;.1. User Data Objects are Python script objects</h2></div></div></div><p>Each user data object is a Python script object
    (<span class="literal">PyObject</span>). Depending on the user data object type, it
    can exist in different parts of BigWorld, as listed below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Client only</em></p><p>Client only user data objects are created by using the
        <span class="literal">CLIENT</span> domain in the <span class="literal">Domain</span> tag
        inside its definition file. Client-only user data objects should not
        have cell or base scripts</p><p>For an example of a client-only user data object, please refer
        to the <span class="literal">CameraNode</span> user data object, implemented in
        the
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/CameraNode.py</code>
        and the
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/user_data_object_defs/CameraNode.def</code>
        files.</p></li><li><p><em class="emphasis">Server only</em></p><p>Server only user data objects are instantiated on the server
        only, and will be instantiated in the cell if its
        <span class="literal">Domain</span> tag is <span class="literal">CELL</span>, or in the
        base if the <span class="literal">Domain</span> tag is set to
        <span class="literal">BASE</span>.</p><p>For an example of a server user data object, please refer to the
        <span class="literal">PatrolNode</span> user data object, implemented in the
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/cell/PatrolNode.py</code>
        and the
        <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/user_data_object_defs/PatrolNode.def</code>
        files.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_UDOs_client_access"></a>8.2.&nbsp;.2. Accessing from the Client</h2></div></div></div><p>The client can access all client-only user data objects using the
    command:</p><pre class="programlisting">&gt;&gt;&gt; BigWorld.userDataObjects
&lt;WeakValueDictionary at 3075900908&gt;</pre><p>This will return a Python dictionary, using the user data object&#8217;s
    unique identifier as the key, and its <span class="literal">PyObject</span>
    representation as its value. The attributes and script methods of the user
    data object can be accessed using the standard dot syntax:</p><pre class="programlisting">&gt;&gt;&gt; patrolNode.patrolLinks
[UserDataObject at 2358353012, UserDataObject at 2358383771]</pre></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Scripting"></a>Chapter&nbsp;9.&nbsp;Scripting</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Functional_Components">9.1. Functional components</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2788">9.1.1. Entity skeleton</a></span></dt><dt><span class="section"><a href="#d0e2797">9.1.2. Python script object</a></span></dt><dt><span class="section"><a href="#d0e2804">9.1.3. Model management</a></span></dt><dt><span class="section"><a href="#xref_Filters">9.1.4. Filters</a></span></dt><dt><span class="section"><a href="#xref_Action_Queue">9.1.5. Action Queue</a></span></dt><dt><span class="section"><a href="#xref_Action_Matcher">9.1.6. Action Matcher</a></span></dt><dt><span class="section"><a href="#d0e3476">9.1.7. Trackers</a></span></dt><dt><span class="section"><a href="#d0e3558">9.1.8. Timers and Traps</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Personality_Script">9.2. Personality script</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_init">9.2.1. <span class="literal">init</span></a></span></dt><dt><span class="section"><a href="#d0e3802">9.2.2. <span class="literal">fini</span></a></span></dt><dt><span class="section"><a href="#d0e3822">9.2.3. <span class="literal">handleKeyEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3852">9.2.4. <span class="literal">handleMouseEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3872">9.2.5. <span class="literal">handleAxisEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3892">9.2.6. <span class="literal">handleIMEEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3907">9.2.7. <span class="literal">handleLangChangeEvent</span></a></span></dt><dt><span class="section"><a href="#d0e3917">9.2.8. <span class="literal">onChangeEnvironments</span></a></span></dt><dt><span class="section"><a href="#d0e3933">9.2.9. <span class="literal">onGeometryMapped</span></a></span></dt><dt><span class="section"><a href="#d0e3945">9.2.10. <span class="literal">onRecreateDevice</span></a></span></dt><dt><span class="section"><a href="#d0e3964">9.2.11. <span class="literal">onTimeOfDayLocalChange</span></a></span></dt><dt><span class="section"><a href="#d0e3976">9.2.12. <span class="literal">start</span></a></span></dt></dl></dd></dl></div><p>The facilities provided to scripts are of extreme importance, as they
  determine the generality and extensibility of the client. To a script
  programmer this environment is the client; just as to an ordinary user, the
  windowing system is the computer.</p><p>The scripting environment offers a great temptation to try to write
  the whole of a program in it. This can quickly make for slow and
  incomprehensible programs (especially if the same programming discipline is
  not applied to the scripting language as is to C++). Therefore, we recommend
  that a functionality should only be written in script when it does not need
  to be called at every frame. Furthermore, where it is global, it should be
  implemented in the personality script. So, for example, a global chat
  console would be implemented in the personality script, whilst a targeting
  system, which needs to check the collision scene at every frame, is best
  implemented in C++.</p><p>Importantly, the extensive integration of Python throughout BigWorld
  Technology allows for both rapid development of game code, and enormous
  flexibility.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Garbage collection is disabled in BigWorld's Python integration,
    because garbage collection is an expensive operation that can occur at any
    time, blocking the main thread and causing frame rate spikes for
    example.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Functional_Components"></a>9.1.&nbsp;Functional components</h2></div></div></div><p>This section describes the contents and services of the (general)
    C++ entity, from the point of view of a script that uses these facilities.
    The functional components of an entity, described in the following
    sections are:</p><div class="itemizedlist"><ul type="disc"><li><p>Entity Skeleton</p></li><li><p>Python Script Object</p></li><li><p>Model Management</p></li><li><p>Filters</p></li><li><p>Action Queue</p></li><li><p>Action Matcher</p></li><li><p>Trackers (IK)</p></li><li><p>Timers and Traps</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2788"></a>9.1.1.&nbsp;Entity skeleton</h3></div></div></div><p>The Entity class (entity.cpp) is the C++ container that brings
      together whatever components are in use for a particular entity. It is
      derived from Python object and intercepts certain accesses, and passes
      those it does not understand on to the user script. This allows scripts
      to call C++ functions on themselves (and other entities) transparently,
      using the 'self' reference. The same technique of integration has been
      used in the cell and base components of the server.</p><p>This class handles any housekeeping or glue required by the
      component classes &#8212; it is the public face of an entity as far as
      other C++ modules are concerned.</p><p>The data members of this class include id, type, and
      position.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2797"></a>9.1.2.&nbsp;Python script object</h3></div></div></div><p>This is the instance of the user-supplied script class. The type
      of the entity selects the class. It stores type-specific data defined in
      the XML description of the entity type, as well as any other internally
      used data that the script wishes to store.</p><p>When field data is sent from the server, this class has its fields
      automatically updated (and it is notified of the change). When messages
      are received from the server (or another script on the client), the
      message handlers are called automatically. The entity class performs
      this automation &#8212; it appears to be automatic from the script's
      point of view.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2804"></a>9.1.3.&nbsp;Model management</h3></div></div></div><p>A model is BigWorld's term for a mesh, plus the animations and
      actions used on it.</p><p>The model management component allows an entity to manage the
      models that are drawn and animated at its position. Models can be
      attached to each other at well-defined attachment points (hard points),
      or they can exist independently. A model is not automatically added to
      the scene when it is loaded &#8212; it must be explicitly put in
      it.</p><p>An entity may use any number of independent (disconnected) models,
      but most will use zero or one. Those that use more require special
      filters to behave sensibly. For details, see <a href="#xref_Filters" title="9.1.4.&nbsp;Filters">Filters</a>.</p><p>The best way to understand models is t`o be acquainted to their
      Python interface, which is described in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>'s entry <em class="emphasis">Main
      <span class="symbol">&#8594;</span> Client <span class="symbol">&#8594;</span> BigWorld <span class="symbol">&#8594;</span> Classes <span class="symbol">&#8594;</span> <span class="literal">PyModel</span></em>. For
      more details, see <a href="#xref_Models" title="Chapter&nbsp;10.&nbsp;Models"><i xmlns:xlink="http://www.w3.org/1999/xlink">Models</i></a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Filters"></a>9.1.4.&nbsp;Filters</h3></div></div></div><p>Filters take time-stamped position updates and interpolate them to
      produce the position for an entity at an arbitrary time.</p><p>BigWorld provides only the Filter base class. The game developer
      would derive game-specific filters from this. Each entity can then
      select one type of filter for itself from the variations available. It
      can dynamically change its filter if it so desires.</p><p>Whenever a movement update comes from the server, it is handed
      over to the selected filter, along with the time that the (existing)
      game time reconstruction logic calculated for that event.</p><p>The filter can also be provided with gaps in time and transform,
      <em class="emphasis">i.e.</em>, 'at game-time x there was a forward movement
      of y metres and a rotation of z radians lasting t seconds'. The filter
      (if it is smart enough) can then incorporate this into its
      interpolation.</p><p>The filter can also execute script callbacks at a given time in
      the stream.</p><p>Filters are fully accessible from Python.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Action_Queue"></a>9.1.5.&nbsp;Action Queue</h3></div></div></div><p>The action queue is the structure within the BigWorld Technology
      framework that controls the queue of actions in effect on a model
      (actions are wrapped by ActionQueuer objects that are contained by the
      action queue).</p><p>The ActionQueue deals with the combining of layers and also
      applying the appropriate blend in and blend out times.</p><p>The ActionQueue also deals with any scripted callback functions
      that are linked to the playing of an action, like for example calling
      sound-playing callbacks at particular frames in an action.</p><p>An action is described in XML as illustrated the example
      <span class="literal">.model</span> file below (model files are located in any of
      the various sub-folders under the resource tree
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span> , such as for
      example,
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/environments</span>,
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/flora</span>,
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/sets/vehicles</span>,
      etc...):</p><pre class="programlisting">&lt;action&gt;
   &lt;name&gt;          <em class="replaceable"><code>ACTION_NAME</code></em>     &lt;/name&gt;
  ?&lt;animation&gt;     <em class="replaceable"><code>ANIMATION_NAME  </code></em>&lt;/animation&gt;
  ?&lt;blendInTime&gt;   <em class="replaceable"><code>float</code></em>           &lt;/blendInTime&gt;
  ?&lt;blendOutTime&gt;  <em class="replaceable"><code>float</code></em>           &lt;/blendOutTime&gt;
  ?&lt;filler&gt;        [true|false]    &lt;/filler&gt;
  ?&lt;track&gt;         <em class="replaceable"><code>int</code></em>             &lt;/track&gt;
  ?&lt;isMovement&gt;    [true|false]    &lt;/isMovement&gt;
  ?&lt;isCoordinated&gt; [true|false]    &lt;/isCoordinated&gt;
  ?&lt;isImpacting&gt;   [true|false]    &lt;/isImpacting&gt;
  ?&lt;match&gt;
    ?&lt;trigger&gt;
      ?&lt;minEntitySpeed&gt; <em class="replaceable"><code>float</code></em>  &lt;/minEntitySpeed&gt;
      ?&lt;maxEntitySpeed&gt; <em class="replaceable"><code>float  </code></em>&lt;/maxEntitySpeed&gt;
      ?&lt;minEntityAux1&gt;  <em class="replaceable"><code>float</code></em>  &lt;/minEntityAux1&gt;
      ?&lt;maxEntityAux1&gt;  <em class="replaceable"><code>float</code></em>  &lt;/maxEntityAux1&gt;
      ?&lt;minModelYaw&gt;    <em class="replaceable"><code>float</code></em>  &lt;/minModelYaw&gt;
      ?&lt;maxModelYaw&gt;    <em class="replaceable"><code>float</code></em>  &lt;/maxModelYaw&gt;Coor
      ?&lt;capsOn&gt;  <em class="replaceable"><code>capabilities</code></em>  &lt;/capsOn&gt;
      ?&lt;capsOff&gt; <em class="replaceable"><code>capabilities</code></em>  &lt;/capsOff&gt;
     &lt;/trigger&gt;
    ?&lt;cancel&gt;
      ?&lt;minEntitySpeed&gt; <em class="replaceable"><code>float</code></em>  &lt;/minEntitySpeed&gt;
      ?&lt;maxEntitySpeed&gt; <em class="replaceable"><code>float  </code></em>&lt;/maxEntitySpeed&gt;
      ?&lt;minEntityAux1&gt;  <em class="replaceable"><code>float</code></em>  &lt;/minEntityAux1&gt;
      ?&lt;maxEntityAux1&gt;  <em class="replaceable"><code>float</code></em>  &lt;/maxEntityAux1&gt;
      ?&lt;minModelYaw&gt;    <em class="replaceable"><code>float</code></em>  &lt;/minModelYaw&gt;
      ?&lt;maxModelYaw&gt;    <em class="replaceable"><code>float</code></em>  &lt;/maxModelYaw&gt;Coor
      ?&lt;capsOn&gt;  <em class="replaceable"><code>capabilities</code></em>  &lt;/capsOn&gt;
      ?&lt;capsOff&gt; <em class="replaceable"><code>capabilities</code></em>  &lt;/capsOff&gt;
     &lt;/cancel&gt;
    ?&lt;scalePlaybackSpeed&gt;  [true|false] &lt;/scalePlaybackSpeed&gt;
    ?&lt;feetFollowDirection&gt; [true|false] &lt;/feetFollowDirection&gt;
    ?&lt;oneShot&gt;             [true|false] &lt;/oneShot&gt;En
    ?&lt;promoteMotion&gt;       [true|false] &lt;/promoteMotion&gt;
   &lt;/match&gt;
&lt;/action&gt;</pre><p><span class="citetitle">Example <span class="literal">.model</span> file describing
      action</span></p><p>The list below describes some of the tags in the XML file:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">name</span></em></p><p>Name of that action as used by a script.</p><p>These are available as named 'constants' off the model object
          returned by the Model Manager.</p></li><li><p><em class="emphasis"><span class="literal">animation</span></em></p><p>The base animation whence the frame data is sourced.</p></li><li><p><em class="emphasis"><span class="literal">blendInTime</span></em></p><p>Time in seconds the action takes to completely blend
          in.</p></li><li><p><em class="emphasis"><span class="literal">blendOutTime</span></em></p><p>Time in seconds the action takes to completely blend
          out.</p></li><li><p><em class="emphasis"><span class="literal">filler</span></em></p><p>Specifies if the action is just padding and can be interrupted
          if anything else comes on the queue.</p></li><li><p><em class="emphasis"><span class="literal">track</span></em></p><p>Track number in which the action should be played.</p><p>If the action has a track, then the animation is blended on
          top of whatever other animations exist &#8212;
          <em class="emphasis">i.e.</em>, it bypasses the queue.</p></li><li><p><em class="emphasis"><span class="literal">isMovement</span></em></p><p>Specifies that the action uses a simple movement animation
          such as walk, run, side-step, etc. The translation must be linear,
          and is subtracted from the action when played (so a run animation
          which moves from the origin will now appear to run on the spot).
          This setting requires the PromoteMotion flag to be set, and doing so
          means this translation then moves the model accordingly. If the
          model is owned by a client-controlled Entity, then the server-side
          entity's position will be updated accordingly. This setting allows
          the use of scalePlaybackSpeed. This setting cannot be used with
          isCoordinated and isImpacting.</p></li><li><p><em class="emphasis"><span class="literal">isCoordinated</span></em></p><p>Specifies that the action's animation starts from an offset
          position. Used for actions that require coordination with a
          non-player character (NPC), which needs to be positioned relative to
          the player's character for the purpose of matching contact points
          (e.g. shaking hands). This setting cannot be used with isMovement
          and isImpacting.</p></li><li><p><em class="emphasis"><span class="literal">isImpacting</span></em></p><p>Specifies that the action is a complex (non-linear) movement
          animation. If the entity is client-controlled, then its position on
          the server will also be updated. Examples of animations used with
          isImpacting are jumping, combat and knockdowns, interacting with
          entities, etc. This setting requires PromoteMotion and cannot be
          used with isMovement and isCoordinated.</p></li><li><p><em class="emphasis"><span class="literal">match</span></em></p><p>If this section is present, it means the Action Matcher can
          automatically select the action (see below).</p></li><li><p><em class="emphasis"><span class="literal">trigger</span> (section
          <span class="literal">match</span>)</em></p><p>This section defines criteria used to determine when to start
          an action.</p></li><li><p><em class="emphasis"><span class="literal">minEntitySpeed</span>
          (section <span class="literal">trigger</span>)</em></p><p>Determines the minimum velocity of the entity for the action
          to start.</p></li><li><p><em class="emphasis"><span class="literal">maxEntitySpeed</span>
          (section <span class="literal">trigger</span>)</em></p><p>Determines the maximum velocity of the entity for the action
          to start.</p></li><li><p><em class="emphasis"><span class="literal">minEntityAux1</span>
          (section <span class="literal">trigger</span>)</em></p><p>Determines the minimum pitch of the entity for the action to
          start.</p></li><li><p><em class="emphasis"><span class="literal">maxEntityAux1</span>
          (section <span class="literal">trigger</span>)</em></p><p>Determines the maximum pitch of the entity for the action to
          start.</p></li><li><p><em class="emphasis"><span class="literal">minModelYaw</span> (section
          <span class="literal">trigger</span>)</em></p><p>Determines the minimum yaw of the model for the action to
          start.</p></li><li><p><em class="emphasis"><span class="literal">maxEntityYaw</span> (section
          <span class="literal">trigger</span>)</em></p><p>Determines the maximum yaw of the model for the action to
          start.</p></li><li><p><em class="emphasis"><span class="literal">capsOn</span> (section
          <span class="literal">trigger</span>)</em></p><p>Determines which special case character states need to be on
          for the action to start.</p></li><li><p><em class="emphasis"><span class="literal">capsOff</span> (section
          <span class="literal">trigger</span>)</em></p><p>Determines which special case character states need to be off
          for the action to start.</p></li><li><p><em class="emphasis"><span class="literal">cancel</span> (section
          <span class="literal">match</span>)</em></p><p>This section defines the criteria used to determine when to
          stop an action.</p></li><li><p><em class="emphasis"><span class="literal">minEntitySpeed</span>
          (section <span class="literal">cancel</span>)</em></p><p>Determines the minimum velocity of the entity for the action
          to stop.</p></li><li><p><em class="emphasis"><span class="literal">maxEntitySpeed</span>
          (section <span class="literal">cancel</span>)</em></p><p>Determines the maximum velocity of the entity for the action
          to stop.</p></li><li><p><em class="emphasis"><span class="literal">minEntityAux1</span>
          (section <span class="literal">cancel</span>)</em></p><p>Determines the minimum pitch of the entity for the action to
          stop.</p></li><li><p><em class="emphasis"><span class="literal">maxEntityAux1</span>
          (section <span class="literal">cancel</span>)</em></p><p>Determines the maximum pitch of the entity for the action to
          stop.</p></li><li><p><em class="emphasis"><span class="literal">minModelYaw</span> (section
          <span class="literal">cancel</span>)</em></p><p>Determines the minimum yaw of the model for the action to
          stop.</p></li><li><p><em class="emphasis"><span class="literal">maxEntityYaw</span> (section
          <span class="literal">cancel</span>)</em></p><p>Determines the maximum yaw of the model for the action to
          stop.</p></li><li><p><em class="emphasis"><span class="literal">capsOn</span> (section
          <span class="literal">cancel</span>)</em></p><p>Determines which special case character states need to be on
          for the action to stop.</p></li><li><p><em class="emphasis"><span class="literal">capsOff</span> (section
          <span class="literal">cancel</span>)</em></p><p>Determines which special case character states need to be off
          for the action to stop.</p></li><li><p><em class="emphasis"><span class="literal">scalePlaybackSpeed</span>
          (section <span class="literal">match</span>)</em></p><p>Specifies that the animation playback speed should be scaled
          as a function of the entity's speed. This setting requires
          isMovement.</p></li><li><p><em class="emphasis"><span class="literal">feetFollowDirection</span>
          (section <span class="literal">match</span>)</em></p><p>Specifies that the model should turn to track the Entity. In
          practice this means while this action is matched, the model rotates
          on the spot instead of playing a turning action.</p></li><li><p><em class="emphasis"><span class="literal">oneShot</span> (section
          <span class="literal">match</span>)</em></p><p>Specifies that the action will only be selected for playing
          once in a row by the action matcher. Note the distinction between
          this and filler, where filler is not related to the action
          matcher.</p></li><li><p><em class="emphasis"><span class="literal">promoteMotion</span>
          (section <span class="literal">match</span>)</em></p><p>Specifies that the motion of the root node within the
          animation should affect the model's position (and the owner entity's
          position, if the entity is client-controlled). This setting must be
          enabled for isImpacting or isMovement actions to work correctly.
          This setting cannot be used with filler.</p></li></ul></div><p>The Python interface to a model's action queue allows actions to
      be played directly on that model, or a set of actions to be queued and
      played in sequence. Callback functions can be defined and played when
      actions are finished.</p><p>In Python, a model can be easily created and an action played on
      it, as illustrated in the example below:</p><pre class="programlisting">class Jogger( BigWorld.Entity ):
  ....
def __init__( self ):
  self.model = BigWorld.Model( "jogger.model" )

def warmUp( self ):
  self.model.action( "StretchLegs" )()
...</pre><p><span class="citetitle">Model creation in Python</span></p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Debugging_Animations"></a>9.1.5.1.&nbsp;Debugging animations</h4></div></div></div><p>If a model is not being animated as it is supposed to, it is
        useful to display the Action Queue graph in the Python console.</p><p>This is can be done by calling
        <span class="literal">BigWorld.debugAQ()</span> method, which can receive two
        kinds of arguments:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">PyModel</span></em></p><p>Displays the graph for the specified model, with the blend
            weight of each action. Each action is represented in a different,
            arbitrarily chosen, colour.</p></li><li><p><em class="emphasis">None</em></p><p>Switches off the graph display.</p></li></ul></div><div class="informalfigure"><div class="mediaobject"><img src="images/python_console_display_action_queue.png"><span class="caption"><p>Python console displaying Action Queue's debugging
            graph</p></span></div></div><p>The graph in the picture above displays the execution on the
        TurnLeft animation (in green) and the Idle one (in red). We can
        determine the animations that were being played in each labelled point
        in the graph:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">A</em> &#8212; 100% of the
            <span class="literal">Idle</span> animation is being played.</p></li><li><p><em class="emphasis">Between A and B</em> &#8212;
            <span class="literal">Idle</span> animation is being blended in with
            <span class="literal">TurnLeft</span> animation.</p></li><li><p><em class="emphasis">B</em> &#8212; 50% of the
            <span class="literal">Idle</span> animation is being played, and 50% of the
            <span class="literal">TurnLeft</span> animation is being played.</p></li><li><p><em class="emphasis">C</em> &#8212; 100% of the
            <span class="literal">TurnLeft</span> animation is being played.</p></li></ul></div><p>For more details, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>ModelEditor offers the same functionality for the model. For
          details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_ModelEditor" class="olink"><i>ModelEditor</i></a> <span class="symbol">&#8594;</span>
          <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_me_Panel_Summary" class="olink">Panel summary</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_me_Actions_Panel" class="olink">Actions panel</a>.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Action_Matcher"></a>9.1.6.&nbsp;Action Matcher</h3></div></div></div><p>Given a model, an action queue, and a set of actions, all
      behaviour of a game object/character can be specified by event-driven
      calls on the Action Queuer. This ends up with a heavy overhead, as many
      changes in object state need to directly call the object and solve which
      animation should be played.</p><p>The solution to this problem is to internalise most of the
      behaviour of a character in a system called the Action Matcher, which
      automatically updates an object's motion based on the object's state. It
      is a simple pattern matcher, picking an animation based on model's
      attributes such as speed, direction, etc.</p><p>State parameters such as speed, rotation, or power are exposed to
      the Action Matcher, which then selects the action that best maps to
      these parameters. This frees the game from having to handle many aspects
      of animation, allowing it to only have to update state parameters, such
      as position.</p><p>When there are no (unblended) actions in the Action Queue for a
      model (within the player's AoI), the Action Matcher takes over and plays
      an 'idle' action. It triggers these 'idle' animations to give the game
      world more life, since real living things are not still. It can also be
      used to automate menial animation tasks.</p><p>This class looks at all the actions that have a match section (see
      XML example in section <a href="#xref_Action_Queue" title="9.1.5.&nbsp;Action Queue">Action Queue</a>,
      whose constraints are satisfied for the Action Matcher object
      controlling the model.</p><p>Scriptable constraints are tested against the capabilities bit
      fields <span class="literal">capsOn</span> and <span class="literal">capsOff</span>. The
      Action Matcher for a model has a set of capability bits, which value is
      controlled by script. An action will only be matched if all the capsOn
      bits are on and all the capsOff bits are off in the Action Matcher's
      set.</p><p>It then looks at the change in pose (position and orientation
      &#8212; as set by the filter) and selects the first action that matches
      this change for the time over which the change occurred. The trigger
      constraints are used to test most actions. The cancel constraints are
      used if the action that matched last frame is encountered. This feature
      is intended primarily to reduce action hysteresis.</p><p>The update function of an action-matched object takes the previous
      updated position of the object, chooses the best matched action from its
      matched action list, then plays the animation back at the correct speed
      to smoothly link action with speed. As a game character starts moving
      faster, the Action Matcher may choose a faster running cycle to play
      back and increase its playback speed to precisely match speed so no foot
      sliding is seen.</p><p>This method allows an AI system to define behaviour with respect
      to a few variables such as orientation, speed, and aiming direction, and
      the Action Matcher will convert these updated parameters into a smoothly
      moving character.</p><p>In a client/server architecture where position and orientation are
      updated over a network, the Action Matcher (combined with a filter) can
      automatically compensate for position jumps caused by network lag by
      having characters realistically run faster to the latest updated
      position.</p><p>When an action is loaded, its data is augmented with the effect on
      pose that performing the action would have on the root node. This
      information is used for the matching described above.</p><p>Now that an action has been selected, it is passed to the Action
      Queue. If the action supplied is the same as the previous action, it
      continues to be played in the normal fashion (<em class="emphasis">i.e.</em>,
      <span class="literal">frame += fps*deltaTime</span>). Otherwise, it is blended in
      over a few frames while the other is blended out.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e3425"></a>9.1.6.1.&nbsp;Using the Action Matcher</h4></div></div></div><p>Each action designed to be matched must define a &lt;match&gt;
        section. These are added via ModelEditor using the Actions window. The
        matching parameters are divided in two:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Trigger parameters</em> &#8212;
            Define when an action can be started, and</p></li><li><p><em class="emphasis">Cancel section</em> &#8212;
            Defines when an action should be stopped.</p></li></ul></div><p>The minEntitySpeed and minEntitySpeed tags in each section
        define the velocities in which actions can and cannot be triggered or
        cancelled.</p><p>The auxiliary parameters can be used to define a pitch range
        that is used to match action. The minModelYaw and maxModelYaw tags
        define a yaw range. The main matching parameters define speed and
        orientation ranges that the action applies to, and also a user-defined
        set of matching flags that are used with special case character
        states. These flags can be used to set whether a game character is not
        using the basic action set, such as being injured or being
        angry.</p><p>The BigWorld engine uses the matchCaps parameter to store the
        bitwise flag set of an action. At any given time, the model itself
        will have an on/off flag set representing the state of these states,
        and this is tested against each action's matchCaps per frame.</p><p>A set of user-defined action states should be defined (created
        as a text file or as comment section in model file). A simple example
        is given in the list below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Capability flag: 1</em> &#8212;
            State: Angry</p></li><li><p><em class="emphasis">Capability flag: 2</em> &#8212;
            State: Happy</p></li><li><p><em class="emphasis">Capability flag: 3</em> &#8212;
            State: Sad</p></li></ul></div><p>A set of angry animation can now be accessed using the action
        matcher by just adding the angry flag to the current matchCaps.</p><p>In Python code, a simple example of a character that should now
        move and behave in an angry manner is shown below:</p><pre class="programlisting">class AngryMan( BigWorld.Entity ):
  ....
def onEnterWorld( self, prereqs ):
  self.am = BigWorld.ActionMatcher( self )

def enterAngryMode( self ):
  self.am.matchCaps = self.am.matchCaps + [1]
...</pre><p><span class="citetitle">Python implementation of character in angry
        mode</span></p><p>By using the Action Matcher this way, a character's natural
        motion can be fleshed out without having to explicitly call any
        function to play animations. Specific event-based actions should still
        be called directly via the Action Queue structure, but the background
        behaviour of the character can be completely defined using the
        ModelEditor tool and setting matching flags appropriately in the code
        base.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3476"></a>9.1.7.&nbsp;Trackers</h3></div></div></div><p>A tracker applies inverse kinematics to nodes in the entity's
      model so that they appear to point to a position defined by a given
      'target' entity. An entity may have any number of trackers.</p><p>To add a tracker to an entity, use a script call like this:</p><pre class="programlisting">tracker = BigWorld.Tracker()
tracker.dirProvider = DiffDirProvider( 
  self.focalMatrix, target.focalMatrix )
tracker.nodeInfo = BigWorld.TrackerNodeInfo(
  model,
  primaryNode, 
  secondaryNodeList, 
  pointingNodeName,
  minPitch, maxPitch,
  minYaw, maxYaw,
  angularVelocity )
self.model.tracker = tracker</pre><p><span class="citetitle">Adding tracker in Python</span></p><p>The parameters for the <span class="literal">BigWorld.TrackerNodeInfo</span>
      method are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">model</span></em></p><p>PyModel that owns the nodes that the tracker will
          affect.</p></li><li><p><em class="emphasis"><span class="literal">primaryNode</span></em></p><p>Primary node reference.</p><p>Node references are built up from the entity's independent
          model (the first one if there are multiple) following a path of
          attachment points and ending in a node name. This allows trackers to
          transparently work through attached models
          (<em class="emphasis">i.e.</em>, they are treated as if they are welded
          onto the model's skeleton).</p><p>This is more important for Supermodels (for more details, see
          <a href="#xref_SuperModel" title="10.3.&nbsp;SuperModel">SuperModel</a>), where characters are built out
          of multiple model parts.</p></li><li><p><em class="emphasis"><span class="literal">secondaryNodeList</span></em></p><p>List of secondary nodes, containing tuples of the form (node,
          weight).</p><p>These have the same transform performed on them as on the
          primary node, in proportion with the weight amount. Actually, all
          the weights (including the primary node, with a weight of 1.0) are
          summed, and each node gets their weight proportion of this total
          applied to them.</p></li><li><p><em class="emphasis"><span class="literal">pointingNodeName</span></em></p><p>Name of the node providing the frame of reference used for
          tracker manipulations.</p><p>If the node specified is not present, then the model's scene
          root is used.</p></li><li><p><em class="emphasis"><span class="literal">minPitch</span>,
          <span class="literal">maxPitch</span>, <span class="literal">minYaw</span>,
          <span class="literal">maxYaw</span></em></p><p>Limits on the turn that the tracker is permitted to apply, in
          degrees.</p></li><li><p><em class="emphasis"><span class="literal">angularVelocity</span></em></p><p>Speed at which a tracker will turn the PyModelNode instances
          that it influences, in degrees per second.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3558"></a>9.1.8.&nbsp;Timers and Traps</h3></div></div></div><p>These are generic helper services provided to entity
      scripts.</p><p>A script can set timers to have itself called-back at a certain
      time, as illustrated in the example below:</p><pre class="programlisting">BigWorld.callback( afterTime, fn )</pre><p>Traps use a slightly different interface:</p><pre class="programlisting">trapRef = self.addTrap( radius, function )</pre><p>A trap goes off if any entity wanders within the given radius of
      the entity it is created on, and can be cancelled with the self.delTrap
      method.</p><p>There are two other types of trap, optimised for their specific
      need, as discussed in the following sections.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e3575"></a>9.1.8.1.&nbsp;Pot</h4></div></div></div><p>A Pot is a 'player-only-trap', and is triggered only by the
        player entity. Due to this, it is a lot cheaper to use than a general
        trap.</p><p>A Pot is added given a matrix provider, a radius, and a script
        callback for triggering.</p><pre class="programlisting">potHandle = BigWorld.addPot( trapMatrix, radius, callback )</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e3584"></a>9.1.8.2.&nbsp;Mat</h4></div></div></div><p>A Mat is a 'matrix trap', and is triggered when an area is
        triggered by another. This makes sense only because matrix providers
        are dynamic. The areas are defined as:</p><div class="itemizedlist"><ul type="disc"><li><p>Source-matrix translation and a bounding area given by the
            scale of the x-, y- and z-axes in that matrix.</p></li><li><p>Destination-matrix translation of destination matrix
            (treated as a point).</p></li></ul></div><p>A Mat is defined in Python as listed below:</p><pre class="programlisting">matHandle = BigWorld.addMat( sourceMatrix, callback, destMatrix )</pre></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Personality_Script"></a>9.2.&nbsp;Personality script</h2></div></div></div><p>The personality script is a Python script used to handle several
    callbacks from the BigWorld engine for initialisation, cleanup, input
    handling, and environment changes. It can also implement client
    functionality that does not belong to any particular entity in the game,
    such as the game start screen.</p><p>Its name is defined in the file specified by the
    <span class="literal">resources.xml</span>'s <span class="literal">engineConfigXML</span> tag,
    in the <span class="literal">personality</span> tag &#8212; for more details, see
    <a href="#xref_File_engine_config_xml" title="1.4.2.&nbsp;File <engine_config&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span></a>.</p><p>The personality script generally declares a class to contain all
    data to be shared by functions in the script, and declares a global
    variable using the constructor of that class. For example, a personality
    script may include the following code:</p><pre class="programlisting">class SharedData:
  def __init__( self ):
    self.settings = ""

# initialise the shared data object for this personality script
sd = SharedData()

# This callback is called by BigWorld when initialising
def init( configSect ):
  # save the configSect object for later use
  sd.configSect = configSect</pre><p><span class="citetitle">Example of personality script</span></p><p>The sections below describe the available personality
    callbacks.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_init"></a>9.2.1.&nbsp;<span class="literal">init</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">init(scriptsConfig, engineConfig, preferences, loadingScreenGUI = None)</pre><p>The script is called once, when the engine initialises, and
      receives the arguments below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">scriptsConfig</span></em></p><p><span class="literal">PyDataSection</span> object containing data from
          XML file defined in <span class="literal">resources.xml</span>'s
          <span class="literal">scriptsConfigXML</span> tag (for details, see <a href="#xref_File_scripts_config_xml" title="1.4.3.&nbsp;File <scripts_config&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;scripts_config&gt;</code></em>.xml</span></a>).</p></li><li><p><em class="emphasis"><span class="literal">engineConfig</span></em></p><p><span class="literal">PyDataSection</span> object containing data from
          XML file defined in <span class="literal">resources.xml</span>'s
          <span class="literal">engineConfigXML</span> tag (for details, see <a href="#xref_File_scripts_config_xml" title="1.4.3.&nbsp;File <scripts_config&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;scripts_config&gt;</code></em>.xml</span></a>).</p></li><li><p><em class="emphasis"><span class="literal">preferences</span></em></p><p><span class="literal">PyDataSection</span> object containing data from
          the <span class="literal">scriptsPreference</span> section of the file
          specified in the <span class="literal">preferences</span> tag of the file
          specified in <span class="literal">resources.xml</span>'s
          <span class="literal">engineConfigXML</span> tag (for details, see <a href="#xref_File_preferences_xml" title="1.4.4.&nbsp;File <preferences&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;preferences&gt;</code></em>.xml</span></a>).</p></li><li><p><em class="emphasis"><span class="literal">loadingScreenGUI</span></em></p><p>Optional argument representing the loading screen GUI, if one
          was defined in <span class="literal">resources.xml</span> (for details, see
          <a href="#xref_File_preferences_xml" title="1.4.4.&nbsp;File <preferences&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;preferences&gt;</code></em>.xml</span></a>).</p></li></ul></div><p>The available read functions are listed below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">readBool</span></em></p></li><li><p><em class="emphasis"><span class="literal">readFloat</span></em></p></li><li><p><em class="emphasis"><span class="literal">readFloats</span></em></p></li><li><p><em class="emphasis"><span class="literal">readInt</span></em></p></li><li><p><em class="emphasis"><span class="literal">readInts</span></em></p></li><li><p><em class="emphasis"><span class="literal">readMatrix34</span></em></p></li><li><p><em class="emphasis"><span class="literal">readString</span></em></p></li><li><p><em class="emphasis"><span class="literal">readStrings</span></em></p></li><li><p><em class="emphasis"><span class="literal">readVector2</span></em></p></li><li><p><em class="emphasis"><span class="literal">readVector2s</span></em></p></li><li><p><em class="emphasis"><span class="literal">readVector3</span></em></p></li><li><p><em class="emphasis"><span class="literal">readVector3s</span></em></p></li><li><p><em class="emphasis"><span class="literal">readVector4</span></em></p></li><li><p><em class="emphasis"><span class="literal">readVector4s</span></em></p></li><li><p><em class="emphasis"><span class="literal">readWideString</span></em></p></li><li><p><em class="emphasis"><span class="literal">readWideStrings</span></em></p></li></ul></div><p>To read data from PyDataSection, call the read function that
      relates to the data type, passing in the section name as the first
      argument, and the default value as the second argument. The plural read
      functions (ending in 's') read the contents of all matching subsections
      of the specified section, and return the results as tuple of values. You
      can refer to sub-sections by using the forward slash.</p><p>For example:</p><pre class="programlisting">username = userPreferences.readString("login/username", "guest")</pre><p>You can also reference to subsections of a PyDataSection by
      calling the section name prefixed with an underscore.</p><p>For example:</p><pre class="programlisting">username = userPreferences._login._username.asString</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3802"></a>9.2.2.&nbsp;<span class="literal">fini</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">fini()</pre><p>This is script is called when the client engine shuts down. It is
      used to do any cleanup required before the client exits. This is a good
      place to perform a logout procedure on the player to logout
      gracefully.</p><p>For example:</p><pre class="programlisting"># note: you must set up a logOff method as a base method in the
# def file of the class that the player is using.
def fini():
  try:
    BigWorld.player().base.logOff()
  except:
    pass</pre><p><span class="citetitle">Example of <span class="literal">fini()</span>
      implementation</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3822"></a>9.2.3.&nbsp;<span class="literal">handleKeyEvent</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">handleKeyEvent( event )</pre><p>The event argument is a PyKeyEvent which contains information
      about the key event. See the Python Client API document for
      details.</p><p>Generally, several systems can process keyboard input, so the
      arguments are passed to a <span class="literal">handleKeyEvent</span> method on
      each system in turn, until one returns a Boolean value of True,
      indicating that it has processed the key event.</p><p>For example:</p><pre class="programlisting">def handleKeyEvent( event ):
  global rds

  # give the chat console a go first
  if rds.chat.editing:
    if rds.chat.handleKeyEvent( event ):
      return True
  # try the gui
  if GUI.handleKeyEvent( event ):
    return 1
  # now do our custom keys
  if not event.isKeyDown(): return False # we are not interested in key releases
  if event.key == KEY_RETURN and event.modifiers == 0:
    rds.chat.edit( True )  # bring up the chat console
    return True

  # return False because the key event has not been handled
  return False</pre><p><span class="citetitle">Example of <span class="literal">handleKeyEvent()</span>
      implementation</span></p><p>Note that the engine also calls the
      <span class="literal">handleKeyEvent</span> method on the entity that the player
      is controlling. All keys related to player control are handled
      there.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3852"></a>9.2.4.&nbsp;<span class="literal">handleMouseEvent</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">handleMouseEvent( event )</pre><p>This script is called whenever the mouse moves, and is given an
      instance of PyMouseEvent. It operates similarly to
      handleKeyEvent.</p><p>For example:</p><pre class="programlisting">def handleMouseEvent( event ):

  # try the gui
  if GUI.handleMouseEvent( event ):
    return True

  # return False because the mouse event has not been handled
  return False</pre><p><span class="citetitle">Example of <span class="literal">handleMouseEvent()</span>
      implementation</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3872"></a>9.2.5.&nbsp;<span class="literal">handleAxisEvent</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">handleAxisEvent( event )</pre><p>This script is called whenever a joystick axis event occurs, and
      is given an instance of PyAxisEvent.</p><p>For example:</p><pre class="programlisting">def handleAxisEvent( event ):

  # try the GUI
  if GUI.handleAxisEvent( event ):
    return True

  # return False because the axis event has not been handled
  return False</pre><p><span class="citetitle">Example of <span class="literal">handleAxisEvent()</span>
      implementation</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3892"></a>9.2.6.&nbsp;<span class="literal">handleIMEEvent</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">handleIMEEvent( event )</pre><p>This is called when an Input Method Editor (IME) related event
      occurs and is used to update the GUI respectively, and is given a
      <code class="code">PyIMEEvent</code> object as it's first parameter. See <a href="#xref_IME" title="Chapter&nbsp;18.&nbsp;Input Method Editors (IME)"><i xmlns:xlink="http://www.w3.org/1999/xlink">Input Method Editors (IME)</i></a> for details on IME
      support.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3907"></a>9.2.7.&nbsp;<span class="literal">handleLangChangeEvent</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">handleLangChangeEvent()</pre><p>This event occurs whenever the current input language has been
      changed by the user. It is useful for tasks such as updating language
      indicators on GUI edit fields.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3917"></a>9.2.8.&nbsp;<span class="literal">onChangeEnvironments</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">onChangeEnvironments( inside )</pre><p>This script is a callback acknowledging the environment type the
      player is currently in.</p><p>Currently there are only inside and outside environment types. The
      argument is a Boolean value indicating whether the player is inside or
      not. This may be useful for modifying the behaviour of the camera in
      third person mode.</p><p>For example:</p><pre class="programlisting">def onChangeEnvironments( inside ):
  global sd
  sd.inside = inside
  sd.updatePivotDist()</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3933"></a>9.2.9.&nbsp;<span class="literal">onGeometryMapped</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">onGeometryMapped(spaceID, spacePath)</pre><p>This callback method tells the player entity about changes to the
      geometry in a space. It is called when geometry is mapped into any of
      the currently existing spaces on the client. The space ID and the name
      of the space geometry are passed as parameters.</p><p>The first parameter is the ID of the space the geometry is being
      mapped in to. The second parameter is the name describing the space's
      geometry.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3945"></a>9.2.10.&nbsp;<span class="literal">onRecreateDevice</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">onRecreateDevice ()</pre><p>This script is a callback alerting the scripts that the Direct3D
      device has been recreated. This often occurs when the screen resolution
      is changed.</p><p>This callback was introduced primarily so that scripts can
      re-layout their GUI component scripts, but it is also useful for
      recreating any static <span class="literal">PyModelRenderer</span> textures (since
      these do not automatically update, unless they are dynamic).</p><p>For example:</p><pre class="programlisting">def onRecreateDevice():
  (width,height) = GUI.screenResolution()
  myGuiController.doLayout( width, height )
  myRenderers.recreateTextures()</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3964"></a>9.2.11.&nbsp;<span class="literal">onTimeOfDayLocalChange</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">onTimeOfDayLocalChange( gameTime, secondsPerGameHour )</pre><p>This script is a callback to allow scripts to be notified of
      changes in the game time.</p><p>It is passed two floats as arguments: the first one is the game
      time in seconds, and the second is the number of real-time seconds per
      game hour.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e3976"></a>9.2.12.&nbsp;<span class="literal">start</span></h3></div></div></div><p>The callback has the following syntax:</p><pre class="programlisting">start()</pre><p>This script is called after the engine has initialised, and used
      to start the game. It may be used to bring up a start menu, or login
      screen.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Models"></a>Chapter&nbsp;10.&nbsp;Models</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e4015">10.1. Performance</a></span></dt><dt><span class="section"><a href="#xref_Hard_Points">10.2. Hard Points</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4079">10.2.1. Naming scheme</a></span></dt><dt><span class="section"><a href="#d0e4157">10.2.2. How it works</a></span></dt><dt><span class="section"><a href="#d0e4164">10.2.3. Syntax</a></span></dt><dt><span class="section"><a href="#d0e4181">10.2.4. Data</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_SuperModel">10.3. SuperModel</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4256">10.3.1. Design</a></span></dt><dt><span class="section"><a href="#d0e4272">10.3.2. SuperModel classes</a></span></dt></dl></dd></dl></div><p>For the purposes of the BigWorld client, a model is a self-contained
  unit of geometry that can draw itself into a 3D scene at the location of a
  world-space transform matrix. Moreover, all models may have animations that
  alter their appearance over time &#8212; some models explicitly support animations
  of their nodes (which are skinned), whereas the others are animated by
  displaying alternate geometries.</p><p>Moo, the BigWorld 3D engine, currently exports three kinds of objects
  that may be used as models:</p><div class="itemizedlist"><ul type="disc"><li><p>Meshes with skeletons.</p></li><li><p>Meshes without skeletons.</p></li><li><p>Billboards (a special form of simple geometry).</p></li></ul></div><p>However, the model concept in the BigWorld client encapsulates
  anything that fits into the definition above, and the implementation is
  easily extended to incorporate new kinds of objects.</p><p>Moo names its meshes <em class="emphasis">visuals</em> (visuals actually
  include a good deal more than a simple polygon mesh. They can have groups of
  meshes, bones, envelopes, materials, and a hierarchical skeleton too) and
  <span class="literal">.visual</span> files can be readily created from a 3ds Max model
  using a BigWorld exporter. Node-based animations can also be created with
  the exporter. A .model file can then be created with the tool ModelEditor,
  so that the visual and its animations are tied together. Model files that
  are billboards or static meshes (and their animations) can also be created
  with ModelEditor.</p><p>A model file can also specify a simpler parent file to be used when
  drawn in the distance. Chains of parent model files thus formed are known as
  level-of-detail (LOD) chains.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4015"></a>10.1.&nbsp;Performance</h2></div></div></div><p>In order to improve rendering performance, a model can be flagged in
    ModelEditor to be batch rendered, which results in the creation of the
    <span class="literal">batched</span> tag in the generated model file (for details,
    see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s
    section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_ModelEditor" class="olink"><i>ModelEditor</i></a> <span class="symbol">&#8594;</span>
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_me_Panel_Summary" class="olink">Panel summary</a> <span class="symbol">&#8594;</span>
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_me_Object_Properties_Panel" class="olink">Object Properties panel</a>).</p><p>The batch rendering works by caching per-instance data (essentially
    lighting conditions and transforms) at traverse time, and once the scene
    has been traversed, rendering all instances at the same time, only
    updating the data necessary for each render. This saves the engine from
    setting vertices, indices, and textures multiple times for batched models.
    It does use a bit more memory, but gives a considerable performance
    boost.</p><p>It is advisable to use the batch flag on models with many instances
    of it in the scene. In FantasyDemo, the batch flag is used on trees,
    guards, striffs, chickens, and the guard's guns. Please note that the flag
    does not affect models that use tints.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Hard_Points"></a>10.2.&nbsp;Hard Points</h2></div></div></div><p>Hard points, or attachment points, can be conceived as logical
    patches of Velcro that allow us to stick a gun in a hand, sling a backpack
    over a shoulder, or place a security camera on a turret. The artists must
    embed hard points in their .visual files using dummy nodes.</p><p>Hard points use well-defined names, preceded by 'HP_' prefix, so
    that entities can scan for hard point nodes. The significant information
    is:</p><div class="itemizedlist"><ul type="disc"><li><p>Name.</p></li><li><p>Position.</p></li><li><p>Orientation.</p></li></ul></div><p>This information allows the developer to attach any object to any
    other, within the constraints of game logic.</p><p>Examples of hard points include:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="literal">HP_LeftHand</span></p></li><li><p><span class="literal">HP_RightHand</span></p></li><li><p><span class="literal">HP_Shoulder</span></p></li><li><p><span class="literal">HP_Belt1</span></p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4079"></a>10.2.1.&nbsp;Naming scheme</h3></div></div></div><p>In order to avoid the need for an intermediate step, there needs
      to be an explicit pairing between character hard points and item hard
      points. Every item needs a hard point for every specific way that it can
      be held.</p><p>As an example, listed below are the hard points for a human
      character and a gun.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">In
          <span class="literal">human.model</span>:</em></p><div class="itemizedlist"><ul type="circle"><li><p><span class="literal">HP_Left_Hand</span></p></li><li><p><span class="literal">HP_Right_Hand</span></p></li><li><p><span class="literal">HP_Belt_1</span></p></li><li><p><span class="literal">HP_Belt_2</span></p></li><li><p><span class="literal">HP_Belt_3</span></p></li><li><p><span class="literal">HP_Belt_4</span></p></li><li><p><span class="literal">HP_Shoulder</span></p></li><li><p><span class="literal">HP_Blade_Lower</span></p></li><li><p><span class="literal">HP_Blade_Upper</span></p></li></ul></div></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">In
          <span class="literal">gun.model</span>:</em></p><div class="itemizedlist"><ul type="circle"><li><p><span class="literal">HP_Left_Hand</span></p></li><li><p>H<span class="literal">P_Right_Hand</span></p></li><li><p><span class="literal">HP_Belt_2</span></p></li><li><p><span class="literal">HP_Shoulder</span></p></li></ul></div></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4157"></a>10.2.2.&nbsp;How it works</h3></div></div></div><p>The (client-side) Entity class provides a list of hard points, but
      only if asked by the specializing class. For example, when a model is
      loaded, it will find all nodes prefixed with (for instance) 'HP_'. These
      are then stored in a hardPoint list that is owned by the model.</p><p>When an item is equipped, the entity/game arbiter will be asked to
      match up the item with the correct hard point. For example, if the 'next
      weapon' button is pressed, the next weapon in the inventory can be
      attached to the right hand hard point.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4164"></a>10.2.3.&nbsp;Syntax</h3></div></div></div><p>The syntax for using hard points from Python is elegant and
      powerful. To attach model gun to model avatar on hard point hand, use
      the following syntax:</p><pre class="programlisting">avatar.hand = gun</pre><p>A model is checked when it is attached to ensure that it is not
      attached elsewhere. To retrieve the model attached to avatar's hand,
      simply use:</p><pre class="programlisting">model = avatar.hand</pre><p>If no model is attached, then None is returned.</p><p>The model is attached by reference, not by copy, so anything that
      can be done to the original model reference can be done to the reference
      retrieved from a hard point.</p><p>For example, gun.Shoot() and avatar.hand.Shoot() have the same
      effect.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4181"></a>10.2.4.&nbsp;Data</h3></div></div></div><p>A model definition is an XML file specifying:</p><div class="itemizedlist"><ul type="disc"><li><p>A base model definition reference (optional).</p></li><li><p>The visual defining the mesh.</p></li><li><p>The animations the mesh can use.</p></li><li><p>The actions that the model can perform (for more details, see
          <a href="#xref_Action_Queue" title="9.1.5.&nbsp;Action Queue">Action Queue</a>).</p></li></ul></div><p>The ModelEditor tool is used to create a .model file that links an
      object's geometry to its animations and defines the sets of
      animations/actions that are possible to play on this object.</p><p>As with all resource files in the BigWorld framework, .model files
      are in XML format. They are hierarchical and inherit data from their
      parent(s), in this way basic animations that apply to a large set of
      characters can be isolated from more character-specific animations
      without having to be duplicated.</p><p>The example below defines a very simple model:</p><pre class="programlisting">&lt;jogger.model&gt;

  &lt;nodefullVisual&gt;  jogger  &lt;/nodefullVisual&gt;
  &lt;parent&gt;          biped   &lt;/parent&gt;

  &lt;animation&gt;
    &lt;name&gt;      jog         &lt;/name&gt;
    &lt;frameRate&gt; 30.0        &lt;/frameRate&gt;
    &lt;nodes&gt;     jogAnim     &lt;/nodes&gt;
    &lt;alpha&gt;
      &lt;Torso&gt;   0.0  &lt;/Torso&gt;
      &lt;Pelvis&gt;  1.0  &lt;/Pelvis&gt;
    &lt;/alpha&gt;
  &lt;/animation&gt;

  &lt;action&gt;
    &lt;name&gt;          BIPED_JOG  &lt;/name&gt;
    &lt;animation&gt;     jog        &lt;/animation&gt;
    &lt;blendInTime&gt;   0.300000   &lt;/blendInTime&gt;
    &lt;blendOutTime&gt;  0.300000   &lt;/blendOutTime&gt;
    &lt;filler&gt;        false      &lt;/filler&gt;
    &lt;blended&gt;       false      &lt;/blended&gt;
    &lt;isMovement&gt;    true       &lt;/isMovement&gt;
    &lt;isCoordinated&gt; false      &lt;/isCoordinated&gt;
    &lt;isImpacting&gt;   true       &lt;/isImpacting&gt;
    &lt;match&gt;
      &lt;trigger&gt;
        &lt;minEntitySpeed&gt; 1.0  &lt;/minEntitySpeed&gt;
        &lt;maxEntitySpeed&gt; 3.0  &lt;/maxEntitySpeed&gt;
        &lt;capsOn&gt;         16   &lt;/capsOn&gt;
      &lt;/trigger&gt;
    &lt;/match&gt;
  &lt;/action&gt;
&lt;jogger.model&gt;</pre><p><span class="citetitle">Example of <span class="literal">.model</span>
      file</span></p><p>This file describes a character (<span class="literal">jogger</span>) which
      has a geometry defined by the visual file jogger and has a standard set
      of biped actions via the <span class="literal">&lt;parent&gt;</span> tag, which
      may include walk, run, and jump animations, but also specifies a jog
      animation.</p><p>The animation section includes:</p><div class="itemizedlist"><ul type="disc"><li><p>Name of the animation.</p></li><li><p>Frame rate at which the animation should normally be played
          at.</p></li><li><p>Tag <span class="literal">&lt;nodes&gt;</span>, which refers to the name
          of the animation file that contains the raw keyframe data.</p></li></ul></div><p>The <span class="literal">&lt;action&gt;</span> section describes the action
      name that is used to play this action from the Python code.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_SuperModel"></a>10.3.&nbsp;SuperModel</h2></div></div></div><p>A SuperModel is a collection of models that need to function as one.
    The SuperModel class is a utility class that forms a flexible basis for
    modules that want to use models. It is used for the static models
    specified in chunks, and the dynamic models that entities can
    manipulate.</p><p>The SuperModel provides an efficient representation (both in memory
    and in CPU) of a conceptual model. The supermodel is made up of selectable
    parts, and these parts have an inheritance tree for specifying animations,
    actions, material overrides, and most importantly, lower level of detail
    (LOD) parts that may be substituted at appropriate distances.</p><p>The supermodel brings all these parts and their adornments together
    into one conceptual model that automatically takes care of the complexity
    that arises from the multi-part and LODing features.</p><p>An example of the most basic SuperModel is a single mesh, which has
    been exported from 3ds Max using the BigWorld exporter; into the format
    understood by the 3D engine Moo.</p><p>SuperModels do not live in the scene graph or in chunks, and provide
    no interfaces to the scripting system. These matters are left up to
    higher-level classes, which are encouraged to use SuperModel for all their
    model needs.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4256"></a>10.3.1.&nbsp;Design</h3></div></div></div><p>There are model files, with the .model extension, but there are no
      explicit SuperModel files.</p><p>There is the SuperModel class, which holds together and controls
      the animation and rendering of a number of models. A SuperModel is
      created based on information in chunk and model files (these are
      instance-like classes &#8212; there is nothing analogous to
      PyModelInfo.).</p><p>Using LOD ratios, the SuperModel class can manage the transition
      between, say, an avatar being rendered at a high LOD using three
      separate models, to it being rendered at a low LOD using just
      one.</p><p>Animations are accumulated on the same inheritance hierarchy, and
      the animation most appropriate to the current LOD level is used. All the
      animations for all the LOD levels are interpreted and selected from a
      flat namespace. Attempting to play an animation that does not exist (or
      does not exist at the current LOD level) selects an infinite length
      animation of the model's initial pose. Care must be taken to ensure that
      multi-model SuperModels do not waste time animating unnecessarily
      (<em class="emphasis">e.g.</em>, when all the small parts have an animation
      overriding the whole part's animation, it would be a waste of time to
      apply the whole part's animation).</p><p>The mesh files themselves specify how a part is connected to
      others for multi-part supermodels.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4272"></a>10.3.2.&nbsp;SuperModel classes</h3></div></div></div><p>The SuperModel class implements the basic functionality of the
      BigWorld model definition, using the objects provided by Moo. It
      combines a number of the .model files created by ModelEditor (but
      usually just one) into one conceptual model, managing any animations and
      level-of-detail chains. The SuperModel class is detailed in <a href="#xref_SuperModel" title="10.3.&nbsp;SuperModel">SuperModel</a>.</p><p>Two classes currently use SuperModels in the BigWorld client, for
      two different needs:</p><div class="itemizedlist"><ul type="disc"><li><p>ChunkModel</p></li><li><p>PyModel</p></li></ul></div><p>Both are described in the following subsections.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e4290"></a>10.3.2.1.&nbsp;ChunkModel</h4></div></div></div><p>A ChunkModel is a model that inhabits the static scene base
        (<em class="emphasis">e.g.</em>, rocks, trees). Together with the terrain,
        it populates the client world and forms the majority of interesting
        scenery.</p><p>All ChunkModels are added to the collision scene for their
        chunk, unless flagged otherwise. They may optionally play one
        animation, at a specified speed multiplier &#8212; otherwise they are
        static.</p><p>They depend heavily upon the services of their SuperModel,
        supplying only the interface required to live in a chunk, and the
        simple instructions to play back their single animation.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e4302"></a>10.3.2.2.&nbsp;PyModel</h4></div></div></div><p>This class implements the model as it appears to the scripting
        environment.</p><p>It allows scripts to perform the following operations:</p><div class="itemizedlist"><ul type="disc"><li><p>Fetch bound actions sourced from the model's
            definition.</p></li><li><p>Reference hard points (for details, see <a href="#xref_Hard_Points" title="10.2.&nbsp;Hard Points">Hard Points</a>).</p></li><li><p>Specify position, rotation, and scaling.</p></li><li><p>Add motors to move itself around in the scene (such as an
            Action Matcher).</p></li><li><p>Add trackers for inverse kinematics.</p></li><li><p>Add particle systems tied to any node.</p></li><li><p>Control the generation of footsteps and dust
            particles.</p></li><li><p>Control visibility and shadows.</p></li></ul></div></div></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Animation_System"></a>Chapter&nbsp;11.&nbsp;Animation System</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e4345">11.1. Basic keyframed animations</a></span></dt><dt><span class="section"><a href="#d0e4361">11.2. Animation layering and blending</a></span></dt><dt><span class="section"><a href="#d0e4401">11.3. Animation data files</a></span></dt><dt><span class="section"><a href="#d0e4435">11.4. Animation data streaming</a></span></dt><dt><span class="section"><a href="#d0e4460">11.5. Actions</a></span></dt></dl></div><p>The animation system in the BigWorld engine combines many
  sophisticated techniques that are accessed via an easy-to-use interface.
  This system allows game developers to quickly create lifelike characters and
  environments. The problem this system solves is taking the raw content that
  is created by artists and integrating it into a believable dynamic game
  world.</p><p>Artists working on design tools such as 3ds Max or Maya can create
  models and animations, then use the BigWorld Exporter plug-in to export them
  into data files of a format understandable by the graphics engine.</p><p>The ModelEditor tool can be used to view these models and play back
  animations. It is then used to create a list of actions from these
  animations that are the Python-accessible interfaces within the game
  engine.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4345"></a>11.1.&nbsp;Basic keyframed animations</h2></div></div></div><p>The motions of an object over time can be stored as an array of
    keyframes that describe the position, rotation, and scale of an object (or
    part of one) at different points in time. These keyframes are then used as
    reference values and intermediate positions and rotations are calculated
    by interpolating between keyframe data.</p><p>More realistic intricate objects are described as nodal trees
    representing a bone hierarchy. An example is a simple biped character that
    would have a typical hierarchy shown below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/typical_biped_hierarchy.png"><span class="caption"><p>Typical biped hierarchy</p></span></div></div><p>Each node represents the spatial state of a part of an object. These
    can map to rendered geometry either directly for rigid objects such as a
    hydraulic machine or as bone transforms that are used to update a skinned
    mesh (each geometry vertex having a set of weights that define how each
    bone influences its movement).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4361"></a>11.2.&nbsp;Animation layering and blending</h2></div></div></div><p>A simple animation such as a man waving may consists of keyframe
    arrays from a subset of the whole bone tree, <em class="emphasis">e.g.</em>,
    only for <span class="literal">Torso</span>, <span class="literal">UpperArmRight</span> and
    <span class="literal">LowerArmRight</span>.</p><p>A different animation of the man walking may include only the
    <span class="literal">Torso</span> and <span class="literal">Pelvis</span> sub-tree. These two
    animations can be seen as different layers of the total movement. Within
    the BigWorld framework, this layering is achieved via setting nodal alpha
    values with the ModelEditor tool, as illustrated below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/modeleditor_blending_fields.png"><span class="caption"><p>ModelEditor 'Blending' fields</p></span></div></div><p>Within the engine, different layers can be seen to be played on
    different animation tracks, which control the stopping and starting of
    animations for particular parts of the body (the usual separation into
    upper and lower body allows motion and action to be dealt with smoothly
    yet independently within a game).</p><p>It is possible to play an arbitrary number of animations at once and
    have the resulting motion be a blended interpolation of all the
    animations. This is essentially the same procedure as keyframed
    interpolation, as we are interpolating position, rotation, and scale data.
    When the different animation layers need to be combined into a single
    motion, the nodes that overlap in the different tracks need to be blended
    together.</p><p>Transitions between animations could be achieved by creating all
    possible animation transitions and allowing all animations to complete
    their cycle before starting a new animation.</p><p>A much more adaptable and robust method is to blend out ending
    animations and blend in starting animations over a period of time. As long
    as the animation list is large enough to account for possible jarring
    transitions. For example, instead of having only stand and run animations,
    include also walk and jog ones, then this system combined with good
    animations creates smooth lifelike behaviour in game characters.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4401"></a>11.3.&nbsp;Animation data files</h2></div></div></div><p>The BigWorld exporter outputs the following data files (all file
    types exported to the resource tree
    <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span>):</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">.visual</span>
        files</em></p><p>Define an object's bone structure and material data.</p></li><li><p><em class="emphasis"><span class="literal">.primitive</span>
        files</em></p><p>Define the vertex data such as offset and weighting values for a
        skinned object, and contain BSP data where appropriate.</p></li><li><p><em class="emphasis"><span class="literal">.animation</span>
        files</em></p><p>Define the keyframe data of an animation.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4435"></a>11.4.&nbsp;Animation data streaming</h2></div></div></div><p>Animation data is stored as a series of blocks that are
    asynchronously streamed into memory on demand.</p><p>The sum of all these blocks is referred to as the streamed block
    cache, which size is constrained to prevent excessive memory usage. To
    specify the size of the cache, set the
    <span class="literal">animation/streamChacheSizeKB</span> tag in
    <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span>
    (for details, see <a href="#xref_File_engine_config_xml" title="1.4.2.&nbsp;File <engine_config&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span></a>)</p><p>The watchers <span class="literal">Memory/StreamedBlocks_CacheSize</span> and
    <span class="literal">Memory/StreamedBlocks_CacheMaxSize</span> display the current
    size and the limit of the cache in bytes, respectively.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4460"></a>11.5.&nbsp;Actions</h2></div></div></div><p>An action is a wrapper object that links an animation to in-game
    behaviour and events. Action objects differ from animation ones in the
    information they hold, as described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Animation object</em></p><div class="itemizedlist"><ul type="circle"><li><p>Raw keyframe data.</p></li><li><p>Information on frame rate.</p></li><li><p>Functionality on how to play itself on a model.</p></li></ul></div></li><li><p><em class="emphasis">Action object</em></p><div class="itemizedlist"><ul type="circle"><li><p>Blending time information.</p></li><li><p>Information on whether action is loop.</p></li><li><p>Information on whether an animation is movement.</p></li><li><p>Animation-matching data specifying particular object state
            values for when a particular action should be played.</p></li></ul></div></li></ul></div><p>The raw data describing an action is defined in a
    <span class="literal">.model</span> file in XML format (located in any of the
    various sub-folders under the resource tree
    <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span>, such as for
    example,
    <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/environments</span>,
    <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/flora</span>,
    <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/sets/vehicles</span>,
    etc...).. This data is produced from the ModelEditor tool.</p><p>For details, see <a href="#xref_Action_Matcher" title="9.1.6.&nbsp;Action Matcher">Action Matcher</a>.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Server_Communications"></a>Chapter&nbsp;12.&nbsp;Server Communications</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e4539">12.1. Login</a></span></dt><dt><span class="section"><a href="#d0e4560">12.2. Online</a></span></dt><dt><span class="section"><a href="#d0e4648">12.3. Firewalls</a></span></dt></dl></div><p>The communication with the server uses a low-level UDP-based protocol
  named Mercury. Mercury is described in detail in the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#Server_Overview" class="olink">Server Overview</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Inter_Process_Communication_Mercury" class="olink">Inter-Process Communication (Mercury)</a>.</p><p>Server communication is accessible from both C++ and Python
  scripts.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>This section is only applicable for a full client/server BigWorld
    implementation.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4539"></a>12.1.&nbsp;Login</h2></div></div></div><p>To log in, the client sends a UDP packet using Mercury to the login
    server, on a well-known port. The packet contains all the account and
    character information required to authenticate the client and select a
    character.</p><p>If login is successful, the login server adds an entity for the
    character to the BigWorld server system, and refers the client to a proxy
    server, which handles all in-game communication. Both sides then begin
    sending data to each other. For more details on the login process, see the
    document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#Server_Overview" class="olink">Server Overview</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Design_Introduction" class="olink"><i>Design Introduction</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Design_Introduction_Use_Cases" class="olink">Use Cases</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_overview/server_overview.html#xref_Use_Cases_Logging_In" class="olink">Logging In</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4560"></a>12.2.&nbsp;Online</h2></div></div></div><p>A Mercury channel is created between the proxy and the client. Only
    selected data that is classified as reliable is resent in the event of a
    dropped packet. Due to the average packet rate, and the expected network
    latency, a packet is classified as dropped if a packet with a higher
    sequence number is received before it is.</p><p>Since the client is operating in high-latency conditions, the server
    does not wait for dropped packets to be resent before delivering other
    pending information to the client. The client must therefore cope with
    receiving out-of-order messages of all kinds.</p><p>Messages are sent to the server through a
    <span class="literal">ServerConnection</span> class. The position of the player is
    sent to the server 10 times a second. Messages are received from the
    server by this class during the input loop, and dispatched to their
    handlers in the Entity Manager.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">The types of messages that the server can
        send to the client are as follows:</em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">enterEntity</span></em></p><p>Informs the client that the entity with the given ID has
            entered its AoI.</p></li><li><p><em class="emphasis"><span class="literal">leaveEntity</span></em></p><p>Informs the client that the entity with the given ID has
            left its AoI.</p></li><li><p><em class="emphasis"><span class="literal">createEntity</span></em></p><p>In response to a query from the client, provides the type
            and other immediate data of the entity.</p></li><li><p><em class="emphasis"><span class="literal">avatarUpdate</span></em></p><p>Updates the position of an entity that has a volatile
            position.</p><p>These messages are sent unreliably
            (<em class="emphasis">i.e.</em>, they are not resent if the packet is
            lost).</p></li><li><p><em class="emphasis"><span class="literal">entityMessage</span></em></p><p>Sends a script message to, or updates a property of the
            client representation of an entity.</p></li></ul></div></li><li><p><em class="emphasis">The types of messages that the client can
        send to the server are as follows:</em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis"><span class="literal">avatarUpdate</span></em></p><p>Informs the position of the client's player entity to the
            server.</p></li><li><p><em class="emphasis"><span class="literal">requestEntityUpdate</span></em></p><p>Requests information about the entity with the given ID that
            has just entered the client's AoI.</p><p>This works by effectively setting the entity's last update
            time (to the requesting client) to the time contained in this
            message.</p><p>Properties that have been changed since that time are
            resent.</p></li><li><p><em class="emphasis"><span class="literal">entityMessage</span></em></p><p>Sends a script message to the server side of an entity
            (either on the base or on the cell).</p></li></ul></div></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4648"></a>12.3.&nbsp;Firewalls</h2></div></div></div><p>The bane of mass-market online gaming is the firewall, especially
    the corporate ones. Our protocols have been designed to work smoothly
    through all but the most paranoid of firewalls.</p><p>From the firewall's point of view, it should appear that the client
    has initiated both the login and the proxy packet streams &#8212; since the
    login reply packet contains the address of the proxy server to send to,
    the client can immediately begin sending data, which makes it appear to
    the server it has initiated this stream too, <em class="emphasis">i.e.</em>, it
    'punched a hole in the firewall'.</p><p>The BigWorld server correctly handles the case where it sends data
    to the client (which may be lost if the client is behind a firewall)
    before the client has sent any data to it &#8212; the lost data is
    resent.</p><p>All that the firewall needs to support for these protocols to work
    is the storing of a UDP reply mapping entry when it forwards an outgoing
    packet, so that a when a reply packet arrives with exactly reversed
    addresses (the source and destination IP and port are swapped from the
    request packet), it is forwarded back to the requesting client. This is
    the same requirement as that of the ubiquitous Internet Domain Name
    Service (DNS), which practically all firewalls support.</p><p>The BigWorld server does not require the client to make requests
    from any particular port, so it is not confused if a firewall masquerades
    the port as well as the IP.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Particles"></a>Chapter&nbsp;13.&nbsp;Particles</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e4671">13.1. Particle Systems</a></span></dt><dt><span class="section"><a href="#d0e4733">13.2. Particle Actions</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4763">13.2.1. Source actions</a></span></dt><dt><span class="section"><a href="#d0e4772">13.2.2. Movement actions</a></span></dt><dt><span class="section"><a href="#d0e4784">13.2.3. Sink actions</a></span></dt><dt><span class="section"><a href="#d0e4800">13.2.4. Alteration actions</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e4805">13.3. Particle types</a></span></dt><dt><span class="section"><a href="#d0e4823">13.4. Attaching particle systems to bones</a></span></dt></dl></div><p>A particle is a textured rectangle or a small mesh that can be drawn
  quickly and simply, usually with an additive blend mode. They are mostly
  used to create interesting graphical effects.</p><p>Particles are managed within particle system objects, which keep track
  of a number of particles with similar properties, and an identical function
  pipeline to describe the transition of its particles' properties.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4671"></a>13.1.&nbsp;Particle Systems</h2></div></div></div><p>The particle system is implemented in C++ and is accessible from
    both the scripting environment and C++. The Python module for particle
    systems is named Pixie.</p><p>Each particle system is presently responsible for a set of particles
    of the same texture. While a particle system can change its particle
    texture colour dynamically, effects that require different simultaneous
    textures require separate particle systems.</p><p>A particle system is a conglomerate of the following:</p><div class="itemizedlist"><ul type="disc"><li><p>Particles. This is a container that has specific allocation
        requirements determined by the renderer type. Currently there are
        contiguous particles, which have optimal insert/erase characteristics;
        and FixedIndex particles, these behave like a circular buffer and
        ensure that particle indices remain constant over their lifetime.
        FixedIndexParticles are a requirement for trail rendering and mesh
        particle rendering.</p></li><li><p>Particle Actions, which are responsible for the movement of
        particles (these actions do all the work of moving, creating and
        destroying each particle).</p></li><li><p>Particle Renderer, which is in charge of drawing the
        particles.</p></li></ul></div><p>The Particle System itself provides a common access point for all
    three objects.</p><p>The Particle Renderer is for the most part hidden within the
    particle system. Likewise, the particles themselves are inaccessible to
    the outside. Most game code associated with the Particle System involves
    the creation of special Particle Actions.</p><p>Particle Actions work only during the update phase of the client.
    They are called in turn during the tick method for a particle system, and
    the combined actions of each produce the overall particle effect of the
    system.</p><p>For each particle system class, there is a corresponding python
    wrapper class. For example, <span class="literal">MetaParticleSystem</span> is
    wrapped by <span class="literal">PyMetaParticleSystem</span>. These python wrappers
    hold no state, they only hold a smart pointer reference to the underlying
    C++ object. The reason for this separation between the C++ object and
    their python equivalent is to allow the full construction of particle
    systems in the background thread (Python objects may only be constructed
    in the main thread.)</p><p>There is one more particle system class, which is the ChunkParticles
    class. This is entirely C++ and implements a ChunkItem for particle
    systems, it allows particle systems to be placed in the world via the
    WorldEditor tool. Note that such particle systems should be automatically
    time triggered, as there is no way to access them at run-time in python
    and turn them on or off.</p><p>At present, the procedure for using a particle system involves the
    following steps:</p><div class="itemizedlist"><ul type="disc"><li><p>Particle System is created using Particle Editor.</p></li><li><p>Particle Editor is used to create the different types of
        Particle Actions that control the particles.</p></li><li><p>Any texture and material effects are set.</p></li><li><p>Particle System is added to a model, in order to be displayed
        and updated.</p></li></ul></div><p>Particle Systems can easily be created in the BigWorld
    ParticleEditor and saved as XML files &#8212; typically under folder the
    resource tree <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span>.
    In the client, they can either be placed directly into the scene using the
    World Editor, or invoked from Python as such:</p><pre class="programlisting">import Pixie
ps = Pixie.create( "my_particle_system.xml" )
BigWorld.player().model.node( "biped head" ).attach( ps )</pre><p>Note
    that particle systems can take a reasonably long time to construct - for a
    moderately complex system it might take 5ms to parse the xml file, create
    all the subsystems and hook them all up together. For this reason, it is
    highly recommended that the script-writer load Particle Systems
    asynchronously, using either the Pixie.createBG method, the
    BigWorld.loadResourceListBG method, or using Entity prerequisites. For
    example:</p><pre class="programlisting">Example 1:

import Pixie
ps = Pixie.createBG( "my_particle_system.xml", self.onLoadPS )

def onLoadPS( self, ps ):
  BigWorld.player().model.node( "biped head" ).attach( ps )


Example 2:

import BigWorld
BigWorld.loadResourceListBG( ("particles/one.xml", "particles/two.xml"), self.onLoadResources )

def onLoadResources( self, resources ):
  self.model.root.attach( resources["particles/one.xml"] )
  self.model.root.attach( resources["particles/two.xml"] )
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4733"></a>13.2.&nbsp;Particle Actions</h2></div></div></div><p>There are four main categories of Particle Actions:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Source</em></p><p>Creates particles</p></li><li><p><em class="emphasis">Movement</em></p><p>Changes the velocity or position of the particles based on a set
        of rules. One movement action is special as it applies the effect of
        velocity onto the position of each particle.</p></li><li><p><em class="emphasis">Sink</em></p><p>Removes particles from the list of active particles according to
        a set of rules.</p></li><li><p><em class="emphasis">Alteration</em></p><p>Changes the appearance of the particles.</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4763"></a>13.2.1.&nbsp;Source actions</h3></div></div></div><p>Source actions can create particles over regular periods of time,
      on demand, or even be sensitive to the movement of the model to which it
      is attached. The size, colour, velocity, position, and even age of the
      particles can be specified upon creation. The key behind vector
      descriptions of particles is the Vector Generation subsystem.</p><p>Each source action requires three vector generators. A vector
      generator is a class of objects that randomly create vectors within a
      given space; the space is usually defined by the type of generator and
      the parameters given to it. For example, a sphere generator may accept a
      point in 3D space and a radius value, while a line generator may accept
      two points in 3D space.</p><p>The three generators are used to find the initial position,
      velocity, and colour of the particle when created. When calculating
      position and velocity, the local space of the model is taken into
      account, but only for the creation of the particle. What this means is
      that a cube described by two points, (-0.5, -0.5, -0.5) to (0.5, 0.5,
      0.5) is roughly the bounding box of the particle in position.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4772"></a>13.2.2.&nbsp;Movement actions</h3></div></div></div><p>Movement actions act on every particle in the system. There is a
      variety of movements that can be applied to a particle. Examples would
      be force, stream, barrier, and jitter.</p><p>Basic movement of particles due to velocity is calculated
      automatically within the particle system, taking wind also into
      account.</p><p>Particles can also undergo full scene collision &#8212;
      <em class="emphasis">e.g.</em>, spent bullets tumbling down steps.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4784"></a>13.2.3.&nbsp;Sink actions</h3></div></div></div><p>Sink actions remove particles from the system, whether it is due
      to age or for moving beyond a specified boundary. Examples of sink
      actions are <em class="emphasis">sink</em>, <em class="emphasis">barrier,</em> and
      <em class="emphasis">splat</em>.</p><p>It is important to note that without sink actions, particles once
      created will never leave the system, eventually forcing it to hit its
      particle limit.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4800"></a>13.2.4.&nbsp;Alteration actions</h3></div></div></div><p>Alteration actions affect the appearance of the particles. They
      can modify the shading, alpha level, and size of the particle over time.
      They are typically used in smoke effects, gentle fading in and out, and
      glowing effects. Particle textures can be animated if the texture
      specified is an animated texture.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4805"></a>13.3.&nbsp;Particle types</h2></div></div></div><p>The particle system renderer is separate from the main particle
    system calculations, and allows not just texture-based particles, but also
    sprite-based and mesh-based particles. Multiple particle systems can share
    the same renderer.</p><p>The mesh particle renderer can use any visual, but for optimum
    performance, meshes specific for use in particle systems should be
    exported from 3ds Max or Maya in groups of 15, having the Mesh Particles
    option button selected in its respective exporter dialog. For more
    details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_3ds_Max_And_Maya_Exporters" class="olink"><i>3ds Max and Maya Exporters</i></a> .</p><div class="informalfigure"><div class="mediaobject"><img src="images/3ds_max_and_maya_visual_exporter_dialogs.png"><span class="caption"><p>3ds Max Visual Exporter dialog and Maya Visual Exporter
        dialog</p></span></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4823"></a>13.4.&nbsp;Attaching particle systems to bones</h2></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>For details on any class mentioned in this section, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>'s entry <em class="emphasis">Class
      List</em>.</p></div><p>To have a particle system follow a bone and orient to an external
    target, you should attach it to a node, and then point that node using a
    tracker.</p><p>The tracker class provided by the BigWorld module (BigWorld.Tracker)
    can be set up using a variety of DirectionProviders to point a node in the
    appropriate direction:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">EntityDirProvider</span></em></p><p>Points a node in the direction that an entity is facing.</p></li><li><p><em class="emphasis"><span class="literal">DiffDirProvider</span></em></p><p>Points a node towards the position given by a MatrixProvider
        (<em class="emphasis">e.g.</em>, to point at the head node of another
        entity, or to point in a constant world direction).</p></li><li><p><em class="emphasis"><span class="literal">ScanDirProvider</span></em></p><p>Makes a node swing back and forth around its Y-axis
        (<em class="emphasis">e.g.</em>, to simulate a security camera).</p></li></ul></div><p>Depending on your particular game, you might not be able to use a
    tracker to point a node on the source model. For example, the node may be
    part of a character's skeleton and have some mesh rigged to it, so you may
    not want to actually point to this bone (only the particle system attached
    to it). If this is the case, then you will need to create a new node on
    which to mount your particle system &#8212; ask your artists to build dummy
    nodes into their models on which to mount FX.</p><p>To have a particle system exist at a position that is not provided
    by a bone, you should attach it to a separate model, and display the
    separate model using <span class="literal">Entity.addModel</span>. Using
    <span class="literal">Entity.addModel</span> instead of
    <span class="literal">Entity.model.node(xxx).attach</span> means that the model
    exists at location independent from the entity &#8212; in fact, it means that
    nobody will be setting the position/direction of the model, and it is
    entirely up to the script.</p><p>Once you have an independent model, you can set its position and
    orientation to any <span class="literal">MatrixProvider</span>, by using the
    <span class="literal">Servo Motor</span>. As explained in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>, the <span class="literal">Servo</span> class is a
    <span class="literal">Motor</span> that sets the transform of a model to the given
    <span class="literal">MatrixProvider</span> &#8212; as the
    <span class="literal">MatrixProvider</span> is updated, the model moves. The signal
    attribute is the <span class="literal">MatrixProvider</span> that sets the model's
    transform.</p><p>This way, you can use the <span class="literal">Servo</span>
    <span class="literal">Motor</span> to move the model to a position provided by any
    dynamic matrix. If the independent model has a node to point to, then you
    can set its orientation by using a <span class="literal">Tracker</span>, as
    explained above. This allows you to detach the position of a particle
    system from a bone, but still set the orientation of the particle system
    to the orientation of the bone, or towards an external target.</p><p>Finally, if you want a particle system to exist at a fixed
    point/orientation, then use the <span class="literal">ParticleSystem</span>'s
    <span class="literal">explicitPosition</span> and
    <span class="literal">explicitDirection</span> attributes. These set the
    position/orientation of a particle system once, and cannot be set to
    dynamic matrices. Note that if you use either attribute, you will need to
    use both (setting either attribute tells the particle system that it is
    using an 'explicit transform' derived from both attributes).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Be careful when attaching particle systems to bones! To attach a
        particle system to a bone, a PyModelNode must be retrieved. If there
        are no existing PyModelNodes referencing the bone you want to use,
        then its transform is undefined until the next draw call. Since python
        scripts are updated *before* the draw call, there is no way of knowing
        where a node is at the time of first retrieval. Therefore in this
        case, you should only attach a particle system to a PyModelNode when
        you know it has been updated. Your possible options are :</p><div class="itemizedlist"><ul type="disc"><li><p>Retrieve and keep a reference to the bone when you create
            your model. This will ensure at a later date when a particle
            system is attached to that bone, that the bone's position is
            well-known.</p></li><li><p>Retrieve a reference to the bone you require, and callback
            yourself the next frame to attach the particle system to it. For
            example :</p><p>BigWorld.callback( 0.0, partial( self.model.node("HP
            particles").attach, self.particles ) )</p></li></ul></div></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Detail_Objects"></a>Chapter&nbsp;14.&nbsp;Detail Objects</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e4946">14.1. Flora</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4964">14.1.1. Placement</a></span></dt><dt><span class="section"><a href="#d0e5009">14.1.2. Implementation</a></span></dt><dt><span class="section"><a href="#d0e5034">14.1.3. Frame coherency</a></span></dt><dt><span class="section"><a href="#d0e5041">14.1.4. Animation</a></span></dt><dt><span class="section"><a href="#d0e5048">14.1.5. Lighting</a></span></dt><dt><span class="section"><a href="#d0e5055">14.1.6. File format</a></span></dt></dl></dd></dl></div><p>A detail object is a small mesh drawn in large numbers onto the
  terrain around the camera position. They are separated from ordinary models
  for efficiency. The selection and placement of these objects is largely
  automatic &#8212; it is based on the texture used by the underlying
  terrain.</p><p>Examples of detail objects are: grasses, ferns, bulrushes, pebbles,
  and rocks. The user does not interact with detail objects (for example, no
  collision detection is performed).</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e4946"></a>14.1.&nbsp;Flora</h2></div></div></div><p>BigWorld by default has about 60,000 triangles of flora active at
    any time, of which about 15,000 will be drawn at any one time. You may
    change the size of the vertex buffer used by changing the value of the
    <span class="literal">vb_size</span> tag in your flora configuration file (which is
    specified by the <span class="literal">environment/floraXML</span> tag in your
    configuration file
    <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/resources.xml</span> &#8212;
    for details, see <a href="#xref_File_resources_xml" title="1.4.1.&nbsp;File resources.xml">File <span class="literal">resources.xml</span></a>.).</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e4964"></a>14.1.1.&nbsp;Placement</h3></div></div></div><p>Because of the multitude of objects involved, it is impractical to
      place detail objects by hand. Instead, BigWorld has Ecotypes.</p><p>Ecotypes define objects that are automatically placed within the
      world, guided by terrain texture. They are defined in XML, and have the
      following properties:</p><div class="itemizedlist"><ul type="disc"><li><p>One or more units (Moo visuals).</p></li><li><p>One or more textures, which are used to match the terrain to
          an ecotype.</p></li><li><p>Sound tag, for character footsteps.</p></li></ul></div><p>For example, a grass ecotype could contain two separate meshes:
      one for low-height grass, and another for mid-height grass.</p><p>The set of ecotypes currently active is managed by the Flora
      class, which also manages the individual active detail objects,
      allocating and de-allocating them as required.</p><p>Each terrain block can have four textures, and each of these
      textures can have one associated ecotype. This allows for four different
      ecotypes per terrain block. Hence, within the detail sphere (50-metre
      radius from the camera) up to 16 different ecotypes may be
      visible.</p><p>Detail objects are not placed precisely within the terrain blocks
      &#8212; this would create square regions of detail objects. Detail objects
      'jitter' their position before querying the terrain for its detail
      mapping. This effectively antialiases the quantized detail map.</p><p>Flora is calculated and stored in terrain files by the World
      Editor. For more details, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//content_creation.chm#Content_Creation_Manual" class="olink">Content Creation Manual</a> (accessible in WorldEditor,
      ModelEditor, and ParticleEditor via the <em class="emphasis">Help
      <span class="symbol">&#8594;</span> Content Creation</em> menu
      item, or by pressing <span class="literal">F1</span>).</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e5002"></a>14.1.1.1.&nbsp;Visual consistency</h4></div></div></div><p>The detail objects are mapped directly from terrain textures.
        Visually this is correct, since in real life the colour on the terrain
        is actually made from the colour of millions of detail objects (blades
        of grass, etc...). Thus, a green 'grassy' terrain texture can be made
        to map perfectly to a grass ecotype.</p><p>In BigWorld, whenever a texture is used, its accompanying detail
        objects are displayed.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5009"></a>14.1.2.&nbsp;Implementation</h3></div></div></div><p>Drawing detail objects is an extremely performance-critical area,
      as all routines are run thousands of times per frame.</p><p>Vertex buffers are the perfect solution. The detail objects are
      kept transformed in a large vertex buffer. Thus, 1,000 pieces of grass
      at 6 vertices each means a world-space vertex buffer of 6,000 vertices.
      This allows all grass to be drawn using one call to the video card,
      using one transform matrix. 3D accelerators are extremely fast
      performing this kind of batched rendering.</p><p>As the player moves around the world, he sees the detail objects
      in the immediate vicinity (50m). In reality, this means that the active
      set of detail objects must change according to the camera position.
      Detail objects that are just coming into view are faded in, using alpha
      blending.</p><p>The flora configuration XML file
      <span class="literal"><em class="replaceable"><code>&lt;flora&gt;</code></em>.xml</span> (for
      details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_flora_xml" class="olink"><span class="literal"><em class="replaceable"><code>&lt;flora&gt;</code></em>.xml</span></a>) can define
      the size of the vertex buffer either statically or as a set of options
      selectable by the user via the <span class="literal">FLORA_DENSITY</span> graphics
      setting. For details, see <a href="#xref_FLORA_DENSITY" title="21.9.1.3.&nbsp;FLORA_DENSITY"><span class="literal">FLORA_DENSITY</span></a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5034"></a>14.1.3.&nbsp;Frame coherency</h3></div></div></div><p>In a multi-thousand object system, frame coherency must be
      utilised aggressively. The obvious choice for frame coherency is the
      vertex transforms. Each detail object is kept transformed in a vertex
      buffer in world space, until its terrain tile (or 'flora block') leaves
      the detail radius, at which point another terrain tile will have moved
      into the detail radius. Then the new tile's detail objects will be
      transformed and placed in the freed up vertex buffer memory.</p><p>On average, detail objects have shown around 97% coherency between
      frames, making for a huge saving in transformation cost.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5041"></a>14.1.4.&nbsp;Animation</h3></div></div></div><p>In order to create an immersive, living, breathing world, most
      things must animate.</p><p>Animating detail objects add greatly to the illusion of the world.
      The BigWorld client uses 3D Perlin noise based on (wx, wz, time) to
      create believable procedural animation to the detail objects. Perlin
      noise was chosen because it is a cheap way to create space-time coherent
      noise. The implementation performs the animation efficiently in the
      vertex shader.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5048"></a>14.1.5.&nbsp;Lighting</h3></div></div></div><p>When using simplified meshes (which is crucial in a multi-thousand
      object ornamentation system), lighting becomes challenging. Consider a
      criss-cross grass object rising vertically out of the terrain. If lit
      using standard procedures, the criss-cross objects would flare up in the
      evening sun.</p><p>In the BigWorld client, lighting for detail objects is performed
      using the light map calculated from the actual terrain. Thus, it picks
      up terrain shadows as well. This is a mostly correct solution, because
      the mesh-based terrain itself is really a simplified version of the
      millions of detail objects in existence.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5055"></a>14.1.6.&nbsp;File format</h3></div></div></div><p>The XML flora file defines among other things, the light map to be
      used, plus the ecotypes and noise generation functions. For details on
      this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_flora_xml" class="olink"><span class="literal"><em class="replaceable"><code>&lt;flora&gt;</code></em>.xml</span></a>.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Water"></a>Chapter&nbsp;15.&nbsp;Water</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e5096">15.1. Code overview</a></span></dt><dt><span class="section"><a href="#d0e5216">15.2. Scene generation</a></span></dt><dt><span class="section"><a href="#xref_Render_Settings">15.3. Render settings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Setting_The_Quality">15.3.1. Setting the quality</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Simulation">15.4. Simulation</a></span></dt><dt><span class="section"><a href="#d0e5419">15.5. Rain</a></span></dt><dt><span class="section"><a href="#d0e5424">15.6. Water depth</a></span></dt><dt><span class="section"><a href="#d0e5437">15.7. Watchers</a></span></dt></dl></div><p>Bodies of water can be placed in the world via WorldEditor, using the
  provided helper file
  <code class="filename">bigworld/res/helpers/misc/water.xml</code> &#8212; for details, see
  the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//content_creation.chm#Content_Creation_Manual" class="olink">Content Creation Manual</a>'s lesson <em class="emphasis">Add Water to the World</em>.</p><p>As all water objects are VLO's, every instance will create two new
  files in the chunk folder (named with a unique ID for each instance):</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="filename">.vlo</code>
      file</em></p><p>Contains the XML chunk item section for the water object.</p></li><li><p><em class="emphasis"><code class="filename">.odata</code>
      file</em></p><p>Contains binary information related to the VLO (in this case, the
      water's per-vertex transparency/edging data).</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5096"></a>15.1.&nbsp;Code overview</h2></div></div></div><p>The water implementation is contained in the
    <code class="filename">bigworld/src/lib/romp</code> library, more specifically in
    the following files:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="filename">chunk_water.cpp</code>,
        <code class="filename">chunk_water.hpp</code></em></p><p>Water's link to the BigWorld chunking system.</p><p>See also:
        <code class="filename">bigworld/src/lib/chunk/chunk_vlo.cpp</code>, and
        <code class="filename">bigworld/src/lib/chunk/chunk_vlo.hpp</code>.</p></li><li><p><em class="emphasis"><code class="filename">editor_chunk_water.cpp</code>,
        <code class="filename">editor_chunk_water.hpp</code></em></p><p>Editor-related features, like saving, moving, and
        editing.</p><p>See also:
        <code class="filename">bigworld/src/lib/chunk/editor_chunk_vlo.cpp</code> and
        <code class="filename">bigworld/src/lib/chunk/editor_chunk_vlo.hpp</code>.</p></li><li><p><em class="emphasis"><code class="filename">water.cpp</code>,
        <code class="filename">water.hpp</code>,
        <code class="filename">water.ipp</code></em></p><p>The main files. Contains the surface drawing/setup.</p></li><li><p><em class="emphasis"><code class="filename">water_scene_renderer.cpp</code>,
        <code class="filename">water_scene_renderer.hpp</code></em></p><p>Implementation of the water scene (reflection/refraction)
        generation.</p></li><li><p><em class="emphasis"><code class="filename">water_simulation.cpp</code>,
        <code class="filename">water_simulation.hpp</code></em></p><p>Implementation of the simulation of water surface.</p></li></ul></div><p>The water features also uses the shaders below (located in
    res/shaders/water):</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><code class="filename">water.fx</code></em></p><p>Main surface shader for the water.</p></li><li><p><em class="emphasis"><code class="filename">simulation.fx</code></em></p><p>Shader for simulation of GPU water interaction.</p></li></ul></div><p>Each <span class="literal">ChunkWater</span> in the world creates its own
    <span class="literal">Water</span> object. A <span class="literal">ChunkWater</span> is
    created by the first reference <span class="literal">ChunkVLO</span> encountered.
    The water is a very large object (VLO), which means that it can
    span/belong to more than one chunk. This is implemented by placing a VLO
    reference object (<span class="literal">ChunkVLO</span>) into every chunk that the
    water overlaps. Each reference is treated like the actual large object,
    passing and retrieving data from/to it.</p><p>Each water object adds itself to the draw list at each frame, with
    <span class="literal">Waters::addToDrawList</span>. The engine then draws the list
    of water surfaces with a call to
    <span class="literal">Waters::drawWaters</span>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5216"></a>15.2.&nbsp;Scene generation</h2></div></div></div><p>A reflection scene are rendered based on the current water quality
    level (for details, see <a href="#xref_Setting_The_Quality" title="15.3.1.&nbsp;Setting the quality">Setting the quality</a>). The
    reflection scene is a render target that is updated in the main game loop,
    during the call to
    <span class="literal">TextureRenderer::updateDynamics</span>.</p><p>Multiple water surfaces can share a reflection render target
    (<span class="literal">WaterScene</span> class) if they are both in the same
    position on the y-axis. The water scene generation assumes a flat plane
    for the water to reflect/clip around the defined y-axis position.</p><p>The refraction scene uses the Distortion channel texture which
    contains a copy of the main render target.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Render_Settings"></a>15.3.&nbsp;Render settings</h2></div></div></div><p>The terrain will always be drawn, but everything else is linked to
    the current quality setting defined by the following variables:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">WaterSceneRenderer::s_drawDynamics_</span></em></p><p>Determines if dynamic objects are drawn into the water
        scene.</p></li><li><p><em class="emphasis"><span class="literal">WaterSceneRenderer::s_drawPlayer_</span></em></p><p>Determines if the player model is drawn into the water
        scene.</p></li><li><p><em class="emphasis"><span class="literal">WaterSceneRenderer::s_drawTrees_</span></em></p><p>Determines if trees are drawn into the water scene.</p></li><li><p><em class="emphasis"><span class="literal">WaterSceneRenderer::s_maxReflectionDistance_</span></em></p><p>Maximum distance that a dynamic object can be away from the
        water. Default value is 25.</p></li><li><p><em class="emphasis"><span class="literal">WaterSceneRenderer::s_maxReflections_</span></em></p><p>Maximum number of dynamic objects to draw. Default value is
        10.</p></li><li><p><em class="emphasis"><span class="literal">WaterSceneRenderer::s_useClipPlane_</span></em></p><p>Toggles the use of the hardware clipping planes</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Setting_The_Quality"></a>15.3.1.&nbsp;Setting the quality</h3></div></div></div><p>The Water::init method is used to initialise the graphics settings
      options menu link and the FX files, and is only called once. It will
      make available the following menu items:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Water Quality <span class="symbol">&#8594;</span> High</em> &#8212; Invoked method:
          <span class="literal">Waters::setQualityOption</span></p><p>All world items are drawn in the water scenes. Highest detail
          shader is also used.</p></li><li><p><em class="emphasis">Water Quality <span class="symbol">&#8594;</span> Mid</em> &#8212; Invoked method:
          <span class="literal">Waters::setQualityOption</span></p><p>Except for dynamic objects, all world items are drawn in the
          water scenes.</p></li><li><p><em class="emphasis">Water Quality <span class="symbol">&#8594;</span> Low</em> &#8212; Invoked method:
          <span class="literal">Waters::setQualityOption</span></p><p>Player, trees and sky are drawn in the Reflection. Reflection
          texture size is reduced.</p></li><li><p><em class="emphasis">Water Quality <span class="symbol">&#8594;</span> Lowest</em> &#8212; Invoked method:
          <span class="literal">Waters::setQualityOption</span></p><p>Dynamic objects, player drawing, terrain and trees are
          disabled. Only the sky will be drawn into the reflection.</p></li><li><p><em class="emphasis">Water Simulation Quality <span class="symbol">&#8594;</span> High</em> &#8212; Invoked method:
          <span class="literal">Waters::setSimulationOption</span></p><p>Perturbations can propagate between
          cells<sup>A</sup>.</p></li><li><p><em class="emphasis">Water Simulation Quality <span class="symbol">&#8594;</span> Low</em> &#8212; Invoked method:
          <span class="literal">Waters::setSimulationOption</span></p><p>Simulation is restricted to the individual
          cells<sup>A</sup>.</p></li><li><p><em class="emphasis">Water Simulation Quality <span class="symbol">&#8594;</span> Off</em> &#8212; Invoked method:
          <span class="literal">Waters::setSimulationOption</span></p><p>Simulation is disabled</p></li></ul></div><p><em class="emphasis"><em class="emphasis">A</em> &#8212; Cells are
      sub-divisions of the water surface (for details, see <a href="#xref_Simulation" title="15.4.&nbsp;Simulation">Simulation</a>).</em></p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Simulation"></a>15.4.&nbsp;Simulation</h2></div></div></div><p>The water surface is divided up into cells with size defined by the
    water surface (defaulting to be 100.0 units). Each cell defines an area of
    water simulation that can be active.</p><p>There is a common pool of simulation textures (of size
    <span class="literal">MAX_SIM_TEXTURE_BLOCKS</span>) maintained by the
    SimulationManager class.</p><p>A cell is activated when a movement enters its defined area, and is
    deactivated after a period of inactivity (defined by
    <span class="literal">SimulationManager::maxIdleTime_</span>, with a default value
    of 5.0 seconds).</p><p>When the high detail simulation options are selected, water
    movements will propagate to (and activate) neighbouring cells.</p><p>The maximum number of active movements is defined by
    <span class="literal">MAX_SIM_MOVEMENTS</span>. Water movements are passed into the
    simulation manager through the Sway system &#8212; for details, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_cpp/client/index.html#Client_C_API" class="olink">Client C API</a>'s entry <em class="emphasis">Class List
    <span class="symbol">&#8594;</span> <span class="literal">ChunkWater</span>,
    Public Member Fuction <span class="literal">sway</span></em>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5419"></a>15.5.&nbsp;Rain</h2></div></div></div><p>Water is automatically affected by rain &#8212; there is another
    simulation texture block reserved in the SimulationManager, and that is
    used for the rain.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5424"></a>15.6.&nbsp;Water depth</h2></div></div></div><p>The water depth is determined by the lowest terrain point underneath
    the water. The bounding box generated from this value could also be used
    to define a water volume for gameplay purposes. This can be found by
    searching for the <span class="literal">bbDeep_ references</span> in
    <code class="filename">bigworld/src/lib/romp/water.cpp</code>.</p><p>This depth information is also used to colour the water's refraction
    based on the actual per-pixel depth of the water surface. This uses an MRT
    (multiple render target) depth texture generated in the main scene render.
    A foaming edge effect is also added using this information.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5437"></a>15.7.&nbsp;Watchers</h2></div></div></div><p>To configure the behaviour of the water system, the watchers below
    are used (all watchers are prefixed by <em class="emphasis"><span class="literal">Client Settings/Water/</span></em>):</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">character
        impact</span></em></p><p>Strength at which a movement will hit the water surface
        simulation.</p></li><li><p><em class="emphasis"><span class="literal">draw</span></em></p><p>Defines whether water surfaces are drawn.</p></li><li><p><em class="emphasis"><span class="literal">Draw
        Dynamics</span></em></p><p>Linked to
        <span class="literal">WaterSceneRenderer::s_drawDynamics_</span>.<sup>A</sup></p></li><li><p><em class="emphasis"><span class="literal">Draw
        Player</span></em></p><p>Linked to
        <span class="literal">WaterSceneRenderer::s_drawPlayer_</span>.<sup>A</sup></p></li><li><p><em class="emphasis"><span class="literal">Draw
        Trees</span></em></p><p>Linked to
        <span class="literal">WaterSceneRenderer::s_drawTrees_</span>.<sup>A</sup></p></li><li><p><em class="emphasis"><span class="literal">Max Reflection
        Distance</span></em></p><p>Linked to
        <span class="literal">WaterSceneRenderer::s_maxReflectionDistance_</span>.<sup>A</sup></p></li><li><p><em class="emphasis"><span class="literal">Max
        Reflections</span></em></p><p>Linked to
        <span class="literal">WaterSceneRenderer::s_maxReflections_</span>.<sup>A</sup></p></li><li><p><em class="emphasis"><span class="literal">Scene/Use Clip
        Plane</span></em></p><p>Linked to
        <span class="literal">WaterSceneRenderer::s_useClipPlane_</span>.<sup>A</sup></p></li><li><p><em class="emphasis"><span class="literal">water speed
        square</span></em></p><p>Speed in which a wave will travel in the water
        simulation.</p></li><li><p><em class="emphasis"><span class="literal">wireframe</span></em></p><p>Toggles wireframe mode for water surface.</p></li></ul></div><p><em class="emphasis"><em class="emphasis">A</em> &#8212; For details, see
    <a href="#xref_Render_Settings" title="15.3.&nbsp;Render settings">Render settings</a>.</em></p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Graphical_User_Interface_GUI"></a>Chapter&nbsp;16.&nbsp;Graphical User Interface (GUI)</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_C_GUI_Support">16.1. C++ GUI support</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5606">16.1.1. SimpleGUIComponent</a></span></dt><dt><span class="section"><a href="#d0e5617">16.1.2. GUIShader</a></span></dt><dt><span class="section"><a href="#d0e5637">16.1.3. SimpleGUI</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Python_GUI_Support">16.2. Python GUI support</a></span></dt><dt><span class="section"><a href="#d0e5689">16.3. XML</a></span></dt><dt><span class="section"><a href="#xref_XML_And_Python">16.4. XML and Python</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5729">16.4.1. <span class="literal">onLoad(self,section)</span></a></span></dt><dt><span class="section"><a href="#d0e5742">16.4.2. <span class="literal">onBound(self)</span></a></span></dt><dt><span class="section"><a href="#d0e5762">16.4.3. <span class="literal">onSave(self,section)</span></a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Input_Events">16.5. Input events</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5890">16.5.1. Keyboard Events</a></span></dt><dt><span class="section"><a href="#d0e5941">16.5.2. Axis Events</a></span></dt><dt><span class="section"><a href="#d0e5979">16.5.3. Mouse Events</a></span></dt><dt><span class="section"><a href="#d0e6136">16.5.4. Drag-and-drop events</a></span></dt><dt><span class="section"><a href="#d0e6333">16.5.5. Component PyGUI</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Mouse_Cursor">16.6. Mouse cursor</a></span></dt></dl></div><p>The BigWorld GUI can be broken into standalone (menu and options
  interfaces) and in-game overlays.</p><p>The in-game overlays require 3D integration, and thus have a separate
  design. The unique features of the in-game interface are support for:</p><div class="itemizedlist"><ul type="disc"><li><p>Linking to in-game objects (specifically models' bounding
      boxes),</p></li><li><p>Alpha blending, or superimposing over the scene,</p></li><li><p>Special effects like scaling, rotation, colour change, fading
      in/out, and motion blur.</p></li></ul></div><p>The most important feature of the in-game interface is the ability to
  fade away when not in use. This allows the game designer to create a more
  immersive game world experience. Whilst a GUI is required to relate
  important information to the player, it should only do so when that
  information is required. At other times, the player should not be distracted
  by overlays, but immersed fully in the 3D world.</p><p>Some examples of in-game interfaces would be:</p><div class="itemizedlist"><ul type="disc"><li><p>Targeting</p></li><li><p>Current item display</p></li><li><p>Player health and damage</p></li><li><p>Chat window</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_C_GUI_Support"></a>16.1.&nbsp;C++ GUI support</h2></div></div></div><p>There are two C++ base classes for GUI support:</p><div class="itemizedlist"><ul type="disc"><li><p>SimpleGUIComponent</p></li><li><p>GUIShader</p></li></ul></div><p>There is also one management class:</p><div class="itemizedlist"><ul type="disc"><li><p>SimpleGUI</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5606"></a>16.1.1.&nbsp;SimpleGUIComponent</h3></div></div></div><p>The SimpleGUIComponent class is simply a textured rectangle. The
      derived class TextGUIComponent draws text, and the also derived class
      FrameGUIComponent draws a resizable frame using three bitmaps (corner,
      edge, background).</p><p>SimpleGUIComponent has many properties, mostly accessed from
      Python and XML files. For more details, see <a href="#xref_Python_GUI_Support" title="16.2.&nbsp;Python GUI support">Python GUI support</a>.</p><p>Components are hierarchical only in that parents draw their
      children; children do not inherit their parents' transform.
      WindowGUIComponent is an exception to this rule &#8212; children are
      automatically clipped and translated by their parent. Note that this is
      a feature of WindowGUIComponent, not the GUI system in general.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5617"></a>16.1.2.&nbsp;GUIShader</h3></div></div></div><p>The GUIShader class alters the way that components are drawn, in
      an analogous form to vertex shaders (in fact, 99% of GUI shaders operate
      only on temporary variables instead of vertices, hardware TnL
      support).</p><div class="itemizedlist"><ul type="disc"><li><p>ClipGUIShader clips GUIComponents to a proportion of its
          original length, which is useful for making health bars.</p></li><li><p>ColourGUIShader colours a component.</p></li><li><p>AlphaGUIShader fades a component.</p></li><li><p>MatrixGUIShader transforms a component.</p></li></ul></div><p>Shaders are applied to all children &#8212; so use a MatrixGUIShader to
      implement windowing, and an AlphaGUIShader to fade in/out a whole tree
      of components.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5637"></a>16.1.3.&nbsp;SimpleGUI</h3></div></div></div><p>This is the GUI root, and it is ticked and drawn at every
      frame.</p><p>Use SimpleGUI::addSimpleComponent() and
      SimpleGUI::removeSimpleComponent() to build your tree of GUI components.
      Note that you would normally never call these methods from C++, as they
      are mostly called by scripts.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Python_GUI_Support"></a>16.2.&nbsp;Python GUI support</h2></div></div></div><p>You probably will create GUIs using Python and XML most of the time.
    There is no BigWorld GUI editor, thus all GUI is currently created using
    the Python console in game.</p><p>The code below shows an example:</p><pre class="programlisting">import GUI
 
#create a simple GUI component
s=GUI.Simple( "maps/guis/stats_bar.dds" )

#width/height initially in pixels. can use widthRelative/heightRelative
#to designate the component uses clip coordinates ( -1 .. +1 ) instead.
s.width = 64
s.height = 16

#colour attribute is ( r,g,b,a )
s.colour = ( 255, 128, 0, 255 )

#the materialFX is simply the blend mode. can be "BLEND","SOLID","ADD"... 
s.materialFX = "BLEND"

#the position is always in clip coordinates ( -1 .. +1 )
s.position = ( 0, 0.85, 0.5 )

#the anchors determine what the position means with respect to the width 
#and height. in this example, the position of (0,0.85,0.5) and anchors
#"TOP,CENTER" means that the top centre of the component will rest at 
#the given position.
#The component will hang down from y=0.85, and will be centred on x=0.0
s.verticalAnchor = "TOP"
s.horizontalAnchor = "CENTER"
 
#create a clipper for the health amount. clip shaders are used to
#implement stats bars. the constructor parameter "RIGHT" means the 
#shader will clip the component from the right hand side.
c=GUI.ClipShader( "RIGHT" )

#all shaders animate their values. the speed indicates how long the
#internal parameter will change from the old value to the new. This speed
#indicates the health bar will always take 1/2 a second to change.
c.speed = 0.5

#the value is what the game normally changes if player's health changes.
c.value = 1.0

#this line adds the shader. Note that you can call your shader any name
#you like. Internally, the simple GUI component sees you are trying to 
#add a GuiShader to it, under the name of clipper.
#Internally it will call SimpleGUIComponent::addShader()
s.clipper = c
 
#create a colourer for the health amount
c=GUI.ColourShader()

#the start,middle and end simply represent colours to blend to when the
# value parameter is 1.0, 0.5 and 0.0 respectively.
c.start=(255,0,0,192)
c.middle=(255,255,0,192)
c.end=(0,255,0,192)
c.speed=0.5
c.value=1.0
s.colourer=c
 
#and make the health bar be drawn
GUI.addRoot( s )</pre><p><span class="citetitle">Example of GUI creation</span></p><p>You can then customize the new health bar simply by setting the
    appropriate values in the shaders:</p><pre class="programlisting"># player's health went down to 80%
s.clipper.value = s.colourer.value = 0.8</pre><p>Finally, you can associate a script with the GUI component, in order
    to handle input and I/O events, and to build high-level functionality onto
    it. Associate a script object with the component using the script
    attribute:</p><pre class="programlisting">s.script = PyGUI.Button( s )</pre><p>For more details about GUI scripts, see <a href="#xref_XML_And_Python" title="16.4.&nbsp;XML and Python">XML and Python</a>, and <a href="#xref_Input_Events" title="16.5.&nbsp;Input events">Input events</a>.
    For more details on attributes, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>'s entry <em class="emphasis">Main Page
    <span class="symbol">&#8594;</span> Client <span class="symbol">&#8594;</span> GUI <span class="symbol">&#8594;</span>
    Classes <span class="symbol">&#8594;</span>
    <span class="literal">SimpleGUIComponent</span></em>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e5689"></a>16.3.&nbsp;XML</h2></div></div></div><p>GUI can also be represented as XML files. They can be saved in the
    folder <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/guis</span> once
    constructed, for example, using the method described above.</p><p>The advantage of the Python interface is that once you have created
    the GUI, simply call:</p><pre class="programlisting">s.save( "guis/health_bar.gui" )</pre><p>An XML file will be created encapsulating the GUI component, its
    shaders, and all of its children. Once you have done this, write:</p><pre class="programlisting">GUI.delRoot( s )
s = None
s = GUI.load( "guis/health_bar.gui" )
GUI.addRoot( s )</pre><p>After that, you will have exactly the same component, with all its
    shaders and children set up.</p><p>Advanced users will find creating XML by hand the quickest way to
    create your GUI. Alternatively, a GUI editor can be entirely created in
    Python.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_XML_And_Python"></a>16.4.&nbsp;XML and Python</h2></div></div></div><p>When you have a GUI component with a script saved in XML, your
    Python script must implement the following methods (at the very least to
    stub them out):</p><div class="itemizedlist"><ul type="disc"><li><p><span class="literal">def onLoad( self, section )</span></p></li><li><p><span class="literal">def onBound( self )</span></p></li><li><p><span class="literal">def onSave( self, section )</span></p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5729"></a>16.4.1.&nbsp;<span class="literal">onLoad(self,section)</span></h3></div></div></div><p>The <span class="literal">onLoad</span> method is called just after the C++
      load method has been called, the standard member variables have been
      setup, and the associated script has already been constructed.</p><p>The data section that the GUI component is being loaded from is
      passed into the method. This allows the definition of custom attributes,
      especially for loading custom data into the script object.</p><p>Note that the method is called before any children components or
      shaders have been loaded.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5742"></a>16.4.2.&nbsp;<span class="literal">onBound(self)</span></h3></div></div></div><p>The <span class="literal">onBound</span> method is called after the load is
      complete.</p><p>The main difference between this method and
      <span class="literal">onLoad</span> is that by the time <span class="literal">onBound</span>
      is called, the whole GUI component tree has been created. Thus in the
      <span class="literal">onBound</span> method you can write custom script handling
      to manipulate child components. For example, you could invoke your own
      custom Layout Manager in this method.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5762"></a>16.4.3.&nbsp;<span class="literal">onSave(self,section)</span></h3></div></div></div><p>The <span class="literal">onSave</span> method is called just after the C++
      save method has saved all standard GUI component members, but before the
      shaders and children are saved.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Input_Events"></a>16.5.&nbsp;Input events</h2></div></div></div><p><span class="literal">SimpleGUI</span> offers support for keyboard, joystick,
    and mouse input. To capture events, a component needs to have its property
    focus set to true, and an associated Python script attached.</p><p>When loading a component from a GUI file, the attribute of a
    <span class="literal">SimpleGUIComponent</span> is automatically set if the XML
    declares a script field. The value of the field is used to instantiate the
    script object (it must be a callable receiving one parameter &#8212; the
    <span class="literal">SimpleGUIComponent</span> being created &#8212; , and returning a
    Python object). The Python object returned will be the one assigned as the
    script object for the newly created component.</p><p>The script attribute can also be set manually for an existing
    component, like in the example below:</p><pre class="programlisting"># instantiate a new PyGUI Button class, and make it the component's 
# script attribute. note most scripts are passed the GUI component 
# in their constructor so they can perform operations on them.
s.script = PyGUI.Button( s )</pre><p>There are separate focus properties for each category of input
    events, as described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">focus</span></em></p><p><em class="emphasis">Associated with:</em> Keyboard
        events (including character events), joystick (axis) events, and
        global mouse button events.</p></li><li><p><em class="emphasis"><span class="literal">mouseButtonFocus</span></em></p><p><em class="emphasis">Associated with:</em> Mouse button
        events that occur while the mouse position is contained within the
        region of the component.</p></li><li><p><em class="emphasis"><span class="literal">crossFocus</span></em></p><p><em class="emphasis">Associated with:</em> Mouse
        <em class="emphasis">enter</em> events, and mouse
        <em class="emphasis">leave</em> events.</p></li><li><p><em class="emphasis"><span class="literal">moveFocus</span></em></p><p><em class="emphasis">Associated with:</em> Mouse
        <em class="emphasis">move</em> events.</p></li><li><p><em class="emphasis"><span class="literal">dragFocus</span></em></p><p><em class="emphasis">Associated with:</em> Drag
        events.</p></li><li><p><em class="emphasis"><span class="literal">dropFocus</span></em></p><p><em class="emphasis">Associated with:</em> Drop
        events.</p></li></ul></div><p>To make a component start receiving input events, you must set the
    appropriate property to True, and to have it no longer receiving events
    set it to False, as illustrated below:</p><pre class="programlisting"># start receiving key/axis events
c.focus = True

# stop receiving mouse enter/leave events
c.crossFocus = False</pre><p>When a component has a script and it has focus enabled, the script
    will start capturing input events.</p><p>The script must define the appropriate methods to handle the events.
    The example below illustrated a script defining the methods to handle
    keyboard and joystick (axis) events:</p><pre class="programlisting">class Button:
   def handleKeyEvent( self, event ):
      # do whatever, and return 1 if 
      # this key event was consumed

   def handleAxisEvent( self, event ):
      # do whatever, and return 1 
      # if this axis event was consumed</pre><p>The following sub-sections describe the events supported by
    <span class="literal">SimpleGUI</span>. For more details, see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//api_python/client/index.html#Client_Python_API" class="olink">Client Python API</a>'s entry <em class="emphasis">Main Page
    <span class="symbol">&#8594;</span> Client <span class="symbol">&#8594;</span> GUI <span class="symbol">&#8594;</span>
    Classes <span class="symbol">&#8594;</span>
    <span class="literal">SimpleGUIComponent</span></em>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5890"></a>16.5.1.&nbsp;Keyboard Events</h3></div></div></div><p>Keyboard events are related to input from keyboard, mouse, and
      joystick buttons. They are reported to script objects through the
      <span class="literal">handleKeyEvent</span> method:</p><pre class="programlisting">def handleKeyEvent( self, event )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">event</span></em></p><p><span class="literal">PyKeyEvent</span> containing information about
          this event.</p></li></ul></div><p>A return value of <span class="literal">True</span> means that the event has
      been consumed, thus effectively preventing it from being propagated to
      other components or game scripts. A return value of
      <span class="literal">False</span> allows further propagation.</p><p>To receive key events, a component must have the property
      <span class="literal">focus</span> set to True.</p><p>Note that mouse button events reported through the method
      <span class="literal">handleKeyEvent</span> differ from those reported through
      <span class="literal">handleMouseButtonEvent</span> in that the mouse cursor does
      not have to be inside the area defined by a component for that component
      to capture the event. The only requirements for the capture are to have
      the property <span class="literal">focus</span> set to True, and not having
      another component consuming the event earlier in the focus list.</p><p>Character events are attached to key events. Check the
      <span class="literal">PyKeyEvent.character</span> parameter, which will be a
      string containing the fully translated character. It will otherwise it
      will be None. Keep in mind that due to more complex input methods (e.g.
      dead-keys) the length of the character string can be greater than
      1.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5941"></a>16.5.2.&nbsp;Axis Events</h3></div></div></div><p>Axis events are related to joystick axis input. They are reported
      to script objects through the <span class="literal">handleAxisEvent</span>
      method:</p><pre class="programlisting">def handleAxisEvent( self, axis, value, dTime )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">event</span></em></p><p><code class="code">PyAxisEvent</code> containing information about this
          event.</p></li></ul></div><p>A return value of <span class="literal">True</span> means that the event has
      been consumed, effectively preventing it to be propagated to other
      components or game scripts. A return value of <span class="literal">False</span>
      allows further propagation.</p><p>To receive axis events, a component must have the property
      <span class="literal">focus</span> set to <span class="literal">True</span>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e5979"></a>16.5.3.&nbsp;Mouse Events</h3></div></div></div><p>Mouse events can be grouped into three categories:</p><div class="itemizedlist"><ul type="disc"><li><p>Button events</p></li><li><p>Cross events</p></li><li><p>Move events.</p></li></ul></div><p>Mouse events are propagated from the top-most component under the
      mouse cursor down to the bottom component until it is handled by a
      component (by returning True in one of its event handling
      methods).</p><p>The following sub-sections describe how to handle input from each
      category of mouse event.</p><p>Note that mouse events are only generated when the object
      MouseCursor is active. For more details, see <a href="#xref_Mouse_Cursor" title="16.6.&nbsp;Mouse cursor">Mouse cursor</a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6002"></a>16.5.3.1.&nbsp;Button events</h4></div></div></div><p>Button events are related to mouse buttons input. They are
        reported to the script objects through the methods
        handleMouseButtonEvent and handleMouseClickEvent methods.</p><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e6007"></a>16.5.3.1.1.&nbsp;<span class="literal">handleMouseButtonEvent</span></h5></div></div></div><p>This method is called by SimpleGUI on the top most component
          under the mouse that has <code class="code">mouseButtonFocus</code> set to
          True:</p><pre class="programlisting">def handleMouseButtonEvent( self, comp, event )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component over which the button was pressed or
              released.</p></li><li><p><em class="emphasis"><span class="literal">event</span></em></p><p>PyKeyEvent containing information about this event.</p></li></ul></div><p>A return value of True means that the event has been consumed,
          effectively preventing it to be propagated to other components or
          game scripts. A return value of False allows further
          propagation.</p><p>To receive mouse button events, a component must have the
          property mouseButtonFocus set to True.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e6039"></a>16.5.3.1.2.&nbsp;<span class="literal">handleMouseClickEvent</span></h5></div></div></div><p>This method is called by SimpleGUI when the left mouse button
          was pressed and released over the component.</p><pre class="programlisting">def handleMouseClickEvent( self, comp, pos )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component over which the button was pressed.</p></li><li><p><em class="emphasis"><span class="literal">pos</span></em></p><p>Position of the mouse on the instant of the mouse button
              click.</p><p>Value is a 2-tuple of floats in clip-space, ranging from
              -1.0 (leftmost in x-axis, top in y-axis) to 1.0 (rightmost in
              x-axis, bottom in y-axis).</p></li></ul></div><p>A return value of True means that the event has been consumed,
          effectively preventing it to be propagated to other components or
          game scripts. A return value of False allows further
          propagation.</p><p>To receive mouse click events, a component must have the
          property focus set to True.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6070"></a>16.5.3.2.&nbsp;Cross events</h4></div></div></div><p>Cross events are related to the mouse pointer entering or
        leaving the region defined by the component in the screen. They are
        reported to the script objects through the methods
        handleMouseEnterEvent and handleMouseLeaveEvent.</p><p>The signature for handleMouseEnterEvent is described
        below:</p><pre class="programlisting">def handleMouseEnterEvent( self, comp, pos )</pre><p>The signature for handleMouseLeaveEvent is described
        below:</p><pre class="programlisting">def handleMouseLeaveEvent( self, comp, pos )</pre><p>The parameters for both methods are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component that the mouse entered or left.</p></li><li><p><em class="emphasis"><span class="literal">pos</span></em></p><p>First position of the mouse when entering or leaving the
            component.</p><p>Value is a 2-tuple of floats in clip-space, ranging from
            -1.0 (leftmost in x-axis, top in y-axis) to 1.0 (rightmost in
            x-axis, bottom in y-axis).</p></li></ul></div><p>A return value of True means that the event has been consumed,
        effectively preventing it to be propagated to other components or game
        scripts. A return value of False allows further propagation.</p><p>To receive mouse enter and leave events, a component must have
        the properties focus and crossFocus set to True.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6106"></a>16.5.3.3.&nbsp;Move events</h4></div></div></div><p>Move events are related to the mouse pointer hovering over the
        region defined by the component in the screen. They are reported to
        the script objects through the handleMouseEvent method:</p><pre class="programlisting">def handleMouseEvent( self, comp, event )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component over which the mouse cursor hovered.</p></li><li><p><em class="emphasis"><span class="literal">event</span></em></p><p><code class="code">PyMouseEvent</code> containing information about this
            event.</p></li></ul></div><p>A return value of True means that the event has been consumed,
        effectively preventing it to be propagated to other components or game
        scripts. A return value of False allows further propagation.</p><p>To receive mouse move events, a component must have the property
        focus and moveFocus set to True.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6136"></a>16.5.4.&nbsp;Drag-and-drop events</h3></div></div></div><p>SimpleGUI offers support for drag-and-drop functionality.
      Drag-and-drop events can be grouped into two categories:</p><div class="itemizedlist"><ul type="disc"><li><p>Drag events</p></li><li><p>Drop events</p></li></ul></div><p>The following sub-sections describe how to handle input from each
      category of drag-and-drop event.</p><p>Note that drag-and-drop events are only generated when the
      MouseCursor is active. For more details, see <a href="#xref_Mouse_Cursor" title="16.6.&nbsp;Mouse cursor">Mouse cursor</a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6154"></a>16.5.4.1.&nbsp;Drag events</h4></div></div></div><p>Drag events are related to a component being dragged by the
        user. They are always generated on the component being dragged and
        reported through the methods handleDragStartEvent and
        handleDragStopEvent.</p><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e6159"></a>16.5.4.1.1.&nbsp;<span class="literal">handleDragStartEvent</span></h5></div></div></div><p>This method is called when the user is trying to drag the
          component:</p><pre class="programlisting">def handleDragStartEvent( self, comp, pos )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component that the user is trying to drag.</p></li><li><p><em class="emphasis"><span class="literal">pos</span></em></p><p>Position of the mouse on the instant of the event.</p><p>Value is a 2-tuple of floats in clip-space, ranging from
              -1.0 (leftmost in x-axis, top in y-axis) to 1.0 (rightmost in
              x-axis, bottom in y-axis).</p></li></ul></div><p>A return value of True signals to the GUI manager that this
          component is willing to be dragged, and consumes the event. A return
          value of False prevents the component from being dragged, and allows
          further propagation of the event.</p><p>To receive this event, a component must have the property
          dragFocus set to True.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e6190"></a>16.5.4.1.2.&nbsp;<span class="literal">handleDragStopEvent</span></h5></div></div></div><p>This method is called when the user released the mouse left
          button, and therefore wants to drop the component:</p><pre class="programlisting">def handleDragStopEvent( self, comp, pos )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component being dragged.</p></li><li><p><em class="emphasis"><span class="literal">pos</span></em></p><p>Position of the mouse on the instant of the event.</p><p>Value is a 2-tuple of floats in clip-space, ranging from
              -1.0 (leftmost in x-axis, top in y-axis) to 1.0 (rightmost in
              x-axis, bottom in y-axis).</p></li></ul></div><p>The return value from this method is always ignored, and the
          originating mouse button event is allowed to propagate
          further.</p><p>To receive this event, a component must have the property
          dragFocus set to True.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6221"></a>16.5.4.2.&nbsp;Drop events</h4></div></div></div><p>Drop events are related to a component being dropped over
        another one. They are always generated on the recipient component and
        reported through the handleDragEnterEvent, handleDragEnterEvent and
        handleDropEvent methods.</p><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e6226"></a>16.5.4.2.1.&nbsp;<span class="literal">handleDragEnterEvent</span></h5></div></div></div><p>This method is called when the user just dragged another
          component over this one, but has not dropped it yet:</p><pre class="programlisting">def handleDragEnterEvent( self, comp, pos, dropped )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component about to receive the drop.</p></li><li><p><em class="emphasis"><span class="literal">pos</span></em></p><p>Position of the mouse on the instant of the event.</p><p>Value is a 2-tuple of floats in clip-space, ranging from
              -1.0 (leftmost in x-axis, top in y-axis) to 1.0 (rightmost in
              x-axis, bottom in y-axis).</p></li><li><p><em class="emphasis"><span class="literal">dragged</span></em></p><p>Component being dragged.</p></li></ul></div><p>The return value from this method is used to determine if the
          recipient component is willing to accept the drop. This event is
          always considered consumed when first triggered, and the originating
          mouse move event is propagated no further.</p><p>To receive this event, a component must have the property
          dropFocus set to True. Arguments</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e6264"></a>16.5.4.2.2.&nbsp;<span class="literal">handleDragLeaveEvent</span></h5></div></div></div><p>This method is called when the dragged component is no longer
          over this one:</p><pre class="programlisting">def handleDragLeaveEvent( self, comp, pos )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component that was about to receive the drop.</p></li><li><p><em class="emphasis"><span class="literal">pos</span></em></p><p>Position of the mouse on the instant of the event.</p><p>Value is a 2-tuple of floats in clip-space, ranging from
              -1.0 (leftmost in x-axis, top in y-axis) to 1.0 (rightmost in
              x-axis, bottom in y-axis).</p></li></ul></div><p>A return value of True means that the event has been consumed,
          effectively preventing the originating mouse event to be propagated
          to other components or game scripts. A return value of False allows
          further propagation.</p><p>To receive this event, a component must have the property
          dropFocus set to True.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e6295"></a>16.5.4.2.3.&nbsp;<span class="literal">handleDropEvent</span></h5></div></div></div><p>This method is called when the user has dropped a component
          over this one:</p><pre class="programlisting">def handleDropEvent( self, comp, pos, dropped )</pre><p>The parameters are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">comp</span></em></p><p>Component receiving the drop.</p></li><li><p><em class="emphasis"><span class="literal">pos</span></em></p><p>Position of the mouse on the instant of the event.</p><p>Value is a 2-tuple of floats in clip-space, ranging from
              -1.0 (leftmost in x-axis, top in y-axis) to 1.0 (rightmost in
              x-axis, bottom in y-axis).</p></li><li><p><em class="emphasis"><span class="literal">dropped</span></em></p><p>Component receiving the drop.</p></li></ul></div><p>The return value from this method is always ignored, and the
          originating mouse button event is allowed to propagate
          further.</p><p>To receive this event, a component must have the property
          dropFocus set to True.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6333"></a>16.5.5.&nbsp;Component PyGUI</h3></div></div></div><p>You might find it useful to build your own Python module with
      custom GUI components. To do that, the best starting point is the module
      PyGUI.</p><p>PyGUI is the informal Python module for basic GUI elements,
      created for the Citizen Zero project, and defined in
      <span class="literal">fantasydemo/res/scripts/client/Helpers/PyGUI</span>.</p><p>Starting from the basic functionality offered by SimpleGUI native
      components, you can code your own GUI toolkit in Python. Below are some
      examples of widgets you can create:</p><div class="itemizedlist"><ul type="disc"><li><p>Page control</p></li><li><p>Drop-down List</p></li><li><p>Edit field</p></li><li><p>Multi-line text field</p></li><li><p>Check box</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Mouse_Cursor"></a>16.6.&nbsp;Mouse cursor</h2></div></div></div><p>It is possible to control the behaviour and appearance of the mouse
    cursor from the game scripts. Mouse cursor-related functions and
    properties can be accessed though the MouseCursor object.</p><p>The MouseCursor object is a singleton, and can be obtained using the
    method <code class="code">GUI.mcursor.</code></p><p>The properties published by it are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">position</span></em> &#8212;
        Read/write</p><p>Mouse cursor position</p></li><li><p><em class="emphasis"><span class="literal">shape</span></em> &#8212;
        Read/write</p><p>Mouse cursor shape</p></li><li><p><em class="emphasis"><span class="literal">visible</span></em> &#8212;
        Read/write</p><p>Mouse cursor visibility status</p></li><li><p><em class="emphasis"><span class="literal">active</span></em> &#8212;
        Read-only</p><p>Mouse activity status</p></li><li><p><em class="emphasis"><span class="literal">clipped</span></em> &#8212;
        Read/write</p><p>When set to true, the mouse cursor will be clipped to the region
        of the client window.</p></li></ul></div><p>The MouseCursor is an instance of the abstract concept InputCursor.
    There can only be one active InputCursor at any given time.</p><p>To activate the MouseCursor, use the method BigWorld.setCursor. To
    deactivate it, activate another input cursor, or pass None to
    BigWorld.setCursor.</p><p>Mouse and drag-and-drop events are only propagated to GUI components
    while the MouseCursor is active.</p><p>The code below illustrates how to use the MouseCursor:</p><pre class="programlisting"># access and modify the mouse cursor
import GUI
import BigWorld

mc = GUI.mcursor()
mc.shape = "arrow"
mc.visible = True
if not mc.active:
   lastPosition = mc.position
   mc.position = ( 0.0, 0.0 )
   BigWorld.setCursor( mc )
   # mc.active is now True</pre><p><span class="citetitle">Example of how to use <span class="literal">MouseCursor</span>
    object</span></p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Fonts"></a>Chapter&nbsp;17.&nbsp;Fonts</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e6434">17.1. Creating and Using Fonts</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6439">17.1.1. Creating a Font Definition File</a></span></dt><dt><span class="section"><a href="#d0e6473">17.1.2. Preloading Glyphs</a></span></dt><dt><span class="section"><a href="#d0e6483">17.1.3. Specifying the widest character</a></span></dt><dt><span class="section"><a href="#d0e6493">17.1.4. Displaying Text</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6503">17.2. Artist modified Fonts</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6508">17.2.1. Generating a Snapshot of a Font's Glyph Cache</a></span></dt><dt><span class="section"><a href="#d0e6516">17.2.2. Modifying the Font Texture</a></span></dt><dt><span class="section"><a href="#d0e6523">17.2.3. Explaining the Font Grid .dds File</a></span></dt></dl></dd></dl></div><p>BigWorld has an in-built font generation and glyph caching system. It
  supports large international character sets. Internally, BigWorld uses GDI+
  and requires an installed true-type font file to draw the glyphs into a
  glyph-cache render target. As an alternative, you can ship your game with
  pre-cached font maps, however this method does not support dynamic glyph
  usage, and as such is not appropriate for large character sets.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6434"></a>17.1.&nbsp;Creating and Using Fonts</h2></div></div></div><p>To use fonts, you must first create a font definition file that
    describes the font style, point size, and desired effects. Once a font is
    defined, you can use the font to display text on-screen. The main way to
    display text on-screen is via a Python GUI.Text component.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6439"></a>17.1.1.&nbsp;Creating a Font Definition File</h3></div></div></div><p>Font Definition Files are an XML file describing the font itself,
      the size of the glyph cache and the details of any preloaded glyphs
      :</p><pre class="programlisting">&lt;example_font.font&gt;
    &lt;creation&gt;
        &lt;sourceFont&gt; Arial &lt;/sourceFont&gt;
        &lt;sourceFontSize&gt; 16 &lt;/sourceFontSize&gt;
        &lt;effectsMargin&gt;   1 &lt;/effectsMargin&gt;
        &lt;textureMargin&gt;   1 &lt;/textureMargin&gt;
        &lt;dropShadow&gt;   true &lt;/dropShadow&gt;
        &lt;shadowAlpha&gt;   192 &lt;/shadowAlpha&gt;
        &lt;bold&gt;         true &lt;/bold&gt;
    &lt;/creation&gt;
&lt;/example_font.font&gt;</pre><p>Since fonts are generated
      on-the-fly and their glyphs cached at runtime, this is all you need to
      do to begin using a new font. If the specified source font name does not
      exist on the system, then Windows will automatically choose the nearest
      matching typeface. To avoid any potential problems, please make sure you
      license and install your desired true-type fonts on the end-users'
      system (e.g. as part of the installer scripts). If you do decide to
      choose only Windows fonts (and assume they exist on the end-users'
      machines) then be aware that there are large differences in the standard
      fonts used by Windows, depending on the region. For example, if Windows
      has been installed with the Asian font pack, it will have a
      significantly different standard font sets by default (even for English
      language fonts).</p><p>See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_name_size_font" class="olink"><i><span class="literal">.font</span></i></a> for a detailed description of the
      .font definition format.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6452"></a>17.1.1.1.&nbsp;Secondary Font Families</h4></div></div></div><p>In order to allow mixing different character sets within the
        same string of text while maintaining control over how each character
        set is rendered, secondary font families can be defined. For example,
        Arial may be desired for latin-1 (e.g. English) characters, however
        Arial is not designed to render east-Asian character sets (e.g.
        Chinese). This would mean artifacts are produced when rendering
        east-Asian characters.</p><p>Secondary fonts are defined using one or more
        <code class="code">secondary</code> tags within the <code class="code">creation</code> section.
        A secondary font consists of a font name and a Unicode range used to
        selected which secondary font to use.</p><p>For example, to use Arial and Chinese you could add a
        <code class="code">secondary</code> font using SimSun:</p><pre class="programlisting">&lt;example_font.font&gt;
    &lt;creation&gt;
        &lt;sourceFont&gt; Arial &lt;/sourceFont&gt;
        ...
        &lt;secondary&gt;
            &lt;sourceFont&gt;      SimSun          &lt;/sourceFont&gt;
            &lt;unicodeRange&gt;    U+2F00-U+9FFF   &lt;/unicodeRange&gt;
        &lt;/secondary&gt;
    &lt;/creation&gt;
&lt;/example_font.font&gt;</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6473"></a>17.1.2.&nbsp;Preloading Glyphs</h3></div></div></div><p>For languages that have a limited number of glyphs, for example
      English, you may want to preload all the glyphs into the cache so the
      client doesn't have to do anything more at runtime. Additionally, for
      larger Asian languages, you may still want to preload the cache with
      some often-used glyphs and from then on let the cache deal with
      whichever less-frequently used glyphs are required at runtime. The glyph
      caching system will still be in effect, but the cache will contain these
      glyphs to begin with. Additionally, the preloaded glyphs will never
      leave the cache during the duration of client execution, even if they
      are not used.</p><p>To preload glyphs or a range of glyphs, add any combination of the
      following tags into your font definition file.</p><pre class="programlisting">&lt;startChar&gt;    32    &lt;/startChar&gt;
&lt;endChar&gt;     192    &lt;/endChar&gt;

or

&lt;unicodeChar&gt;  U+3000  &lt;unicodeChar&gt;

and/or

&lt;unicodeRange&gt;  U+AC00-U+D7A3   &lt;/unicodeRange&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6483"></a>17.1.3.&nbsp;Specifying the widest character</h3></div></div></div><p>Font glyphs are cached into a texture and are positioned on a
      regular grid (i.e. each grid element is the same width and height). In
      order to determine the size of each grid element up front, the glyph
      cache must know the dimensions of the widest character. By default the
      letter 'W' is used to calculate this size but this may be inappropriate
      for some character sets (including Chinese). If the widest character is too
      narrow, then visual artifacts will occur (characters will be clipped and
      neighbouring characters may 'leak' into each other). If it is too wide,
      then texture space will be wasted.</p><p>The widest character can be set using the &lt;widestChar&gt; tag
      in the font definition file. For example:</p><pre class="programlisting">&lt;example_font.font&gt;
    &lt;creation&gt;
        ...
        &lt;widestChar&gt;  U+FF1F  &lt;/widestChar&gt;
        ...
    &lt;/creation&gt;
&lt;/example_font.font&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6493"></a>17.1.4.&nbsp;Displaying Text</h3></div></div></div><p>Text GUI Components are the main way that fonts are used to
      display text on-screen. For full details on Text GUI Components and
      their python GUI.Text counterpart, please refer to the Python Client API
      guide, under the section GUI.Text. The GUI.Text class supports the
      "font" attribute, this specifies the name of the font definition file,
      relative from the font root (see File Grammar Guide / resources.xml to
      see how to choose or change the font root folder.)</p><p>Here is an example of how to use the above example font file,
      which for now we will assume was saved to
      $FONT_ROOT/example_font.font.</p><pre class="programlisting">import GUI
t = GUI.Text( "Some Text" )
t.font = "example_font.font"
GUI.addRoot(t)</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6503"></a>17.2.&nbsp;Artist modified Fonts</h2></div></div></div><p>Built-in or licensed true-type fonts may not necessarily have to
    desired look for your game. For example you may want to use fonts that
    have a glow effect, or an internal gradient fill. In these situations, you
    have the choice to output a fixed snapshot of a glyph cache as a .dds
    file. This file can then be processed by an artist to generate whatever
    font effects they like. Note that this procedure will only work with a
    fixed set of glyphs, as the client will not internally posess the ability
    to recreate the steps the artist took to modify the font.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6508"></a>17.2.1.&nbsp;Generating a Snapshot of a Font's Glyph Cache</h3></div></div></div><p>The python API contains a function, BigWorld.saveFontCacheMap,
      that outputs the contents of the font's glyph cache to a DDS file, and
      the details of the font metrics to the .font file. Once this snapshot is
      taken, the .font file contains a &lt;generated&gt; section, and the font
      will no longer use the glyph cache, or be able to generate any new
      glyphs at runtime. To revert this change, simply remove the
      &lt;generated&gt; section from the .font file, and delete the .dds file.
      The texture will be named $FONT_ROOT/$FONTNAME_font.dds</p><pre class="programlisting">import BigWorld
BigWorld.saveFontCacheMap( "super_turbo.font" )
#this generates super_turbo.font.dds, super_turbo.font.generated, and super_turbo.font.grid.dds</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6516"></a>17.2.2.&nbsp;Modifying the Font Texture</h3></div></div></div><p>Once a snapshot has been created, the generated font .dds file can
      be loaded into Photoshop (you may need to download and install a .dds
      file plugin, depending on the version of Photoshop you are using). The
      glyphs can then be modified freely, however care must be taken not to go
      outside of the designated bounds for each character. The grid reference
      bitmap describes the go and no-go areas, and its alpha-channel has a
      copy of the glyphs to provide shape information and to simply
      demonstrate which character goes where.</p><p>Once you have modified a font texture, simply save over the
      *.font.dds file, and make sure both it and the *.font.generated file is
      committed as part of your asset repository. The presence of these files
      on disk instructs the font system to use the generated map from now on,
      and never attempt to expand the glyph cache. If glyphs are encountered
      that do not exist as part of the generated glyph cache, a warning will
      be output to the debug window and a filler character will be
      used.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6523"></a>17.2.3.&nbsp;Explaining the Font Grid .dds File</h3></div></div></div><p>Below is a portion of a font.grid.dds file, duplicated 3 times in
      photoshop with various colour channels extracted. You can see the three
      colour channels, with the alpha channel overlayed in white.</p><div class="informalfigure"><div class="mediaobject"><img src="images/font_grid.png"><span class="caption"><p>Example extracted from a .font.grid.dds
          file</p></span></div></div><p>On the left, <em class="emphasis">the red channel describes the
      raw glyph rectangle as given by GDI+</em>. As you can see in the
      example, the W and / glyphs go outside of this region. This is because
      this particular font already has a drop-shadow applied. The drop shadow,
      as provided in-engine, is a copy of the glyph, with a single pixel
      offset. This is demonstrated by the green region below.</p><p><em class="emphasis">The green region describes the glyph region
      plus the effect margin, and is the rectangle that will be drawn by the
      engine</em>. Any pixels outside of the green area will be clipped
      when drawing text to the screen. Note too that when glyphs are drawn
      together, creating a string or a sentence, the red regions (raw size)
      determine the spacing between characters, and any effects margin is
      overlapped by the next glyph, this ensures that adding effects like drop
      shadows do not increase the width of your strings.</p><p><em class="emphasis">The blue region describes the glyph region
      plus effect margin plus texture margin</em>. The texture margin is
      used to pad the glyphs apart in the texture map, to avoid any filtering
      artifacts. The texture margin should never be drawn, and is pretty much
      wasted space. If you are sure that your font will only be drawn at a 1:1
      ratio between pixels and texels (for example the text will never be
      shrunk, or drawn in 3D where it can be rotated and mip-maps come into
      play), then you can safely do away with any texture margin.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_IME"></a>Chapter&nbsp;18.&nbsp;Input Method Editors (IME)</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e6612">18.1. Components of an IME interface</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6637">18.1.1. Examples</a></span></dt><dt><span class="section"><a href="#d0e6654">18.1.2. Recommended Reading</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e6667">18.2. IME Python API</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e6680">18.2.1. Enabling IME</a></span></dt><dt><span class="section"><a href="#d0e6695">18.2.2. Receiving IME events</a></span></dt><dt><span class="section"><a href="#d0e6772">18.2.3. Displaying the IME</a></span></dt></dl></dd></dl></div><p>An Input Method Editor (IME) is an advanced user interface which is
  used to enter input text for East Asian such as Chinese where the character
  set is much larger than can be practically mapped directly to keyboard
  buttons. This is a mechanism provided by Windows and is determined by the
  currently installed keyboard layout.</p><p>Unfortunately the default IME interfaces used by Windows overlay
  additional child pop-up windows which do not work well within the context of
  a game. These pop-ups will conflict with the Direct3D device (especially in
  full-screen mode), are not skinnable, and, since Windows has no knowledge
  about your in-game user interface, it will not be positioned to line up with
  your in-game edit controls. Thus in order to integrate nicely with a game
  and deliver a smooth experience for the user, the IME interface should be
  rendered using the in-game GUI system.</p><p>The BigWorld engine provides an API which allows the Python scripts to
  respond to IME events generated by the operating system and populate an
  in-game IME based on the current state of the system input driver.</p><p>The currently supported IME types are: </p><div class="itemizedlist"><ul type="disc"><li><p>Chinese Simplified (PRC)</p><div class="itemizedlist"><ul type="circle"><li><p>Microsoft Pinyin</p></li><li><p>QuanPin</p></li><li><p>Sogou Pinyin</p></li><li><p>Sogou Wubi</p></li><li><p>Google Pinyin</p></li></ul></div></li><li><p>Chinese Traditional (Taiwan)</p><div class="itemizedlist"><ul type="circle"><li><p>Microsoft New Phonetic IME</p></li></ul></div></li><li><p>Japanese</p><div class="itemizedlist"><ul type="circle"><li><p>Microsoft IME</p></li></ul></div></li><li><p>Korean</p><div class="itemizedlist"><ul type="circle"><li><p>Microsoft IME</p></li></ul></div></li></ul></div><p>This chapter describes how to setup Python scripts to respond to IME
  events and display an interface accordingly.</p><p>In addition to this document, there is an example implementation
  located at
  <code class="filename">fantasydemo/res/scripts/client/Helpers/PyGUI/IME.py</code>.
  This script is used by the <code class="code">PyGUI.EditField</code> class.</p><p>Please note that the BigWorld IME system will be disabled if the
  Scaleform IME library is enabled.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6612"></a>18.1.&nbsp;Components of an IME interface</h2></div></div></div><p>There are three main components that make up an Input Method
    Editor:</p><div class="itemizedlist"><ul type="disc"><li><p>Composition string. This contains the characters that the user
        has composed with the IME and is the string that will be sent to the
        application once it has been finalised by the user. The composition
        string is usually drawn on top of the edit control at the current
        location of the input cursor.</p></li><li><p>Reading window. Typically used only by Chinese IME's, this
        contains the most recent keystrokes which have not yet been translated
        to the target language.</p></li><li><p>Candidate list. This is a list of candidate characters based on
        the current contents of the composition string. The user can use the
        arrow keys to cycle through the available options and can use page-up
        and page-down if there are multiple pages of options. The desired
        candidate is selected by pressing the number key corresponding to the
        candidate list item, or by pressing enter on the highlighted
        item.</p></li></ul></div><p>A particular IME may use all or only some of these components. The
    <code class="code">PyIME</code> object is used by the Python scripts to determine when
    a particular component needs to be drawn (e.g. the
    <code class="code">BigWorld.ime.readingVisible</code> flag can be used to determine
    whether or not the reading window should be drawn at any particular
    time).</p><p>While not strictly part of the IME itself, including a language
    indicator on your edit control is useful as a visual aid to keep track of
    which language is currently active. By changing its colour, you can also
    indicate the current state of the IME (e.g. whether or not the IME is
    currently in alpha-numeric mode).</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6637"></a>18.1.1.&nbsp;Examples</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><img src="images/ime_japanese.png"><span class="caption"><p>Japanese IME</p></span></div></div><div class="informalfigure"><div class="mediaobject"><img src="images/ime_chinese.png"><span class="caption"><p>Chinese IME</p></span></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6654"></a>18.1.2.&nbsp;Recommended Reading</h3></div></div></div><p>[<span class="citation">Installing and Using Input Method Editors, MSDN - <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://msdn.microsoft.com/en-us/library/bb174599%28VS.85%29.aspx" target="_top">http://msdn.microsoft.com/en-us/library/bb174599%28VS.85%29.aspx</a></span>]</p><p>[<span class="citation">Using an Input Method Editor in a Game, MSDN - <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://msdn.microsoft.com/en-us/library/bb206300%28VS.85%29.aspx" target="_top">http://msdn.microsoft.com/en-us/library/bb206300%28VS.85%29.aspx</a></span>]</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6667"></a>18.2.&nbsp;IME Python API</h2></div></div></div><p>The BigWorld IME Python API is accessed via the
    <code class="code">BigWorld.ime</code> object. This is a singleton instance of the
    <code class="code">PyIME</code> class.</p><p>See the Python client API documentation for details on all methods
    and properties mentioned here.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6680"></a>18.2.1.&nbsp;Enabling IME</h3></div></div></div><p>Disabled by default, IME can be enabled and disabled from the
      Python script. Typically, an application would enable IME when a
      text-input interface comes into focus (e.g. an edit box), and disable it
      again once it has lost focus. The <code class="code">enabled</code> property on the
      <code class="code">PyIME</code> object controls the current state:</p><pre class="programlisting">BigWorld.ime.enabled = enableBoolean</pre><p>The internal state will be reset when IME is disabled.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6695"></a>18.2.2.&nbsp;Receiving IME events</h3></div></div></div><p>Once the IME system is enabled, the engine will start posting
      events to the personality script.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6700"></a>18.2.2.1.&nbsp;BWPersonality.handleInputLangChangeEvent</h4></div></div></div><p>The <code class="code">BWPersonality.handleInputLangChangeEvent</code> will
        be called whenever the user has switched the current input language.
        The function does not take any parameters, so the handler should check
        the <code class="code">BigWorld.ime.language</code> property and the
        <code class="code">BigWorld.localeInfo</code> function to check the new language
        and update accordingly.</p><p>Typically, an application would update language indicators
        and/or fonts based on the new language.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6716"></a>18.2.2.2.&nbsp;BWPersonality.handleIMEEvent</h4></div></div></div><p>The <code class="code">BWPersonality.handleIMEEvent</code> gets called
        whenever the user performs some action (usually a keystroke) that
        causes the internal IME state to be changed. The only parameter to the
        <code class="code">handleIMEEvent</code> is a <code class="code">PyIMEEvent</code> object. The
        event object itself does not have any data, rather it has a set of
        flags which indicate which <code class="code">BigWorld.ime</code> properties have
        been updated. The <code class="code">handleIMEEvent</code> function will be called
        when the following events occur:</p><div class="itemizedlist"><ul type="disc"><li><p>The current IME state has been changed (e.g. switching
            between alpha-numeric mode and Hiragana mode whilst in the
            Japanese language).</p></li><li><p>The composition string has been modified.</p></li><li><p>The cursor position within the composition string has been
            modified.</p></li><li><p>The reading window string has changed.</p></li><li><p>The reading window visibility has changed.</p></li><li><p>The candidate list visibility has changed.</p></li><li><p>The candidate list items have changed.</p></li><li><p>The user has changed the highlighted item within the
            candidate list.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6761"></a>18.2.2.3.&nbsp;Finalising characters</h4></div></div></div><p>When the user has finished entering their desired text into the
        method editor they will press enter to commit the string. When this
        occurs, <code class="code">BWPersonality.handleKeyEvent</code> will be called for
        each unicode character in the finalised string, and will be posted
        with the key code <code class="code">Keys.KEY_IME_CHAR</code>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e6772"></a>18.2.3.&nbsp;Displaying the IME</h3></div></div></div><p>The task of actually displaying the IME interface based on the
      current underlying state is a task for the Python script programmer. The
      complexity of the IME presentation scripts will be determined by how
      many languages need to be supported, as each language has their own
      standard way of presenting the IME.</p><p>Note that due to the number of different IME's available for a
      single language, and due to differences between Windows XP and Windows
      Vista, it is recommended to test across these different configurations
      as much as possible.</p><p>Generally, when constructing an IME interface, the scripts will do
      the following:</p><div class="itemizedlist"><ul type="disc"><li><p>Build a composition string window based on the contents of
          <code class="code">BigWorld.ime.composition</code>. Each character in the
          composition string will have a different attribute associated with
          it which determine its state (e.g. whether or not it is
          highlighted). This is determined by the
          <code class="code">BigWorld.ime.compositionAttr</code> property (an array of the
          same length as the composition string).</p><p>A cursor should be drawn within the composition string based
          on the <code class="code">BigWorld.ime.compositionCursorPosition</code>
          attribute.</p></li><li><p>If <code class="code">BigWorld.ime.readingVisible</code> is True, build a
          reading window based on the contents of
          <code class="code">BigWorld.ime.reading</code>.</p><p>The orientation of the reading window is determined by the
          <code class="code">BigWorld.ime.readingVertical</code> property.</p></li><li><p>If <code class="code">BigWorld.ime.candidatesVisible</code> is True, build
          a candidate window based on the contents of
          <code class="code">BigWorld.ime.candidates</code>. This is an array of candidate
          strings for the current page (each page has a maximum of 9 entries).
          The highlighted item of the composition is determined by the
          <code class="code">BigWorld.ime.selectedCandidate</code> property.</p><p>The candidate window should be placed so it appears just under
          the location of the composition window cursor.</p><p>The orientation of the candidate window is determined by the
          <code class="code">BigWorld.ime.candidatesVertical</code> property.</p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6829"></a>18.2.3.1.&nbsp;Japanese</h4></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>Rather than placing the candidate window at the location of
            the composition string cursor, the candidate window should be
            placed below the first target converted character (determined via
            the <code class="code">compositionAttr</code> property).</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6839"></a>18.2.3.2.&nbsp;Korean</h4></div></div></div><p>Korean IME's require a bit more specialisation than Chinese and
        Japanese. The main considerations for creating a Korean IME
        are:</p><div class="itemizedlist"><ul type="disc"><li><p>The composition string is edited in-line. In other words,
            the composition character is directly inserted into the edit box
            immediately so that the character to the right of the cursor is
            moved across. The underlying Korean IME implements this by
            injecting keystrokes such as <code class="code">LEFTARROW</code>,
            <code class="code">RIGHTARROW</code> and <code class="code">BACKSPACE</code> into the input
            stream to automatically insert and remove a character into your
            edit box.</p></li><li><p>The composition string background blinks, itself acting as
            the cursor. As such,
            <code class="code">BigWorld.ime.compositionCursorPosition</code> can be
            ignored.</p></li></ul></div></div></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Web"></a>Chapter&nbsp;19.&nbsp;BigWorld Web Integration</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e6868">19.1. Architecture</a></span></dt><dt><span class="section"><a href="#d0e6907">19.2. Using the Web Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Web_GUI_Component">19.2.1. In Game Web GUI Component</a></span></dt><dt><span class="section"><a href="#xref_Web_Screen">19.2.2. In Game Web Screen</a></span></dt><dt><span class="section"><a href="#xref_Texture_Mapping">19.2.3. Texture Mapping of Web Pages into a world object</a></span></dt></dl></dd></dl></div><p>The BigWorld Technology engine now includes the open source Mozilla
  project allowing for displaying and interacting with web pages as part of
  the client.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6868"></a>19.1.&nbsp;Architecture</h2></div></div></div><p>The BigWorld Technology Client includes the following components as
    part of the web browser integration:</p><div class="itemizedlist"><ul type="disc"><li><p>The bigworld/src/lib/web_render directory contains the BigWorld
        web integration code. The WebPageProvider class is the main interface
        for the web integration. The MozillaWebPageInterface class contains
        the main interface implementation for the Mozilla integration.</p></li><li><p>The Mozilla project, see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.mozilla.org/" target="_top">http://www.mozilla.org/</a> is the
        web layout engine used by the BigWorld Technology Client. This project
        is shipped as compiled dlls as part of the BigWorld engine. These dlls
        are available in the fantasydemo/game/mozilla directory. Different
        dlls are compiled for Visual Studio 2005 and Visual Studio 2008. These
        dlls are based on the Mozilla 1.8 release. If required, customers can
        also replace these dlls by recompiling Mozilla using the instructions
        available at http://ubrowser.com/. When recompiling Mozilla,
        additional fixes to the Mozilla source code might be required (see the
        content of bigworld/bin/client/mozilla/patch/mozilla_diff.txt for more
        details. Any modification to the Mozilla source code will require
        redistribution of the modification (as required by the Mozilla
        license).</p></li><li><p>The LLMozlib library, see <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://ubrowser.com/" target="_top">http://ubrowser.com/</a> is an open
        source wrapper for the Mozilla project and is shipped as part of the
        BigWorld source code. The LLMozlib source code is available in
        bigworld/src/lib/third_party/llmozlib2 and is compiled as part of the
        BigWorld client solution file. Any modification to the LLMozlib source
        code will require redistribution of the modification (as required by
        the LLMozlib license).</p></li></ul></div><p>How the code works:</p><div class="itemizedlist"><ul type="disc"><li><p>A secondary thread is used to deal with all web related
        requests. This prevents performance spikes when responding to long web
        related requests.</p></li><li><p>The MozillaWebPageManager manages calls to Mozilla and callbacks
        by using a separate command thread with two FIFO buffers.</p></li><li><p>Users (i.e. Python/C++ classes) use MozillaWebPageInterface to
        interact with the MozillaWebPageManager, and they send commands to the
        manager which are sent over via the FIFO buffer to be dealt with by
        the secondary thread. This thread dispatches the commands to the
        MozillaWebPage instance which correlates with the
        MozillaWebPageInterface.</p></li><li><p>Callbacks are dispatched using a second FIFO buffer which is
        flushed by the main thread during the tick method.</p></li><li><p>Please note that all interaction with Mozilla must be done in
        the second thread (as Mozilla itself is not thread safe).</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e6907"></a>19.2.&nbsp;Using the Web Integration</h2></div></div></div><p>The BigWorld web integration can be used in multiple scenarios.
    Multiple usage examples are available as part of FantasyDemo and will be
    explained below.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Web_GUI_Component"></a>19.2.1.&nbsp;In Game Web GUI Component</h3></div></div></div><p>An in game web GUI component is a GUI component capable of
      displaying 2D web content and sending mouse and keyboard events to that
      web content. There is some experimental (not supported) code also allows
      building a game integrated with ActionScript and JavaScript components
      (see below).</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6917"></a>19.2.1.1.&nbsp;Creating an Interactive 2D Web GUI Component</h4></div></div></div><p>Displaying an interactive 2D web GUI Component which can be used
        to browse the web can be done by creating a GUI component containing a
        child SimpleGuiComponent using the
        fantasydemo/res/scripts/client/Helpers/PyGUI/InternalBrowser.py
        script. For an example of a 2D web GUI component please review the
        fantasydemo/res/gui/web.gui. Following are the main considerations for
        creating an interactive 2D web GUI component.</p><div class="itemizedlist"><ul type="disc"><li><p>The web.gui contains multiple child GUI components. The main
            GUI component used to display the web content is the
            InternalBrowser component. Other child components are mainly used
            to display navigation buttons, a window label and the window
            texture.</p></li><li><p>The InternalBrowser.py sets the SimpleGuiComponent texture
            to use the TextureProvider returned by the WebPageProvider in
            order to display the web page as part of the
            SimpleGuiComponent.</p></li><li><p>The InternalBrowser.py implementation currently supports two
            types of keyboard input methods. Keyboard input is automatically
            captured by Mozilla when mozillaHandlesKeyboard is set to True,
            otherwise key events are sent to Mozilla by the InternalBrowser
            script, allowing for in game IME implementation.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6932"></a>19.2.1.2.&nbsp;Creating a Game Integrated 2D Web GUI Component</h4></div></div></div><p>A game integrated 2D web GUI component is a web GUI component
        which can interact with the game logic. This allows building game GUI
        using fast development tools like HTML or Flash, and having them call
        Python methods using a JavaScript to Python or ActionScript to Python
        bridges. Please note that this BigWorld feature is not supported and
        we recommend using the ScaleForm solution for customers interested in
        such a solution. Implementing a Game Integrated 2D Web GUI Component
        is done similarly to the above Interactive Component but with several
        additional steps. The fantasydemo/res/gui/html_chat_window.gui
        contains an example html GUI component using the JavaScript to Python
        bridge.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Web_Screen"></a>19.2.2.&nbsp;In Game Web Screen</h3></div></div></div><p>An in game web screen is a 3D in game entity with similar
      capabilities and use cases as the previously explained Web GUI
      Component. The main difference between the Web GUI component and the in
      game web screen is that the Web Screen is part of the 3D game scene and
      not a 2D GUI component. This Web Screen is located in a specific world
      location and isn't available for gamers as part of their HUD.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e6942"></a>19.2.2.1.&nbsp;Creating an In Game Web Screen</h4></div></div></div><p>The WebScreen entity available as an example in
        fantasydemo/res/scripts/client/WebScreen.py implements an in game web
        screen. Following are the main considerations for creating an In Game
        Web Screen:</p><div class="itemizedlist"><ul type="disc"><li><p>The WebScreen entity uses a model with multiple tints, the
            current tint is fed by a TextureFeed created by the WebScreen
            entity. The parameters usedTint and textureFeedName control the
            entity model used tint and the TextureFeed name used by this
            entity. These should usually contain the same string based on the
            tints available for that model. These options are exposed as part
            of WorldEditor.</p></li><li><p>The model used by the WebScreen entity should also have
            three hard points called HP_top_left, HP_top_right,
            HP_bottom_left. These hard points are used by the
            _intersectMouseCoordinates method to find an intersection between
            a world ray and the entity model. This allows sending mouse events
            with a 2D position to the actual web page.</p></li><li><p>The webPage member of this entity contains a WebPageProvider
            and is used to render a web page and to send mouse and keyboard
            events to the web page.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Texture_Mapping"></a>19.2.3.&nbsp;Texture Mapping of Web Pages into a world object</h3></div></div></div><p>The TextureProvider returned by the WebPageProvider can be used to
      build a TextureFeed (similar to the one used for the WebScreen entity
      above). A VideoScreen Entity allows simple usage of the TextureFeed to
      map the texture into 3D world objects with the correct material settings
      (same as the tints used above). The exhibition room in the Urban space
      contains a teapot example of mapping a web texture into a world object
      using a VideoScreen entity.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Sounds"></a>Chapter&nbsp;20.&nbsp;Sounds</h2></div></div></div><p>BigWorld provides sound support via the third-party FMOD sound library
  (www.fmod.org). See the document "Third-Party Integrations" for more
  information.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_3D_Engine"></a>Chapter&nbsp;21.&nbsp;3D Engine (Moo)</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Features">21.1. Features</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e7014">21.1.1. D3DXEffects vertex and pixel shader support</a></span></dt><dt><span class="section"><a href="#d0e7021">21.1.2. Cubic environment maps</a></span></dt><dt><span class="section"><a href="#d0e7026">21.1.3. Render targets</a></span></dt><dt><span class="section"><a href="#xref_Lighting">21.1.4. Lighting</a></span></dt><dt><span class="section"><a href="#d0e7136">21.1.5. Normal mapping/bump mapping</a></span></dt><dt><span class="section"><a href="#d0e7141">21.1.6. Terrain</a></span></dt><dt><span class="section"><a href="#d0e7146">21.1.7. Animation</a></span></dt><dt><span class="section"><a href="#d0e7151">21.1.8. Vertex morphing</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e7158">21.2. Supported video cards</a></span></dt><dt><span class="section"><a href="#d0e7191">21.3. Hardware requirements for special effects</a></span></dt><dt><span class="section"><a href="#d0e7324">21.4. Visual</a></span></dt><dt><span class="section"><a href="#xref_EffectMaterial">21.5. EffectMaterial</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_EffectMaterial_Format">21.5.1. Format</a></span></dt><dt><span class="section"><a href="#xref_Automatic_Variables_Globals">21.5.2. Automatic variables/Globals</a></span></dt><dt><span class="section"><a href="#xref_Artist_Editable_Tweakable_Variables">21.5.3. Artist-editable/tweakable variables</a></span></dt><dt><span class="section"><a href="#d0e8227">21.5.4. Multiple-layered effects per material</a></span></dt><dt><span class="section"><a href="#d0e8237">21.5.5. Recording material states</a></span></dt><dt><span class="section"><a href="#d0e8261">21.5.6. Using BigWorld <span class="literal">.fx</span> files with 3ds Max</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8326">21.6. Visual channels</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8359">21.6.1. Sorted channel</a></span></dt><dt><span class="section"><a href="#d0e8371">21.6.2. Internal sorted channel</a></span></dt><dt><span class="section"><a href="#d0e8380">21.6.3. Shimmer channel</a></span></dt><dt><span class="section"><a href="#d0e8387">21.6.4. Sorted shimmer channel</a></span></dt><dt><span class="section"><a href="#d0e8397">21.6.5. Distortion channel</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Textures">21.7. Textures</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Texture_Details_Levels_Compression">21.7.1. Texture detail levels/compression</a></span></dt><dt><span class="section"><a href="#d0e8587">21.7.2. Animated textures</a></span></dt><dt><span class="section"><a href="#d0e8650">21.7.3. Applying a code-generated texture to a character</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e8829">21.8. Vertex declaration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e8849">21.8.1. File format</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Graphics_Settings">21.9. Graphics settings</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Customising_Options">21.9.1. Customising options</a></span></dt><dt><span class="section"><a href="#d0e9820">21.9.2. Using settings</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_High_Resolution_Screenshots">21.10. Taking Screenshots</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10078">21.10.1. High Resolution Screenshots</a></span></dt></dl></dd><dt><span class="section"><a href="#xref_Dynamic_Entity_Shadows">21.11. Dynamic Entity Shadows</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10227">21.11.1. Splodges</a></span></dt><dt><span class="section"><a href="#d0e10255">21.11.2. Shadow maps</a></span></dt></dl></dd></dl></div><p>Moo is a 3D engine using DirectX 9 that provides resource-, object-
  and device- based services up to, but not including the scene
  database.</p><p>Resource-based services include the generation and management of
  vertex buffers, index buffers, vertex shaders, pixel shaders, and effects.
  Textures are compressed and stored automatically. All resources that are not
  managed by Direct3D are managed by Moo, allowing for large amounts of data
  moving in and out of use.</p><p>Object-based services include a full animation system, skinned bipeds,
  compound skeletal geometrics, and specialised terrain rendering. Moo exposes
  the concept of a visual, an important mid-level geometric construct that
  sits beneath the scene database and greatly simplifies the scene database
  code.</p><p>Device-based services include level-of-detail control over rendering
  states, encapsulated in materials and shaders. The 3D window is encapsulated
  as a RenderContext, and provides frames-of-reference in which to render
  geometrics and store lighting states.</p><p>Finally, Moo provides the essential alpha-blended sorted triangle
  pipeline, a service that unfortunately is still not provided by Direct3D or
  directly in (most) hardware.</p><p>It is important to note that where possible, Moo uses underlying
  Direct3DX structures such as D3DXMatrix, D3DXVector, and D3DXQuaternion. The
  DirectX team continually improves the implementation of these mathematical
  classes, and their functionality often takes advantage of processor specific
  instructions, such as MMX, SIMD and 3DNow!. It is prudent to leverage the
  efforts of these engineers.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Features"></a>21.1.&nbsp;Features</h2></div></div></div><p>Some of the advanced features of Moo are listed below:</p><div class="itemizedlist"><ul type="disc"><li><p>D3DXEffects vertex and pixel shader support</p></li><li><p>Cubic environment maps</p></li><li><p>Render targets</p></li><li><p>Lighting</p></li><li><p>Normal mapping/bump mapping</p></li><li><p>Terrain</p></li><li><p>Animation</p></li><li><p>Vertex morphing</p></li></ul></div><p>The following sections describe these features.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7014"></a>21.1.1.&nbsp;D3DXEffects vertex and pixel shader support</h3></div></div></div><p>Effect files are used extensively in Moo. Most of the rendering
      pipeline is based around the class EffectMaterial, which implements a
      way of managing the global values used by the effects, and also the
      per-instance data for the effects, such as textures, self-illumination
      values, and specular reflection constants.</p><p>The effect files also make it easier to manage pixel and vertex
      shaders, as they are created together in one file. Using the D3DXEffect
      format removes much of the complexities of adding new shader effects to
      the engine and allows rapid prototyping of new visual effects.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7021"></a>21.1.2.&nbsp;Cubic environment maps</h3></div></div></div><p>Cubic environment maps can be used for some reflections and for
      normalisation cube maps (used for normal mapping).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7026"></a>21.1.3.&nbsp;Render targets</h3></div></div></div><p>Render targets are used to create billboard textures. They can
      also be used in conjunction with the GUI components to display 3D
      objects in the 2D GUI (for example, for item selection previews).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Lighting"></a>21.1.4.&nbsp;Lighting</h3></div></div></div><p>The lighting component of Moo supports three different kinds of
      lights:</p><div class="itemizedlist"><ul type="disc"><li><p>Directional lights.</p></li><li><p>Point lights.</p></li><li><p>Spot lights.</p></li></ul></div><p>Any object can be lit by two directional lights, four point lights
      and two spot lights. These lights are picked according to an attenuation
      metric, so that generally the closest lights will be chosen. It is also
      important to note that the fewer lights used, the faster the execution
      of the lighting vertex shader will be.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Light_Maps"></a>21.1.4.1.&nbsp;Light maps</h4></div></div></div><p>The class <span class="literal">bigworld/src/lib/romp/light_map.cpp</span>
        is generalised to support both the flora and sky light maps. Light
        maps are configurable in XML files.</p><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="xref_Flora_Light_Map"></a>21.1.4.1.1.&nbsp;Flora light map</h5></div></div></div><p>The flora light map details are specified in
          <span class="literal">flora.xml</span> (for details on this file's grammar,
          see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section
          <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_flora_xml" class="olink"><span class="literal"><em class="replaceable"><code>&lt;flora&gt;</code></em>.xml</span></a>)
          and its location is specified in the file
          <span class="literal">resources.xml</span> (for details on this file, see
          <a href="#xref_File_resources_xml" title="1.4.1.&nbsp;File resources.xml">File <span class="literal">resources.xml</span></a>).</p><p>The <span class="literal">material</span> tag for flora light map should
          be <span class="literal">system/materials/light_map.mfm</span> (for details on
          this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <span class="literal"><a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_material_mfm" class="olink"><i><span class="literal">.mfm</span></i></a></span>).</p><p>The default width/height for the flora light map is 64x64.
          This is small, but still enough resolution for the projection onto
          the flora, because its visible area is 100x100 metres.</p><div class="informalfigure"><div class="mediaobject"><img src="images/definition_of_flora_light_map.png"><span class="caption"><p>Definition of flora light map</p></span></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="xref_Sky_Light_Map"></a>21.1.4.1.2.&nbsp;Sky light map</h5></div></div></div><p>The sky light map details are specified in the space's
          <span class="literal">sky.xml</span> file, and its location is specified in
          the space's <span class="literal">space.settings</span> file (for details on
          this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_space_settings" class="olink"><i><span class="literal">space.settings</span></i></a>.).</p><p>The material tag for sky light map should be
          <span class="literal">system/materials/sky_light_map.mfm</span> (for details
          on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_material_mfm" class="olink"><i><span class="literal">.mfm</span></i></a>).</p><p>The default width/height for the sky light map is 512x512.
          This is quite large because the light map is projected across the
          whole visible world (usually around 1x1 km).</p><div class="informalfigure"><div class="mediaobject"><img src="images/definition_of_sky_light_map.png"><span class="caption"><p>Definition of sky light map</p></span></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The sky light map can be disabled via the
            <span class="literal">SKY_LIGHT_MAP</span> graphic setting (for details, see
            <a href="#xref_Customising_Options" title="21.9.1.&nbsp;Customising options">Customising options</a>).</p></div></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7136"></a>21.1.5.&nbsp;Normal mapping/bump mapping</h3></div></div></div><p>Normal mapping is used to add surface detail to objects by using
      per-texel normals baked into a texture. Moo currently supports normal
      maps for specular and diffuse lighting on dynamically lit objects, and
      specular lighting on statically lit objects. The current version of the
      Exporter supports tangent space normal mapping only.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7141"></a>21.1.6.&nbsp;Terrain</h3></div></div></div><p>Moo takes advantage of the multi-texture, vertex, and pixel
      shading capabilities of the supported graphics cards. Since it uses a
      blended 4-layered texturing system for the terrain, Moo utilises the
      hardware's four texture stages optimally so that that most of the
      terrain can be rendered in just one pass. The terrain also supports
      self-shadowing from a directional light source.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7146"></a>21.1.7.&nbsp;Animation</h3></div></div></div><p>Moo supports node-based and vertex-based (morph) animation. Moo
      can also blend animations together to provide smooth transitions between
      them.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e7151"></a>21.1.8.&nbsp;Vertex morphing</h3></div></div></div><p>Moo's vertex morphing is suitable for small changes in surfaces,
      such as facial animation. Morph targets are exported from the content
      creation package, and controlled through the normal animation
      system.</p><p>Please note that as morph targets are applied in software,
      extensive use will affect rendering performance.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e7158"></a>21.2.&nbsp;Supported video cards</h2></div></div></div><p>The currently supported graphics cards are as follows:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">NVIDIA</em></p><p>GeForce4 series, GeForce FX series, GeForce 6x00 series, GeForce
        7x00 series cards and above.</p></li><li><p><em class="emphasis">ATI</em></p><p>Radeon 9000 series, and Radeon x000 series of cards.</p></li></ul></div><p>Any graphics chip that supports at least Hardware Transform and
    Lighting and two texture stages should work, some with a limited subset of
    features enabled. These include (but are not limited to):</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">NVIDIA</em></p><p>GeForce3 series and GeForce GO 4 series cards.</p></li><li><p><em class="emphasis">ATI</em></p><p>Radeon 7000 series, Radeon 8000 series, Mobility 8000 and
        Mobility 9000 series.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e7191"></a>21.3.&nbsp;Hardware requirements for special effects</h2></div></div></div><p>The table below lists the special effects available in Moo, and
    their hardware requirements:</p><div class="altrow"><table border="0"><colgroup><col width="120"><col width="61"><col width="56"><col width="62"></colgroup><thead><tr><th>Special effect</th><th>Vertex shader version</th><th>Pixel shader version</th><th>Texture stages required</th></tr></thead><tbody><tr><td>Bloom</td><td>1.1</td><td>1.1</td><td>4</td></tr><tr><td>Cloud shadows</td><td>1.1</td><td>-</td><td>3</td></tr><tr><td>Flora</td><td>1.1</td><td>-</td><td>1</td></tr><tr><td>Heat Shimmer</td><td>1.1</td><td>-</td><td>1</td></tr><tr><td>Normal mapping</td><td>1.1</td><td>1.1</td><td>4</td></tr><tr><td>PyModel Shimmer</td><td>1.1</td><td>-</td><td>1</td></tr><tr><td>PyModel stipple</td><td>1.1</td><td>1.1</td><td>4</td></tr><tr><td>Entity shadows</td><td>2.0</td><td>2.0</td><td>1</td></tr><tr><td>Simulated sub-surface scattering</td><td>3.0</td><td>3.0</td><td>4</td></tr><tr><td>Sky Gradient dome</td><td>1.1</td><td>-</td><td>3</td></tr><tr><td>Terrain shadows</td><td>1.1</td><td>1.1</td><td>4</td></tr><tr><td>Terrain Specular</td><td>1.1</td><td>1.1</td><td>4</td></tr></tbody></table></div><p><span class="citetitle">Hardware requirements for special
    effects</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e7324"></a>21.4.&nbsp;Visual</h2></div></div></div><p>The <span class="literal">Visual</span> class implements the basic renderable
    objects drawn by the 3D engine. A visual contains a node hierarchy,
    vertices, indices, and materials used for rendering objects, and it also
    contains a BSP tree used for collision detection.</p><p>The node hierarchy gives the renderable object a frame of reference
    when rendering objects. Visual uses the <span class="literal">EffectMaterial</span>,
    <span class="literal">Primitives</span>, and <span class="literal">Vertices</span> classes to
    render its geometry.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_EffectMaterial"></a>21.5.&nbsp;EffectMaterial</h2></div></div></div><p>The material system in the BigWorld 3D engine uses
    <span class="literal">D3DXEffects</span> files extensively.</p><p>The material system is implemented through the class
    <span class="literal">EffectMaterial</span>, which contains one or more D3DX
    effects, their overridden values, and information about the collision
    properties and surface type of the material.</p><p>The idea behind the material system is to give as much control as
    possible to the artists, to allow them to experiment with new rendering
    techniques without involving programmers.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_EffectMaterial_Format"></a>21.5.1.&nbsp;Format</h3></div></div></div><p>The format of the <span class="literal">EffectMaterial</span> on disk is
      very simple, having only a handful of sections, and with most of the
      work done through the .fx file.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Automatic_Variables_Globals"></a>21.5.2.&nbsp;Automatic variables/Globals</h3></div></div></div><p>Automatic variables are used for any variable that is controlled
      by the engine, such as transforms, lights, camera positions, etc...
      Automatic variables are exposed to Effect files using variable
      semantics.</p><p>In an Effect file, the automatic variables are defined like
      below:</p><pre class="programlisting">&lt;<em class="replaceable"><code>type</code></em>&gt; &lt;<em class="replaceable"><code>variableName</code></em>&gt; : &lt;<em class="replaceable"><code>semantic</code></em>&gt;;</pre><p>where:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;<em class="replaceable"><code>type</code></em>&gt;</span></em></p><p>The variable type (float, bool, texture, etc.).</p></li><li><p><em class="emphasis"><span class="literal">&lt;<em class="replaceable"><code>variableName</code></em>&gt;</span></em></p><p>Name used for the variable in the effect file.</p></li><li><p><em class="emphasis"><span class="literal">&lt;<em class="replaceable"><code>semantic</code></em>&gt;</span></em></p><p>Name exposed to the engine.</p></li></ul></div><p>The automatic variables are connected to the effect through the
      class EffectConstantValue. New automatic variables can be added by
      overriding the EffectConstantValue interface, implementing the operation
      (), and adding an instance of the new class using
      EffectConstantValue::set or using a handle returned from
      EffectConstantValue::get.</p><p>The automatic variables set up by Moo::EffectVisualContext are
      listed below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">Ambient</span>
          (<span class="literal">float4</span>)</em></p><p>Current ambient colour.</p></li><li><p><em class="emphasis"><span class="literal">CameraPos</span>
          (<span class="literal">float3</span>)</em></p><p>Current camera position in world space.</p></li><li><p><em class="emphasis"><span class="literal">CameraPosObjectSpace</span>
          (<span class="literal">float3</span>)</em></p><p>Current camera position in object space.</p></li><li><p><em class="emphasis">DepthTex
          (<span class="literal">texture</span>)</em></p><p>The depth of the scene, stored encoded in a 32-bit RGBA
          texture. This is only available when the Advanced Post Processing
          graphics setting is switched on.</p></li><li><p><em class="emphasis"><span class="literal">DirectionalLightCount</span>
          (<span class="literal">int</span>)</em></p><p>Number of directional lights.</p></li><li><p><em class="emphasis"><span class="literal">DirectionalLights</span>
          (<span class="literal">DirectionalLights[2]</span>)</em></p><p>Current diffuse directional lights in world space.</p></li><li><p><em class="emphasis"><span class="literal">DirectionalLightsObjectSpace</span>
          (<span class="literal">DirectionalLights[2]</span>)</em></p><p>Current diffuse directional lights in object space.</p></li><li><p><em class="emphasis">EnvironmentCubeMap
          (<span class="literal">texture</span>)</em></p><p>Cube map containing a low-resolution dynamic cube map of the
          environment (sun, moon, sky gradient dome, sky boxes ).</p></li><li><p><em class="emphasis">EnvironmentTransform(<span class="literal">float4x4</span>)</em></p><p>Matrix used to transform environmental and skybox objects to
          the screen. Comes pre-multiplied with the projection matrix.</p></li><li><p><em class="emphasis">EnvironmentShadowTransform(<span class="literal">float4x4</span>)</em></p><p>Matrix used to transform environmental and skybox objects to
          the sky light map.</p></li><li><p><em class="emphasis">FarPlane
          (<span class="literal">float</span>)</em></p><p>Current far plane in metres.</p></li><li><p><em class="emphasis"><span class="literal">FloraAnimationGrid</span>
          (<span class="literal">float4[64]</span>)</em></p><p>8x8 array of Perlin noise values used to animate the flora
          vertex buffer.</p></li><li><p><em class="emphasis"><span class="literal">FloraTexture</span>
          (<span class="literal">texture</span>)</em></p><p>The composite Flora texture map used by the
          FloraRenderer.</p></li><li><p><em class="emphasis"><span class="literal">FogColour</span>
          (<span class="literal">float4</span>)</em></p><p>Fog colour.</p></li><li><p><em class="emphasis"><span class="literal">FogEnd</span>
          (<span class="literal">float</span>)</em></p><p>End of linear fog.</p></li><li><p><em class="emphasis"><span class="literal">FogGradientTexture</span>
          (<span class="literal">texture</span>)</em></p><p>The fog texture used by the terrain renderer.</p></li><li><p><em class="emphasis"><span class="literal">FogStart</span>
          (<span class="literal">float</span>)</em></p><p>Start of linear fog.</p></li><li><p><em class="emphasis"><span class="literal">FogTextureTransform</span>
          (<span class="literal">matrix</span>)</em></p><p>Projects the fog texture onto the terrain.</p></li><li><p><em class="emphasis"><span class="literal">GUIColour</span>
          (<span class="literal">float4</span>)</em></p><p>Colour for use by the GUI.</p></li><li><p><em class="emphasis"><span class="literal">LastViewProjection</span>
          (<span class="literal">float4x4</span>)</em></p><p>The last frame's view*projection matrix.</p></li><li><p><em class="emphasis"><span class="literal">InvView</span>
          (<span class="literal">float4x4</span>)</em></p><p>Current inverse view matrix.</p></li><li><p><em class="emphasis"><span class="literal">InvViewProjection</span>
          (<span class="literal">float4x4</span>)</em></p><p>Current inverse view*projection matrix.</p></li><li><p><em class="emphasis"><span class="literal">MipFilter</span>
          (<span class="literal">int</span>)</em></p><p>Configurable MIPFILTER.</p></li><li><p><em class="emphasis"><span class="literal">MinMagFilter</span>
          (<span class="literal">int</span>)</em></p><p>Configurable MIN/ MAGFILTER.</p></li><li><p><em class="emphasis"><span class="literal">MaxAnisotropy</span>
          (<span class="literal">int</span>)</em></p><p>Configurable MAXANISOTROPY.</p></li><li><p><em class="emphasis">NearPlane
          (<span class="literal">float</span>)</em></p><p>Current near plane in metres.</p></li><li><p><em class="emphasis"><span class="literal">NormalisationMap</span>
          (<span class="literal">texture</span>)</em></p><p>Normalisation cubemap.</p></li><li><p><em class="emphasis">ObjectID
          (<span class="literal">float</span>)</em></p><p>Set to 1 when rendering a PyModel, aka a dynamic/entity model.
          Set to 0 for all other models. In future, this may expand to
          designate further groups of objects.</p></li><li><p><em class="emphasis"><span class="literal">PenumbraSize</span>
          (<span class="literal">float</span>)</em></p><p>Used by the terrain renderer for self-shadowing.</p></li><li><p><em class="emphasis"><span class="literal">PointLightCount</span>
          (<span class="literal">int</span>)</em></p><p>Number of point lights.</p></li><li><p><em class="emphasis"><span class="literal">PointLights</span>
          (<span class="literal">PointLights[4]</span>)</em></p><p>Current diffuse point lights in world space.</p></li><li><p><em class="emphasis"><span class="literal">PointLightsObjectSpace</span>
          (<span class="literal">PointLights[4]</span>)</em></p><p>Current diffuse point lights in object space.</p></li><li><p><em class="emphasis">Screen
          (<span class="literal">float4</span>)</em></p><p>Holds the screen dimension thus : ( width, height, half width,
          half height )</p></li><li><p><em class="emphasis">SkyBoxController
          (<span class="literal">float4</span>)</em></p><p>Holds the current value of the Vector4 that was registered
          with the sky box currently being rendered. How this variable is
          interpreted is up to the individual sky box, although the fourth
          component is generally treated as an alpha value.</p></li><li><p><em class="emphasis"><span class="literal">SpecularDirectionalLightCount</span>
          (<span class="literal">int</span>)</em></p><p>Number of specular directional lights.</p></li><li><p><em class="emphasis"><span class="literal">SpecularDirectionalLights</span>
          (<span class="literal">DirectionalLights[2]</span>)</em></p><p>Current specular directional lights in world space.</p></li><li><p><em class="emphasis"><span class="literal">SpecularDirectionalLightsObjectSpace</span>
          (<span class="literal">DirectionalLights[2]</span>)</em></p><p>Current specular directional lights in object space.</p></li><li><p><em class="emphasis"><span class="literal">SpecularPointLightCount</span>
          (<span class="literal">int</span>)</em></p><p>Number of specular point lights.</p></li><li><p><em class="emphasis"><span class="literal">SpecularPointLights</span>
          (<span class="literal">PointLights[2]</span>)</em></p><p>Current specular point lights in world space.</p></li><li><p><em class="emphasis"><span class="literal">SpecularPointLightsObjectSpace</span>
          (<span class="literal">PointLights[2]</span>)</em></p><p>Current specular point lights in object space.</p></li><li><p><em class="emphasis"><span class="literal">SpotLightCount</span>
          (<span class="literal">int</span>)</em></p><p>Number of spot lights.</p></li><li><p><em class="emphasis"><span class="literal">SpotLights</span>
          (<span class="literal">SpotLights[2]</span>)</em></p><p>Current diffuse spot lights in world space.</p></li><li><p><em class="emphasis"><span class="literal">SpotLightsObjectSpace</span>
          (<span class="literal">SpotLights[2]</span>)</em></p><p>Current diffuse spot lights in object space.</p></li><li><p><em class="emphasis"><span class="literal">StaticLighting</span>
          (<span class="literal">bool</span>)</em></p><p>Whether static lighting is applied or not.</p></li><li><p><em class="emphasis"><span class="literal">StippleMap</span>
          (<span class="literal">texture</span>)</em></p><p>Map to be used for the stipple effect.</p></li><li><p><em class="emphasis"><span class="literal">SunAngle</span>
          (<span class="literal">float</span>)</em></p><p>Used by the terrain renderer for self-shadowing.</p></li><li><p><em class="emphasis"><span class="literal">TerrainTextureTransform</span>
          (<span class="literal">float4[2]</span>)</em></p><p>Projects textures onto the terrain.</p></li><li><p><em class="emphasis"><span class="literal">Time</span>
          (<span class="literal">float</span>)</em></p><p>Time in seconds since the game started.</p></li><li><p><em class="emphasis"><span class="literal">View</span>
          (<span class="literal">float4x4</span>)</em></p><p>Current view matrix.</p></li><li><p><em class="emphasis"><span class="literal">ViewProjection</span>
          (<span class="literal">float4x4</span>)</em></p><p>Current view*projection matrix.</p></li><li><p><em class="emphasis"><span class="literal">WindAnimation</span>
          (<span class="literal">float4</span>)</em></p><p>Two Vector2's. in (x,y) is a value that can be used for
          wind-affected texture scrolling. It keeps the incremental value of a
          single uv coordinate blown around by the wind. in (x,z) is the
          current wind average speed.</p></li><li><p><em class="emphasis"><span class="literal">World</span>
          (<span class="literal">float4x4</span>)</em></p><p>Current world matrix.</p></li><li><p><em class="emphasis"><span class="literal">WorldPalette</span>
          (<span class="literal">float4[17*3]</span>)</em></p><p>Matrix palette, made up of the current renderset matrices
          stored as transposed 4x3 matrices.</p></li><li><p><em class="emphasis"><span class="literal">WorldView</span>
          (<span class="literal">float4x4</span>)</em></p><p>Current world*view matrix.</p></li><li><p><em class="emphasis"><span class="literal">WorldViewProjection</span>
          (<span class="literal">float4x4</span>)</em></p><p>Current world*view*projection matrix.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Artist_Editable_Tweakable_Variables"></a>21.5.3.&nbsp;Artist-editable/tweakable variables</h3></div></div></div><p>Artist-editable variables are variables that are designed to be
      overridden on a per-material basis. These variables can be edited in
      WorldEditor and ModelEditor, allowing you to change the look of a model
      in real time, while visualising it.</p><p>The artist-editable variables can be exposed to the engine by
      setting the attribute <span class="literal">artistEditable</span> or
      <span class="literal">worldBuilderEditable</span> to
      <span class="literal">true</span>.</p><p>Setting <span class="literal">artistEditable</span> to
      <span class="literal">true</span> exposes the variable to ModelEditor's <em class="emphasis">Materials Settings</em> panel (for details, see the
      document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s section
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_ModelEditor" class="olink"><i>ModelEditor</i></a> <span class="symbol">&#8594;</span>
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_me_Panel_Summary" class="olink">Panel summary</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_me_Material_Settings_Panel" class="olink">Materials Settings panel</a>), while setting
      <span class="literal">worldBuilderEditable</span> to <span class="literal">true</span>
      exposes it to both ModelEditor and, if the
      <span class="literal">objects/materialOverrideMode</span> tag is set to
      <span class="literal">1</span> in
      <span class="literal">bigworld/tools/worldeditor/options.xml</span> (for details
      on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_options_xml" class="olink"><i><span class="literal">options.xml</span></i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_options_xml_WorldEditor" class="olink">WorldEditor</a>) file, to WorldEditor's
      <em class="emphasis">Properties</em> panel (for details, see the
      document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s section
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_WorldEditor" class="olink"><i>WorldEditor</i></a> <span class="symbol">&#8594;</span>
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_we_Panel_Summary" class="olink">Panel summary</a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_we_Properties_Panel" class="olink">Properties panel</a>).</p><p>The notation for these variables in a FX file is described
      below:</p><pre class="programlisting">&lt;type&gt; &lt;variableName&gt;
&lt;
  bool [artistEditable|worldBuilderEditable] = true;
  ... <a name="co6977"></a><img src="../images/callouts/1.png" alt="1" border="0">
&gt; = &lt;defaultValue&gt;;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a href="#co6977"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>Other attribute definitions.</p></td></tr></table></div><p>where:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">&lt;type&gt;</span></em> &#8212; Type of the
          object.</p></li><li><p><em class="emphasis"><span class="literal">&lt;variableName&gt;</span></em> &#8212;
          Variable name in the effect file.</p></li><li><p><em class="emphasis"><span class="literal">&lt;defaultValue&gt;</span></em> &#8212;
          Default value of the variable.</p></li></ul></div><p>Currently, the supported types of artist-editable variables
      are:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">bool</span></em></p></li><li><p><em class="emphasis"><span class="literal">float</span></em></p></li><li><p><em class="emphasis"><span class="literal">float4</span></em></p></li><li><p><em class="emphasis"><span class="literal">float4x4</span></em></p></li><li><p><em class="emphasis"><span class="literal">int</span></em></p></li><li><p><em class="emphasis"><span class="literal">texture</span></em></p></li></ul></div><p>The conditions to have the variable exposed in either tool are
      described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">If <span class="literal">artistEditable</span> is
          set to <span class="literal">true</span> in the FX file</em></p><p><em class="emphasis">Exposed in ModelEditor?</em>:
          Yes</p><p><em class="emphasis">Exposed in WorldEditor?</em>:
          No</p></li><li><p><em class="emphasis">If
          <span class="literal">worldBuilderEditable</span> is set to
          <span class="literal">true</span> in the FX file</em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis">If
              <span class="literal">materialOverrideMode</span> is set to
              <span class="literal">1</span> in <span class="literal">bigworld/tools/
              worldeditor/options.xml</span></em></p><p><em class="emphasis">Exposed in ModelEditor?</em>:
              No</p><p><em class="emphasis">Exposed in WorldEditor?</em>:
              No</p></li><li><p><em class="emphasis">If
              <span class="literal">materialOverrideMode</span> is set to
              <span class="literal">0</span> in <span class="literal">bigworld/tools/
              worldeditor/options.xml</span></em></p><p><em class="emphasis">Exposed in ModelEditor?</em>:
              No</p><p><em class="emphasis">Exposed in WorldEditor?</em>:
              Yes</p></li></ul></div></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8227"></a>21.5.4.&nbsp;Multiple-layered effects per material</h3></div></div></div><p>The <span class="literal">Moo::EffectMaterial</span> class supports having
      multiple-layered D3DXEffects per material.</p><p>This is useful for materials that need to use a standard set of
      vertex shaders, but only have slight changes to the pixel shader
      component of the effect. These materials would generally only be created
      by the asset converter, as ModelEditor does not support adding more than
      one effect per material.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8237"></a>21.5.5.&nbsp;Recording material states</h3></div></div></div><p>Material states can be recorded by class
      <span class="literal">Moo::EffectMaterial</span> by calling the method
      <span class="literal">recordPass()</span> between a <span class="literal">begin()</span> and
      <span class="literal">end()</span> pair on the material.</p><p>This method returns a <span class="literal">Moo::StateRecorder</span> that
      is used to store the current render states for delayed rendering.</p><p>This object only stays valid until the end of the current render
      loop, and will not be usable after this point.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8261"></a>21.5.6.&nbsp;Using BigWorld <span class="literal">.fx</span> files with 3ds Max</h3></div></div></div><p>BigWorld <span class="literal">.fx</span> files and 3ds Max .fx files
      unfortunately are not 100% compatible. It is however possible to create
      a <span class="literal">.fx</span> file that can be used in both
      applications.</p><p>To expose editable parameters, BigWorld shaders use the annotation
      below:</p><pre class="programlisting">bool artistEditable = true;</pre><p>whereas 3ds Max requires the annotation string below:</p><pre class="programlisting">UIName="name"</pre><p>The sample effect file
      <span class="literal">bigworld/res/shaders/std_effects/normalmap.fx</span> exposes
      its parameters properly to BigWorld and 3ds Max. The exporter also
      exports the values entered in the 3ds Max shader material panel.</p><p>The file <span class="literal">normalmap.fx</span> also uses a separate
      technique, called <span class="literal">max_preview</span>, plus additional vertex
      and pixel shaders.</p><p>This is due to two reasons:</p><div class="itemizedlist"><ul type="disc"><li><p>There is no uniform way to apply the lighting in both the
          BigWorld engine and 3ds Max.</p></li><li><p>3ds Max uses a right-handed coordinate system, while BigWorld
          uses a left-handed one.</p></li></ul></div><p>In itself this is not a big problem, but it means that additional
      shader work is required if you want to preview your shaders in 3ds
      Max.</p><p>If you have not applied Service Pack 1for 3ds Max 7, an issue
      exists in that its <em class="emphasis">Material Panel</em> is
      very poor at dealing with <span class="literal">#include</span> directives in the
      effect files. What happens is that if you save a material with the
      effect <span class="literal">normalmap</span> applied, then not always it will be
      properly loaded up again in 3ds Max, which can cause additional
      confusion for the artists. This problem has been fixed in Service Pack
      1, so it is important to apply it if you want to use
      <span class="literal">.fx</span> files in 3ds Max.</p><p>It is important to be mindful of these issues before you decide to
      make your <span class="literal">.fx</span> files compatible with 3ds Max.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e8326"></a>21.6.&nbsp;Visual channels</h2></div></div></div><p>The visual channels implement the delayed rendering pipeline in
    Moo.</p><p>There are presently five standard channels implemented:</p><div class="itemizedlist"><ul type="disc"><li><p>Sorted channel</p></li><li><p>Internal sorted channel</p></li><li><p>Shimmer channel</p></li><li><p>Sorted shimmer channel</p></li><li><p>Distortion channel</p></li></ul></div><p>An application can create as many channels as it wants by overriding
    the <span class="literal">Moo::VisualChannel</span> interface and implementing
    <span class="literal">VisualChannel::addItem</span>.</p><p>The following sub-sections describe these channels.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8359"></a>21.6.1.&nbsp;Sorted channel</h3></div></div></div><p>The sorted channel is used for objects that need to be rendered in
      a back-to-front order.</p><p>When a primitive group from a visual is added to this channel, its
      triangles are not sorted internally.</p><p>This channel is mostly useful for additive objects,
      <em class="emphasis">i.e.</em>, objects with a destination blend of
      one.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8371"></a>21.6.2.&nbsp;Internal sorted channel</h3></div></div></div><p>The internal sorted channel is used for objects that need to be
      rendered in a back-to-front order, and also have its triangles rendered
      in a back-to-front order.</p><p>Objects that are added to this channel will also be sorted against
      objects in the sorted channel.</p><p>This channel is useful for alpha-blended objects, and any
      transparent object that does not have a destination blend of one.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8380"></a>21.6.3.&nbsp;Shimmer channel</h3></div></div></div><p>The shimmer channel is used for objects that need a heat
      shimmer.</p><p>Any object that is added to this channel should only write to the
      alpha channel of the frame buffer.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8387"></a>21.6.4.&nbsp;Sorted shimmer channel</h3></div></div></div><p>The <em class="emphasis">sorted shimmer channel</em> is used for
      objects that need a heat shimmer, and also need to draw colour
      information.</p><p>Any object added to this channel should write to both the alpha
      channel (for shimmer amount) and colour channel of the frame
      buffer.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8397"></a>21.6.5.&nbsp;Distortion channel</h3></div></div></div><p>The <em class="emphasis">distortion channel</em> is used for objects
      that want direct access to the final scene as a texture. This can be
      used to achieve effects like refraction (for example, the water).</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Textures"></a>21.7.&nbsp;Textures</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Texture_Details_Levels_Compression"></a>21.7.1.&nbsp;Texture detail levels/compression</h3></div></div></div><p>Textures are loaded and compressed automatically based on their
      filenames, which control the size, format conversions, and compression
      levels.</p><p>For details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_texformat" class="olink"><i><span class="literal">.texformat</span></i></a>.</p><p>The system is implemented through the class
      <span class="literal">Moo::TextureDetailLevel</span>. The Texture Manager stores a
      list of texture detail levels and uses them to resize and compress
      textures based on their filenames. The legacy
      <span class="literal">.texformat</span> system is still supported.</p><p>The properties for the <span class="literal">TextureDetailLevel</span> are
      divided into two sets:</p><div class="itemizedlist"><ul type="disc"><li><p>Filename matching criterion.</p></li><li><p>Conversion rule.</p></li></ul></div><p>The filename matching criterion set of properties defines the
      criteria used to check if the current TextureDetailLevel applies to the
      texture being checked. They are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">contains_</span></em></p><p>Matched strings for a string contained in the texture
          filename.</p></li><li><p><em class="emphasis"><span class="literal">postFixes_</span></em></p><p>Matched strings for the postfixes of the texture
          filename.</p></li><li><p><em class="emphasis"><span class="literal">preFixes_</span></em></p><p>Matched strings for the prefixes of the texture
          filename.</p></li></ul></div><p>Only one string from each list of strings has to match the texture
      name for the <span class="literal">TextureDetailLevel</span> to consider it a
      match. If there are no strings in one of the lists, that will be
      considered a match as well.</p><p>The conversion rule set of properties defines how matching
      textures will be converted. They are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">compressedFormat_</span></em></p><p>Format to which convert the texture (when texture compression
          is enabled).<sup>AB</sup></p></li><li><p><em class="emphasis"><span class="literal">format_</span></em></p><p>The format to convert the texture to.</p></li><li><p><em class="emphasis"><span class="literal">lodMode_</span></em></p><p>Defines how texture responds to the texture quality
          settings.</p><p>Texture quality is set via <span class="literal">TEXTURE_QUALITY</span>
          graphics setting.<sup>AB</sup></p></li><li><p><em class="emphasis"><span class="literal">maxDim_</span></em></p><p>The maximum width/height dimension of the texture.</p></li><li><p><em class="emphasis"><span class="literal">minDim_</span></em></p><p>The minimum width/height dimension of the texture.</p></li><li><p><em class="emphasis"><span class="literal">noResize_</span></em></p><p>Determines that the texture will not be scaled to be a power
          of two, and will not have mipmapping, compression or a .dds
          version.</p></li><li><p><em class="emphasis"><span class="literal">reduceDim_</span></em></p><p>The number of times to halve the dimensions of the texture
          when compression is disabled.<sup>A</sup></p></li></ul></div><p><em class="emphasis"><em class="emphasis">A</em> &#8212; Texture
      compression can be toggled via TEXTURE_COMPRESSION graphics
      setting.<sup>B</sup> </em></p><p><em class="emphasis"><em class="emphasis">B</em> &#8212; For details, see
      <a href="#xref_Graphics_Settings" title="21.9.&nbsp;Graphics settings">Graphics settings</a>.</em></p><p>The texture detail level can be read from a datasection, as
      displayed in the example below:</p><pre class="programlisting">&lt;prefix&gt;     objects/ &lt;/prefix&gt;
&lt;postfix&gt;    tga      &lt;/postfix&gt;
&lt;postfix&gt;    bmp      &lt;/postfix&gt;
&lt;contains&gt;   norms    &lt;/contains&gt;
&lt;contains&gt;   normals  &lt;/contains&gt;
&lt;maxDim&gt;     512      &lt;/maxDim&gt;
&lt;minDim&gt;     128      &lt;/minDim&gt;
&lt;reduceDim&gt;  1        &lt;/reduceDim&gt;
&lt;format&gt;     A8R8G8B8 &lt;/format&gt;</pre><p><span class="citetitle">Example texture detail level format</span></p><p>The example above results in any texture loaded from a sub-tree of
      folder objects/ with the extension <span class="literal">.tga</span> or
      <span class="literal">.bmp</span> and that contains the string norms or normals to
      have its dimensions reduced by half once, as long as the smallest
      dimension does not fall below 128. If the format is different, it will
      be changed to a 32-bit colour with alpha.</p><p>The default detail levels are:</p><div class="itemizedlist"><ul type="disc"><li><p>Any file with a filename ending in
          <span class="literal">norms.tga</span> or <span class="literal">norms.bmp</span> will be
          converted to an A8R8G8B8 texture (so as to not compress BigWorld's
          normal maps).</p></li><li><p>Any other <span class="literal">.tga</span> file is converted to the
          DXT3 format.</p></li><li><p>Any other <span class="literal">.bmp</span> file is converted to the
          DXT1 format.</p></li></ul></div><p>By default textures are only scaled down if their dimensions are
      bigger than 2048.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8587"></a>21.7.2.&nbsp;Animated textures</h3></div></div></div><p>Moo supports simple animated textures by texture swapping.</p><p>When Texture Manager loads a texture, it will look for a file with
      the same name as the one being loaded, but with a
      <span class="literal">.texanim</span> extension. If such file is found, then it
      will be loaded as an animated texture.</p><p>The <span class="literal">.texanim</span> file is a simple XML file that
      references a number of textures, contains an animation string and a
      frames-per-second value.</p><p>The format of a <span class="literal">.texanim</span> file is described
      below:</p><pre class="programlisting"> &lt;frames&gt;  <em class="replaceable"><code>string</code></em>           &lt;/frames&gt;
 &lt;fps&gt;     <em class="replaceable"><code>.f</code></em>               &lt;/fps&gt;
+&lt;texture&gt; <em class="replaceable"><code>TEXTURE_RESOURCE</code></em> &lt;/texture&gt;</pre><p><span class="citetitle">File <span class="literal">.texanim</span>
      format</span></p><p>An example of a <span class="literal">.texanim</span> file is displayed
      below:</p><pre class="programlisting">&lt;frames&gt;  abcdefgh              &lt;/frames&gt;
&lt;fps&gt;     10.0                  &lt;/fps&gt;
&lt;texture&gt; maps/fx/fx_dirt01.tga &lt;/texture&gt;
&lt;texture&gt; maps/fx/fx_dirt02.tga &lt;/texture&gt;
&lt;texture&gt; maps/fx/fx_dirt03.tga &lt;/texture&gt;
&lt;texture&gt; maps/fx/fx_dirt04.tga &lt;/texture&gt;
&lt;texture&gt; maps/fx/fx_dirt05.tga &lt;/texture&gt;
&lt;texture&gt; maps/fx/fx_dirt06.tga &lt;/texture&gt;
&lt;texture&gt; maps/fx/fx_dirt07.tga &lt;/texture&gt;
&lt;texture&gt; maps/fx/fx_dirt08.tga &lt;/texture&gt;</pre><p><span class="citetitle">Example file <span class="literal">.texanim</span>
      format</span></p><p>In this case, the animating texture will play the
      <span class="literal">fx_dirt</span> textures back in order at a rate of ten
      frames per second.</p><p>You can change the order in which the frames are played back by
      changing the <span class="literal">frames</span> tag . The <span class="literal">a</span> in
      the tag's value refers to the first texture stored in the XML file, b
      refers to the second texture stored, and so on.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8650"></a>21.7.3.&nbsp;Applying a code-generated texture to a character</h3></div></div></div><p>To apply a code-generated texture to a model, follow the steps
      below:</p><div class="orderedlist"><ol type="1"><li><p>Create an automatic <span class="literal">.fx</span> variable
          (<em class="emphasis">e.g.</em>,
          <span class="literal">customTexture</span>).</p></li><li><p>Update the character's shaders so that they render using the
          new <span class="literal">.fx</span> variable, instead of the
          <span class="literal">diffuseMap</span> property.</p></li><li><p>You will need a single <span class="literal">TextureSetter</span>, which
          is a <span class="literal">Moo::EffectConstantValue</span>. This provides the
          "current custom texture" to <span class="literal">.fx</span> files.</p></li><li><p>Write a <span class="literal">PyFashion</span> that sets up the "current
          custom texture" when drawing an instance of a
          <span class="literal">PyModel</span>.</p></li><li><p>Create a <span class="literal">Moo::BaseTexture</span> that wraps the
          custom texture creation process.</p></li></ol></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Loading_Textures_From_Disk"></a>21.7.3.1.&nbsp;Loading textures from disk</h4></div></div></div><p>When loading texture from disk, it is recommended to have the
        loading thread running in the background, so that it does not
        interrupt the rendering thread.</p><p>The example below illustrates a texture loader using the
        <span class="literal">BackgroundTask</span> and <span class="literal">BGTaskManager</span>
        classes. Note that the code provides two features &#8212; threaded texture
        loading, and providing the texture to the <span class="literal">.fx</span> file
        system.</p><pre class="programlisting">#include "pch.hpp"
#include "cstdmf/bgtask_manager.hpp"
#include "cstdmf/concurrency.hpp"

DECLARE_DEBUG_COMPONENT2( "romp", 0 );

// -------------------------------------------------------------------------
// Section: Texture Setter
// -----------------------------------------------------------------------
/**
 *  This class sets textures on the device.  It is also multi-threaded.
 *  When it is told to use a new texture, it uses the background loading thread
 *  to do so.  While it is doing this, the textureName refers to the new
 *  texture, but isLoading() will return true.  And in this state, it will be
 *  sneakily using the pre-existing texture until the new one is ready.
 */
class ThreadedTextureSetter : public Moo::EffectConstantValue
{
public:
  ThreadedTextureSetter():
    pTexture_( NULL ),
    bgLoader_( NULL ),
    textureName_( "" )
  {    
  }
  /**
   *  This method is called by the effect system when a material needs
   *  to draw using a texture with the given automatic semantic.
   */
  bool operator()(ID3DXEffect* pEffect, D3DXHANDLE constantHandle)
  {
    SimpleMutexHolder holder( mutex_ );

    if (pTexture_ &amp;&amp; pTexture_-&gt;pTexture())
      pEffect-&gt;SetTexture(constantHandle, pTexture_-&gt;pTexture());
    else
      pEffect-&gt;SetTexture(constantHandle, NULL);

    return true;
  }

  /**
   *  This method sets our texture.  If the texture is different then
   *  the existing one, we schedule the new one for loading, and set
   *  the textureName and the isLoading() flag.  In an unspecified amount
   *  of time, the new texture will be loaded and used.
   */
  void texture( const std::string&amp; texName )
  {
    if (textureName_ == texName)
      return;
    
    if (this-&gt;isLoading())
      return;
    
    textureName_ = texName;    
    
    bgLoader_ = new BackgroundTask(
            &amp;ThreadedTextureSetter::loadTexture, this,
            &amp;ThreadedTextureSetter::onLoadComplete, this );

#ifndef EDITOR_ENABLED
    BgTaskManager::instance()-&gt;addTask( *bgLoader_ );
#else
    ThreadedTextureSetter::loadTexture( this );
    ThreadedTextureSetter::onLoadComplete( this );
#endif
  }

  /**
   *  This class-static method is called by the background loading thread
   *  and allows us to load the texture resource in a blocking manner.
   */
  static void loadTexture( void* s )
  {
    ThreadedTextureSetter* setter = static_cast&lt;ThreadedTextureSetter*&gt;(s);
    Moo::BaseTexturePtr pTex = 
      Moo::TextureManager::instance()-&gt;get( setter-&gt;textureName() );
    setter-&gt;pTexture(pTex);
  }

  /**
   *  This class-static method is called when the background loading thread
   *  has finished.
   */
  static void onLoadComplete( void* s )
  {
    ThreadedTextureSetter* setter = static_cast&lt;ThreadedTextureSetter*&gt;(s);
    setter-&gt;onBgLoadComplete();
  }

  /**
   *  This method returns the name of the texture we are currently
   *  drawing with.  If isLoading() is true, then the textureName
   *  refers to the texture we would like to draw with (however we
   *  will be actually drawing with the previous texture ptr).
   */
  const std::string&amp; textureName() const
  {
    return textureName_;
  }

  /**
   *  This method returns true if we are currently waiting for the
   *  background loading thread to load our texture.
   */
  bool isLoading()
  {
    SimpleMutexHolder holder( mutex_ );
    return (bgLoader_ != NULL);
  }

private:
  //only called by the background loading thread
  void pTexture( Moo::BaseTexturePtr pTex )
  {    
    SimpleMutexHolder holder( mutex_ );
    pTexture_ = pTex;    
  }

  //only called by the background loading thread
  void onBgLoadComplete()
  {
    SimpleMutexHolder holder( mutex_ );
    delete bgLoader_;
    bgLoader_ = NULL;
  }

  Moo::BaseTexturePtr pTexture_;
  std::string textureName_;  //store a copy for use while loading.
  BackgroundTask* bgLoader_;  
  SimpleMutex    mutex_;
};</pre><p><span class="citetitle">Example of texture loader</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e8725"></a>21.7.3.2.&nbsp;Manipulate individual pixels within a texture</h4></div></div></div><p>To manipulate pixel within a code-generated texture, there are
        at least two available options:</p><div class="orderedlist"><ol type="1"><li><p><em class="emphasis">Create the texture in the managed
            pool</em></p><p>This way there will be a system memory copy and a video
            memory copy. You can then lock the texture and manipulate it as
            needed &#8212; DirectX will update the changes to video memory.</p><p>The only drawback to this option is that on some hardware
            configurations, the system memory texture may be stored swizzled,
            meaning that the lock operation would have to unswizzle it before
            you can make changes &#8212; a potentially costly lock operation.</p><p>Note that to use the texture, you will need to have mipmaps
            available, so when performing the lock you will have to
            either:</p><div class="itemizedlist"><ul type="disc"><li><p>Update each surface of the texture individually.</p><p><em class="emphasis">&#8212; or &#8212;</em></p></li><li><p>Use stretch rect to supply the mipmap chain from the top
                surface.</p></li></ul></div></li><li><p><em class="emphasis">Create the texture in video memory as
            a render target</em></p><p>You will have to use shaders to write your changes to the
            texture.</p><p>The drawback to this method is that if the device is reset,
            then your changes will be lost. If that happens, you will have to
            handle the CreateUnmanagedObjects callback (from the
            DeviceCallback interface) and recreate the custom texture.</p><p>Unfortunately, you cannot just copy the data to system
            memory, because a CTRL+ALT+DEL will lose the device without giving
            you a chance to save the video memory data first.</p><p>Note again that to use the texture, you will need to have
            mipmaps available. So perhaps in this instance you can create a
            separate mipmap texture in video memory, and use stretch rect to
            supply the mipmap chain from the source render target. The source
            render target might be a 'scratch pad' used in building all the
            custom character textures.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e8763"></a>21.7.3.3.&nbsp;Using a shader to build a custom texture</h4></div></div></div><p>The closest example on how to achieve this is provided by the
        flora light map, which uses a variation of the terrain shaders to
        render the lighting information to a render target. For details, see
        bigworld/src/lib/romp/flora_light_map.cpp.</p><p>Note that to use shaders you will need a video memory/render
        target surface as described in the section above.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e8770"></a>21.7.3.4.&nbsp;Dealing with the texture cache</h4></div></div></div><p>The custom texture is needed to implement the Moo::BaseTexture
        interface, so that it can add itself to the Texture Manager. However,
        depending on the following step (applying custom textures to models),
        you may not even need to use the TextureManager, as it simply provides
        a 'retrieve texture by name' access to textures.</p><p>If you are creating several custom textures for characters, then
        you may have an internal (hidden) naming scheme, which would result in
        a minimal benefit for using the texture cache. It may be good enough
        simply to use smart pointers to handle caching.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e8777"></a>21.7.3.5.&nbsp;Assigning custom textures to a model</h4></div></div></div><p>Assuming that you have one model that you want display many
        times, each with a unique custom texture, then you will have to
        implement a class deriving from the <span class="literal">PyFashion</span>
        class.</p><p>Such classes are created from Python, assigned to a
        <span class="literal">PyModel</span> instance, and given an opportunity to alter
        how a shared model renders (<em class="emphasis">i.e.</em>, to set the
        custom texture on the model). The <span class="literal">PyFashion</span> class
        will become the main interface to your scripts, so in Python you can
        construct the <span class="literal">PyFashion</span> instance with the names of
        the texture you want to combine, and then assign it to a player's
        model by simply setting the fashion as any named attribute on its
        <span class="literal">PyModel</span> (<span class="literal">PyModel::pySetAttribute</span>
        automatically detects when a fashion is set on itself, and
        incorporates it into its rendering chain).</p><p>To actually set the custom texture on the model, we recommend
        creating a class deriving from
        <span class="literal">Moo::EffectConstantValue</span>, and that provides the
        custom texture to <span class="literal">.fx</span> files by name. In the
        <span class="literal">.fx</span> files, use the automatic variable semantic
        (<em class="emphasis">e.g.</em>, <span class="literal">Texture diffuseMap
        :customCharacterTexture</span>), instead of the existing
        <span class="literal">artistEditable</span> property.</p><p>For an example code on creating a texture setter, see <a href="#xref_Loading_Textures_From_Disk" title="21.7.3.1.&nbsp;Loading textures from disk">Loading textures from disk</a>.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e8829"></a>21.8.&nbsp;Vertex declaration</h2></div></div></div><p>Vertex declarations are used by Direct3D to map vertex stream data
    to vertex shaders.</p><p>Moo uses the <span class="literal">VertexDeclaration</span> class to ease the
    handling of vertex declarations used by Direct3D. Vertex declarations are
    stored on disk in XML format and loaded as needed. The vertex declarations
    stored on disk can be retrieved by calling method
    <span class="literal">VertexDeclaration::get()</span>.</p><p>By default, the vertex declarations are stored under folder
    bigworld/res/shaders/ formats.</p><p>Two declarations can be combined with
    <span class="literal">VertexDeclaration::combine()</span> as long as the elements of
    both declarations are mutually exclusive.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e8849"></a>21.8.1.&nbsp;File format</h3></div></div></div><p>The format of the vertex declaration file is described
      below:</p><pre class="programlisting">&lt;root&gt;

  +&lt;USAGE&gt; (usage index, optional defaults to 0)

    ?&lt;stream&gt; (strm #, opt, dflt is strm used by the prev elmnt)     &lt;/stream&gt;
    ?&lt;offset&gt; (ofst into strm, opt, dflt is nxt ofst aft prev elmnt) &lt;/offset&gt;
    ?&lt;type&gt;    (data type, opt, defaults to FLOAT3)                   &lt;/type&gt;

   &lt;/USAGE&gt;

&lt;/root&gt;</pre><p><span class="citetitle">Vertex declaration file format</span></p><p>The <span class="literal">USAGE</span> tag maps to the enumerated type
      <span class="literal">D3DDECLUSAGE</span>, and its possible values are listed
      below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">POSITION</span></em></p></li><li><p><em class="emphasis"><span class="literal">BLENDWEIGHT</span></em></p></li><li><p><em class="emphasis"><span class="literal">BLENDINDICES</span></em></p></li><li><p><em class="emphasis"><span class="literal">NORMAL</span></em></p></li><li><p><em class="emphasis"><span class="literal">PSIZE</span></em></p></li><li><p><em class="emphasis"><span class="literal">TEXCOORD</span></em></p></li><li><p><em class="emphasis"><span class="literal">TANGENT</span></em></p></li><li><p><em class="emphasis"><span class="literal">BINORMAL</span></em></p></li><li><p><em class="emphasis"><span class="literal">TESSFACTOR</span></em></p></li><li><p><em class="emphasis"><span class="literal">POSITIONT</span></em></p></li><li><p><em class="emphasis"><span class="literal">COLOR</span></em></p></li><li><p><em class="emphasis"><span class="literal">FOG</span></em></p></li><li><p><em class="emphasis"><span class="literal">DEPTH</span></em></p></li><li><p><em class="emphasis"><span class="literal">SAMPLE</span></em></p></li></ul></div><p>The data types entered in the <span class="literal">type</span> tag map to
      enumerated type <span class="literal">D3DDECLTYPE</span>, and its possible values
      are listed below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">D3DCOLOR</span></em></p></li><li><p><em class="emphasis"><span class="literal">DEC3N</span></em></p></li><li><p><em class="emphasis"><span class="literal">FLOAT1</span></em></p></li><li><p><em class="emphasis"><span class="literal">FLOAT16_2</span></em></p></li><li><p><em class="emphasis"><span class="literal">FLOAT16_4</span></em></p></li><li><p><em class="emphasis"><span class="literal">FLOAT2</span></em></p></li><li><p><em class="emphasis"><span class="literal">FLOAT3</span></em></p></li><li><p><em class="emphasis"><span class="literal">FLOAT4</span></em></p></li><li><p><em class="emphasis"><span class="literal">SHORT2</span></em></p></li><li><p><em class="emphasis"><span class="literal">SHORT2N</span></em></p></li><li><p><em class="emphasis"><span class="literal">SHORT4</span></em></p></li><li><p><em class="emphasis"><span class="literal">SHORT4N</span></em></p></li><li><p><em class="emphasis"><span class="literal">UBYTE4</span></em></p></li><li><p><em class="emphasis"><span class="literal">UBYTE4N</span></em></p></li><li><p><em class="emphasis"><span class="literal">UDEC3</span></em></p></li><li><p><em class="emphasis"><span class="literal">USHORT2N</span></em></p></li><li><p><em class="emphasis"><span class="literal">USHORT4N</span></em></p></li></ul></div><p>As an example, the <span class="literal">xyznuv_d</span> vertex format is
      defined like this:</p><pre class="programlisting">&lt;xyznuv_d.xml&gt;

  &lt;POSITION/&gt; 
  &lt;NORMAL/&gt;
  &lt;TEXCOORD&gt;
    &lt;type&gt;  FLOAT2  &lt;/type&gt;
  &lt;/TEXCOORD&gt;
  &lt;COLOR&gt;
    &lt;stream&gt; 1         &lt;/stream&gt;
    &lt;offset&gt; 0         &lt;/offset&gt;
    &lt;type&gt;   D3DCOLOR  &lt;/type&gt;
  &lt;/COLOR&gt;

&lt;/xyznuv_d.xml&gt;</pre><p><span class="citetitle">Vertex declaration file
      <span class="literal">xyznuv_d.xml</span></span></p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Graphics_Settings"></a>21.9.&nbsp;Graphics settings</h2></div></div></div><p>To allow the game client to run as smoothly as possible in the
    widest range of systems, BigWorld's 3D engine exposes several parameters.
    These can be tweaked by the player to achieve the optimal balance between
    visual quality and game responsiveness for his particular hardware
    configuration.</p><p>These parameters are known as graphics settings, and are listed
    below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">FAR_PLANE</span><sup>A</sup></em></p><p><em class="emphasis">Available options: <span class="literal">FAR</span>,
        <span class="literal">MEDIUM</span>, <span class="literal">NEAR </span><a href="#xref_Customising_Options" title="21.9.1.&nbsp;Customising options">Customising options</a></em></p><p>Modifies the viewing distance. The viewing distance is defined
        per space and this graphics option modifies the viewing distance by a
        factor. The factors and options are configurable in the file
        <span class="literal">bigworld/res/system/data/graphics_settings.xml</span></p></li><li><p><em class="emphasis"><span class="literal">FLORA_DENSITY</span><sup>A</sup></em></p><p><em class="emphasis">Available options:
        <span class="literal">HIGH</span>, <span class="literal">MEDIUM</span>,
        <span class="literal">LOW</span>, <span class="literal">OFF</span> <a href="#xref_Customising_Options" title="21.9.1.&nbsp;Customising options">Customising options</a></em></p><p>Sets the density of the flora detail objects by a factor. The
        factors and options are configurable in the file
        <span class="literal">bigworld/res/system/data/graphics_settings.xml</span>.</p></li><li><p><em class="emphasis"><span class="literal">FOOT_PRINTS</span></em></p><p><em class="emphasis">Available options: <span class="literal">ON</span>,
        <span class="literal">OFF</span></em></p><p>Toggles footprints on and off.</p></li><li><p><em class="emphasis"><span class="literal">OBJECT_LOD</span><sup>A</sup></em></p><p><em class="emphasis">Available options:
        <span class="literal">HIGH</span>, <span class="literal">MEDIUM</span>, <span class="literal">LOW
        </span><a href="#xref_Customising_Options" title="21.9.1.&nbsp;Customising options">Customising options</a></em></p><p>Modifies the relative distance from the camera for LOD
        transitions by a factor.</p></li><li><p><em class="emphasis"><span class="literal">SHADER_VERSION_CAP</span></em></p><p><em class="emphasis">Available options:
        <span class="literal">SHADER_MODEL_3</span>, <span class="literal">SHADER_MODEL_2</span>,
        <span class="literal">SHADER_MODEL_1</span>,
        <span class="literal">SHADER_MODEL_0</span></em></p><p>Sets the maximum shader model version available to the
        engine.</p><p>SHADER_MODEL_0 is disabled if client is running with a graphics
        card supports Shader Model 1 only. SHADER_MODEL_0 need vertex shader
        2.0 capability, no matter it is software or hardware vertex
        processing. SM1 graphics card such as nVidia TI4400 enables hardware
        vertex processing but only support vertex shader 1.1, so
        SHADER_MODEL_0 option can&#8217;t be applied.</p></li><li><p><em class="emphasis"><span class="literal">SHADOWS_COUNT</span><sup>A</sup></em></p><p><em class="emphasis">Available options: From 1 to
        <span class="literal">maxCount</span> (defined in <span class="literal">shadows.xml</span>
        &#8212; for details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_shadows_xml" class="olink"><i><span class="literal">shadows.xml</span></i></a>)</em></p><p>Sets the number of simultaneously visible dynamic entity
        shadows.</p></li><li><p><em class="emphasis"><span class="literal">SHADOWS_QUALITY</span></em></p><p><em class="emphasis">Available options:
        <span class="literal">HIGH</span>,
        <span class="literal">MEDIUM</span>,<span class="literal">LOW</span>,
        <span class="literal">OFF</span></em></p><p>Sets entity shadow quality. <span class="literal">HIGH</span> uses a
        12-tap filter for shadows, <span class="literal">MEDIUM</span> uses a 4-tap
        filter for shadows, <span class="literal">LOW</span> uses a 1-tap filter for
        shadows and <span class="literal">OFF</span> turns shadows off</p></li><li><p><em class="emphasis"><span class="literal">SKY_LIGHT_MAP</span><sup>B</sup></em></p><p><em class="emphasis">Available options: <span class="literal">ON</span>,
        <span class="literal">OFF</span></em></p><p>Toggles the cloud shadows on and off.</p></li><li><p><em class="emphasis"><span class="literal">TERRAIN_SPECULAR</span><sup>B</sup></em></p><p><em class="emphasis">Available options: <span class="literal">ON</span>,
        <span class="literal">OFF</span></em></p><p>Toggles terrain specular lighting on and off.</p></li><li><p><em class="emphasis"><span class="literal">TERRAIN_LOD</span></em></p><p><em class="emphasis">Available options: <span class="literal">FAR</span>,
        <span class="literal">MEDIUM</span>,<span class="literal">NEAR</span></em></p><p>Modifies the terrain geo-morphing distances by a factor. The
        factors and options are configurable in the file
        <span class="literal">bigworld/res/system/data/terrain2.xml</span></p></li><li><p><em class="emphasis"><span class="literal">TERRAIN_MESH_RESOLUTION</span></em></p><p><em class="emphasis">Available options:
        <span class="literal">HIGH</span>,
        <span class="literal">MEDIUM</span>,<span class="literal">LOW</span></em></p><p>Selects the terrain resolution to use. HIGH uses the highest
        available resolution, MEDIUM uses half the available resolution, LOW
        uses a quarter of the available resolution</p></li><li><p><em class="emphasis"><span class="literal">TEXTURE_COMPRESSION</span><sup>AC</sup></em></p><p><em class="emphasis">Available options: <span class="literal">ON</span>,
        <span class="literal">OFF </span><a href="#xref_Customising_Options" title="21.9.1.&nbsp;Customising options">Customising options</a></em></p><p>Toggles texture compression on and off</p></li><li><p><em class="emphasis"><span class="literal">TEXTURE_FILTERING</span></em></p><p><em class="emphasis">Available options:
        <span class="literal">ANISOTROPIC_16X</span>, <span class="literal">ANISOTROPIC_8X</span>,
        <span class="literal">ANISOTROPIC_4X</span>, <span class="literal">ANISOTROPIC_2X</span>,
        <span class="literal">TRILINEAR</span>, <span class="literal">BILINEAR</span>,
        <span class="literal">LINEAR</span>, <span class="literal">POINT</span></em></p><p>Selects texture filtering. Shaders can be modified to take
        advantage of this setting by using the automatic variables
        <span class="literal">MinMagFilter</span>, <span class="literal">MipFilter</span>, and
        <span class="literal">MaxAnisotropy</span> to set the
        <span class="literal">MINFILTER</span> , <span class="literal">MAGFILTER</span>,
        <span class="literal">MIPFILTER</span> and <span class="literal">MAXANISOTROPY</span>
        sampler states. For details, see
        <span class="literal">bigworld/res/shaders/speedtree/speedtree.fx</span>.</p></li><li><p><em class="emphasis"><span class="literal">TEXTURE_QUALITY</span><sup>AC
        </sup><a href="#xref_Customising_Options" title="21.9.1.&nbsp;Customising options">Customising options</a></em></p><p><em class="emphasis">Available options:
        <span class="literal">HIGH</span>, <span class="literal">MEDIUM</span>,
        <span class="literal">LOW</span></em></p><p>Sets texture quality level.</p></li><li><p><em class="emphasis"><span class="literal">SPEEDTREE_QUALITY</span></em></p><p><em class="emphasis">Available options:
        <span class="literal">VERYHIGH</span>, <span class="literal">HIGH</span>,
        <span class="literal">MEDIUM</span>, <span class="literal">LOW</span>,
        <span class="literal">LOWEST</span></em></p><p>Sets the quality of the speedtree rendering.
        <span class="literal">VERYHIGH</span> Enables per-pixel lighting (normal mapped)
        on all tree parts, <span class="literal">HIGH</span> Enables per-pixel lighting
        (normal mapped) on only the tree branches, <span class="literal">MEDIUM</span>
        Trees use simple lighting, <span class="literal">LOW</span> Trees use simple
        animation and lighting, using the fixed function pipeline.</p></li><li><p><em class="emphasis"><span class="literal">WATER_QUALITY</span></em></p><p><em class="emphasis">Available options:
        <span class="literal">HIGH</span>, <span class="literal">MEDIUM</span>,
        <span class="literal">LOW</span>, <span class="literal">LOWEST</span></em></p><p>Sets the quality of water reflection rendering.
        <span class="literal">HIGH</span> Enables drawing of all object types,
        <span class="literal">MEDIUM</span> Disables drawing of dynamic objects,
        <span class="literal">LOW</span> Disables drawing of dynamic objects and halves
        the resolution of the render target. <span class="literal">LOWEST</span> only
        renders specular reflections.</p></li><li><p><em class="emphasis"><span class="literal">WATER_SIMULATION</span></em></p><p><em class="emphasis">Available options:
        <span class="literal">HIGH</span>, <span class="literal">LOW</span>,
        <span class="literal">OFF</span></em></p><p>Sets the quality of the water simulation.
        <span class="literal">HIGH</span> Enables inter-cell water simulation,
        <span class="literal">MEDIUM</span> enables water simulation on a cell by cell
        basis, <span class="literal">OFF</span> turns water simulation off.</p></li><li><p><em class="emphasis"><span class="literal">POST_PROCESSING</span></em></p><p><em class="emphasis">Available options:
        <span class="literal">HIGH</span>, MEDIUM, <span class="literal">LOW</span>,
        <span class="literal">OFF</span></em></p><p>Sets the default post-processing chain. These are selected from
        the chains folder, for example :
        bigworld/res/system/post_processing/chains/high_graphics_setting.xml.
        If you want to edit the default post-processing then edit the three
        chain files there.</p></li><li><p><em class="emphasis"><span class="literal">MRT_DEPTH</span></em></p><p><em class="emphasis">Available options: ON,
        <span class="literal">OFF</span></em></p><p>Enables creation of the depth texture (exposed to .fx files via
        the DepthTex semantic.) This enables a variety of advanced
        post-processing effects such as depth-of-field and depth-fades, as
        well as the depth-based colouring of the water.</p></li></ul></div><p><em class="emphasis"><em class="emphasis">A</em> &#8212; Adjustable via
    configuration files. For details, see <a href="#xref_Customising_Options" title="21.9.1.&nbsp;Customising options">Customising options</a>.</em></p><p><em class="emphasis"><em class="emphasis">B </em>&#8212; Requires restart
    of the client. For details, see <a href="#xref_Settings_That_Require_Restarting_The_Client" title="21.9.2.4.&nbsp;Settings that require restarting the client">Settings that require restarting the client</a>.</em></p><p><em class="emphasis"><em class="emphasis">C</em> &#8212; Delayed setting.
    For details, see <a href="#xref_Delayed_Settings" title="21.9.2.3.&nbsp;Delayed settings">Delayed settings</a>.</em></p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Customising_Options"></a>21.9.1.&nbsp;Customising options</h3></div></div></div><p>Although most of these settings have their options determined in
      the engine, some settings can have their options customized via
      configuration files.</p><p>These settings and their customisation are discussed in the
      following topics.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9539"></a>21.9.1.1.&nbsp;<span class="literal">TEXTURE_QUALITY</span> and
        <span class="literal">TEXTURE_COMPRESSION</span></h4></div></div></div><p>Both <span class="literal">TEXTURE_QUALITY</span> and
        <span class="literal">TEXURE_COMPRESSION</span> settings are customized by the
        way of the texture format (<span class="literal">.texformat</span>) and detail
        levels (<span class="literal">texture_detail_level.xml</span>) files (for
        details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_texformat" class="olink"><i><span class="literal">.texformat</span></i></a>).</p><p>Lowering the texture quality and using compressed formats helps
        improving engine performance, by reducing the amount of texture memory
        required to store them. This means that less data needs to be sent to
        the graphics card at each frame, ultimately improving frame
        rate.</p><p><span class="literal">TEXURE_QUALITY</span> adjusts the resolution of a
        texture by preventing its topmost mipmap levels from being loaded.
        This means that, at the highest level of quality, the texture will be
        at the same resolution as the original texture map. At medium level,
        it will be at half its original size, and at a quarter of it at the
        lowest level of quality.</p><p>How many mipmap levels are skipped in each quality level for
        each texture can be controlled by the <span class="literal">lodMode</span> tag
        in the texture's <span class="literal">detailLevel</span> section.</p><p>The table below lists the values <span class="literal">lodMode</span> can
        assume, next to the number of mipmaps skipped for each of the texture
        quality setting levels:</p><div class="altrow"><table border="0"><colgroup><col width="39"><col width="48"><col width="51"><col width="63"><col width="50"></colgroup><thead><tr><th><span class="literal">lodMode</span></th><th colspan="4"># of skipped mipmaps</th></tr></thead><tbody><tr><td>Value</td><td>Description</td><td>High quality</td><td>Medium quality</td><td>Low quality</td></tr><tr><td>1</td><td>Normal</td><td>0</td><td>1</td><td>2</td></tr><tr><td>2</td><td>Low bias</td><td>0</td><td>1</td><td>1</td></tr><tr><td>3</td><td>High bias</td><td>0</td><td>0</td><td>1</td></tr></tbody></table></div><p><span class="citetitle">Number of skipped mipmaps per quality
        setting level/ LOD level</span></p><p><span class="literal">TEXURE_COMPRESSION</span> affects the format in
        which texture maps are stored in memory. When texture compression is
        disabled, all textures are stored using the format defined by the
        format tag in the texture's <span class="literal">detailLevel</span> section.
        When texture compression is enabled, the format defined by the
        <span class="literal">formatCompressed</span> is used. If
        <span class="literal">formatCompressed</span> is not defined for a texture, then
        format is used, whatever the compression setting is.</p><p>Note that there is no restriction to what texture format is used
        for format or <span class="literal">formatCompressed</span>, but for the texture
        compression setting to yield any significant performance results,
        <span class="literal">formatCompressed</span> should define a texture format
        that uses less texture memory than its non-compressed format
        counterpart.</p><p>For details on how to setup a texture's level of detail, see
        <a href="#xref_Texture_Details_Levels_Compression" title="21.7.1.&nbsp;Texture detail levels/compression">Texture detail levels/compression</a>. For details
        on the configuration file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_texformat" class="olink"><i><span class="literal">.texformat</span></i></a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9674"></a>21.9.1.2.&nbsp;<span class="literal">SHADOWS_COUNT</span></h4></div></div></div><p><span class="literal">SHADOWS_COUNT</span> defines the maximum number of
        simultaneous dynamic entity shadow casters in a scene.</p><p>Shadows are rendered using shadow buffers, thus consuming
        texture memory. Filling the buffers up at every frame requires
        rendering the scene again for each shadow caster. Reducing the number
        of simultaneous dynamic shadow casters reduces the memory requirements
        and the amount of processing used to update the buffers at every
        frame.</p><p>Value ranges from 1 to value specified in
        <span class="literal">maxCount</span> <span class="literal">shadows.xml</span> file, in
        power of two steps (defined in <span class="literal">shadows.xml</span> &#8212; for
        details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_shadows_xml" class="olink"><i><span class="literal">shadows.xml</span></i></a>).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_FLORA_DENSITY"></a>21.9.1.3.&nbsp;<span class="literal">FLORA_DENSITY</span></h4></div></div></div><p><span class="literal">FLORA_DENSITY</span> defines the size of the vertex
        buffer used to render the flora detail objects.</p><p>Since the flora drawing distance to the camera is fixed,
        defining the size of the vertex buffer also determines the flora
        density. Because it uses alpha blending, drawing the flora can
        negatively influence the frame rendering time, especially on hardware
        with limited fill rate performance. Reducing the amount of flora
        rendered at any one time may help improving the frame rate.</p><p>Flora density options are defined in
        <span class="literal">&lt;graphics_settings&gt;.xml</span> (for details on this
        file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_graphics_settings_xml" class="olink"><span class="literal"><em class="replaceable"><code>&lt;graphics_settings&gt;</code></em>.xml</span></a>) as a multiplier of the
        vertex buffer, which actual size is defined per space in
        <span class="literal">&lt;flora&gt;.xml</span> (for details on this file's
        grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s
        section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_flora_xml" class="olink"><span class="literal"><em class="replaceable"><code>&lt;flora&gt;</code></em>.xml</span></a>).</p><pre class="programlisting">&lt;graphics_settings.xml&gt;

  &lt;flora&gt;
    &lt;option&gt;
      &lt;label&gt;  HIGH &lt;/label&gt;
      &lt;value&gt;  1.0  &lt;/value&gt;
    &lt;/option&gt;

    &lt;option&gt;
      &lt;label&gt;  LOW  &lt;/label&gt;
      &lt;value&gt;  0.5  &lt;/value&gt;
    &lt;/option&gt;

    &lt;option&gt;
      &lt;label&gt;  OFF  &lt;/label&gt;
      &lt;value&gt;  0    &lt;/value&gt;
    &lt;/option&gt;
  &lt;/flora&gt;

&lt;/graphics_settings.xml&gt;</pre><p><span class="citetitle">Example
        <span class="literal">&lt;graphics_settings&gt;.xml</span> &#8212; Configuring flora
        density</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_FAR_PLANE"></a>21.9.1.4.&nbsp;<span class="literal">FAR_PLANE</span></h4></div></div></div><p><span class="literal">FAR_PLANE</span> defines the maximum viewing
        distance when rendering the 3D world.</p><p>Decreasing the viewing distance reduces the amount of geometry
        sent to the rendering pipeline, resulting in higher frame
        rates.</p><p>Because the far plane distance can be defined on a per-space
        basis (in <span class="literal">space.settings</span> file &#8212; for details on this
        file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_space_settings" class="olink"><i><span class="literal">space.settings</span></i></a>),
        <span class="literal">FAR_PLANE</span> is actually multiplied by the space's
        specific far plane value before it is applied to the camera.</p><p>Specified in
        <span class="literal"><em class="replaceable"><code>&lt;graphics_settings&gt;</code></em>.xml</span>
        (for details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_graphics_settings_xml" class="olink"><span class="literal"><em class="replaceable"><code>&lt;graphics_settings&gt;</code></em>.xml</span></a>), the far plane can be
        configured as in the example below:</p><pre class="programlisting">&lt;graphics_settings.xml&gt;

  &lt;farPlane&gt;

    &lt;option&gt;
      &lt;value&gt;  1.0     &lt;/value&gt;
      &lt;label&gt;  FAR     &lt;/label&gt;
    &lt;/option&gt;

    &lt;option&gt;
      &lt;value&gt;  0.75    &lt;/value&gt;
      &lt;label&gt;  MEDIUM  &lt;/label&gt;
    &lt;/option&gt;

    &lt;option&gt;
      &lt;value&gt;  0.5     &lt;/value&gt;
      &lt;label&gt;  NEAR    &lt;/label&gt;
    &lt;/option&gt;

  &lt;/farPlane&gt;

&lt;/graphics_settings.xml&gt;</pre><p><span class="citetitle">Example
        <span class="literal"><em class="replaceable"><code>&lt;graphics_settings&gt;</code></em>.xml</span>
        &#8212; Configuring far plane</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9776"></a>21.9.1.5.&nbsp;<span class="literal">OBJECT_LOD</span></h4></div></div></div><p><span class="literal">OBJECT_LOD</span> defines the relative distance to
        the camera before LOD transitions occur.</p><p>For standard BigWorld models, LOD distances are defined using
        the ModelEditor. ParticleEditor is used to set the LOD distance for
        particle systems (the maximum distance to which the system is still
        visible). LOD levels and transition distances for SpeedTrees are
        defined inside SpeedTreeCAD (although they can be overridden by the
        SpeedTree's XML configuration file, which is specified in
        <span class="literal">resources.xml</span> file's
        <span class="literal">speedTreeXML</span> tag. For details on this file, see
        <a href="#xref_File_resources_xml" title="1.4.1.&nbsp;File resources.xml">File <span class="literal">resources.xml</span></a>).</p><p>The <span class="literal">OBJECT_LOD</span> setting specify multipliers
        that will modify those distances during runtime, allowing the user to
        trade some visual quality for better performance.</p><p>The LOD multipliers are defined in
        <span class="literal"><em class="replaceable"><code>&lt;graphics_settings&gt;</code></em>.xml</span>
        (for details on this file's grammar, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_graphics_settings_xml" class="olink"><span class="literal"><em class="replaceable"><code>&lt;graphics_settings&gt;</code></em>.xml</span></a>):</p><pre class="programlisting">&lt;graphics_settings.xml&gt;

  &lt;objectLOD&gt;

    &lt;option&gt;
      &lt;value&gt;  1.0     &lt;/value&gt;
      &lt;label&gt;  HIGH   &lt;/label&gt;
    &lt;/option&gt;

    &lt;option&gt;
      &lt;value&gt;  0.66    &lt;/value&gt;
      &lt;label&gt;  MEDIUM  &lt;/label&gt;
    &lt;/option&gt;

    &lt;option&gt;
      &lt;value&gt;  0.33    &lt;/value&gt;
      &lt;label&gt;  LOW     &lt;/label&gt;
    &lt;/option&gt;

  &lt;/objectLOD&gt;

&lt;/graphics_settings.xml&gt;</pre><p><span class="citetitle">Example
        <span class="literal"><em class="replaceable"><code>&lt;graphics_settings&gt;</code></em>.xml</span>
        &#8212; Configuring object LOD</span></p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e9820"></a>21.9.2.&nbsp;Using settings</h3></div></div></div><p>Upon startup, the client automatically tries to load the graphics
      settings from disk. All graphics settings are stored in the
      <span class="literal">graphicsPreferences</span> section of the file specified in
      preferences tag of the file specified in
      <span class="literal">resources.xml</span>'s <span class="literal">engineConfigXML</span>
      tag (for details, see <a href="#xref_File_preferences_xml" title="1.4.4.&nbsp;File <preferences&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;preferences&gt;</code></em>.xml</span></a>). The
      first time the application is run, and when the graphics card or its
      driver has changed, the graphics settings will try to auto-detect the
      most appropriate settings for the device.</p><p>Saving, on the other hand, is not performed automatically; it must
      be controlled from the scripts, using the
      <span class="literal">BigWorld.savePreferences</span> method &#8212; it will save both
      the graphics settings and the video and script preferences.</p><p>The game scripts can use the functions
      <span class="literal">BigWorld.graphicsSettings</span> and
      <span class="literal">BigWorld.setGraphicsSettings</span> to query and change the
      current state of the settings (usually trough a graphical user
      interface).</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9849"></a>21.9.2.1.&nbsp;Auto-detecting settings</h4></div></div></div><p>Auto-detecting of settings is supported through an xml
        configuration file specified by the tag
        <span class="literal">graphicsSettingsPresets</span> in
        <span class="literal">resources.xml</span>. This file defines matching criteria
        to attempt to match a group of settings to a specific device (graphics
        card). There are three different ways of matching a group of settings
        to a device. All matching is done against the
        <span class="literal">D3DADAPTER_IDENTIFIER9</span> structure. The
        auto-detection itself is performed in the method
        <span class="literal">Moo::GraphicsSetting::init</span></p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">GUID</span></em></p><p>Matches a specific device type and driver version to a
            settings group, this is useful when there are known issues with a
            certain driver/device pair and you can adjust your graphics
            settings accordingly</p></li><li><p><em class="emphasis"><span class="literal">VendorID/DeviceID
            pair</span></em></p><p>Matches a specific device type to the settings this is
            useful when you know the vendor and device id's for a specific
            device</p></li><li><p><em class="emphasis"><span class="literal">Device description
            string</span></em></p><p>Matches the strings to the device description, all the
            strings need to match for the setting to be selected</p></li></ul></div><pre class="programlisting">&lt;graphicsPreferences&gt; HIGH &lt;=== Name of the preset, if no name is present, the preset will not appear in the list of settings, 
                                but it will still be used when auto-detecting settings for the graphics card

  &lt;entry&gt; &lt;=== a graphics setting to change 
    &lt;label&gt; CLASSIC_TERRAIN_QUALITY &lt;/label&gt; &lt;=== the name of the graphics setting
    &lt;activeOption&gt; 0 &lt;/activeOption&gt; &lt;===the selected option
  &lt;/entry&gt;

  &lt;GUIDMatch&gt;  01234567.89abcdef.01234567.89abcdef &lt;/GUIDMatch&gt;  
    &lt;===  Combined GUID of device and driver version, this is the value from DeviceIdentifier in the 
          D3DADAPTER_IDENTIFIER9 structure saved out using the BigWorld UniqueID class.
          If this value matches, the setting will be used.

  &lt;VendorDeviceIDMatch&gt;
    &lt;VendorID&gt; 4318 &lt;/VendorID&gt; &lt;=== the VendorId from D3DADAPTER_IDENTIFIER9
    &lt;DeviceID&gt; 1554 &lt;/DeviceID&gt; &lt;=== the DeviceId from D3DADAPTER_IDENTIFIER9
  &lt;/VendorDeviceIDMatch&gt; &lt;=== If these two values match the current device, the setting will be selected
                              unless there is a GUIDMatch with the current device

  &lt;DeviceDescriptionMatch&gt; 
    &lt;string&gt; nvidia &lt;/string&gt; &lt;=== Any number of strings that will be matched against the 
    &lt;string&gt; 6800 &lt;/string&gt; &lt;=== Description property from D3DADAPTER_IDENTIFIER9
  &lt;/DeviceDescriptionMatch&gt;  &lt;=== If these values match the current device, the setting will be selected
                                  unless there is a GUIDMatch or VendorDeviceIDMatch with the 
                                  current device

  &lt;defaultSetting&gt; true &lt;/defaultSetting&gt; &lt;=== this value is true for the value to be used as the default setting,
                                               the default setting is used when no other settings match.
&lt;/graphicsPreferences&gt;</pre><p><span class="citetitle">Example
        <span class="literal"><em class="replaceable"><code>&lt;graphics_settings_presets&gt;</code></em>.xml</span>
        &#8212; Setting up device matches</span></p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e9897"></a>21.9.2.2.&nbsp;<span class="literal">GraphicsPresets</span> class</h4></div></div></div><p>A simple python graphics presets class is also supplied. This
        class helps with grouping several graphics settings together so that
        you can have pre-defined settings for multiple graphics options for a
        specific level of hardware or performance. The
        <code class="code">GraphicsPresets</code> class can be found in the folder
        <span class="literal">bigworld/res/scripts/GraphicsPresets.py</span>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Delayed_Settings"></a>21.9.2.3.&nbsp;Delayed settings</h4></div></div></div><p>Most settings take effect immediately after calling
        <span class="literal">BigWorld.setGraphicsSettings</span>, but some are just
        flagged as delayed. That means that after being set they are added to
        a list of pending settings, and that they will only come into effect
        when that list gets committed.</p><p>This was designed to give the interface programmer a chance to
        warn the user that processing the new settings may take a while to
        complete before the client application blocks for a few seconds
        (currently, there is no support for displaying a progress bar while
        the settings are being processed).</p><p>The following functions allow the scripts to manage the pending
        settings list:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">BigWorld.hasPendingGraphicsSettings</span></em></p></li><li><p><em class="emphasis"><span class="literal">BigWorld.commitPendingGraphicsSettings</span></em></p></li><li><p><em class="emphasis"><span class="literal">BigWorld.rollBackPendingGraphicsSettings</span></em></p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Settings_That_Require_Restarting_The_Client"></a>21.9.2.4.&nbsp;Settings that require restarting the client</h4></div></div></div><p>Some settings are not applied until the client application is
        restarted. The function
        <span class="literal">BigWorld.graphicsSettingsNeedRestart</span> returns true
        whenever the client requires a restart for a recently changed setting
        to take effect.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_High_Resolution_Screenshots"></a>21.10.&nbsp;Taking Screenshots</h2></div></div></div><p>The BigWorld client is able to take screenshots and save them to a
    number of different formats. It does this by retrieving the current
    content of the back buffer at the time the screenshot operation is called.
    To take an in-game screenshot, press the <span class="literal">PrtScn button</span>,
    or use the
    <span class="literal">BigWorld.screenShot(<em class="replaceable"><code>extension</code></em>,
    <em class="replaceable"><code>name</code></em>)</span> Python API function.</p><p>The default image type, filename prefix, and output location are all
    configured within the <code class="code">engine_config.xml</code> (see <a href="#xref_File_engine_config_xml" title="1.4.2.&nbsp;File <engine_config&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span></a>). The schema for the
    <code class="code">&lt;screenShot&gt;</code> tag is:</p><pre class="programlisting">&lt;engine_config.xml&gt;
  ...
    &lt;screenShot&gt;
        &lt;path&gt; <em class="replaceable"><code>relativePath</code></em>
            &lt;pathBase&gt;  <em class="replaceable"><code>basePathName</code></em> &lt;/pathBase&gt;
        &lt;/path&gt;        
        &lt;name&gt; <em class="replaceable"><code>prefixName</code></em> &lt;/name&gt;
        &lt;extension&gt; <em class="replaceable"><code>extension</code></em> &lt;/extension&gt;                
    &lt;/screenShot&gt;
  ...
&lt;/engine_config.xml&gt;</pre><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">relativePath &#8212;
        </span></em>This is the output path relative to basePath
        (outlined below). For example, if relativePath is
        <code class="code">MY_DOCS,</code> you may want to set this to something like
        <code class="code">"My Company/Game Name/Screenshots"</code>. Leave blank or
        specify <span class="literal">"./"</span> to place directly in
        <span class="literal">basePathName</span> (which is the default
        behaviour).</p></li><li><p><em class="emphasis"><span class="literal">basePathName &#8212;
        </span></em>This configures the base output location for the
        screenshots. This can be one of the following values:</p><div class="itemizedlist"><ul type="circle"><li><p><code class="code">EXE_PATH</code> &#8212; Screenshots relative to the location
            of the client executable. This is the default location if none is
            supplied.</p></li><li><p><code class="code">CWD</code> &#8212; Screenshots will be stored relative to
            the current working directory. Note that if the working directory
            changes during runtime, it will save in the new working
            directory.</p></li><li><p><code class="code">APP_DATA</code> &#8212; Screenshots will be stored relative
            to the current user's AppData directory.</p></li><li><p><code class="code">MY_DOCS</code> &#8212; Screenshots will be stored relative
            to the current user's My Documents directory.</p></li><li><p><code class="code">RES_TREE</code> &#8212; Screenshots will be stored relative
            to the first resource path found in <code class="code">paths.xml</code>.</p></li></ul></div><p>The default value is <code class="code">EXE_PATH</code>.</p></li><li><p><em class="emphasis"><span class="literal">prefixName </span></em>&#8212;
        Specifies the prefix to use when generating a numbered screenshot. The
        default value is "shot".</p></li><li><p><em class="emphasis"><span class="literal">extension </span></em> &#8212;
        Specifies the file format to use when saving the screenshot. This can
        be one of "bmp", "jpg", "tga", "png" or "dds". The default value is
        "bmp".</p></li></ul></div><p>The full path of the generated screenshot will therefore be
    <code class="code">basePathName/relativePath/prefixName_<span class="literal"><em class="replaceable"><code>&lt;sequence&gt;</code></em></span>.extension</code>,
    where <span class="literal"><em class="replaceable"><code>&lt;sequence&gt;</code></em></span> is a
    four-digit non-negative integer, padded with leading zeros
    (<em class="emphasis">e.g.</em>, <span class="literal">shot_0012.bmp</span>). The screen
    capture mechanism will not overwrite pre-existing files.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10078"></a>21.10.1.&nbsp;High Resolution Screenshots</h3></div></div></div><p>Normally the back buffer is the same size as the window or the
      screen resolution when in full-screen mode. However, when running in
      windowed mode it is possible to have a back buffer that is larger than
      the window itself, thus increasing the size of the screenshot.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10083"></a>21.10.1.1.&nbsp;The backBufferWidthOverride watcher</h4></div></div></div><p>The size of the back buffer can be changed (via Debug (Watchers)
        Console) by the <code class="code">backBufferWidthOverride</code> watcher.</p><p>The values specified to the watcher, and their effect on the
        back buffer are described below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Watcher's value: 0
            (default)</em></p><p><em class="emphasis">Resulting dimensions of the back
            buffer:</em> Same as those of the window (when in windowed
            mode) or screen (when in full-screen mode).</p></li><li><p><em class="emphasis">Watcher's value: Between 1 and the
            maximum surface width (4096 high-end cards)</em></p><p><em class="emphasis">Resulting dimensions of the back
            buffer:</em> Width of the back buffer will be as specified.
            Height of the back buffer will be the specified width divided by
            the aspect ratio of the window.</p></li><li><p><em class="emphasis">Watcher's value: Greater than
            supported by hardware</em></p><p><em class="emphasis">Resulting dimensions of the back
            buffer:</em> Maximum value supported by the hardware
            (typically 2048 or 4096). Specified value will be ignored.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10118"></a>21.10.1.2.&nbsp;How to take a high resolution screenshot</h4></div></div></div><p>To take a high-resolution screenshot</p><div class="orderedlist"><ol type="1"><li><p>Open <span class="literal">engine_config.xml</span> (for details on
            this file, see <a href="#xref_File_engine_config_xml" title="1.4.2.&nbsp;File <engine_config&gt;.xml">File
      <span class="literal"><em class="replaceable"><code>&lt;engine_config&gt;</code></em>.xml</span></a>) and
            check the settings in &lt;supershot&gt; tag. If you have a video
            card with a large amount of memory you may be able to change hRes
            to 4096.</p></li><li><p>Load the space/level and navigate to the place of which you
            want the screenshot.</p></li><li><p>Press ctrl+PrtScn to enable high resolution screenshot
            settings.</p></li><li><p>Press PrtScn to take a screenshot.</p></li><li><p>Press ctrl+PrtScn to restore regular render settings.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10144"></a>21.10.1.3.&nbsp;Troubleshooting</h4></div></div></div><p>The list below describes some errors that you might come across
        when taking high-resolution screenshots and how to solve them:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Back buffer's size did not change to
            the value that I specified.</em></p><p>When setting <span class="literal">backBufferWidthOverride</span>,
            client checks if specified size is larger than the hardware can
            support. If that is the case, then hardware will ignore the
            specified size and use its maximum (typically 2048 or
            4096).</p><p><em class="emphasis">&#8212; or &#8212;</em></p><p>When very large numbers are specified in the <em class="emphasis">Debug (Watchers) Console</em>, parsing may wrap
            the value. If this is the case of the value specified for
            backBufferWidthOverride, then it will be set to 0.</p></li><li><p><em class="emphasis">There is a glow covering the
            screen.</em></p><p>Sometimes, limited video memory resources will stop the
            renderer from allocating some of the buffers that it uses, or from
            drawing full-screen post-processing.</p><p>This is particularly common when changing to a lower
            resolution after using a very large one.</p><p>To solve this, you can either:</p><div class="itemizedlist"><ul type="circle"><li><p>Set buffer to a smaller width (an application restart
                may also be necessary).</p></li><li><p>Turn off post-processing through the graphics
                settings</p><div class="itemizedlist"><ul type="square"><li><p>Press <span class="literal">DEBUG</span>+P to open the
                    <em class="emphasis">Python Console</em>.</p></li><li><p>Type BigWorld.setGraphicsSetting( "POST_PROCESSING",
                    3 )</p></li></ul></div></li></ul></div></li><li><p><em class="emphasis">Changing back buffer's size had no
            effect when working in full-screen mode.</em></p><p>When in full-screen mode, the back buffer must always have
            the same dimensions as the screen resolution &#8212; this is a
            hardware/API limitation.</p><p>Hence, <span class="literal">backBufferWidthOverride</span> will
            always be disabled (value equals 0) when running in full-screen
            mode.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10208"></a>21.10.1.4.&nbsp;Hardware recommendations</h4></div></div></div><p>To produce high-resolution screenshots, a very capable video
        card is necessary &#8212; the two key requirements are:</p><div class="itemizedlist"><ul type="disc"><li><p>Maximum texture resolution</p></li><li><p>Available video memory</p></li></ul></div><p>DirectX 9 requires 2048 resolution as a minimum, but 4096 is
        available on nVidia GeForce3+ (7800+ recommended) and ATI 1X800+
        series cards. It is recommended that you have a minimum of 256MB video
        memory when taking screenshots at resolutions in the order of
        4096x3072.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Dynamic_Entity_Shadows"></a>21.11.&nbsp;Dynamic Entity Shadows</h2></div></div></div><p>The client supports two different ways to allow entity models to
    cast shadows into the scene. The method you choose to use will depend on
    the target hardware as they differ greatly in cost.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10227"></a>21.11.1.&nbsp;Splodges</h3></div></div></div><p>This system works by drawing a special "splodge" texture onto the
      geometry below the feet of the entity model, projected in the direction
      of the sun (they are only visible while in outside chunks). This is a
      good low-end solution as they are inexpensive to draw, however they will
      only provide a crude approximation of a shadow.</p><p>Splodges can be added to an entity model by using the PySplodge
      API. The PySplodge class is a type of attachment, and are attached to
      the feet of the entity model (one per foot). For example:
      </p><pre class="programlisting">&gt;&gt;&gt; lsplodge = BigWorld.Splodge()
&gt;&gt;&gt; rsplodge = BigWorld.Splodge()
&gt;&gt;&gt; model.node( "biped L Toe0" ).attach( lsplodge )
&gt;&gt;&gt; model.node( "biped R Toe0" ).attach( rsplodge )</pre><p>While all splodges use the same material to draw (this can be
      configured by modifying the environment/splodgeMaterial section in
      resources.xml), each PySplodge intstance can modify the following
      parameters: </p><div class="itemizedlist"><ul type="disc"><li><p>The maximum LOD distance from the camera, after which they
            are culled. Defaults to 50 metres.</p></li><li><p>The size of the individual splodge.</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p> Since the collision scene is used to determine where to draw a
        splodge, only solid objects will receive splodge shadows. </p></div><div class="informalfigure"><div class="mediaobject"><img src="images/splodge.png"><span class="caption"><p>An example of splodge shadows</p></span></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10255"></a>21.11.2.&nbsp;Shadow maps</h3></div></div></div><p>Entity models can be configured so that they cast a shadow into
      the scene based on the direction of the sun light, utilising a dynamic
      shadow map. Each frame the engine will select a set of shadow casting
      entities closest to the camera, the number of which is configured via
      the <code class="code">SHADOWS_COUNT</code> graphics setting. For each shadow caster
      it will render the caster into a texture from the direction of the light
      and then project this texture into the scene by re-rendering each object
      that intersects the shadow (using the shadow map as input).</p><p>In order to cast shadows, an entity must be explicitly added to
      the entity shadow manager. Two Python API's are provided: </p><div class="itemizedlist"><ul type="disc"><li><p><code class="code">BigWorld.addShadowEntity</code> - this is usually
            called from the <code class="code">onEnterWorld</code> entity callback.</p></li><li><p><code class="code">BigWorld.delShadowEntity</code> - this is usually
            called from the <code class="code">onLeaveWorld</code> entity callback.</p></li></ul></div><p>Global shadow settings (e.g. shadow map resolution, intensity, and
      shaders) are configured in the shadows XML file (defined in
      <span class="literal">shadows.xml</span> &#8212; for details on this file's grammar, see
      the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#File_Grammar_Guide" class="olink">File Grammar Guide</a>'s section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../file_grammar_guide/file_grammar_guide.html#xref_shadows_xml" class="olink"><i><span class="literal">shadows.xml</span></i></a>).</p><p>User controllable graphics settings are <code class="code">SHADOWS_COUNT</code>
      and <code class="code">SHADOWS_QUALITY</code>. See <a href="#xref_Graphics_Settings" title="21.9.&nbsp;Graphics settings">Graphics settings</a> for details.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Shadows will be cast onto terrain, solid models, and flora.
        Sorted triangles (i.e. transluscent objects) will not cast or receive
        shadows.</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Keep in mind that the expense of using entity shadows will
        increase as the number of rendered shadowed entities increases, so it
        is recommended to keep the <code class="code">SHADOWS_COUNT</code> setting as low
        as possible to maintain performance. As such this is not designed to
        be a general purpose full-scene shadowing system.</p></div><div class="informalfigure"><div class="mediaobject"><img src="images/shadow-map.png"><span class="caption"><p>An example of dynamic entity shadows</p></span></div></div></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Post_Processing"></a>Chapter&nbsp;22.&nbsp;Post Processing</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Post_Processing_Pipeline">22.1. Pipeline Overview</a></span></dt><dt><span class="section"><a href="#d0e10390">22.2. Creating a Custom Post-Processing Effect</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10399">22.2.1. Creating the Custom Pixel Shader</a></span></dt><dt><span class="section"><a href="#d0e10416">22.2.2. Previewing the Results</a></span></dt><dt><span class="section"><a href="#d0e10437">22.2.3. Writing a Custom Pixel Shader for Previewing the Results</a></span></dt><dt><span class="section"><a href="#d0e10451">22.2.4. Authoring a Post-Processing Effect in Python</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10539">22.3. Render Targets</a></span></dt><dt><span class="section"><a href="#d0e10572">22.4. Performance</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10577">22.4.1. Measuring the Time Spent on the GPU</a></span></dt><dt><span class="section"><a href="#d0e10590">22.4.2. Background Loading</a></span></dt></dl></dd></dl></div><p>Post-processing effects are used extensively in all modern games, and
  have many applications - from HDR tone-mapping and colour-correction to
  cartoon effects, the possibilities are almost limitless.</p><p>BigWorld Technology has support for complete user customisation of the
  post-processing chain, for artists via a built-in editing tool, and for
  programmers by offering full control over every parameter in python and
  drop-in shaders in the way of DirectX/HLSL effect files.</p><p>However before you jump into creating your own new swanky effect, it
  pays to think about it. Effects should play nicely together, they should
  reuse render targets where possible, and you need to monitor
  performance.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Post_Processing_Pipeline"></a>22.1.&nbsp;Pipeline Overview</h2></div></div></div><p>After the opaque scene, translucencies and lens effects, and before
    the GUI is drawn, the <em class="emphasis">PostProcessing::Manager</em> draws its current chain. A
    <em class="emphasis">Chain</em> contains a list of effects that
    draw in order. Internally each <em class="emphasis">Effect</em>
    contains a list of Phases that draw in order. A <em class="emphasis">Phase</em> usually draws a full-screen quad to the
    screen using an effect file, although other transfer meshes are
    available.</p><p>There are three parts to the implementation of post-processing. The
    core is written in C++, in the
    <em class="emphasis">bigworld/src/lib/post_processing</em> library. All of the
    features there are exposed to python via the <em class="emphasis">_PostProcessing</em> module.</p><p>In Python, the <em class="emphasis">PostProcessing</em>
    module exists in
    <em class="emphasis">bigworld/res/scripts/client/PostProcessing</em> and
    imports all of the methods from <em class="emphasis">_PostProcessing</em>. This allows you to override, or
    wrap, any of the C++ methods. Therefore all python calls should be to the
    <em class="emphasis">PostProcessing</em>, not <em class="emphasis">_PostProcessing</em>.</p><p>By default, the <em class="emphasis">PostProcessing</em>
    module registers 3 graphics settings. If the user selects high/medium/low,
    an appropriate post-processing chain is loaded. These are found in
    <em class="emphasis">bigworld/res/system/post_processing/chains/</em> and are
    "High Graphics Setting.ppchain", "Medium Graphics Setting.ppchain" and
    "Low Graphics Setting.ppchain". Therefore it is easy for developers to
    redefine the default post-processing chains by creating new chains in
    WorldEditor and saving over the top of these files.</p><p>In general it is expected that a game will use a combination of the
    default post-processing chain files, dynamically mixed in with gameplay
    related effects. In order to achieve this, follow the examples in the
    <em class="emphasis">PostProcessing</em> module. Additionally, take
    a look at the Python API for <em class="emphasis">PyMaterial</em>,
    as it will demonstrate how you can smoothly fade in/out your dynamic
    post-processing effects.</p><p>Finally in WorldEditor, the Post-Processing tab is a full-featured
    editor and preview tool for chains. It loads and saves .ppchain files.
    Please see the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../..//content_creation.chm#Content_Creation_Manual" class="olink">Content Creation Manual</a> and the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a> for further
    information.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10390"></a>22.2.&nbsp;Creating a Custom Post-Processing Effect</h2></div></div></div><p>While BigWorld comes with a basic set of post-processing shaders,
    phases and effects, more likely than not you will find yourself needing to
    implement an effect that is unique to your game.</p><p>For this example, we will be creating a post-process that will
    invert all the colours on the screen.</p><p>We will author a post-processing effect that can be added as part of
    the client's overall post-processing chain, and we will write a custom
    shader that performs the actual colour inversion.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10399"></a>22.2.1.&nbsp;Creating the Custom Pixel Shader</h3></div></div></div><p>So how are we going to get the GPU to invert all the colours on
      the screen?</p><p>Because the BigWorld client supports drop-in DirectX Effect files
      (.fx), this step is relatively easy. All we need to do is author a .fx
      file that takes an input texture, inverts the colour, and outputs that
      value.</p><pre class="programlisting">float4 ps_invert(PS_INPUT input) : COLOR0
{
    float4 map = tex2D(inputTextureSampler, input.tc);
    float4 invMap = float4(1,1,1,1) - map;
    return invMap;
}</pre><p>OK, so that was the easy bit. This pixel shader assumes a
      couple of things, namely that the vertex shader is passing through a set
      of texture coordinates, that there is a sampler reading the correct
      texture map, and that there is a PS_INPUT structure defined.</p><p>Luckily all of this has been taken care of, via the effect include
      file post_processing.fxh
      (bigworld/res/shaders/post_processing/post_processing.fxh)</p><p>The complete effect utilising this pixel shader is quite
      straightforward, and looks something like this:</p><pre class="programlisting">#include "post_processing.fxh"

DECLARE_EDITABLE_TEXTURE(inputTexture, inputSampler)

float4 ps_invert(PS_INPUT input) : COLOR0
{
    float4 map = tex2D(inputSampler, input.tc);
    float4 invMap = float4(1,1,1,1) - map;
    return invMap;
}

vs2 = compile vs_2_0 vs_main()
ps2 = compile ps_2_0 ps_invert()
 
STANDARD_TECHNIQUE(vs2, ps2)

</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10416"></a>22.2.2.&nbsp;Previewing the Results</h3></div></div></div><p>As the post-processing chain contains many phases, which often
      write to intermediate, invisible render targets, it is often desirable
      to see the intermediate results of a post-processing effect or chain.
      There are two methods available for this purpose, <em class="emphasis">PostProcessing.debug()</em> and WorldEditor's preview
      feature.</p><p>In the client, you can register a render target of arbitrary size
      with the <em class="emphasis">_PostProcessing</em> module, and
      have it record all intermediate steps. This render target can then be
      viewed by displaying it in the GUI. A helper class, <em class="emphasis">ChainView</em>, is available in the <em class="emphasis">PostProcessing</em> module, this will display the
      entire chain on-screen in real-time.</p><p>In WorldEditor, there is a preview button in the post-processing
      editor, this displays the intermediate results inside each of the phase
      nodes in the editing graph.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10437"></a>22.2.3.&nbsp;Writing a Custom Pixel Shader for Previewing the Results</h3></div></div></div><p>Sometimes, this simple preview is not going to be suitable. By
      default, the preview directly displays the output of each phase's pixel
      shader. However, often the output of an intermediate step is written to
      a floating-point render target that does not directly map to the visible
      colour range, other times there is information encoded in specific ways
      that are not directly viewable.</p><p>Take for example a depth-of-field lens simulation. One possible
      implementation might decode the depth buffer, and categorise the scene
      into 7 separate areas, 3 levels of blur in front of the focal range,
      in-focus and 3 levels after. This information may be written into a
      single-component floating point render target and contain a value
      between -3 and +3.</p><p>When the output of a pixel shader is not directly viewable, you
      can author another pixel shader that is used for the preview function.
      To do this, you need to add a new technique to your effect. This
      technique must be called "<em class="emphasis">Preview</em>", and
      if available, will be used in lieu of the main technique when previewing
      the post-processing chain. This technique should output the data such
      that it will be viewable and make sense on an ordinary R8G8B8A8 render
      target and when viewed on-screen.</p><p>In the above example, you could write a preview technique that
      displays 3 shades of red for blurred areas in front of the focal range,
      full-green for all areas in focus, and 3 shades of blue for all areas
      being blurred behind the focal range.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10451"></a>22.2.4.&nbsp;Authoring a Post-Processing Effect in Python</h3></div></div></div><p>So now how do we get our new effect to manipulate the screen at
      post-processing time? We have to author a <em class="emphasis">PostProcessing::Effect</em>. Most often, this will be
      done via the post-processing editor in WorldEditor. WorldEditor saves
      out .ppchain files, these contain chains of effects and phases, and can
      simply be loaded up and set as the current post-processing chain.
      However, it's also useful to know how to use the Python API, as you do
      have access to the entire chain, and often you will want to tie in
      post-processing effects directly to game logic. It also helps to
      understand what is happening 'under-the-hood' when authoring chains in
      the editor.</p><p>For this example effect, we must write every pixel in the
      backbuffer with the inverse of whatever colour is in the
      backbuffer.</p><p>PC hardware cannot read from the same texture that is being
      written to, so we will need first to grab a copy of the back buffer, and
      store it in another texture.</p><p>This snippet of python code creates a <em class="emphasis">CopyBackBuffer</em> phase, creates a render target
      that is the size of the back buffer, and hooks the two up.</p><pre class="programlisting">import PostProcessing

phase1 = PostProcessing.CopyBackBuffer()
bbcRT = BigWorld.RenderTarget("backBufferCopy", 0, 0)
phase1.renderTarget = bbcRT</pre><p>In WorldEditor, we can simply drop a "BackBufferCopy" phase into
      our effect and be done with it.</p><p>Note in this case, we are creating a new render target, however
      generally you want to share render targets between effects and phases,
      especially full-screen ones like the one above. So instead of creating a
      render target, we could instead use the <em class="emphasis">RenderTargets</em> module like this:</p><pre class="programlisting">bbcRT = PostProcessing.RenderTargets.rt("backBufferCopy")
</pre><p>Now we have a copy of the back buffer that we can read in as
      a texture, now is time to do our colour inversion pass</p><pre class="programlisting">phase2 = PostProcessing.Phase()
phase2.material = BigWorld.Material("shaders/post_processing/colour_invert.fx")
phase2.material.inputTexture = phase1.renderTarget.texture
phase2.renderTarget = None
phase2.filterQuad = PostProcessing.TransferQuad()</pre><p>This code
      sample creates a new phase, this time a generic <em class="emphasis">PyPhase</em> object. A <em class="emphasis">PyPhase</em> object has a <em class="emphasis">PyMaterial</em> and a <em class="emphasis">FilterQuad</em>. It uses these to write to a <em class="emphasis">RenderTarget</em>.</p><p>We have created a new <em class="emphasis">PyMaterial</em>,
      from "colour_invert.fx", the shader we authored earlier.</p><p>The effect file uses a texture variable named "inputTexture".
      Since we marked this variable in the effect as 'editable', it shows up
      in the python dictionary for the material. Thus we can set it directly
      to the texture held by the back buffer copy render target.</p><p>We have set this phase's <em class="emphasis">renderTarget</em>
      attribute to None. Specifically this means "don't set a render target",
      in practice this means we want to write directly to the main scene's
      back buffer, instead of an off-screen render target.</p><p>Note that whenever we write to the back buffer, we change its
      contents, and the next post-processing effect or phase must use a new
      copy that contains these changes. The <em class="emphasis">BackBufferCopy</em> phase internally detects whether
      or not the back buffer has been modified since the last copy was taken.
      Therefore it is ok to use <em class="emphasis">BackBufferCopy</em> phases all the time, and there
      will be no performance penalty if that phase is in fact not needed at
      that time.</p><p>Finally the phase uses a <em class="emphasis">FilterQuad</em> to draw with; these usually draw with
      n sets of filter taps, in this case we just want to read a single pixel
      from the source texture, for each pixel in the output render target. So
      we have created a <em class="emphasis">PyTransferQuad</em>, which
      has only a single sample point, and with no offsets. If we wanted to do
      some texture filtering, we could have used a <em class="emphasis">PyFilterQuad</em> instead, and specified n sample
      points - with each sample point representing (u-offset in texels,
      v-offset in texels, weight, unused).</p><pre class="programlisting">colourInvert = PostProcessing.Effect()
colourInvert.phases = [phase1, phase2]
colourInvert.name = "Invert Colours"
PostProcessing.chain([colourInvert])
</pre><p>This final code example wraps up our two phases into a single
      <em class="emphasis">Effect</em>, and registers the Effect as the
      post-processing chain. From here on in, the colours on the screen will
      be inverted.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10539"></a>22.3.&nbsp;Render Targets</h2></div></div></div><p>One of the main sets of resources used by post-processing chains are
    render targets. These tend to be multiples of the back buffer size, and
    have different surface formats and uses. The BigWorld client exposes the
    <em class="emphasis">PyRenderTarget</em> class which can be used to
    create custom render targets on demand. Please see the <em class="emphasis">Python
    Client API</em> for detailed instructions on how to use <em class="emphasis">PyRenderTarget</em>.</p><p>Note that it is ok to create as many render targets as you like, as
    the actual surface memory is only allocated when the render target is
    first used for drawing into (via <em class="emphasis">RenderTarget.push</em>).
    Therefore you can define render targets that are not actually used, with
    negligible overhead. However for the render targets in use, the video
    memory can quickly add up, so it pays to take care when designing your
    post processing chains. The total memory used by any particular chain can
    be viewed in the WorldEditor, or by calling the function
    <em class="emphasis">PostProcessing.RenderTargets.reportMemoryUsage()</em>.</p><p>In Python, the <em class="emphasis">PostProcessing</em>
    module has its own <em class="emphasis">RenderTargets</em> module,
    in
    <em class="emphasis">bigworld/res/scripts/client/PostProcessing/RenderTargets</em>.
    If you want to add more render targets for use by your post-processing
    chains, then add them to the render target list here. Doing this is
    necessary because this is where WorldEditor gets its list of available
    post-processing render targets.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10572"></a>22.4.&nbsp;Performance</h2></div></div></div><p>There are two main performance metrics to be aware of when authoring
    post-processing chains. These are: memory use (mainly by the render
    targets); and the time spent in the GPU. Render targets and their
    associated memory use are described in the previous chapter. As always,
    PostProcessing resources created dynamically should be loaded in the
    background thread, to avoid stalling the rendering thread.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10577"></a>22.4.1.&nbsp;Measuring the Time Spent on the GPU</h3></div></div></div><p>Post-processing chains tend to have a low CPU cost - involving
      simple iteration through effects and phases and simple geometry setup -
      but a high GPU cost, with complex pixel shaders that perform full-screen
      passes and many texture fetches per pixel. Therefore the main cost is
      normally GPU bandwidth: fill-rate, and texture-fetch.</p><p>The BigWorld client has a python API function,
      <em class="emphasis">PostProcessing.profile(nIterations)</em>, which measures
      the time taken by the GPU. The parameter
      <em class="emphasis">nIterations</em> should usually be around 10 or so to
      make sure an accurate value is measured. Since the main cost is
      fill-rate and texture-fetch, this value depends on the resolution of the
      screen, so it is necessary to profile on different GPUs and at different
      resolutions. Note that WorldEditor also comes with a toolbar button on
      the Post-Processing panel that also profiles the chain.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10590"></a>22.4.2.&nbsp;Background Loading</h3></div></div></div><p>There is no direct support for background creation of <em class="emphasis">.ppchain</em> files, since the library uses many
      <em class="emphasis">PyObject</em> pointers which can only be
      created in the main thread. Instead, support for background loading of
      .ppchain files can be achieved via the
      <em class="emphasis">PostProcessing.prerequisites()</em> method. This
      extracts the appropriate resources (mainly EffectMaterials) from the XML
      file and returns a list of the required resources which can then be
      passed directly to
      <em class="emphasis">BigWorld.loadResourceListBG()</em>.</p><p>For example:</p><pre class="programlisting">filename = "system/post_processing/chains/underwater.ppchain"
BigWorld.loadResourceListBG(PostProcessing.prerequisites(filename), onLoadBG)</pre><p>PostProcessing chains loaded via the SFX system are automatically
      loaded in the background.</p><p>Because gathering the PostProcessing prerequisites relies on the
      .ppchain file data section already being loaded, it is recommended that
      you <em class="emphasis">preload</em> all your .ppchain XML
      files.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Job_System"></a>Chapter&nbsp;23.&nbsp;Job System</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e10621">23.1. Overview</a></span></dt><dt><span class="section"><a href="#d0e10632">23.2. Under the Hood</a></span></dt><dt><span class="section"><a href="#d0e10643">23.3. Wrapper API</a></span></dt><dt><span class="section"><a href="#d0e10670">23.4. Job System API</a></span></dt><dt><span class="section"><a href="#d0e10694">23.5. An Example</a></span></dt><dt><span class="section"><a href="#d0e10731">23.6. Implementing it</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10621"></a>23.1.&nbsp;Overview</h2></div></div></div><p>The job system allows additional cores in multicore systems to
    execute code and calculate data for rendering just in time. It also moves
    the issue of D3D commands onto its own core, with the main thread simply
    recording them for execution in the next frame.</p><p>The rendering of a frame is divided into blocks. Blocks are rendered
    in order. Each block begins only after the previous block has
    finished.</p><p>Each block consists of any D3D rendering commands and associated
    vertex and index buffers, textures, shader constants or any other data.
    The block can be produced as a combination of conventional D3D rendering
    from the main thread and output from jobs running in parallel on cores
    allocated to run jobs.</p><p>Any number of jobs can produce the input for a block. Since only one
    block is rendering at a time and jobs execute in parallel you should use
    at least as many jobs as there are cores, otherwise there will be idle
    cores. Jobs within a block can finish in any order, but the block will not
    be rendered until all jobs are complete. While the jobs are executing D3D
    executes the previous block. Thus the job cores and the D3D core are
    constantly working while at the same time the main thread is preparing
    another frame of blocks and their corresponding jobs.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10632"></a>23.2.&nbsp;Under the Hood</h2></div></div></div><p>All rendering commands and jobs are stored in a command buffer. This
    is accomplished by wrapping D3D. All D3D function calls go to the wrapper
    which records them to be executed on the next frame while at the same time
    the commands from the previous frame are executed in another thread on the
    D3D core.</p><p>When flushed the D3D core first stalls for the results of the first
    block's jobs. Meanwhile each core in the job cluster starts grabbing jobs
    from the block. There is no central dispatch mechanism. The cores grab
    jobs and atomically decrement a counter for that block when they finish
    writing their results. Note that jobs are grabbed in order but they are
    not necessarily finished in order. For example, if the first job takes a
    long time the second might finish first and that core can begin on another
    job. This means that the output is not guaranteed to be contiguous until
    after the last job finishes and decrements the counter to zero.</p><p>Only then can the D3D core begin to process the results of the first
    block, while the cluster begins to operate on the second block, outputting
    the results into another buffer.</p><p>If the D3D core finishes first it retires the buffer and stalls
    until its next buffer is ready. If the cluster finishes first it stalls
    until the D3D core retires the buffer it is consuming so it can receive
    output from the cluster.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10643"></a>23.3.&nbsp;Wrapper API</h2></div></div></div><p>In addition to wrapping D3D the wrapper has a small API to control
    its behaviour.</p><p><code class="code">DX::newBlock()</code>: Starts a new block. All rendering from
    the previous block will finish before this one will begin and all job
    output that was used to render the previous block will no longer be
    accessible. What this means is that all jobs producing output for this
    block must be allocated before the next call to
    <code class="code">DX::newBlock()</code>.</p><p><code class="code">DX::setWrapperFlags()</code> and
    <code class="code">DX::getWrapperFlags()</code>: These functions get and set flags that
    control the behaviour of the wrapper.</p><p><code class="code">IMMEDIATE_LOCK</code>: Flush the command buffer and then
    execute the lock in the main thread. This is required if you are not going
    to fill in the entire locked region. It is an extremely expensive way to
    lock and should be avoided where possible.</p><p><code class="code">DEFERRED_LOCK</code>: This flag is used to lock a buffer that
    will be filled in with a job. The pointer that a lock returns can only be
    used to store into a job and then accessed when the job executes. The
    actual lock occurs in the next frame when the job executes.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10670"></a>23.4.&nbsp;Job System API</h2></div></div></div><p>The Job System API is accessed through the JobSystem singleton. It
    is obtained with <code class="code">JobSystem::instance()</code>.</p><p><code class="code">allocJob()</code>: This method places a job into the list of
    jobs for the current block and returns a user implemented class derived
    from Job. This has a virtual function called <code class="code">execute()</code> which
    actually performs the job. The derived class stores anything necessary for
    the execution of the job. Note that the jobs within a block will not
    execute in order.</p><p><code class="code">allocOutput()</code>: The job will need to produce output and
    this is allocated up front with <code class="code">allocOutput()</code>. It is called
    from the main thread and its result is placed into the Job object. The
    memory for the output is not actually allocated at this time, but it will
    be made ready at the time that the job is executed next frame.</p><p>Within a block you can have any mix of job and output allocations.
    For example, you may allocate one output and divide it between many jobs
    or vice versa or any combination you like. The only rule is that the
    output and the jobs must all come from the same block.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10694"></a>23.5.&nbsp;An Example</h2></div></div></div><p>Let us imagine that we are updating and rendering a simple particle
    system. This will be done in one block. The particle system consists of
    4096 points, each of which will be updated and generate one vertex into a
    vertex buffer for rendering.</p><p>Our block will consist of setting a vertex bufferer and calling
    DrawPrimitive on it. The vertex buffer will be filled using jobs. The
    vertex buffer will be divided into 8 parts of 512 vertices each. Each part
    will be filled in with one job.</p><p>Main thread:</p><div class="itemizedlist"><ul type="disc"><li><p>New Block</p></li><li><p>Lock vertex buffer of 4096 points using the
        <code class="code">DEFERRED_LOCK</code> flag</p></li><li><p>Set 8 jobs, each filling in 512 points</p></li><li><p>Set rendering states</p></li><li><p>DrawPrimitive</p></li><li><p>Reset wrapper flags</p></li></ul></div><p>All of the above steps are not immediately executed but rather
    recorded for execution on the next frame.</p><p>Jobs and D3D core:</p><p>During the next frame the default block renders until the new block
    for the particles is reached. At the same time the 8 jobs to fill the
    vertex buffers are executed. When the new block is reached and the jobs
    are completed the particles are rendered. At the same time the jobs for
    the next block are executed.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10731"></a>23.6.&nbsp;Implementing it</h2></div></div></div><p>Now that we understand how this example works we can go through the
    steps of implementing it.</p><p>First we need to implement our job object.</p><pre class="programlisting">class PointSpriteParticleJob : public Job
{
public:
    void set( Particle* particles, Moo::VertexXYZDP* pVertex, uint nPoints );
    virtual void execute();

private:
    Particle* particles_;
    Moo::VertexXYZDP* pVertex_;
    uint nPoints_;
};
</pre><p>The job object inherits the virtual <code class="code">execute()</code> method
    which gets called in the next frame just before the output of the job will
    be needed for consumption by the D3D core.</p><p>We also implement a <code class="code">set()</code> method which gets called from
    the main thread and stores all the information that will be needed in
    <code class="code"> execute()</code>.</p><p>The <code class="code">execute()</code> method will do two things. It will update
    the positions of the particles and output the new positions into a vertex
    buffer. Each given job object will do this for only a part of the particle
    system and vertex buffer so that the entire task can be divided into
    several jobs and execute in parallel on several cores.</p><p>Now we are ready to use the job class in our rendering code.</p><p>We begin this with a new block.</p><pre class="programlisting">DX::newBlock();
</pre><p>Now we are ready to queue our rendering commands.</p><p>First we need to lock a deferred vertex buffer, and to do this we
    need to set the appropriate wrapper flag before locking.</p><p>Normally when locking you get a pointer that you can use immediately
    to write vertex data. However our vertex data will be calculated in the
    next frame by jobs, so the lock actually has to occur at that time.
    Therefore we use a deferred lock which returns a pointer now but does not
    perform the lock until required.</p><pre class="programlisting">uint32 oldFlags = DX::getWrapperFlags();
DX::setWrapperFlags( DX::WRAPPER_FLAG_DEFERRED_LOCK );

Moo::DynamicVertexBufferBase2&lt;Moo::VertexXYZDP&gt;&amp; vb = Moo::DynamicVertexBufferBase2&lt;Moo::VertexXYZDP&gt;::instance();
Moo::VertexXYZDP* pVertex = vb.lock2( 4096 );
</pre><p>Now we are ready to allocate and set up our jobs. The pointer from
    the lock is used to set up the jobs.</p><pre class="programlisting">for ( uint i = 0; i &lt; 8; i++ )
{
    job = jobSystem.allocJob&lt;UpdateParticlesJob&gt;();
    job.set( particles + i*512, vertices + i*512, 512 );
}
</pre><p>Finally we can unlock the buffer, reset the wrapper flags and
    render.</p><p>At this point we can render as if the jobs that we have allocated
    and set are complete, since the following rendering commands will not be
    executed until that time.</p><pre class="programlisting">vb.unlock();
uint32 lockIndex = vb.lockIndex();

DX::setWrapperFlags( oldFlags );

vb.set( 0 );
Moo::rc().drawPrimitive( D3DPT_POINTLIST, lockIndex, nPoints );
</pre></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Debugging"></a>Chapter&nbsp;24.&nbsp;Debugging</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d0e10791">24.1. Build configuration &#8212; conditional feature inclusion</a></span></dt><dt><span class="section"><a href="#xref_Watchers">24.2. Watchers</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10818">24.2.1. Watcher types</a></span></dt><dt><span class="section"><a href="#d0e10829">24.2.2. Using watchers</a></span></dt><dt><span class="section"><a href="#d0e10844">24.2.3. Watcher Console</a></span></dt><dt><span class="section"><a href="#d0e10856">24.2.4. Remote watcher access</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e10872">24.3. Memory tracking</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e10877">24.3.1. ResourceCounters overview</a></span></dt><dt><span class="section"><a href="#d0e10899">24.3.2. Memory allocation taxonomy</a></span></dt><dt><span class="section"><a href="#d0e10930">24.3.3. Case studies</a></span></dt><dt><span class="section"><a href="#d0e11557">24.3.4. Displaying the memory tracking console</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11600">24.4. Scripts</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e11607">24.4.1. Python Console</a></span></dt><dt><span class="section"><a href="#xref_Remote_Python_Console">24.4.2. Remote Python Console</a></span></dt><dt><span class="section"><a href="#d0e11876">24.4.3. Script reloading</a></span></dt><dt><span class="section"><a href="#d0e11891">24.4.4. Common errors</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e11974">24.5. Script interactive debugging</a></span></dt><dt><span class="section"><a href="#xref_Client_Access_Tool_CAT">24.6. Client Access Tool (CAT)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12089">24.6.1. Connecting to the client</a></span></dt><dt><span class="section"><a href="#d0e12105">24.6.2. CAT Scripts</a></span></dt><dt><span class="section"><a href="#d0e12187">24.6.3. Creating scripts for CAT</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e12550">24.7. Timing</a></span></dt></dl></div><p>This section describes some of the debugging features of the BigWorld
  client.</p><p>Debugging is an important part of any development process, and the
  client has many features that facilitate finding bugs early, in-game
  debugging, remote debugging, and the immediate application of changes
  without restarting.</p><p>Many debugging features are accessed via a specially defined debug
  key. By default, the debug maps to the grave (tilde) key on the keyboard,
  however this can be re-configured by editing the engine configuration XML
  file.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10791"></a>24.1.&nbsp;Build configuration &#8212; conditional feature inclusion</h2></div></div></div><p>BigWorld provides a number of features that aid in runtime
    debugging, such as the debug menu and the telnet Python service.</p><p>To remove these features from a final release build of the client, a
    number of compile guards exist. These are collectively controlled by the
    following define located in src/lib/ cstdmf/config.hpp.</p><pre class="programlisting">#define CONSUMER_CLIENT_BUILD 0</pre><p>If <span class="literal">CONSUMER_CLIENT_BUILD</span> is 0, then the
    development features will be compiled.</p><p>Individual features are encapsulated in their own individual compile
    guards, which can collectively be switched using the above define.
    Individual features may also be enabled, by setting the corresponding
    force enable define to a non-zero value.</p><p>This is illustrated in the example below:</p><pre class="programlisting">#define CONSUMER_CLIENT_BUILD    0

#define FORCE_ENABLE_DEBUG_KEY_HANDLER    0
#define ENABLE_DEBUG_KEY_HANDLER  (!CONSUMER_CLIENT_BUILD \
                                   || FORCE_ENABLE_DEBUG_KEY_HANDLER)
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Watchers"></a>24.2.&nbsp;Watchers</h2></div></div></div><p>A watcher is an object that wraps a variable or function result in a
    program, and turns it into a string.</p><p>Watchers can be read-write or read-only, and can be viewed in
    various ways. Their hierarchy is usually organised by functionality. There
    are also watchers that can dynamically match changing data, such as the
    contents of a sequence or map.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10818"></a>24.2.1.&nbsp;Watcher types</h3></div></div></div><p>The simplest watcher type is the DirectoryWatcher, which allows
      the creation of a directory of other watchers (including
      DirectoryWatchers). This is one way in which the hierarchy can be built
      up. For example, a float value for the amount of rain drawn by the rain
      system in the BigWorld client is specified at 'Client Settings/Rain/
      amount'. This uses three DirectoryWatchers: the root directory, the
      Client Settings directory, and the Rain directory.</p><p>There are also templatised watchers for any data type that can be
      streamed onto a std::stream object. These come in two flavours, as
      DataWatchers of variables, and as MemberWatchers of the result (or sole
      argument) of member functions of a class.</p><p>The DataWatchers and MemberWatchers can also take a 'base object'
      argument, which the data they point to is considered a member of. This
      is very useful when combined with more complicated types of watchers,
      such as the SequenceWatcher.</p><p>The SequenceWatcher and MapWatcher appear to be the same as a
      DirectoryWatcher, but they watch any class that supports the STL
      sequence or mapping methods. They have just one client watcher, but they
      present as many children as there are elements of their wrapped
      container. The child watcher is called with its 'base object' set to the
      element of the container. To handle pointers in these containers, there
      is also the BaseDereferenceWatcher, which presents no extra hierarchy
      level, but rather dereferences its base object and calls a sole child
      watcher with that value. The children can be named either by a static
      list, or by making a request for a certain value in the child watcher
      (such as name).</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10829"></a>24.2.2.&nbsp;Using watchers</h3></div></div></div><p>From the types above, it can be seen that a watcher hierarchy can
      be set up to both expose simple settings and to track complex
      structures.</p><p>The simplest way to make a watcher is to use the MF_WATCH macro.
      This macro takes the path name for the watcher, and a variable or member
      function to get/set its value. It expands to code that adds the
      appropriate watcher.</p><p>To change the parsing or display of a value (as a string), it is
      not necessary to write a new watcher. Instead, you can use member
      functions that get and set the value as a string. This is how the
      'Client Settings/Time of day' value works &#8212; there are simple accessors
      for timeOfDayAsString, which format the time of day as 'hours:minutes'
      and parse it back from the same format. Setting a watcher can also be
      used to trigger a command &#8212; for example, the server is also notified
      whenever the time of day is set (for debugging purposes only).</p><p>To track complex structures, the appropriate watcher must be
      created directly, and inserted into the watcher hierarchy. Classes that
      participate in such an arrangement often implement a getWatcher() static
      method that returns a watcher object that works when the 'base object'
      is set to an instance of their class. The same watcher can be shared by
      all instances of the class, and is usually of type DirectoryWatcher of
      DataWatchers and MemberWatchers.</p><p>This is done on the client with the map of entities maintained by
      the Entity Manager. The entities are named by their ID.</p><p>Most of the C++ state of the client is also available through
      explicitly added watchers, as they were needed for some stage of the
      debugging already.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10844"></a>24.2.3.&nbsp;Watcher Console</h3></div></div></div><p>The watcher console provides access to the watcher system from
      within the game. It can be brought up at any time, and overlays the game
      screen with a listing of the current watcher directory.</p><p>Directory-like entries can be followed down, and the value of any
      writable watcher can be set by selecting it, pressing
      <span class="literal">Enter</span>, then typing in a new value.</p><p>There are also keys for adjusting numerical values by 1, 10, 100,
      or 1000.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10856"></a>24.2.4.&nbsp;Remote watcher access</h3></div></div></div><p>The watcher system is exported from the client using a very simple
      UDP-based watcher message protocol. The server uses this protocol
      extensively for its own debugging needs.</p><p>This is not related to Mercury, although it can be (and currently
      is) linked to its input loop. When the client starts up, it broadcasts a
      watcher nub notification packet, advertising the port its watcher nub is
      listening for requests on (it sends a similar message when it shuts down
      cleanly).</p><p>To access the watcher values, a number of tools may be used, but
      by far the most useful is a UNIX daemon called 'watcher'. This daemon
      listens for any broadcast watcher packets and adds or removes them from
      an internal list.</p><p>The other side of the daemon presents an HTTP interface to all the
      watcher nubs it knows. It inserts the name of the watcher nub (contained
      in the registration message, <em class="emphasis">e.g.</em>, 'client of
      John', 'cell14', etc...) as the top level of a watcher super-hierarchy.
      It presents the individual watcher trees as branches of this top
      directory. The path in the request URL is translated into the watcher
      value request path. This interface can get and set values.</p><p>So by connecting to this daemon with any web browser, all the
      running clients on the local network can be seen, and then investigated
      or manipulated, right down to changing the value of a Python variable in
      an entity. Python variables can be set to arbitrary Python, which is
      executed on the client to find its value. The client can also send its
      watcher nub notification to another external address if so desired, so
      even remote clients can be accessed in this way.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e10872"></a>24.3.&nbsp;Memory tracking</h2></div></div></div><p>The memory tracking system can be used to determine the amount of
    memory allocated to a class or module. The ResourceCounters class is the
    primary class used to perform the tracking.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10877"></a>24.3.1.&nbsp;ResourceCounters overview</h3></div></div></div><p>This is a simple class that tracks the memory usage of a component
      based on a description string (the component allocating/deallocating the
      memory) and a memory pool enumeration (the memory pool to be used,
      <em class="emphasis">i.e.</em>, system memory, managed video memory, or
      default video memory).</p><p>The two main worker methods of this class are add and subtract,
      which respectively track memory allocations and deallocations using the
      description-pool.</p><p>The <span class="literal">ResourceCounters</span> class maintains a map of
      the components it is tracking. Rather than calling the methods of
      ResourceCounters directly, two macros are exposed. These macros are
      defined away to nothing when memory tracking is disabled:</p><pre class="programlisting">#define RESOURCE_COUNTER_ADD(DESCRIPTION_POOL, AMOUNT) /
  ResourceCounters::instance().add(DESCRIPTION_POOL, (size_t)(AMOUNT));
#define RESOURCE_COUNTER_SUB(DESCRIPTION_POOL, AMOUNT) /
  ResourceCounters::instance().subtract(DESCRIPTION_POOL, (size_t)(AMOUNT));</pre><p>ResourceCounters also exposes <span class="literal">toString</span>-style
      methods that are used by the realtime resource-monitoring console to
      display the current memory usage statistics.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10899"></a>24.3.2.&nbsp;Memory allocation taxonomy</h3></div></div></div><p>With respect to the memory tracking system, there are two basic
      types of memory allocation:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">DirectX memory
          allocation</em></p><p>All DirectX resources are COM objects. COM objects use
          reference counting to manage their sharing among multiple objects.
          The Moo library provides the wrapper class ComObjectWrap for dealing
          with these objects.</p><p>Inside BigWorld, there are two reference types used to refer
          to DirectX objects: plain points (<em class="emphasis">e.g.</em>,
          DX::Texture*) and ComObjectWrap pointers. For DirectX objects, the
          memory tracking is performed purely through the ComObjectWrap class.
          Therefore, any DirectX resource that needs its memory tracked must
          be refactored to use ComObjectWrap references if it does not do so
          already. For details on how the DirectX textures were instrumented,
          see <a href="#xref_DirectX_Textures" title="24.3.3.1.&nbsp;DirectX textures">DirectX textures</a>.</p></li><li><p><em class="emphasis">Standard memory
          allocation</em></p><p>All other objects in BigWorld use standard stack or heap
          memory. Unlike the memory tracking for DirectX resources, there is
          no unified way of instrumenting a particular class or set of
          classes. For details on the main issues encountered when
          instrumenting arbitrary classes, see <a href="#xref_Binary_Blocks" title="24.3.3.2.&nbsp;Binary blocks">Binary blocks</a>, <a href="#xref_Terrain_Height_Maps" title="24.3.3.3.&nbsp;Terrain height maps">Terrain height maps</a>, and <a href="#xref_Terrain_Texture_Layers" title="24.3.3.4.&nbsp;Terrain texture layers">Terrain texture layers</a>.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10930"></a>24.3.3.&nbsp;Case studies</h3></div></div></div><p>This section documents the instrumenting of four classes/types
      that make up the BigWorld system:</p><div class="itemizedlist"><ul type="disc"><li><p>DirectX textures</p></li><li><p>Binary blocks</p></li><li><p>Terrain height maps</p></li><li><p>Terrain texture layers.</p></li></ul></div><p>Each of these classes/types presents its own set of challenges.
      These examples highlight the main issues that come up during
      instrumentation.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_DirectX_Textures"></a>24.3.3.1.&nbsp;DirectX textures</h4></div></div></div><p>Even with the memory-tracking functionality added to the
        <span class="literal">ComObjectWrap</span> class, COM objects are not
        memory-tracked by default, because the accounting for memory must
        occur after the resource has been created. Since there is no way of
        knowing when this happens automatically, memory tracking cannot be
        activated automatically for all COM objects.</p><p>In order to activate the memory tracking for a particular
        DirectX resource, the programmer must make a call to
        <span class="literal">ComObjectWrap::addAlloc(<em class="replaceable"><code>&lt;string
        description&gt;</code></em>)</span> after creating the DirectX
        resource to activate the memory tracking for this resource. Note that
        <span class="literal">ComObjectWrap</span> objects automatically handle the
        deallocation of memory from the memory tracking system on destruction
        of the last resource reference. Therefore there is no need for the
        programmer to explicitly make the deallocation.</p><p>Below are excerpts of the <span class="literal">lock_map.*pp</span> files
        that support DirectX texture instrumenting.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">src/tools/worldeditor/project/lock_map.hpp</span></em></p><pre class="programlisting">Class LockMap
{
public:
  ...
  ComObjectWrap&lt;DX::Texture&gt; lockTexture() { return lockTexture_; }
  ...
private:
  ...
  ComObjectWrap&lt;DX::Texture&gt; lockTexture_;
  ...
};</pre></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">src/tools/worldeditor/project/lock_map.cpp</span></em></p><pre class="programlisting">LockMap::LockMap() :
  gridWidth_(0),
  gridHeight_(0),
  colourLocked_(Colour::getUint32(COLOUR_LOCKED)),
  colourLockedEdge_(Colour::getUint32(COLOUR_LOCKED_EDGE)),
  colourLockedByOther_(Colour::getUint32(COLOUR_LOCKED_BY_OTHER)),
  colourUnlocked_(Colour::getUint32(COLOUR_UNLOCKED))
{
}
...

void LockMap::setTexture(uint8 textureStage)
{
  Moo::rc().setTexture(textureStage, lockTexture_.pComObject());
}
...

void LockMap::updateLockData(  uint32 width, uint32 height, uint8* lockData)
{
  bool recreate = !lockTexture_.pComObject(); <a name="co9669"></a><img src="../images/callouts/1.png" alt="1" border="0">
  ...
}

void LockMap::releaseLockTexture()
{
  lockTexture_ = NULL; <a name="co9675"></a><img src="../images/callouts/2.png" alt="2" border="0">
}
...

void LockMap::createLockTexture()
{
  ...
  HRESULT hr = Moo::rc().device()-&gt;CreateTexture(
    gridWidth_, gridHeight_, 1, 0, D3DFMT_A8R8G8B8,
    D3DPOOL_MANAGED, &amp;lockTexture_, 0 );
  lockTexture_.addAlloc("texture/lock terrain");
  ...
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a href="#co9669"><img src="../images/callouts/1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>Several functions require a reference to a DirectX
                texture resource, such as <span class="literal">setTexture</span>. A
                call to <span class="literal">ComObjectWrap:: pComObject()</span>
                returns such a pointer.</p></td></tr><tr><td width="5%" valign="top" align="left"><a href="#co9675"><img src="../images/callouts/2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><p>When releasing resources, the release call is handled
                automatically. It must not be called explicitly on release &#8212;
                <span class="literal">ComObjectWrap</span> should simply be set to
                <span class="literal">NULL</span>.</p></td></tr></table></div></li></ul></div><p>It is important that when <span class="literal">ComObjectWrap</span>
        objects are being used to access a DirectX resource that they be used
        everywhere to access that resource. <span class="literal">ComObjectWrap</span>
        objects automatically increment and decrement the internal reference
        count of the COM objects they reference when passing COM objects
        between themselves. Passing a COM object reference from a
        <span class="literal">ComObjectWrap</span> object to a regular pointer
        circumvents the automated memory deallocation and reference
        decrementing functionality.</p><p>The only situation when a DirectX resource should be exposed as
        a plain pointer is when passing the object to DirectX functions
        directly (see the above example in
        <span class="literal">src/tools/bigbang/project/lock_map.cpp</span>'s function
        <span class="literal">setTexture</span>, when
        <span class="literal">Moo::rc().setTexture</span> is called).</p><p>In
        <span class="literal">src/tools/worldeditor/project/lock_map.cpp</span>'s
        function <span class="literal">createLockTexture</span>, directly after the call
        to <span class="literal">Moo::rc().device()-&gt;CreateTexture</span>, a call to
        <span class="literal">lockTexture_.addAlloc("texture/lock terrain")</span> is
        made. This call accounts for the allocation of memory during the
        <span class="literal">Moo::rc().device()-&gt;CreateTexture</span> call for the
        <span class="literal">lockTexture_</span> object. The" texture/lock terrain"
        memory resource pool will be incremented by the amount of memory used
        by <span class="literal">lockTexture_</span>. But how to is the amount of memory
        used by <span class="literal">lockTexture_</span> determined?</p><p><span class="literal">ComObjectWrap</span> is a templated class. A
        different class implementation is created at compile time for each COM
        object that makes use of this class. In the case of
        <span class="literal">DX::Texture</span>, a
        <span class="literal">ComObjectWrap&lt;Dx::Texture&gt;</span> class is created.
        During the call
        <span class="literal">ComObjectWrap::addAlloc(<em class="replaceable"><code>&lt;string
        description&gt;</code></em>)</span>, calls to the functions
        <span class="literal">ComObjectWrap::pool</span> and
        <span class="literal">ComObjectWrap::size</span> are made. Each COM object can
        implement its own version of these methods using template
        specialisation. The
        <span class="literal">ComObjectWrap&lt;Dx::Texture&gt;</span> versions
        are:</p><pre class="programlisting">template&lt;&gt; uint ComObjectWrap&lt;DX::Texture&gt;::pool() const
{
  // Get a surface to determine pool
  D3DSURFACE_DESC surfaceDesc;
  pComObject_-&gt;GetLevelDesc(0, &amp;surfaceDesc);
  
  return (uint)surfaceDesc.Pool;
}

template&lt;&gt; uint ComObjectWrap&lt;DX::Texture&gt;::size() const
{
  // Determine the mip-map texture size scaling factor
  double mipmapScaler = 0.0;
  for (DWORD i = 0; i &lt; pComObject_-&gt;GetLevelCount(); i++)
  mipmapScaler += 1 / pow(4.0, (double)i);

  // Get a surface to determine the width, height, and format
  D3DSURFACE_DESC surfaceDesc;
  pComObject_-&gt;GetLevelDesc(0, &amp;surfaceDesc);

  // Get the surface size
  uint32 surfaceSize = DX::surfaceSize(surfaceDesc);

  // Track memory usage
  return (uint)(surfaceSize * mipmapScaler);
}</pre><p><span class="citetitle">Excerpt &#8212;
        <span class="literal">src/lib/moo/com_object_wrap.ipp</span></span></p><p>The <span class="literal">ComObjectWrap&lt;DX::Texture&gt;::pool</span>
        function determines what memory pool the texture resides in by
        examining the surface description of the surface at mipmap level 0.
        The <span class="literal">ComObjectWrap&lt;DX::Texture&gt;::size</span> function
        determines the size of the memory allocation by computing the mipmap
        scaling factor due to the mipmap levels, determining the memory
        footprint of the zero level mipmap level for the given texture format,
        and then multiplying the two.</p><p>Every DirectX resource that is to be memory-tracked will need to
        implement its own versions of these functions.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Binary_Blocks"></a>24.3.3.2.&nbsp;Binary blocks</h4></div></div></div><p>Memory tracking for <span class="literal">BinaryBlock</span> involves
        calls to the <span class="literal">RESOURCE_COUNTER_ADD</span> and
        <span class="literal">RESOURCE_COUNTER_SUB</span> macros in the constructor and
        destructor respectively. In the constructor, if the
        <span class="literal">BinaryBlock</span> is the owner of the data, the memory
        tracking call is:</p><pre class="programlisting">RESOURCE_COUNTER_ADD( ResourceCounters::DescriptionPool(  "binary block",
                     (uint)ResourceCounters::SYSTEM),
                     (uint)(len_ + sizeof(*this)))</pre><p>Otherwise, if another <span class="literal">BinaryBlock</span> owns the
        data, the call is:</p><pre class="programlisting">RESOURCE_COUNTER_ADD( ResourceCounters::DescriptionPool(  "binary block",
                      (uint)ResourceCounters::SYSTEM),
                      (uint)sizeof(*this))</pre><p>Note that in the first version, the size of the binary data
        allocation is accounted for, as well as the size of the
        <span class="literal">BinaryBlock</span> object, while in the second version
        only the size of the <span class="literal">BinaryBlock</span> object is
        accounted for. Similarly in the destructor, if the
        <span class="literal">BinaryBlock</span> owns the data, the memory tracking call
        is:</p><pre class="programlisting">RESOURCE_COUNTER_SUB( ResourceCounters::DescriptionPool(  "binary block",
                      (uint)ResourceCounters::SYSTEM),
                      (uint)(len_ + sizeof(*this)))</pre><p>Otherwise, the call is:</p><pre class="programlisting">RESOURCE_COUNTER_SUB( ResourceCounters::DescriptionPool(  "binary block",
                      (uint)ResourceCounters::SYSTEM),
                      (uint)sizeof(*this))</pre><p>As it stands, the memory usage for all
        <span class="literal">BinaryBlock</span> objects is placed in a single resource
        pool called "binary block". This is still a very high level of
        granularity &#8212; it is likely that <span class="literal">BinaryBlock</span> objects
        are used by many different objects to varying degrees. It would be
        useful to known their distribution throughout the system. For details
        on how this is done, see <a href="#xref_Terrain_Texture_Layers" title="24.3.3.4.&nbsp;Terrain texture layers">Terrain texture layers</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Terrain_Height_Maps"></a>24.3.3.3.&nbsp;Terrain height maps</h4></div></div></div><p>Like most classes, <span class="literal">TerrainHeightMap2</span> has
        primitive types, pointers, and objects as member variables.</p><pre class="programlisting">TerrainHeightMap2::TerrainHeightMap2(CommonTerrainBlock2 &amp;terrainBlock2):
...
{
  ...
  RESOURCE_COUNTER_ADD( ResourceCounters::DescriptionPool(  "height map",
                        (uint)ResourceCounters::SYSTEM),
                        (uint)(sizeof(*this)))
}
TerrainHeightMap2::~TerrainHeightMap2()
{
  RESOURCE_COUNTER_SUB( ResourceCounters::DescriptionPool(  "height map",
                        (uint)ResourceCounters::SYSTEM),
                        (uint)(sizeof(*this)))
}</pre><p><span class="citetitle">Excerpt &#8212;
        <span class="literal">src/lib/moo/terrain_height_map2.cpp</span></span></p><p>The calls to <span class="literal">RESOURCE_COUNTER_ADD</span> and
        <span class="literal">RESOURCE_COUNTER_SUB</span> account for the static memory
        used by the member variables, but do not account for the dynamically
        allocated memory used by our member pointers, the member pointers of
        our member objects, member pointers of member objects of our member
        objects, and so on.</p><p>Therefore, it is necessary to examine both the member pointers
        and the member objects to account for their dynamic memory usage, if
        any. With respect to the TerrainHeightMap2 class, there are three
        members of interest:</p><div class="itemizedlist"><ul type="disc"><li><p><span class="literal">CommonTerrainBlock2*
            terrainBlock2_</span></p></li><li><p><span class="literal">TerrainQuadTreeCell quadTree_</span></p></li><li><p>I<span class="literal">mage&lt;float&gt; heights_</span></p></li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e11196"></a>24.3.3.3.1.&nbsp;<span class="literal">CommonTerrainBlock2*
          terrainBlock2_</span></h5></div></div></div><p>On construction of a <span class="literal">TerrainHeightMap2</span>
          object, a reference to the parent
          <span class="literal">CommonTerrainBlock2</span> objects is passed in. As
          such, the <span class="literal">TerrainHeightMap2</span> is not responsible
          for the memory usage of this class (in fact, the opposite is true &#8212;
          if memory tracking is added to
          <span class="literal">CommonTerrainBlock2</span>, then it is likely that the
          memory allocated by <span class="literal">TerrainHeightMap2</span> should be
          allocated into the <span class="literal">CommonTerrainBlock2</span> resource
          counter). Simply accounting for the
          <span class="literal">terrainBlock2_</span> pointer in the constructor's call
          to <span class="literal">RESOURCE_COUNTER_ADD</span> is sufficient.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="xref_TerrainQuadTreeCell_quadTree"></a>24.3.3.3.2.&nbsp;TerrainQuadTreeCell quadTree_</h5></div></div></div><p>The <span class="literal">TerrainQuadTreeCell</span> class must be
          inspected to check whether it or any of its members result in any
          dynamic memory allocations. The inspection is recursive until all
          members and their allocations are accounted for. For the
          <span class="literal">TerrainQuadTreeCell</span> class we have the following
          expansion:</p><pre class="programlisting">TerrainQuadTreeCell

    std::string allocator_;                      // Need to account for this
    std::vector&lt;TerrainQuadTreeCell&gt; children_;  // Need to account for this
    BoundingBox boundingBox_;                    // Need to expand

      static BoundingBox s_insideOut_;          // For simplicity we do not
                                                // account for static members
      Outcode oc_;                              // Is of primitive type uint32
      Outcode combinedOc_;                      // Is of primitive type uint32
      Vector3 min_;                             // Only contains primitives
      Vector3 max_;                             // Only contains primitives</pre><p>For <span class="literal">TerrainQuadTreeCell</span>, the dynamic memory
          used by member variables
          <span class="literal">TerrainQuadTreeCell::allocator</span>_ and
          <span class="literal">TerrainQuadTreeCell::children_</span> must be accounted
          for.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">
              <span class="literal">TerrainQuadTreeCell::allocator_</span></em></p><p><span class="literal">allocator_</span> is a
              <span class="literal">std::string</span> that records the resource pool
              being used. Since we want <span class="literal">TerrainHeightMap2</span>'s
              <span class="literal">TerrainQuadTreeCell</span> instances to use
              <span class="literal">TerrainHeightMap2</span>'s resource pool, we need a
              way to configure <span class="literal">TerrainQuadTreeCells</span>
              resource pool. This is done by passing the resource pool string
              to the <span class="literal">TerrainQuadTreeCell</span>
              constructor.</p><pre class="programlisting">TerrainQuadTreeCell::TerrainQuadTreeCell(const std::string&amp; allocator);</pre><p><em class="emphasis">Excerpt &#8212;
              <span class="literal">src/lib/moo/terrain_quad_tree_cell.cpp</span></em></p><p><span class="literal">allocator</span>_ is then set to the resource
              pool passed as parameter, so that the correct resource pool will
              be used. It is a simple matter to account for
              <span class="literal">allocator_</span>'s additional memory usage in the
              constructor's memory-tracking call to
              <span class="literal">RESOURCE_COUNTER_ADD</span>:</p><pre class="programlisting">TerrainQuadTreeCell::TerrainQuadTreeCell(const std::string&amp; allocator);
{
  ...
  RESOURCE_COUNTER_ADD( ResourceCounters::DescriptionPool(  allocator_,
                        (uint)ResourceCounters::SYSTEM),
                        (uint)( sizeof(*this) + 
                        allocator_.capacity() ))
  ...
}</pre><p>A similar call is made in the destructor.</p></li><li><p><em class="emphasis"><span class="literal">TerrainQuadTreeCell::children_</span></em></p><p><span class="literal">children_</span> is a
              <span class="literal">std::vector</span> containing zero or four
              <span class="literal">TerrainQuadTreeCell</span> objects. Vectors use
              dynamic memory allocation, but since the objects are of type
              <span class="literal">TerrainQuadTreeCell</span>, that means we are
              already accounting for the memory of each allocation. The only
              catch with having a vector of
              <span class="literal">TerrainQuadTreeCell</span> objects is that the call
              to <span class="literal">children_.resize(4)</span> in
              <span class="literal">TerrainQuadTreeCell::init</span> would create four
              <span class="literal">TerrainQuadTreeCell</span> objects using the default
              constructor. These objects must use the same resource pool as
              their parent <span class="literal">TerrainQuadTreeCell</span> object. This
              is achieved by passing a prototype instance to the resize method
              with the appropriate resource pool:</p><pre class="programlisting">void TerrainQuadTreeCell::init(...)
{
  ...
  TerrainQuadTreeCell childPrototype(allocator_);
  children_.resize(4, childPrototype);
  ...</pre><p><span class="citetitle">Excerpt &#8212;
              <span class="literal">src/lib/moo/terrain_quad_tree_cell.cpp</span></span></p><p>At this point all memory has been accounted for in class
              <span class="literal">TerrainHeightMap2</span>.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="xref_Image_float_heights"></a>24.3.3.3.3.&nbsp;<span class="literal">Image&lt;float&gt; heights_</span></h5></div></div></div><p>The <span class="literal">Image&lt;float&gt;</span> class must be
          inspected to see if it or any of its members result in any dynamic
          memory allocations. Like the inspection performed on
          <span class="literal">TerrainQuadTreeCell</span>, the inspection is recursive
          until all members and there allocations are accounted for. The
          member variables of the <span class="literal">Image&lt;PixelType&gt;</span>
          class are:</p><pre class="programlisting">Image&lt;PixelType&gt;

  std::string allocator_;           // Need to account for this
  PixelType* pixels_;               // Need to account for this
  PixelType** lines_;               // Need to account for this
  uint32 width_;                    // Primitive
  uint32 height_;                   // Primitive
  bool owns_;                       // Primitive
  size_t stride_;                   // Primitive</pre><p>For <span class="literal">Image&lt;float&gt;</span>, the dynamic memory
          used by the member variables
          <span class="literal">Image&lt;float&gt;::allocator_</span>,
          <span class="literal">Image&lt;float&gt;::pixels_</span>, and
          <span class="literal">Image&lt;float&gt;::lines_</span> must be accounted
          for.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">Image&lt;float&gt;::allocator_</span></em></p><p>Just like
              <span class="literal">TerrainQuadTreeCell::allocator_</span> (for details,
              see <a href="#xref_TerrainQuadTreeCell_quadTree" title="24.3.3.3.2.&nbsp;TerrainQuadTreeCell quadTree_">TerrainQuadTreeCell quadTree_</a>),
              <span class="literal">Image&lt;float&gt;::allocator_</span> stores the
              resource pool for this object. Its memory is accounted for in
              the constructor's memory tracking call to
              <span class="literal">RESOURCE_COUNTER_ADD</span>:</p><pre class="programlisting">RESOURCE_COUNTER_ADD(  ResourceCounters::DescriptionPool(  allocator_,
                       (uint)ResourceCounters::SYSTEM),
                       (uint)( sizeof(*this) + allocator_.capacity() ))</pre><p>A similar call is made in the destructor.</p></li><li><p><em class="emphasis"><span class="literal">Image&lt;float&gt;::pixels_</span></em></p><p>The dynamic memory allocations assigned to
              Image<span class="literal">&lt;float&gt;::pixels_</span> can be determined
              simply by searching through the Image class. Every direct or
              indirect memory allocation and deallocation must be accounted
              for. The following is an example of an indirect dynamic memory
              allocation to the <span class="literal">Image&lt;float&gt;::pixels_</span>
              member variable.</p><pre class="programlisting">template&lt;typename PixelType&gt;
bool Image&lt;PixelType&gt;::createBuffer(uint32 w, uint32 h, PixelType* &amp; buffer,
                          bool&amp; owns, size_t&amp; stride, bool&amp; flipped)
{
  ...
  // Track memory usage
  RESOURCE_COUNTER_ADD(
    ResourceCounters::DescriptionPool(  allocator_,
                              (uint)ResourceCounters::SYSTEM),
                              (uint)(sizeof(PixelType) * w * h))
  buffer = new PixelType[w*h];
  ...
}

template&lt;typename PixelType&gt;
void Image&lt;PixelType&gt;::init(  uint32 w, uint32 h, PixelType *pixels,
                      bool owns, size_t stride, bool flipped)
{
  ...
  pixels_ = pixels;
  width_  = w;
  height_ = h;
  owns_   = owns;
  stride_ = (stride == 0) ? w*sizeof(PixelType) : stride;
  createLines(width_, height_, pixels_, stride_, flipped);
}

template&lt;typename PixelType&gt;
inline void Image&lt;PixelType&gt;::resize(uint32 w, uint32 h)
{
  ...
  PixelType *newBuf = NULL;  // Creates a PixelType pointer
  bool owns, flipped;
  size_t stride;

  // newBuf points to newly created pixel buffer
  createBuffer(w, h, newBuf, owns, stride, flipped);

  // pixels_ now points to newly created pixel buffer
  init(w, h, newBuf, owns, stride, flipped);
}</pre></li><li><p><em class="emphasis"><span class="literal">Image&lt;float&gt;::lines_</span></em></p><p>Use the same technique described above for
              <span class="literal">Image&lt;float&gt;::lines_</span>.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="xref_Terrain_Texture_Layers"></a>24.3.3.4.&nbsp;Terrain texture layers</h4></div></div></div><p>The final instrumenting case study is for class
        <span class="literal">TerrainTextureLayer2</span>. The techniques described in
        the earlier case studies can be used to account for all but three of
        <span class="literal">TerrainTextureLayer2</span>'s member variables:</p><pre class="programlisting">CommonTerrainBlock2* terrainBlock_;      // Same as CommonTerrainBlock2* terrainBlk2
std::string textureName_;                // Need to account for this
TerrainTextureLayer2::ImageType blends_; // Same as Image&lt;float&gt; heights_
uint32 width_;                           // Primitive
uint32 height_;                          // Primitive
Vector4 uProjection_;                    // Primitive
Vector4 vProjection_;                    // Primitive
size_t lockCount_;                       // Primitive
BaseTexturePtr pTexture_;                // Need to account for this
State state_;                            // Primitive
BinaryPtr compressedBlend_;              // Need to account for this</pre><p><span class="citetitle"><span class="literal">TerrainTextureLayer2</span>'s member
        variables</span></p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">std::string::textureName_</span></em></p><p><span class="literal">textureName_</span> can be accounted for in a
            similar manner to TerrainQuadTreeCell::allocator_ (for details,
            see <a href="#xref_TerrainQuadTreeCell_quadTree" title="24.3.3.3.2.&nbsp;TerrainQuadTreeCell quadTree_">TerrainQuadTreeCell quadTree_</a>) and
            <span class="literal">Image&lt;float&gt;::allocator_ </span>(for details,
            see <a href="#xref_Image_float_heights" title="24.3.3.3.3.&nbsp;Image<float&gt; heights_"><span class="literal">Image&lt;float&gt; heights_</span></a>), except that the
            allocation occurs in several places in
            <span class="literal">terrain_texture_layer2.cpp</span>. Each can be handled
            similarly by subtracting from the resource pool before an
            assignment and adding to the resource pool after an assignment, as
            illustrated below:</p><pre class="programlisting">RESOURCE_COUNTER_SUB(  ResourceCounters::DescriptionPool(  "texture layer",
                       (uint)ResourceCounters::SYSTEM),
                       (uint)textureName_.capacity())

textureName_ = filename;

RESOURCE_COUNTER_ADD(  ResourceCounters::DescriptionPool(  "texture layer",
                       (uint)ResourceCounters::SYSTEM),
                       (uint)textureName_.capacity())</pre><p><span class="citetitle">Excerpt &#8212;
            <span class="literal">src/lib/moo/terrain_texture_layer2.cpp</span></span></p></li><li><p><span class="literal">BaseTexturePtr::pTexture_</span></p><p><span class="literal">BaseTexturePtr</span> is a smart pointer to the
            abstract class <span class="literal">BaseTexture</span>. The first case
            study above already accounted for all texture usage in the system,
            therefore we need a way to override the call to
            <span class="literal">ComObjectWrap::addAlloc(std::string
            description)</span> so that for this particular texture the
            "terrain texture layer/texture" memory resource pool is
            used.</p><p>First, a search is performed to find where
            <span class="literal">pTexture_</span> is being assigned:</p><pre class="programlisting">pTexture_ = TextureManager::instance()-&gt;get( textureName_ );</pre><p>The desired memory pool needs to be added to this parameter
            list to override the default pool used for
            <span class="literal">TextureManager</span>'s created textures. The call now
            looks like this with all the default values for the parameters
            filled in:</p><pre class="programlisting">pTexture_ = TextureManager::instance()-&gt;get(
      textureName_, true, true, true, "terrain texture layer/texture" );</pre><p>The last parameter must have a default value assigned so
            that the interface for the method is not broken. The allocator
            pool must be passed through to the construction of the
            <span class="literal">AnimatingTexture</span> and
            <span class="literal">ManagedTexture</span> classes. This requires the
            addition of the allocator pool description string to the
            constructors of these classes (and any other classes that inherit
            from <span class="literal">BaseTexture</span> that need more accurate memory
            tracking). The constructor of the <span class="literal">BaseTexture</span>
            class is also changed to accept this allocator string in its
            constructor and store it in a member variable. This member
            variable can then be used by all classes that inherit from
            <span class="literal">BaseTexture</span> to account for the memory allocated
            in the call to <span class="literal">CreateTexture</span>.</p></li><li><p><em class="emphasis"><span class="literal">BinaryPtr::compressedBlend_</span></em></p><p>As mentioned above, the <span class="literal">BinaryBlock</span> class
            accounts for all its memory usage. Therefore, if we wish to
            account for the <span class="literal">compressedBlend_</span> dynamic
            allocation in the <span class="literal">TerrainTextureLayer2</span> memory
            pool we must override the memory tracking in
            <span class="literal">BinaryBlock</span>. This can be achieved similarly to
            how the resource pool was overridden when creating a texture. The
            desired pool must be passed through to the
            <span class="literal">BinaryBlock</span> constructor. This required adding
            the default valued allocator string to the end of the following
            methods:</p><pre class="programlisting">inline BinaryPtr Moo::compressImage( Image&lt;PIXELTYPE&gt; const &amp;image,
                                     std::string allocator)
{
   ...
   return compressPNG(pngData, allocator);
}
...</pre><p><span class="citetitle"><span class="literal">src/lib/moo/png.hpp</span></span></p><pre class="programlisting">BinaryPtr Moo::compressPNG( PNGImageData const &amp;data,
                            std::string allocator)
{
   ...
   BinaryPtr result = concatenate(outputBuffers, allocator);
   ...
}
...
BinaryPtr concatenate ( std::vector&lt;BinaryPtr&gt; const &amp;buffers,
                        std::string            const &amp;allocator)
{
   ...
   BinaryPtr result = new BinaryBlock(data, totalSize, allocator() );
   ...
}</pre><p><span class="citetitle"><span class="literal">src/lib/moo/png.cpp</span></span></p><pre class="programlisting">BinaryBlock::BinaryBlock( const void * data, int len,
                          const char *allocator, BinaryPtr pOwner )
{
   ...
   RESOURCE_COUNTER_ADD( ResourceCounters::DescriptionPool(allocator_,
                         (uint)ResourceCounters::SYSTEM),
                         (uint)sizeof(*this))
}</pre><p><span class="citetitle"><span class="literal">src/lib/resmgr/binary_block.cpp</span></span></p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e11557"></a>24.3.4.&nbsp;Displaying the memory tracking console</h3></div></div></div><p>The memory tracking console can be displayed in the client,
      WorldEditor, ModelEditor and ParticleEditor. To display the console in
      the client, press <span class="literal">Ctrl+DEBUG</span>+<span class="literal">F5</span>,
      and to display it in the tools, press
      <span class="literal">Shift+Ctrl</span>+<span class="literal">F5</span>.</p><p>The user can cycle through the realtime memory usage information
      by pressing <span class="literal">Space</span>. There are three levels of
      granularity:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">All memory </em>&#8212; one pool.</p></li><li><p><em class="emphasis">System memory, video memory, and
          miscellaneous memory </em>&#8212; three pools.</p></li><li><p><em class="emphasis">System memory, managed memory, default
          memory, and miscellaneous memory</em> &#8212; four pools</p></li></ul></div><p>Note that video memory is a combination of managed and default
      memories. Also, miscellaneous memory is a catchall for any memory that
      does not fall into the system, managed, or default pools
      (<em class="emphasis">e.g.</em>, DirectX Scratch memory).</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e11600"></a>24.4.&nbsp;Scripts</h2></div></div></div><p>The implementation of a game using the BigWorld client can
    potentially involve many scripts. These scripts will interact and have
    real-time requirements and dependencies, since they are part of a network
    game &#8212; in some cases, the game cannot be simply stopped and stepped
    through without affecting the behaviour of the client being
    debugged.</p><p>Scripting must therefore be approached in the same way as any other
    coding, and not as a poor alternative to C++ coding. Scripts must be
    designed properly, and consideration must be given to the appropriate use
    of class hierarchies and other language concepts.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e11607"></a>24.4.1.&nbsp;Python Console</h3></div></div></div><p>The Python console can be brought up at any time during the
      game.</p><p>This is a console that looks and acts exactly like a Python
      interpreter, so arbitrary Python can be entered into it. All C++ modules
      can be accessed, so the environment is the same as that in which the
      scripts are executed.</p><p>Python errors and exceptions that are not caught by the script
      itself (before they reach the C++ call-in point) are output to the
      console, and therefore are errors from commands entered into the Python
      console itself. The console is the first place to access when an error
      occurs in a game.</p><p>The Python console supports multi-line commands the same way that
      the standard Python interpreter does, and it also supports macros like a
      UNIX shell. Macro invocations begin with a dollar sign ($), and their
      expansions are contained in a dictionary in the personality file ( see
      the fantasydemo personality script for an example). It implements the
      BWPersonality.expandMacros() callback function.</p><p>The list below describes the line editing shortcuts supported by
      the Python console:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">Backspace</span></em></p><p>Deletes the character to the left on insertion point. Same as
          <span class="literal">Ctrl</span>+<span class="literal">H</span>.</p></li><li><p><em class="emphasis"><span class="literal">Delete</span></em></p><p>Deletes the character to the right of insertion point. Same as
          <span class="literal">Ctrl</span>+<span class="literal">D</span>.</p></li><li><p><em class="emphasis"><span class="literal">End</span></em></p><p>Moves insertion point to the end of line. Same as
          <span class="literal">Ctrl</span>+<span class="literal">E</span>.</p></li><li><p><em class="emphasis"><span class="literal">Home</span></em></p><p>Moves insertion point to the beginning of line. Same as
          <span class="literal">Ctrl</span>+<span class="literal">A</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">Backspace</span></em></p><p>Cuts to clipboard all text between insertion point and
          beginning of word. Same as
          <span class="literal">Ctrl</span>+<span class="literal">W</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">Delete</span></em></p><p>Cuts to clipboard all text between insertion point and end of
          word. Same as <span class="literal">Ctrl</span>+<span class="literal">R</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">Insert</span></em></p><p>Pastes the content of clipboard after insertion point. Same as
          <span class="literal">Ctrl</span>+<span class="literal">Y</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">Left
          arrow</span></em></p><p>Moves insertion point to the beginning of word.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">Right
          arrow</span></em></p><p>Moves insertion point to the end of word.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">A</span></em></p><p>Moves insertion point to the beginning of line. Same as
          <span class="literal">Home</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">D</span></em></p><p>Deletes the character to the right of insertion point. Same as
          <span class="literal">Delete</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">E</span></em></p><p>Moves insertion point to the end of line. Same as
          <span class="literal">End</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">H</span></em></p><p>Deletes the character to the left of insertion point. Same as
          <span class="literal">Backspace</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">K</span></em></p><p>Cuts to clipboard all text between insertion point and end of
          line.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">R</span></em></p><p>Cuts to clipboard all text between insertion point and end of
          word. Same as
          <span class="literal">Ctrl</span>+<span class="literal">Delete</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">U</span></em></p><p>Cuts to clipboard all text between insertion point and
          beginning of line.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">W</span></em></p><p>Cuts to clipboard all text between insertion point and
          beginning of word. Same as
          <span class="literal">Ctrl</span>+<span class="literal">Backspace</span>.</p></li><li><p><em class="emphasis"><span class="literal">Ctrl</span>+<span class="literal">Y</span></em></p><p>Pastes the content of clipboard after insertion point. Same as
          <span class="literal">Ctrl</span>+<span class="literal">Insert</span>.</p></li></ul></div><p>The console also offers the functionality of auto code completion.
      By pressing <span class="literal">Tab</span>, it automatically completes the
      current word by trying to match it against the attributes defined for
      the referenced context. If a unique match is found, then it is added
      after the insertion point. If more than one match exists, then pressing
      <span class="literal">Tab</span> cycles through all of them.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Remote_Python_Console"></a>24.4.2.&nbsp;Remote Python Console</h3></div></div></div><p>The services provided by the Python console are also available
      remotely over the network.</p><p>The client accepts connections using the telnet protocol on TCP
      port 50001. A number of telnet options are supported, such as the
      emulation of line editing.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e11876"></a>24.4.3.&nbsp;Script reloading</h3></div></div></div><p>All scripts can be reloaded by pressing <span class="literal">Caps
      Lock</span>+<span class="literal">F11</span>.</p><p>Existing entity class instances are updated so that they are
      instances of the new classes, without losing their dictionary. Entity
      script classes can provide a reload method to refetch stored function
      references that have changed after reloading. For example, the reload
      function in the player script recalculates its key bindings, which would
      otherwise continue to reference functions in the old version of the
      class.</p><p>When the server sends an update to a script, only that script is
      reloaded and only its instances are updated.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e11891"></a>24.4.4.&nbsp;Common errors</h3></div></div></div><p>Some common scripting errors are listed below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Could not find class
          <span class="literal"><em class="replaceable"><code>&lt;entity&gt;</code></em></span></em></p><p>There is a Python error in the file
          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/client/<em class="replaceable"><code>&lt;entity&gt;</code></em>.py</span>.
          Check the file <span class="literal">python.log</span> in the current working
          folder.</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">App::init:
          BigWorldClientScript::init()</span> failed</em></p><p>There is a mismatch between Python script and
          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</span>.</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">EntityType::init:
          EntityDescriptionMap::parse</span> failed</em></p><p>An undefined data type was used in file
          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/<em class="replaceable"><code>&lt;entity&gt;</code></em>.def</span>
          file, or in
          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/scripts/entity_defs/alias.xml</span>.</p></li></ul></div><p>For details on entity definition and Python script files, see the
      document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#Server_Programming_Guide" class="olink">Server Programming Guide</a>'s sections <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_Physical_Entity_Structure_For_Scripting" class="olink"><i>Physical Entity Structure for Scripting</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_The_Definition_File" class="olink">The Entity Definition File</a> and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_Physical_Entity_Structure_For_Scripting" class="olink"><i>Physical Entity Structure for Scripting</i></a> <span class="symbol">&#8594;</span> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_programming_guide/server_programming_guide.html#xref_The_Script_Files" class="olink">The Script Files</a>, respectively.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e11974"></a>24.5.&nbsp;Script interactive debugging</h2></div></div></div><p>You can run BigWorld Client as a Python extension module, instead of
    as an executable. This will allow you to use third party interactive
    debuggers (such as Wing IDE and Komodo), or Python's built-in debug module
    (pdb) to debug your game's scripts.</p><p>To run the client as Python extension module, follow these steps
    below:</p><div class="orderedlist"><ol type="1"><li><p>Create the Python extension module by build the client using the
        <span class="literal">PyModule_Hybrid</span> configuration.</p><p>This configuration requires the environment variable
        <span class="literal">PYTHONHOME</span> to be set to the top-level folder of a
        standard Python installation (<em class="emphasis">e.g.</em>,
        <span class="literal">C:\Python25</span>).</p><p>Because the client will link against the stock standard dynamic
        Python libraries, you must disable the dependency of your startup
        project (<em class="emphasis">e.g.</em>, <span class="literal">fantasydemo</span>) to
        the <span class="literal">pythoncore</span> project. To do so, follow the steps
        below:</p><div class="itemizedlist"><ul type="disc"><li><p>On the <em class="emphasis">Solution Explorer</em>
            pane, right-click your startup project.</p></li><li><p>In the context menu, select the <em class="emphasis">Project Dependencies</em> menu item</p></li><li><p>In the <em class="emphasis">Project Dependencies</em>
            dialog box, check <em class="emphasis"><span class="literal">pythoncore</span></em> on the
            <em class="emphasis">Depends On</em> list.</p></li><li><p>Click OK.</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Instead of a <span class="literal">winMAIN</span> entry point, when
          build as an extension module, the client will require a Python
          module initialisation entry point.</p><p>For a sample implementation, see
          <span class="literal"><em class="replaceable"><code>&lt;mfroot&gt;</code></em>/fantasydemo/src/client/winmain.cpp</span>,
          or just copy the code inside the <span class="literal">BWCLIENT_AS_PYTHON_MODULE
          #if/#endif</span> block into your <span class="literal">winmain.cpp</span>
          file).</p></div></li><li><p>Run the client using the following start-up script:</p><pre class="programlisting"># add client script directories 
# to Python's script search path
import sys
sys.path[1:1] = [
  r'd:\mf\fantasydemo\res\scripts\client',
  r'd:\mf\fantasydemo\res\scripts\common']

# run the client. Replace fantasydemo with
# the name of your extension module (.pyd)
import fantasydemo
fantasydemo.run(' '.join(sys.argv))</pre></li></ol></div><p>Using the script above, you can start the client from the command
    prompt (for example, with the command <span class="literal">python.exe
    fantasydemo.py</span>.) or from Visual Studio. Now, from anywhere in
    the scripts or from the Python console, you can invoke the standard Python
    debugger:</p><pre class="programlisting">import pdb
pdb.set_trace()</pre><p>For more information on how to use the pdb module, please refer to
    the Python Manuals.</p><p>You can also use the start-up script to run the client using a third
    party interactive Python debugger/IDE. This should allow you to set
    breakpoints and inspect variables. For more information on how to use an
    interactive debugger, please refer to your package manuals.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The client will be disconnected from the server if the execution
      of the main thread is interrupted by more than a few seconds, as it
      usually happens when Python scripts are debugged interactively.</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>When running the client as an extension module, it is possible to
      quit the Python interpreter before exiting the client (by, for example,
      invoking exit() from pdb prompt).</p><p>Because the client will still try to execute Python commands
      during its shutdown process, this will cause the client to crash.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Client_Access_Tool_CAT"></a>24.6.&nbsp;Client Access Tool (CAT)</h2></div></div></div><p>CAT provides a graphical interface to change watcher values and run
    Python console commands on a remote or local client. It does so via the
    Remote Python Console service provided by the client. For more details,
    see <a href="#xref_Remote_Python_Console" title="24.4.2.&nbsp;Remote Python Console">Remote Python Console</a>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12089"></a>24.6.1.&nbsp;Connecting to the client</h3></div></div></div><p>In order to connect to the client, you have to provide the
      computer name and/or the IP address where it is running.</p><div class="informalfigure"><div class="mediaobject"><img src="images/client_chooser_dialog.png"><span class="caption"><p>Client Chooser dialog</p></span></div></div><p>If you provide both the computer name and the IP address, CAT
      first tries to connect using the computer name, and if that fails, then
      it uses the IP address. Specify localhost as the computer name or
      127.0.0.1 in the IP address to connect to the local client.</p><p>CAT automatically reconnects to the last client when it is
      started.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12105"></a>24.6.2.&nbsp;CAT Scripts</h3></div></div></div><p>CAT searches for scripts in folder
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/../tools/cat/scripts</span>,
      where <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span> is one
      of the entries in the resources folders list (for details on how
      BigWorld compiles this list, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_Starting_The_Tools" class="olink"><i>Starting the Tools</i></a>).</p><p>For example, if one of the entries in
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span> is
      <span class="literal">C:/mf/fantasydemo/res</span>, then CAT will look for scripts
      under the folder <span class="literal">C:/mf/fantasydemo/tools/cat/scripts</span>.
      It will then present a tree view of the scripts, as illustrated in the
      picture below:</p><div class="informalfigure"><div class="mediaobject"><img src="images/tree_view_of_scripts.png"><span class="caption"><p>Tree view of scripts</p></span></div></div><p>CAT scripts are specialised Python scripts. In the image above,
      the CAT script
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/../tools/cat/scripts/Render/Performance.py</span>
      is selected. It defines the GUI controls to the right of the tree. When
      you select a different CAT script from the tree, different controls will
      be presented to the right of the tree.</p><p>CAT scripts allow the viewing and manipulation of client watcher
      values as well as the execution of commands in the client's Python
      console. See the examples provided in folder
      <span class="literal">fantasydemo/tools/cat/scripts</span> for information on how
      to create your own scripts.</p><p>The list below describes the toolbar buttons and its
      functions:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis">Reconnect</em></p><p>Reconnects to the client, <em class="emphasis">e.g.</em>, after you
          restart the client.</p></li><li><p><em class="emphasis">Disconnect</em></p><p>Disconnects from the client.</p></li><li><p><em class="emphasis">Auto update</em></p><p>Refreshes the data on the current tab once every 2
          seconds.</p></li><li><p><em class="emphasis">Update</em></p><p>Refreshes the data on the current tab
          <em class="emphasis">e.g.</em>, if watcher values are changed from the
          within client.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12187"></a>24.6.3.&nbsp;Creating scripts for CAT</h3></div></div></div><p>CAT looks for scripts in folder
      <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em>/../tools/cat/scripts</span>,
      thus enabling two separate sets of CAT scripts to exist:</p><div class="itemizedlist"><ul type="disc"><li><p>BigWorld system scripts</p></li><li><p>Scripts defined by you that are specific for your game.</p></li></ul></div><p>CAT scans this directory hierarchically, and generates a folder
      tree akin to Windows Explorer's one, using the folder names as branches
      and script files as leaves.</p><p>The picture below illustrates how a folder structure will be
      displayed in CAT:</p><div class="informalfigure"><div class="mediaobject"><img src="images/example_folder_structure_vs_resulting_structure_in_cat.png"><span class="caption"><p>Example folder structure vs. Resulting structure in
          CAT</p></span></div></div><p>The basic structure of the CAT script files is illustrated
      below:</p><pre class="programlisting">from controls import *
envSetup = \
"""
&#8230;
""" 

args = \
(
  ...
)

commands = \
(
  ...
)</pre><p><span class="citetitle">Skeleton of CAT script files</span></p><p>CAT script files are divided in three blocks, which are described
      below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">envSetup</span></em></p><p>Block where variables local to this CAT script are created and
          initialised.</p></li><li><p><em class="emphasis"><span class="literal">args</span></em></p><p>Represent various controls for variables, which can be edited.
          They can either represent variables local to the CAT page, or
          watchers that mirror values on the client.</p></li><li><p><em class="emphasis"><span class="literal">commands</span></em></p><p>Executable commands that appear on the CAT page as
          buttons.</p></li></ul></div><p>The following sections discuss the blocks args and
      commands.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e12248"></a>24.6.3.1.&nbsp;Block args</h4></div></div></div><p>There are several widget elements available in the args block of
        the CAT pages.</p><p>In order to add multiple elements, they should be placed in a
        list with comma delimiters. Any underscores in names are ignored and
        replaced by spaces.</p><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e12255"></a>24.6.3.1.1.&nbsp;Basic Elements</h5></div></div></div><p>The basic elements of args control the layout of CAT
          pages.</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">Divider()</span></em></p><p>This element causes CAT to display a horizontal divider
              between elements, allowing pages to be visually divided.</p></li></ul></div><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">FixedText(
              "<em class="replaceable"><code>&lt;text&gt;</code></em>"
              )</span></em></p><p>This element displays any static text segments such as
              headings. Multiple lines of text can be specified by using the
              newline character "<span class="literal">\n</span>".</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e12282"></a>24.6.3.1.2.&nbsp;Variables</h5></div></div></div><p>It is possible to set up variables that are local to a
          specific CAT page.</p><p>These can also have an associated Python variable tied to
          them, to allow for updates from the client application.</p><p>Below is a list of commands to create variables in CAT:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">StaticText ( "&lt;name&gt;"
              [, default = "&lt;value&gt;"] [, updateCommand =
              "&lt;python_update _source&gt;" ] )</span></em></p><p>This widget creates a non-editable field with the
              specified name and default value (if default is present).</p><p>If updateCommand is specified, then
              <span class="literal"><em class="replaceable"><code>&lt;python_update_source&gt;</code></em></span>
              will be used as the Python value from the client that will be
              displayed.</p><p>For example:</p><pre class="programlisting">StaticText( "Position",
updateCommand = """
  location = $B.findChunkFromPoint( $p.position ).split( '@' )
  print "(%.1f,%.1f,%.1f) @ %s @ %s" %
    ( $p.position.x, $p.position.y, $p.position.z,
      location[0], location[1] )
  """ )</pre><p><span class="citetitle">Creation of field</span></p></li><li><p><em class="emphasis"><span class="literal">CheckBox( "&lt;name&gt;" [,
              updateCommand = "&lt;python_update_source&gt;" [, setCommand =
              "&lt;python_set_source&gt;" ] ] )</span></em></p><p>This widget creates a check box called with the specified
              name.</p><p>If updateCommand is specified, then until the check box is
              edited, it will use &lt;python_update_source&gt; as the Python
              code to get the value that will be displayed.</p><p>If setCommand is specified, then when the field is edited,
              &lt;python_set_source&gt; will be executed.</p><p>For example:</p><pre class="programlisting">CheckBox( "Use Dash",
          updateCommand = "$p.isDashing",
          setCommand = "$p.switchToDash(Use_Dash)" )</pre><p><span class="citetitle">Creation of check box</span></p></li><li><p><em class="emphasis"><span class="literal">Int ( "&lt;name&gt;" [,
              default = &lt;value&gt; ] [, updateCommand =
              "&lt;python_update_source&gt;" [, setCommand =
              "&lt;python_set_source&gt;" [, minMax =
              (&lt;min&gt;,&lt;max&gt;) ] ] ] )</span></em></p><p>This widget creates an integer field with the specified
              name and default value (if default is present).</p><p>If setCommand is specified, then when the field is edited,
              &lt;python_set_source&gt; will be executed.</p><p>If updateCommand is specified, then
              &lt;python_update_source&gt; will be used as the Python value
              from the client that will be displayed.</p><p>If minMax is specified, then the field will have the
              specified (inclusive) value range.</p><p>For example:</p><pre class="programlisting">Int( "Health",
     default = 100,
     updateCommand = "$p.healthPercent",
     setCommand = "$p.healthPercent = Health; $p.set_healthPercent()",
     minMax = ( 0, 100 ) )</pre><p><span class="citetitle">Creation of integer field</span></p></li><li><p><em class="emphasis"><span class="literal">Float ( ( "&lt;name&gt;" [,
              default = &lt;value&gt; ] [, updateCommand =
              "&lt;python_update_source&gt;" [, setCommand =
              "&lt;python_set_source&gt;" [, minMax =
              (&lt;min&gt;,&lt;max&gt;) ] ] ] )</span></em></p><p>This widget creates a float field with the specified name
              and default value (if default is present).</p><p>If updateCommand is specified, then
              &lt;python_update_source&gt; will be used as the Python value
              from the client that will be displayed.</p><p>If setCommand is specified, then when the field is edited,
              &lt;python_set_source&gt; will be executed.</p><p>If minMax is specified, then the field will have the
              specified (inclusive) value range.</p><p>For example:</p><pre class="programlisting">Float( "Speed Multiplier",
       default = 1.0,
       updateCommand = "$p.speedMultiplier",
       setCommand = "$p.speedMultiplier = Speed_Multiplier",
       minMax = ( 1.0, 10.0 ) )</pre><p><span class="citetitle">Creation of float field</span></p></li><li><p><em class="emphasis"><span class="literal">FloatSlider ( (
              "&lt;name&gt;" [, updateCommand = "&lt;python_update_source&gt;"
              [, setCommand = "&lt;python_set_source&gt;" [, minMax =
              (&lt;min&gt;,&lt;max&gt;) ] ] ] )</span></em></p><p>This widget creates a float slider with the specified name
              and default value (if default is present).</p><p>If updateCommand is specified, then
              &lt;python_update_source&gt; will be used as the Python value
              from the client that will be displayed.</p><p>If setCommand is specified, then when the field is edited,
              &lt;python_set_source&gt; will be executed.</p><p>If minMax is specified, then the field will have the
              specified (inclusive) value range.</p><p>For example:</p><pre class="programlisting">FloatSlider( "Camera_Distance",
updateCommand = "BigWorld.camera().pivotMaxDist",
setCommand = "BigWorld.camera().pivotMaxDist=Camera_Distance",
minMax = (0.01, 200.0) )</pre><p><span class="citetitle">Creation of float slider</span></p></li><li><p><em class="emphasis"><span class="literal">List ( "&lt;name&gt;",
              ("&lt;option1&gt;", "&lt;option2&gt;", ...), [, default =
              "&lt;option9&gt;" [, updateCommand =
              "&lt;python_update_source&gt;" ] ] )</span></em></p><p>This widget creates a drop-down menu with the specified
              name, containing the entries specified in the list passed as the
              second argument.</p><p>If default is specified, then the value entered must be
              present in the list passed as the second argument.</p><p>In a similar fashion to the Int and Float widgets, the
              drop-down menu can be given an associated Python
              variable.</p></li><li><p><em class="emphasis"><span class="literal">Enum ( "&lt;name&gt;", (
              ("&lt;option_1&gt;",&lt;value1&gt;),
              ("&lt;option_2&gt;",&lt;value2&gt;), ...), [, updateCommand =
              "&lt;python_update_source&gt;" [, setCommand =
              "&lt;python_set_source&gt;" ] ] )</span></em></p><p>This widget creates a drop-down menu with the specified
              name, containing the entries specified in the list of 2-tuple
              passed as the second argument.</p><p>Each entry will be associated with the value specified on
              the second element of its tuple.</p><p>If updateCommand is specified, then
              &lt;python_update_source&gt; will be used as the Python value
              from the client that will be displayed.</p><p>If setCommand is specified, then when the field is edited,
              &lt;python_set_source&gt; will be executed.</p><p>For example:</p><pre class="programlisting">Enum( "Mode",
( ("Walk",0), ("Run",1), ("Dash",2) ),
updateCommand = "2*$p.isDashing + $p.isRunning",
setCommand = """
 if Mode==0: $p.switchToRun(1); $p.switchToDash(0)
 if Mode==1: $p.switchToRun(0); $p.switchToDash(0)
 if Mode==2: $p.switchToRun(1); $p.switchToDash(1)
 """ )</pre><p><span class="citetitle">Creation of drop-down menu with associated
              numeric values</span></p></li><li><p><em class="emphasis"><span class="literal">Bool ( "&lt;name&gt;", [,
              updateCommand = "&lt;python_update_source&gt;" [, setCommand =
              "&lt;python_set_source&gt;" ] ] )</span></em></p><p>This widget creates a drop-down menu with the specified
              name, with just one entry having two possible values: true or
              false.</p><p>If updateCommand is specified, then
              &lt;python_update_source&gt; will be used as the Python value
              from the client that will be displayed.</p><p>If setCommand is specified, then when the field is edited,
              &lt;python_set_source&gt; will be executed.</p><p>For example:</p><pre class="programlisting">Bool( "Walking", updateCommand = "1-$p. isRunning ", setCommand = "$p. switchToRun (Walking)" )</pre><p><span class="citetitle">Creation of drop-down menu with true/false
              entry</span></p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h5 class="title"><a name="d0e12439"></a>24.6.3.1.3.&nbsp;Watchers</h5></div></div></div><p>Watchers allow you to view the value of specific variables in
          a live system.</p><p>These values can be accessed from the Debug (Watchers) Console
          in the FantasyDemo (accessed by pressing <span class="literal">DEBUG</span>+
          <span class="literal">F7</span>). However, CAT gives you a much simpler way to
          manipulate them.</p><p>Whenever adding a CAT control, it is essential to ensure that
          there is a matching <span class="literal">MF_WATCHER</span> that corresponds
          to the value in question. The best way to check that is by looking
          for the value in the watcher console within the game.</p><p>The value is retrieved from and saved to the value that
          matches the <em class="emphasis">value path</em>
          <span class="literal">MF_WATCHER</span>.</p><p>Below is a list of commands that allow you to manipulate
          watchers:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">WatcherCheckBox(
              "&lt;name&gt;", "&lt;value_path&gt;"
              )</span></em></p><p>Shows a check box with the specified name.</p></li><li><p><em class="emphasis"><span class="literal">WatcherFloat(
              "&lt;name&gt;", "&lt;value_path&gt;" [, minMax =
              (&lt;min&gt;,&lt;max&gt;)] )</span></em></p><p>Shows a float field with the specified name. If minMax is
              specified, then the field will have the specified (inclusive)
              value range.</p></li><li><p><em class="emphasis"><span class="literal">WatcherFloatEnum (
              "&lt;name&gt;", "&lt;value_path&gt;", ( ( "&lt;option1&gt;",
              &lt;value1&gt; ), ( "&lt;option2&gt;", &lt;value2&gt; ) )
              )</span></em></p><p>Shows a dropdown menu with the specified name, containing
              the entries specified in the list of 2-tuple passed as the third
              argument.</p><p>Each entry will be associated with the value specified on
              the second element of its tuple.</p></li><li><p><em class="emphasis"><span class="literal">WatcherFloatSlider(
              "&lt;name&gt;", "&lt;value_path&gt;", minMax =
              (&lt;min&gt;,&lt;max&gt;) )</span></em></p><p>Shows a float slider with the specified name, and with the
              specified (inclusive) value range.</p></li><li><p><em class="emphasis"><span class="literal">WatcherInt( "&lt;name&gt;",
              "&lt;value_path&gt;" [, minMax = (&lt;min&gt;,&lt;max&gt;)]
              )</span></em></p><p>Shows an integer field with the specified name. If
              <span class="literal">minMax</span> is specified, then the field will have
              the specified (inclusive) value range.</p></li><li><p><em class="emphasis"><span class="literal">WatcherIntSlider(
              "&lt;name&gt;", "&lt;value_path&gt;", minMax =
              (&lt;min&gt;,&lt;max&gt;) )</span></em></p><p>Shows a slider with the specified name, and with the
              specified (inclusive) value range.</p></li><li><p><em class="emphasis"><span class="literal">WatcherText(
              "&lt;name&gt;", "&lt;value_path&gt;"
              )</span></em></p><p>Creates a field with the specified name.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e12522"></a>24.6.3.2.&nbsp;Block commands</h4></div></div></div><p>These are commands that appear as buttons in CAT, shown below
        the elements specified in the block args.</p><p>They execute a given Python script. Each command to be added
        takes the following format:</p><pre class="programlisting">( "&lt;description&gt;", "&lt;script&gt;" ),</pre><p>where
        <span class="literal"><em class="replaceable"><code>&lt;description&gt;</code></em></span> is
        the button's caption, and
        <span class="literal"><em class="replaceable"><code>&lt;script&gt;</code></em></span> is the
        Python script to be executed.</p><p>For example:</p><pre class="programlisting">from controls import *

...

commands = \
(
    ( "Hide_GUI", "BigWorld.hideGui()" ),
    ( "Show_ GUI ", "BigWorld.showGui()" )
)Example implementation of block commands</pre><p><span class="citetitle">Example implementation of block
        <span class="literal">commands</span></span></p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e12550"></a>24.7.&nbsp;Timing</h2></div></div></div><p>The BigWorld libraries provide a number of timing tools for
    analysing game performance. One of the most important of these is the
    DogWatch timer class.</p><p>When a DogWatch is created, it is registered in a global list.
    Whenever that timer is started, it is automatically entered into a timing
    statistics hierarchy, based on what other timers are running when it is
    started. The same timer can have multiple instances in the hierarchy if it
    is run more than once in different contexts.</p><p>The root timer is called Frame, and is always running for the entire
    frame time at every frame. All other timer instances are children of this
    timer's instance. Care is taken at the frame boundary to ensure that no
    time goes unaccounted for. Timers can even be running across the frame
    boundary. If this is the case, then they are momentarily stopped, and then
    restarted in the next frame's time slice.</p><p>A view of the DogWatch timer hierarchy is displayed in a debug
    console, which shows the average of the DogWatch times over the last
    second. The user can navigate and drill down in the hierarchy, which is
    displayed using indentation on a single console page. Any of the timer
    instances can also be graphed, and there can be as many graphs displayed
    simultaneously as desired. By default, the client keeps 120 frames of
    DogWatch timer history.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Releasing_The_Game"></a>Chapter&nbsp;25.&nbsp;Releasing The Game</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Limited_User_Accounts">25.1. Configure the engine for limited user accounts</a></span></dt><dt><span class="section"><a href="#xref_Prepare_The_Assets">25.2. Prepare the assets</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e12639">25.2.1. <span class="literal">bin_convert</span></a></span></dt><dt><span class="section"><a href="#xref_Run_res_packer">25.2.2. <span class="literal">res_packer</span></a></span></dt><dt><span class="section"><a href="#d0e12948">25.2.3. Processing done in <span class="literal">bin_convert</span> and
      <span class="literal">res_packer</span></a></span></dt><dt><span class="section"><a href="#d0e13136">25.2.4. Files and folders that do not need to be shipped to the end
      user</a></span></dt><dt><span class="section"><a href="#d0e13211">25.2.5. Font Licensing issues with <span class="literal">bin_convert</span> and
      <span class="literal">res_packer</span></a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13227">25.3. Zip assets and specify paths</a></span></dt><dt><span class="section"><a href="#d0e13319">25.4. Prepare the game executable</a></span></dt></dl></div><p>This chapter lists the steps necessary to prepare the game for its
  release.</p><p>The following sections detail each of these steps.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Limited_User_Accounts"></a>25.1.&nbsp;Configure the engine for limited user accounts</h2></div></div></div><p>In order to allow the client to run on a system with limited
    privileges, the engine should not try to write to the installation
    directory (which, depending on how the game is installed, is usually a
    privileged location). Certain files that need to be written must be
    configured to be written to the user's directory.</p><div class="itemizedlist"><ul type="disc"><li><p>The <em class="emphasis">prefrences.xml</em> file contains end-user
        specific settings such as graphics settings and is written whenever
        the client closes or when <code class="code">BigWorld.savePreferences()</code> is
        called. To configure where this file is saved, edit the
        <code class="code">preferences/pathBase</code> configuration key in
        engine_config.xml.</p><p>For example, you may want to configure preferences.xml to be
        written to
        <code class="code"><code class="code">MY_DOCS/GameTitle/preferences.xml</code></code>.</p><p>See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="client_programming_guide.html#xref_File_preferences_xml" class="olink">File
      <span class="literal"><em class="replaceable"><code>&lt;preferences&gt;</code></em>.xml</span></a> for details on how to
        configure this setting.</p></li><li><p><em class="emphasis">Screenshots</em> can be taken either by pressing
        PrtScn or by calling <code class="code">BigWorld.screenShot()</code>. To configure
        where screenshots are saved, edit the
        <code class="code">preferences/screenShot/path/pathBase</code> configuration key in
        engine_config.xml.</p><p>For example, you may want screen shots to be written to
        <code class="code"><code class="code">MY_DOCS/GameTitle/Screenshots</code></code>.</p><p>See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="client_programming_guide.html#xref_High_Resolution_Screenshots" class="olink">Taking Screenshots</a> for details on how to
        configure this setting.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Prepare_The_Assets"></a>25.2.&nbsp;Prepare the assets</h2></div></div></div><p>Since "just-in-time" resource processing is not enabled in the
    Consumer Release client (e.g. converting textures to DDS format on the
    fly), all resources must be pre-prepared for release. A command line tool,
    called <code class="code">res_packer</code>, is provided which will process a given
    list of assets. A higher level wrapper for <code class="code">res_packer</code> is
    <code class="code">bin_convert</code> (implemented in Python), which will batch process
    an entire resource tree.</p><p>This section provides an overview of how to use both
    <code class="code">res_packer</code> and <code class="code">bin_convert</code>.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12639"></a>25.2.1.&nbsp;<span class="literal">bin_convert</span></h3></div></div></div><p><code class="code"><span class="literal">bin_convert</span></code> is a command-line tool
      implemented in Python that prepares assets in batch, which makes use of
      the <code class="code">res_packer</code> binary. Its usage is described below:</p><pre class="programlisting">bin_convert [--res|-r search_paths] [source_path [dest_path [base_path]]]</pre><p>The options for invoking
      <span class="literal"><code class="code">bin_convert.py</code></span> are described
      below:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">search_paths</span></em></p><p>Search paths of the original source assets, as specified in
          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span> (the
          resources folders list) &#8212; for details on how BigWorld compiles
          this list, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_Starting_The_Tools" class="olink"><i>Starting the Tools</i></a>.</p><p>This value overrides the local <span class="literal">paths.xml</span>,
          if there is one.</p></li><li><p><em class="emphasis"><span class="literal">source_path</span></em></p><p>Path of the original source assets.</p></li><li><p><em class="emphasis"><span class="literal">dest_path</span></em></p><p>Path of the final game, <em class="emphasis">i.e.</em>, the
          destination of processed assets.</p></li><li><p><em class="emphasis"><span class="literal">base_path</span></em></p><p>The resource root for <span class="literal">dest_path</span>, only needs
          to be specified if not converting the entire resource folder.</p></li></ul></div><p>This tool can be customised in different ways, so it can skip
      certain files, skip entire folder, have special handlers for asset types
      (overriding <span class="literal">res_packer</span>).</p><p>For more information on customising
      <span class="literal">bin_convert.py</span>, please refer to its source
      code.</p><p>If the desired processing cannot be achieved in Python, then you
      can modify the source of <span class="literal">res_packer</span> using any of the
      included packer classes as example.</p><p>The list below shows some example of usage of
      <span class="literal">bin_convert.py</span>:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">python bin_convert.py
          /mf/fantasydemo/res
          /mf/fantasydemo/packed</span></em></p><p>Converts all FantasyDemo assets in res to packed
          folder.</p></li><li><p><em class="emphasis"><span class="literal">python bin_convert.py --res
          /mf/fantasydemo/res;/mf/bigworld/res /mf/fantasydemo/res
          /mf/fantasydemo/packed</span></em></p><p>Converts all FantasyDemo assets in res to packed folder,
          specifying the search paths in the command line.</p></li><li><p><em class="emphasis"><span class="literal">python bin_convert.py
          /mf/fantasydemo/res/characters /mf/fantasydemo/packed/characters
          /mf/fantasydemo/packed</span></em></p><p>Converts all FantasyDemo assets in the
          <span class="literal">res/characters</span> folder to the
          <span class="literal">packed/characters</span> folder.</p><p>Note that <span class="literal">base_path</span> (in this case
          <span class="literal">c:/mf/ fantasydemo/packed</span>) must be specified to
          ensure that <span class="literal">res_packer</span> works properly.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Run_res_packer"></a>25.2.2.&nbsp;<span class="literal">res_packer</span></h3></div></div></div><p><span class="literal">res_packer</span> is a command-line tool that is
      capable of processing assets depending on their type, pre-processing
      assets to make them load faster and stripping information that is not
      needed when running the game. Usually, it is called from
      <span class="literal">bin_convert</span> and is not used directly by the
      developer. Its usage is as follows:</p><p>Batch list mode:</p><pre class="programlisting">res_packer [--res|-r search_paths] -list|-l asset_list_file -in|-i src_path -out|-o dest_path [-err|-e error_log_file]</pre><p>Compatible mode:</p><pre class="programlisting">res_packer [--res|-r search_paths] source_file [dest_file [base_path] ]</pre><p>The options for invoking <span class="literal">res_packer</span> are
      described below:</p><p>Batch list mode:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">search_paths</span></em></p><p>Search paths of the original source assets, as specified in
          <span class="literal"><em class="replaceable"><code>&lt;res&gt;</code></em></span> (the
          resources folders list) &#8212; for details on how BigWorld compiles
          this list, see the document <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#Content_Tools_Reference_Guide" class="olink">Content Tools Reference Guide</a>'s chapter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../content_tools_reference_guide/content_tools_reference_guide#xref_Starting_The_Tools" class="olink"><i>Starting the Tools</i></a>.</p><p>This value overrides local <span class="literal">paths.xml</span>, if
          there is one.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>For some asset types, search paths have to be specified,
            either in the command line, in the game's
            <span class="literal">paths.xml</span>, or in the
            <span class="literal">BW_RES_PATH</span> environment variable.</p><p>These paths should be the source search paths used by the
            game, so that <span class="literal">res_packer</span> can find other source
            files that might be needed in the processing.</p><p>For instance, to process a model file, other assets such as
            the visual, textures, and animations must be also read.</p></div></li><li><p><em class="emphasis"><span class="literal">asset_list_file</span></em></p><p>A text file that contains a list of all the assets to process.
          This expected the dissolved paths with one per line.</p></li><li><p><em class="emphasis"><span class="literal">src_path</span></em></p><p>The root path of the input files.</p></li><li><p><em class="emphasis"><span class="literal">dest_path</span></em></p><p>The root path of the output files.</p></li><li><p><em class="emphasis"><span class="literal">error_log_file</span></em></p><p>An optional error output log. Any files that fail to process
          will be added to this log.</p></li></ul></div><p>Compatible mode:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">source_file</span></em></p><p>Source file (with path) to process.</p></li><li><p><em class="emphasis"><span class="literal">dest_file</span></em></p><p>Destination file (with path) of the processed assets.</p><p>In some cases, <span class="literal">source_file</span> might not be
          copied at all (<span class="literal">.bmp</span> files are not copied), or the
          processed file could be of a different type than the original source
          file (<span class="literal">.bmp</span> files are converted to
          <span class="literal">.dds</span> files).</p><p>If this argument is missing, then
          <span class="literal">source_file</span> will not be processed, and a message
          will be sent to the standard output (useful for examining XML files,
          for instance).</p></li><li><p><em class="emphasis"><span class="literal">base_path</span></em></p><p>Base path of the final game &#8212; usually corresponds to
          <span class="literal">dest_file</span>'s path.</p><p>This argument is used when packing file types that require
          special processing, such as images, models, and chunk files.</p><p>If this argument is missing, then the
          <span class="literal">dest_file</span>'s path is used.</p></li></ul></div><p>To modify <span class="literal">res_packer</span>'s default behaviour for an
      asset type, or to add new asset types for processing, modify the source
      code using any of the included packer classes as example.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>When processing <span class="literal">Python</span> files,
        <span class="literal">res_packer</span> does not compile the
        <code class="filename">.py</code> files into <code class="filename">.pyc</code> when
        called directly without <span class="literal">bin_convert</span>. Compiling of
        <code class="filename">.py</code> files is done directly inside
        <span class="literal">bin_convert</span>. Furthermore, if old
        <code class="filename">.pyc</code> files exist in the source folder,
        <span class="literal">res_packer</span> copies them to the destination folder
        without recompiling when run directly without
        <span class="literal">bin_convert</span>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e12948"></a>25.2.3.&nbsp;Processing done in <span class="literal">bin_convert</span> and
      <span class="literal">res_packer</span></h3></div></div></div><p>The default processing done by these tools is as follows:</p><div class="itemizedlist"><ul type="disc"><li><p><em class="emphasis"><span class="literal">bin_convert</span></em></p><div class="itemizedlist"><ul type="circle"><li><p>Skips the <span class="literal">scripts/editor</span>,
              <span class="literal">scripts/cell</span> and
              <span class="literal">scripts/base</span> folders.</p></li><li><p>Skips the <span class="literal">animations</span>,
              <span class="literal">.bwthumbs</span> and <span class="literal">CVS</span>
              folders.</p></li><li><p>Skips the thumbnail files (<em class="emphasis">i.e.</em>,
              files with <span class="literal">.thumbnail.*</span> extension).</p></li><li><p>For <span class="literal">.py</span> files</p><p>Generates <span class="literal">.pyc</span> compiled Python files
              and skips the source <span class="literal">.py</span>, using a custom
              handler.</p></li></ul></div></li><li><p><em class="emphasis"><span class="literal">res_packer</span>:</em></p><div class="itemizedlist"><ul type="circle"><li><p><em class="emphasis">For <span class="literal">.bmp</span>,
              <span class="literal">.tga</span>, <span class="literal">.jpg</span>,
              <span class="literal">.png</span>, <span class="literal">.texformat</span> and
              <span class="literal">.dds</span> files:</em></p><p>Generates DDS for source image files that do not have one,
              and copies DDS files that do not have a corresponding source
              image file. The <span class="literal">.texformat</span> files are skipped
              after processing.</p></li><li><p><em class="emphasis">For <span class="literal">.model</span> and
              <span class="literal">.anca</span> files:</em></p><p>Loads models to generate <span class="literal">.anca</span> files.
              The .animation files are skipped after processing, and the
              <span class="literal">.model</span> files are packed.</p></li><li><p><em class="emphasis">For <span class="literal">.cdata</span>
              files:</em></p><p>Strips thumbnail.dds and navgen sections.</p></li><li><p><em class="emphasis">For <span class="literal">.chunk</span>
              files:</em></p><p>Strips entities that are not client-only, then packs the
              file.</p></li><li><p><em class="emphasis">For <span class="literal">.fx</span>,
              <span class="literal">.fxh</span> and <span class="literal">.fxo</span>
              files:</em></p><p>By default it ignores <span class="literal"><code class="code">.fx</code>
              </span>and <span class="literal"><code class="code">.fxh</code></span> files, and
              only copies <span class="literal">.fxo</span> files, but it can also be
              configured to copy the source <span class="literal">.fx</span> and
              <span class="literal">.fxh</span> (requires recompiling, see
              <code class="code">src/tools/res_packer/config.hpp</code>) .</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>res_packer itself does not rebuild shaders, it only
                copies any existing binaries. Use the utility script located
                in
                <code class="code">bigworld/tools/misc/rebuild_shaders/RebuildShaders.py</code>
                to pre-build all shader combinations before running
                res_packer.</p></div></li><li><p><em class="emphasis">For all other file
              types:</em></p><p>Text XML files &#8212; <em class="emphasis">i.e.</em>, files
              beginning with the <span class="literal">&lt;</span> (left angle bracket)
              character, regardless of extension &#8212; will be packed, while
              others will just be copied.</p></li></ul></div></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13136"></a>25.2.4.&nbsp;Files and folders that do not need to be shipped to the end
      user</h3></div></div></div><p>Both bin_convert and res_packer try their best to slim down the
      game's assets that will be shipped to the end user, but because each
      game has different architecture and requirements, some final tuning
      might be needed for your game. Following is a list of files and folders
      to help identify what should not be shipped to the end
      user:</p><div class="itemizedlist"><ul type="disc"><li><p>Files <span class="literal">*.bmp</span>, *<span class="literal">.tga</span>,
            <span class="literal">*.jpg</span>, *<span class="literal">.png</span>,
            *<span class="literal">.texformat</span>: The final <span class="literal">dds</span>
            files are generated and packed by <span class="literal">res_packer</span>,
            so the source images are not needed.</p></li><li><p>Files *.<span class="literal">thumbnail.*:</span> These files are not
            packed, as these are generated and used in the tools' Asset
            Browser only.<span class="literal"> </span></p></li><li><p>Files *<span class="literal">.animation:</span> Packed
            <span class="literal">.anca</span> files are generated from the source
            <span class="literal">.animation</span> files by
            <span class="literal">res_packer</span>.</p></li><li><p>Files *.py: Compiled .<span class="literal">pyc</span> files are
            generated by <span class="literal">bin_convert</span>, so Python source is
            not needed.</p></li><li><p>Folders to skip: <span class="literal">animations, .bwthumbs,
            <span class="literal">scripts/editor</span>,
            <span class="literal">scripts/cell</span>, <span class="literal">scripts/base,
            scripts/db, scripts/bot, bigworld/res/server,
            bigworld/res/helpers. </span></span></p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13211"></a>25.2.5.&nbsp;Font Licensing issues with <span class="literal">bin_convert</span> and
      <span class="literal">res_packer</span></h3></div></div></div><p>By default, <code class="filename">res_packer</code> will pack any font
      <span class="literal">DDS</span> files into your game's destination folder, and
      font authors usually require buying a license in order to allow their
      font(s) to be used. Please make sure you own license(s) to the font(s)
      you use in your game.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13227"></a>25.3.&nbsp;Zip assets and specify paths</h2></div></div></div><p>To pack assets to zip files, simply create one or more zip files
    containing the game's assets. To create a set of Zip files that can be
    used by the BigWorld client application:</p><div class="orderedlist"><ol type="1"><li><p><em class="emphasis">Zip files bigger than 2GB are not
        supported. More than one Zip file might be required.</em></p><p>The maximum Zip file size supported is 2GB.</p></li><li><p><em class="emphasis">Before creating the Zip files, the assets
        should be prepared via bin_convert.py.</em></p><p>This tool is located under
        <span class="literal">bigworld/tools/misc/res_packer</span> folder.</p></li><li><p><em class="emphasis">Zip file access is done through zlib, and
        the supported Zip compression methods are DEFLATE and STORE. Non-ASCII
        file names should be encoded as UTF-8.</em></p><p>Zip files created with WinRAR, WinZip and 7-Zip have been
        successfully tested. If Non-ASCII file names are included, make sure
        they are encoded as UTF-8, ie. in the case of 7-Zip, choose "Add to
        archive..", set "cu" as the parameters which will force the file names
        to be encoded as UTF-8.</p><div class="informalfigure"><div class="mediaobject"><img src="images/7-zip_archive.png"><span class="caption"><p>7-Zip Add to Archive dialog</p></span></div></div></li><li><p><em class="emphasis">Create Zip files for the base BigWorld
        resources.</em></p><p>Navigate to the folder containing BigWorld's packed assets, and
        create the Zip files for its files and sub-folders.</p></li><li><p><em class="emphasis">Create Zip files for the actual game
        assets.</em></p><p>Navigate to the game assets folder, and create the Zip files for
        its files and sub-folders.</p></li><li><p><em class="emphasis">Specify Zip files as paths in the
        paths.xml file, in order of precedence.</em></p><p>The paths.xml file's Path tag can be set either to a path, or to
        a Zip file. Usually, game asset folders/zip files are listed before
        BigWorld resources folders/zip files. All paths must be specified
        relative to the client executable.</p><p>Assuming the following:</p><div class="itemizedlist"><ul type="disc"><li><p>Common BigWorld resources compressed to
            <span class="literal">bwres001.zip</span>.</p></li><li><p>Final game assets compressed to
            <span class="literal">res001.zip</span> and
            <span class="literal">res002.zip</span>.</p></li><li><p>The resource packages are located next to client
            executable.</p></li></ul></div><p>Your <span class="literal">paths.xml</span> file should look similar to
        this:</p><pre class="programlisting">&lt;root&gt;
  &lt;Paths&gt;
    &lt;Path&gt;  res001.zip    &lt;/Path&gt;
    &lt;Path&gt;  res002.zip    &lt;/Path&gt;
    &lt;Path&gt;  bwres001.zip  &lt;/Path&gt;
  &lt;/Paths&gt;
&lt;/root&gt;</pre><p>You can also combine Zip file paths with normal file system
        paths as well, so that you can have additional assets in unzipped
        folder (this is required, for example, by streamed FMOD sound
        banks).</p><p>If your unzipped folder is called
        <span class="literal">resunpacked</span>, then <span class="literal">paths.xml</span> will
        look like this:</p><pre class="programlisting">&lt;root&gt;
  &lt;Paths&gt;
    &lt;Path&gt;  res001.zip    &lt;/Path&gt;
    &lt;Path&gt;  res002.zip    &lt;/Path&gt;
    &lt;Path&gt;  bwres001.zip  &lt;/Path&gt;
    &lt;Path&gt;  resunpacked    &lt;/Path&gt;
  &lt;/Paths&gt;
&lt;/root&gt;</pre></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13319"></a>25.4.&nbsp;Prepare the game executable</h2></div></div></div><div class="itemizedlist"><ul type="disc"><li><p>If this has not already been done, compile the final release of
        your game's executable. This can be done in the VisualStudio's
        <em class="emphasis">Configuration Manager</em> dialog box
        (accessed by the <em class="emphasis">Build <span class="symbol">&#8594;</span> Configuration Manager</em> menu
        item).</p><p>The <em class="emphasis">Active Solution
        Configuration</em> drop-down list must be set to <em class="emphasis">Consumer_Release</em>.</p></li><li><p>Copy binaries to their final location in the redistributable
        directory structure. The final structure is quite flexible, as long as
        the resource paths are specified as relative to the executable. For
        example, if the paths.xml described in the previous section is used,
        then the final structure would look like:</p><div class="itemizedlist"><ul type="circle"><li><p><code class="code">InstallDir/bwclient.exe</code></p></li><li><p><code class="code">InstallDir/res001.zip</code></p></li><li><p><code class="code">InstallDir/res002.zip</code></p></li><li><p><code class="code">InstallDir/bwres001.zip</code></p></li><li><p><code class="code">InstallDir/resunpacked/</code></p></li></ul></div></li></ul></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="xref_Simplified_Server_Usage"></a>Chapter&nbsp;26.&nbsp;Shared Development Environments</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#xref_Window_Linux_Cross_Platform_Development">26.1. Windows and Linux cross platform development</a></span></dt><dd><dl><dt><span class="section"><a href="#xref_Sharing_Resources_From_Windows">26.1.1. Sharing resources from Windows</a></span></dt><dt><span class="section"><a href="#d0e13570">26.1.2. Accessing Windows share from Linux</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13727">26.2. Using BigWorld with a Version Control System</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e13732">26.2.1. Customers using the Commercial Edition</a></span></dt><dt><span class="section"><a href="#d0e13741">26.2.2. Customers using the Indie Edition</a></span></dt><dt><span class="section"><a href="#xref_Version_Control_Exclusions">26.2.3. Files to exclude from version
      control</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e13851">26.3. DBMgr database conflicts</a></span></dt></dl></div><p>As the workflow of creating a game requires a large number of people
  working on a numerous components simultaneously within a variety of
  environments it is nescessary to ensure that everybody can work together in
  as seamless a manner as possible. This chapter aims to outline the key areas
  in which interaction is required and the recommended methods to avoid
  conflicts.</p><p>Currently there are three areas that have been identified that may
  cause potential interaction conflict for an unprepared development
  team:</p><div class="orderedlist"><ol type="1"><li><p>Windows and Linux cross platform development.</p></li><li><p>Using BigWorld with a Version Control System.</p></li><li><p>DBMgr database conflicts.</p></li></ol></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xref_Window_Linux_Cross_Platform_Development"></a>26.1.&nbsp;Windows and Linux cross platform development</h2></div></div></div><p>For anyone not familiar with both Windows and Linux, running a
    BigWorld server on a Linux box to test game scripts and assets can be
    intimidating and error prone. Since designers and artists typically do
    most of their work on Windows, the process of synchronising files between
    Windows and Linux machines can be tedious.</p><p>The solution outlined below aims to simplify this task by having all
    assets and game scripts reside on a Windows machine, with a Linux machine
    (which can be shared among multiple users) hosting and running a BigWorld
    server for each user that requires their own development
    environment.</p><div class="informalfigure"><div class="mediaobject" align="center"><img src="images/shared_resources.png" align="middle" height=""><span class="caption"><p>Sharing game resources between Windows and
        Linux</p></span></div></div><p>This solution can be summarised as follows:</p><div class="orderedlist"><ol type="1"><li><p>A game developer on a Windows machine creates a network share of
        the root BigWorld directory (<em class="emphasis">i.e.</em>, the directory
        containing <code class="filename">bigworld</code>, <code class="filename">fantasydemo</code>, and <code class="filename">src</code> folders).</p></li><li><p>On the Linux machine, the Windows share from Step 1 is mapped to
        a directory and the relevant <code class="filename"><em class="replaceable"><code>&lt;res&gt;</code></em></code>
        directories and used when a BigWorld server is started.</p></li></ol></div><p>Cross-mounting development resources has been found within the
    BigWorld offices to be the most effective method for Windows based
    developers and artists to work, as all editable files reside on the
    machine they are working on.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>This solution intentionally keeps the server binaries on the Linux
      box.</p><p>Running server executables that exist on Samba mounted filesystems
      can cause unexpected problems, and is not recommended.</p><p>Running server binaries from NFS mounted filesystems works
      correctly and is a recommended alternative.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Sharing_Resources_From_Windows"></a>26.1.1.&nbsp;Sharing resources from Windows</h3></div></div></div><p>For the purposes of this example we assume that all the game
      resources have been checked out into a directory called <code class="filename">C:\BigWorld</code>.</p><p>To share the <code class="filename">C:\BigWorld</code>
      directory on the Windows machine, follow the steps below for your
      version of Windows.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13445"></a>26.1.1.1.&nbsp;Windows XP</h4></div></div></div><div class="orderedlist"><ol type="1"><li><p>Browse to the <code class="filename">C:\</code>
            drive in Explorer.</p></li><li><p>Select the <code class="filename">BigWorld</code>
            directory and right-click it.</p></li><li><p>In the context menu, select the <em class="emphasis">Sharing and Security...</em> menu item.</p></li><li><p>On the <em class="emphasis">mf Properties</em> dialog
            box, select the <em class="emphasis">Share This Folder</em>
            option button.</p></li><li><p>In the <em class="emphasis">Share Name</em> field,
            type the name to share the folder by (in our example, <em class="emphasis">mf-win</em>).</p></li><li><p>Click the <em class="emphasis">Permissions</em>
            button.</p></li><li><p>In the <em class="emphasis">Permission For mf</em>
            dialog box's <em class="emphasis">Group or User Names</em>
            list box, select the <em class="emphasis">Everyone</em>
            item.</p></li><li><p>In the <em class="emphasis">Permissions For
            Everyone</em> list box's <em class="emphasis">Full
            Control</em> entry, select the <em class="emphasis">Allow</em> check box.</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13515"></a>26.1.1.2.&nbsp;Windows 7</h4></div></div></div><div class="orderedlist"><ol type="1"><li><p>Browse to the <code class="filename">C:\</code>
            drive in Explorer.</p></li><li><p>Select the <code class="filename">BigWorld</code>
            directory and right-click it.</p></li><li><p>In the context menu, select the <em class="emphasis">Properties</em> menu item.</p></li><li><p>Select the <em class="emphasis">Sharing</em>
            tab.</p></li><li><p>Click the <em class="emphasis">Advanced
            Sharing...</em> button.</p></li><li><p>In the <em class="emphasis">Advanced Sharing</em>
            dialog box, select the <em class="emphasis">Share this
            folder</em> check box.</p></li><li><p>If necessary, click the <em class="emphasis">Permissions</em> button to enable all users
            access privileges to this share.</p></li><li><p>Click <em class="emphasis">OK</em> when
            finished.</p></li></ol></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13570"></a>26.1.2.&nbsp;Accessing Windows share from Linux</h3></div></div></div><p>To assist the process of mounting the Windows share, BigWorld
      provides the script <code class="filename">setup_win_dev</code>. The location of
      this script may differ depending on your edition.</p><div class="variablelist"><dl><dt><span class="term">Indie Edition</span></dt><dd><p>For customers using the Indie edition,
            <code class="filename">setup_win_dev</code> will be installed into
            <code class="filename">/opt/bigworld/current/server/bin</code> by
            the server RPM package. This directory has also been placed into
            your <code class="envar">$PATH</code> so you can run
            <code class="filename">setup_win_dev</code> from any directory.</p></dd><dt><span class="term">Commercial Edition</span></dt><dd><p>Customers using the Commercial edition can find the
            setup_win_dev script located in
            <code class="filename">bigworld/tools/server/install/setup_win_dev.py</code>.</p></dd></dl></div><p>Please note, however, that it was designed for developers working
      at BigWorld, and hence it uses default values appropriate for BigWorld
      as well. Before artists and game programmers use it, a sysadmin or
      programmer should edit this file to change the defaults to values
      appropriate for your development environment.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13608"></a>26.1.2.1.&nbsp;Assumptions and Requirements</h4></div></div></div><p>This <code class="filename">setup_win_dev</code> script has following
        assumptions:</p><div class="itemizedlist"><ul type="disc"><li><p>The server binaries can be accessed on the Windows
            share.</p></li><li><p>Your username on the Windows box is the same as your
            username on the Linux box.</p></li><li><p>You are using CentOS 5 or later.</p></li><li><p>Linux kernel with CIFS module. This should be contained
            within the default CentOS kernel.</p></li></ul></div><p>The script will display a list of prerequisites upon startup,
        which are reproduced here for convenience:</p><div class="itemizedlist"><ul type="disc"><li><p>The user running the script has been entered into the
            <code class="filename">/etc/sudoers</code> file on the Linux
            machine.</p><p>For details see the system manual page with the command
            '<span><strong class="command">man sudoers</strong></span>'.</p></li><li><p>You know the location of your home directory on the Linux
            machine.</p><p>This can generally be discovered by running the following
            command:</p><pre class="programlisting">$ echo $HOME
/home/alice</pre></li><li><p>You have shared the top level BigWorld directory from your
            Windows machine.</p><p>For details on how to achieve this see <a href="#xref_Sharing_Resources_From_Windows" title="26.1.1.&nbsp;Sharing resources from Windows">Sharing resources from Windows</a>.</p></li><li><p>You may also require the Samba client programs. To install
            the Samba client, run the following command as the root
            user:</p><pre class="programlisting"># yum install samba-client</pre></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13662"></a>26.1.2.2.&nbsp;Mapping a Windows share onto Linux</h4></div></div></div><p>Once the requirements outlined above have been met, or any
        necessary modifications have been made to your environment, running
        the <code class="filename">setup_win_dev</code> script will guide you through
        mounting a Windows share using Samba onto the Linux machine.</p><p>Outlined below is a simple run through of the
        <code class="filename">setup_win_dev</code> program discussing each
        step.</p><p>When the program is first run, it attempts to establish root
        user privileges using the <span><strong class="command">sudo</strong></span> command. This
        enables the program to interact with the system devices nescessary to
        provide access to your Windows share. This step may not be nescessary
        if you have recently performed another command using sudo. Enter the
        password for the account you are currently logged in as.</p><pre class="programlisting">$ setup_win_dev
NOTE: If you are immediately prompted for a password, enter your *own*
      password not that of the root user.

* Validating user has 'sudo' privileges
Password: </pre><p>Next we see that the program is preparing a destination
        directory for the Windows share to be placed under. This directory
        defaults to <code class="filename"><code class="envar">$HOME</code>/bigworld_windows_share</code>.</p><pre class="programlisting">* Setting up destination location for Windows resources</pre><p>The next step involves entering information regarding the
        location of the Windows machine and the name of the shared resources.
        If you are uncertain about any of the details attempt to access your
        Windows machine from another machine in the network to establish the
        machine name and share name.</p><pre class="programlisting">* Querying location of remote resources

Enter the hostname of your Windows machine: <em class="emphasis">mywindowsmachine</em>
Enter the share name of the shared BigWorld directory: <em class="emphasis">BigWorld_indie</em></pre><p>You now need to input the username and password required to
        access the Windows machine. The username will default to the username
        of your unix account, however if your Windows login is different
        simply enter that here.</p><pre class="programlisting">We now need the username and password required to connect to the Windows share
Username [alice]: <em class="emphasis">bob</em>
Password: 
Confirm password: </pre><p>The <code class="filename">setup_win_dev</code> program now outputs the
        resource name to be used when accessing the Windows share. This
        resource name can be used by other Samba tools such as smbclient if
        you are having troubles connecting.</p><pre class="programlisting">Using remote location: '//mywindowsmachine/BigWorld_indie'</pre><p>Finally you will be asked if you wish to have the Windows share
        always available on the Linux machine. This allows you to reboot or
        shutdown the Linux machine whenever you need to without having to
        remount the Windows share. If you choose 'yes' a new file that is only
        readable by your user will be created in
        <code class="filename"><code class="envar">$HOME</code>/.bw_share_credentials</code>
        containing your username and password.</p><pre class="programlisting">Do you want to automount your Windows share each time this Linux box boots?
This will place a file in your home directory containing a clear-text copy
of your password that is only readable by your user. [yes]</pre><p>The setup_win_dev program will now attempt to make the Windows
        shared resources available for you.</p><pre class="programlisting">Patched /etc/fstab successfully
//mywindowsmachine/BigWorld_indie is mounted at /home/alice/bigworld_windows_share
* Windows directory successfully mounted</pre></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13727"></a>26.2.&nbsp;Using BigWorld with a Version Control System</h2></div></div></div><p>It is strongly recommended that a version control system such as
    CVS, SVN or Perforce is used while developing a game using BigWorld. In
    doing so you allow numerous people within your development team to remain
    up to date with changes and enable access to all parts of the project
    resources regardless of the development platform of an individual.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13732"></a>26.2.1.&nbsp;Customers using the Commercial Edition</h3></div></div></div><p>Most recipients of an SVN distribution should place the entire
      release received from BigWorld into their version control system. This
      ensures that any changes to the BigWorld source code and resources are
      propagated to all the game developers at once.</p><p>Some files should not be committed into the version control
      system. Please review the section <a href="#xref_Version_Control_Exclusions" title="26.2.3.&nbsp;Files to exclude from version control">Files to exclude from version
      control</a> for further details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e13741"></a>26.2.2.&nbsp;Customers using the Indie Edition</h3></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13744"></a>26.2.2.1.&nbsp;Creating a project repository</h4></div></div></div><p>Customers using the Indie edition should only commit their own
        project directories into version control.</p><p>Indie customers should only commit their own project directories
        into version control.</p><p>For example in the case of a new game called
        &#8220;<span class="quote">my_game</span>&#8221; it is recommended to commit the directory
        <code class="filename">C:\BigWorld\my_game</code> into your
        version control system.</p><p>Some files should not be committed into the version control
        system. Please review the section <a href="#xref_Version_Control_Exclusions" title="26.2.3.&nbsp;Files to exclude from version control">Files to exclude from version
      control</a> for further
        details.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13763"></a>26.2.2.2.&nbsp;Checking out an existing project</h4></div></div></div><p>When setting up a new client machine run the installation
        procedures outlined in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../client_installation_guide/client_installation_guide.html#Client_Installation_Guide" class="olink">Client Installation Guide</a> and then checkout your project
        into the new installation.</p><p>When setting up a new server machine run the installation
        procedures outlined in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_installation_guide/server_installation_guide.html#Server_Installation_Guide" class="olink">Server Installation Guide</a>. You will then need to
        checkout your project into the home directory of the user running the
        server, or follow the instructions outlined in <a href="#xref_Window_Linux_Cross_Platform_Development" title="26.1.&nbsp;Windows and Linux cross platform development">Windows and Linux cross platform development</a> to use
        resources mounted from a Windows machined. After preparing the server
        and the game resources for use you will also need to ensure that the
        .bwmachined.conf file has been updated accordingly. Details on the
        .bwmachined.conf file can be found in the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_installation_guide/server_installation_guide.html#Server_Installation_Guide" class="olink">Server Installation Guide</a>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="xref_Version_Control_Exclusions"></a>26.2.3.&nbsp;Files to exclude from version
      control</h3></div></div></div><p>There are numerous files that are automatically generated while
      running a the BigWorld Technology Suite which are only relevant to the
      user currently running a program. These files should be excluded from
      your version control system to avoid conflicts with other users. Each
      version control system provides its own mechanism to ignore or exclude
      files. For example Subversion allows you to set a directory property
      <span class="literal">svn:ignore</span> to a list of file match patterns for that
      directory.</p><p>Below is listed a set of files and directories that should be
      considered for adding exclusion rules to your version control repository
      and configuration files.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13788"></a>26.2.3.1.&nbsp;General exclusion rules</h4></div></div></div><p>Application log files such as <code class="filename">python.log</code> or
        <code class="filename">worldeditor.log</code> should not be committed into your
        repository.</p><pre class="programlisting">*.log</pre><p>When you run the game client or the tools, some resources will
        be created on-disk as 'processed' or 'compiled' versions of source
        files. These files are regenerated on demand based on comparing the
        timestamp of the source with the timestamp of the automatically
        generated file. These files should not be committed into your
        repository.</p><pre class="programlisting">*.dds        # Compressed texture map files
*.anca       # Compressed animation files
*.font       # Processed font files
font/*.dds   # Generated font bitmaps</pre><p>Python scripts used for client and server game logic will
        generate a compiled byte-code file when they are first run or updated.
        As these files will be changing frequently during development they
        should not be included in the repository to help reduce clutter with
        each changeset.</p><pre class="programlisting">*.pyc</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="d0e13809"></a>26.2.3.2.&nbsp;Tools specific exclusion rules</h4></div></div></div><p>The art pipeline tools automatically generate user preference
        files when they are run. As these will differ between artists they
        should be excluded from the repository.</p><pre class="programlisting">bigworld/tools/worldeditor/options.xml
bigworld/tools/worldeditor/resources/graphics_preferences.xml

bigworld/tools/particleeditor/options.xml

bigworld/tools/modeleditor/options.xml</pre><p>The art tools Asset Browser also generates history files as it
        is being used.</p><pre class="programlisting">bigworld/tools/modeleditor/resources/ual/history.xml
bigworld/tools/modeleditor/resources/ual/favourites.xml

bigworld/tools/particleeditor/resources/ual/history.xml
bigworld/tools/particleeditor/resources/ual/favourites.xml

bigworld/tools/worldeditor/resources/ual/history.xml
bigworld/tools/worldeditor/resources/ual/favourites.xml</pre><p>WorldEditor will create a
        <code class="filename">space.localsettings</code> file when creating a new
        space.</p><pre class="programlisting"><em class="replaceable"><code>&lt;your_game&gt;</code></em>/res/spaces/<em class="replaceable"><code>&lt;your_new_space&gt;</code></em>/space.localsettings</pre><p>WorldEditor will also create two files containing a space map.
        Both these files must be committed to revision control or
        neither.</p><pre class="programlisting"><em class="replaceable"><code>&lt;your_game&gt;</code></em>/res/spaces/<em class="replaceable"><code>&lt;your_space&gt;</code></em>/space.thumbnail.dds
<em class="replaceable"><code>&lt;your_game&gt;</code></em>/res/spaces/<em class="replaceable"><code>&lt;your_space&gt;</code></em>/space.thumbnail.timestamps</pre><p>The BigWorld game client will also generate a preferences file
        in the directory it is run from.</p><pre class="programlisting"># Substitute 'fantasydemo' for your game name
fantasydemo/game/preferences.xml</pre></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e13851"></a>26.3.&nbsp;DBMgr database conflicts</h2></div></div></div><p>For customers using a MySQL database to store persistent data,
    shared development environments can present an issue with multiple servers
    contending for the same database.</p><p>The database used by DBMgr is exclusive per server cluster instance
    so it is nessecary for multiple users running a server on the same machine
    to use different databases. To do this requires adding or modifying the
    the &lt;res&gt;/server/bw.xml configuration file entries for
    <span class="literal">dbMgr/host</span> and <span class="literal">dbMgr/databaseName</span>.
    Specifically the <span class="literal">databaseName</span> should be unique per
    user. For more information on these options refer to the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#Server_Operations_Guide" class="olink">Server Operations Guide</a> section <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../server_operations_guide/server_operations_guide.html#xref_DBMgr_Configuration_Options" class="olink">DBMgr Configuration Options</a>.</p></div></div></div></div></body></html>